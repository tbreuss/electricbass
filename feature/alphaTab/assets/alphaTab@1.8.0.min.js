/*!
 * alphaTab v1.8.0 (, build 26)
 *
 * Copyright © 2026, Daniel Kuschny and Contributors, All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Integrated Libraries:
 *
 * Library: TinySoundFont
 * License: MIT
 * Copyright: Copyright (C) 2017, 2018 Bernhard Schelling
 * URL: https://github.com/schellingb/TinySoundFont
 * Purpose: SoundFont loading and Audio Synthesis
 *
 * Library: SFZero
 * License: MIT
 * Copyright: Copyright (C) 2012 Steve Folta ()
 * URL: https://github.com/stevefolta/SFZero
 * Purpose: TinySoundFont is based on SFZEro
 *
 * Library: Haxe Standard Library
 * License: MIT
 * Copyright: Copyright (C)2005-2025 Haxe Foundation
 * URL: https://github.com/HaxeFoundation/haxe/tree/development/std
 * Purpose: XML Parser & Zip Inflate Algorithm
 *
 * Library: SharpZipLib
 * License: MIT
 * Copyright: Copyright © 2000-2018 SharpZipLib Contributors
 * URL: https://github.com/icsharpcode/SharpZipLib
 * Purpose: Zip Deflate Algorithm for writing compressed Zips
 *
 * Library: NVorbis
 * License: MIT
 * Copyright: Copyright (c) 2020 Andrew Ward
 * URL: https://github.com/NVorbis/NVorbis
 * Purpose: Vorbis Stream Decoding
 *
 * Library: libvorbis
 * License: BSD-3-Clause
 * Copyright: Copyright (c) 2002-2020 Xiph.org Foundation
 * URL: https://github.com/xiph/vorbis
 * Purpose: NVorbis adopted some code from libvorbis.
 *
 * @preserve
 * @license
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).alphaTab={})}(this,function(t){"use strict";class e{t;i=new Set;constructor(t){this.t=t,window.addEventListener("resize",this.o.bind(this),!1)}observe(t){this.i.add(t)}unobserve(t){this.i.delete(t)}disconnect(){this.i.clear()}o(){const t=[];for(const e of this.i)t.push({target:e,contentRect:void 0,borderBoxSize:void 0,contentBoxSize:[],devicePixelContentBoxSize:[]});this.t(t,this)}}class s{t;l=[];u=null;constructor(t){this.t=t,window.addEventListener("resize",()=>this.p,!0),document.addEventListener("scroll",()=>this.p,!0)}p(){this.u||(this.u=setTimeout(()=>{this.m(),this.u=null},100))}observe(t){this.l.indexOf(t)>=0||(this.l.push(t),this.p())}unobserve(t){this.l=this.l.filter(e=>e!==t)}m(){const t=[];for(const e of this.l){const s=e.getBoundingClientRect();s.top+s.height>=0&&s.top<=window.innerHeight&&s.left+s.width>=0&&s.left<=window.innerWidth&&t.push({target:e,isIntersecting:!0})}t.length&&this.t(t,this)}}var i,n,r,a,h,o,c,l,u,d,f,p,b,m,g,w,y,k,S,B,_,T,x,M,v,N,P,C,E,F,A,D,L,W,R,I,O;void 0===Symbol.dispose&&(Symbol.dispose=Symbol("Symbol.dispose")),"undefined"!=typeof window&&("ResizeObserver"in globalThis||(globalThis.ResizeObserver=e),"IntersectionObserver"in globalThis||(globalThis.IntersectionObserver=s),"replaceChildren"in Element.prototype||(Element.prototype.replaceChildren=function(...t){this.innerHTML="",this.append(...t)},Document.prototype.replaceChildren=Element.prototype.replaceChildren,DocumentFragment.prototype.replaceChildren=Element.prototype.replaceChildren)),"replaceAll"in String.prototype||(String.prototype.replaceAll=function(t,e){return this.replace(new RegExp(t,"g"),e)}),t.AlphaTabErrorType=void 0,(i=t.AlphaTabErrorType||(t.AlphaTabErrorType={}))[i.General=0]="General",i[i.Format=1]="Format",i[i.AlphaTex=2]="AlphaTex";class G extends Error{type;constructor(t,e="",s){super(e??"",{cause:s}),this.type=t}}class V{static version="1.8.0";static date="2026-01-12T15:41:07.446Z";static commit="b3039f03e18398df334fd99c8ec92ea94c1ebea1";static print(t){t(`alphaTab ${V.version}`),t(`commit: ${V.commit}`),t(`build date: ${V.date}`)}}!function(t){t[t.PPP=0]="PPP",t[t.PP=1]="PP",t[t.P=2]="P",t[t.MP=3]="MP",t[t.MF=4]="MF",t[t.F=5]="F",t[t.FF=6]="FF",t[t.FFF=7]="FFF",t[t.PPPP=8]="PPPP",t[t.PPPPP=9]="PPPPP",t[t.PPPPPP=10]="PPPPPP",t[t.FFFF=11]="FFFF",t[t.FFFFF=12]="FFFFF",t[t.FFFFFF=13]="FFFFFF",t[t.SF=14]="SF",t[t.SFP=15]="SFP",t[t.SFPP=16]="SFPP",t[t.FP=17]="FP",t[t.RF=18]="RF",t[t.RFZ=19]="RFZ",t[t.SFZ=20]="SFZ",t[t.SFFZ=21]="SFFZ",t[t.FZ=22]="FZ",t[t.N=23]="N",t[t.PF=24]="PF",t[t.SFZP=25]="SFZP"}(n||(n={}));class ${static QuarterTime=960;static k=15;static VelocityIncrement=16;static ticksToMillis(t,e){return t*(6e4/(e*$.QuarterTime))|0}static millisToTicks(t,e){return t/(6e4/(e*$.QuarterTime))|0}static toTicks(t){return $.valueToTicks(t)}static valueToTicks(t){let e=t;return e<0&&(e=1/-e),$.QuarterTime*(4/e)|0}static applyDot(t,e){return e?t+3*(t/4|0):t+(t/2|0)}static applyTuplet(t,e,s){return t*s/e|0}static removeTuplet(t,e,s){return t*e/s|0}static dynamicToVelocity(t,e=0){let s=1;switch(t){case n.PPP:s=$.k+0*$.VelocityIncrement;break;case n.PP:s=$.k+1*$.VelocityIncrement;break;case n.P:s=$.k+2*$.VelocityIncrement;break;case n.MP:s=$.k+3*$.VelocityIncrement;break;case n.MF:s=$.k+4*$.VelocityIncrement;break;case n.F:s=$.k+5*$.VelocityIncrement;break;case n.FF:s=$.k+6*$.VelocityIncrement;break;case n.FFF:s=$.k+7*$.VelocityIncrement;break;case n.PPPP:s=10;break;case n.PPPPP:s=5;break;case n.PPPPPP:s=3;break;case n.FFFF:s=$.k+8*$.VelocityIncrement;break;case n.FFFFF:s=$.k+9*$.VelocityIncrement;break;case n.FFFFFF:s=$.k+10*$.VelocityIncrement;break;case n.SF:case n.SFP:case n.SFZP:case n.SFPP:case n.SFZ:case n.FZ:s=$.k+6*$.VelocityIncrement;break;case n.FP:case n.RF:case n.RFZ:case n.SFFZ:s=$.k+5*$.VelocityIncrement;break;case n.N:s=1;break;case n.PF:s=$.k+(4.5*$.VelocityIncrement|0)}return s+=e*$.VelocityIncrement,Math.min(Math.max(s,1),127)}}!function(t){t[t.Tempo=0]="Tempo",t[t.Volume=1]="Volume",t[t.Instrument=2]="Instrument",t[t.Balance=3]="Balance",t[t.SyncPoint=4]="SyncPoint",t[t.Bank=4]="Bank"}(r||(r={}));class H{barOccurence=0;millisecondOffset=0}class U{isLinear=!1;type=r.Tempo;value=0;syncPointValue;ratioPosition=0;text="";isVisible=!0;static buildTempoAutomation(t,e,s,i,n=!0){(i<1||i>5)&&(i=2);const a=new Float32Array([1,.5,1,1.5,2,3]),h=new U;return h.type=r.Tempo,h.isLinear=t,h.ratioPosition=e,h.value=s*a[i],h.isVisible=n,h}static buildInstrumentAutomation(t,e,s){const i=new U;return i.type=r.Instrument,i.isLinear=t,i.ratioPosition=e,i.value=s,i}}class z{static MaxPosition=60;static MaxValue=12;offset;value;constructor(t=0,e=0){this.offset=t,this.value=e}}!function(t){t[t.Default=0]="Default",t[t.Gradual=1]="Gradual",t[t.Fast=2]="Fast"}(a||(a={})),function(t){t[t.None=0]="None",t[t.Custom=1]="Custom",t[t.Bend=2]="Bend",t[t.Release=3]="Release",t[t.BendRelease=4]="BendRelease",t[t.Hold=5]="Hold",t[t.Prebend=6]="Prebend",t[t.PrebendBend=7]="PrebendBend",t[t.PrebendRelease=8]="PrebendRelease"}(h||(h={})),function(t){t[t.None=0]="None",t[t.BrushUp=1]="BrushUp",t[t.BrushDown=2]="BrushDown",t[t.ArpeggioUp=3]="ArpeggioUp",t[t.ArpeggioDown=4]="ArpeggioDown"}(o||(o={})),function(t){t[t.None=0]="None",t[t.Crescendo=1]="Crescendo",t[t.Decrescendo=2]="Decrescendo"}(c||(c={})),function(t){t[t.QuadrupleWhole=-4]="QuadrupleWhole",t[t.DoubleWhole=-2]="DoubleWhole",t[t.Whole=1]="Whole",t[t.Half=2]="Half",t[t.Quarter=4]="Quarter",t[t.Eighth=8]="Eighth",t[t.Sixteenth=16]="Sixteenth",t[t.ThirtySecond=32]="ThirtySecond",t[t.SixtyFourth=64]="SixtyFourth",t[t.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",t[t.TwoHundredFiftySixth=256]="TwoHundredFiftySixth"}(l||(l={})),function(t){t[t.None=0]="None",t[t.OnBeat=1]="OnBeat",t[t.BeforeBeat=2]="BeforeBeat",t[t.BendGrace=3]="BendGrace"}(u||(u={})),function(t){t[t.None=0]="None",t[t.Normal=1]="Normal",t[t.Heavy=2]="Heavy",t[t.Tenuto=3]="Tenuto"}(d||(d={})),function(t){t[t.Unknown=-2]="Unknown",t[t.NoOrDead=-1]="NoOrDead",t[t.Thumb=0]="Thumb",t[t.IndexFinger=1]="IndexFinger",t[t.MiddleFinger=2]="MiddleFinger",t[t.AnnularFinger=3]="AnnularFinger",t[t.LittleFinger=4]="LittleFinger"}(f||(f={})),function(t){t[t.None=0]="None",t[t.Natural=1]="Natural",t[t.Artificial=2]="Artificial",t[t.Pinch=3]="Pinch",t[t.Tap=4]="Tap",t[t.Semi=5]="Semi",t[t.Feedback=6]="Feedback"}(p||(p={})),function(t){t[t.Default=0]="Default",t[t.ForceNone=1]="ForceNone",t[t.ForceNatural=2]="ForceNatural",t[t.ForceSharp=3]="ForceSharp",t[t.ForceDoubleSharp=4]="ForceDoubleSharp",t[t.ForceFlat=5]="ForceFlat",t[t.ForceDoubleFlat=6]="ForceDoubleFlat"}(b||(b={})),function(t){t[t.S=0]="_15ma",t[t._=1]="_8va",t[t.Regular=2]="Regular",t[t.T=3]="_8vb",t[t.M=4]="_15mb"}(m||(m={})),function(t){t[t.None=0]="None",t[t.IntoFromBelow=1]="IntoFromBelow",t[t.IntoFromAbove=2]="IntoFromAbove"}(g||(g={})),function(t){t[t.None=0]="None",t[t.Shift=1]="Shift",t[t.Legato=2]="Legato",t[t.OutUp=3]="OutUp",t[t.OutDown=4]="OutDown",t[t.PickSlideDown=5]="PickSlideDown",t[t.PickSlideUp=6]="PickSlideUp"}(w||(w={})),function(t){t[t.None=0]="None",t[t.Slight=1]="Slight",t[t.Wide=2]="Wide"}(y||(y={})),t.TabRhythmMode=void 0,(k=t.TabRhythmMode||(t.TabRhythmMode={}))[k.Hidden=0]="Hidden",k[k.ShowWithBeams=1]="ShowWithBeams",k[k.ShowWithBars=2]="ShowWithBars",k[k.Automatic=3]="Automatic",t.FingeringMode=void 0,(S=t.FingeringMode||(t.FingeringMode={}))[S.ScoreDefault=0]="ScoreDefault",S[S.ScoreForcePiano=1]="ScoreForcePiano",S[S.SingleNoteEffectBand=2]="SingleNoteEffectBand",S[S.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano",t.NotationMode=void 0,(B=t.NotationMode||(t.NotationMode={}))[B.GuitarPro=0]="GuitarPro",B[B.SongBook=1]="SongBook",t.NotationElement=void 0,(_=t.NotationElement||(t.NotationElement={}))[_.ScoreTitle=0]="ScoreTitle",_[_.ScoreSubTitle=1]="ScoreSubTitle",_[_.ScoreArtist=2]="ScoreArtist",_[_.ScoreAlbum=3]="ScoreAlbum",_[_.ScoreWords=4]="ScoreWords",_[_.ScoreMusic=5]="ScoreMusic",_[_.ScoreWordsAndMusic=6]="ScoreWordsAndMusic",_[_.ScoreCopyright=7]="ScoreCopyright",_[_.GuitarTuning=8]="GuitarTuning",_[_.TrackNames=9]="TrackNames",_[_.ChordDiagrams=10]="ChordDiagrams",_[_.ParenthesisOnTiedBends=11]="ParenthesisOnTiedBends",_[_.TabNotesOnTiedBends=12]="TabNotesOnTiedBends",_[_.ZerosOnDiveWhammys=13]="ZerosOnDiveWhammys",_[_.EffectAlternateEndings=14]="EffectAlternateEndings",_[_.EffectCapo=15]="EffectCapo",_[_.EffectChordNames=16]="EffectChordNames",_[_.EffectCrescendo=17]="EffectCrescendo",_[_.EffectDynamics=18]="EffectDynamics",_[_.EffectFadeIn=19]="EffectFadeIn",_[_.EffectFermata=20]="EffectFermata",_[_.EffectFingering=21]="EffectFingering",_[_.EffectHarmonics=22]="EffectHarmonics",_[_.EffectLetRing=23]="EffectLetRing",_[_.EffectLyrics=24]="EffectLyrics",_[_.EffectMarker=25]="EffectMarker",_[_.EffectOttavia=26]="EffectOttavia",_[_.EffectPalmMute=27]="EffectPalmMute",_[_.EffectPickSlide=28]="EffectPickSlide",_[_.EffectPickStroke=29]="EffectPickStroke",_[_.EffectSlightBeatVibrato=30]="EffectSlightBeatVibrato",_[_.EffectSlightNoteVibrato=31]="EffectSlightNoteVibrato",_[_.EffectTap=32]="EffectTap",_[_.EffectTempo=33]="EffectTempo",_[_.EffectText=34]="EffectText",_[_.EffectTrill=35]="EffectTrill",_[_.EffectTripletFeel=36]="EffectTripletFeel",_[_.EffectWhammyBar=37]="EffectWhammyBar",_[_.EffectWideBeatVibrato=38]="EffectWideBeatVibrato",_[_.EffectWideNoteVibrato=39]="EffectWideNoteVibrato",_[_.EffectLeftHandTap=40]="EffectLeftHandTap",_[_.EffectFreeTime=41]="EffectFreeTime",_[_.EffectSustainPedal=42]="EffectSustainPedal",_[_.EffectGolpe=43]="EffectGolpe",_[_.EffectWahPedal=44]="EffectWahPedal",_[_.EffectBeatBarre=45]="EffectBeatBarre",_[_.EffectNoteOrnament=46]="EffectNoteOrnament",_[_.EffectRasgueado=47]="EffectRasgueado",_[_.EffectDirections=48]="EffectDirections",_[_.EffectBeatTimer=49]="EffectBeatTimer",_[_.EffectWhammyBarLine=50]="EffectWhammyBarLine",_[_.EffectNumberedNotationKeySignature=51]="EffectNumberedNotationKeySignature",_[_.ChordDiagramFretboardNumbers=52]="ChordDiagramFretboardNumbers",_[_.BarNumber=53]="BarNumber",_[_.RepeatCount=54]="RepeatCount",_[_.ScoreBendSlur=55]="ScoreBendSlur";class X{notationMode=t.NotationMode.GuitarPro;fingeringMode=t.FingeringMode.ScoreDefault;elements=new Map;static defaultElements=new Map([[t.NotationElement.ZerosOnDiveWhammys,!1]]);rhythmMode=t.TabRhythmMode.Automatic;rhythmHeight=25;transpositionPitches=[];displayTranspositionPitches=[];smallGraceTabNotes=!0;extendBendArrowsOnTiedNotes=!0;extendLineEffectsToBeatEnd=!1;slurHeight=5;isNotationElementVisible(t){return this.elements.has(t)?this.elements.get(t):!X.defaultElements.has(t)||X.defaultElements.get(t)}}class j{v;L=void 0;get hasValue(){return void 0!==this.L}constructor(t){this.v=t}get value(){return void 0===this.L&&(this.L=this.v()),this.L}reset(){this.L=void 0}}t.LogLevel=void 0,(T=t.LogLevel||(t.LogLevel={}))[T.None=0]="None",T[T.Debug=1]="Debug",T[T.Info=2]="Info",T[T.Warning=3]="Warning",T[T.Error=4]="Error";class J{static logLevel=t.LogLevel.Info;static W(t,e){return`[AlphaTab][${t}] ${e}`}debug(t,e,...s){console.debug(J.W(t,e),...s)}warning(t,e,...s){console.warn(J.W(t,e),...s)}info(t,e,...s){console.info(J.W(t,e),...s)}error(t,e,...s){console.error(J.W(t,e),...s)}}class q{static logLevel=t.LogLevel.Info;static log=new J;static R(e){return q.logLevel!==t.LogLevel.None&&e>=q.logLevel}static debug(e,s,...i){q.R(t.LogLevel.Debug)&&q.log.debug(e,s,...i)}static warning(e,s,...i){q.R(t.LogLevel.Warning)&&q.log.warning(e,s,...i)}static info(e,s,...i){q.R(t.LogLevel.Info)&&q.log.info(e,s,...i)}static error(e,s,...i){q.R(t.LogLevel.Error)&&q.log.error(e,s,...i)}}!function(t){t[t.None=0]="None",t[t.Natural=1]="Natural",t[t.Sharp=2]="Sharp",t[t.Flat=3]="Flat",t[t.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",t[t.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",t[t.FlatQuarterNoteUp=6]="FlatQuarterNoteUp",t[t.DoubleSharp=7]="DoubleSharp",t[t.DoubleFlat=8]="DoubleFlat"}(x||(x={})),function(t){t[t.Neutral=0]="Neutral",t[t.C3=1]="C3",t[t.C4=2]="C4",t[t.F4=3]="F4",t[t.G2=4]="G2"}(M||(M={})),function(t){t[t.None=0]="None",t[t.Simple=1]="Simple",t[t.FirstOfDouble=2]="FirstOfDouble",t[t.SecondOfDouble=3]="SecondOfDouble"}(v||(v={}));class Y{colors=new Map}!function(t){t[t.Cb=-7]="Cb",t[t.Gb=-6]="Gb",t[t.Db=-5]="Db",t[t.Ab=-4]="Ab",t[t.Eb=-3]="Eb",t[t.Bb=-2]="Bb",t[t.F=-1]="F",t[t.C=0]="C",t[t.G=1]="G",t[t.D=2]="D",t[t.A=3]="A",t[t.E=4]="E",t[t.B=5]="B",t[t.FSharp=6]="FSharp",t[t.CSharp=7]="CSharp"}(N||(N={})),function(t){t[t.Major=0]="Major",t[t.Minor=1]="Minor"}(P||(P={})),function(t){t[t.Down=0]="Down",t[t.Hold=1]="Hold",t[t.Up=2]="Up"}(C||(C={}));class K{ratioPosition=0;pedalType=C.Down;bar;nextPedalMarker=null;previousPedalMarker=null}!function(t){t[t.StandardNotationRepeats=0]="StandardNotationRepeats",t[t.GuitarTabsRepeats=1]="GuitarTabsRepeats",t[t.SlashRepeats=2]="SlashRepeats",t[t.NumberedRepeats=3]="NumberedRepeats",t[t.StandardNotationBarNumber=4]="StandardNotationBarNumber",t[t.GuitarTabsBarNumber=5]="GuitarTabsBarNumber",t[t.SlashBarNumber=6]="SlashBarNumber",t[t.NumberedBarNumber=7]="NumberedBarNumber",t[t.StandardNotationBarLines=8]="StandardNotationBarLines",t[t.GuitarTabsBarLines=9]="GuitarTabsBarLines",t[t.SlashBarLines=10]="SlashBarLines",t[t.NumberedBarLines=11]="NumberedBarLines",t[t.StandardNotationClef=12]="StandardNotationClef",t[t.GuitarTabsClef=13]="GuitarTabsClef",t[t.StandardNotationKeySignature=14]="StandardNotationKeySignature",t[t.NumberedKeySignature=15]="NumberedKeySignature",t[t.StandardNotationTimeSignature=16]="StandardNotationTimeSignature",t[t.GuitarTabsTimeSignature=17]="GuitarTabsTimeSignature",t[t.SlashTimeSignature=18]="SlashTimeSignature",t[t.NumberedTimeSignature=19]="NumberedTimeSignature",t[t.StandardNotationStaffLine=20]="StandardNotationStaffLine",t[t.GuitarTabsStaffLine=21]="GuitarTabsStaffLine",t[t.SlashStaffLine=22]="SlashStaffLine",t[t.NumberedStaffLine=23]="NumberedStaffLine"}(E||(E={}));class Q extends Y{}!function(t){t[t.Automatic=0]="Automatic",t[t.Dashed=1]="Dashed",t[t.Dotted=2]="Dotted",t[t.Heavy=3]="Heavy",t[t.HeavyHeavy=4]="HeavyHeavy",t[t.HeavyLight=5]="HeavyLight",t[t.LightHeavy=6]="LightHeavy",t[t.LightLight=7]="LightLight",t[t.None=8]="None",t[t.Regular=9]="Regular",t[t.Short=10]="Short",t[t.Tick=11]="Tick"}(F||(F={}));class Z{static I=0;static resetIds(){Z.I=0}id=Z.I++;index=0;nextBar=null;previousBar=null;clef=M.G2;clefOttava=m.Regular;staff;voices=[];simileMark=v.None;O=new Set([0]);get isMultiVoice(){return this.O.size>1}get filledVoices(){return this.O}displayScale=1;displayWidth=-1;sustainPedals=[];get masterBar(){return this.staff.track.score.masterBars[this.index]}V=!0;$=!0;get isEmpty(){return this.V}get hasChanges(){if(0===this.index)return!0;return!(this.keySignature===this.previousBar.keySignature&&this.keySignatureType===this.previousBar.keySignatureType&&this.clef===this.previousBar.clef&&this.clefOttava===this.previousBar.clefOttava)||(this.simileMark!==v.None||this.sustainPedals.length>0||this.barLineLeft!==F.Automatic||this.barLineRight!==F.Automatic)}get isRestOnly(){return this.$}barLineLeft=F.Automatic;barLineRight=F.Automatic;keySignature=N.C;keySignatureType=P.Major;barNumberDisplay;shortestDuration=l.DoubleWhole;getActualBarLineLeft(t){return Z.H(this,!1,t)}getActualBarLineRight(){return Z.H(this,!0,!1)}static U(t,e,s){let i;return i=e?t.isRepeatEnd?F.LightHeavy:t.nextMasterBar?t.isFreeTime?F.Dashed:t.isDoubleBar?F.LightLight:F.Regular:F.LightHeavy:t.isRepeatStart?F.HeavyLight:s?F.Regular:F.None,i}static H(t,e,s){const i=t.masterBar,n=e?t.barLineRight:t.barLineLeft;let r;return r=n===F.Automatic?Z.U(i,e,s):n,r}style;addVoice(t){t.bar=this,t.index=this.voices.length,this.voices.push(t)}finish(t,e=null){this.O.clear(),this.O.add(0),this.V=!0,this.$=!0,this.shortestDuration=l.DoubleWhole;for(let s=0,i=this.voices.length;s<i;s++){const i=this.voices[s];i.finish(t,e),i.isEmpty||(this.V=!1,this.O.add(s),i.shortestDuration>this.shortestDuration&&(this.shortestDuration=i.shortestDuration)),i.isRestOnly||(this.$=!1)}const s=this.sustainPedals;if(s.length>0){let t=null;this.sustainPedals=[],this.previousBar&&this.previousBar.sustainPedals.length>0&&(t=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1],t.pedalType===C.Up&&(t=null));const e=null!==t&&t.pedalType!==C.Up;for(const i of s){if(t&&t.pedalType!==C.Up){if(t.bar===this&&i.ratioPosition<=t.ratioPosition)continue;t.nextPedalMarker=i,i.previousPedalMarker=t}e&&i.pedalType===C.Down&&(i.pedalType=C.Hold),i.bar=this,this.sustainPedals.push(i),t=i}}else if(this.previousBar&&this.previousBar.sustainPedals.length>0){const t=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1];if(t.pedalType!==C.Up){const e=new K;e.ratioPosition=0,e.bar=this,e.pedalType=C.Hold,this.sustainPedals.push(e),t.nextPedalMarker=e,e.previousPedalMarker=t}}}calculateDuration(){let t=0;for(const e of this.voices){const s=e.calculateDuration();s>t&&(t=s)}return t}}!function(t){t[t.NoTripletFeel=0]="NoTripletFeel",t[t.Triplet16th=1]="Triplet16th",t[t.Triplet8th=2]="Triplet8th",t[t.Dotted16th=3]="Dotted16th",t[t.Dotted8th=4]="Dotted8th",t[t.Scottish16th=5]="Scottish16th",t[t.Scottish8th=6]="Scottish8th"}(A||(A={}));class tt{X;groups=new Map;uniqueId="";timeSignatureNumerator=0;timeSignatureDenominator=0;static createSimple(t,e,s,i){const n=new tt;return n.timeSignatureNumerator=t,n.timeSignatureDenominator=e,n.groups.set(s,i),n.finish(),n}findRule(t){const e=this.X;if(e)return[e,this.groups.get(e)];if(t<l.Quarter)return[t,[]];let s=t;do{const t=s;if(this.groups.has(t))return[t,this.groups.get(t)];s*=2}while(s<=l.TwoHundredFiftySixth);s=t/2;do{const t=s;if(this.groups.has(t))return[t,this.groups.get(t)];s/=2}while(s>l.Half);return[t,[]]}finish(){let t=`${this.timeSignatureNumerator}_${this.timeSignatureDenominator}`;for(const[e,s]of this.groups){t+=`__${e}`;let i=s.length;for(let t=s.length-1;t>=0&&0===s[t];t--)i=t;i<s.length&&s.splice(i,s.length-i),t+=`_${s.join("_")}`,1===this.groups.size&&(this.X=e)}this.uniqueId=t}}class et{static MaxAlternateEndings=8;alternateEndings=0;nextMasterBar=null;previousMasterBar=null;index=0;get hasChanges(){if(0===this.index)return!1;return!(this.timeSignatureCommon===this.previousMasterBar.timeSignatureCommon&&this.timeSignatureNumerator===this.previousMasterBar.timeSignatureNumerator&&this.timeSignatureDenominator===this.previousMasterBar.timeSignatureDenominator&&this.tripletFeel===this.previousMasterBar.tripletFeel)||(0!==this.alternateEndings||this.isRepeatStart||this.isRepeatEnd||this.isFreeTime||this.isSectionStart||this.tempoAutomations.length>0||this.syncPoints&&this.syncPoints.length>0||null!==this.fermata&&this.fermata.size>0||null!==this.directions&&this.directions.size>0||this.isAnacrusis)}get keySignature(){return this.score.tracks[0].staves[0].bars[this.index].keySignature}set keySignature(t){this.score.tracks[0].staves[0].bars[this.index].keySignature=t}get keySignatureType(){return this.score.tracks[0].staves[0].bars[this.index].keySignatureType}set keySignatureType(t){this.score.tracks[0].staves[0].bars[this.index].keySignatureType=t}isDoubleBar=!1;isRepeatStart=!1;get isRepeatEnd(){return this.repeatCount>0}repeatCount=0;repeatGroup;timeSignatureNumerator=4;timeSignatureDenominator=4;timeSignatureCommon=!1;beamingRules;actualBeamingRules;isFreeTime=!1;tripletFeel=A.NoTripletFeel;section=null;get isSectionStart(){return!!this.section}get tempoAutomation(){return this.tempoAutomations.length>0?this.tempoAutomations[0]:null}tempoAutomations=[];syncPoints;score;fermata=null;start=0;isAnacrusis=!1;displayScale=1;displayWidth=-1;directions=null;calculateDuration(t=!0){if(this.isAnacrusis&&t){let t=0;for(const e of this.score.tracks)for(const s of e.staves){const e=this.index<s.bars.length?s.bars[this.index].calculateDuration():0;e>t&&(t=e)}return t}return this.timeSignatureNumerator*$.valueToTicks(this.timeSignatureDenominator)}addFermata(t,e){let s=this.fermata;null===s&&(s=new Map,this.fermata=s),s.set(t,e)}addDirection(t){null==this.directions&&(this.directions=new Set),this.directions.add(t)}getFermata(t){const e=this.fermata;return null===e?null:e.has(t.playbackStart)?e.get(t.playbackStart):0===t.index&&e.has(0)?e.get(0):null}addSyncPoint(t){this.syncPoints||(this.syncPoints=[]),this.syncPoints.push(t)}finish(t){let e=this.beamingRules;if(e&&(e.timeSignatureNumerator=this.timeSignatureNumerator,e.timeSignatureDenominator=this.timeSignatureDenominator,e.finish()),this.index>0){this.start=this.previousMasterBar.start+this.previousMasterBar.calculateDuration();const s=t.has("beamingRules")?t.get("beamingRules"):void 0;s&&s.uniqueId===e?.uniqueId?(this.beamingRules=void 0,e=s):e||(e=s)}this.actualBeamingRules=e,this.beamingRules&&t.set("beamingRules",e)}}!function(t){t[t.NoBrackets=0]="NoBrackets",t[t.GroupStaves=1]="GroupStaves",t[t.GroupSimilarInstruments=2]="GroupSimilarInstruments"}(D||(D={})),function(t){t[t.Hidden=0]="Hidden",t[t.FirstSystem=1]="FirstSystem",t[t.AllSystems=2]="AllSystems"}(L||(L={})),function(t){t[t.FullName=0]="FullName",t[t.ShortName=1]="ShortName"}(W||(W={})),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(R||(R={})),function(t){t[t.AllBars=0]="AllBars",t[t.FirstOfSystem=1]="FirstOfSystem",t[t.Hide=2]="Hide"}(I||(I={}));class st{hideDynamics=!1;bracketExtendMode=D.GroupStaves;useSystemSignSeparator=!1;globalDisplayTuning=!0;perTrackDisplayTuning=null;globalDisplayChordDiagramsOnTop=!0;perTrackChordDiagramsOnTop=null;globalDisplayChordDiagramsInScore=!1;singleTrackTrackNamePolicy=L.FirstSystem;multiTrackTrackNamePolicy=L.FirstSystem;firstSystemTrackNameMode=W.ShortName;otherSystemsTrackNameMode=W.ShortName;firstSystemTrackNameOrientation=R.Vertical;otherSystemsTrackNameOrientation=R.Vertical;multiTrackMultiBarRest=!1;perTrackMultiBarRest=null;extendBarLines=!1;hideEmptyStaves=!1;hideEmptyStavesInFirstSystem=!1;showSingleStaffBrackets=!1;barNumberDisplay=I.AllBars}class it{masterBars=[];opening=null;get openings(){const t=this.opening;return t?[t]:[]}closings=[];get isOpened(){return!0===this.opening?.isRepeatStart}isClosed=!1;addMasterBar(t){null===this.opening&&(this.opening=t),this.masterBars.push(t),t.repeatGroup=this,t.isRepeatEnd&&(this.closings.push(t),this.isClosed=!0)}}class nt{beats=[];id="empty";isComplete=!1;addBeat(t){t.graceIndex=this.beats.length,t.graceGroup=this,this.beats.push(t)}finish(){this.beats.length>0&&(this.id=`${this.beats[0].absoluteDisplayStart}_${this.beats[0].voice.index}`)}}!function(t){t[t.Glyphs=0]="Glyphs"}(O||(O={}));class rt extends Y{}let at=class t{j;V=!0;$=!0;static J=0;static resetIds(){t.J=0}id=t.J++;index=0;bar;beats=[];get isEmpty(){return this.V}style;forceNonEmpty(){this.V=!1}get isRestOnly(){return this.$}shortestDuration=l.DoubleWhole;insertBeat(t,e){e.nextBeat=t.nextBeat,e.nextBeat&&(e.nextBeat.previousBeat=e),e.previousBeat=t,e.voice=this,t.nextBeat=e,this.beats.splice(t.index+1,0,e)}addBeat(t){t.voice=this,t.index=this.beats.length,this.beats.push(t),t.isEmpty||(this.V=!1),t.isRest||(this.$=!1)}q(t,e=null){if(this.bar){if(t.index<this.beats.length-1)t.nextBeat=this.beats[t.index+1],t.nextBeat.previousBeat=t;else if(t.isLastOfVoice&&t.voice.bar.nextBar){const e=this.bar.nextBar.voices[this.index];e.beats.length>0?(t.nextBeat=e.beats[0],t.nextBeat.previousBeat=t):t.nextBeat.previousBeat=t}t.chain(e)}}addGraceBeat(t){if(0===this.beats.length)return void this.addBeat(t);const e=this.beats[this.beats.length-1];this.beats.splice(this.beats.length-1,1),this.addBeat(t),this.addBeat(e),this.V=!1,this.$=!1}getBeatAtPlaybackStart(t){return this.j.has(t)?this.j.get(t):null}finish(t,e=null){this.V=!0,this.$=!0,this.j=new Map;let s=null;for(let t=0;t<this.beats.length;t++){const i=this.beats[t];i.index=t,this.q(i,e),i.graceType===u.None?(i.graceGroup=s,s&&(s.isComplete=!0),s=null):(s||(s=new nt),s.addBeat(i)),i.isEmpty||(this.V=!1),i.isRest||(this.$=!1)}let i=0,n=0;this.shortestDuration=l.DoubleWhole;for(let s=0;s<this.beats.length;s++){const r=this.beats[s];if(r.index=s,r.finish(t,e),r.graceType===u.None){if(r.duration>this.shortestDuration&&(this.shortestDuration=r.duration),r.graceGroup){const t=r.graceGroup.beats[0],e=r.graceGroup.beats[r.graceGroup.beats.length-1];if(t.graceType!==u.BendGrace){const s=e.playbackStart+e.playbackDuration-t.playbackStart;switch(t.graceType){case u.BeforeBeat:t.previousBeat?(t.previousBeat.playbackDuration-=s,n=t.previousBeat.voice===this?t.previousBeat.playbackStart+t.previousBeat.playbackDuration:-s):n=-s;for(const t of r.graceGroup.beats)this.j.delete(t.playbackStart),t.playbackStart=n,this.j.set(t.playbackStart,r),n+=t.playbackDuration;break;case u.OnBeat:r.playbackDuration-=s,n=e.voice===this?e.playbackStart+e.playbackDuration:-s}}}r.displayStart=i,r.playbackStart=n,this.j.set(r.playbackStart,r)}else r.displayStart=i,r.playbackStart=n;r.fermata?this.bar.masterBar.addFermata(r.playbackStart,r.fermata):r.fermata=this.bar.masterBar.getFermata(r),r.finishTuplet(),r.graceGroup&&r.graceGroup.finish(),i+=r.displayDuration,n+=r.playbackDuration}}calculateDuration(){if(this.isEmpty||0===this.beats.length)return 0;const t=this.beats[this.beats.length-1],e=this.beats[0];return t.playbackStart+t.playbackDuration-e.playbackStart}};var ht,ot,ct,lt,ut,dt,ft,pt,bt,mt,gt,wt,yt,kt,St,Bt,_t,Tt,xt,Mt,vt,Nt,Pt,Ct,Et,Ft,At,Dt,Lt,Wt,Rt;!function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(ht||(ht={})),function(t){t[t.Top=0]="Top",t[t.Middle=1]="Middle",t[t.Bottom=2]="Bottom",t[t.Alphabetic=3]="Alphabetic"}(ot||(ot={}));class It{width;height;constructor(t,e){this.width=t,this.height=e}}class Ot{static fillMusicFontSymbolSafe(t,e,s,i,n,r){t.settings.display.resources.engravingSettings.hasSymbol(n)&&t.fillMusicFontSymbol(e,s,i,n,r)}static fillMusicFontSymbolsSafe(t,e,s,i,n,r){const a=n.filter(e=>t.settings.display.resources.engravingSettings.hasSymbol(e));0!==a.length&&t.fillMusicFontSymbols(e,s,i,a,r)}}!function(t){t[t.Title=0]="Title",t[t.SubTitle=1]="SubTitle",t[t.Artist=2]="Artist",t[t.Album=3]="Album",t[t.Words=4]="Words",t[t.Music=5]="Music",t[t.WordsAndMusic=6]="WordsAndMusic",t[t.Transcriber=7]="Transcriber",t[t.Copyright=8]="Copyright",t[t.CopyrightSecondLine=9]="CopyrightSecondLine",t[t.ChordDiagramList=10]="ChordDiagramList"}(ct||(ct={}));class Gt{template;isVisible;textAlign;constructor(t="",e=void 0,s=ht.Left){this.template=t,this.isVisible=e,this.textAlign=s}static equals(t,e){return(void 0===t.isVisible||t.isVisible)===(void 0===e.isVisible||e.isVisible)&&(t.template===e.template&&t.textAlign===e.textAlign)}buildText(t){let e=!1,s=!1;const i=this.template.replace(Gt.Y,(i,n)=>{s=!0;let r="";switch(n){case"TITLE":r=t.title;break;case"SUBTITLE":r=t.subTitle;break;case"ARTIST":r=t.artist;break;case"ALBUM":r=t.album;break;case"WORDS":case"WORDSMUSIC":r=t.words;break;case"MUSIC":r=t.music;break;case"TABBER":r=t.tab;break;case"COPYRIGHT":r=t.copyright;break;default:r=""}return r&&(e=!0),r});return s&&!e?"":i}static Y=/%([^%]+)%/g}class Vt extends Y{headerAndFooter=new Map;static defaultHeaderAndFooter=new Map([[ct.Title,new Gt("%TITLE%",void 0,ht.Center)],[ct.SubTitle,new Gt("%SUBTITLE%",void 0,ht.Center)],[ct.Artist,new Gt("%ARTIST%",void 0,ht.Center)],[ct.Album,new Gt("%ALBUM%",void 0,ht.Center)],[ct.Words,new Gt("Words by %WORDS%",void 0,ht.Left)],[ct.Music,new Gt("Music by %MUSIC%",void 0,ht.Right)],[ct.WordsAndMusic,new Gt("Words & Music by %MUSIC%",void 0,ht.Right)],[ct.Transcriber,new Gt("Tabbed by %TABBER%",!1,ht.Right)],[ct.Copyright,new Gt("%COPYRIGHT%",void 0,ht.Center)],[ct.CopyrightSecondLine,new Gt("All Rights Reserved - International Copyright Secured",!0,ht.Center)]])}class $t{K=null;Z=[];tt=0;static resetIds(){Z.resetIds(),se.resetIds(),at.resetIds(),Qt.resetIds()}album="";artist="";copyright="";instructions="";music="";notices="";subTitle="";title="";words="";tab="";get tempo(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].value:120}get tempoLabel(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].text:""}masterBars=[];tracks=[];defaultSystemsLayout=3;systemsLayout=[];stylesheet=new st;backingTrack;style;rebuildRepeatGroups(){this.K=null,this.Z=[],this.tt=0;for(const t of this.masterBars)this.et(t)}addMasterBar(t){t.score=this,t.index=this.masterBars.length,0!==this.masterBars.length&&(t.previousMasterBar=this.masterBars[this.masterBars.length-1],t.previousMasterBar.nextMasterBar=t,t.start=t.previousMasterBar.start+(t.previousMasterBar.isAnacrusis?0:t.previousMasterBar.calculateDuration())),this.et(t),this.masterBars.push(t)}et(t){t.isRepeatStart?(this.K?.isClosed&&(this.Z.pop(),this.tt--),this.K=new it,this.Z.push(this.K),this.tt++):this.K||(this.K=new it,this.Z.push(this.K)),this.K.addMasterBar(t),t.isRepeatEnd&&this.tt>1&&(this.Z.pop(),this.tt--,this.K=this.Z.length>0?this.Z[this.Z.length-1]:null)}addTrack(t){t.score=this,t.index=this.tracks.length,this.tracks.push(t)}finish(t){const e=new Map;for(let s=0,i=this.tracks.length;s<i;s++)this.tracks[s].finish(t,e);for(const t of this.masterBars)t.finish(e)}applyFlatSyncPoints(t){for(const t of this.masterBars)t.syncPoints=void 0;for(const e of t){const t=new U;t.ratioPosition=Math.min(1,Math.max(0,e.barPosition)),t.type=r.SyncPoint,t.syncPointValue=new H,t.syncPointValue.millisecondOffset=e.millisecondOffset,t.syncPointValue.barOccurence=e.barOccurence,e.barIndex<this.masterBars.length&&this.masterBars[e.barIndex].addSyncPoint(t)}for(const t of this.masterBars)t.syncPoints&&t.syncPoints.sort((t,e)=>{const s=t.syncPointValue.barOccurence-e.syncPointValue.barOccurence;return 0!==s?s:t.ratioPosition-e.ratioPosition})}exportFlatSyncPoints(){const t=[];for(const e of this.masterBars){const s=e.syncPoints;if(s)for(const i of s)t.push({barIndex:e.index,barOccurence:i.syncPointValue.barOccurence,barPosition:i.ratioPosition,millisecondOffset:i.syncPointValue.millisecondOffset})}return t}}class Ht{static DefaultChannelCount=17;static MetronomeChannel=Ht.DefaultChannelCount-1;static MetronomeKey=33;static AudioChannels=2;static MinVolume=0;static MinProgram=0;static MaxProgram=127;static MinPlaybackSpeed=.125;static MaxPlaybackSpeed=8;static PercussionChannel=9;static PercussionBank=128;static MaxPitchWheel=16384;static MaxPitchWheel20=4294967296;static DefaultPitchWheel=Ht.MaxPitchWheel/2;static MicroBufferCount=32;static MicroBufferSize=64}class Ut{note=null;tone=new zt;octave=0;get realValue(){return 12*this.octave+this.tone.noteValue}}class zt{noteValue;accidentalMode;constructor(t=0,e=b.Default){this.noteValue=t,this.accidentalMode=e}}class Xt{static st=Xt.it();static it(){return new Map(Object.values(l).filter(t=>"number"==typeof t).map(t=>[t,t<0?0:0|Math.log2(t)]))}static getIndex(t){return Xt.st.get(t)}static keySignatureIsFlat(t){return t<0}static keySignatureIsNatural(t){return 0===t}static keySignatureIsSharp(t){return t>0}static applyPitchOffsets(t,e){for(let s=0;s<e.tracks.length;s++){if(s<t.notation.displayTranspositionPitches.length)for(const i of e.tracks[s].staves)i.displayTranspositionPitch=-t.notation.displayTranspositionPitches[s];if(s<t.notation.transpositionPitches.length)for(const i of e.tracks[s].staves)i.transpositionPitch=-t.notation.transpositionPitches[s]}}static isTuning(t){return!!Xt.parseTuning(t)}static tuningLetters=new Set([67,68,69,70,71,65,66,99,100,101,102,103,97,98,35]);static parseTuning(t){let e="",s="";for(let i=0;i<t.length;i++){const n=t.charCodeAt(i);if(n>=48&&n<=57){if(!e)return null;s+=String.fromCharCode(n)}else if(0===e.length){if(!Xt.tuningLetters.has(n))return null;e+=String.fromCharCode(n)}else e+=String.fromCharCode(n)}if(!s||!e)return null;const i=new Ut;i.octave=Number.parseInt(s,10)+1,i.note=e.toLowerCase();const n=Xt.getToneForText(i.note);return null===n?null:(i.tone=n,i.tone.noteValue<0&&(i.octave--,i.tone.noteValue+=12),i)}static getTuningForText(t){const e=Xt.parseTuning(t);return e?e.realValue:-1}static getToneForText(t){const e=t.substring(0,1),s=t.substring(1);let i,n;switch(e.toLowerCase()){case"c":i=0;break;case"d":i=2;break;case"e":i=4;break;case"f":i=5;break;case"g":i=7;break;case"a":i=9;break;case"b":i=11;break;default:return null}if(!Xt.accidentalModeMapping.has(s))return null;switch(n=Xt.parseAccidentalMode(s),n){case b.Default:case b.ForceNone:case b.ForceNatural:break;case b.ForceSharp:i++;break;case b.ForceDoubleSharp:i+=2;break;case b.ForceFlat:i--;break;case b.ForceDoubleFlat:i-=2}return new zt(i,n)}static reverseAccidentalModeMapping=new Map([[b.Default,"d"],[b.ForceNone,"forcenone"],[b.ForceNatural,"forcenatural"],[b.ForceSharp,"#"],[b.ForceDoubleSharp,"x"],[b.ForceFlat,"b"],[b.ForceDoubleFlat,"bb"]]);static accidentalModeMapping=new Map([["default",b.Default],["d",b.Default],["",b.Default],["forcenone",b.ForceNone],["-",b.ForceNone],["forcenatural",b.ForceNatural],["n",b.ForceNatural],["forcesharp",b.ForceSharp],["#",b.ForceSharp],["forcedoublesharp",b.ForceDoubleSharp],["##",b.ForceDoubleSharp],["x",b.ForceDoubleSharp],["forceflat",b.ForceFlat],["b",b.ForceFlat],["forcedoubleflat",b.ForceDoubleFlat],["bb",b.ForceDoubleFlat]]);static parseAccidentalMode(t){const e=t.toLowerCase();return Xt.accidentalModeMapping.has(e)?Xt.accidentalModeMapping.get(e):b.Default}static newGuid(){return`${Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}`}static isAlmostEqualTo(t,e){return Math.abs(t-e)<1e-5}static toHexString(t,e=0){let s="";do{s=String.fromCharCode("0123456789ABCDEF".charCodeAt(15&t))+s,t>>=4}while(t>0);for(;s.length<e;)s=`0${s}`;return s}static getAlternateEndingsList(t){const e=[];for(let s=0;s<et.MaxAlternateEndings;s++)t&1<<s&&e.push(s);return e}static deltaFretToHarmonicValue(t){switch(t){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return t;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}static clamp(t,e,s){return t<=e?e:t>=s?s:t}static buildMultiBarRestInfo(t,e,s){if(!t)return null;const i=t[0].score.stylesheet;if(!(t.length>1?i.multiTrackMultiBarRest:!0===i.perTrackMultiBarRest?.has(t[0].index)))return null;const n=new Map,r=t[0].score;let a=e,h=r.tempo;for(;a<=s;){const i=a;let o=null;for(;a<=s;){const s=r.masterBars[a];let n=!1;for(const t of s.tempoAutomations)t.value!==h&&(n=!0),h=t.value;if(s.alternateEndings||s.isRepeatStart&&s.index!==i||s.isFreeTime||s.isAnacrusis||null!==s.section||s.index!==i&&n||null!==s.fermata&&s.fermata.size>0||null!==s.directions&&s.directions.size>0)break;if(i>e&&s.previousMasterBar&&(s.timeSignatureCommon!==s.previousMasterBar.timeSignatureCommon||s.timeSignatureNumerator!==s.previousMasterBar.timeSignatureNumerator||s.timeSignatureDenominator!==s.previousMasterBar.timeSignatureDenominator||s.tripletFeel!==s.previousMasterBar.tripletFeel))break;let c=!0;for(const e of t){for(const t of e.staves){const e=t.bars[s.index];if(!e.isRestOnly){c=!1;break}if(e.index>0&&(e.keySignature!==e.previousBar.keySignature||e.keySignatureType!==e.previousBar.keySignatureType)){c=!1;break}}if(!c)break}if(!c)break;if(a++,s.index>i&&(null===o?o=[s.index]:o.push(s.index)),s.isRepeatEnd)break}o?n.set(i,o):a++}return n}static computeFirstDisplayedBarIndex(t,e){let s=e.display.startBar;return s--,s=Math.min(t.masterBars.length-1,Math.max(0,s)),s}static computeLastDisplayedBarIndex(t,e,s){let i=e.display.barCount;return i<0&&(i=t.masterBars.length),i=s+i-1,i=Math.min(t.masterBars.length-1,Math.max(0,i)),i}static getOrCreateHeaderFooterStyle(t,e){let s,i=t.style;if(t.style||(i=new Vt,t.style=i),i.headerAndFooter.has(e))s=i.headerAndFooter.get(e);else{if(s=new Gt,Vt.defaultHeaderAndFooter.has(e)){const t=Vt.defaultHeaderAndFooter.get(e);s.template=t.template,s.textAlign=t.textAlign}i.headerAndFooter.set(e,s)}return s}static consolidate(t){if(0===t.masterBars.length){const e=new et;t.addMasterBar(e);const s=new U;s.isLinear=!1,s.type=r.Tempo,s.value=t.tempo,e.tempoAutomations.push(s);const i=new Z;t.tracks[0].staves[0].addBar(i);const n=new at;i.addVoice(n);const a=new se;return a.isEmpty=!0,void n.addBeat(a)}const e=new Set([Ht.PercussionChannel]);for(const s of t.tracks){if(1===s.staves.length&&s.staves[0].isPercussion)s.playbackInfo.primaryChannel=Ht.PercussionChannel,s.playbackInfo.secondaryChannel=Ht.PercussionChannel;else{if(s.playbackInfo.primaryChannel!==Ht.PercussionChannel)for(;e.has(s.playbackInfo.primaryChannel);)s.playbackInfo.primaryChannel++;if(e.add(s.playbackInfo.primaryChannel),s.playbackInfo.secondaryChannel!==Ht.PercussionChannel)for(;e.has(s.playbackInfo.secondaryChannel);)s.playbackInfo.secondaryChannel++;e.add(s.playbackInfo.secondaryChannel)}for(const e of s.staves){for(const t of e.bars)for(const e of t.voices)if(e.isEmpty&&0===e.beats.length){const t=new se;t.isEmpty=!0,e.addBeat(t)}const s=0===e.bars.length?1:e.bars[0].voices.length;for(;e.bars.length<t.masterBars.length;){const t=new Z;e.addBar(t);const i=t.previousBar;i&&(t.clef=i.clef,t.clefOttava=i.clefOttava,t.keySignature=t.previousBar.keySignature,t.keySignatureType=t.previousBar.keySignatureType);for(let e=0;e<s;e++){const e=new at;t.addVoice(e);const s=new se;s.isEmpty=!0,e.addBeat(s)}}}}if(t.masterBars.length>0){if(!t.masterBars[0].tempoAutomations.find(t=>t.type===r.Tempo&&0===t.ratioPosition)){const e=new U;e.isLinear=!1,e.type=r.Tempo,e.value=t.tempo,e.text=t.tempoLabel,e.isVisible=!1,t.masterBars[0].tempoAutomations.push(e)}}}static trimEmptyBarsAtEnd(t){for(;t.masterBars.length>1;){const e=t.masterBars.length-1,s=t.masterBars[e];if(s.hasChanges)return;for(const s of t.tracks)for(const t of s.staves)if(e<t.bars.length){const s=t.bars[e];if(!s.isEmpty||s.hasChanges)return}for(const s of t.tracks)for(const t of s.staves)if(e<t.bars.length){const s=t.bars[e];t.bars.pop(),s.previousBar.nextBar=null}t.masterBars.pop(),s.previousMasterBar.nextMasterBar=null}}static displayTranspositionPitches=new Map([[24,-12],[25,-12],[26,-12],[27,-12],[28,-12],[29,-12],[30,-12],[31,-12],[32,-12],[33,-12],[34,-12],[35,-12],[36,-12],[37,-12],[38,-12],[39,-12],[43,-12]]);static flooredDivision(t,e){return t-e*Math.floor(t/e)}static nt(t){const e=[];for(const s of t){const t=[];e.push(t);for(const e of s){const s=Number.parseInt(e.charAt(0),10)*("b"===e.charAt(1)?-1:1);t.push(s)}}return e}static rt=Xt.nt([["7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#"],["2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b","0#"],["3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#"],["4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b"],["1#","2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#"],["6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b"],["1b","0#","1#","2#","3#","4#","7b","6#","7#","4b","3b","2b","1b","0#","1#"],["4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#"],["3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b"],["2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#"],["5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b"],["0#","1#","2#","3#","4#","7b","6b","6#","4b","3b","2b","1b","0#","1#","2#"]]);static transposeKey(t,e){if(0===e)return t;if(e<0){const s=Xt.rt[-e].indexOf(t);return-1===s?t:s-7}return Xt.rt[e][t+7]}static ht=[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]];static accidentalNotes=[!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!0,!1];static computeAccidental(t,e,s,i,n=null){const r=t+7,a=s%12,h=r<7?x.Flat:x.Sharp,o=Xt.ht[r][a],c=Xt.accidentalNotes[a];let l=x.None;if(i)switch(l=c?h:x.Natural,l){case x.Natural:l=x.NaturalQuarterNoteUp;break;case x.Sharp:l=x.SharpQuarterNoteUp;break;case x.Flat:l=x.FlatQuarterNoteUp}else{switch(e){case b.ForceSharp:l=x.Sharp;break;case b.ForceDoubleSharp:l=x.DoubleSharp;break;case b.ForceFlat:l=x.Flat;break;case b.ForceDoubleFlat:l=x.DoubleFlat;break;default:c?l=h:o&&(l=x.Natural)}l!==x.None?null!=n?n===l&&(l=x.None):o&&l===h&&(l=x.None):null!==n&&(l=n===x.Natural?x.None:x.Natural)}return l}static toArticulationId(t){return t.replace(/[^a-zA-Z0-9]/g,"").toLowerCase()}static minBoundingBox(t,e){return Number.isNaN(t)?e:Number.isNaN(e)||t<e?t:e}static maxBoundingBox(t,e){return Number.isNaN(t)?e:Number.isNaN(e)||t>e?t:e}static getSystemLayout(t,e,s){let i,n;return 1===s.length?(i=s[0].defaultSystemsLayout,n=s[0].systemsLayout):(i=t.defaultSystemsLayout,n=t.systemsLayout),e<n.length?n[e]:i}}!function(t){t[t.None=0]="None",t[t.Up=1]="Up",t[t.Down=2]="Down"}(lt||(lt={})),function(t){t[t.None=-1]="None",t[t.Space=32]="Space",t[t.Brace=57344]="Brace",t[t.BracketTop=57347]="BracketTop",t[t.BracketBottom=57348]="BracketBottom",t[t.SystemDivider=57351]="SystemDivider",t[t.GClef=57424]="GClef",t[t.GClef15mb=57425]="GClef15mb",t[t.GClef8vb=57426]="GClef8vb",t[t.GClef8va=57427]="GClef8va",t[t.GClef15ma=57428]="GClef15ma",t[t.CClef=57436]="CClef",t[t.CClef8vb=57437]="CClef8vb",t[t.FClef=57442]="FClef",t[t.FClef15mb=57443]="FClef15mb",t[t.FClef8vb=57444]="FClef8vb",t[t.FClef8va=57445]="FClef8va",t[t.FClef15ma=57446]="FClef15ma",t[t.UnpitchedPercussionClef1=57449]="UnpitchedPercussionClef1",t[t.SixStringTabClef=57453]="SixStringTabClef",t[t.FourStringTabClef=57454]="FourStringTabClef",t[t.Clef8=57469]="Clef8",t[t.Clef15=57470]="Clef15",t[t.TimeSig0=57472]="TimeSig0",t[t.TimeSig1=57473]="TimeSig1",t[t.TimeSig2=57474]="TimeSig2",t[t.TimeSig3=57475]="TimeSig3",t[t.TimeSig4=57476]="TimeSig4",t[t.TimeSig5=57477]="TimeSig5",t[t.TimeSig6=57478]="TimeSig6",t[t.TimeSig7=57479]="TimeSig7",t[t.TimeSig8=57480]="TimeSig8",t[t.TimeSig9=57481]="TimeSig9",t[t.TimeSigCommon=57482]="TimeSigCommon",t[t.TimeSigCutCommon=57483]="TimeSigCutCommon",t[t.NoteheadDoubleWholeSquare=57505]="NoteheadDoubleWholeSquare",t[t.NoteheadDoubleWhole=57504]="NoteheadDoubleWhole",t[t.NoteheadWhole=57506]="NoteheadWhole",t[t.NoteheadHalf=57507]="NoteheadHalf",t[t.NoteheadBlack=57508]="NoteheadBlack",t[t.NoteheadNull=57509]="NoteheadNull",t[t.NoteheadXOrnate=57514]="NoteheadXOrnate",t[t.NoteheadPlusDoubleWhole=57516]="NoteheadPlusDoubleWhole",t[t.NoteheadPlusWhole=57517]="NoteheadPlusWhole",t[t.NoteheadPlusHalf=57518]="NoteheadPlusHalf",t[t.NoteheadPlusBlack=57519]="NoteheadPlusBlack",t[t.NoteheadSquareWhite=57528]="NoteheadSquareWhite",t[t.NoteheadSquareBlack=57529]="NoteheadSquareBlack",t[t.NoteheadTriangleUpDoubleWhole=57530]="NoteheadTriangleUpDoubleWhole",t[t.NoteheadTriangleUpWhole=57531]="NoteheadTriangleUpWhole",t[t.NoteheadTriangleUpHalf=57532]="NoteheadTriangleUpHalf",t[t.NoteheadTriangleUpBlack=57534]="NoteheadTriangleUpBlack",t[t.NoteheadTriangleRightWhite=57537]="NoteheadTriangleRightWhite",t[t.NoteheadTriangleRightBlack=57538]="NoteheadTriangleRightBlack",t[t.NoteheadTriangleDownDoubleWhole=57548]="NoteheadTriangleDownDoubleWhole",t[t.NoteheadTriangleDownWhole=57540]="NoteheadTriangleDownWhole",t[t.NoteheadTriangleDownHalf=57541]="NoteheadTriangleDownHalf",t[t.NoteheadTriangleDownBlack=57543]="NoteheadTriangleDownBlack",t[t.NoteheadDiamondDoubleWhole=57559]="NoteheadDiamondDoubleWhole",t[t.NoteheadDiamondWhole=57560]="NoteheadDiamondWhole",t[t.NoteheadDiamondHalf=57561]="NoteheadDiamondHalf",t[t.NoteheadDiamondBlack=57563]="NoteheadDiamondBlack",t[t.NoteheadDiamondBlackWide=57564]="NoteheadDiamondBlackWide",t[t.NoteheadDiamondWhite=57565]="NoteheadDiamondWhite",t[t.NoteheadDiamondWhiteWide=57566]="NoteheadDiamondWhiteWide",t[t.NoteheadCircleXDoubleWhole=57520]="NoteheadCircleXDoubleWhole",t[t.NoteheadCircleXWhole=57521]="NoteheadCircleXWhole",t[t.NoteheadCircleXHalf=57522]="NoteheadCircleXHalf",t[t.NoteheadCircleX=57523]="NoteheadCircleX",t[t.NoteheadXDoubleWhole=57510]="NoteheadXDoubleWhole",t[t.NoteheadXWhole=57511]="NoteheadXWhole",t[t.NoteheadXHalf=57512]="NoteheadXHalf",t[t.NoteheadXBlack=57513]="NoteheadXBlack",t[t.NoteheadParenthesis=57550]="NoteheadParenthesis",t[t.NoteheadSlashedBlack1=57551]="NoteheadSlashedBlack1",t[t.NoteheadSlashedBlack2=57552]="NoteheadSlashedBlack2",t[t.NoteheadSlashedHalf1=57553]="NoteheadSlashedHalf1",t[t.NoteheadSlashedHalf2=57554]="NoteheadSlashedHalf2",t[t.NoteheadSlashedWhole1=57555]="NoteheadSlashedWhole1",t[t.NoteheadSlashedWhole2=57556]="NoteheadSlashedWhole2",t[t.NoteheadSlashedDoubleWhole1=57557]="NoteheadSlashedDoubleWhole1",t[t.NoteheadSlashedDoubleWhole2=57558]="NoteheadSlashedDoubleWhole2",t[t.NoteheadCircledBlack=57572]="NoteheadCircledBlack",t[t.NoteheadCircledHalf=57573]="NoteheadCircledHalf",t[t.NoteheadCircledWhole=57574]="NoteheadCircledWhole",t[t.NoteheadCircledDoubleWhole=57575]="NoteheadCircledDoubleWhole",t[t.NoteheadCircleSlash=57591]="NoteheadCircleSlash",t[t.NoteheadHeavyX=57592]="NoteheadHeavyX",t[t.NoteheadHeavyXHat=57593]="NoteheadHeavyXHat",t[t.NoteheadSlashHorizontalEnds=57601]="NoteheadSlashHorizontalEnds",t[t.NoteheadSlashWhiteWhole=57602]="NoteheadSlashWhiteWhole",t[t.NoteheadSlashWhiteHalf=57603]="NoteheadSlashWhiteHalf",t[t.NoteheadRoundWhiteWithDot=57621]="NoteheadRoundWhiteWithDot",t[t.NoteheadSquareBlackLarge=57626]="NoteheadSquareBlackLarge",t[t.NoteheadSquareBlackWhite=57627]="NoteheadSquareBlackWhite",t[t.NoteheadClusterDoubleWhole3rd=57640]="NoteheadClusterDoubleWhole3rd",t[t.NoteheadClusterWhole3rd=57641]="NoteheadClusterWhole3rd",t[t.NoteheadClusterHalf3rd=57642]="NoteheadClusterHalf3rd",t[t.NoteheadClusterQuarter3rd=57643]="NoteheadClusterQuarter3rd",t[t.NoteShapeRoundWhite=57776]="NoteShapeRoundWhite",t[t.NoteShapeRoundBlack=57777]="NoteShapeRoundBlack",t[t.NoteShapeSquareWhite=57778]="NoteShapeSquareWhite",t[t.NoteShapeSquareBlack=57779]="NoteShapeSquareBlack",t[t.NoteShapeTriangleRightWhite=57780]="NoteShapeTriangleRightWhite",t[t.NoteShapeTriangleRightBlack=57781]="NoteShapeTriangleRightBlack",t[t.NoteShapeTriangleLeftWhite=57782]="NoteShapeTriangleLeftWhite",t[t.NoteShapeTriangleLeftBlack=57783]="NoteShapeTriangleLeftBlack",t[t.NoteShapeDiamondWhite=57784]="NoteShapeDiamondWhite",t[t.NoteShapeDiamondBlack=57785]="NoteShapeDiamondBlack",t[t.NoteShapeTriangleUpWhite=57786]="NoteShapeTriangleUpWhite",t[t.NoteShapeTriangleUpBlack=57787]="NoteShapeTriangleUpBlack",t[t.NoteShapeMoonWhite=57788]="NoteShapeMoonWhite",t[t.NoteShapeMoonBlack=57789]="NoteShapeMoonBlack",t[t.NoteShapeTriangleRoundWhite=57790]="NoteShapeTriangleRoundWhite",t[t.NoteShapeTriangleRoundBlack=57791]="NoteShapeTriangleRoundBlack",t[t.NoteQuarterUp=57813]="NoteQuarterUp",t[t.Note8thUp=57815]="Note8thUp",t[t.MetNoteQuarterUp=60581]="MetNoteQuarterUp",t[t.MetNote8thUp=60583]="MetNote8thUp",t[t.MetAugmentationDot=60599]="MetAugmentationDot",t[t.ArrowheadBlackUp=60280]="ArrowheadBlackUp",t[t.ArrowheadBlackDown=60284]="ArrowheadBlackDown",t[t.AugmentationDot=57831]="AugmentationDot",t[t.TextBlackNoteLongStem=57841]="TextBlackNoteLongStem",t[t.TextBlackNoteFrac8thLongStem=57843]="TextBlackNoteFrac8thLongStem",t[t.TextBlackNoteFrac16thLongStem=57845]="TextBlackNoteFrac16thLongStem",t[t.TextBlackNoteFrac32ndLongStem=57846]="TextBlackNoteFrac32ndLongStem",t[t.TextCont8thBeamLongStem=57848]="TextCont8thBeamLongStem",t[t.TextCont16thBeamLongStem=57850]="TextCont16thBeamLongStem",t[t.TextCont32ndBeamLongStem=57851]="TextCont32ndBeamLongStem",t[t.TextAugmentationDot=57852]="TextAugmentationDot",t[t.TextTupletBracketStartLongStem=57857]="TextTupletBracketStartLongStem",t[t.TextTuplet3LongStem=57858]="TextTuplet3LongStem",t[t.TextTupletBracketEndLongStem=57859]="TextTupletBracketEndLongStem",t[t.Tremolo1=57888]="Tremolo1",t[t.Tremolo2=57889]="Tremolo2",t[t.Tremolo3=57890]="Tremolo3",t[t.Tremolo4=57891]="Tremolo4",t[t.Tremolo5=57892]="Tremolo5",t[t.BuzzRoll=57898]="BuzzRoll",t[t.Flag8thUp=57920]="Flag8thUp",t[t.Flag8thDown=57921]="Flag8thDown",t[t.Flag16thUp=57922]="Flag16thUp",t[t.Flag16thDown=57923]="Flag16thDown",t[t.Flag32ndUp=57924]="Flag32ndUp",t[t.Flag32ndDown=57925]="Flag32ndDown",t[t.Flag64thUp=57926]="Flag64thUp",t[t.Flag64thDown=57927]="Flag64thDown",t[t.Flag128thUp=57928]="Flag128thUp",t[t.Flag128thDown=57929]="Flag128thDown",t[t.Flag256thUp=57930]="Flag256thUp",t[t.Flag256thDown=57931]="Flag256thDown",t[t.AccidentalFlat=57952]="AccidentalFlat",t[t.AccidentalNatural=57953]="AccidentalNatural",t[t.AccidentalSharp=57954]="AccidentalSharp",t[t.AccidentalDoubleSharp=57955]="AccidentalDoubleSharp",t[t.AccidentalDoubleFlat=57956]="AccidentalDoubleFlat",t[t.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",t[t.AccidentalQuarterToneSharpNaturalArrowUp=57970]="AccidentalQuarterToneSharpNaturalArrowUp",t[t.AccidentalThreeQuarterTonesSharpArrowUp=57972]="AccidentalThreeQuarterTonesSharpArrowUp",t[t.RepeatDot=57412]="RepeatDot",t[t.Segno=57415]="Segno",t[t.Coda=57416]="Coda",t[t.ArticAccentAbove=58528]="ArticAccentAbove",t[t.ArticAccentBelow=58529]="ArticAccentBelow",t[t.ArticStaccatoAbove=58530]="ArticStaccatoAbove",t[t.ArticStaccatoBelow=58531]="ArticStaccatoBelow",t[t.ArticTenutoAbove=58532]="ArticTenutoAbove",t[t.ArticTenutoBelow=58533]="ArticTenutoBelow",t[t.ArticMarcatoAbove=58540]="ArticMarcatoAbove",t[t.ArticMarcatoBelow=58541]="ArticMarcatoBelow",t[t.FermataAbove=58560]="FermataAbove",t[t.FermataShortAbove=58564]="FermataShortAbove",t[t.FermataLongAbove=58566]="FermataLongAbove",t[t.RestLonga=58593]="RestLonga",t[t.RestDoubleWhole=58594]="RestDoubleWhole",t[t.RestWhole=58595]="RestWhole",t[t.RestHalf=58596]="RestHalf",t[t.RestQuarter=58597]="RestQuarter",t[t.Rest8th=58598]="Rest8th",t[t.Rest16th=58599]="Rest16th",t[t.Rest32nd=58600]="Rest32nd",t[t.Rest64th=58601]="Rest64th",t[t.Rest128th=58602]="Rest128th",t[t.Rest256th=58603]="Rest256th",t[t.RestHBarLeft=58607]="RestHBarLeft",t[t.RestHBarMiddle=58608]="RestHBarMiddle",t[t.RestHBarRight=58609]="RestHBarRight",t[t.Repeat1Bar=58624]="Repeat1Bar",t[t.Repeat2Bars=58625]="Repeat2Bars",t[t.Ottava=58640]="Ottava",t[t.OttavaAlta=58641]="OttavaAlta",t[t.OttavaBassaVb=58652]="OttavaBassaVb",t[t.Quindicesima=58644]="Quindicesima",t[t.QuindicesimaAlta=58645]="QuindicesimaAlta",t[t.DynamicPPPPPP=58663]="DynamicPPPPPP",t[t.DynamicPPPPP=58664]="DynamicPPPPP",t[t.DynamicPPPP=58665]="DynamicPPPP",t[t.DynamicPPP=58666]="DynamicPPP",t[t.DynamicPP=58667]="DynamicPP",t[t.DynamicPiano=58656]="DynamicPiano",t[t.DynamicMP=58668]="DynamicMP",t[t.DynamicMF=58669]="DynamicMF",t[t.DynamicPF=58670]="DynamicPF",t[t.DynamicForte=58658]="DynamicForte",t[t.DynamicFF=58671]="DynamicFF",t[t.DynamicFFF=58672]="DynamicFFF",t[t.DynamicFFFF=58673]="DynamicFFFF",t[t.DynamicFFFFF=58674]="DynamicFFFFF",t[t.DynamicFFFFFF=58675]="DynamicFFFFFF",t[t.DynamicFortePiano=58676]="DynamicFortePiano",t[t.DynamicNiente=58662]="DynamicNiente",t[t.DynamicSforzando1=58678]="DynamicSforzando1",t[t.DynamicSforzandoPiano=58679]="DynamicSforzandoPiano",t[t.DynamicSforzandoPianissimo=58680]="DynamicSforzandoPianissimo",t[t.DynamicSforzato=58681]="DynamicSforzato",t[t.DynamicSforzatoPiano=58682]="DynamicSforzatoPiano",t[t.DynamicSforzatoFF=58683]="DynamicSforzatoFF",t[t.DynamicRinforzando1=58684]="DynamicRinforzando1",t[t.DynamicRinforzando2=58685]="DynamicRinforzando2",t[t.DynamicForzando=58677]="DynamicForzando",t[t.DynamicCrescendoHairpin=58686]="DynamicCrescendoHairpin",t[t.GraceNoteSlashStemUp=58724]="GraceNoteSlashStemUp",t[t.GraceNoteSlashStemDown=58725]="GraceNoteSlashStemDown",t[t.OrnamentTrill=58726]="OrnamentTrill",t[t.OrnamentTurn=58727]="OrnamentTurn",t[t.OrnamentTurnInverted=58728]="OrnamentTurnInverted",t[t.OrnamentShortTrill=58732]="OrnamentShortTrill",t[t.OrnamentMordent=58733]="OrnamentMordent",t[t.StringsDownBow=58896]="StringsDownBow",t[t.StringsUpBow=58898]="StringsUpBow",t[t.KeyboardPedalPed=58960]="KeyboardPedalPed",t[t.KeyboardPedalUp=58965]="KeyboardPedalUp",t[t.PictEdgeOfCymbal=59177]="PictEdgeOfCymbal",t[t.GuitarString0=59443]="GuitarString0",t[t.GuitarString1=59444]="GuitarString1",t[t.GuitarString2=59445]="GuitarString2",t[t.GuitarString3=59446]="GuitarString3",t[t.GuitarString4=59447]="GuitarString4",t[t.GuitarString5=59448]="GuitarString5",t[t.GuitarString6=59449]="GuitarString6",t[t.GuitarString7=59450]="GuitarString7",t[t.GuitarString8=59451]="GuitarString8",t[t.GuitarString9=59452]="GuitarString9",t[t.GuitarOpenPedal=59453]="GuitarOpenPedal",t[t.GuitarClosePedal=59455]="GuitarClosePedal",t[t.GuitarGolpe=59458]="GuitarGolpe",t[t.GuitarFadeIn=59459]="GuitarFadeIn",t[t.GuitarFadeOut=59460]="GuitarFadeOut",t[t.GuitarVolumeSwell=59461]="GuitarVolumeSwell",t[t.FretboardFilledCircle=59480]="FretboardFilledCircle",t[t.FretboardX=59481]="FretboardX",t[t.FretboardO=59482]="FretboardO",t[t.Tuplet0=59520]="Tuplet0",t[t.Tuplet1=59521]="Tuplet1",t[t.Tuplet2=59522]="Tuplet2",t[t.Tuplet3=59523]="Tuplet3",t[t.Tuplet4=59524]="Tuplet4",t[t.Tuplet5=59525]="Tuplet5",t[t.Tuplet6=59526]="Tuplet6",t[t.Tuplet7=59527]="Tuplet7",t[t.Tuplet8=59528]="Tuplet8",t[t.Tuplet9=59529]="Tuplet9",t[t.TupletColon=59530]="TupletColon",t[t.WiggleTrill=60068]="WiggleTrill",t[t.GuitarVibratoStroke=60082]="GuitarVibratoStroke",t[t.GuitarWideVibratoStroke=60083]="GuitarWideVibratoStroke",t[t.WiggleVibratoMediumFast=60126]="WiggleVibratoMediumFast",t[t.WiggleSawtoothNarrow=60090]="WiggleSawtoothNarrow",t[t.WiggleSawtooth=60091]="WiggleSawtooth",t[t.OctaveBaselineM=60565]="OctaveBaselineM",t[t.OctaveBaselineB=60563]="OctaveBaselineB",t[t.GuitarLeftHandTapping=59456]="GuitarLeftHandTapping",t[t.Fingering0=60688]="Fingering0",t[t.Fingering1=60689]="Fingering1",t[t.Fingering2=60690]="Fingering2",t[t.Fingering3=60691]="Fingering3",t[t.Fingering4=60692]="Fingering4",t[t.Fingering5=60693]="Fingering5",t[t.FingeringPLower=60695]="FingeringPLower",t[t.FingeringTLower=60696]="FingeringTLower",t[t.FingeringILower=60697]="FingeringILower",t[t.FingeringMLower=60698]="FingeringMLower",t[t.FingeringALower=60699]="FingeringALower",t[t.FingeringCLower=60700]="FingeringCLower"}(ut||(ut={}));class jt{static ot=[];static ct=new Set;static lt(){const t=jt.ot;if(0===t.length)for(const e of Object.values(ut).filter(t=>"number"==typeof t)){const s=e;t.push(s);ut[s].toLowerCase().endsWith("black")&&jt.ct.add(s)}}static getAllMusicFontSymbols(){return jt.lt(),jt.ot}static isBlackNoteHead(t){return jt.lt(),jt.ct.has(t)}}!function(t){t[t.Above=0]="Above",t[t.Inside=1]="Inside",t[t.Below=2]="Below",t[t.Outside=3]="Outside"}(dt||(dt={}));class Jt{id=0;get uniqueId(){return`${this.elementType}.${this.id}`}elementType;staffLine;noteHeadDefault;noteHeadHalf;noteHeadWhole;techniqueSymbol;techniqueSymbolPlacement;outputMidiNumber;constructor(t="",e=0,s=0,i=ut.None,n=ut.None,r=ut.None,a=ut.None,h=dt.Inside,o=0){this.id=o,this.elementType=t,this.outputMidiNumber=s,this.staffLine=e,this.noteHeadDefault=i,this.noteHeadHalf=n!==ut.None?n:i,this.noteHeadWhole=r!==ut.None?r:i,this.techniqueSymbol=a,this.techniqueSymbolPlacement=h}static create(t=0,e="",s=0,i=0,n=ut.None,r=ut.None,a=ut.None,h=ut.None,o=dt.Inside){return new Jt(e,s,i,n,r,a,h,o,t)}getSymbol(t){switch(t){case l.Whole:return this.noteHeadWhole;case l.Half:return this.noteHeadHalf;default:return this.noteHeadDefault}}}class qt{static instrumentArticulations=new Map([Jt.create(38,"Snare",3,38,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(37,"Snare",3,37,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(91,"Snare",3,38,ut.NoteheadDiamondWhite,ut.NoteheadDiamondWhite,ut.NoteheadDiamondWhite),Jt.create(42,"Charley",-1,42,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(92,"Charley",-1,46,ut.NoteheadCircleSlash,ut.NoteheadCircleSlash,ut.NoteheadCircleSlash),Jt.create(46,"Charley",-1,46,ut.NoteheadCircleX,ut.NoteheadCircleX,ut.NoteheadCircleX),Jt.create(44,"Charley",9,44,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(35,"Acoustic Kick Drum",8,35,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(36,"Kick Drum",7,36,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(50,"Tom Very High",1,50,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(48,"Tom High",2,48,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(47,"Tom Medium",4,47,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(45,"Tom Low",5,45,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(43,"Tom Very Low",6,43,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(93,"Ride",0,51,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.PictEdgeOfCymbal,dt.Above),Jt.create(51,"Ride",0,51,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(53,"Ride",0,53,ut.NoteheadDiamondWhite,ut.NoteheadDiamondWhite,ut.NoteheadDiamondWhite),Jt.create(94,"Ride",0,51,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.ArticStaccatoAbove,dt.Outside),Jt.create(55,"Splash",-2,55,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(95,"Splash",-2,55,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.ArticStaccatoAbove,dt.Outside),Jt.create(52,"China",-3,52,ut.NoteheadHeavyXHat,ut.NoteheadHeavyXHat,ut.NoteheadHeavyXHat),Jt.create(96,"China",-3,52,ut.NoteheadHeavyXHat,ut.NoteheadHeavyXHat,ut.NoteheadHeavyXHat),Jt.create(49,"Crash High",-2,49,ut.NoteheadHeavyX,ut.NoteheadHeavyX,ut.NoteheadHeavyX),Jt.create(97,"Crash High",-2,49,ut.NoteheadHeavyX,ut.NoteheadHeavyX,ut.NoteheadHeavyX,ut.ArticStaccatoAbove,dt.Outside),Jt.create(57,"Crash Medium",-1,57,ut.NoteheadHeavyX,ut.NoteheadHeavyX,ut.NoteheadHeavyX),Jt.create(98,"Crash Medium",-1,57,ut.NoteheadHeavyX,ut.NoteheadHeavyX,ut.NoteheadHeavyX,ut.ArticStaccatoAbove,dt.Outside),Jt.create(99,"Cowbell Low",1,56,ut.NoteheadTriangleUpBlack,ut.NoteheadTriangleUpHalf,ut.NoteheadTriangleUpWhole),Jt.create(100,"Cowbell Low",1,56,ut.NoteheadXBlack,ut.NoteheadXHalf,ut.NoteheadXWhole),Jt.create(56,"Cowbell Medium",0,56,ut.NoteheadTriangleUpBlack,ut.NoteheadTriangleUpHalf,ut.NoteheadTriangleUpWhole),Jt.create(101,"Cowbell Medium",0,56,ut.NoteheadXBlack,ut.NoteheadXHalf,ut.NoteheadXWhole),Jt.create(102,"Cowbell High",-1,56,ut.NoteheadTriangleUpBlack,ut.NoteheadTriangleUpHalf,ut.NoteheadTriangleUpWhole),Jt.create(103,"Cowbell High",-1,56,ut.NoteheadXBlack,ut.NoteheadXHalf,ut.NoteheadXWhole),Jt.create(77,"Woodblock Low",-9,77,ut.NoteheadTriangleUpBlack,ut.NoteheadTriangleUpBlack,ut.NoteheadTriangleUpBlack),Jt.create(76,"Woodblock High",-10,76,ut.NoteheadTriangleUpBlack,ut.NoteheadTriangleUpBlack,ut.NoteheadTriangleUpBlack),Jt.create(60,"Bongo High",-4,60,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(104,"Bongo High",-5,60,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole,ut.NoteheadParenthesis,dt.Inside),Jt.create(105,"Bongo High",-6,60,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(61,"Bongo Low",-7,61,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(106,"Bongo Low",-8,61,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole,ut.NoteheadParenthesis,dt.Inside),Jt.create(107,"Bongo Low",-16,61,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(66,"Timbale Low",10,66,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(65,"Timbale High",9,65,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(68,"Agogo Low",12,68,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(67,"Agogo High",11,67,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(64,"Conga Low",17,64,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(108,"Conga Low",16,64,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(109,"Conga Low",15,64,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole,ut.NoteheadParenthesis,dt.Inside),Jt.create(63,"Conga High",14,63,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(110,"Conga High",13,63,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(62,"Conga High",19,62,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole,ut.NoteheadParenthesis,dt.Inside),Jt.create(72,"Whistle Low",-11,72,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(71,"Whistle High",-17,71,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(73,"Guiro",38,73,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(74,"Guiro",37,74,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(86,"Surdo",36,86,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(87,"Surdo",35,87,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadParenthesis,dt.Inside),Jt.create(54,"Tambourine",3,54,ut.NoteheadTriangleUpBlack,ut.NoteheadTriangleUpBlack,ut.NoteheadTriangleUpBlack),Jt.create(111,"Tambourine",2,54,ut.NoteheadTriangleUpBlack,ut.NoteheadTriangleUpBlack,ut.NoteheadTriangleUpBlack,ut.StringsUpBow,dt.Above),Jt.create(112,"Tambourine",1,54,ut.NoteheadTriangleUpBlack,ut.NoteheadTriangleUpBlack,ut.NoteheadTriangleUpBlack,ut.StringsDownBow,dt.Above),Jt.create(113,"Tambourine",-7,54,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(79,"Cuica",30,79,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(78,"Cuica",29,78,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(58,"Vibraslap",28,58,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(81,"Triangle",27,81,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(80,"Triangle",26,80,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadParenthesis,dt.Inside),Jt.create(114,"Grancassa",25,43,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(115,"Piatti",18,49,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(116,"Piatti",24,49,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(69,"Cabasa",23,69,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(117,"Cabasa",22,69,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole,ut.StringsUpBow,dt.Outside),Jt.create(85,"Castanets",21,85,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(75,"Claves",20,75,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(70,"Left Maraca",-12,70,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(118,"Left Maraca",-13,70,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole,ut.StringsUpBow,dt.Outside),Jt.create(119,"Right Maraca",-14,70,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(120,"Right Maraca",-15,70,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole,ut.StringsUpBow,dt.Outside),Jt.create(82,"Shaker",-23,82,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(122,"Shaker",-24,82,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole,ut.StringsUpBow,dt.Outside),Jt.create(84,"Bell Tree",-18,53,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(123,"Bell Tree",-19,53,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole,ut.StringsUpBow,dt.Outside),Jt.create(83,"Jingle Bell",-20,53,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(83,"Tinkle Bell",-20,53,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(124,"Golpe",-21,62,ut.NoteheadNull,ut.NoteheadNull,ut.NoteheadNull,ut.GuitarGolpe,dt.Below),Jt.create(125,"Golpe",-22,62,ut.NoteheadNull,ut.NoteheadNull,ut.NoteheadNull,ut.GuitarGolpe,dt.Above),Jt.create(39,"Hand Clap",3,39,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(40,"Electric Snare",3,40,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(31,"Sticks",3,40,ut.NoteheadSlashedBlack2,ut.NoteheadSlashedBlack2,ut.NoteheadSlashedBlack2),Jt.create(41,"Very Low Floor Tom",5,41,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole),Jt.create(59,"Ride Cymbal 2",2,59,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.PictEdgeOfCymbal,dt.Above),Jt.create(126,"Ride Cymbal 2",2,59,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(127,"Ride Cymbal 2",2,59,ut.NoteheadDiamondWhite,ut.NoteheadDiamondWhite,ut.NoteheadDiamondWhite),Jt.create(29,"Ride Cymbal 2",2,59,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.ArticStaccatoAbove,dt.Outside),Jt.create(30,"Reverse Cymbal",-3,49,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(33,"Metronome",3,37,ut.NoteheadXBlack,ut.NoteheadXBlack,ut.NoteheadXBlack),Jt.create(34,"Metronome",3,38,ut.NoteheadBlack,ut.NoteheadBlack,ut.NoteheadBlack)].map(t=>[t.uniqueId,t]));static ut=new Map([["Snare (hit)","Snare.38"],["Snare (side stick)","Snare.37"],["Snare (rim shot)","Snare.91"],["Hi-Hat (closed)","Charley.42"],["Hi-Hat (half)","Charley.92"],["Hi-Hat (open)","Charley.46"],["Pedal Hi-Hat (hit)","Charley.44"],["Kick (hit)","Acoustic Kick Drum.35"],["Kick (hit) 2","Kick Drum.36"],["High Floor Tom (hit)","Tom Very High.50"],["High Tom (hit)","Tom High.48"],["Mid Tom (hit)","Tom Medium.47"],["Low Tom (hit)","Tom Low.45"],["Very Low Tom (hit)","Tom Very Low.43"],["Ride (edge)","Ride.93"],["Ride (middle)","Ride.51"],["Ride (bell)","Ride.53"],["Ride (choke)","Ride.94"],["Splash (hit)","Splash.55"],["Splash (choke)","Splash.95"],["China (hit)","China.52"],["China (choke)","China.96"],["Crash high (hit)","Crash High.49"],["Crash high (choke)","Crash High.97"],["Crash medium (hit)","Crash Medium.57"],["Crash medium (choke)","Crash Medium.98"],["Cowbell low (hit)","Cowbell Low.99"],["Cowbell low (tip)","Cowbell Low.100"],["Cowbell medium (hit)","Cowbell Medium.56"],["Cowbell medium (tip)","Cowbell Medium.101"],["Cowbell high (hit)","Cowbell High.102"],["Cowbell high (tip)","Cowbell High.103"],["Woodblock low (hit)","Woodblock Low.77"],["Woodblock high (hit)","Woodblock High.76"],["Bongo High (hit)","Bongo High.60"],["Bongo High (mute)","Bongo High.104"],["Bongo High (slap)","Bongo High.105"],["Bongo Low (hit)","Bongo Low.61"],["Bongo Low (mute)","Bongo Low.106"],["Bongo Low (slap)","Bongo Low.107"],["Timbale low (hit)","Timbale Low.66"],["Timbale high (hit)","Timbale High.65"],["Agogo low (hit)","Agogo Low.68"],["Agogo high (hit)","Agogo High.67"],["Conga low (hit)","Conga Low.64"],["Conga low (slap)","Conga Low.108"],["Conga low (mute)","Conga Low.109"],["Conga high (hit)","Conga High.63"],["Conga high (slap)","Conga High.110"],["Conga high (mute)","Conga High.62"],["Whistle low (hit)","Whistle Low.72"],["Whistle high (hit)","Whistle High.71"],["Guiro (hit)","Guiro.73"],["Guiro (scrap-return)","Guiro.74"],["Surdo (hit)","Surdo.86"],["Surdo (mute)","Surdo.87"],["Tambourine (hit)","Tambourine.54"],["Tambourine (return)","Tambourine.111"],["Tambourine (roll)","Tambourine.112"],["Tambourine (hand)","Tambourine.113"],["Cuica (open)","Cuica.79"],["Cuica (mute)","Cuica.78"],["Vibraslap (hit)","Vibraslap.58"],["Triangle (hit)","Triangle.81"],["Triangle (mute)","Triangle.80"],["Grancassa (hit)","Grancassa.114"],["Piatti (hit)","Piatti.115"],["Piatti (hand)","Piatti.116"],["Cabasa (hit)","Cabasa.69"],["Cabasa (return)","Cabasa.117"],["Castanets (hit)","Castanets.85"],["Claves (hit)","Claves.75"],["Left Maraca (hit)","Left Maraca.70"],["Left Maraca (return)","Left Maraca.118"],["Right Maraca (hit)","Right Maraca.119"],["Right Maraca (return)","Right Maraca.120"],["Shaker (hit)","Shaker.82"],["Shaker (return)","Shaker.122"],["Bell Tree (hit)","Bell Tree.84"],["Bell Tree (return)","Bell Tree.123"],["Jingle Bell (hit)","Jingle Bell.83"],["Tinkle Bell (hit)","Tinkle Bell.83"],["Golpe (thumb)","Golpe.124"],["Golpe (finger)","Golpe.125"],["Hand Clap (hit)","Hand Clap.39"],["Electric Snare (hit)","Electric Snare.40"],["Snare (side stick) 2","Sticks.31"],["Low Floor Tom (hit)","Very Low Floor Tom.41"],["Ride (edge) 2","Ride Cymbal 2.59"],["Ride (middle) 2","Ride Cymbal 2.126"],["Ride (bell) 2","Ride Cymbal 2.127"],["Ride (choke) 2","Ride Cymbal 2.29"],["Reverse Cymbal (hit)","Reverse Cymbal.30"],["Metronome (hit)","Metronome.33"],["Metronome (bell)","Metronome.34"]]);static dt=[[35,35,35],[38,91,37],[99,100,99],[56,100,56],[102,103,102],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[50,50,50],[42,92,46],[44,44,44],[57,98,57],[49,97,49],[55,95,55],[51,93,127],[52,96,52]];static articulationFromElementVariation(t,e){return t<qt.dt.length?(e>=qt.dt.length&&(e=0),qt.dt[t][e]):38}static getArticulationName(t){const e=qt.getArticulation(t);if(e){const t=e.uniqueId;for(const[e,s]of qt.instrumentArticulationNames)if(s===t)return e}else{const e=`.${t.percussionArticulation}`;for(const[t,s]of qt.instrumentArticulationNames)if(s.endsWith(e))return t}return"unknown"}static getArticulation(t){const e=t.percussionArticulation;if(e<0)return null;const s=t.beat.voice.bar.staff.track.percussionArticulations;return e<s.length?s[e]:qt.getArticulationById(e)}static ft;static bt(){let t=qt.ft;if(!t){t=new Map;for(const e of qt.instrumentArticulations.values())t.set(e.id,e);qt.ft=t}return t}static instrumentArticulationIds(){return qt.bt().keys()}static getArticulationById(t){const e=qt.bt();return e.has(t)?e.get(t):null}static getElementAndVariation(t){const e=qt.getArticulation(t);if(!e)return[-1,-1];for(let t=0;t<qt.dt.length;t++){const s=qt.dt[t];for(let i=0;i<s.length;i++){const n=qt.getArticulationById(s[i]);if(n?.outputMidiNumber===e.outputMidiNumber)return[t,i]}}return[-1,-1]}static instrumentArticulationNames=qt.gt([new Map([["Hand (hit)","Bongo Low.61"],["Tinkle Bell (hat)","Tingle Bell.83"],["Cymbal (hit)","Reverse Cymbal.30"],["Snare (side stick) 3","Snare.37"],["Snare (hit) 2","Snare.38"],["Snare (hit) 3","Snare.40"],["Agogo tow (hit)","Agogo Low.68"],["Triangle (rnute)","Triangle.80"],["Hand (mute)","Bongo High.104"],["Hand (slap)","Bongo High.105"],["Hand (mute) 2","Bongo Low.106"],["Hand (slap) 2","Bongo Low.107"],["Piatti (hat)","Piatti.115"],["Bell Tee (return)","Bell Tree.123"]]),qt.ut]);static gt(t){const e=new Map(t[0]);for(let s=1;s<t.length;s++)for(const[i,n]of t[s])e.set(i,n);return e}static wt;static tryMatchKnownArticulation(t){let e=qt.wt;if(!e){e=new Map;for(const t of qt.instrumentArticulations.values())e.has(t.outputMidiNumber)||e.set(t.outputMidiNumber,t);qt.wt=e}return e.has(t.outputMidiNumber)?e.get(t.outputMidiNumber).id:-1}static yt;static getInstrumentArticulationByUniqueId(t){let e=qt.yt;if(!e){e=new Map;for(const t of qt.instrumentArticulations.values())e.set(t.uniqueId,t);qt.yt=e}return e.has(t)?e.get(t):void 0}}!function(t){t[t.None=0]="None",t[t.InvertedTurn=1]="InvertedTurn",t[t.Turn=2]="Turn",t[t.UpperMordent=3]="UpperMordent",t[t.LowerMordent=4]="LowerMordent"}(ft||(ft={}));class Yt{tieDestinationNoteId=-1;tieOriginNoteId=-1;slurDestinationNoteId=-1;slurOriginNoteId=-1;hammerPullDestinationNoteId=-1;hammerPullOriginNoteId=-1;slideTargetNoteId=-1;slideOriginNoteId=-1}!function(t){t[t.Effects=0]="Effects",t[t.StandardNotationNoteHead=1]="StandardNotationNoteHead",t[t.StandardNotationAccidentals=2]="StandardNotationAccidentals",t[t.StandardNotationEffects=3]="StandardNotationEffects",t[t.GuitarTabFretNumber=4]="GuitarTabFretNumber",t[t.GuitarTabEffects=5]="GuitarTabEffects",t[t.SlashNoteHead=6]="SlashNoteHead",t[t.SlashEffects=7]="SlashEffects",t[t.NumberedNumber=8]="NumberedNumber",t[t.NumberedAccidentals=9]="NumberedAccidentals",t[t.NumberedEffects=10]="NumberedEffects"}(pt||(pt={}));class Kt extends Y{noteHead;noteHeadCenterOnStem}class Qt{static globalNoteId=0;static resetIds(){Qt.globalNoteId=0}id=Qt.globalNoteId++;index=0;accentuated=d.None;bendType=h.None;bendStyle=a.Default;bendOrigin=null;isContinuedBend=!1;bendPoints=null;maxBendPoint=null;get hasBend(){return null!==this.bendPoints&&this.bendType!==h.None}get isStringed(){return this.string>=0}fret=-1;string=-1;showStringNumber=!1;get isPiano(){return!this.isStringed&&this.octave>=0&&this.tone>=0}octave=-1;tone=-1;get isPercussion(){return!this.isStringed&&this.percussionArticulation>=0}get element(){return this.isPercussion?qt.getElementAndVariation(this)[0]:-1}get variation(){return this.isPercussion?qt.getElementAndVariation(this)[1]:-1}percussionArticulation=-1;isVisible=!0;isLeftHandTapped=!1;isHammerPullOrigin=!1;get isHammerPullDestination(){return!!this.hammerPullOrigin}hammerPullOrigin=null;hammerPullDestination=null;get isSlurOrigin(){return!!this.slurDestination}isSlurDestination=!1;slurOrigin=null;slurDestination=null;get isHarmonic(){return this.harmonicType!==p.None}harmonicType=p.None;harmonicValue=0;isGhost=!1;isLetRing=!1;letRingDestination=null;isPalmMute=!1;palmMuteDestination=null;isDead=!1;isStaccato=!1;slideInType=g.None;slideOutType=w.None;slideTarget=null;slideOrigin=null;vibrato=y.None;tieOrigin=null;tieDestination=null;isTieDestination=!1;get isTieOrigin(){return null!==this.tieDestination}leftHandFinger=f.Unknown;rightHandFinger=f.Unknown;get isFingering(){return this.leftHandFinger!==f.Unknown||this.rightHandFinger!==f.Unknown}trillValue=-1;get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return this.trillValue>=0}trillSpeed=l.ThirtySecond;durationPercent=1;accidentalMode=b.Default;beat;dynamics=n.F;isEffectSlurOrigin=!1;hasEffectSlur=!1;get isEffectSlurDestination(){return!!this.effectSlurOrigin}effectSlurOrigin=null;effectSlurDestination=null;ornament=ft.None;style;get stringTuning(){return this.beat.voice.bar.staff.capo+Qt.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(t,e){return t.tuning.length>0?t.tuning[t.tuning.length-(e-1)-1]:0}get realValue(){return this.calculateRealValue(!0,!0)}get realValueWithoutHarmonic(){return this.calculateRealValue(!0,!1)}calculateRealValue(t,e){const s=t?this.beat.voice.bar.staff.transpositionPitch:0;if(e){let e=this.calculateRealValue(t,!1);return this.isStringed&&(this.harmonicType===p.Natural?e=this.harmonicPitch+this.stringTuning-s:e+=this.harmonicPitch),e}return this.isPercussion?this.percussionArticulation:this.isStringed?this.fret+this.stringTuning-s:this.isPiano?12*this.octave+this.tone-s:0}get harmonicPitch(){if(this.harmonicType===p.None||!this.isStringed)return 0;const t=this.harmonicValue;return Xt.isAlmostEqualTo(t,2.4)?36:Xt.isAlmostEqualTo(t,2.7)?34:t<3?0:t<=3.5?31:t<=4?28:t<=5?24:t<=6?34:t<=7?19:t<=8.5?36:t<=9?28:t<=10?34:t<=11?0:t<=12?12:t<14?0:t<=15?34:t<=16?28:t<=17?36:t<=18?0:t<=19?19:t<=21?0:t<=22?36:t<=24?24:0}get initialBendValue(){return this.hasBend?Math.floor(this.bendPoints[0].value/2):this.bendOrigin?Math.floor(this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2):this.isTieDestination&&this.tieOrigin.bendOrigin?Math.floor(this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2):this.beat.hasWhammyBar?Math.floor(this.beat.whammyBarPoints[0].value/2):this.beat.isContinuedWhammy?Math.floor(this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2):0}get displayValue(){return this.displayValueWithoutBend+this.initialBendValue}get displayValueWithoutBend(){let t=this.realValue;switch(this.harmonicType!==p.Natural&&this.harmonicType!==p.None&&(t-=this.harmonicPitch),this.beat.ottava){case m.S:t-=24;break;case m._:t-=12;break;case m.Regular:break;case m.T:t+=12;break;case m.M:t+=24}switch(this.beat.voice.bar.clefOttava){case m.S:t-=24;break;case m._:t-=12;break;case m.Regular:break;case m.T:t+=12;break;case m.M:t+=24}return t-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!=0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!=0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!=0:!!this.beat.isContinuedWhammy&&this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!=0}addBendPoint(t){let e=this.bendPoints;null===e&&(e=[],this.bendPoints=e),e.push(t),(!this.maxBendPoint||t.value>this.maxBendPoint.value)&&(this.maxBendPoint=t),this.bendType===h.None&&(this.bendType=h.Custom)}finish(e,s=null){const i=new j(()=>Qt.nextNoteOnSameLine(this)),n=e&&e.notation.notationMode===t.NotationMode.SongBook;if(this.isTieDestination&&(this.chain(s),n&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0)),this.isLetRing&&(i.value&&i.value.isLetRing?this.letRingDestination=i.value:this.letRingDestination=this,n&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1)),this.isPalmMute&&(i.value&&i.value.isPalmMute?this.palmMuteDestination=i.value:this.palmMuteDestination=this),this.isHammerPullOrigin){const t=Qt.findHammerPullDestination(this);t?(this.hammerPullDestination=t,t.hammerPullOrigin=this):this.isHammerPullOrigin=!1}switch(this.slideOutType){case w.Shift:case w.Legato:this.slideTarget||(this.slideTarget=i.value),this.slideTarget?this.slideTarget.slideOrigin=this:this.slideOutType=w.None}let r=null;this.isHammerPullOrigin&&this.hammerPullDestination?r=this.hammerPullDestination:this.slideOutType===w.Legato&&this.slideTarget&&(r=this.slideTarget),r&&(this.hasEffectSlur=!0,this.effectSlurOrigin&&this.beat.pickStroke===lt.None?(this.effectSlurOrigin.effectSlurDestination=r,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=r,this.effectSlurDestination.effectSlurOrigin=this));const a=this.bendPoints,o=null!=a&&a.length>0;if(o){const t=this.isTieDestination&&this.tieOrigin.hasBend;this.isContinuedBend=t}else this.bendType=h.None;if(o&&this.bendType===h.Custom)if(4===a.length){const t=a[0],e=a[1],s=a[2],i=a[3];e.value===s.value?i.value>t.value?e.value>i.value?this.bendType=h.BendRelease:!this.isContinuedBend&&t.value>0?(this.bendType=h.PrebendBend,a.splice(2,1),a.splice(1,1)):(this.bendType=h.Bend,a.splice(2,1),a.splice(1,1)):i.value<t.value?this.isContinuedBend?(this.bendType=h.Release,a.splice(2,1),a.splice(1,1)):(this.bendType=h.PrebendRelease,a.splice(2,1),a.splice(1,1)):e.value>t.value?this.bendType=h.BendRelease:t.value>0&&!this.isContinuedBend?(this.bendType=h.Prebend,a.splice(2,1),a.splice(1,1)):(this.bendType=h.Hold,a.splice(2,1),a.splice(1,1)):q.warning("Model","Unsupported bend type detected, fallback to custom",null)}else if(3===a.length){const t=a[0],e=a[1],s=a[2];s.value>t.value?e.value>s.value?(this.bendType=h.BendRelease,a.splice(1,0,new z(e.offset,e.value))):!this.isContinuedBend&&t.value>0?(this.bendType=h.PrebendBend,a.splice(1,1)):(this.bendType=h.Bend,a.splice(1,1)):s.value<t.value?this.isContinuedBend?(this.bendType=h.Release,a.splice(1,1)):(this.bendType=h.PrebendRelease,a.splice(1,1)):e.value>t.value?(this.bendType=h.BendRelease,a.splice(1,0,new z(e.offset,e.value))):t.value>0&&!this.isContinuedBend?(this.bendType=h.Prebend,a.splice(1,1)):(this.bendType=h.Hold,a.splice(1,1))}else if(2===a.length){const t=a[0],e=a[1];e.value>t.value?!this.isContinuedBend&&t.value>0?this.bendType=h.PrebendBend:this.bendType=h.Bend:e.value<t.value?this.isContinuedBend?this.bendType=h.Release:this.bendType=h.PrebendRelease:t.value>0&&!this.isContinuedBend?this.bendType=h.Prebend:this.bendType=h.Hold}this.initialBendValue>0&&(this.accidentalMode=b.Default)}static kt=3;static nextNoteOnSameLine(t){let e=t.beat.nextBeat;for(;e&&e.voice.bar.index<=t.beat.voice.bar.index+Qt.kt;){const s=e.getNoteOnString(t.string);if(s)return s;e=e.nextBeat}return null}static findHammerPullDestination(t){let e=t.beat.nextBeat;for(;e&&e.voice.bar.index<=t.beat.voice.bar.index+Qt.kt;){let s=e.getNoteOnString(t.string);if(s)return s;for(let i=t.string;i>0;i--)if(s=e.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}for(let i=t.string;i<=t.beat.voice.bar.staff.tuning.length;i++)if(s=e.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}e=e.nextBeat}return null}static findTieOrigin(t){let e=t.beat.previousBeat;for(;e&&e.voice.bar.index>=t.beat.voice.bar.index-Qt.kt;){if(t.isStringed){const s=e.getNoteOnString(t.string);if(s)return s}else if(-1===t.octave&&-1===t.tone){if(t.index<e.notes.length)return e.notes[t.index]}else{const s=e.getNoteWithRealValue(t.realValue);if(s)return s}e=e.previousBeat}return null}static St="NoteIdLookup";Bt=null;chain(t=null){if(null!==t)if(null!==this.Bt){let e;t.has(Qt.St)?e=t.get(Qt.St):(e=new Map,t.set(Qt.St,e)),-1===this.Bt.hammerPullDestinationNoteId&&-1===this.Bt.tieDestinationNoteId&&-1===this.Bt.slurDestinationNoteId&&-1===this.Bt.slideTargetNoteId||e.set(this.id,this),-1!==this.Bt.hammerPullOriginNoteId&&(this.hammerPullOrigin=e.get(this.Bt.hammerPullOriginNoteId),this.hammerPullOrigin.hammerPullDestination=this),-1!==this.Bt.tieOriginNoteId&&(this.tieOrigin=e.get(this.Bt.tieOriginNoteId),this.tieOrigin.tieDestination=this),-1!==this.Bt.slurOriginNoteId&&(this.slurOrigin=e.get(this.Bt.slurOriginNoteId),this.slurOrigin.slurDestination=this),-1!==this.Bt.slideOriginNoteId&&(this.slideOrigin=e.get(this.Bt.slideOriginNoteId),this.slideOrigin.slideTarget=this),this.Bt=null}else{if(!this.isTieDestination&&null===this.tieOrigin)return;const t=this.tieOrigin??Qt.findTieOrigin(this);t?(t.tieDestination=this,this.tieOrigin=t,this.fret=t.fret,this.octave=t.octave,this.tone=t.tone,t.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1}}toJson(t){null!==this.tieDestination&&t.set("tiedestinationnoteid",this.tieDestination.id),null!==this.tieOrigin&&t.set("tieoriginnoteid",this.tieOrigin.id),null!==this.slurDestination&&t.set("slurdestinationnoteid",this.slurDestination.id),null!==this.slurOrigin&&t.set("sluroriginnoteid",this.slurOrigin.id),null!==this.hammerPullOrigin&&t.set("hammerpulloriginnoteid",this.hammerPullOrigin.id),null!==this.hammerPullDestination&&t.set("hammerpulldestinationnoteid",this.hammerPullDestination.id),null!==this.slideTarget&&t.set("slidetargetnoteid",this.slideTarget.id),null!==this.slideOrigin&&t.set("slideoriginnoteid",this.slideOrigin.id)}setProperty(t,e){switch(t){case"tiedestinationnoteid":return null==this.Bt&&(this.Bt=new Yt),this.Bt.tieDestinationNoteId=e,!0;case"tieoriginnoteid":return null==this.Bt&&(this.Bt=new Yt),this.Bt.tieOriginNoteId=e,!0;case"slurdestinationnoteid":return null==this.Bt&&(this.Bt=new Yt),this.Bt.slurDestinationNoteId=e,!0;case"sluroriginnoteid":return null==this.Bt&&(this.Bt=new Yt),this.Bt.slurOriginNoteId=e,!0;case"hammerpulloriginnoteid":return null==this.Bt&&(this.Bt=new Yt),this.Bt.hammerPullOriginNoteId=e,!0;case"hammerpulldestinationnoteid":return null==this.Bt&&(this.Bt=new Yt),this.Bt.hammerPullDestinationNoteId=e,!0;case"slidetargetnoteid":return null==this.Bt&&(this.Bt=new Yt),this.Bt.slideTargetNoteId=e,!0;case"slideoriginnoteid":return null==this.Bt&&(this.Bt=new Yt),this.Bt.slideOriginNoteId=e,!0}return!1}}class Zt{static _t=1920;static Tt=960;static xt=480;static Mt=240;static vt=120;static Nt=60;static Pt=30;static Ct=15;static Et=[Zt._t,Zt.Tt,Zt.xt,Zt.Mt,Zt.vt,Zt.Nt,Zt.Pt,Zt.Ct];Ft=!0;totalDuration=0;beats=[];voice;isFull=!1;constructor(t){this.voice=t}check(t){if(0===this.beats.length)return this.beats.push(t),this.totalDuration+=t.playbackDuration,!0;if(t.graceType!==u.None)return!0;if(t.voice!==this.voice||this.isFull||t.tupletNumerator!==this.beats[0].tupletNumerator||t.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(t.displayDuration!==this.beats[0].displayDuration&&(this.Ft=!1),this.beats.push(t),this.totalDuration+=t.displayDuration,this.Ft)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{const t=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(const e of Zt.Et)if(this.totalDuration===e*t){this.isFull=!0;break}}return!0}}!function(t){t[t.None=0]="None",t[t.Custom=1]="Custom",t[t.Dive=2]="Dive",t[t.Dip=3]="Dip",t[t.Hold=4]="Hold",t[t.Predive=5]="Predive",t[t.PrediveDive=6]="PrediveDive"}(bt||(bt={})),function(t){t[t.None=0]="None",t[t.Thumb=1]="Thumb",t[t.Finger=2]="Finger"}(mt||(mt={})),function(t){t[t.None=0]="None",t[t.FadeIn=1]="FadeIn",t[t.FadeOut=2]="FadeOut",t[t.VolumeSwell=3]="VolumeSwell"}(gt||(gt={})),function(t){t[t.None=0]="None",t[t.Open=1]="Open",t[t.Closed=2]="Closed"}(wt||(wt={})),function(t){t[t.None=0]="None",t[t.Full=1]="Full",t[t.Half=2]="Half"}(yt||(yt={})),function(t){t[t.None=0]="None",t[t.Ii=1]="Ii",t[t.Mi=2]="Mi",t[t.MiiTriplet=3]="MiiTriplet",t[t.MiiAnapaest=4]="MiiAnapaest",t[t.PmpTriplet=5]="PmpTriplet",t[t.PmpAnapaest=6]="PmpAnapaest",t[t.PeiTriplet=7]="PeiTriplet",t[t.PeiAnapaest=8]="PeiAnapaest",t[t.PaiTriplet=9]="PaiTriplet",t[t.PaiAnapaest=10]="PaiAnapaest",t[t.AmiTriplet=11]="AmiTriplet",t[t.AmiAnapaest=12]="AmiAnapaest",t[t.Ppp=13]="Ppp",t[t.Amii=14]="Amii",t[t.Amip=15]="Amip",t[t.Eami=16]="Eami",t[t.Eamii=17]="Eamii",t[t.Peami=18]="Peami"}(kt||(kt={})),function(t){t[t.Default=0]="Default",t[t.BuzzRoll=1]="BuzzRoll"}(St||(St={}));class te{static minMarks=0;static maxMarks=5;marks=0;style=St.Default;getDuration(t){let e=this.marks;e<1&&(e=1);const s=t*Math.pow(2,e);return s<=l.TwoHundredFiftySixth?s:l.TwoHundredFiftySixth}getDurationAsTicks(t){let e=this.marks;e<1&&(e=1);const s=t*Math.pow(2,e);return $.valueToTicks(s)}}!function(t){t[t.Auto=0]="Auto",t[t.ForceSplitToNext=1]="ForceSplitToNext",t[t.ForceMergeWithNext=2]="ForceMergeWithNext",t[t.ForceSplitOnSecondaryToNext=3]="ForceSplitOnSecondaryToNext"}(Bt||(Bt={})),function(t){t[t.Effects=0]="Effects",t[t.StandardNotationStem=1]="StandardNotationStem",t[t.StandardNotationFlags=2]="StandardNotationFlags",t[t.StandardNotationBeams=3]="StandardNotationBeams",t[t.StandardNotationTuplet=4]="StandardNotationTuplet",t[t.StandardNotationEffects=5]="StandardNotationEffects",t[t.StandardNotationRests=6]="StandardNotationRests",t[t.GuitarTabStem=7]="GuitarTabStem",t[t.GuitarTabFlags=8]="GuitarTabFlags",t[t.GuitarTabBeams=9]="GuitarTabBeams",t[t.GuitarTabTuplet=10]="GuitarTabTuplet",t[t.GuitarTabEffects=11]="GuitarTabEffects",t[t.GuitarTabRests=12]="GuitarTabRests",t[t.SlashStem=13]="SlashStem",t[t.SlashFlags=14]="SlashFlags",t[t.SlashBeams=15]="SlashBeams",t[t.SlashTuplet=16]="SlashTuplet",t[t.SlashRests=17]="SlashRests",t[t.SlashEffects=18]="SlashEffects",t[t.NumberedDuration=19]="NumberedDuration",t[t.NumberedEffects=20]="NumberedEffects",t[t.NumberedRests=21]="NumberedRests",t[t.NumberedTuplet=22]="NumberedTuplet"}(_t||(_t={}));class ee extends Y{}class se{static At=0;static resetIds(){se.At=0}id=se.At++;index=0;previousBeat=null;nextBeat=null;get isLastOfVoice(){return this.index===this.voice.beats.length-1}voice;notes=[];noteStringLookup=new Map;noteValueLookup=new Map;isEmpty=!1;whammyStyle=a.Default;ottava=m.Regular;fermata=null;isLegatoOrigin=!1;get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}minNote=null;maxNote=null;maxStringNote=null;minStringNote=null;duration=l.Quarter;get isRest(){return this.isEmpty||!this.deadSlapped&&0===this.notes.length}get isFullBarRest(){return this.isRest&&1===this.voice.beats.length&&this.duration===l.Whole}isLetRing=!1;isPalmMute=!1;automations=[];dots=0;get fadeIn(){return this.fade===gt.FadeIn}set fadeIn(t){this.fade=t?gt.FadeIn:gt.None}fade=gt.None;lyrics=null;get hasRasgueado(){return this.rasgueado!==kt.None}pop=!1;slap=!1;tap=!1;text=null;slashed=!1;deadSlapped=!1;brushType=o.None;brushDuration=0;tupletDenominator=-1;tupletNumerator=-1;get hasTuplet(){return!(-1===this.tupletDenominator&&-1===this.tupletNumerator||1===this.tupletDenominator&&1===this.tupletNumerator)}tupletGroup=null;isContinuedWhammy=!1;whammyBarType=bt.None;whammyBarPoints=null;maxWhammyPoint=null;minWhammyPoint=null;get hasWhammyBar(){return null!==this.whammyBarPoints&&this.whammyBarType!==bt.None}vibrato=y.None;chordId=null;get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.getChord(this.chordId):null}graceType=u.None;graceGroup=null;graceIndex=-1;pickStroke=lt.None;get isTremolo(){return void 0!==this.tremoloPicking}tremoloPicking;get tremoloSpeed(){const t=this.tremoloPicking;return t?t.getDuration(this.duration):null}set tremoloSpeed(t){if(null===t)return void(this.tremoloPicking=void 0);let e=this.tremoloPicking;switch(void 0===e&&(e=new te,this.tremoloPicking=e),t){case l.Eighth:e.marks=1;break;case l.Sixteenth:e.marks=2;break;case l.ThirtySecond:e.marks=3;break;case l.SixtyFourth:e.marks=4;break;case l.OneHundredTwentyEighth:e.marks=5}}crescendo=c.None;displayStart=0;get displayEnd(){return this.displayStart+this.displayDuration}playbackStart=0;displayDuration=0;playbackDuration=0;overrideDisplayDuration;golpe=mt.None;get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}dynamics=n.F;invertBeamDirection=!1;preferredBeamDirection=null;isEffectSlurOrigin=!1;get isEffectSlurDestination(){return!!this.effectSlurOrigin}effectSlurOrigin=null;effectSlurDestination=null;beamingMode=Bt.Auto;wahPedal=wt.None;barreFret=-1;barreShape=yt.None;get isBarre(){return this.barreShape!==yt.None&&this.barreFret>=0}rasgueado=kt.None;showTimer=!1;timer=null;style;addWhammyBarPoint(t){let e=this.whammyBarPoints;null===e&&(e=[],this.whammyBarPoints=e),e.push(t),(!this.maxWhammyPoint||t.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=t),(!this.minWhammyPoint||t.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=t),this.whammyBarType===bt.None&&(this.whammyBarType=bt.Custom)}removeWhammyBarPoint(t){const e=this.whammyBarPoints;if(null===e||t<0||t>=e.length)return;e.splice(t,1);const s=e[t];if(s===this.maxWhammyPoint){this.maxWhammyPoint=null;for(const t of e)(!this.maxWhammyPoint||t.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=t)}if(s===this.minWhammyPoint){this.minWhammyPoint=null;for(const t of e)(!this.minWhammyPoint||t.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=t)}}addNote(t){t.beat=this,t.index=this.notes.length,this.notes.push(t),t.isStringed&&this.noteStringLookup.set(t.string,t)}removeNote(t){const e=this.notes.indexOf(t);e>=0&&(this.notes.splice(e,1),t.isStringed&&this.noteStringLookup.delete(t.string))}getAutomation(t){for(let e=0,s=this.automations.length;e<s;e++){const s=this.automations[e];if(s.type===t)return s}return null}getNoteOnString(t){return this.noteStringLookup.has(t)?this.noteStringLookup.get(t):null}Dt(){if(void 0!==this.overrideDisplayDuration)return this.overrideDisplayDuration;if(this.isFullBarRest)return this.voice.bar.masterBar.calculateDuration();let t=$.toTicks(this.duration);return 2===this.dots?t=$.applyDot(t,!0):1===this.dots&&(t=$.applyDot(t,!1)),this.tupletDenominator>0&&this.tupletNumerator>=0&&(t=$.applyTuplet(t,this.tupletNumerator,this.tupletDenominator)),t}updateDurations(){const t=this.Dt();switch(this.playbackDuration=t,this.graceType){case u.BeforeBeat:case u.OnBeat:switch(this.duration){case l.Sixteenth:this.playbackDuration=$.toTicks(l.SixtyFourth);break;case l.ThirtySecond:this.playbackDuration=$.toTicks(l.OneHundredTwentyEighth);break;default:this.playbackDuration=$.toTicks(l.ThirtySecond)}this.displayDuration=0;break;case u.BendGrace:this.playbackDuration/=2,this.displayDuration=0;break;default:this.displayDuration=t;const e=this.previousBeat;e&&e.graceType===u.BendGrace&&(this.playbackDuration=e.playbackDuration)}}finishTuplet(){const t=this.previousBeat;let e=t?t.tupletGroup:null;(this.hasTuplet||this.graceType!==u.None&&e)&&(t&&e&&e.check(this)||(e=new Zt(this.voice),e.check(this)),this.tupletGroup=e);const s=this.voice.bar.masterBar.calculateDuration(!1),i=[];for(const t of this.automations)0===t.ratioPosition&&(t.ratioPosition=this.playbackStart/s),t.type!==r.Tempo&&i.push(t);this.automations=i}finish(e,s=null){switch(null===this.getAutomation(r.Instrument)&&0===this.index&&0===this.voice.index&&0===this.voice.bar.index&&0===this.voice.bar.staff.index&&this.automations.push(U.buildInstrumentAutomation(!1,0,this.voice.bar.staff.track.playbackInfo.program)),this.graceType){case u.OnBeat:case u.BeforeBeat:const t=this.graceGroup.beats.length;this.duration=1===t?l.Eighth:2===t?l.Sixteenth:l.ThirtySecond}this.brushType===o.None&&(this.brushDuration=0);const i=this.tremoloPicking;void 0!==i&&(i.marks<te.minMarks||i.marks>te.maxMarks)&&(this.tremoloPicking=void 0);const n=e?e.notation.notationMode:t.NotationMode.GuitarPro;let c="grad"===this.text||"grad."===this.text;c&&n===t.NotationMode.SongBook&&(this.text="");let d=!1;this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null;let f=0,p=!1;for(let i=0,r=this.notes.length;i<r;i++){const r=this.notes[i];if(r.dynamics=this.dynamics,r.finish(e,s),r.isLetRing&&(this.isLetRing=!0),r.isPalmMute&&(this.isPalmMute=!0),n===t.NotationMode.SongBook&&r.hasBend&&this.graceType!==u.BendGrace){if(!r.isTieOrigin)switch(r.bendType){case h.Bend:case h.PrebendRelease:case h.PrebendBend:d=!0}c||r.bendStyle===a.Gradual?(c=!0,r.bendStyle=a.Gradual,d=!1):r.bendStyle=a.Fast}r.isVisible&&(f++,(!this.minNote||r.realValue<this.minNote.realValue)&&(this.minNote=r),(!this.maxNote||r.realValue>this.maxNote.realValue)&&(this.maxNote=r),(!this.minStringNote||r.string<this.minStringNote.string)&&(this.minStringNote=r),(!this.maxStringNote||r.string>this.maxStringNote.string)&&(this.maxStringNote=r),r.hasEffectSlur&&(p=!0))}if(p&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),this.notes.length>0&&0===f&&(this.isEmpty=!0),this.isRest||this.isLetRing&&this.isPalmMute)this.isRest&&this.previousBeat&&e&&e.notation.notationMode===t.NotationMode.GuitarPro&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute&&(this.isPalmMute=!0));else{let t=this.previousBeat;for(;t&&t.isRest;)this.isLetRing||(t.isLetRing=!1),this.isPalmMute||(t.isPalmMute=!1),t=t.previousBeat}const b=this.whammyBarPoints,m=null!==b&&b.length>0;if(m){const t=!!this.previousBeat&&this.previousBeat.hasWhammyBar;this.isContinuedWhammy=t}else this.whammyBarType=bt.None;if(m&&this.whammyBarType===bt.Custom)if(n===t.NotationMode.SongBook&&(this.whammyStyle=c?a.Gradual:a.Fast),4===b.length){const e=b[0],s=b[1],i=b[2],r=b[3];s.value===i.value&&(e.value<s.value&&s.value<r.value||e.value>s.value&&s.value>r.value?(0===e.value||this.isContinuedWhammy?this.whammyBarType=bt.Dive:this.whammyBarType=bt.PrediveDive,b.splice(2,1),b.splice(1,1)):e.value>s.value&&s.value<r.value||e.value<s.value&&s.value>r.value?(this.whammyBarType=bt.Dip,s.offset!==i.offset&&n!==t.NotationMode.SongBook||b.splice(2,1)):e.value===s.value&&s.value===r.value&&(0===e.value||this.isContinuedWhammy?this.whammyBarType=bt.Hold:this.whammyBarType=bt.Predive,b.splice(2,1),b.splice(1,1)))}else if(3===b.length){const t=b[0],e=b[1],s=b[2];t.value<e.value&&e.value<s.value||t.value>e.value&&e.value>s.value?(0===t.value||this.isContinuedWhammy?this.whammyBarType=bt.Dive:this.whammyBarType=bt.PrediveDive,b.splice(1,1)):t.value>e.value&&e.value<s.value||t.value<e.value&&e.value>s.value?this.whammyBarType=bt.Dip:t.value===e.value&&e.value===s.value&&(0===t.value||this.isContinuedWhammy?this.whammyBarType=bt.Hold:this.whammyBarType=bt.Predive,b.splice(1,1))}else if(2===b.length){const t=b[0],e=b[1];t.value<e.value||t.value>e.value?0===t.value||this.isContinuedWhammy?this.whammyBarType=bt.Dive:this.whammyBarType=bt.PrediveDive:t.value===e.value&&(0===t.value||this.isContinuedWhammy?this.whammyBarType=bt.Hold:this.whammyBarType=bt.Predive)}if(this.updateDurations(),d){const t=oe.clone(this);t.id=se.At++,t.pickStroke=lt.None;for(let e=0,s=t.notes.length;e<s;e++){const s=t.notes[e],i=this.notes[e];if(s.bendType=h.None,s.maxBendPoint=null,s.bendPoints=null,s.bendStyle=a.Default,s.id=Qt.globalNoteId++,i.isTieOrigin&&(s.tieDestination=i.tieDestination,i.tieDestination.tieOrigin=s),i.isTieDestination&&(s.tieOrigin=i.tieOrigin?i.tieOrigin:null,i.tieOrigin.tieDestination=s),i.hasBend&&i.isTieOrigin){const t=Qt.findTieOrigin(i);if(t&&t.hasBend){s.bendType=h.Hold;const t=i.bendPoints[i.bendPoints.length-1];s.addBendPoint(new z(0,t.value)),s.addBendPoint(new z(z.MaxPosition,t.value))}}s.isTieDestination=!0}this.graceType=u.BendGrace,this.graceGroup=new nt,this.graceGroup.addBeat(this),this.graceGroup.isComplete=!0,this.graceGroup.finish(),this.updateDurations(),this.voice.insertBeat(this,t),t.graceGroup=new nt,t.graceGroup.addBeat(this),t.graceGroup.isComplete=!0,t.graceGroup.finish()}}isBefore(t){return this.voice.bar.index<t.voice.bar.index||t.voice.bar.index===this.voice.bar.index&&this.index<t.index}isAfter(t){return this.voice.bar.index>t.voice.bar.index||t.voice.bar.index===this.voice.bar.index&&this.index>t.index}hasNoteOnString(t){return this.noteStringLookup.has(t)}getNoteWithRealValue(t){return this.noteValueLookup.has(t)?this.noteValueLookup.get(t):null}chain(t=null){for(const e of this.notes)this.noteValueLookup.set(e.realValue,e),e.chain(t)}}class ie{static clone(t){const e=new z;return e.offset=t.offset,e.value=t.value,e}}class ne{static clone(t){const e=new Qt;if(e.index=t.index,e.accentuated=t.accentuated,e.bendType=t.bendType,e.bendStyle=t.bendStyle,e.isContinuedBend=t.isContinuedBend,t.bendPoints){e.bendPoints=[];for(const s of t.bendPoints)e.addBendPoint(ie.clone(s))}return e.fret=t.fret,e.string=t.string,e.showStringNumber=t.showStringNumber,e.octave=t.octave,e.tone=t.tone,e.percussionArticulation=t.percussionArticulation,e.isVisible=t.isVisible,e.isLeftHandTapped=t.isLeftHandTapped,e.isHammerPullOrigin=t.isHammerPullOrigin,e.isSlurDestination=t.isSlurDestination,e.harmonicType=t.harmonicType,e.harmonicValue=t.harmonicValue,e.isGhost=t.isGhost,e.isLetRing=t.isLetRing,e.isPalmMute=t.isPalmMute,e.isDead=t.isDead,e.isStaccato=t.isStaccato,e.slideInType=t.slideInType,e.slideOutType=t.slideOutType,e.vibrato=t.vibrato,e.isTieDestination=t.isTieDestination,e.leftHandFinger=t.leftHandFinger,e.rightHandFinger=t.rightHandFinger,e.trillValue=t.trillValue,e.trillSpeed=t.trillSpeed,e.durationPercent=t.durationPercent,e.accidentalMode=t.accidentalMode,e.dynamics=t.dynamics,e.ornament=t.ornament,e}}class re{static clone(t){const e=new H;return e.barOccurence=t.barOccurence,e.millisecondOffset=t.millisecondOffset,e}}class ae{static clone(t){const e=new U;return e.isLinear=t.isLinear,e.type=t.type,e.value=t.value,e.syncPointValue=t.syncPointValue?re.clone(t.syncPointValue):void 0,e.ratioPosition=t.ratioPosition,e.text=t.text,e.isVisible=t.isVisible,e}}class he{static clone(t){const e=new te;return e.marks=t.marks,e.style=t.style,e}}class oe{static clone(t){const e=new se;e.index=t.index,e.notes=[];for(const s of t.notes)e.addNote(ne.clone(s));e.isEmpty=t.isEmpty,e.whammyStyle=t.whammyStyle,e.ottava=t.ottava,e.isLegatoOrigin=t.isLegatoOrigin,e.duration=t.duration,e.isLetRing=t.isLetRing,e.isPalmMute=t.isPalmMute,e.automations=[];for(const s of t.automations)e.automations.push(ae.clone(s));if(e.dots=t.dots,e.fade=t.fade,e.lyrics=t.lyrics?t.lyrics.slice():null,e.pop=t.pop,e.slap=t.slap,e.tap=t.tap,e.text=t.text,e.slashed=t.slashed,e.deadSlapped=t.deadSlapped,e.brushType=t.brushType,e.brushDuration=t.brushDuration,e.tupletDenominator=t.tupletDenominator,e.tupletNumerator=t.tupletNumerator,e.isContinuedWhammy=t.isContinuedWhammy,e.whammyBarType=t.whammyBarType,t.whammyBarPoints){e.whammyBarPoints=[];for(const s of t.whammyBarPoints)e.addWhammyBarPoint(ie.clone(s))}return e.vibrato=t.vibrato,e.chordId=t.chordId,e.graceType=t.graceType,e.pickStroke=t.pickStroke,e.tremoloPicking=t.tremoloPicking?he.clone(t.tremoloPicking):void 0,e.crescendo=t.crescendo,e.displayStart=t.displayStart,e.playbackStart=t.playbackStart,e.displayDuration=t.displayDuration,e.playbackDuration=t.playbackDuration,e.overrideDisplayDuration=t.overrideDisplayDuration,e.golpe=t.golpe,e.dynamics=t.dynamics,e.invertBeamDirection=t.invertBeamDirection,e.preferredBeamDirection=t.preferredBeamDirection,e.isEffectSlurOrigin=t.isEffectSlurOrigin,e.beamingMode=t.beamingMode,e.wahPedal=t.wahPedal,e.barreFret=t.barreFret,e.barreShape=t.barreShape,e.rasgueado=t.rasgueado,e.showTimer=t.showTimer,e.timer=t.timer,e}}class ce{static Lt(t){const e=new Map;for(const[s,i]of t)e.has(i)||e.set(i,s);return e}static whammyType=new Map([["custom",1],["dive",2],["dip",3],["hold",4],["predive",5],["predivedive",6]]);static whammyTypeReversed=ce.Lt(ce.whammyType);static bendStyle=new Map([["default",0],["gradual",1],["fast",2]]);static bendStyleReversed=ce.Lt(ce.bendStyle);static graceType=new Map([["onbeat",1],["beforebeat",2],["bendgrace",3],["ob",1],["bb",2],["b",3]]);static graceTypeReversed=ce.Lt(ce.graceType);static fermataType=new Map([["short",0],["medium",1],["long",2]]);static fermataTypeReversed=ce.Lt(ce.fermataType);static alphaTexAccidentalMode=new Map([["auto",0],["explicit",1]]);static alphaTexAccidentalModeReversed=ce.Lt(ce.alphaTexAccidentalMode);static alphaTexVoiceMode=new Map([["staffwise",0],["barwise",1]]);static alphaTexVoiceModeReversed=ce.Lt(ce.alphaTexVoiceMode);static noteAccidentalMode=new Map([["default",0],["forcenone",1],["forcenatural",2],["forcesharp",3],["forcedoublesharp",4],["forceflat",5],["forcedoubleflat",6],["d",0],["-",1],["n",2],["#",3],["##",4],["x",4],["b",5],["bb",6]]);static noteAccidentalModeReversed=ce.Lt(ce.noteAccidentalMode);static barreShape=new Map([["full",1],["half",2]]);static barreShapeReversed=ce.Lt(ce.barreShape);static ottavia=new Map([["15ma",0],["8va",1],["regular",2],["8vb",3],["15mb",4],["15ma",0],["8va",1],["8vb",3],["15mb",4]]);static ottaviaReversed=ce.Lt(ce.ottavia);static rasgueado=new Map([["ii",1],["mi",2],["miitriplet",3],["miianapaest",4],["pmptriplet",5],["pmpanapaest",6],["peitriplet",7],["peianapaest",8],["paitriplet",9],["paianapaest",10],["amitriplet",11],["amianapaest",12],["ppp",13],["amii",14],["amip",15],["eami",16],["eamii",17],["peami",18]]);static rasgueadoReversed=ce.Lt(ce.rasgueado);static dynamicValue=new Map([["ppp",0],["pp",1],["p",2],["mp",3],["mf",4],["f",5],["ff",6],["fff",7],["pppp",8],["ppppp",9],["pppppp",10],["ffff",11],["fffff",12],["ffffff",13],["sf",14],["sfp",15],["sfpp",16],["fp",17],["rf",18],["rfz",19],["sfz",20],["sffz",21],["fz",22],["n",23],["pf",24],["sfzp",25]]);static dynamicValueReversed=ce.Lt(ce.dynamicValue);static bracketExtendMode=new Map([["nobrackets",0],["groupstaves",1],["groupsimilarinstruments",2]]);static bracketExtendModeReversed=ce.Lt(ce.bracketExtendMode);static trackNamePolicy=new Map([["hidden",0],["firstsystem",1],["allsystems",2]]);static trackNamePolicyReversed=ce.Lt(ce.trackNamePolicy);static trackNameOrientation=new Map([["horizontal",0],["vertical",1]]);static trackNameOrientationReversed=ce.Lt(ce.trackNameOrientation);static trackNameMode=new Map([["fullname",0],["shortname",1]]);static trackNameModeReversed=ce.Lt(ce.trackNameMode);static textAlign=new Map([["left",0],["center",1],["right",2]]);static textAlignReversed=ce.Lt(ce.textAlign);static bendType=new Map([["custom",1],["bend",2],["release",3],["bendrelease",4],["hold",5],["prebend",6],["prebendbend",7],["prebendrelease",8]]);static bendTypeReversed=ce.Lt(ce.bendType);static keySignature=new Map([["cb",-7],["gb",-6],["db",-5],["ab",-4],["eb",-3],["bb",-2],["f",-1],["c",0],["g",1],["d",2],["a",3],["e",4],["b",5],["f#",6],["c#",7],["cbmajor",-7],["abminor",-7],["gbmajor",-6],["ebminor",-6],["dbmajor",-5],["bbminor",-5],["abmajor",-4],["fminor",-4],["ebmajor",-3],["cminor",-3],["bbmajor",-2],["gminor",-2],["fmajor",-1],["dminor",-1],["cmajor",0],["aminor",0],["gmajor",1],["eminor",1],["dmajor",2],["bminor",2],["amajor",3],["f#minor",3],["emajor",4],["c#minor",4],["bmajor",5],["g#minor",5],["f#major",6],["d#minor",6],["f#",6],["c#major",7],["a#minor",7],["c#",7]]);static keySignatureReversed=ce.Lt(ce.keySignature);static keySignatureType=new Map([["major",0],["minor",1],["cb",0],["cbmajor",0],["gb",0],["gbmajor",0],["db",0],["dbmajor",0],["ab",0],["abmajor",0],["eb",0],["ebmajor",0],["bb",0],["bbmajor",0],["f",0],["fmajor",0],["c",0],["cmajor",0],["g",0],["gmajor",0],["d",0],["dmajor",0],["a",0],["amajor",0],["e",0],["emajor",0],["b",0],["bmajor",0],["f#",0],["f#major",0],["c#",0],["c#major",0],["abminor",1],["ebminor",1],["bbminor",1],["fminor",1],["cminor",1],["gminor",1],["dminor",1],["aminor",1],["eminor",1],["bminor",1],["f#minor",1],["c#minor",1],["g#minor",1],["d#minor",1],["a#minor",1]]);static keySignatureTypeReversed=ce.Lt(ce.keySignatureType);static clef=new Map([["neutral",0],["c3",1],["c4",2],["f4",3],["g2",4],["n",0],["alto",1],["tenor",2],["bass",3],["treble",4]]);static clefReversed=ce.Lt(ce.clef);static tripletFeel=new Map([["none",0],["triplet16th",1],["triplet8th",2],["dotted16th",3],["dotted8th",4],["scottish16th",5],["scottish8th",6],["none",0],["no",0],["notripletfeel",0],["t16",1],["triplet-16th",1],["t8",2],["triplet-8th",2],["d16",3],["dotted-16th",3],["d8",4],["dotted-8th",4],["s16",5],["scottish-16th",5],["s8",6],["scottish-8th",6]]);static tripletFeelReversed=ce.Lt(ce.tripletFeel);static barLineStyle=new Map([["automatic",0],["dashed",1],["dotted",2],["heavy",3],["heavyheavy",4],["heavylight",5],["lightheavy",6],["lightlight",7],["none",8],["regular",9],["short",10],["tick",11]]);static barLineStyleReversed=ce.Lt(ce.barLineStyle);static simileMark=new Map([["none",0],["simple",1],["firstofdouble",2],["secondofdouble",3]]);static simileMarkReversed=ce.Lt(ce.simileMark);static direction=new Map([["fine",0],["segno",1],["segnosegno",2],["coda",3],["doublecoda",4],["dacapo",5],["dacapoalcoda",6],["dacapoaldoublecoda",7],["dacapoalfine",8],["dalsegno",9],["dalsegnoalcoda",10],["dalsegnoaldoublecoda",11],["dalsegnoalfine",12],["dalsegnosegno",13],["dalsegnosegnoalcoda",14],["dalsegnosegnoaldoublecoda",15],["dalsegnosegnoalfine",16],["dacoda",17],["dadoublecoda",18]]);static directionReversed=ce.Lt(ce.direction);static tremoloPickingStyle=new Map([["default",0],["buzzroll",1]]);static tremoloPickingStyleReversed=ce.Lt(ce.tremoloPickingStyle);static barNumberDisplay=new Map([["allbars",0],["firstofsystem",1],["hide",2]]);static barNumberDisplayReversed=ce.Lt(ce.barNumberDisplay);static keySignaturesMinorReversed=new Map([[-7,"abminor"],[-6,"ebminor"],[-5,"bbminor"],[-4,"fminor"],[-3,"cminor"],[-2,"gminor"],[-1,"dminor"],[0,"aminor"],[1,"eminor"],[2,"bminor"],[3,"f#minor"],[4,"c#minor"],[5,"g#minor"],[6,"d#minor"],[7,"a#minor"]]);static keySignaturesMajorReversed=new Map([[-7,"cb"],[-6,"gb"],[-5,"db"],[-4,"ab"],[-3,"eb"],[-2,"bb"],[-1,"f"],[0,"c"],[1,"g"],[2,"d"],[3,"a"],[4,"e"],[5,"b"],[6,"f#"],[7,"c#"]])}class le{static Wt(t){return t?{expectedTypes:new Set(t[0]),parseMode:t[1],allowedValues:t.length>2&&t[2]&&t[2].length>0?new Set(t[2]):void 0,reservedIdentifiers:t.length>3&&t[3]&&t[3].length>0?new Set(t[3]):void 0}:null}static Rt(t){return null==t?null:t.map(t=>({isStrict:t.length>0&&null===t[0],parameters:t.map(le.Wt).filter(t=>null!==t)}))}static It(t){return new Map(t.map(t=>[t[0],null===t[1]?null:new Map(t[1].map(t=>[t[0],le.Rt(t[1])]))]))}static Ot(t){return new Map(t.map(t=>[t[0],le.Rt(t[1])]))}static Gt(t){return new Map(t.map(t=>[t[0],le.Rt(t[1])]))}static scoreMetaDataSignatures=le.Gt([["title",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["subtitle",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["artist",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["album",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["words",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["music",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["wordsandmusic",[[[[17],0],[[10,17],1,["left","center","right"]]]]],["copyright",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["copyright2",[[[[17],0],[[10,17],1,["left","center","right"]]]]],["instructions",[[[[17,10],0]]]],["notices",[[[[17,10],0]]]],["tab",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["systemslayout",[[[[16],5]]]],["defaultsystemslayout",[[[[16],0]]]],["showdynamics",null],["hidedynamics",null],["usesystemsignseparator",null],["multibarrest",null],["bracketextendmode",[[[[10,17],0,["nobrackets","groupstaves","groupsimilarinstruments"]]]]],["singletracktracknamepolicy",[[[[10,17],0,["hidden","firstsystem","allsystems"]]]]],["multitracktracknamepolicy",[[[[10,17],0,["hidden","firstsystem","allsystems"]]]]],["firstsystemtracknamemode",[[[[10,17],0,["fullname","shortname"]]]]],["othersystemstracknamemode",[[[[10,17],0,["fullname","shortname"]]]]],["firstsystemtracknameorientation",[[[[10,17],0,["horizontal","vertical"]]]]],["othersystemstracknameorientation",[[[[10,17],0,["horizontal","vertical"]]]]],["extendbarlines",null],["chorddiagramsinscore",[[[[10],1,["true","false"]]]]],["hideemptystaves",null],["hideemptystavesinfirstsystem",null],["showsinglestaffbrackets",null],["defaultbarnumberdisplay",[[[[10,17],0,["allbars","firstofsystem","hide"]]]]]]);static staffMetaDataSignatures=le.Gt([["tuning",[[[[10,17],0,["piano","none","voice"]]],[[[10,17],5]]]],["chord",[[[[17,10],0],[[10,17,16],5]]]],["capo",[[[[16],0]]]],["lyrics",[[[[17],0]],[[[16],0],[[17],0]]]],["articulation",[[[[10],0,["defaults"]]],[[[17,10],0],[[16],0]]]],["displaytranspose",[[[[16],0]]]],["transpose",[[[[16],0]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]]]);static structuralMetaDataSignatures=le.Gt([["track",[[[[17],1],[[17],1]]]],["staff",null],["voice",null]]);static barMetaDataSignatures=le.Gt([["ts",[[[[10,17],0,["common"]]],[[[16],0],[[16],0]]]],["ro",null],["rc",[[[[16],0]]]],["ae",[[[[16,13],4]]]],["ks",[[[[10,17],0,["cb","gb","db","ab","eb","bb","f","c","g","d","a","e","b","f#","c#","cbmajor","abminor","gbmajor","ebminor","dbmajor","bbminor","abmajor","fminor","ebmajor","cminor","bbmajor","gminor","fmajor","dminor","cmajor","aminor","gmajor","eminor","dmajor","bminor","amajor","f#minor","emajor","c#minor","bmajor","g#minor","f#major","d#minor","f#","c#major","a#minor","c#"]]]]],["clef",[[[[10,16,17],0,["neutral","c3","c4","f4","g2","n","alto","tenor","bass","treble"]]]]],["ottava",[[[[10,17],0,["15ma","8va","regular","8vb","15mb","15ma","8va","8vb","15mb"]]]]],["tempo",[[[[16],2],[[17],1]],[null,[[16],2],[[17],0],[[16],1],[[10],1,["hide"]]]]],["tf",[[[[10,16,17],0,["none","triplet16th","triplet8th","dotted16th","dotted8th","scottish16th","scottish8th","none","no","notripletfeel","t16","triplet-16th","t8","triplet-8th","d16","dotted-16th","d8","dotted-8th","s16","scottish-16th","s8","scottish-8th"]]]]],["ac",null],["section",[[[[17,10],0]],[[[17,10],0],[[17,10],0,null,["x","-","r"]]]]],["jump",[[[[10,17],0,["fine","segno","segnosegno","coda","doublecoda","dacapo","dacapoalcoda","dacapoaldoublecoda","dacapoalfine","dalsegno","dalsegnoalcoda","dalsegnoaldoublecoda","dalsegnoalfine","dalsegnosegno","dalsegnosegnoalcoda","dalsegnosegnoaldoublecoda","dalsegnosegnoalfine","dacoda","dadoublecoda"]]]]],["ft",null],["simile",[[[[10,17],0,["none","simple","firstofdouble","secondofdouble"]]]]],["barlineleft",[[[[10,17],0,["automatic","dashed","dotted","heavy","heavyheavy","heavylight","lightheavy","lightlight","none","regular","short","tick"]]]]],["barlineright",[[[[10,17],0,["automatic","dashed","dotted","heavy","heavyheavy","heavylight","lightheavy","lightlight","none","regular","short","tick"]]]]],["scale",[[[[16],2]]]],["width",[[[[16],2]]]],["sync",[[[[16],0],[[16],0],[[16],0],[[16],3]]]],["accidentals",[[[[10,17],0,["auto","explicit"]]]]],["spd",[[[[16],2]]]],["sph",[[[[16],2]]]],["spu",[[[[16],2]]]],["db",null],["voicemode",[[[[10,17],0,["staffwise","barwise"]]]]],["barnumberdisplay",[[[[10,17],0,["allbars","firstofsystem","hide"]]]]],["beaming",[[[[16],0],[[16],5]]]]]);static metaDataProperties=le.It([["track",[["color",[[[[17],0]]]],["systemslayout",[[[[16],5]]]],["defaultsystemslayout",[[[[16],0]]]],["solo",null],["mute",null],["volume",[[[[16],0]]]],["balance",[[[[16],0]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]],["bank",[[[[16],0]]]],["multibarrest",null]]],["staff",[["score",[[[[16],1]]]],["tabs",null],["slash",null],["numbered",null]]],["voice",null],["title",null],["subtitle",null],["artist",null],["album",null],["words",null],["music",null],["wordsandmusic",null],["copyright",null],["copyright2",null],["instructions",null],["notices",null],["tab",null],["systemslayout",null],["defaultsystemslayout",null],["showdynamics",null],["hidedynamics",null],["usesystemsignseparator",null],["multibarrest",null],["bracketextendmode",null],["singletracktracknamepolicy",null],["multitracktracknamepolicy",null],["firstsystemtracknamemode",null],["othersystemstracknamemode",null],["firstsystemtracknameorientation",null],["othersystemstracknameorientation",null],["extendbarlines",null],["chorddiagramsinscore",null],["hideemptystaves",null],["hideemptystavesinfirstsystem",null],["showsinglestaffbrackets",null],["defaultbarnumberdisplay",null],["tuning",[["hide",null],["label",[[[[17],0]]]]]],["chord",[["firstfret",[[[[16],0]]]],["barre",[[[[16],5]]]],["showdiagram",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]],["showfingering",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]],["showname",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]]]],["capo",null],["lyrics",null],["articulation",null],["displaytranspose",null],["transpose",null],["instrument",null],["ts",null],["ro",null],["rc",null],["ae",null],["ks",null],["clef",null],["ottava",null],["tempo",null],["tf",null],["ac",null],["section",null],["jump",null],["ft",null],["simile",null],["barlineleft",null],["barlineright",null],["scale",null],["width",null],["sync",null],["accidentals",null],["spd",null],["sph",null],["spu",null],["db",null],["voicemode",null],["barnumberdisplay",null],["beaming",null]]);static metaDataSignatures=[le.scoreMetaDataSignatures,le.staffMetaDataSignatures,le.structuralMetaDataSignatures,le.barMetaDataSignatures];static durationChangeProperties=le.Ot([["tu",[[[[16],0,["3","5","6","7","9","10","12"]]],[[[16],0],[[16],0]]]]]);static beatProperties=le.Ot([["f",null],["fo",null],["vs",null],["v",null],["vw",null],["s",null],["p",null],["tt",null],["d",null],["dd",null],["su",null],["sd",null],["cre",null],["dec",null],["spd",null],["sph",null],["spu",null],["spe",null],["slashed",null],["ds",null],["glpf",null],["glpt",null],["waho",null],["wahc",null],["legatoorigin",null],["timer",null],["tu",[[[[16],0,["3","5","6","7","9","10","12"]]],[[[16],0],[[16],0]]]],["txt",[[[[17,10],0]]]],["lyrics",[[[[17],0]],[[[16],0],[[17],0]]]],["tb",[[[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["tbe",[[[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["bu",[[[[16],1]]]],["bd",[[[[16],1]]]],["au",[[[[16],1]]]],["ad",[[[[16],1]]]],["ch",[[[[17,10],0]]]],["gr",[[[[10,17],1,["onbeat","beforebeat","bendgrace","ob","bb","b"]]]]],["dy",[[[[10,17],0,["ppp","pp","p","mp","mf","f","ff","fff","pppp","ppppp","pppppp","ffff","fffff","ffffff","sf","sfp","sfpp","fp","rf","rfz","sfz","sffz","fz","n","pf","sfzp"]]]]],["tempo",[[[[16],0],[[10],1,["hide"]]],[[[16],0],[[17],0],[[10],1,["hide"]]]]],["volume",[[[[16],0]]]],["balance",[[[[16],0]]]],["tp",[[[[16],0],[[10,17],1,["default","buzzroll"]]]]],["barre",[[[[16],0],[[10,17],1,["full","half"]]]]],["rasg",[[[[10,17],0,["ii","mi","miitriplet","miianapaest","pmptriplet","pmpanapaest","peitriplet","peianapaest","paitriplet","paianapaest","amitriplet","amianapaest","ppp","amii","amip","eami","eamii","peami"]]]]],["ot",[[[[10,17],0,["15ma","8va","regular","8vb","15mb","15ma","8va","8vb","15mb"]]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]],["bank",[[[[16],0]]]],["fermata",[[[[10,17],0,["short","medium","long"]],[[16],3]]]],["beam",[[[[10,17],0,["invert","up","down","auto","split","merge","splitsecondary"]]]]]]);static noteProperties=le.Ot([["nh",null],["ah",[[[[16],1]]]],["th",[[[[16],1]]]],["ph",[[[[16],1]]]],["sh",[[[[16],1]]]],["fh",[[[[16],1]]]],["v",null],["vw",null],["sl",null],["ss",null],["sib",null],["sia",null],["sou",null],["sod",null],["psu",null],["psd",null],["h",null],["lht",null],["g",null],["ac",null],["hac",null],["ten",null],["tr",[[[[16],0],[[16],1,["16","32","64"]]]]],["pm",null],["st",null],["lr",null],["x",null],["t",null],["turn",null],["iturn",null],["umordent",null],["lmordent",null],["string",null],["hide",null],["b",[[[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["be",[[[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["lf",[[[[16],0,["1","2","3","4","5"]]]]],["rf",[[[[16],0,["1","2","3","4","5"]]]]],["acc",[[[[10,17],0,["default","forcenone","forcenatural","forcesharp","forcedoublesharp","forceflat","forcedoubleflat","d","-","n","#","##","x","b","bb"]]]]],["slur",[[[[17],0]],[[[10],0]]]],["-",null]])}!function(t){t[t.Dot=0]="Dot",t[t.Backslash=1]="Backslash",t[t.DoubleBackslash=2]="DoubleBackslash",t[t.Pipe=3]="Pipe",t[t.LBrace=4]="LBrace",t[t.RBrace=5]="RBrace",t[t.LParen=6]="LParen",t[t.RParen=7]="RParen",t[t.Colon=8]="Colon",t[t.Asterisk=9]="Asterisk",t[t.Ident=10]="Ident",t[t.Tag=11]="Tag",t[t.Meta=12]="Meta",t[t.Arguments=13]="Arguments",t[t.Props=14]="Props",t[t.Prop=15]="Prop",t[t.Number=16]="Number",t[t.String=17]="String",t[t.Score=18]="Score",t[t.Bar=19]="Bar",t[t.Beat=20]="Beat",t[t.Duration=21]="Duration",t[t.NoteList=22]="NoteList",t[t.Note=23]="Note"}(Tt||(Tt={})),function(t){t[t.Hint=0]="Hint",t[t.Warning=1]="Warning",t[t.Error=2]="Error"}(xt||(xt={})),function(t){t[t.AT001=1]="AT001",t[t.AT002=2]="AT002",t[t.AT003=3]="AT003",t[t.AT004=4]="AT004",t[t.AT005=5]="AT005",t[t.AT006=6]="AT006",t[t.AT200=200]="AT200",t[t.AT201=201]="AT201",t[t.AT202=202]="AT202",t[t.AT203=203]="AT203",t[t.AT204=204]="AT204",t[t.AT205=205]="AT205",t[t.AT206=206]="AT206",t[t.AT207=207]="AT207",t[t.AT208=208]="AT208",t[t.AT209=209]="AT209",t[t.AT210=210]="AT210",t[t.AT211=211]="AT211",t[t.AT212=212]="AT212",t[t.AT213=213]="AT213",t[t.AT214=214]="AT214",t[t.AT215=215]="AT215",t[t.AT216=216]="AT216",t[t.AT217=217]="AT217",t[t.AT218=218]="AT218",t[t.AT219=219]="AT219",t[t.AT220=220]="AT220",t[t.AT300=300]="AT300",t[t.AT301=301]="AT301",t[t.AT302=302]="AT302",t[t.AT303=303]="AT303",t[t.AT304=304]="AT304",t[t.AT305=305]="AT305",t[t.AT306=306]="AT306",t[t.AT400=400]="AT400"}(Mt||(Mt={}));class ue{Vt=!1;items=[];get errors(){return this.items.filter(t=>t.severity===xt.Error)}get hasErrors(){return this.Vt}push(t){this.items.push(t),t.severity===xt.Error&&(this.Vt=!0)}[Symbol.iterator](){return this.items[Symbol.iterator]()}}!function(t){t[t.Auto=0]="Auto",t[t.Explicit=1]="Explicit"}(vt||(vt={})),function(t){t[t.StaffWise=0]="StaffWise",t[t.BarWise=1]="BarWise"}(Nt||(Nt={})),function(t){t[t.Pitched=0]="Pitched",t[t.Fretted=1]="Fretted",t[t.Articulation=2]="Articulation"}(Pt||(Pt={})),function(t){t[t.Required=0]="Required",t[t.Optional=1]="Optional",t[t.RequiredAsFloat=2]="RequiredAsFloat",t[t.OptionalAsFloat=3]="OptionalAsFloat",t[t.RequiredAsValueList=4]="RequiredAsValueList",t[t.ValueListWithoutParenthesis=5]="ValueListWithoutParenthesis"}(Ct||(Ct={}));class de{static $t=new ArrayBuffer(8);static Ht=new Uint8Array(de.$t);static Ut=new DataView(de.$t);static float64ToBytes(t){return de.Ut.setFloat64(0,t,!0),de.Ht}static bytesToInt64LE(t){de.Ht.set(t,0);const e=de.Ut.getBigInt64(0,!0);return e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER?Number(e):Number.MAX_SAFE_INTEGER}static bytesToFloat64LE(t){return de.Ht.set(t,0),de.Ut.getFloat64(0,!0)}static bytesToFloat32LE(t){return de.Ht.set(t,0),de.Ut.getFloat32(0,!0)}static float32BEToBytes(t){return de.Ut.setFloat32(0,t,!1),de.Ht.slice(0,4)}static uint16ToInt16(t){return de.Ut.setUint16(0,t,!0),de.Ut.getInt16(0,!0)}static int16ToUint32(t){return de.Ut.setInt16(0,t,!0),de.Ut.getUint32(0,!0)}static int32ToUint16(t){return de.Ut.setInt32(0,t,!0),de.Ut.getUint16(0,!0)}static int32ToInt16(t){return de.Ut.setInt32(0,t,!0),de.Ut.getInt16(0,!0)}static int32ToUint32(t){return de.Ut.setInt32(0,t,!0),de.Ut.getUint32(0,!0)}static uint8ToInt8(t){return de.Ut.setUint8(0,t),de.Ut.getInt8(0)}}class fe{static readInt32BE(t){return t.readByte()<<24|t.readByte()<<16|t.readByte()<<8|t.readByte()}static readFloat32BE(t){const e=new Uint8Array(4);return t.read(e,0,e.length),e.reverse(),de.bytesToFloat32LE(e)}static readFloat64BE(t){const e=new Uint8Array(8);return t.read(e,0,e.length),e.reverse(),de.bytesToFloat64LE(e)}static readInt32LE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte();return t.readByte()<<24|i<<16|s<<8|e}static readInt64LE(t){const e=new Uint8Array(8);return t.read(e,0,e.length),de.bytesToInt64LE(e)}static readUInt32LE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte();return t.readByte()<<24|i<<16|s<<8|e}static decodeUInt32LE(t,e){const s=t[e],i=t[e+1],n=t[e+2];return t[e+3]<<24|n<<16|i<<8|s}static readUInt16LE(t){const e=t.readByte(),s=t.readByte();return de.int32ToUint16(s<<8|e)}static readInt16LE(t){const e=t.readByte(),s=t.readByte();return de.int32ToInt16(s<<8|e)}static readUInt32BE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte(),n=t.readByte();return de.int32ToUint32(e<<24|s<<16|i<<8|n)}static readUInt16BE(t){const e=t.readByte(),s=t.readByte();return de.int32ToInt16(e<<8|s)}static readInt16BE(t){const e=t.readByte(),s=t.readByte();return de.int32ToInt16(e<<8|s)}static readByteArray(t,e){const s=new Uint8Array(e);return t.read(s,0,e),s}static read8BitChars(t,e){const s=new Uint8Array(e);return t.read(s,0,s.length),fe.toString(s,"utf-8")}static read8BitString(t){let e="",s=t.readByte();for(;0!==s;)e+=String.fromCharCode(s),s=t.readByte();return e}static read8BitStringLength(t,e){let s="",i=-1;for(let n=0;n<e;n++){const e=t.readByte();0===e&&-1===i&&(i=n),s+=String.fromCharCode(e)}const n=s;return i>=0?n.substr(0,i):n}static readSInt8(t){const e=t.readByte();return-256*((255&e)>>7)+(255&e)}static readInt24(t,e){let s=t[e]|t[e+1]<<8|t[e+2]<<16;return 8388608&~s||(s|=255<<24),s}static readInt16(t,e){return de.int32ToInt16(t[e]|t[e+1]<<8)}static toString(t,e){const s=fe.zt(t);s&&(e=s),e||(e="utf-8");return new TextDecoder(e).decode(t.buffer)}static zt(t){return t.length>2&&254===t[0]&&255===t[1]?"utf-16be":t.length>2&&255===t[0]&&254===t[1]?"utf-16le":t.length>4&&0===t[0]&&0===t[1]&&254===t[2]&&255===t[3]?"utf-32be":t.length>4&&255===t[0]&&254===t[1]&&0===t[2]&&0===t[3]?"utf-32le":null}static stringToBytes(t){return(new TextEncoder).encode(t)}static writeInt32BE(t,e){t.writeByte(e>>24&255),t.writeByte(e>>16&255),t.writeByte(e>>8&255),t.writeByte(255&e)}static writeInt32LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255),t.writeByte(e>>16&255),t.writeByte(e>>24&255)}static writeUInt16LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255)}static writeInt16LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255)}static writeInt16BE(t,e){t.writeByte(e>>8&255),t.writeByte(255&e)}static writeFloat32BE(t,e){const s=de.float32BEToBytes(e);t.write(s,0,s.length)}static*iterateCodepoints(t){let e=0;for(;e<t.length;){let s=t.charCodeAt(e);fe.isLeadingSurrogate(s)&&e+1<t.length&&(e++,s=1024*(s-55296)+(t.charCodeAt(e)-56320)+65536),e++,yield s}}static isLeadingSurrogate(t){return t>=55296&&t<=56319}static isTrailingSurrogate(t){return t>=56320&&t<=57343}}class pe{static Xt=0;jt;Jt=pe.Xt;qt=0;Yt=1;Kt=1;fatalError=!1;Qt={line:0,col:0,offset:0};Zt;te;ee;se;lexerDiagnostics=new ue;constructor(t){this.jt=[...fe.iterateCodepoints(t)],this.qt=0,this.Yt=1,this.Kt=1,this.Jt=this.jt.length>0?this.jt[0]:pe.Xt}peekToken(){if(this.fatalError)return;let t=this.se;return t||(t=this.ie(),this.se=t,t)}extendToFloat(t){if(46!==this.Jt||this.qt+1>=this.jt.length||!pe.ne(this.jt[this.qt+1]))return t;let e=this.qt+2;for(;e<this.jt.length&&pe.ne(this.jt[e]);)e++;if(e<this.jt.length&&pe.re(this.jt[e]))return t;const s=e-this.qt-1;return this.qt+=s,this.Kt+=s,this.ae(),t.end=this.he(),t.value=Number.parseFloat(String.fromCodePoint(...this.jt.slice(t.start.offset,t.end.offset))),t}advance(){this.ee=this.se,this.se=void 0}ae(){const t=this.jt;let e=this.qt;if(e<t.length-1){10===t[e]?(this.te=void 0,++this.Yt,this.Kt=1):++this.Kt,++e;const s=t[e];return this.Jt=s,this.qt=e,s}return this.Jt!==pe.Xt&&(this.Jt=pe.Xt,++this.Kt,this.qt=t.length),pe.Xt}previousTokenEndLocation(){return this.ee?.end??this.he()}currentTokenLocation(){return this.se?.start??this.he()}he(){return{line:this.Yt,col:this.Kt,offset:this.qt}}ie(){for(this.Zt=void 0;this.Jt!==pe.Xt&&!this.fatalError;)if(this.Qt=this.he(),pe.oe.has(this.Jt)){const t=pe.oe.get(this.Jt)(this);if(t)return this.te=t,t}else{if(pe.re(this.Jt)){const t=this.ce();return this.te=t,t}this.Jt=this.ae()}}le(){this.Jt=this.ae(),47===this.Jt?this.ue():42===this.Jt?this.de():(this.lexerDiagnostics.push({code:Mt.AT001,message:`Unexpected character at comment start, expected '//' or '/*' but found '/${String.fromCodePoint(this.Jt)}'`,severity:xt.Error,start:this.Qt,end:this.he()}),this.fatalError=!0)}static oe=new Map([[47,t=>t.le()],[34,t=>t.fe()],[39,t=>t.fe()],[45,t=>t.ce()],[46,t=>t.pe({nodeType:Tt.Dot})],[58,t=>t.pe({nodeType:Tt.Colon})],[40,t=>t.pe({nodeType:Tt.LParen})],[41,t=>t.pe({nodeType:Tt.RParen})],[123,t=>t.pe({nodeType:Tt.LBrace})],[125,t=>t.pe({nodeType:Tt.RBrace})],[124,t=>t.pe({nodeType:Tt.Pipe})],[42,t=>t.pe({nodeType:Tt.Asterisk})],[92,t=>t.be()],[9,t=>t.me()],[10,t=>t.me()],[11,t=>t.me()],[13,t=>t.me()],[32,t=>t.me()]]);be(){const t=this.he();let e,s;this.Jt=this.ae(),92===this.Jt?(this.Jt=this.ae(),s=this.he(),e={nodeType:Tt.DoubleBackslash,start:t,end:s}):(s=this.he(),e={nodeType:Tt.Backslash,start:t,end:s});let i="";for(;pe.re(this.Jt);)i+=String.fromCodePoint(this.Jt),this.Jt=this.ae();if(0===i.length)return void this.lexerDiagnostics.push({code:Mt.AT002,message:"Missing identifier after meta data start",severity:xt.Error,start:this.Qt,end:this.he()});return{nodeType:Tt.Tag,leadingComments:this.Zt,start:this.Qt,end:this.he(),prefix:e,tag:{nodeType:Tt.Ident,text:i,start:s,end:this.he()}}}pe(t){return t.leadingComments=this.Zt,t.start=this.Qt,this.Jt=this.ae(),t.end=this.he(),t}fe(){const t=this.Jt;this.Jt=this.ae();let e="",s=-1;for(;this.Jt!==t&&this.Jt!==pe.Xt;){let i=-1;if(92===this.Jt)if(this.Jt=this.ae(),92===this.Jt)i=92;else if(this.Jt===t)i=t;else if(82===this.Jt||114===this.Jt)i=13;else if(78===this.Jt||110===this.Jt)i=10;else if(84===this.Jt||116===this.Jt)i=9;else{if(117!==this.Jt)return this.lexerDiagnostics.push({code:Mt.AT005,message:`Unsupported escape sequence. Expected '\\n', '\\r', '\\t', or '\\uXXXX' but found '\\${String.fromCodePoint(this.Jt)}'.`,severity:xt.Error,start:this.Qt,end:this.he()}),void(this.fatalError=!0);{let t="";for(let e=0;e<4;e++){if(this.Jt=this.ae(),this.Jt===pe.Xt)return this.lexerDiagnostics.push({code:Mt.AT003,message:"Unexpected end of file. Need 4 hex characters on a \\uXXXX escape sequence",severity:xt.Error,start:this.Qt,end:this.he()}),void(this.fatalError=!0);t+=String.fromCodePoint(this.Jt)}if(i=Number.parseInt(t,16),Number.isNaN(i))return this.lexerDiagnostics.push({code:Mt.AT004,message:"Invalid unicode value. Need 4 hex characters on a \\uXXXX escape sequence.",severity:xt.Error,start:this.Qt,end:this.he()}),void(this.fatalError=!0)}}else i=this.Jt;fe.isLeadingSurrogate(s)&&fe.isTrailingSurrogate(i)?(i=1024*(s-55296)+(i-56320)+65536,e+=String.fromCodePoint(i)):fe.isLeadingSurrogate(i)||(fe.isLeadingSurrogate(s)&&(e+=String.fromCodePoint(s)),i>0&&(e+=String.fromCodePoint(i))),s=i,this.Jt=this.ae()}if(this.Jt===pe.Xt)return this.lexerDiagnostics.push({code:Mt.AT006,message:"Unexpected end of file. String not closed.",severity:xt.Error,start:this.Qt,end:this.he()}),void(this.fatalError=!0);const i={nodeType:Tt.String,text:e,leadingComments:this.Zt,start:this.Qt,end:this.he()};return this.Jt=this.ae(),i}de(){const t=this.te,e={start:this.Qt,end:this.he(),text:"",multiLine:!0};for(;this.Jt!==pe.Xt;)if(42===this.Jt){if(this.Jt=this.ae(),47===this.Jt){this.Jt=this.ae();break}e.text+=`*${String.fromCodePoint(this.Jt)}`,e.end.line=this.Yt,e.end.col=this.Kt,e.end.offset=this.qt}else this.Jt=this.ae(),e.text+=String.fromCodePoint(this.Jt),e.end.line=this.Yt,e.end.col=this.Kt,e.end.offset=this.qt;t?(t.trailingComments??=[],t.trailingComments.push(e)):(this.Zt??=[],this.Zt.push(e))}ce(){let t="",e=!0,s=this.Jt;45===s&&(t+=String.fromCodePoint(s),s=this.ae(),pe.ne(s)||(e=!1));let i=!0;do{e?pe.ne(s)?(t+=String.fromCodePoint(s),s=this.ae(),i=!0):pe.re(s)?(e=!1,t+=String.fromCodePoint(s),s=this.ae(),i=!0):i=!1:pe.re(s)?(t+=String.fromCodePoint(s),s=this.ae(),i=!0):i=!1}while(i);if(e){return{nodeType:Tt.Number,leadingComments:this.Zt,start:this.Qt,end:this.he(),value:Number.parseInt(t,10)}}return{nodeType:Tt.Ident,leadingComments:this.Zt,start:this.Qt,end:this.he(),text:t}}ue(){const t=this.te,e={start:this.Qt,end:this.he(),text:"",multiLine:!1};let s=this.Jt;for(;s!==pe.Xt&&(s=this.ae(),10!==s&&s!==pe.Xt);)e.text+=String.fromCodePoint(s),e.end.line=this.Yt,e.end.col=this.Kt,e.end.offset=this.qt;t?(t.trailingComments??=[],t.trailingComments.push(e)):(this.Zt??=[],this.Zt.push(e))}me(){let t=this.Jt;for(;pe.ge(t);)10===t&&(this.te=void 0),t=this.ae()}static ne(t){return t>=48&&t<=57}static we(){const t=new Set;for(const e of pe.oe.keys())t.add(e);return t.delete(45),t.add(pe.Xt),t}static ye=pe.we();static re(t){return!pe.ye.has(t)}static ge(t){return 32===t||10===t||13===t||9===t||11===t}}!function(t){t[t.ForModelImport=0]="ForModelImport",t[t.Full=1]="Full"}(Et||(Et={}));class be{lexer;ke;Se=ge.instance;mode=Et.ForModelImport;get lexerDiagnostics(){return this.lexer.lexerDiagnostics}parserDiagnostics=new ue;addParserDiagnostic(t){this.parserDiagnostics.push(t)}unexpectedToken(t,e,s){t?this.addParserDiagnostic({code:Mt.AT202,message:`Unexpected '${Tt[t.nodeType]}' token. Expected one of following: ${e.map(t=>Tt[t]).join(",")}`,severity:xt.Error,start:t.start,end:t.end}):this.addParserDiagnostic({code:Mt.AT203,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation(),severity:xt.Error,message:"Unexpected end of file."}),s&&(this.lexer.fatalError=!0)}constructor(t){this.lexer=new pe(t)}read(){return this.Be(),this.ke}Be(){this.ke={nodeType:Tt.Score,bars:[],start:this.lexer.currentTokenLocation()};try{this._e()}finally{this.ke.end=this.lexer.previousTokenEndLocation()}}_e(){let t=this.lexer.peekToken();for(;t;)this.Te(),t=this.lexer.peekToken()}Te(){const t={nodeType:Tt.Bar,metaData:[],beats:[],pipe:void 0,start:this.lexer.currentTokenLocation()};this.ke.bars.push(t);try{this.xe(t),this.Me(t);const e=this.lexer.peekToken();e?.nodeType===Tt.Pipe&&(t.pipe=e,this.lexer.advance()),(t.metaData.length>0||t.beats.length>0||t.pipe)&&(t.end=this.lexer.previousTokenEndLocation())}finally{t.end=this.lexer.previousTokenEndLocation()}}xe(t){let e=this.lexer.peekToken();for(;e&&(e.nodeType===Tt.Tag||e.nodeType===Tt.Dot);)e.nodeType===Tt.Dot?(this.lexer.advance(),this.addParserDiagnostic({code:Mt.AT400,message:"The dots separating score metadata, score contents and the sync points can be removed.",severity:xt.Hint,start:e.start,end:e.end})):this.ve(t.metaData),e=this.lexer.peekToken()}Me(t){let e=this.lexer.peekToken();for(;e&&e.nodeType!==Tt.Pipe&&e.nodeType!==Tt.Dot&&e.nodeType!==Tt.Tag;){const s=this.Ne();s&&t.beats.push(s),e=this.lexer.peekToken()}}Ne(){const t={nodeType:Tt.Beat,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0,beatMultiplier:void 0,beatMultiplierValue:void 0,start:this.lexer.peekToken()?.start};try{if(this.Pe(t),this.Ce(t),!t.notes&&!t.rest)return t;this.Ee(t),this.Fe(t),t.beatEffects=this.Ae(t=>this.Se.readBeatPropertyArguments(this,t)),void 0!==t.beatMultiplierValue&&t.beatEffects?.openBrace&&this.addParserDiagnostic({code:Mt.AT304,message:"The beat multiplier should be specified after the beat effects.",severity:xt.Warning,start:t.beatMultiplier.start,end:t.beatMultiplierValue.end}),this.Fe(t)}finally{t.end=this.lexer.previousTokenEndLocation()}return t}Ee(t){const e=this.lexer.peekToken();if(e?.nodeType!==Tt.Dot)return;t.durationDot=e,this.lexer.advance();const s=this.lexer.peekToken();if(s?.nodeType===Tt.Number)return t.durationValue=s,void this.lexer.advance();s?.nodeType!==Tt.Tag?s&&this.unexpectedToken(s,[Tt.Number],!0):t.durationDot=void 0}Pe(t){const e=this.lexer.peekToken();if(e?.nodeType!==Tt.Colon)return;this.lexer.advance();const s={nodeType:Tt.Duration,colon:e,value:void 0,properties:void 0,start:e.start};t.durationChange=s;try{const t=this.lexer.peekToken();if(!t||t.nodeType!==Tt.Number)return void this.addParserDiagnostic({code:Mt.AT201,message:"Missing duration value after ':'.",severity:xt.Error,start:e.start,end:e.end});this.lexer.advance(),s.value=t,s.properties=this.Ae(t=>this.Se.readDurationChangePropertyArguments(this,t))}finally{s.end=this.lexer.previousTokenEndLocation()}}Ce(t){const e=this.lexer.peekToken();if(e)if(e.nodeType===Tt.Ident&&"r"===e.text)t.rest=e,this.lexer.advance();else if(e.nodeType===Tt.LParen)t.notes=this.De(e);else{const s=this.Le(e);s&&(t.notes={nodeType:Tt.NoteList,openParenthesis:void 0,notes:[s],closeParenthesis:void 0,start:s.start,end:s.end})}}Fe(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==Tt.Asterisk)return;this.lexer.advance(),t.beatMultiplier=e;const s=this.lexer.peekToken();s&&s.nodeType===Tt.Number?(t.beatMultiplierValue=s,this.lexer.advance()):this.addParserDiagnostic({code:Mt.AT200,message:"Missing beat multiplier value after '*'.",severity:xt.Error,start:t.beatMultiplier.start,end:t.beatMultiplier.end})}De(t){const e={nodeType:Tt.NoteList,openParenthesis:void 0,notes:[],closeParenthesis:void 0,start:this.lexer.currentTokenLocation()};try{e.openParenthesis=t,this.lexer.advance();let s=this.lexer.peekToken();for(;s&&s.nodeType!==Tt.RParen;){const t=this.Le(s);if(!t)break;e.notes.push(t),s=this.lexer.peekToken()}const i=this.lexer.peekToken();i?.nodeType===Tt.RParen?(e.closeParenthesis=i,this.lexer.advance()):this.addParserDiagnostic({code:Mt.AT206,message:"Unexpected end of file. Group not closed.",severity:xt.Error,start:i?.start??this.lexer.currentTokenLocation(),end:i?.end??this.lexer.currentTokenLocation()})}finally{e.end=this.lexer.previousTokenEndLocation()}return e}Le(t){const e={nodeType:Tt.Note,noteValue:{nodeType:Tt.Ident,text:""},start:t.start};try{let s=!1;switch(t.nodeType){case Tt.Number:e.noteValue=t,this.lexer.advance(),s=!0;break;case Tt.String:case Tt.Ident:switch(e.noteValue=t,this.lexer.advance(),e.noteValue.text){case"x":case"-":s=!0}break;default:return void this.unexpectedToken(t,[Tt.Number,Tt.String,Tt.Ident],!0)}if(s){const t=this.lexer.peekToken();if(t?.nodeType===Tt.Dot){const s=t;this.lexer.advance();const i=this.lexer.peekToken();if(!i)return void this.unexpectedToken(i,[Tt.Number],!0);if(i.nodeType===Tt.Tag)return e;if(i.nodeType!==Tt.Number)return void this.unexpectedToken(i,[Tt.Number],!0);e.noteStringDot=s,e.noteString=i,this.lexer.advance()}}e.noteEffects=this.Ae(t=>this.Se.readNotePropertyArguments(this,t))}finally{e.end=this.lexer.previousTokenEndLocation()}return e}static We=new Set(["chord"]);ve(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==Tt.Tag)return;const s={nodeType:Tt.Meta,tag:e,start:e.start,properties:void 0,propertiesBeforeArguments:!1};this.lexer.advance(),t.push(s);try{const t=be.We.has(s.tag.tag.text),e=this.lexer.peekToken();t&&e?.nodeType===Tt.LBrace?(s.propertiesBeforeArguments=!0,s.properties=this.Ae(t=>this.Se.readMetaDataPropertyArguments(this,s.tag,t)),s.arguments=this.argumentList(),s.arguments||(s.arguments=this.Se.readMetaDataArguments(this,s.tag),s.arguments&&s.arguments.arguments.length>1&&(this.addParserDiagnostic({code:Mt.AT301,message:"Metadata arguments should be wrapped into parenthesis.",severity:xt.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end}),this.addParserDiagnostic({code:Mt.AT302,message:"Metadata arguments should be placed before metadata properties.",severity:xt.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end})))):(this.Se.hasMetaDataArguments(s.tag)&&(s.arguments=this.argumentList(),s.arguments||(s.arguments=this.Se.readMetaDataArguments(this,s.tag),s.arguments&&s.arguments.arguments.length>1&&this.addParserDiagnostic({code:Mt.AT301,message:"Metadata arguments should be wrapped into parenthesis.",severity:xt.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end}))),s.properties=this.Ae(t=>this.Se.readMetaDataPropertyArguments(this,s.tag,t)))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}Ae(t){const e=this.lexer.peekToken();if(!e||e.nodeType!==Tt.LBrace)return;const s={nodeType:Tt.Props,openBrace:e,properties:[],closeBrace:void 0,start:e.start};this.lexer.advance();try{let e=this.lexer.peekToken();for(;e?.nodeType===Tt.Ident;)s.properties.push(this.Re(e,t)),e=this.lexer.peekToken();const i=this.lexer.peekToken();i?.nodeType===Tt.RBrace?(s.closeBrace=i,this.lexer.advance()):this.addParserDiagnostic({code:Mt.AT206,message:"Unexpected end of file. Group not closed.",severity:xt.Error,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{s.end=this.lexer.previousTokenEndLocation()}return s}Re(t,e){const s={nodeType:Tt.Prop,property:t,arguments:void 0};this.lexer.advance(),s.start=s.property.start;try{s.arguments=this.argumentList(),s.arguments||(s.arguments=e(s),s.arguments&&s.arguments.arguments.length>1&&this.addParserDiagnostic({code:Mt.AT303,message:"Property args should be wrapped into parenthesis.",severity:xt.Warning,start:s.arguments.start,end:s.arguments.end}))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}argumentList(){const t=this.lexer.peekToken();if(t?.nodeType!==Tt.LParen)return;const e={nodeType:Tt.Arguments,openParenthesis:t,arguments:[],closeParenthesis:void 0,start:t.start};this.lexer.advance();try{let t=this.lexer.peekToken();for(;t&&t?.nodeType!==Tt.RParen;){switch(t.nodeType){case Tt.Ident:case Tt.String:e.arguments.push(t),this.lexer.advance();break;case Tt.Number:e.arguments.push(this.lexer.extendToFloat(t)),this.lexer.advance();break;default:this.unexpectedToken(t,[Tt.Ident,Tt.String,Tt.Number],!1),this.lexer.advance()}t=this.lexer.peekToken()}const s=this.lexer.peekToken();s?.nodeType===Tt.RParen?(e.closeParenthesis=s,this.lexer.advance()):this.addParserDiagnostic({code:Mt.AT206,message:"Unexpected end of file. Group not closed.",severity:xt.Error,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{e.end=this.lexer.previousTokenEndLocation()}return e}}class me{static ident(t){return{nodeType:Tt.Ident,text:t}}static string(t){return{nodeType:Tt.String,text:t}}static number(t){return{nodeType:Tt.Number,value:t}}static meta(t,e,s){return{nodeType:Tt.Meta,tag:{nodeType:Tt.Tag,prefix:{nodeType:Tt.Backslash},tag:{nodeType:Tt.Ident,text:t}},arguments:e,properties:s,propertiesBeforeArguments:!1}}static identMeta(t,e){return me.meta(t,me.identValue(e))}static numberMeta(t,e){return me.meta(t,me.numberValue(e))}static args(t,e=void 0){const s={nodeType:Tt.Arguments,arguments:t.filter(t=>void 0!==t)};if((void 0===e?s.arguments.length>1:e)&&(s.openParenthesis={nodeType:Tt.LParen},s.closeParenthesis={nodeType:Tt.RParen}),0!==s.arguments.length)return s}static stringValue(t){return me.args([me.string(t)])}static identValue(t){return me.args([me.ident(t)])}static numberValue(t){return me.args([me.number(t)])}static props(t){const e={nodeType:Tt.Props,properties:[],openBrace:{nodeType:Tt.LBrace},closeBrace:{nodeType:Tt.RBrace}};for(const s of t)s&&e.properties.push({nodeType:Tt.Prop,property:me.ident(s[0]),arguments:s[1]});return e}static prop(t,e,s){t.push({nodeType:Tt.Prop,property:me.ident(e),arguments:s})}}class ge{static instance=new ge;static Ie=new Set([Tt.LParen,Tt.String,Tt.Ident,Tt.Number]);hasMetaDataArguments(t){const e=t.tag.text.toLowerCase();for(const t of le.metaDataSignatures)if(t.has(e)){return null!==t.get(e)}return!0}readMetaDataArguments(t,e){const s=e.tag.text.toLowerCase();for(const e of le.metaDataSignatures)if(e.has(s)){const i=e.get(s);return i?this.Oe(t,i):void 0}t.addParserDiagnostic({code:Mt.AT204,message:`Unrecognized metadata '${e.tag.text}'.`,severity:xt.Error,start:e.start,end:e.end}),t.lexer.fatalError=!0}readMetaDataPropertyArguments(t,e,s){const i=e.tag.text.toLowerCase();if(!le.metaDataProperties.has(i))return;const n=le.metaDataProperties.get(i);return n?this.Ge(t,[n],s):this.Ge(t,[],s)}readBeatPropertyArguments(t,e){return this.Ge(t,[le.beatProperties],e)}readDurationChangePropertyArguments(t,e){return this.Ge(t,[le.durationChangeProperties],e)}readNotePropertyArguments(t,e){return this.Ge(t,[le.noteProperties,le.beatProperties],e)}Ge(t,e,s){const i=s.property.text.toLowerCase(),n=new Set([Tt.Ident,Tt.RBrace]);for(const s of e)if(s.has(i)){const e=s.get(i);return e?this.Oe(t,e,n):void this.Ve(t,[],n)}let r=t.lexer.peekToken();for(;r&&r.nodeType!==Tt.Ident&&r.nodeType!==Tt.RBrace;)t.lexer.advance(),r=t.lexer.peekToken();t.addParserDiagnostic({code:Mt.AT205,message:`Unrecognized property '${s.property.text}'.`,severity:xt.Error,start:s.property.start,end:r?.start??t.lexer.currentTokenLocation()})}Oe(t,e,s){if(1===e.length&&0===e[0].parameters.length)return;const i=[],n=t.lexer.peekToken()?.start,r=void 0!==s,a=new Map(e.map((t,e)=>[e,{signature:t,parameterIndex:0,parameterHasValues:!1,parameterValueMatches:0}])),h=this.$e(t,a,i,s),o=this.He(t,a,i,s,e,n);return r&&this.Ve(t,e,s),this.Ue(i,n,t.lexer.previousTokenEndLocation(),o,h)}He(t,e,s,i,n,r){const a=t.lexer.peekToken();let h=!1;return 1!==e.size&&void 0===a?(t.addParserDiagnostic({code:Mt.AT203,start:t.lexer.currentTokenLocation(),end:t.lexer.currentTokenLocation(),severity:xt.Error,message:"Unexpected end of file."}),h=!0):0===e.size&&(void 0!==a&&0===s.length&&i&&!i.has(a.nodeType)&&(s.push(t.lexer.peekToken()),t.lexer.advance()),t.addParserDiagnostic({code:Mt.AT219,message:`Error parsing arguments: no overload matched arguments ${ge.generateSignaturesFromArguments(s)}. Signatures:\n${ge.generateSignatures(n)}`,severity:xt.Error,start:r,end:t.lexer.previousTokenEndLocation()}),h=!0),h}Ue(t,e,s,i,n){if(0===t.length)return;const r=me.args(t,!1);return r.start=e,r.end=s,r.validated=!i,n&&(n.length>1&&ge.sortCandidates(n),r.signatureCandidateIndices=n.map(t=>t[0])),r}$e(t,e,s,i){const n=t.mode===Et.Full,r=(i,r)=>{const a=e.get(r);if(i.nodeType===Tt.LParen){const e=t.argumentList();if(e)for(const t of e.arguments)n&&(t.parameterIndices||(t.parameterIndices=new Map),t.parameterIndices.set(r,a.parameterIndex)),s.push(t)}else{const e=i;n&&(e.parameterIndices||(e.parameterIndices=new Map),e.parameterIndices.set(r,a.parameterIndex)),0!==s.length&&s[s.length-1]===e||(s.push(e),t.lexer.advance())}},a=e=>{t.lexer.extendToFloat(e)},h=ge.Ie;for(;e.size>1||e.size>0&&!ge.ze(e);){const s=t.lexer.peekToken();if(!s||!h.has(s.nodeType))break;if(!ge.filterSignatureCandidates(e,s,void 0!==i&&i.has(s.nodeType),r,a))break}const o=t.mode===Et.Full?Array.from(e.entries()):void 0;return ge.filterIncompleteCandidates(e),o}static sortCandidates(t){t.length<2||t.sort((t,e)=>{const s=Math.abs(t[1].parameterIndex-t[1].signature.parameters.length),i=Math.abs(e[1].parameterIndex-e[1].signature.parameters.length);if(s===i){const s=t[1].parameterValueMatches;return e[1].parameterValueMatches-s}return s-i})}Ve(t,e,s){const i=t.lexer.currentTokenLocation();let n=t.lexer.peekToken(),r=!1;const a=ge.Ie;for(;n&&!s.has(n.nodeType);)a.has(n.nodeType)?(t.lexer.advance(),r=!0,n=t.lexer.peekToken()):n=void 0;r&&t.addParserDiagnostic({code:Mt.AT220,message:`Error parsing arguments: unexpected additional arguments. Signatures:\n${ge.generateSignatures(e)}`,severity:xt.Error,start:i,end:t.lexer.previousTokenEndLocation()})}static ze(t){for(const e of t.values())if(e.parameterIndex===e.signature.parameters.length)return!0;return!1}static filterIncompleteCandidates(t){const e=new Set;for(const[s,i]of t)for(let t=i.parameterIndex;t<i.signature.parameters.length;t++){switch(i.signature.parameters[t].parseMode){case Ct.Required:case Ct.RequiredAsFloat:e.add(s)}}for(const s of e)t.delete(s)}static generateSignaturesFromArguments(t){return t?`(${t.map(t=>Tt[t.nodeType]).join(", ")})`:"()"}static generateSignatures(t,e){return 0===t.length?"()":t.map((t,s)=>ge.Xe(t,void 0!==e&&e.size>1&&e.has(s))).join("\n")}static Xe(t,e){const s=e?" ~":"";return`(${t.parameters.map(ge.je).join(", ")})${s}`}static je(t,e){const s=Array.from(t.expectedTypes);let i=`v${e}`;switch(t.parseMode){case Ct.Optional:case Ct.OptionalAsFloat:i+="?"}if(t.allowedValues&&t.allowedValues.size<5){const e=Array.from(t.allowedValues);if(s[0]===Tt.String)i=e.map(t=>`"${t}"`).join("|");else i=e.join("|")}else i=Array.from(t.expectedTypes).map(t=>Tt[t]).join("|");switch(t.parseMode){case Ct.RequiredAsValueList:case Ct.ValueListWithoutParenthesis:i+="[]"}return i}static filterSignatureCandidates(t,e,s,i,n){const r=new Set;let a=!1;for(const[h,o]of t){let t=!1;for(;!t;){const c=o.parameterIndex<o.signature.parameters.length?o.signature.parameters[o.parameterIndex]:void 0;if(c)if(o.signature.isStrict&&o.parameterIndex>0)r.add(h),t=!0;else if((c.expectedTypes.has(e.nodeType)||ge.Je(e,c))&&ge.qe(e,c,n))switch(t=!0,a=!0,i(e,h),c.allowedValues&&o.parameterValueMatches++,c.parseMode){case Ct.ValueListWithoutParenthesis:o.parameterHasValues=!0;break;case Ct.RequiredAsValueList:default:o.parameterIndex++,o.parameterHasValues=!1}else switch(c.parseMode){case Ct.ValueListWithoutParenthesis:o.parameterIndex++,o.parameterHasValues=!1;break;case Ct.Required:case Ct.RequiredAsFloat:r.add(h),t=!0;break;case Ct.Optional:case Ct.OptionalAsFloat:case Ct.RequiredAsValueList:o.parameterIndex++,o.parameterHasValues=!1}else s||r.add(h),t=!0}}if(a)for(const e of r)t.delete(e);return a}static qe(t,e,s){switch(t.nodeType){case Tt.Ident:const i=t;return e?.allowedValues?e.allowedValues.has(i.text.toLowerCase()):!e?.reservedIdentifiers||!e.reservedIdentifiers.has(i.text.toLowerCase());case Tt.String:const n=t;return!e?.allowedValues||e.allowedValues.has(n.text.toLowerCase());case Tt.Number:switch(e?.parseMode??Ct.Optional){case Ct.RequiredAsFloat:case Ct.OptionalAsFloat:return s?.(t),!0;default:return!0}case Tt.LParen:return!0}return!1}static Je(t,e){return t.nodeType===Tt.LParen&&(e.expectedTypes.has(Tt.Arguments)||e.parseMode===Ct.ValueListWithoutParenthesis||e.parseMode===Ct.RequiredAsValueList)}}!function(t){t[t.Applied=0]="Applied",t[t.NotAppliedSemanticError=1]="NotAppliedSemanticError",t[t.NotAppliedUnrecognizedMarker=2]="NotAppliedUnrecognizedMarker"}(Ft||(Ft={})),function(t){t[t.AppliedNewTrack=0]="AppliedNewTrack",t[t.AppliedNewStaff=1]="AppliedNewStaff",t[t.AppliedNewVoice=2]="AppliedNewVoice",t[t.NotAppliedSemanticError=3]="NotAppliedSemanticError",t[t.NotAppliedUnrecognizedMarker=4]="NotAppliedUnrecognizedMarker"}(At||(At={}));class we{static Ye=new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]);static getValue(t){return we.Ye||(we.Ye=new Map),t=t.toLowerCase().replaceAll(" ",""),we.Ye.has(t)?we.Ye.get(t):0}static getName(t){for(const[e,s]of we.Ye)if(s===t)return e;return t.toString()}static isPiano(t){return t<=7||t>=16&&t<=23}static isGuitar(t){return t>=24&&t<=39||105===t||43===t}static isBass(t){return t>=32&&t<=39}static bankToLsbMsb(t){return[127&t,t>>7&127]}}class ye{name="";firstFret=1;strings=[];barreFrets=[];staff;showName=!0;showDiagram=!0;showFingering=!0;get uniqueId(){return[this.name,this.firstFret.toString(),this.strings.join(","),this.barreFrets.join(","),this.showDiagram.toString(),this.showFingering.toString(),this.showName.toString()].join("|")}}class ke extends G{constructor(e){super(t.AlphaTabErrorType.Format,e)}}class Se{static BlackRgb="#000000";constructor(t,e,s,i=255){this.raw=(255&i)<<24|(255&t)<<16|(255&e)<<8|255&s,this.updateRgba()}updateRgba(){255===this.a?this.rgba=`#${Xt.toHexString(this.r,2)}${Xt.toHexString(this.g,2)}${Xt.toHexString(this.b,2)}`:this.rgba=`rgba(${this.r},${this.g},${this.b},${this.a/255})`}raw=0;get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return 255&this.raw}rgba;static random(t=100){return new Se(255*Math.random()|0,255*Math.random()|0,255*Math.random()|0,t)}static fromJson(t){if(t instanceof Se)return t;switch(typeof t){case"number":{const e=new Se(0,0,0,0);return e.raw=t,e.updateRgba(),e}case"string":{const e=t;if(e.startsWith("#")){if(4===e.length)return new Se(17*Number.parseInt(e[1],16),17*Number.parseInt(e[2],16),17*Number.parseInt(e[3],16));if(5===e.length)return new Se(17*Number.parseInt(e[1],16),17*Number.parseInt(e[2],16),17*Number.parseInt(e[3],16),17*Number.parseInt(e[4],16));if(7===e.length)return new Se(Number.parseInt(e.substring(1,3),16),Number.parseInt(e.substring(3,5),16),Number.parseInt(e.substring(5,7),16));if(9===e.length)return new Se(Number.parseInt(e.substring(1,3),16),Number.parseInt(e.substring(3,5),16),Number.parseInt(e.substring(5,7),16),Number.parseInt(e.substring(7,9),16))}else if(e.startsWith("rgba")||e.startsWith("rgb")){const t=e.indexOf("("),s=e.lastIndexOf(")");if(-1===t||-1===s)throw new ke("No values specified for rgb/rgba function");const i=e.substring(t+1,s).split(",");if(3===i.length)return new Se(Number.parseInt(i[0],10),Number.parseInt(i[1],10),Number.parseInt(i[2],10));if(4===i.length)return new Se(Number.parseInt(i[0],10),Number.parseInt(i[1],10),Number.parseInt(i[2],10),255*Number.parseFloat(i[3]))}return null}}throw new ke("Unsupported format for color")}static toJson(t){return null===t?null:t.raw}}!function(t){t[t.Short=0]="Short",t[t.Medium=1]="Medium",t[t.Long=2]="Long"}(Dt||(Dt={}));class Be{type=Dt.Short;length=0}!function(t){t[t.IgnoreSpaces=0]="IgnoreSpaces",t[t.Begin=1]="Begin",t[t.Text=2]="Text",t[t.Comment=3]="Comment",t[t.Dash=4]="Dash"}(Lt||(Lt={}));class _e{static Ke=10;static Qe=9;static Ze=13;static ts=32;static es=93;static ss=91;static ns=45;startBar=0;text="";chunks;finish(t=!1){this.chunks=[],this.rs(this.text,0,this.chunks,t)}rs(t,e,s,i){if(!t)return;let n=Lt.Begin,r=Lt.Begin,a=!1,h=0;for(;e<t.length;){const s=t.charCodeAt(e);switch(n){case Lt.IgnoreSpaces:switch(s){case _e.Ke:case _e.Ze:case _e.Qe:break;case _e.ts:if(!a){n=r;continue}break;default:a=!1,n=r;continue}break;case Lt.Begin:if(s!==_e.ss){h=e,n=Lt.Text;continue}n=Lt.Comment;break;case Lt.Comment:if(s===_e.es)n=Lt.Begin;break;case Lt.Text:switch(s){case _e.ns:n=Lt.Dash;break;case _e.Ze:case _e.Ke:case _e.ts:const s=t.substr(h,e-h);this.hs(s,i),n=Lt.IgnoreSpaces,r=Lt.Begin}break;case Lt.Dash:if(s!==_e.ns){const s=t.substr(h,e-h);this.hs(s,i),a=!0,n=Lt.IgnoreSpaces,r=Lt.Begin;continue}}e+=1}n===Lt.Text&&e!==h&&this.hs(t.substr(h,e-h),i)}hs(t,e){t=this.cs(t),(!e||t.length>0&&"-"!==t)&&this.chunks.push(t)}cs(t){const e=t.split("+").join(" ");let s=e.length;for(;s>0&&"_"===e.charAt(s-1);)s--;return s!==e.length?e.substr(0,s):e}}class Te{marker="";text=""}class xe{static ls=[];static us=[];static ds=[];static fs=[];static ps=new Map;static noteNames=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];static getTextForTuning(t,e){const s=xe.getTextPartsForTuning(t);return e?s.join(""):s[0]}static getTextPartsForTuning(t,e=-1){const s=t/12|0,i=t%12;return[xe.noteNames[i],(s+e).toString()]}static getDefaultTuningFor(t){if(xe.ps.has(t)){const e=xe.ps.get(t);return new xe(e.name,e.tunings,e.isStandard)}return null}static getPresetsFor(t){switch(t){case 7:return xe.ls;case 6:return xe.us;case 5:return xe.ds;case 4:return xe.fs}return[]}static initialize(){xe.ps.set(7,new xe("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),xe.ls.push(xe.ps.get(7)),xe.ps.set(6,new xe("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),xe.us.push(xe.ps.get(6)),xe.us.push(new xe("Guitar Tune down ½ step",[63,58,54,49,44,39],!1)),xe.us.push(new xe("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),xe.us.push(new xe("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),xe.us.push(new xe("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),xe.us.push(new xe("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),xe.us.push(new xe("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),xe.us.push(new xe("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),xe.us.push(new xe("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),xe.us.push(new xe("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),xe.us.push(new xe("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),xe.us.push(new xe("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),xe.us.push(new xe("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),xe.us.push(new xe("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),xe.us.push(new xe("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),xe.us.push(new xe("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),xe.us.push(new xe("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),xe.us.push(new xe("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),xe.us.push(new xe("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),xe.us.push(new xe("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),xe.us.push(new xe("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),xe.us.push(new xe("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),xe.us.push(new xe("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),xe.us.push(new xe("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),xe.us.push(new xe("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),xe.us.push(new xe("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),xe.us.push(new xe("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),xe.us.push(new xe("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),xe.us.push(new xe("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),xe.us.push(new xe("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),xe.us.push(new xe("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),xe.ps.set(5,new xe("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),xe.ds.push(xe.ps.get(5)),xe.ds.push(new xe("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),xe.ds.push(new xe("Banjo Open D Tuning",[62,57,54,50,69],!1)),xe.ds.push(new xe("Banjo Open G Tuning",[62,59,55,50,67],!1)),xe.ds.push(new xe("Banjo G Minor Tuning",[62,58,55,50,67],!1)),xe.ds.push(new xe("Banjo G Modal Tuning",[62,57,55,50,67],!1)),xe.ps.set(4,new xe("Bass Standard Tuning",[43,38,33,28],!0)),xe.fs.push(xe.ps.get(4)),xe.fs.push(new xe("Bass Tune down ½ step",[42,37,32,27],!1)),xe.fs.push(new xe("Bass Tune down 1 step",[41,36,31,26],!1)),xe.fs.push(new xe("Bass Tune down 2 step",[39,34,29,24],!1)),xe.fs.push(new xe("Bass Dropped D Tuning",[43,38,33,26],!1)),xe.fs.push(new xe("Ukulele C Tuning",[45,40,36,43],!1)),xe.fs.push(new xe("Ukulele G Tuning",[52,47,43,38],!1)),xe.fs.push(new xe("Mandolin Standard Tuning",[64,57,50,43],!1)),xe.fs.push(new xe("Mandolin or Violin Tuning",[76,69,62,55],!1)),xe.fs.push(new xe("Viola Tuning",[69,62,55,48],!1)),xe.fs.push(new xe("Cello Tuning",[57,50,43,36],!1))}static findTuning(t){const e=xe.getPresetsFor(t.length);for(let s=0,i=e.length;s<i;s++){const i=e[s];let n=!0;for(let e=0,s=t.length;e<s;e++)if(t[e]!==i.tunings[e]){n=!1;break}if(n)return new xe(i.name,i.tunings,i.isStandard)}return null}isStandard;name;tunings;constructor(t="",e=null,s=!1){this.isStandard=s,this.name=t,this.tunings=e??[]}reset(){this.isStandard=!1,this.name="",this.tunings=[]}finish(){const t=xe.findTuning(this.tunings);t&&(0===this.name.length&&(this.name=t.name),this.isStandard=t.isStandard)}}xe.initialize();class Me{static DefaultStandardNotationLineCount=5;index=0;track;bars=[];chords=null;capo=0;transpositionPitch=0;displayTranspositionPitch=0;stringTuning=new xe("",[],!1);get tuning(){return this.stringTuning.tunings}get tuningName(){return this.stringTuning.name}get isStringed(){return this.stringTuning.tunings.length>0}showSlash=!1;showNumbered=!1;showTablature=!0;showStandardNotation=!0;isPercussion=!1;standardNotationLineCount=Me.DefaultStandardNotationLineCount;O=new Set([0]);get filledVoices(){return this.O}finish(t,e=null){this.isPercussion&&(this.stringTuning.tunings=[],this.showTablature=!1,this.displayTranspositionPitch=0),this.stringTuning.finish(),0===this.stringTuning.tunings.length&&(this.showTablature=!1);for(let s=0,i=this.bars.length;s<i;s++){this.bars[s].finish(t,e);for(const t of this.bars[s].filledVoices)this.O.add(t)}}addChord(t,e){e.staff=this;let s=this.chords;null===s&&(s=new Map,this.chords=s),s.set(t,e)}hasChord(t){return this.chords?.has(t)??!1}getChord(t){return this.chords?.get(t)??null}addBar(t){const e=this.bars;t.staff=this,t.index=e.length,e.length>0&&(t.previousBar=e[e.length-1],t.previousBar.nextBar=t),e.push(t)}}class ve{volume=15;balance=8;port=1;program=0;bank=0;primaryChannel=0;secondaryChannel=0;isMute=!1;isSolo=!1}!function(t){t[t.TrackName=0]="TrackName",t[t.BracesAndBrackets=1]="BracesAndBrackets",t[t.SystemSeparator=2]="SystemSeparator",t[t.StringTuning=3]="StringTuning"}(Wt||(Wt={}));class Ne extends Y{}class Pe{static bs=10;index=0;score;staves=[];playbackInfo=new ve;color=new Se(200,0,0,255);name="";isVisibleOnMultiTrack=!0;shortName="";defaultSystemsLayout=3;systemsLayout=[];lineBreaks;get isPercussion(){return this.staves.some(t=>t.isPercussion)}addLineBreaks(t){this.lineBreaks||(this.lineBreaks=new Set),this.lineBreaks.add(t)}percussionArticulations=[];style;ensureStaveCount(t){for(;this.staves.length<t;)this.addStaff(new Me)}addStaff(t){t.index=this.staves.length,t.track=this,this.staves.push(t)}finish(t,e=null){this.shortName||(this.shortName=this.name,this.shortName.length>Pe.bs&&(this.shortName=this.shortName.substr(0,Pe.bs)));for(const s of this.staves)s.finish(t,e),s.isPercussion&&(this.playbackInfo.program=0)}applyLyrics(t){for(const e of t)e.finish();const e=this.staves[0];for(let s=0;s<t.length;s++){const i=t[s];if(i.startBar>=0&&i.startBar<e.bars.length){let n=e.bars[i.startBar].voices[0].beats[0];for(let e=0;e<i.chunks.length&&n;e++){for(;n&&(n.isEmpty||n.isRest);)n=n.nextBeat;n&&(n.lyrics||(n.lyrics=new Array(t.length),n.lyrics.fill("")),n.lyrics[s]=i.chunks[e],n=n.nextBeat)}}}}}!function(t){t[t.Up=0]="Up",t[t.Down=1]="Down"}(Rt||(Rt={}));class Ce{static instance=new Ce;static gs=new Set([1,2,4,8,16,32,64,128]);applyScoreMetaData(t,e,s){const i=this.ws(t,[le.scoreMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(void 0!==i)return i;switch(s.tag.tag.text.toLowerCase()){case"title":return e.title=s.arguments.arguments[0].text,this.ys(t,e,ct.Title,s),Ft.Applied;case"subtitle":return e.subTitle=s.arguments.arguments[0].text,this.ys(t,e,ct.SubTitle,s),Ft.Applied;case"artist":return e.artist=s.arguments.arguments[0].text,this.ys(t,e,ct.Artist,s),Ft.Applied;case"album":return e.album=s.arguments.arguments[0].text,this.ys(t,e,ct.Album,s),Ft.Applied;case"words":return e.words=s.arguments.arguments[0].text,this.ys(t,e,ct.Words,s),Ft.Applied;case"music":return e.music=s.arguments.arguments[0].text,this.ys(t,e,ct.Music,s),Ft.Applied;case"copyright":return e.copyright=s.arguments.arguments[0].text,this.ys(t,e,ct.Copyright,s),Ft.Applied;case"instructions":return e.instructions=s.arguments.arguments[0].text,Ft.Applied;case"notices":return e.notices=s.arguments.arguments[0].text,Ft.Applied;case"tab":return e.tab=s.arguments.arguments[0].text,this.ys(t,e,ct.Transcriber,s),Ft.Applied;case"copyright2":return this.ys(t,e,ct.CopyrightSecondLine,s,0),Ft.Applied;case"wordsandmusic":return this.ys(t,e,ct.WordsAndMusic,s,0),Ft.Applied;case"defaultsystemslayout":return e.defaultSystemsLayout=s.arguments.arguments[0].value,Ft.Applied;case"systemslayout":for(const t of s.arguments.arguments)e.systemsLayout.push(t.value);return Ft.Applied;case"hidedynamics":return e.stylesheet.hideDynamics=!0,Ft.Applied;case"showdynamics":return e.stylesheet.hideDynamics=!1,Ft.Applied;case"extendbarlines":return e.stylesheet.extendBarLines=!0,Ft.Applied;case"bracketextendmode":const i=Ce.ks(t,s.arguments,"bracket extend mode",ce.bracketExtendMode);return void 0===i?Ft.NotAppliedSemanticError:(e.stylesheet.bracketExtendMode=i,Ft.Applied);case"usesystemsignseparator":return e.stylesheet.useSystemSignSeparator=!0,Ft.Applied;case"multibarrest":return e.stylesheet.multiTrackMultiBarRest=!0,Ft.Applied;case"singletracktracknamepolicy":const n=Ce.ks(t,s.arguments,"track name policy",ce.trackNamePolicy);return void 0===n?Ft.NotAppliedSemanticError:(e.stylesheet.singleTrackTrackNamePolicy=n,Ft.Applied);case"multitracktracknamepolicy":const r=Ce.ks(t,s.arguments,"track name policy",ce.trackNamePolicy);return void 0===r?Ft.NotAppliedSemanticError:(e.stylesheet.multiTrackTrackNamePolicy=r,Ft.Applied);case"firstsystemtracknamemode":const a=Ce.ks(t,s.arguments,"track name mode",ce.trackNameMode);return void 0===a?Ft.NotAppliedSemanticError:(e.stylesheet.firstSystemTrackNameMode=a,Ft.Applied);case"othersystemstracknamemode":const h=Ce.ks(t,s.arguments,"track name mode",ce.trackNameMode);return void 0===h?Ft.NotAppliedSemanticError:(e.stylesheet.otherSystemsTrackNameMode=h,Ft.Applied);case"firstsystemtracknameorientation":const o=Ce.ks(t,s.arguments,"track name orientation",ce.trackNameOrientation);return void 0===o?Ft.NotAppliedSemanticError:(e.stylesheet.firstSystemTrackNameOrientation=o,Ft.Applied);case"othersystemstracknameorientation":const c=Ce.ks(t,s.arguments,"track name orientation",ce.trackNameOrientation);return void 0===c?Ft.NotAppliedSemanticError:(e.stylesheet.otherSystemsTrackNameOrientation=c,Ft.Applied);case"chorddiagramsinscore":return e.stylesheet.globalDisplayChordDiagramsInScore=!s.arguments||Ce.Ss(s.arguments.arguments,0),Ft.Applied;case"hideemptystaves":return e.stylesheet.hideEmptyStaves=!0,Ft.Applied;case"hideemptystavesinfirstsystem":return e.stylesheet.hideEmptyStavesInFirstSystem=!0,Ft.Applied;case"showsinglestaffbrackets":return e.stylesheet.showSingleStaffBrackets=!0,Ft.Applied;case"defaultbarnumberdisplay":const l=Ce.ks(t,s.arguments,"bar number display",ce.barNumberDisplay);return void 0===l?Ft.NotAppliedSemanticError:(e.stylesheet.barNumberDisplay=l,Ft.Applied);default:return Ft.NotAppliedUnrecognizedMarker}}ws(t,e,s,i,n){const r=e.find(t=>t.has(i));if(!r)return Ft.NotAppliedUnrecognizedMarker;const a=r.get(i);if(a)return this.Bs(t,a,s,n)?void 0:Ft.NotAppliedSemanticError;n&&n.arguments.length>0&&t.addSemanticDiagnostic({code:Mt.AT300,message:"Expected no arguments, but found some.",start:n.start,end:n.end,severity:xt.Warning})}applyStaffMetaData(t,e,s){const i=this.ws(t,[le.staffMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(void 0!==i)return i;switch(s.tag.tag.text.toLowerCase()){case"capo":return e.capo=s.arguments.arguments[0].value,Ft.Applied;case"tuning":const i=[];let n=!1,r="";for(let a=0;a<s.arguments.arguments.length;a++){const h=s.arguments.arguments[a],o=h.text;switch(o){case"piano":case"none":case"voice":t.applyStaffNoteKind(e,Pt.Pitched),a=s.arguments.arguments.length;break;case"hide":n=!0,t.addSemanticDiagnostic({code:Mt.AT305,message:"This value should be rather specified via the properties.",start:h.start,end:h.end,severity:xt.Warning});break;default:const c=Xt.parseTuning(o);if(c)i.push(c.realValue);else if(a===s.arguments.arguments.length-1&&i.length>0)r=o,t.addSemanticDiagnostic({code:Mt.AT305,message:"This value should be rather specified via the properties.",start:h.start,end:h.end,severity:xt.Warning});else{const e=Array.from(Xt.tuningLetters).join(","),s=Array.from(Xt.accidentalModeMapping.keys()).join(",");t.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected tuning value '${o}', expected: <note><accidental><octave> where <note>=oneOf(${e}) <accidental>=oneOf(${s}), <octave>=number`,start:h.start,end:h.end,severity:xt.Error})}}}return t.state.staffHasExplicitTuning.add(e),t.state.staffTuningApplied.delete(e),e.stringTuning=new xe,e.stringTuning.tunings=i,e.stringTuning.name=r,this._s(t,e,e.stringTuning,s),n&&(e.track.score.stylesheet.perTrackDisplayTuning||(e.track.score.stylesheet.perTrackDisplayTuning=new Map),e.track.score.stylesheet.perTrackDisplayTuning.set(e.track.index,!1)),Ft.Applied;case"instrument":return t.state.staffTuningApplied.delete(e),this.Ts(t,e.track,s.arguments),Ft.Applied;case"bank":return e.track.playbackInfo.bank=s.arguments.arguments[0].value,Ft.Applied;case"lyrics":const a=new _e;return a.startBar=0,a.text="",2===s.arguments.arguments.length?(a.startBar=s.arguments.arguments[0].value,a.text=s.arguments.arguments[1].text):a.text=s.arguments.arguments[0].text,t.state.lyrics.get(e.track.index).push(a),Ft.Applied;case"chord":const h=new ye;this.xs(t,h,s),h.name=s.arguments.arguments[0].text;for(let e=1;e<s.arguments.arguments.length;e++){const i=s.arguments.arguments[e];if(i.nodeType===Tt.Number)h.strings.push(i.value);else if(i.nodeType===Tt.Ident){const e=i.text;"x"===e?h.strings.push(-1):t.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected chord value '${e}', expected: 'x'`,severity:xt.Error,start:i.start,end:i.end})}}return e.addChord(Ce.Ms(e,h.name),h),Ft.Applied;case"articulation":const o=t.state.percussionArticulationNames,c=s.arguments.arguments[0].text;if("defaults"===c){for(const[t,e]of qt.instrumentArticulationNames)o.set(t.toLowerCase(),e),o.set(Xt.toArticulationId(t),e);return Ft.Applied}if(2===s.arguments.arguments.length){const e=s.arguments.arguments[1].value,i=qt.getArticulationById(e);if(i)return o.set(c.toLowerCase(),i.uniqueId),Ft.Applied;{const i=Array.from(qt.instrumentArticulationIds()).map(t=>`${t}`).join(",");return t.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected articulation value '${e}', expected: ${i}`,start:s.arguments.arguments[1].start,end:s.arguments.arguments[1].end,severity:xt.Error}),Ft.NotAppliedSemanticError}}return Ft.Applied;case"accidentals":return Ce.vs(t,s.arguments);case"displaytranspose":return e.displayTranspositionPitch=-1*s.arguments.arguments[0].value,t.state.staffHasExplicitDisplayTransposition.add(e),Ft.Applied;case"transpose":return e.transpositionPitch=-1*s.arguments.arguments[0].value,Ft.Applied;default:return Ft.NotAppliedUnrecognizedMarker}}applyBarMetaData(t,e,s){const i=this.ws(t,[le.barMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(void 0!==i)return i;switch(s.tag.tag.text.toLowerCase()){case"sync":const i=this.Ns(s);return t.state.syncPoints.push(i),Ft.Applied;case"tempo":let n=0;const a=s.arguments.arguments[n++].value;let h="",o=!0,c=0;for(;n<s.arguments.arguments.length;){switch(s.arguments.arguments[n].nodeType){case Tt.Ident:case Tt.String:const t=s.arguments.arguments[n].text;"hide"===t?o=!1:h=t;break;case Tt.Number:c=s.arguments.arguments[n].value}n++}let l=e.masterBar.tempoAutomations.find(t=>t.ratioPosition===c);return l||(l=new U,e.masterBar.tempoAutomations.push(l)),l.isLinear=!1,l.type=r.Tempo,l.value=a,l.text=h,l.ratioPosition=c,l.isVisible=o,Ft.Applied;case"rc":return e.masterBar.repeatCount=s.arguments.arguments[0].value,Ft.Applied;case"ae":for(const i of s.arguments.arguments)if(i.nodeType===Tt.Number){const s=i.value;if(s<1||s>31)return t.addSemanticDiagnostic({code:Mt.AT211,message:"Value is out of valid range. Allowed range: %s, Actual Value: %s",severity:xt.Error,start:i.start,end:i.end}),Ft.NotAppliedSemanticError;e.masterBar.alternateEndings|=1<<s-1}else t.addSemanticDiagnostic({code:Mt.AT202,message:`Unexpected '${Tt[i.nodeType]}' token. Expected one of following: ${Tt[Tt.Number]}`,severity:xt.Error,start:i.start,end:i.end});return Ft.Applied;case"ts":switch(s.arguments.arguments[0].nodeType){case Tt.Number:if(e.masterBar.timeSignatureNumerator=0|s.arguments.arguments[0].value,(e.masterBar.timeSignatureNumerator<1||e.masterBar.timeSignatureNumerator>32)&&t.addSemanticDiagnostic({code:Mt.AT211,message:`Value is out of valid range. Allowed range: 1-32, Actual Value: ${e.masterBar.timeSignatureNumerator}`,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end,severity:xt.Error}),e.masterBar.timeSignatureDenominator=0|s.arguments.arguments[1].value,!Ce.gs.has(e.masterBar.timeSignatureDenominator)){const i=Array.from(Ce.gs).join(", ");t.addSemanticDiagnostic({code:Mt.AT211,message:`Value is out of valid range. Allowed range: ${i}, Actual Value: ${e.masterBar.timeSignatureDenominator}`,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end,severity:xt.Error})}break;case Tt.Ident:case Tt.String:const i=s.arguments.arguments[0].text;if("common"!==i.toLowerCase())return t.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected time signature value '${i}', expected: common or two numbers`,severity:xt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Ft.NotAppliedSemanticError;e.masterBar.timeSignatureCommon=!0,e.masterBar.timeSignatureNumerator=4,e.masterBar.timeSignatureDenominator=4}return Ft.Applied;case"beaming":return this.Ps(t,s,e.masterBar);case"ks":const u=Ce.ks(t,s.arguments,"key signature",ce.keySignature);if(void 0===u)return Ft.NotAppliedSemanticError;const d=Ce.ks(t,s.arguments,"key signature type",ce.keySignatureType);return void 0===d?Ft.NotAppliedSemanticError:(e.keySignature=u,e.keySignatureType=d,Ft.Applied);case"clef":switch(s.arguments.arguments[0].nodeType){case Tt.Ident:case Tt.String:const i=Ce.ks(t,s.arguments,"clef",ce.clef);if(void 0===i)return Ft.NotAppliedSemanticError;e.clef=i;break;case Tt.Number:const n=s.arguments.arguments[0].value;switch(n){case 0:e.clef=M.Neutral;break;case 43:e.clef=M.G2;break;case 65:e.clef=M.F4;break;case 48:e.clef=M.C3;break;case 60:e.clef=M.C4;break;default:return t.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected clef value '${n}', expected: ${Array.from(ce.clef.keys()).join(",")}`,severity:xt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Ft.NotAppliedSemanticError}}return Ft.Applied;case"section":const f=new Te;return 1===s.arguments.arguments.length?f.text=s.arguments.arguments[0].text:(f.marker=s.arguments.arguments[0].text,f.text=s.arguments.arguments[1].text),e.masterBar.section=f,Ft.Applied;case"tf":switch(s.arguments.arguments[0].nodeType){case Tt.Ident:case Tt.String:const i=Ce.ks(t,s.arguments,"triplet feel",ce.tripletFeel);if(void 0===i)return Ft.NotAppliedSemanticError;e.masterBar.tripletFeel=i;break;case Tt.Number:const n=s.arguments.arguments[0].value;switch(n){case 0:e.masterBar.tripletFeel=A.NoTripletFeel;break;case 1:e.masterBar.tripletFeel=A.Triplet16th;break;case 2:e.masterBar.tripletFeel=A.Triplet8th;break;case 3:e.masterBar.tripletFeel=A.Dotted16th;break;case 4:e.masterBar.tripletFeel=A.Dotted8th;break;case 5:e.masterBar.tripletFeel=A.Scottish16th;break;case 6:e.masterBar.tripletFeel=A.Scottish8th;break;default:return t.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected triplet feel value '${n}', expected: ${Array.from(ce.tripletFeel.keys()).join(",")}`,severity:xt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Ft.NotAppliedSemanticError}}return Ft.Applied;case"barlineleft":const p=Ce.ks(t,s.arguments,"bar line",ce.barLineStyle);return void 0===p?Ft.NotAppliedSemanticError:(e.barLineLeft=p,Ft.Applied);case"barlineright":const b=Ce.ks(t,s.arguments,"bar line",ce.barLineStyle);return void 0===b?Ft.NotAppliedSemanticError:(e.barLineRight=b,Ft.Applied);case"accidentals":return Ce.vs(t,s.arguments);case"voicemode":return Ce.Cs(t,s.arguments);case"jump":const m=Ce.ks(t,s.arguments,"direction",ce.direction);return void 0===m?Ft.NotAppliedSemanticError:(e.masterBar.addDirection(m),Ft.Applied);case"ottava":const g=Ce.ks(t,s.arguments,"clef ottava",ce.ottavia);return void 0===g?Ft.NotAppliedSemanticError:(e.clefOttava=g,Ft.Applied);case"simile":const w=Ce.ks(t,s.arguments,"simile mark",ce.simileMark);return void 0===w?Ft.NotAppliedSemanticError:(e.simileMark=w,Ft.Applied);case"width":return e.masterBar.displayWidth=s.arguments.arguments[0].value,e.displayWidth=e.masterBar.displayWidth,Ft.Applied;case"scale":return e.masterBar.displayScale=s.arguments.arguments[0].value,e.displayScale=e.masterBar.displayScale,Ft.Applied;case"spd":const y=new K;return y.pedalType=C.Down,y.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(y),Ft.Applied;case"spu":const k=new K;return k.pedalType=C.Up,k.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(k),Ft.Applied;case"sph":const S=new K;return S.pedalType=C.Hold,S.ratioPosition=s.arguments.arguments[0].value,e.sustainPedals.push(S),Ft.Applied;case"ft":return e.masterBar.isFreeTime=!0,Ft.Applied;case"ro":return e.masterBar.isRepeatStart=!0,Ft.Applied;case"ac":return e.masterBar.isAnacrusis=!0,Ft.Applied;case"db":return e.masterBar.isDoubleBar=!0,e.barLineRight=F.LightLight,Ft.Applied;case"barnumberdisplay":const B=Ce.ks(t,s.arguments,"bar number display",ce.barNumberDisplay);return void 0===B?Ft.NotAppliedSemanticError:(e.barNumberDisplay=B,Ft.Applied);default:return Ft.NotAppliedUnrecognizedMarker}}Ps(t,e,s){let i=l.Eighth;const n=[],r=e.arguments.arguments[0].value;switch(r){case 4:i=l.QuadrupleWhole;break;case 8:i=l.Eighth;break;case 16:i=l.Sixteenth;break;case 32:i=l.ThirtySecond;break;default:return t.addSemanticDiagnostic({code:Mt.AT209,message:`Value is out of valid range. Allowed range: 4,8,16 or 32, Actual Value: ${r}`,severity:xt.Error,start:e.arguments.arguments[0].start,end:e.arguments.arguments[0].end}),Ft.NotAppliedSemanticError}for(let s=1;s<e.arguments.arguments.length;s++){if(e.arguments.arguments[s].value<1)return t.addSemanticDiagnostic({code:Mt.AT209,message:`Value is out of valid range. Allowed range: >0, Actual Value: ${r}`,severity:xt.Error,start:e.arguments.arguments[s].start,end:e.arguments.arguments[s].end}),Ft.NotAppliedSemanticError;n.push(e.arguments.arguments[s].value)}return s.beamingRules||(s.beamingRules=new tt),s.beamingRules.groups.set(i,n),Ft.Applied}static vs(t,e){const s=Ce.ks(t,e,"accidental mode",ce.alphaTexAccidentalMode);return void 0===s?Ft.NotAppliedSemanticError:(t.state.accidentalMode=s,Ft.Applied)}static Cs(t,e){const s=Ce.ks(t,e,"voice mode",ce.alphaTexVoiceMode);return void 0===s?Ft.NotAppliedSemanticError:(t.state.voiceMode=s,Ft.Applied)}static Ms(t,e){return e.toLowerCase()+t.index+t.track.index}Ns(t){const e=t.arguments.arguments[0].value,s=t.arguments.arguments[1].value,i=t.arguments.arguments[2].value;let n=0;return t.arguments.arguments.length>3&&(n=t.arguments.arguments[3].value),{barIndex:e,barOccurence:s,barPosition:n,millisecondOffset:i}}Bs(t,e,s,i){if(!i){return!!e.some(t=>0===t.parameters.length||!t.parameters.some(t=>t.parseMode===Ct.Required||t.parseMode===Ct.RequiredAsFloat||t.parseMode===Ct.RequiredAsValueList))||(t.addSemanticDiagnostic({code:Mt.AT219,message:`Error parsing arguments: no overload matched arguments ${ge.generateSignaturesFromArguments(void 0)}. Signatures: ${ge.generateSignatures(e)}`,severity:xt.Error,start:s.start,end:s.end}),!1)}if(i.validated)return!0;let n=!1;const r=new Map(e.map((t,e)=>[e,{signature:t,parameterIndex:0,parameterValueMatches:0,parameterHasValues:!1}])),a=t.parseMode===Et.Full,h=a?(t,e)=>{const s=r.get(e),i=t;i.parameterIndices||(i.parameterIndices=new Map),i.parameterIndices.set(e,s.parameterIndex)}:(t,e)=>{};for(const t of i.arguments)if(ge.filterSignatureCandidates(r,t,!1,h),0===r.size)break;const o=a?Array.from(r.entries()):void 0;return ge.filterIncompleteCandidates(r),0===r.size&&(t.addSemanticDiagnostic({code:Mt.AT219,message:`Error parsing arguments: no overload matched arguments ${ge.generateSignaturesFromArguments(i.arguments)}. Signatures:\n${ge.generateSignatures(e)}`,severity:xt.Error,start:i.start,end:i.end}),n=!0),o&&(ge.sortCandidates(o),i.signatureCandidateIndices=o.map(t=>t[0])),!n}ys(t,e,s,i,n=1){const r=i.arguments.arguments.length-n;if(r<1)return;const a=Xt.getOrCreateHeaderFooterStyle(e,s);void 0===a.isVisible&&(a.isVisible=!0);const h=i.arguments.arguments[n].text;if(h?a.template=h:a.isVisible=!1,r<2)return;const o=Ce.ks(t,i.arguments,"textAlign",ce.textAlign,n+1);void 0!==o&&(a.textAlign=o)}Ts(t,e,s){switch(s.arguments[0].nodeType){case Tt.Number:const i=s.arguments[0].value;i>=0&&i<=127?e.playbackInfo.program=i:t.addSemanticDiagnostic({code:Mt.AT211,message:`Value is out of valid range. Allowed range: 0-127, Actual Value: ${i}`,start:s.arguments[0].start,end:s.arguments[0].end,severity:xt.Error});break;case Tt.Ident:case Tt.String:const n=s.arguments[0].text.toLowerCase();if("percussion"===n){for(const s of e.staves)t.applyStaffNoteKind(s,Pt.Articulation);e.playbackInfo.primaryChannel=Ht.PercussionChannel,e.playbackInfo.secondaryChannel=Ht.PercussionChannel}else e.playbackInfo.program=we.getValue(n)}}xs(t,e,s){if(s.properties)for(const i of s.properties.properties)if(this.Es(t,[le.metaDataProperties.get("chord")],i))switch(i.property.text.toLowerCase()){case"firstfret":e.firstFret=i.arguments.arguments[0].value;break;case"showdiagram":e.showDiagram=Ce.Ss(i.arguments.arguments,0);break;case"showfingering":e.showFingering=Ce.Ss(i.arguments.arguments,0);break;case"showname":e.showName=Ce.Ss(i.arguments.arguments,0);break;case"barre":e.barreFrets=i.arguments.arguments.map(t=>t.value)}}_s(t,e,s,i){if(i.properties)for(const n of i.properties.properties)if(this.Es(t,[le.metaDataProperties.get("tuning")],n))switch(n.property.text.toLowerCase()){case"hide":e.track.score.stylesheet.perTrackDisplayTuning||(e.track.score.stylesheet.perTrackDisplayTuning=new Map),e.track.score.stylesheet.perTrackDisplayTuning.set(e.track.index,!1);break;case"label":s.name=n.arguments.arguments[0].text}}static Ss(t,e){if(e>=t.length)return!0;const s=t[e];switch(s.nodeType){case Tt.String:case Tt.Ident:return"false"!==s.text;case Tt.Number:return 0!==s.value;default:return!1}}applyStructuralMetaData(t,e){const s=this.ws(t,[le.structuralMetaDataSignatures],e,e.tag.tag.text.toLowerCase(),e.arguments);if(void 0!==s)switch(s){case Ft.NotAppliedSemanticError:return At.NotAppliedSemanticError;case Ft.NotAppliedUnrecognizedMarker:return At.NotAppliedUnrecognizedMarker}switch(e.tag.tag.text.toLowerCase()){case"staff":const s=t.startNewStaff();return this.Fs(t,s,e),At.AppliedNewStaff;case"track":const i=t.startNewTrack();return e.arguments&&e.arguments.arguments.length>0&&(i.name=e.arguments.arguments[0].text,e.arguments.arguments.length>1&&(i.shortName=e.arguments.arguments[1].text)),this.As(t,i,e),At.AppliedNewTrack;case"voice":return t.startNewVoice(),At.AppliedNewVoice;default:return At.NotAppliedUnrecognizedMarker}}Es(t,e,s){const i=this.ws(t,e,s,s.property.text.toLowerCase(),s.arguments);if(void 0!==i)switch(i){case Ft.Applied:case Ft.NotAppliedSemanticError:return!1;case Ft.NotAppliedUnrecognizedMarker:const i=e.flatMap(t=>Array.from(t.keys()));return t.addSemanticDiagnostic({code:Mt.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${i}`,severity:xt.Error,start:s.start,end:s.end}),!1}return!0}Fs(t,e,s){if(!s.properties)return;let i=!1,n=!1,r=!1,a=!1;for(const h of s.properties.properties)if(this.Es(t,[le.metaDataProperties.get("staff")],h))switch(h.property.text.toLowerCase()){case"score":i=!0,h.arguments&&h.arguments.arguments.length>0&&(e.standardNotationLineCount=h.arguments.arguments[0].value);break;case"tabs":n=!0;break;case"slash":r=!0;break;case"numbered":a=!0}(i||n||r||a)&&(e.showStandardNotation=i,e.showTablature=n,e.showSlash=r,e.showNumbered=a)}As(t,e,s){if(s.properties)for(const i of s.properties.properties)if(this.Es(t,[le.metaDataProperties.get("track")],i))switch(i.property.text.toLowerCase()){case"color":try{e.color=Se.fromJson(i.arguments.arguments[0].text)}catch{t.addSemanticDiagnostic({code:Mt.AT213,message:"Invalid format for color",severity:xt.Error,start:i.arguments.arguments[0].start,end:i.arguments.arguments[0].end})}break;case"defaultsystemslayout":e.defaultSystemsLayout=i.arguments.arguments[0].value;break;case"systemslayout":e.systemsLayout=i.arguments.arguments.map(t=>t.value);break;case"volume":e.playbackInfo.volume=i.arguments.arguments[0].value;break;case"balance":e.playbackInfo.balance=i.arguments.arguments[0].value;break;case"mute":e.playbackInfo.isMute=!0;break;case"solo":e.playbackInfo.isSolo=!0;break;case"multibarrest":e.score.stylesheet.perTrackMultiBarRest||(e.score.stylesheet.perTrackMultiBarRest=new Set),e.score.stylesheet.perTrackMultiBarRest.add(e.index);break;case"instrument":this.Ts(t,e,i.arguments);break;case"bank":e.playbackInfo.bank=i.arguments.arguments[0].value}}applyBeatDurationProperty(t,e){const s=this.ws(t,[le.durationChangeProperties],e,e.property.text.toLowerCase(),e.arguments);if(void 0!==s)return s;if("tu"===e.property.text.toLowerCase()){if(2===e.arguments.arguments.length)t.state.currentTupletNumerator=e.arguments.arguments[0].value,t.state.currentTupletDenominator=e.arguments.arguments[1].value;else{const s=e.arguments.arguments[0].value;t.state.currentTupletNumerator=s;const i=Ce.Ds(s);i<0?(t.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected default tuplet value '${s}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:xt.Error,start:e.arguments.arguments[0].start,end:e.arguments.arguments[0].end}),t.state.currentTupletNumerator=-1,t.state.currentTupletDenominator=-1):t.state.currentTupletDenominator=i}return Ft.Applied}return Ft.NotAppliedUnrecognizedMarker}static Ds(t){switch(t){case 3:return 2;case 5:case 6:case 7:return 4;case 9:case 10:case 11:case 12:return 8;default:return-1}}Ls=void 0;get allKnownMetaDataTags(){if(!this.Ls){this.Ls=new Set;const t=[le.scoreMetaDataSignatures.keys(),le.structuralMetaDataSignatures.keys(),le.staffMetaDataSignatures.keys(),le.barMetaDataSignatures.keys()];for(const e of t)for(const t of e)this.Ls.add(t)}return this.Ls}Ws=void 0;get knownScoreMetaDataTags(){return this.Ws||(this.Ws=new Set(le.scoreMetaDataSignatures.keys())),this.Ws}Rs=void 0;get knownStructuralMetaDataTags(){return this.Rs||(this.Rs=new Set(le.structuralMetaDataSignatures.keys())),this.Rs}Is=void 0;get knownBarMetaDataTags(){return this.Is||(this.Is=new Set(le.barMetaDataSignatures.keys())),this.Is}Os=void 0;get knownStaffMetaDataTags(){return this.Os||(this.Os=new Set(le.staffMetaDataSignatures.keys())),this.Os}Gs=void 0;get knownBeatDurationProperties(){return this.Gs||(this.Gs=new Set(le.durationChangeProperties.keys())),this.Gs}Vs=void 0;get knownBeatProperties(){return this.Vs||(this.Vs=new Set(le.beatProperties.keys())),this.Vs}$s=void 0;get knownNoteProperties(){return this.$s||(this.$s=new Set(le.noteProperties.keys())),this.$s}applyBeatProperty(t,e,s){const i=s.property.text.toLowerCase(),n=this.ws(t,[le.beatProperties],s,i,s.arguments);if(void 0!==n)return n;switch(i){case"f":return e.fade=gt.FadeIn,Ft.Applied;case"fo":return e.fade=gt.FadeOut,Ft.Applied;case"vs":return e.fade=gt.VolumeSwell,Ft.Applied;case"v":return e.vibrato=y.Slight,Ft.Applied;case"vw":return e.vibrato=y.Wide,Ft.Applied;case"s":return e.slap=!0,Ft.Applied;case"p":return e.pop=!0,Ft.Applied;case"tt":return e.tap=!0,Ft.Applied;case"txt":return e.text=s.arguments.arguments[0].text,Ft.Applied;case"lyrics":let n=0,a="";for(2===s.arguments.arguments.length?(n=s.arguments.arguments[0].value,a=s.arguments.arguments[1].text):a=s.arguments.arguments[0].text,e.lyrics||(e.lyrics=[]);e.lyrics.length<=n;)e.lyrics.push("");return e.lyrics[n]=a,Ft.Applied;case"dd":return e.dots=2,Ft.Applied;case"d":return e.dots=1,Ft.Applied;case"su":return e.pickStroke=lt.Up,Ft.Applied;case"sd":return e.pickStroke=lt.Down,Ft.Applied;case"tu":if(2===s.arguments.arguments.length)e.tupletNumerator=s.arguments.arguments[0].value,e.tupletDenominator=s.arguments.arguments[1].value;else{const i=s.arguments.arguments[0].value;e.tupletNumerator=i;const n=Ce.Ds(i);if(n<0)return t.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected default tuplet value '${i}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:xt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),e.tupletNumerator=-1,e.tupletDenominator=-1,Ft.NotAppliedSemanticError;e.tupletDenominator=n}return Ft.Applied;case"tb":case"tbe":let h=0,l=!0,d=!1;for(;l;)switch(s.arguments.arguments[h].nodeType){case Tt.Ident:case Tt.String:const i=s.arguments.arguments[h].text.toLowerCase();if(ce.whammyType.has(i))e.whammyBarType=ce.whammyType.get(i),d=!0,h++;else{if(!ce.bendStyle.has(i))return d?Ce.ks(t,s.arguments,"whammy style",ce.bendStyle,h):Ce.ks(t,s.arguments,"whammy type",ce.whammyType,h),Ft.NotAppliedSemanticError;e.whammyStyle=ce.bendStyle.get(i),h++}break;default:l=!1}const f=this.Hs(t,s,h,"tbe"===i);if(f)for(const t of f)e.addWhammyBarPoint(t);return Ft.Applied;case"bu":return Ce.Us(e,s,o.BrushUp,.25),Ft.Applied;case"bd":return Ce.Us(e,s,o.BrushDown,.25),Ft.Applied;case"au":return Ce.Us(e,s,o.ArpeggioUp,1),Ft.Applied;case"ad":return Ce.Us(e,s,o.ArpeggioDown,1),Ft.Applied;case"ch":const p=s.arguments.arguments[0].text,b=Ce.Ms(e.voice.bar.staff,p);if(!e.voice.bar.staff.hasChord(b)){const t=new ye;t.showDiagram=!1,t.name=p,e.voice.bar.staff.addChord(b,t)}return e.chordId=b,Ft.Applied;case"gr":if(s.arguments&&s.arguments.arguments.length>0){const i=Ce.ks(t,s.arguments,"whammy style",ce.graceType);if(void 0===i)return Ft.NotAppliedSemanticError;e.graceType=i}else e.graceType=u.BeforeBeat;return Ft.Applied;case"dy":const m=Ce.ks(t,s.arguments,"dynamic",ce.dynamicValue);return void 0===m?Ft.NotAppliedSemanticError:(e.dynamics=m,t.state.currentDynamics=m,Ft.Applied);case"cre":return e.crescendo=c.Crescendo,Ft.Applied;case"dec":return e.crescendo=c.Decrescendo,Ft.Applied;case"tempo":const g=s.arguments.arguments[0].value;let w="",k=!0;if(s.arguments.arguments.length>2){w=s.arguments.arguments[1].text;const e=s.arguments.arguments[2].text;if("hide"!==e)return t.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected third tempo property value '${e}', expected: 'hide'`,severity:xt.Error,start:s.arguments.arguments[2].start,end:s.arguments.arguments[2].end}),Ft.NotAppliedSemanticError;k=!1}else s.arguments.arguments.length>1&&(w=s.arguments.arguments[1].text,"hide"===w&&(k=!1,w=""));const S=new U;return S.isLinear=!1,S.type=r.Tempo,S.value=g,S.text=w,S.isVisible=k,e.automations.push(S),e.voice.bar.masterBar.tempoAutomations.push(S),Ft.Applied;case"volume":const B=new U;return B.isLinear=!0,B.type=r.Volume,B.value=s.arguments.arguments[0].value,e.automations.push(B),Ft.Applied;case"balance":const _=new U;return _.isLinear=!0,_.type=r.Balance,_.value=Xt.clamp(s.arguments.arguments[0].value,0,16),e.automations.push(_),Ft.Applied;case"tp":const T=new te;if(e.tremoloPicking=T,s.arguments&&s.arguments.arguments.length>0){if(s.arguments.arguments.length>0){const e=s.arguments.arguments[0].value;if(e>=te.minMarks&&e<=te.maxMarks)T.marks=e;else switch(e){case 8:T.marks=1;break;case 16:T.marks=2;break;case 32:T.marks=3;break;default:return t.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected tremolo marks value '${e}, expected: ${te.minMarks}-${te.maxMarks}, or legacy: 8, 16 or 32`,severity:xt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Ft.NotAppliedSemanticError}}if(s.arguments.arguments.length>1){const e=Ce.ks(t,s.arguments,"tremolo picking style",ce.tremoloPickingStyle,1);if(void 0===e)return Ft.NotAppliedSemanticError;T.style=e}}return Ft.Applied;case"spd":return Ce.zs(t,e,C.Down),Ft.Applied;case"sph":return Ce.zs(t,e,C.Hold),Ft.Applied;case"spu":return Ce.zs(t,e,C.Up),Ft.Applied;case"spe":return Ce.zs(t,e,C.Up,!0),Ft.Applied;case"slashed":return e.slashed=!0,Ft.Applied;case"ds":return e.deadSlapped=!0,1===e.notes.length&&e.notes[0].isDead&&e.removeNote(e.notes[0]),Ft.Applied;case"glpf":return e.golpe=mt.Finger,Ft.Applied;case"glpt":return e.golpe=mt.Thumb,Ft.Applied;case"waho":return e.wahPedal=wt.Open,Ft.Applied;case"wahc":return e.wahPedal=wt.Closed,Ft.Applied;case"barre":if(e.barreFret=s.arguments.arguments[0].value,e.barreShape=yt.Full,s.arguments.arguments.length>1){const i=Ce.ks(t,s.arguments,"barre shape",ce.barreShape,1);if(void 0===i)return Ft.NotAppliedSemanticError;e.barreShape=i}return Ft.Applied;case"rasg":const x=Ce.ks(t,s.arguments,"rasgueado pattern",ce.rasgueado);return void 0===x?Ft.NotAppliedSemanticError:(e.rasgueado=x,Ft.Applied);case"ot":const M=Ce.ks(t,s.arguments,"ottava",ce.ottavia);return void 0===M?Ft.NotAppliedSemanticError:(e.ottava=M,Ft.Applied);case"legatoorigin":return e.isLegatoOrigin=!0,Ft.Applied;case"instrument":let v=0;switch(s.arguments.arguments[0].nodeType){case Tt.Ident:case Tt.String:v=we.getValue(s.arguments.arguments[0].text);break;case Tt.Number:v=s.arguments.arguments[0].value}const N=new U;return N.isLinear=!1,N.type=r.Instrument,N.value=v,e.automations.push(N),Ft.Applied;case"bank":const P=new U;return P.isLinear=!1,P.type=r.Bank,P.value=s.arguments.arguments[0].value,e.automations.push(P),Ft.Applied;case"fermata":const E=Ce.ks(t,s.arguments,"fermata",ce.fermataType);if(void 0===E)return Ft.NotAppliedSemanticError;const F=new Be;return F.type=E,s.arguments.arguments.length>1&&(F.length=s.arguments.arguments[1].value),e.fermata=F,Ft.Applied;case"beam":const A=s.arguments.arguments[0].text;switch(A.toLowerCase()){case"invert":e.invertBeamDirection=!0;break;case"up":e.preferredBeamDirection=Rt.Up;break;case"down":e.preferredBeamDirection=Rt.Down;break;case"auto":e.beamingMode=Bt.Auto;break;case"split":e.beamingMode=Bt.ForceSplitToNext;break;case"merge":e.beamingMode=Bt.ForceMergeWithNext;break;case"splitsecondary":e.beamingMode=Bt.ForceSplitOnSecondaryToNext;break;default:const i=["invert","up","down","auto","split","merge","splitsecondary"];return t.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected beam value '${A}', expected: ${i.join(",")}`,severity:xt.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),Ft.NotAppliedSemanticError}return Ft.Applied;case"timer":return e.showTimer=!0,Ft.Applied}return Ft.NotAppliedUnrecognizedMarker}static zs(t,e,s,i=!1){const n=new K;n.pedalType=s,n.ratioPosition=i?1:.001*e.voice.bar.sustainPedals.length,t.state.sustainPedalToBeat.set(n,e),e.voice.bar.sustainPedals.push(n)}static Us(t,e,s,i){t.brushType=s,e.arguments&&e.arguments.arguments.length>0?t.brushDuration=e.arguments.arguments[0].value:(t.updateDurations(),t.brushDuration=t.playbackDuration*i/t.notes.length)}applyNoteProperty(t,e,s){const i=s.property.text.toLowerCase(),n=this.ws(t,[le.noteProperties],s,i,s.arguments);if(void 0!==n)return n;switch(i){case"b":case"be":let n=0,r=!0,a=!1;for(;r;)switch(s.arguments.arguments[n].nodeType){case Tt.Ident:case Tt.String:const i=s.arguments.arguments[n].text.toLowerCase();if(ce.bendType.has(i))e.bendType=ce.bendType.get(i),a=!0,n++;else{if(!ce.bendStyle.has(i))return a?Ce.ks(t,s.arguments,"bend style",ce.bendStyle,n):Ce.ks(t,s.arguments,"bend type",ce.bendType,n),Ft.NotAppliedSemanticError;e.bendStyle=ce.bendStyle.get(i),n++}break;default:r=!1}const h=this.Hs(t,s,n,"be"===i);if(h)for(const t of h)e.addBendPoint(t);return Ft.Applied;case"nh":return e.harmonicType=p.Natural,e.harmonicValue=Xt.deltaFretToHarmonicValue(e.fret),Ft.Applied;case"ah":return e.harmonicType=p.Artificial,e.harmonicValue=Ce.Xs(s.arguments,e.harmonicValue),Ft.Applied;case"th":return e.harmonicType=p.Tap,e.harmonicValue=Ce.Xs(s.arguments,e.harmonicValue),Ft.Applied;case"ph":return e.harmonicType=p.Pinch,e.harmonicValue=Ce.Xs(s.arguments,e.harmonicValue),Ft.Applied;case"sh":return e.harmonicType=p.Semi,e.harmonicValue=Ce.Xs(s.arguments,e.harmonicValue),Ft.Applied;case"fh":return e.harmonicType=p.Feedback,e.harmonicValue=Ce.Xs(s.arguments,e.harmonicValue),Ft.Applied;case"tr":const o=s.arguments.arguments[0].value;let c=l.Sixteenth;if(s.arguments.arguments.length>1){const e=s.arguments.arguments[1].value;switch(e){case 16:c=l.Sixteenth;break;case 32:c=l.ThirtySecond;break;case 64:c=l.SixtyFourth;break;default:return t.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected trill duration value '${e}', expected: 16, 32 or 64`,severity:xt.Error,start:s.arguments.arguments[1].start,end:s.arguments.arguments[1].end}),Ft.NotAppliedSemanticError}}return e.trillValue=o+e.stringTuning,e.trillSpeed=c,Ft.Applied;case"v":return e.vibrato=y.Slight,Ft.Applied;case"vw":return e.vibrato=y.Wide,Ft.Applied;case"sl":return e.slideOutType=w.Legato,Ft.Applied;case"ss":return e.slideOutType=w.Shift,Ft.Applied;case"sib":return e.slideInType=g.IntoFromBelow,Ft.Applied;case"sia":return e.slideInType=g.IntoFromAbove,Ft.Applied;case"sou":return e.slideOutType=w.OutUp,Ft.Applied;case"sod":return e.slideOutType=w.OutDown,Ft.Applied;case"psd":return e.slideOutType=w.PickSlideDown,Ft.Applied;case"psu":return e.slideOutType=w.PickSlideUp,Ft.Applied;case"h":return e.isHammerPullOrigin=!0,Ft.Applied;case"lht":return e.isLeftHandTapped=!0,Ft.Applied;case"g":return e.isGhost=!0,Ft.Applied;case"ac":return e.accentuated=d.Normal,Ft.Applied;case"hac":return e.accentuated=d.Heavy,Ft.Applied;case"ten":return e.accentuated=d.Tenuto,Ft.Applied;case"pm":return e.isPalmMute=!0,Ft.Applied;case"st":return e.isStaccato=!0,Ft.Applied;case"lr":return e.isLetRing=!0,Ft.Applied;case"x":return e.isDead=!0,Ft.Applied;case"-":case"t":return e.isTieDestination=!0,Ft.Applied;case"lf":let u=f.Thumb;if(s.arguments&&s.arguments.arguments.length>0){const e=Ce.js(t,s.arguments);if(void 0===e)return Ft.NotAppliedSemanticError;u=e}return e.leftHandFinger=u,Ft.Applied;case"rf":let b=f.Thumb;if(s.arguments&&s.arguments.arguments.length>0){const e=Ce.js(t,s.arguments);if(void 0===e)return Ft.NotAppliedSemanticError;b=e}return e.rightHandFinger=b,Ft.Applied;case"acc":return e.accidentalMode=Xt.parseAccidentalMode(s.arguments.arguments[0].text),Ft.Applied;case"turn":return e.ornament=ft.Turn,Ft.Applied;case"iturn":return e.ornament=ft.InvertedTurn,Ft.Applied;case"umordent":return e.ornament=ft.UpperMordent,Ft.Applied;case"lmordent":return e.ornament=ft.LowerMordent,Ft.Applied;case"string":return e.showStringNumber=!0,Ft.Applied;case"hide":return e.isVisible=!1,Ft.Applied;case"slur":const m=s.arguments.arguments[0].text;if(t.state.slurs.has(m)){const s=t.state.slurs.get(m);s.slurDestination=e,e.slurOrigin=s,e.isSlurDestination=!0}else t.state.slurs.set(m,e);return Ft.Applied;default:return this.applyBeatProperty(t,e.beat,s)}return Ft.NotAppliedUnrecognizedMarker}static js(t,e){const s=e.arguments[0].value;switch(s){case 1:return f.Thumb;case 2:return f.IndexFinger;case 3:return f.MiddleFinger;case 4:return f.AnnularFinger;case 5:return f.LittleFinger;default:return void t.addSemanticDiagnostic({code:Mt.AT211,message:`Value is out of valid range. Allowed range: 1-5, Actual Value: ${s}`,start:e.arguments[0].start,end:e.arguments[0].end,severity:xt.Error})}}static Xs(t,e){return t&&(e=t.arguments[0].value),e}Hs(t,e,s,i){let n=e.arguments.arguments,r=n.length-s,a=e.arguments;r>0&&n[s].nodeType===Tt.Arguments&&(n=n[s].arguments,s=0,r=n.length,a=n[s]);const h=i?2:1;if(r%h!==0){const s=Math.ceil(r/h),i=s*h;return void t.addSemanticDiagnostic({code:Mt.AT214,message:`The '${e.property.text}' effect needs ${h} arguments per item. With ${s} points, ${i} arguments are needed, only ${r} arguments found.`,severity:xt.Error,start:a.end,end:a.end})}const o=[];let c=s;for(;c<n.length;){let t=0,e=0;i?(t=n[c++].value,e=n[c++].value):(t=0,e=n[c++].value),o.push(new z(t,e))}if(o.length>0){if(o.length>60&&o.splice(60,o.length-60),i)o.sort((t,e)=>t.offset-e.offset);else{const t=o.length,e=z.MaxPosition/(t-1)|0;let s=0;for(;s<t;)o[s].offset=Math.min(z.MaxPosition,s*e),s++}return o}}static ks(t,e,s,i,n=0){if(n>=e.arguments.length)return;const r=e.arguments[n].text;return i.has(r.toLowerCase())?i.get(r.toLowerCase()):void t.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected ${s} value '${r}', expected: ${Array.from(i.keys()).join(",")}`,severity:xt.Error,start:e.arguments[n].start,end:e.arguments[n].end})}static Js=new $t;static qs=new Pe;buildScoreMetaDataNodes(t){const e=[];return Ce.Ys(e,"album",t,t.album,ct.Album),Ce.Ys(e,"artist",t,t.artist,ct.Artist),Ce.Ys(e,"copyright",t,t.copyright,ct.Copyright),Ce.Ys(e,"copyright2",t,void 0,ct.CopyrightSecondLine),Ce.Ys(e,"wordsandmusic",t,void 0,ct.WordsAndMusic,!0),Ce.Ys(e,"instructions",t,t.instructions,void 0),Ce.Ys(e,"music",t,t.music,ct.Music),Ce.Ys(e,"notices",t,t.notices,void 0),Ce.Ys(e,"subtitle",t,t.subTitle,ct.SubTitle),Ce.Ys(e,"title",t,t.title,ct.Title),Ce.Ys(e,"words",t,t.words,ct.Words),Ce.Ys(e,"tab",t,t.tab,ct.Transcriber),t.defaultSystemsLayout!==Ce.Js.defaultSystemsLayout&&e.push(me.numberMeta("defaultSystemsLayout",t.defaultSystemsLayout)),t.systemsLayout.length>0&&e.push(me.meta("systemsLayout",me.args(t.systemsLayout.map(t=>me.number(t))))),Ce.Ks(e,t.stylesheet),e.length>0&&(e[0].leadingComments=[{text:"Score Metadata",multiLine:!1}]),e}static Ks(t,e){const s=t.length;e.hideDynamics&&t.push(me.meta("hideDynamics")),e.bracketExtendMode!==Ce.Js.stylesheet.bracketExtendMode&&t.push(me.identMeta("bracketExtendMode",ce.bracketExtendModeReversed.get(e.bracketExtendMode))),e.useSystemSignSeparator&&t.push(me.meta("useSystemSignSeparator")),e.multiTrackMultiBarRest&&t.push(me.meta("multiBarRest")),e.singleTrackTrackNamePolicy!==Ce.Js.stylesheet.singleTrackTrackNamePolicy&&t.push(me.identMeta("singleTrackTrackNamePolicy",ce.trackNamePolicyReversed.get(e.singleTrackTrackNamePolicy))),e.multiTrackTrackNamePolicy!==Ce.Js.stylesheet.multiTrackTrackNamePolicy&&t.push(me.identMeta("multiTrackTrackNamePolicy",ce.trackNamePolicyReversed.get(e.multiTrackTrackNamePolicy))),e.firstSystemTrackNameMode!==Ce.Js.stylesheet.firstSystemTrackNameMode&&t.push(me.identMeta("firstSystemTrackNameMode",ce.trackNameModeReversed.get(e.firstSystemTrackNameMode))),e.otherSystemsTrackNameMode!==Ce.Js.stylesheet.otherSystemsTrackNameMode&&t.push(me.identMeta("otherSystemsTrackNameMode",ce.trackNameModeReversed.get(e.otherSystemsTrackNameMode))),e.firstSystemTrackNameOrientation!==Ce.Js.stylesheet.firstSystemTrackNameOrientation&&t.push(me.identMeta("firstSystemTrackNameOrientation",ce.trackNameOrientationReversed.get(e.firstSystemTrackNameOrientation))),e.otherSystemsTrackNameOrientation!==Ce.Js.stylesheet.otherSystemsTrackNameOrientation&&t.push(me.identMeta("otherSystemsTrackNameOrientation",ce.trackNameOrientationReversed.get(e.otherSystemsTrackNameOrientation))),e.extendBarLines&&t.push(me.meta("extendBarLines")),e.globalDisplayChordDiagramsInScore&&t.push(me.meta("chordDiagramsInScore")),e.hideEmptyStaves&&t.push(me.meta("hideEmptyStaves")),e.hideEmptyStavesInFirstSystem&&t.push(me.meta("hideEmptyStavesInFirstSystem")),e.showSingleStaffBrackets&&t.push(me.meta("showSingleStaffBrackets")),e.barNumberDisplay!==I.AllBars&&t.push(me.identMeta("defaultBarNumberDisplay",I[e.barNumberDisplay])),s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:"Score Stylesheet"}])}static Ys(t,e,s,i,n,r=!1){if(void 0!==i&&0===i.length&&!r)return;const a=[];if(void 0!==i&&a.push(me.string(i)),void 0!==n){const t=s.style&&s.style.headerAndFooter.has(n)?s.style.headerAndFooter.get(n):void 0,e=Vt.defaultHeaderAndFooter.has(n)?Vt.defaultHeaderAndFooter.get(n):void 0;!t||e&&Gt.equals(e,t)||(a.push(me.string(!1===t.isVisible?"":t.template)),a.push(me.ident(ce.textAlignReversed.get(t.textAlign))))}void 0===i&&0===a.length||void 0!==i&&0===i.length&&1===a.length||t.push(me.meta(e,me.args(a)))}buildSyncPointNodes(t){const e=[],s=t.exportFlatSyncPoints();for(const t of s)e.push(me.meta("sync",me.args([me.number(t.barIndex),me.number(t.barOccurence),me.number(t.millisecondOffset),t.barPosition>0?me.number(t.barPosition):void 0])));return e}buildBarMetaDataNodes(t,e,s,i){const n=[];if(Ce.Qs(e,t,n,i,s),!e)return n;0===s&&0===t.index&&0===t.track.index&&Ce.Zs(n,e.masterBar);const r=n.length;0===s&&0===e.index&&0===t.index&&0===t.track.index&&n.push(me.identMeta("accidentals","auto")),0!==e.index&&e.clef===e.previousBar?.clef||n.push(me.identMeta("clef",ce.clefReversed.get(e.clef))),(0===e.index&&e.clefOttava!==m.Regular||e.clefOttava!==e.previousBar?.clefOttava)&&n.push(me.identMeta("ottava",ce.ottaviaReversed.get(e.clefOttava))),(0===e.index&&e.simileMark!==v.None||e.simileMark!==e.previousBar?.simileMark)&&n.push(me.identMeta("simile",ce.simileMarkReversed.get(e.simileMark))),1!==e.displayScale&&n.push(me.numberMeta("scale",e.displayScale)),e.displayWidth>0&&n.push(me.numberMeta("width",e.displayWidth));for(const t of e.sustainPedals){let e="";switch(t.pedalType){case C.Down:e="spd";break;case C.Hold:e="sph";break;case C.Up:e="spu"}e&&n.push(me.numberMeta(e,t.ratioPosition))}if(e.barLineLeft!==F.Automatic&&n.push(me.identMeta("barLineLeft",ce.barLineStyleReversed.get(e.barLineLeft))),e.barLineRight!==F.Automatic&&n.push(me.identMeta("barLineRight",ce.barLineStyleReversed.get(e.barLineRight))),0===e.index||e.keySignature!==e.previousBar.keySignature||e.keySignatureType!==e.previousBar.keySignatureType){let t="";t=e.keySignatureType===P.Minor?ce.keySignaturesMinorReversed.get(e.keySignature):ce.keySignaturesMajorReversed.get(e.keySignature),n.push(me.identMeta("ks",t))}return r<n.length&&(n[r].leadingComments=[{multiLine:!1,text:`Bar ${e.index+1} Metadata`}]),void 0!==e.barNumberDisplay&&n.push(me.identMeta("barNumberDisplay",I[e.barNumberDisplay])),n}static ti(t,e){const s=t.length;if(0!==e.capo&&t.push(me.numberMeta("capo",e.capo)),e.isPercussion)t.push(me.identMeta("articulation","defaults"));else if(e.isStringed){const s=me.meta("tuning",me.args(e.stringTuning.tunings.map(t=>me.ident(xe.getTextForTuning(t,!0)))));t.push(s),e.track.score.stylesheet.perTrackDisplayTuning&&e.track.score.stylesheet.perTrackDisplayTuning.has(e.track.index)&&(s.properties=me.props([["hide",void 0]])),e.stringTuning.name.length>0&&(s.properties??=me.props([]),me.prop(s.properties.properties,"label",me.stringValue(e.stringTuning.name)))}0!==e.transpositionPitch&&t.push(me.numberMeta("transpose",-e.transpositionPitch));const i=Xt.displayTranspositionPitches.has(e.track.playbackInfo.program)?Xt.displayTranspositionPitches.get(e.track.playbackInfo.program):0;if(e.displayTranspositionPitch!==i&&t.push(me.numberMeta("displaytranspose",-e.displayTranspositionPitch)),null!=e.chords)for(const[s,i]of e.chords)t.push(Ce.ei(i));s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:`Staff ${e.index+1} Metadata`}])}static ei(t){const e=me.meta("chord",me.args([me.string(t.name)],!0),me.props([t.firstFret>=0?["firstfret",me.numberValue(t.firstFret)]:void 0,["showdiagram",me.identValue(t.showDiagram?"true":"false")],["showfingering",me.identValue(t.showFingering?"true":"false")],["showname",me.identValue(t.showName?"true":"false")],t.barreFrets.length>0?["barre",me.args(t.barreFrets.map(t=>me.number(t)))]:void 0]));for(let s=0;s<t.staff.tuning.length;s++)s<t.strings.length&&t.strings[s]>=0?e.arguments.arguments.push(me.number(t.strings[s])):e.arguments.arguments.push(me.ident("x"));return e}static Zs(t,e){const s=t.length;if(0!==e.alternateEndings&&t.push(me.meta("ae",me.args(Xt.getAlternateEndingsList(e.alternateEndings).map(t=>me.number(t+1))))),e.isRepeatStart&&t.push(me.meta("ro")),e.isRepeatEnd&&t.push(me.numberMeta("rc",e.repeatCount)),0!==e.index&&e.timeSignatureCommon===e.previousMasterBar?.timeSignatureCommon&&e.timeSignatureNumerator===e.previousMasterBar.timeSignatureNumerator&&e.timeSignatureDenominator===e.previousMasterBar.timeSignatureDenominator||(e.timeSignatureCommon?t.push(me.identMeta("ts","common")):t.push(me.meta("ts",me.args([me.number(e.timeSignatureNumerator),me.number(e.timeSignatureDenominator)])))),e.beamingRules)for(const[s,i]of e.beamingRules.groups){const e=me.args([me.number(s)],!0);for(const t of i)e.arguments.push(me.number(t));t.push(me.meta("beaming",e))}if((e.index>0&&e.tripletFeel!==e.previousMasterBar?.tripletFeel||0===e.index&&e.tripletFeel!==A.NoTripletFeel)&&t.push(me.identMeta("tf",ce.tripletFeelReversed.get(e.tripletFeel))),e.isFreeTime&&t.push(me.meta("ft")),null!=e.section&&t.push(me.meta("section",me.args([me.string(e.section.marker),me.string(e.section.text)]))),e.isAnacrusis&&t.push(me.meta("ac")),1!==e.displayScale&&t.push(me.numberMeta("scale",e.displayScale)),e.displayWidth>0&&t.push(me.numberMeta("width",e.displayWidth)),e.directions)for(const s of e.directions)t.push(me.identMeta("jump",ce.directionReversed.get(s)));for(const s of e.tempoAutomations){const e=me.meta("tempo",me.args([me.number(s.value),s.text?me.string(s.text):void 0,s.ratioPosition>0?me.number(s.ratioPosition):void 0,s.isVisible?void 0:me.ident("hide")]));1===e.arguments.arguments.length&&(e.arguments.openParenthesis=void 0,e.arguments.closeParenthesis=void 0),t.push(e)}s<t.length&&(t[s].leadingComments=[{multiLine:!1,text:`Masterbar ${e.index+1} Metadata`}])}static Qs(t,e,s,i,n){if((void 0===t||0===t.index)&&(0===n&&(0===e.index&&s.push(Ce.si(e.track)),s.push(Ce.ii(e)),Ce.ti(s,e)),i)){const t=me.meta("voice");t.trailingComments=[{multiLine:!0,text:`Voice ${n+1}`}],s.push(t)}}static ii(t){const e=me.meta("staff",void 0,me.props([t.showStandardNotation?["score",me.args([t.standardNotationLineCount!==Me.DefaultStandardNotationLineCount?me.number(t.standardNotationLineCount):void 0])]:void 0,t.showTablature?["tabs",void 0]:void 0,t.showSlash?["slash",void 0]:void 0,t.showNumbered?["numbered",void 0]:void 0]));return e.properties&&e.properties.properties.length>0&&(e.properties.properties[0].leadingComments=[{multiLine:!1,text:"Staff Properties"}]),e}static si(t){const e=me.meta("track",me.args([me.string(t.name),t.shortName.length>0?me.string(t.shortName):void 0]),me.props([t.color.rgba!==Ce.qs.color.rgba?["color",me.stringValue(t.color.rgba)]:void 0,t.defaultSystemsLayout!==Ce.qs.defaultSystemsLayout?["defaultSystemsLayout",me.numberValue(t.defaultSystemsLayout)]:void 0,t.systemsLayout.length?["systemsLayout",me.args(t.systemsLayout.map(t=>me.number(t)))]:void 0,["volume",me.numberValue(t.playbackInfo.volume)],["balance",me.numberValue(t.playbackInfo.balance)],t.playbackInfo.isMute?["mute",void 0]:void 0,t.playbackInfo.isSolo?["solo",void 0]:void 0,t.score.stylesheet.perTrackMultiBarRest&&t.score.stylesheet.perTrackMultiBarRest.has(t.index)?["multiBarRest",void 0]:void 0,["instrument",me.identValue(t.isPercussion?"percussion":we.getName(t.playbackInfo.program))],t.playbackInfo.bank>0?["bank",me.numberValue(t.playbackInfo.bank)]:void 0]));return e.properties&&e.properties.properties.length>0&&(e.properties.properties[0].leadingComments=[{multiLine:!1,text:"Track Properties"}]),e}buildNoteEffects(t){const e=[];if(t.hasBend){const s=me.args([me.ident(ce.bendTypeReversed.get(t.bendType)),t.bendStyle!==a.Default?me.ident(ce.bendStyleReversed.get(t.bendStyle)):void 0],!0);for(const e of t.bendPoints)s.arguments.push(me.number(e.offset)),s.arguments.push(me.number(e.value));me.prop(e,"be",s)}let s="";switch(t.harmonicType){case p.Natural:me.prop(e,"nh");break;case p.Artificial:s="ah";break;case p.Pinch:s="ph";break;case p.Tap:s="th";break;case p.Semi:s="sh";break;case p.Feedback:s="fh"}switch(s&&me.prop(e,s,me.numberValue(t.harmonicValue)),t.showStringNumber&&me.prop(e,"string"),t.isTrill&&me.prop(e,"tr",me.args([me.number(t.trillFret),me.number(t.trillSpeed)])),t.vibrato){case y.Slight:me.prop(e,"v");break;case y.Wide:me.prop(e,"vw")}switch(t.slideInType){case g.IntoFromBelow:me.prop(e,"sib");break;case g.IntoFromAbove:me.prop(e,"sia")}switch(t.slideOutType){case w.Shift:me.prop(e,"ss");break;case w.Legato:me.prop(e,"sl");break;case w.OutUp:me.prop(e,"sou");break;case w.OutDown:me.prop(e,"sod");break;case w.PickSlideDown:me.prop(e,"psd");break;case w.PickSlideUp:me.prop(e,"psu")}switch(t.isHammerPullOrigin&&me.prop(e,"h"),t.isLeftHandTapped&&me.prop(e,"lht"),t.isGhost&&me.prop(e,"g"),t.accentuated){case d.Normal:me.prop(e,"ac");break;case d.Heavy:me.prop(e,"hac");break;case d.Tenuto:me.prop(e,"ten")}if(t.isPalmMute&&me.prop(e,"pm"),t.isStaccato&&me.prop(e,"st"),t.isLetRing&&me.prop(e,"lr"),t.isDead&&me.prop(e,"x"),t.isTieDestination&&me.prop(e,"t"),t.leftHandFinger>=f.Thumb&&me.prop(e,"lf",me.numberValue(t.leftHandFinger+1)),t.rightHandFinger>=f.Thumb&&me.prop(e,"rf",me.numberValue(t.rightHandFinger+1)),t.isVisible||me.prop(e,"hide"),t.isSlurOrigin){const s=`s${t.id}`;me.prop(e,"slur",me.identValue(s))}if(t.isSlurDestination){const s=`s${t.slurOrigin.id}`;me.prop(e,"slur",me.identValue(s))}switch(t.accidentalMode!==b.Default&&me.prop(e,"acc",me.identValue(Xt.reverseAccidentalModeMapping.get(t.accidentalMode))),t.ornament){case ft.InvertedTurn:me.prop(e,"iturn");break;case ft.Turn:me.prop(e,"turn");break;case ft.UpperMordent:me.prop(e,"umordent");break;case ft.LowerMordent:me.prop(e,"lmordent")}return e}buildBeatEffects(t){const e=[];switch(t.fade){case gt.FadeIn:me.prop(e,"f");break;case gt.FadeOut:me.prop(e,"fo");break;case gt.VolumeSwell:me.prop(e,"vs")}if(t.vibrato===y.Slight?me.prop(e,"v"):t.vibrato===y.Wide&&me.prop(e,"vw"),t.slap&&me.prop(e,"s"),t.pop&&me.prop(e,"p"),t.tap&&me.prop(e,"tt"),t.dots>=2?me.prop(e,"dd"):t.dots>0&&me.prop(e,"d"),t.pickStroke===lt.Up?me.prop(e,"su"):t.pickStroke===lt.Down&&me.prop(e,"sd"),t.hasTuplet&&me.prop(e,"tu",me.args([me.number(t.tupletNumerator),me.number(t.tupletDenominator)])),t.hasWhammyBar){const s=me.args([me.ident(ce.whammyTypeReversed.get(t.whammyBarType)),me.ident(ce.bendStyleReversed.get(t.whammyStyle))],!0);for(const e of t.whammyBarPoints)s.arguments.push(me.number(e.offset)),s.arguments.push(me.number(e.value));me.prop(e,"tbe",s)}let s="";switch(t.brushType){case o.BrushUp:s="bu";break;case o.BrushDown:s="bd";break;case o.ArpeggioUp:s="au";break;case o.ArpeggioDown:s="ad"}if(s&&me.prop(e,s,me.numberValue(t.brushDuration)),null!=t.chord&&me.prop(e,"ch",me.stringValue(t.chord.name)),t.ottava!==m.Regular&&me.prop(e,"ot",me.identValue(ce.ottaviaReversed.get(t.ottava))),t.hasRasgueado&&me.prop(e,"rasg",me.identValue(ce.rasgueadoReversed.get(t.rasgueado))),null!=t.text&&me.prop(e,"txt",me.stringValue(t.text)),null!=t.lyrics&&t.lyrics.length>0)if(t.lyrics.length>1)for(let s=0;s<t.lyrics.length;s++)me.prop(e,"lyrics",me.args([me.number(s),me.string(t.lyrics[s])]));else me.prop(e,"lyrics",me.stringValue(t.lyrics[0]));if(t.graceType!==u.None&&me.prop(e,"gr",t.graceType===u.BeforeBeat?void 0:me.identValue(ce.graceTypeReversed.get(t.graceType))),t.isTremolo){const s=[me.number(t.tremoloPicking.marks)];t.tremoloPicking.style!==St.Default&&s.push(me.ident(St[t.tremoloPicking.style])),me.prop(e,"tp",me.args(s))}switch(t.crescendo){case c.Crescendo:me.prop(e,"cre");break;case c.Decrescendo:me.prop(e,"dec")}(0===t.voice.bar.index&&0===t.index||t.dynamics!==t.previousBeat?.dynamics)&&me.prop(e,"dy",me.identValue(ce.dynamicValueReversed.get(t.dynamics)));null!=t.fermata&&me.prop(e,"fermata",me.args([me.ident(ce.fermataTypeReversed.get(t.fermata.type)),me.number(t.fermata.length)])),t.isLegatoOrigin&&me.prop(e,"legatoorigin");for(const s of t.automations)switch(s.type){case r.Tempo:me.prop(e,"tempo",me.args([me.number(s.value),0===s.text.length?void 0:me.string(s.text)]));break;case r.Volume:me.prop(e,"volume",me.numberValue(s.value));break;case r.Instrument:t.voice.bar.staff.isPercussion||me.prop(e,"instrument",me.identValue(we.getName(s.value)));break;case r.Balance:me.prop(e,"balance",me.numberValue(s.value))}switch(t.wahPedal){case wt.Open:me.prop(e,"waho");break;case wt.Closed:me.prop(e,"wahc")}switch(t.isBarre&&me.prop(e,"barre",me.args([me.number(t.barreFret),me.ident(ce.barreShapeReversed.get(t.barreShape))])),t.slashed&&me.prop(e,"slashed"),t.deadSlapped&&me.prop(e,"ds"),t.golpe){case mt.Thumb:me.prop(e,"glpt");break;case mt.Finger:me.prop(e,"glpf")}t.invertBeamDirection?me.prop(e,"beam",me.identValue("invert")):null!==t.preferredBeamDirection&&me.prop(e,"beam",me.identValue(Rt[t.preferredBeamDirection]));let i="";switch(t.beamingMode){case Bt.ForceSplitToNext:i="split";break;case Bt.ForceMergeWithNext:i="merge";break;case Bt.ForceSplitOnSecondaryToNext:i="splitsecondary"}return i&&me.prop(e,"beam",me.identValue(i)),t.showTimer&&me.prop(e,"timer"),e}}class Ee{data;settings;init(t,e){this.data=t,this.settings=e,$t.resetIds()}}class Fe extends G{constructor(e=null,s){super(t.AlphaTabErrorType.Format,e??"Unsupported format",s)}}class Ae{ni;length=0;position=0;get bytesWritten(){return this.position}getBuffer(){return this.ni}static empty(){return Ae.withCapacity(0)}static withCapacity(t){const e=new Ae;return e.ni=new Uint8Array(t),e}static fromBuffer(t){const e=new Ae;return e.ni=t,e.length=t.length,e}static fromString(t){const e=fe.stringToBytes(t);return Ae.fromBuffer(e)}reset(){this.position=0}skip(t){this.position+=t}readByte(){return this.length-this.position<=0?-1:this.ni[this.position++]}read(t,e,s){let i=this.length-this.position;return i>s&&(i=s),i<=0?0:(t.set(this.ni.subarray(this.position,this.position+i),e),this.position+=i,i)}writeByte(t){const e=this.position+1;this.ri(e),this.ni[this.position]=255&t,e>this.length&&(this.length=e),this.position=e}write(t,e,s){const i=this.position+s;this.ri(i);const n=Math.min(s,t.length-e);this.ni.set(t.subarray(e,e+n),this.position),i>this.length&&(this.length=i),this.position=i}ri(t){if(t>this.ni.length){let e=t;e<256&&(e=256),e<2*this.ni.length&&(e=2*this.ni.length);const s=new Uint8Array(e);this.length>0&&s.set(this.ni.subarray(0,0+this.length),0),this.ni=s}}readAll(){return this.toArray()}toArray(){const t=new Uint8Array(this.length);return t.set(this.ni.subarray(0,0+this.length),0),t}copyTo(t){t.write(this.ni,0,this.length)}}class De extends G{lexerDiagnostics;parserDiagnostics;semanticDiagnostics;*iterateDiagnostics(){if(this.lexerDiagnostics)for(const t of this.lexerDiagnostics.items)yield t;if(this.parserDiagnostics)for(const t of this.parserDiagnostics.items)yield t;if(this.semanticDiagnostics)for(const t of this.semanticDiagnostics.items)yield t}constructor(e,s,i,n){super(t.AlphaTabErrorType.AlphaTex,e),this.lexerDiagnostics=s,this.parserDiagnostics=i,this.semanticDiagnostics=n}toString(){return[this.message,"lexer diagnostics:",De.ai(this.lexerDiagnostics,"  "),"parser diagnostics:",De.ai(this.parserDiagnostics,"  "),"semantic diagnostics:",De.ai(this.semanticDiagnostics,"  ")].join("\n")}static ai(t,e){return t?t.items.map(t=>`${e}${xt[t.severity]} AT${t.code.toString().padStart(3,"0")}${De.hi(t)}: ${t.message}`).join("\n"):`${e}none`}static hi(t){let e="";return t.start&&(e+=`(${t.start.line},${t.start.col})`),t.end&&(e.length>0&&(e+="->"),e+=`(${t.end.line},${t.end.col})`),e}}class Le{trackChannel=0;score;currentTrack;currentStaff;barIndex=0;voiceIndex=0;ignoredInitialVoice=!1;ignoredInitialStaff=!1;ignoredInitialTrack=!1;currentDuration=l.Quarter;articulationUniqueIdToIndex=new Map;hasAnyProperData=!1;percussionArticulationNames=new Map;slurs=new Map;lyrics=new Map;sustainPedalToBeat=new Map;staffTuningApplied=new Set;staffNoteKind=new Map;staffHasExplicitTuning=new Set;staffHasExplicitDisplayTransposition=new Set;staffDisplayTranspositionApplied=new Set;staffInitialClef=new Map;syncPoints=[];currentDynamics=n.F;accidentalMode=vt.Explicit;voiceMode=Nt.StaffWise;currentTupletNumerator=-1;currentTupletDenominator=-1;scoreNode}class We extends Ee{oi;ci=Ce.instance;li=new Le;get state(){return this.li}get scoreNode(){return this.li.scoreNode}get name(){return"AlphaTex"}get lexerDiagnostics(){return this.oi.lexerDiagnostics}get parserDiagnostics(){return this.oi.parserDiagnostics}get parser(){return this.oi}get parseMode(){return this.oi.mode}logErrors=!1;semanticDiagnostics=new ue;addSemanticDiagnostic(t){this.semanticDiagnostics.push(t)}initFromString(t,e){this.data=Ae.empty(),this.oi=new be(t),this.settings=e,$t.resetIds()}readScore(){let t;this.li=new Le,this.ui(),this.data.length>0&&(this.oi=new be(fe.toString(this.data.readAll(),this.settings.importer.encoding)));try{t=this.oi.read(),this.li.scoreNode=t}catch(t){throw this.logErrors&&q.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),new Fe("Error parsing alphaTex, check inner error for details",t)}if(this.oi.parserDiagnostics.hasErrors||this.oi.lexer.lexerDiagnostics.hasErrors){const t=new De("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&q.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),new Fe("Error parsing alphaTex, check diagnostics on inner error for details",t)}if(this._e(t),this.semanticDiagnostics.hasErrors){if(this.li.hasAnyProperData){const t=new De("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&q.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),t}throw new Fe("No alphaTex data found")}Xt.consolidate(this.li.score),this.li.score.finish(this.settings),Xt.trimEmptyBarsAtEnd(this.li.score),this.li.score.rebuildRepeatGroups(),this.li.score.applyFlatSyncPoints(this.li.syncPoints);for(const[t,e]of this.li.lyrics)this.li.score.tracks[t].applyLyrics(e);for(const[t,e]of this.li.sustainPedalToBeat)if(t.ratioPosition<1){const s=e.voice.bar.masterBar.calculateDuration();t.ratioPosition=e.playbackStart/s}return this.li.score}ui(){this.li.score=new $t,this.di()}di(){this.li.currentTrack=new Pe,this.li.currentTrack.ensureStaveCount(1),this.li.currentTrack.playbackInfo.program=25,this.li.currentTrack.playbackInfo.primaryChannel=this.li.trackChannel++,this.li.currentTrack.playbackInfo.secondaryChannel=this.li.trackChannel++;const t=this.li.currentTrack.staves[0];t.displayTranspositionPitch=0,t.stringTuning=xe.getDefaultTuningFor(6),this.li.articulationUniqueIdToIndex.clear(),this.fi(t),this.li.score.addTrack(this.li.currentTrack),this.li.lyrics.set(this.li.currentTrack.index,[]),this.li.currentDynamics=n.F,this.li.currentTupletDenominator=-1,this.li.currentTupletNumerator=-1}fi(t){this.li.currentStaff&&(this.pi(this.li.currentStaff),this.bi(this.li.currentStaff)),this.li.currentStaff=t,this.li.slurs.clear(),this.li.barIndex=0,this.li.voiceIndex=0}_e(t){if(t.bars.length>0){let e=!1;for(const s of t.bars)switch(this.Te(s,e),this.state.voiceMode){case Nt.StaffWise:this.li.barIndex++,e=!0;break;case Nt.BarWise:s.pipe&&(this.li.barIndex++,this.li.voiceIndex=0,this.li.ignoredInitialVoice=!1,e=!0)}}else this.mi(this.li.currentStaff),this.pi(this.li.currentStaff),this.bi(this.li.currentStaff)}Te(t,e){const s=this.gi(t,e);this.pi(this.li.currentStaff),this.bi(this.li.currentStaff),0===s.index&&this.li.staffInitialClef.has(this.li.currentStaff)&&(s.clef=this.li.staffInitialClef.get(this.li.currentStaff));const i=s.voices[this.li.voiceIndex];for(const e of t.beats)this.Ne(i,e);if(0===i.beats.length){const t=new se;t.isEmpty=!0,i.addBeat(t)}}Ne(t,e){if(e.durationChange&&this.Ee(e.durationChange),!e.notes&&!e.rest)return;const s=new se;if(t.addBeat(s),e.notes)for(const t of e.notes.notes)this.Le(s,t);else e.rest;e.durationValue&&(this.li.currentDuration=this.wi(e.durationValue)),s.duration=this.li.currentDuration,s.dynamics=this.li.currentDynamics,-1===this.li.currentTupletNumerator||s.hasTuplet||(s.tupletNumerator=this.li.currentTupletNumerator,s.tupletDenominator=this.li.currentTupletDenominator);let i=1;void 0!==e.beatMultiplierValue&&(i=e.beatMultiplierValue.value),e.beatEffects&&this.yi(s,e.beatEffects);for(let e=0;e<i-1;e++)t.addBeat(oe.clone(s))}yi(t,e){for(const s of e.properties){switch(this.ci.applyBeatProperty(this,t,s)){case Ft.Applied:case Ft.NotAppliedSemanticError:this.li.hasAnyProperData=!0;break;case Ft.NotAppliedUnrecognizedMarker:const t=Array.from(this.ci.knownBeatProperties).join(",");this.addSemanticDiagnostic({code:Mt.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${t}`,severity:xt.Error,start:s.start,end:s.end})}}}Ee(t){if(t.value&&(this.li.currentDuration=this.wi(t.value)),this.li.currentTupletNumerator=-1,this.li.currentTupletDenominator=-1,t.properties)for(const e of t.properties.properties){switch(this.ci.applyBeatDurationProperty(this,e)){case Ft.Applied:case Ft.NotAppliedSemanticError:this.li.hasAnyProperData=!0;break;case Ft.NotAppliedUnrecognizedMarker:const t=Array.from(this.ci.knownBeatDurationProperties).join(",");this.addSemanticDiagnostic({code:Mt.AT212,message:`Unrecogized property '${e.property.text}', expected one of ${t}`,severity:xt.Error,start:e.start,end:e.end})}}}wi(t){switch(t.value){case-4:return l.QuadrupleWhole;case-2:return l.DoubleWhole;case 1:return l.Whole;case 2:return l.Half;case 4:return l.Quarter;case 8:return l.Eighth;case 16:return l.Sixteenth;case 32:return l.ThirtySecond;case 64:return l.SixtyFourth;case 128:return l.OneHundredTwentyEighth;case 256:return l.TwoHundredFiftySixth;default:return this.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected duration value '${t.value}', expected: -4, -2, 1, 2, 4, 8, 16, 32, 64, 128 or 256`,severity:xt.Error,start:t.start,end:t.end}),this.li.currentDuration}}Le(t,e){let s=!1,i=!1,n=-1,r="",a=-1,h=-1,o=b.Default;const c=e.noteValue;let l,u=this.li.staffNoteKind.has(this.li.currentStaff)?this.li.staffNoteKind.get(this.li.currentStaff):void 0;switch(c.nodeType){case Tt.Number:n=c.value,l=void 0!==e.noteString?Pt.Fretted:Pt.Articulation;break;case Tt.String:case Tt.Ident:const t=c.text;if(s="x"===t,i="-"===t,i||s)n=0,l=e.noteStringDot&&e.noteString?Pt.Fretted:void 0;else{const e=Xt.parseTuning(t);if(e)l=Pt.Pitched,a=e.octave,h=e.tone.noteValue,this.li.accidentalMode===vt.Explicit&&(o=e.tone.accidentalMode);else{l=Pt.Articulation;const e=t.toLowerCase(),s=this.li.percussionArticulationNames;if(void 0===u&&0===s.size)for(const[t,e]of qt.instrumentArticulationNames){qt.getInstrumentArticulationByUniqueId(e)&&(s.set(t.toLowerCase(),e),s.set(Xt.toArticulationId(t),e))}if(!s.has(e))return this.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected percussion articulation value '${e}', expected: oneOf(${Array.from(this.li.percussionArticulationNames.keys()).join(",")}).`,severity:xt.Error,start:c.start,end:c.end}),void(r=Array.from(qt.instrumentArticulationNames.values())[0]);r=s.get(e)}}}void 0!==l?void 0===u?(u=l,this.applyStaffNoteKind(this.li.currentStaff,u)):u!==l&&this.addSemanticDiagnostic({code:Mt.AT218,message:`Wrong note kind '${Pt[l]}' for staff with note kind ''${Pt[u]}'. Do not mix incompatible staves and notes.`,severity:xt.Error,start:c.start,end:c.end}):void 0!==u&&(l=u);const d=new Qt;if(d.isDead=s,(s||i)&&(d.fret=n),d.isTieDestination=i,void 0!==l&&l===u)switch(l){case Pt.Pitched:d.octave=a,d.tone=h,d.accidentalMode=o;break;case Pt.Fretted:if(!e.noteString)return void this.addSemanticDiagnostic({code:Mt.AT207,message:"Missing string for fretted note.",severity:xt.Error,start:c.end,end:c.end});const t=e.noteString.value;if(t<1||t>this.li.currentStaff.tuning.length)return void this.addSemanticDiagnostic({code:Mt.AT208,message:`Note string is out of range. Available range: 1-${this.li.currentStaff.tuning.length}`,severity:xt.Error,start:c.end,end:c.end});d.string=this.li.currentStaff.tuning.length-(t-1),i||(d.fret=n);break;case Pt.Articulation:let s=0;if(0===r.length&&n>0){const t=qt.getArticulationById(n);t&&(r=t.uniqueId)}if(this.li.articulationUniqueIdToIndex.has(r))s=this.li.articulationUniqueIdToIndex.get(r);else{s=this.li.currentTrack.percussionArticulations.length;const t=qt.getInstrumentArticulationByUniqueId(r);if(null===t)return void this.addSemanticDiagnostic({code:Mt.AT209,message:`Unexpected articulation value '${n}', expected: oneOf(${Array.from(qt.instrumentArticulations.keys()).join(",")}).`,severity:xt.Error,start:c.end,end:c.end});this.li.currentTrack.percussionArticulations.push(t),this.li.articulationUniqueIdToIndex.set(r,s)}d.percussionArticulation=s}t.addNote(d),this.li.hasAnyProperData=!0,e.noteEffects&&this.ki(d,e.noteEffects)}getStaffNoteKind(t){return this.li.staffNoteKind.has(t)?this.li.staffNoteKind.get(t):void 0}applyStaffNoteKind(t,e){switch(this.li.staffNoteKind.set(t,e),e){case Pt.Pitched:t.isPercussion=!1,t.stringTuning.reset(),this.li.staffHasExplicitDisplayTransposition.has(t)||(t.displayTranspositionPitch=0);break;case Pt.Fretted:t.isPercussion=!1,this.pi(t),this.bi(t);break;case Pt.Articulation:t.isPercussion=!0,t.stringTuning.reset(),this.li.staffHasExplicitDisplayTransposition.has(t)||(t.displayTranspositionPitch=0)}}ki(t,e){for(const s of e.properties){let e=this.ci.applyNoteProperty(this,t,s);switch(e===Ft.NotAppliedUnrecognizedMarker&&(e=this.ci.applyBeatProperty(this,t.beat,s)),e){case Ft.Applied:case Ft.NotAppliedSemanticError:break;case Ft.NotAppliedUnrecognizedMarker:const t=Array.from(this.ci.knownNoteProperties).concat(Array.from(this.ci.knownBeatProperties)).join(",");this.addSemanticDiagnostic({code:Mt.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${t}`,severity:xt.Error,start:s.start,end:s.end})}}}bi(t){if(!this.li.staffDisplayTranspositionApplied.has(t)&&!this.li.staffHasExplicitDisplayTransposition.has(t)){const e=t.track.playbackInfo.program;Xt.displayTranspositionPitches.has(e)?t.displayTranspositionPitch=Xt.displayTranspositionPitches.get(e):this.li.currentStaff.displayTranspositionPitch=0,this.li.staffDisplayTranspositionApplied.add(t)}}pi(t){const e=t.track.playbackInfo.program;this.li.staffTuningApplied.has(t)||this.li.staffHasExplicitTuning.has(t)||(t.stringTuning.reset(),15===e||e>=24&&e<=31?t.stringTuning.tunings=xe.getDefaultTuningFor(6).tunings:e>=32&&e<=39?(t.stringTuning.tunings=[43,38,33,28],this.li.staffInitialClef.set(t,M.F4)):40===e||44===e||45===e||48===e||49===e||50===e||51===e?t.stringTuning.tunings=[52,57,50,43]:41===e?t.stringTuning.tunings=[57,50,43,36]:42===e?t.stringTuning.tunings=[45,38,31,24]:43===e?t.stringTuning.tunings=[43,38,33,28]:105===e?t.stringTuning.tunings=[50,47,43,38,55]:106===e?t.stringTuning.tunings=[57,52,45]:107===e?t.stringTuning.tunings=[52,45,38,31]:110===e?t.stringTuning.tunings=[64,57,50,43]:this.li.staffNoteKind.has(t)&&this.li.staffNoteKind.get(t)===Pt.Fretted&&(t.stringTuning=xe.getDefaultTuningFor(6)),this.li.staffTuningApplied.add(t))}gi(e,s){let i=this.li.score.masterBars.length>0?void 0:[],n=this.li.currentStaff,r=!1,a=!1,h=!1,o=!1;const c=()=>{i&&(i=void 0,n=this.li.currentStaff,r=!1,a=!1,h=!1,o=!1)},l=new j(()=>{h||s||this.li.barIndex++;const t=this.mi(this.li.currentStaff);if(i){for(const e of i)this.ci.applyBarMetaData(this,t,e);c()}return t});for(const s of e.metaData){const e=s.tag.tag.text.toLowerCase();if(this.ci.knownStructuralMetaDataTags.has(e)){this.li.hasAnyProperData=!0;switch(this.ci.applyStructuralMetaData(this,s)){case At.AppliedNewTrack:a||r?o=!0:(r=!0,n=this.li.currentStaff),l.reset();break;case At.AppliedNewStaff:a?o=!0:(a=!0,n=this.li.currentStaff),l.reset();break;case At.AppliedNewVoice:h=!0}if(i&&o){if(0!==n.bars.length)throw new G(t.AlphaTabErrorType.AlphaTex,"Unexpected internal error, didn't expect a filled staff after multiple \\track and/or \\staff tags. Please report this problem providing the input alphaTex.");{const t=new Z;n.addBar(t);const e=new at;if(t.addVoice(e),n.bars.length>this.li.score.masterBars.length){const t=new et;this.li.score.addMasterBar(t)}for(const e of i)this.ci.applyBarMetaData(this,t,e);c()}}}else if(this.ci.knownScoreMetaDataTags.has(s.tag.tag.text.toLowerCase()))this.li.hasAnyProperData=!0,this.ci.applyScoreMetaData(this,this.li.score,s);else if(this.ci.knownStaffMetaDataTags.has(s.tag.tag.text.toLowerCase()))this.li.hasAnyProperData=!0,this.ci.applyStaffMetaData(this,this.li.currentStaff,s);else if(this.ci.knownBarMetaDataTags.has(s.tag.tag.text.toLowerCase()))this.li.hasAnyProperData=!0,i?i.push(s):this.ci.applyBarMetaData(this,l.value,s);else{const t=Array.from(this.ci.allKnownMetaDataTags).join(",");this.addSemanticDiagnostic({code:Mt.AT204,message:`Unrecognized metadata '${s.tag.tag.text}', expected one of: ${t}`,severity:xt.Error,start:s.tag.start,end:s.tag.end})}}return l.value}mi(t){if(this.li.barIndex<t.bars.length){return t.bars[this.li.barIndex]}const e=0===t.bars.length?this.li.voiceIndex+1:t.bars[0].voices.length,s=new Z;t.addBar(s),s.previousBar&&(s.clef=s.previousBar.clef,s.clefOttava=s.previousBar.clefOttava,s.keySignature=s.previousBar.keySignature,s.keySignatureType=s.previousBar.keySignatureType),this.li.barIndex=s.index,s.index>0&&(s.clef=s.previousBar.clef);for(let t=0;t<e;t++){const t=new at;s.addVoice(t)}if(this.li.currentStaff.bars.length>this.li.score.masterBars.length){const t=new et;this.li.score.addMasterBar(t),t.index>0&&(t.timeSignatureDenominator=t.previousMasterBar.timeSignatureDenominator,t.timeSignatureNumerator=t.previousMasterBar.timeSignatureNumerator,t.tripletFeel=t.previousMasterBar.tripletFeel)}return s}startNewStaff(){if(this.li.ignoredInitialVoice=!1,this.li.ignoredInitialStaff||this.li.currentTrack.staves[0].bars.length>0){const t=this.li.currentStaff.isPercussion;this.li.currentTrack.ensureStaveCount(this.li.currentTrack.staves.length+1);const e=this.li.currentTrack.staves[this.li.currentTrack.staves.length-1];this.fi(e),t&&this.applyPercussionStaff(this.li.currentStaff),this.li.currentDynamics=n.F}else this.li.ignoredInitialStaff=!0;return this.li.currentStaff}applyPercussionStaff(t){t.isPercussion=!0,t.showTablature=!1,t.track.playbackInfo.program=0}startNewTrack(){return this.li.ignoredInitialVoice=!1,this.li.ignoredInitialStaff=!1,this.li.ignoredInitialTrack||this.li.score.masterBars.length>0?this.di():this.li.ignoredInitialTrack=!0,this.li.currentTrack}startNewVoice(){let t=0===this.li.voiceIndex&&!this.li.ignoredInitialVoice;if(t)if(0===this.li.currentStaff.bars.length)t=!0;else switch(this.li.voiceMode){case Nt.StaffWise:t=1===this.li.currentStaff.bars.length&&this.li.currentStaff.bars[0].isEmpty;break;case Nt.BarWise:if(this.li.barIndex<this.li.currentStaff.bars.length){t=this.li.currentStaff.bars[this.li.barIndex].voices[0].isEmpty}else t=!0}if(t)this.li.ignoredInitialVoice=!0;else{switch(this.li.voiceMode){case Nt.StaffWise:this.li.voiceIndex++,this.li.barIndex=0,this.li.currentTupletDenominator=-1,this.li.currentTupletNumerator=-1;break;case Nt.BarWise:this.li.voiceIndex++,this.li.currentTupletDenominator=-1,this.li.currentTupletNumerator=-1}for(const t of this.li.currentStaff.bars)for(;t.voices.length<=this.li.voiceIndex;)t.addVoice(new at)}}}let Re=class{};class Ie extends Re{n;constructor(t){super(),this.n=t}}class Oe extends Re{left;right;constructor(t,e){super(),this.left=t,this.right=e}}class Ge extends Re{n;table;constructor(t,e){super(),this.n=t,this.table=e}}class Ve{static make(t,e,s,i){const n=[],r=[];if(i>32)throw new ke("Invalid huffman");for(let t=0;t<i;t++)n.push(0),r.push(0);for(let r=0;r<s;r++){const s=t[r+e];if(s>=i)throw new ke("Invalid huffman");n[s]++}let a=0;for(let t=1;t<i-1;t++)a=a+n[t]<<1,r[t]=a;const h=new Map;for(let i=0;i<s;i++){const s=t[i+e];if(0!==s){const t=r[s-1];r[s-1]=t+1,h.set(t<<5|s,i)}}return Ve.Si(new Oe(Ve.Bi(h,i,0,1),Ve.Bi(h,i,1,1)))}static Bi(t,e,s,i){if(i>e)throw new ke("Invalid huffman");const n=s<<5|i;return t.has(n)?new Ie(t.get(n)):(s<<=1,i+=1,new Oe(Ve.Bi(t,e,s,i),Ve.Bi(t,e,1|s,i)))}static Si(t){const e=Ve._i(t);if(0===e)return t;if(1===e){if(t instanceof Oe)return new Oe(Ve.Si(t.left),Ve.Si(t.right));throw new ke("assert")}const s=1<<e,i=[];for(let t=0;t<s;t++)i.push(new Ie(-1));return Ve.Ti(i,0,0,e,t),new Ge(e,i)}static Ti(t,e,s,i,n){n instanceof Oe&&i>0?(Ve.Ti(t,e,s+1,i-1,n.left),Ve.Ti(t,e|1<<s,s+1,i-1,n.right)):t[e]=Ve.Si(n)}static _i(t){if(t instanceof Ie)return 0;if(t instanceof Ge)throw new ke("assert");if(t instanceof Oe){const e=Ve._i(t.left),s=Ve._i(t.right);return 1+(e<s?e:s)}return 0}}var $e,He,Ue,ze,Xe,je,Je,qe,Ye,Ke,Qe,Ze,ts,es,ss,is,ns,rs,as,hs,os,cs,ls,us,ds,fs,ps,bs,ms,gs;!function(t){t[t.Head=0]="Head",t[t.Block=1]="Block",t[t.CData=2]="CData",t[t.Flat=3]="Flat",t[t.Crc=4]="Crc",t[t.Dist=5]="Dist",t[t.DistOne=6]="DistOne",t[t.Done=7]="Done"}($e||($e={}));class ws{static xi=32768;static Ni=65536;buffer=new Uint8Array(ws.Ni);pos=0;slide(){const t=new Uint8Array(ws.Ni);this.pos-=ws.xi,t.set(this.buffer.subarray(ws.xi,ws.xi+this.pos),0),this.buffer=t}addBytes(t,e,s){this.pos+s>ws.Ni&&this.slide(),this.buffer.set(t.subarray(e,e+s),this.pos),this.pos+=s}addByte(t){this.pos===ws.Ni&&this.slide(),this.buffer[this.pos]=t,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}}class ys{static Pi=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1];static Ci=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258];static Ei=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1];static Fi=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577];static Ai=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];static Di=ys.Li();static Li(){const t=[];for(let e=0;e<288;e++)t.push(e<=143?8:e<=255?9:e<=279?7:8);return Ve.make(t,0,288,10)}Wi=0;Ri=0;li=$e.Block;Oi=!1;Gi=ys.Di;Vi=null;$i=0;Hi=0;Ui=0;zi=null;Xi=0;ji;Ji=[];qi=new ws;constructor(t){this.ji=t;for(let t=0;t<19;t++)this.Ji.push(-1)}readBytes(t,e,s){if(this.Ui=s,this.Xi=e,this.zi=t,s>0)for(;this.Yi(););return s-this.Ui}Yi(){switch(this.li){case $e.Head:const t=this.ji.readByte();if(8!==(15&t))throw new ke("Invalid data");const e=this.ji.readByte(),s=!!(32&e);if(((t<<8)+e)%31!=0)throw new ke("Invalid data");if(s)throw new ke("Unsupported dictionary");return this.li=$e.Block,!0;case $e.Crc:return this.li=$e.Done,!0;case $e.Done:return!1;case $e.Block:switch(this.Oi=this.Ki(),this.Qi(2)){case 0:this.$i=fe.readUInt16LE(this.ji);if(fe.readUInt16LE(this.ji)!==65535-this.$i)throw new ke("Invalid data");this.li=$e.Flat;const t=this.Yi();return this.Zi(),t;case 1:return this.Gi=ys.Di,this.Vi=null,this.li=$e.CData,!0;case 2:const e=this.Qi(5)+257,s=this.Qi(5)+1,i=this.Qi(4)+4;for(let t=0;t<i;t++)this.Ji[ys.Ai[t]]=this.Qi(3);for(let t=i;t<19;t++)this.Ji[ys.Ai[t]]=0;this.Gi=Ve.make(this.Ji,0,19,8);const n=[];for(let t=0;t<e+s;t++)n.push(0);return this.tn(n,e+s),this.Vi=Ve.make(n,e,s,16),this.Gi=Ve.make(n,0,e,16),this.li=$e.CData,!0;default:throw new ke("Invalid data")}case $e.Flat:{const t=this.$i<this.Ui?this.$i:this.Ui,e=fe.readByteArray(this.ji,t);return this.$i-=t,this.en(e,0,t),0===this.$i&&(this.li=this.Oi?$e.Crc:$e.Block),this.Ui>0}case $e.DistOne:{const t=this.$i<this.Ui?this.$i:this.Ui;return this.sn(t),this.$i-=t,0===this.$i&&(this.li=$e.CData),this.Ui>0}case $e.Dist:for(;this.$i>0&&this.Ui>0;){const t=this.$i<this.Hi?this.$i:this.Hi,e=this.Ui<t?this.Ui:t;this.nn(this.Hi,e),this.$i-=e}return 0===this.$i&&(this.li=$e.CData),this.Ui>0;case $e.CData:let i=this.rn(this.Gi);if(i<256)return this.an(i),this.Ui>0;if(256===i)return this.li=this.Oi?$e.Crc:$e.Block,!0;i=i-257&255;let n=ys.Pi[i];if(-1===n)throw new ke("Invalid data");this.$i=ys.Ci[i]+this.Qi(n);const r=this.Vi,a=r?this.rn(r):this.hn(5);if(n=ys.Ei[a],-1===n)throw new ke("Invalid data");if(this.Hi=ys.Fi[a]+this.Qi(n),this.Hi>this.qi.available())throw new ke("Invalid data");return this.li=1===this.Hi?$e.DistOne:$e.Dist,!0}return!1}sn(t){const e=this.qi.getLastChar();for(let s=0;s<t;s++)this.an(e)}an(t){this.qi.addByte(t),this.zi[this.Xi]=t,this.Ui--,this.Xi++}nn(t,e){this.en(this.qi.buffer,this.qi.pos-t,e)}Ki(){0===this.Wi&&(this.Wi=8,this.Ri=this.ji.readByte());const t=!(1&~this.Ri);return this.Wi--,this.Ri=this.Ri>>1,t}Qi(t){for(;this.Wi<t;)this.Ri=this.Ri|this.ji.readByte()<<this.Wi,this.Wi+=8;const e=this.Ri&(1<<t)-1;return this.Wi-=t,this.Ri=this.Ri>>t,e}hn(t){return 0===t?0:this.Ki()?1<<t-1|this.hn(t-1):this.hn(t-1)}Zi(){this.Ri=0,this.Wi=0}en(t,e,s){this.qi.addBytes(t,e,s),this.zi.set(t.subarray(e,e+s),this.Xi),this.Ui-=s,this.Xi+=s}tn(t,e){let s=0,i=0;for(;s<e;){const n=this.rn(this.Gi);switch(n){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:i=n,t[s]=n,s++;break;case 16:const r=s+3+this.Qi(2);if(r>e)throw new ke("Invalid data");for(;s<r;)t[s]=i,s++;break;case 17:if(s+=3+this.Qi(3),s>e)throw new ke("Invalid data");break;case 18:if(s+=11+this.Qi(7),s>e)throw new ke("Invalid data");break;default:throw new ke("Invalid data")}}}rn(t){if(t instanceof Ie)return t.n;if(t instanceof Oe)return this.rn(this.Ki()?t.right:t.left);if(t instanceof Ge)return this.rn(t.table[this.Qi(t.n)]);throw new ke("Invalid data")}}class ks{static OptionalDataDescriptorSignature=134695760;static CompressionMethodDeflate=8;static LocalFileHeaderSignature=67324752;static CentralFileHeaderSignature=33639248;static EndOfCentralDirSignature=101010256;fullName;fileName;data;constructor(t,e){this.fullName=t;const s=t.lastIndexOf("/");this.fileName=-1===s||s===t.length-1?this.fullName:t.substr(s+1),this.data=e}}class Ss{cn;constructor(t){this.cn=t}read(){const t=[];for(;;){const e=this.ln();if(!e)break;t.push(e)}return t}ln(){const t=this.cn;if(fe.readInt32LE(t)!==ks.LocalFileHeaderSignature)return null;fe.readUInt16LE(t);const e=fe.readUInt16LE(t),s=fe.readUInt16LE(t),i=0!==s;if(i&&s!==ks.CompressionMethodDeflate)return null;fe.readInt16LE(this.cn),fe.readInt16LE(this.cn),fe.readInt32LE(t),fe.readInt32LE(t);const n=fe.readInt32LE(t),r=fe.readInt16LE(t),a=fe.readInt16LE(t),h=fe.toString(fe.readByteArray(t,r),"utf-8");let o;if(t.skip(a),i){const t=Ae.empty(),e=new ys(this.cn),s=new Uint8Array(65536);for(;;){const i=e.readBytes(s,0,s.length);if(t.write(s,0,i),i<s.length)break}o=t.toArray()}else o=fe.readByteArray(this.cn,n);if(8&e){fe.readInt32LE(this.cn)===ks.OptionalDataDescriptorSignature&&fe.readInt32LE(this.cn),fe.readInt32LE(this.cn),fe.readInt32LE(this.cn)}return new ks(h,o)}}!function(t){t[t.None=0]="None",t[t.Element=1]="Element",t[t.Text=2]="Text",t[t.CDATA=3]="CDATA",t[t.Document=4]="Document",t[t.DocumentType=5]="DocumentType",t[t.Comment=6]="Comment"}(He||(He={}));class Bs{nodeType=He.None;localName=null;value=null;childNodes=[];attributes=new Map;firstChild=null;firstElement=null;*childElements(){for(const t of this.childNodes)t.nodeType===He.Element&&(yield t)}addChild(t){this.childNodes.push(t),this.firstChild=t,t.nodeType!==He.Element&&t.nodeType!==He.CDATA||(this.firstElement=t)}getAttribute(t,e=""){return this.attributes.has(t)?this.attributes.get(t):e}getElementsByTagName(t,e=!1){const s=[];return this.un(this.childNodes,s,t,e),s}un(t,e,s,i=!1){for(const n of t)n&&n.nodeType===He.Element&&n.localName===s&&e.push(n),i&&this.un(n.childNodes,e,s,!0)}findChildElement(t){for(const e of this.childNodes)if(e&&e.nodeType===He.Element&&e.localName===t)return e;return null}addElement(t){const e=new Bs;return e.nodeType=He.Element,e.localName=t,this.addChild(e),e}get innerText(){if(this.nodeType===He.Element||this.nodeType===He.Document){if(this.firstElement&&this.firstElement.nodeType===He.CDATA)return this.firstElement.innerText;let t="";for(const e of this.childNodes)t+=e.innerText?.toString();return t.trim()}return this.value??""}set innerText(t){const e=new Bs;e.nodeType=He.Text,e.value=t,this.childNodes=[e]}setCData(t){const e=new Bs;e.nodeType=He.CDATA,e.value=t,this.childNodes=[e]}}class _s extends G{xml;pos=0;constructor(e,s,i){super(t.AlphaTabErrorType.Format,e),this.xml=s,this.pos=i}}!function(t){t[t.IgnoreSpaces=0]="IgnoreSpaces",t[t.Begin=1]="Begin",t[t.BeginNode=2]="BeginNode",t[t.TagName=3]="TagName",t[t.Body=4]="Body",t[t.AttribName=5]="AttribName",t[t.Equals=6]="Equals",t[t.AttvalBegin=7]="AttvalBegin",t[t.AttribVal=8]="AttribVal",t[t.Childs=9]="Childs",t[t.Close=10]="Close",t[t.WaitEnd=11]="WaitEnd",t[t.WaitEndRet=12]="WaitEndRet",t[t.Pcdata=13]="Pcdata",t[t.Header=14]="Header",t[t.Comment=15]="Comment",t[t.Doctype=16]="Doctype",t[t.Cdata=17]="Cdata",t[t.Escape=18]="Escape"}(Ue||(Ue={}));class Ts{static CharCodeLF=10;static CharCodeTab=9;static CharCodeCR=13;static CharCodeSpace=32;static CharCodeLowerThan=60;static CharCodeAmp=38;static CharCodeBrackedClose=93;static CharCodeBrackedOpen=91;static CharCodeGreaterThan=62;static CharCodeExclamation=33;static CharCodeUpperD=68;static CharCodeLowerD=100;static CharCodeMinus=45;static CharCodeQuestion=63;static CharCodeSlash=47;static CharCodeEquals=61;static CharCodeDoubleQuote=34;static CharCodeSingleQuote=39;static CharCodeSharp=35;static CharCodeLowerX=120;static CharCodeLowerA=97;static CharCodeLowerZ=122;static CharCodeUpperA=65;static CharCodeUpperZ=90;static CharCode0=48;static CharCode9=57;static CharCodeColon=58;static CharCodeDot=46;static CharCodeUnderscore=95;static CharCodeSemi=59;static dn=new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]);static parse(t,e,s){let i=t.charCodeAt(e),n=Ue.Begin,r=Ue.Begin,a=0,h="",o=Ue.Begin,c=null,l=null,u=0,d=0;for(;e<t.length;){switch(i=t.charCodeAt(e),n){case Ue.IgnoreSpaces:switch(i){case Ts.CharCodeLF:case Ts.CharCodeCR:case Ts.CharCodeTab:case Ts.CharCodeSpace:break;default:n=r;continue}break;case Ue.Begin:if(i!==Ts.CharCodeLowerThan){a=e,n=Ue.Pcdata;continue}n=Ue.IgnoreSpaces,r=Ue.BeginNode;break;case Ue.Pcdata:if(i===Ts.CharCodeLowerThan){h+=t.substr(a,e-a);const i=new Bs;i.nodeType=He.Text,i.value=h,h="",s.addChild(i),n=Ue.IgnoreSpaces,r=Ue.BeginNode}else i===Ts.CharCodeAmp&&(h+=t.substr(a,e-a),n=Ue.Escape,o=Ue.Pcdata,a=e+1);break;case Ue.Cdata:if(i===Ts.CharCodeBrackedClose&&t.charCodeAt(e+1)===Ts.CharCodeBrackedClose&&t.charCodeAt(e+2)===Ts.CharCodeGreaterThan){const i=new Bs;i.nodeType=He.CDATA,i.value=t.substr(a,e-a),s.addChild(i),e+=2,n=Ue.Begin}break;case Ue.BeginNode:switch(i){case Ts.CharCodeExclamation:if(t.charCodeAt(e+1)===Ts.CharCodeBrackedOpen){if(e+=2,"CDATA["!==t.substr(e,6).toUpperCase())throw new _s("Expected <![CDATA[",t,e);e+=5,n=Ue.Cdata,a=e+1}else if(t.charCodeAt(e+1)===Ts.CharCodeUpperD||t.charCodeAt(e+1)===Ts.CharCodeLowerD){if("OCTYPE"!==t.substr(e+2,6).toUpperCase())throw new _s("Expected <!DOCTYPE",t,e);e+=8,n=Ue.Doctype,a=e+1}else{if(t.charCodeAt(e+1)!==Ts.CharCodeMinus||t.charCodeAt(e+2)!==Ts.CharCodeMinus)throw new _s("Expected \x3c!--",t,e);e+=2,n=Ue.Comment,a=e+1}break;case Ts.CharCodeQuestion:n=Ue.Header,a=e;break;case Ts.CharCodeSlash:if(!s)throw new _s("Expected node name",t,e);a=e+1,n=Ue.IgnoreSpaces,r=Ue.Close;break;default:n=Ue.TagName,a=e;continue}break;case Ue.TagName:if(!Ts.pn(i)){if(e===a)throw new _s("Expected node name",t,e);c=new Bs,c.nodeType=He.Element,c.localName=t.substr(a,e-a),s.addChild(c),n=Ue.IgnoreSpaces,r=Ue.Body;continue}break;case Ue.Body:switch(i){case Ts.CharCodeSlash:n=Ue.WaitEnd;break;case Ts.CharCodeGreaterThan:n=Ue.Childs;break;default:n=Ue.AttribName,a=e;continue}break;case Ue.AttribName:if(!Ts.pn(i)){if(a===e)throw new _s("Expected attribute name",t,e);if(l=t.substr(a,e-a),c.attributes.has(l))throw new _s(`Duplicate attribute [${l}]`,t,e);n=Ue.IgnoreSpaces,r=Ue.Equals;continue}break;case Ue.Equals:if(i!==Ts.CharCodeEquals)throw new _s("Expected =",t,e);n=Ue.IgnoreSpaces,r=Ue.AttvalBegin;break;case Ue.AttvalBegin:switch(i){case Ts.CharCodeDoubleQuote:case Ts.CharCodeSingleQuote:h="",n=Ue.AttribVal,a=e+1,d=i}break;case Ue.AttribVal:if(i===Ts.CharCodeAmp)h+=t.substr(a,e-a),n=Ue.Escape,o=Ue.AttribVal,a=e+1;else if(i===d){h+=t.substr(a,e-a);const s=h;h="",c.attributes.set(l,s),n=Ue.IgnoreSpaces,r=Ue.Body}break;case Ue.Childs:a=e=Ts.parse(t,e,c),n=Ue.Begin;break;case Ue.WaitEnd:if(i!==Ts.CharCodeGreaterThan)throw new _s("Expected >",t,e);n=Ue.Begin;break;case Ue.WaitEndRet:if(i===Ts.CharCodeGreaterThan)return e;throw new _s("Expected >",t,e);case Ue.Close:if(!Ts.pn(i)){if(a===e)throw new _s("Expected node name",t,e);if(t.substr(a,e-a)!==s.localName)throw new _s(`Expected </${s.localName}>`,t,e);n=Ue.IgnoreSpaces,r=Ue.WaitEndRet;continue}break;case Ue.Comment:i===Ts.CharCodeMinus&&t.charCodeAt(e+1)===Ts.CharCodeMinus&&t.charCodeAt(e+2)===Ts.CharCodeGreaterThan&&(e+=2,n=Ue.Begin);break;case Ue.Doctype:if(i===Ts.CharCodeBrackedOpen)u++;else if(i===Ts.CharCodeBrackedClose)u--;else if(i===Ts.CharCodeGreaterThan&&0===u){const i=new Bs;i.nodeType=He.DocumentType,i.value=t.substr(a,e-a),s.addChild(i),n=Ue.Begin}break;case Ue.Header:i===Ts.CharCodeQuestion&&t.charCodeAt(e+1)===Ts.CharCodeGreaterThan&&(e++,n=Ue.Begin);break;case Ue.Escape:if(i===Ts.CharCodeSemi){const s=t.substr(a,e-a);if(s.charCodeAt(0)===Ts.CharCodeSharp){const t=s.charCodeAt(1)===Ts.CharCodeLowerX?Number.parseInt(`0${s.substr(1,s.length-1)}`,10):Number.parseInt(s.substr(1,s.length-1),10);h+=String.fromCharCode(t)}else Ts.dn.has(s)?h+=Ts.dn.get(s):h+=`&${s};`?.toString();a=e+1,n=o}else Ts.pn(i)||i===Ts.CharCodeSharp||(h+="&",h+=t.substr(a,e-a),a=--e+1,n=o)}e++}if(n===Ue.Begin&&(a=e,n=Ue.Pcdata),n===Ue.Pcdata){if(e!==a){h+=t.substr(a,e-a);const i=new Bs;i.nodeType=He.Text,i.value=h,s.addChild(i)}return e}if(n===Ue.Escape&&o===Ue.Pcdata){h+="&",h+=t.substr(a,e-a);const i=new Bs;return i.nodeType=He.Text,i.value=h,s.addChild(i),e}throw new _s("Unexpected end",t,e)}static pn(t){return t>=Ts.CharCodeLowerA&&t<=Ts.CharCodeLowerZ||t>=Ts.CharCodeUpperA&&t<=Ts.CharCodeUpperZ||t>=Ts.CharCode0&&t<=Ts.CharCode9||t===Ts.CharCodeColon||t===Ts.CharCodeDot||t===Ts.CharCodeUnderscore||t===Ts.CharCodeMinus}}class xs{bn=[];mn;gn;wn;yn;constructor(t,e){this.mn=t,this.gn=e,this.yn="",this.wn=!0}writeNode(t){switch(t.nodeType){case He.None:break;case He.Element:this.bn.length>0&&this.kn(),this.Sn(`<${t.localName}`);for(const[e,s]of t.attributes)this.Sn(` ${e}="`),this.Bn(s),this.Sn('"');if(0===t.childNodes.length)this.Sn("/>");else{if(this.Sn(">"),1!==t.childNodes.length||t.firstElement){this._n();for(const e of t.childNodes)e.nodeType!==He.Element&&e.nodeType!==He.Comment||this.writeNode(e);this.Tn(),this.kn()}else this.writeNode(t.childNodes[0]);this.Sn(`</${t.localName}>`)}break;case He.Text:t.value&&this.Sn(t.value);break;case He.CDATA:null!==t.value&&this.Sn(`<![CDATA[${t.value}]]>`);break;case He.Document:this.gn&&this.Sn('<?xml version="1.0" encoding="utf-8"?>');for(const e of t.childNodes)this.writeNode(e);break;case He.DocumentType:this.Sn(`<!DOCTYPE ${t.value}>`);break;case He.Comment:this.Sn(`\x3c!-- ${t.value} --\x3e`)}}Tn(){this.yn=this.yn.substr(0,this.yn.length-this.mn.length)}_n(){this.yn+=this.mn}Bn(t){for(let e=0;e<t.length;e++){const s=t.charAt(e);switch(s){case"<":this.bn.push("&lt;");break;case">":this.bn.push("&gt;");break;case"&":this.bn.push("&amp;");break;case"'":this.bn.push("&apos;");break;case'"':this.bn.push("&quot;");break;default:this.bn.push(s)}}}static write(t,e,s){const i=new xs(e,s);return i.writeNode(t),i.toString()}Sn(t){this.wn&&this.bn.push(this.yn),this.bn.push(t),this.wn=!1}kn(t=null){t&&this.Sn(t),this.mn.length>0&&!this.wn&&(this.bn.push("\n"),this.wn=!0)}toString(){return this.bn.join("").trimRight()}}class Ms extends Bs{constructor(){super(),this.nodeType=He.Document}parse(t){Ts.parse(t,0,this)}toString(){return this.toFormattedString()}toFormattedString(t="",e=!1){return xs.write(this,t,e)}}class vs{noteRange=1;x=0;y=0}!function(t){t[t.None=0]="None",t[t.Rectangle=1]="Rectangle",t[t.Ellipse=2]="Ellipse",t[t.Circle=3]="Circle"}(ze||(ze={}));class Ns extends vs{align=ht.Left;frame=ze.None;text="";fontFace="";weight=0;height=0}class Ps extends vs{chord=new ye}class Cs extends vs{}class Es extends vs{}class Fs extends vs{number=0}class As extends vs{decrescendo=!1}class Ds extends vs{allNumbers=!1;firstNumber=0;lastNumber=0}class Ls extends vs{octave=1}class Ws extends vs{}class Rs{defaultClef=M.G2;description="";percussion=!1;instrument=0;volume=0;transpose=0;index=0}class Is{from=0;to=0;curly=!1}class Os{currentBarIndex=-1;currentBarComplete=!0;currentBarDuration=0;currentPosition=0;voiceStemDir=null;repeatCount=0;repeatEnd=null}class Gs{score;xn=0;Mn=Bt.Auto;vn;Nn;Pn=!0;Cn=-1;parseXml(t,e){this.vn=new Map,this.En=[],this.Fn=new Map,this.Nn=new Map,this.An=new Map,this.Dn=new Map,this.Pn=!0;const s=new Ms;try{s.parse(t)}catch(t){throw new Fe("Could not parse XML",t)}this.Ln(s),this.Wn(),this.score.finish(e)}Wn(){Xt.consolidate(this.score),Gs.Rn(this.An,(t,e)=>{e.isLegatoOrigin=!0}),Gs.Rn(this.Dn,(t,e)=>{e.crescendo=t.decrescendo?c.Decrescendo:c.Crescendo})}static Rn(t,e){for(const[s,i]of t){const t=i.noteRange;let n=s;for(let s=0;s<t;s++)if(e(i,n),n.index+1<n.voice.beats.length)n=n.voice.beats[n.index+1];else{if(!(n.voice.bar.index+1<n.voice.bar.staff.bars.length))break;n=n.voice.bar.staff.bars[n.voice.bar.index+1].voices[n.voice.index].beats[0]}}}Ln(t){const e=t.firstElement;if(!e)throw new Fe("No valid XML");if("score"!==e.localName)throw new Fe('Root node of XML was not "score"');this.score=new $t;for(const t of e.childElements())switch(t.localName){case"info":this.In(t);break;case"layout":this.On(t);break;case"gallery":this.Gn(t);break;case"pageObjects":this.Vn(t);break;case"systems":this.$n(t)}}Hn=new Map;On(t){for(const e of t.childElements())switch(e.localName){case"staves":this.Un(e);break;case"brackets":this.zn(e)}const e=this.Xn.filter(t=>!!t.curly);e.sort((t,e)=>t.from-e.from);let s=0,i=null;for(let t=0;t<this.jn.length;t++){const n=this.jn[t];for(;s<e.length&&t>e[s].to;)s++;i&&s<e.length&&t>e[s].from&&t<=e[s].to?i.ensureStaveCount(i.staves.length+1):(i=new Pe,i.ensureStaveCount(1),i.name=n.description,i.playbackInfo.volume=Math.floor(n.volume/128*16),i.playbackInfo.program=n.instrument,n.percussion?(i.playbackInfo.primaryChannel=9,i.playbackInfo.secondaryChannel=9):(i.playbackInfo.primaryChannel=this.xn++,i.playbackInfo.secondaryChannel=this.xn++),this.score.addTrack(i));const r=i.staves[i.staves.length-1];r.isPercussion=n.percussion,r.transpositionPitch=n.transpose,r.displayTranspositionPitch=0,r.showTablature=!1,this.Hn.set(n.index,r)}}Xn=[];zn(t){for(const e of t.childElements())if("bracket"===e.localName)this.Jn(e)}Jn(t){const e=new Is;e.from=Number.parseInt(t.getAttribute("from"),10),e.to=Number.parseInt(t.getAttribute("to"),10),t.attributes.has("curly")&&(e.curly="true"===t.attributes.get("curly")),this.Xn.push(e)}Un(t){for(const e of t.childElements())if("staffLayout"===e.localName)this.qn(e)}Yn=new Map;jn=[];qn(t){const e=new Rs;e.description=t.getAttribute("description");for(const s of t.childElements())switch(s.localName){case"notation":s.attributes.has("defaultClef")&&(e.defaultClef=this.Kn(s.attributes.get("defaultClef")));break;case"sound":s.attributes.has("percussion")&&(e.percussion="true"===s.attributes.get("percussion")),s.attributes.has("instr")&&(e.instrument=Number.parseInt(s.attributes.get("instr"),10)),s.attributes.has("volume")&&(e.volume=Number.parseInt(s.attributes.get("volume"),10)),s.attributes.has("transpose")&&(e.transpose=Number.parseInt(s.attributes.get("transpose"),10))}this.Yn.set(e.description,e),e.index=this.jn.length,this.jn.push(e)}Kn(t){switch(t){case"treble":return M.G2;case"bass":return M.F4;case"alto":case"tenor":return M.C4}return M.G2}Qn(t){return t.endsWith("-")?m.T:t.endsWith("+")?m._:m.Regular}$n(t){for(const e of t.childElements())if("system"===e.localName)this.Zn(e)}Zn(t){t.attributes.has("tempo")&&0===this.score.masterBars.length&&(this.Cn=Number.parseInt(t.attributes.get("tempo"),10)),"0"===t.getAttribute("beamGrouping")&&(this.Mn=Bt.ForceSplitToNext);for(const e of t.childElements())if("staves"===e.localName)this.tr(t,e);this.Pn=!1}tr(t,e){const s=this.score.masterBars.length;for(const i of e.childElements())if("staff"===i.localName)this.er(t,s,i)}sr=new et;ir;er(t,e,s){const i=s.getAttribute("layout");this.ir=this.Yn.get(i),this.sr.timeSignatureNumerator=4,this.sr.timeSignatureDenominator=4,this.sr.timeSignatureCommon=!1,this.nr(s.getAttribute("defaultTime"));const n=this.Hn.get(this.ir.index);for(;n.bars.length<e;)this.rr(n);for(const r of s.childElements())if("voices"===r.localName)this.ar(i,n,t,e,r)}nr(t){switch(t){case"allaBreve":case"C":this.sr.timeSignatureNumerator=2,this.sr.timeSignatureDenominator=2,this.sr.timeSignatureCommon=!0;break;case"longAllaBreve":this.sr.timeSignatureNumerator=4,this.sr.timeSignatureDenominator=4,this.sr.timeSignatureCommon=!0;break;default:if(t.indexOf("/")>0){const e=t.split("/");this.sr.timeSignatureNumerator=Number.parseInt(e[0],10),this.sr.timeSignatureDenominator=Number.parseInt(e[1],10),this.sr.timeSignatureCommon=!1}}}ar(t,e,s,i,n){let r=0;for(const a of n.childElements())if("voice"===a.localName)this.hr(t,e,s,r,i,a),r++}cr(t,e){return e<t.bars.length?t.bars[e]:this.rr(t)}rr(t){const e=new Z;if(t.bars.length>0?(e.clef=t.bars[t.bars.length-1].clef,e.clefOttava=t.bars[t.bars.length-1].clefOttava,e.keySignature=t.bars[t.bars.length-1].keySignature,e.keySignatureType=t.bars[t.bars.length-1].keySignatureType):e.clef=this.ir.defaultClef,t.addBar(e),t.bars.length>this.score.masterBars.length){const t=new et;this.score.addMasterBar(t),t.index>0?t.tripletFeel=t.previousMasterBar.tripletFeel:this.Cn>0&&t.tempoAutomations.push(U.buildTempoAutomation(!1,0,this.Cn,0)),t.timeSignatureDenominator=this.sr.timeSignatureDenominator,t.timeSignatureNumerator=this.sr.timeSignatureNumerator,t.timeSignatureCommon=this.sr.timeSignatureCommon}return e}lr=new Map;ur;dr;pr;br(t,e){this.ur.currentBarIndex++,this.dr=this.cr(t,this.ur.currentBarIndex),this.ur.currentBarDuration=this.dr.masterBar.calculateDuration(!1),this.ur.currentBarComplete=!1,this.ur.currentPosition=0,this.mr(t,e)}hr(t,e,s,i,n,a){const h=`${t}_${i}`;if(this.ur&&!this.ur.currentBarComplete&&(this.dr.masterBar.isAnacrusis=!0),this.lr.has(h)?(this.ur=this.lr.get(h),this.dr=this.cr(e,this.ur.currentBarIndex),this.mr(e,i)):(this.ur=new Os,this.ur.currentBarIndex=n-1,this.lr.set(h,this.ur),this.br(e,i)),a.attributes.has("stemDir"))switch(a.attributes.get("stemDir")){case"up":this.ur.voiceStemDir=Rt.Up;break;case"down":this.ur.voiceStemDir=Rt.Down;break;default:this.ur.voiceStemDir=null}else this.ur.voiceStemDir=null;const o=a.findChildElement("noteObjects");if(s.attributes.has("tempo")){const t=new U;t.isLinear=!0,t.type=r.Tempo,t.value=Number.parseInt(s.attributes.get("tempo"),10),t.ratioPosition=this.ur.currentPosition/this.ur.currentBarDuration,this.dr.masterBar.tempoAutomations.push(t)}if(o)for(const t of o.childElements())switch(this.ur.currentBarComplete&&"barline"!==t.localName&&this.br(e,i),t.localName){case"clefSign":this.dr.clef=this.Kn(t.getAttribute("clef")),this.dr.clefOttava=this.Qn(t.getAttribute("clef"));break;case"keySign":this.dr.keySignature=Number.parseInt(t.getAttribute("fifths"),10);break;case"timeSign":this.nr(t.getAttribute("time")),this.dr.masterBar.timeSignatureDenominator=this.sr.timeSignatureDenominator,this.dr.masterBar.timeSignatureNumerator=this.sr.timeSignatureNumerator,this.dr.masterBar.timeSignatureCommon=this.sr.timeSignatureCommon,this.ur.currentPosition=0,this.ur.currentBarDuration=this.dr.masterBar.calculateDuration(!1);break;case"barline":switch(t.getAttribute("type")){case"double":this.dr.barLineRight=F.LightLight,this.ur.currentBarComplete||(this.dr.masterBar.isAnacrusis=!0),this.ur.currentBarComplete=!0;break;case"end":this.ur.currentBarComplete||(this.dr.masterBar.isAnacrusis=!0);break;case"repEnd":this.ur.repeatEnd=this.dr.masterBar,this.dr.masterBar.repeatCount<this.ur.repeatCount&&(this.dr.masterBar.repeatCount=this.ur.repeatCount),this.gr(t),this.ur.currentBarComplete||(this.dr.masterBar.isAnacrusis=!0),this.ur.currentBarComplete=!0;break;case"repBegin":this.br(e,i),this.dr.masterBar.isRepeatStart=!0,this.ur.repeatEnd=null,this.ur.repeatCount=0;break;case"repEndBegin":this.ur.repeatEnd=this.dr.masterBar,this.dr.masterBar.repeatCount<this.ur.repeatCount&&(this.dr.masterBar.repeatCount=this.ur.repeatCount),this.gr(t),this.br(e,i),this.dr.masterBar.isRepeatStart=!0;break;default:this.ur.currentBarComplete||(this.dr.masterBar.isAnacrusis=!0),this.ur.currentBarComplete=!0}break;case"chord":const s=new se;this.wr(s,this.pr),s.beamingMode=this.Mn,this.ur.voiceStemDir&&(s.preferredBeamDirection=this.ur.voiceStemDir),this.wi(s,t.findChildElement("duration")),s.updateDurations(),this.ur.currentPosition+=s.playbackDuration,this.pr.addBeat(s),this.yr(s,t),this.ur.currentPosition>=this.ur.currentBarDuration&&(this.ur.currentBarComplete=!0);break;case"rest":const n=this.kr(t.findChildElement("duration"));n&&(this.wr(n,this.pr),n.updateDurations(),this.ur.currentPosition+=n.playbackDuration,this.pr.addBeat(n),this.ur.currentPosition>=this.ur.currentBarDuration&&(this.ur.currentBarComplete=!0))}}wr(t,e){const s=this.Sr(e);s&&(t.dynamics=s.dynamics)}Sr(t){if(t.beats.length>0)return t.beats[t.beats.length-1];if(t.bar.index>0){const e=t.bar.staff.bars[t.bar.index-1];if(t.index<e.voices.length){const s=e.voices[t.index];return this.Sr(s)}}return null}mr(t,e){for(;this.dr.voices.length<e+1;)this.dr.addVoice(new at);(!this.Nn.has(t.track.index)||this.Nn.get(t.track.index)<this.dr.voices.length)&&this.Nn.set(t.track.index,this.dr.voices.length),this.pr=this.dr.voices[e]}yr(t,e){const s=new Qt;for(const i of e.childElements())switch(i.localName){case"stem":switch(i.getAttribute("dir")){case"up":t.preferredBeamDirection=Rt.Up;break;case"down":t.preferredBeamDirection=Rt.Down}break;case"articulation":switch(i.getAttribute("type")){case"staccato":s.isStaccato=!0;break;case"normalAccent":s.accentuated=d.Normal;break;case"strongAccent":s.accentuated=d.Heavy}break;case"lyric":this.Br(t,i);break;case"drawObjects":this._r(t,i);break;case"heads":this.Tr(t,s,i);break;case"beam":switch(i.getAttribute("group")){case"force":t.beamingMode=Bt.ForceMergeWithNext;break;case"divide":t.beamingMode=Bt.ForceSplitToNext}}}Tr(t,e,s){for(const i of s.childElements())if("head"===i.localName)this.Mr(t,e,i)}En;Fn;An;Dn;Mr(t,e,s){const i=new Qt,n=Xt.parseTuning(s.getAttribute("pitch"));i.octave=n.octave-1,i.tone=n.tone.noteValue,i.isStaccato=e.isStaccato,i.accentuated=e.accentuated,t.addNote(i);for(const t of s.childElements())switch(t.localName){case"alter":t.attributes.has("step")&&(i.tone+=Number.parseInt(t.attributes.get("step"),10));break;case"tie":t.attributes.has("begin")?this.Fn.has(i.id)||(this.Fn.set(i.id,!0),this.En.push(i)):t.attributes.has("end")&&this.En.length>0&&!i.isTieDestination&&(i.isTieDestination=!0,i.tieOrigin=this.En[0],this.En.splice(0,1),this.Fn.delete(i.id))}}_r(t,e){for(const s of e.childElements())if("drawObj"===s.localName){const e=this.vr(s);if(e)if(e instanceof Ns)e.fontFace.startsWith("capella")?"u"===e.text?(t.fermata=new Be,t.fermata.type=Dt.Medium):"f"===e.text?t.dynamics=n.F:"j"===e.text&&(t.dynamics=n.MF):this.Pn&&""===this.score.title&&e.align===ht.Center&&e.height>16&&e.weight>400?this.score.title=e.text:this.Pn&&""===this.score.artist&&e.align===ht.Center&&e.y<0?this.score.artist=e.text:this.Pn&&""===this.score.music&&e.align===ht.Right&&e.y<0?this.score.music=e.text:e.text.startsWith("by capella")||(t.text=e.text);else if(e instanceof Ps);else if(e instanceof Es)t.vibrato=y.Slight;else if(e instanceof As)t.crescendo=e.decrescendo?c.Decrescendo:c.Crescendo,e.noteRange++,this.Dn.set(t,e);else if(e instanceof Cs){const s=e;this.An.set(t,s)}else e instanceof Ds&&this.Nr(e)}}gr(t){for(const e of t.childElements())if("drawObj"===e.localName){const t=this.vr(e);t&&t instanceof Ds&&this.Nr(t)}}Nr(t){if(t.lastNumber>0?(this.ur.repeatCount=t.lastNumber,this.ur.repeatEnd&&this.ur.repeatEnd.repeatCount<this.ur.repeatCount&&(this.ur.repeatEnd.repeatCount=this.ur.repeatCount)):t.firstNumber>0&&(this.ur.repeatCount=t.firstNumber,this.ur.repeatEnd&&this.ur.repeatEnd.repeatCount<this.ur.repeatCount&&(this.ur.repeatEnd.repeatCount=this.ur.repeatCount)),t.lastNumber>0&&t.firstNumber>0){let e=0;for(let s=t.firstNumber;s<=t.lastNumber;s++)e|=1<<s-1;this.dr.masterBar.alternateEndings=e}else t.lastNumber>0?this.dr.masterBar.alternateEndings=1<<t.lastNumber-1:t.firstNumber>0&&(this.dr.masterBar.alternateEndings=1<<t.firstNumber-1)}Br(t,e){for(const s of e.childElements())if("verse"===s.localName){t.lyrics||(t.lyrics=[]);let e=s.innerText;"true"===s.getAttribute("hyphen")&&(e+="-"),t.lyrics.push(e)}}kr(t){const e=t.getAttribute("base");if(-1!==e.indexOf("/")){const e=new se;return e.beamingMode=this.Mn,this.wi(e,t),e}if(1===Number.parseInt(e,10)){const t=new se;return t.beamingMode=this.Mn,t.duration=l.Whole,t}return q.warning("Importer","Multi-Bar rests are not supported"),null}Pr(t){switch(t){case"2/1":return l.DoubleWhole;case"1/1":return l.Whole;case"1/2":return l.Half;case"1/4":return l.Quarter;case"1/8":return l.Eighth;case"1/16":return l.Sixteenth;case"1/32":return l.ThirtySecond;case"1/64":return l.SixtyFourth;case"1/128":return l.OneHundredTwentyEighth;default:return q.warning("Importer","Unsupported duration"),l.Quarter}}wi(t,e){const s=e.getAttribute("base");t.duration=this.Pr(s),e.attributes.has("dots")&&(t.dots=Number.parseInt(e.attributes.get("dots"),10));const i=e.findChildElement("tuplet");if(i){t.tupletNumerator=Number.parseInt(i.getAttribute("count"),10);const e="true"===i.getAttribute("tripartite")?3:1,s="true"===i.getAttribute("prolong")?0:1;let n=0;for(;e*Math.pow(2,n+s)<t.tupletNumerator;)n++;t.tupletDenominator=e*Math.pow(2,n)}}Vn(t){for(const e of t.childElements())if("drawObj"===e.localName){const t=this.vr(e);if(t&&t instanceof Ns)switch(t.align){case ht.Center:this.score.title?this.score.subTitle||(this.score.subTitle=e.innerText):this.score.title=e.innerText;break;case ht.Right:this.score.artist||(this.score.artist=e.innerText)}}}Gn(t){for(const e of t.childElements())if("drawObj"===e.localName){const t=this.vr(e);t&&this.vn.set(e.getAttribute("name"),t)}}vr(t){let e=null,s=1;for(const i of t.childElements())switch(i.localName){case"text":e=this.Cr(i);break;case"guitar":e=this.Er(i);break;case"slur":e=this.Fr(i);break;case"wavyLine":e=this.Ar(i);break;case"bracket":e=this.Dr(i);break;case"wedge":e=this.Lr(i);break;case"volta":e=this.Wr(i);break;case"octaveClef":e=this.Rr(i);break;case"trill":e=this.Ir(i);break;case"basic":i.attributes.has("noteRange")&&(s=Number.parseInt(i.attributes.get("noteRange"),10))}return e&&(e.noteRange=s),e}Ir(t){return new Ws}Rr(t){const e=new Ls;return t.attributes.has("octave")&&(e.octave=Number.parseInt(t.attributes.get("octave"),10)),e}Wr(t){const e=new Ds;return e.allNumbers="true"===t.attributes.get("allNumbers"),t.attributes.has("firstNumber")&&(e.firstNumber=Number.parseInt(t.attributes.get("firstNumber"),10)),t.attributes.has("lastNumber")&&(e.lastNumber=Number.parseInt(t.attributes.get("lastNumber"),10)),e}Lr(t){const e=new As;return e.decrescendo="true"===t.attributes.get("decrescendo"),e}Dr(t){const e=new Fs;return t.attributes.has("number")&&(e.number=Number.parseInt(t.attributes.get("number"),10)),e}Ar(t){return new Es}Fr(t){return new Cs}Er(t){const e=new Ps,s=t.innerText.trim();for(let t=0;t<s.length;t++)"/"===s.charAt(t)?e.chord.strings.push(0):e.chord.strings.push(Number.parseInt(s.charAt(t),10));return e}Cr(t){const e=new Ns;switch(t.attributes.has("x")&&(e.x=Number.parseFloat(t.attributes.get("x"))),t.attributes.has("x")&&(e.y=Number.parseFloat(t.attributes.get("y"))),t.getAttribute("align")){case"left":e.align=ht.Left;break;case"center":e.align=ht.Center;break;case"right":e.align=ht.Right}switch(t.getAttribute("frame")){case"rectangle":e.frame=ze.Rectangle;break;case"ellipse":e.frame=ze.Ellipse;break;case"circle":e.frame=ze.Circle;break;case"none":e.frame=ze.None}if(t.firstElement)for(const s of t.childElements())switch(s.localName){case"font":e.fontFace=s.getAttribute("face"),s.attributes.has("weight")&&(e.weight=Number.parseInt(s.attributes.get("weight"),10)),s.attributes.has("height")&&(e.height=Number.parseInt(s.attributes.get("height"),10));break;case"content":e.text=s.innerText}else e.text=t.innerText;return e}In(t){for(const e of t.childElements())switch(e.localName){case"author":this.score.tab=e.firstChild.innerText;break;case"comment":this.score.notices=e.firstChild.innerText}}}class Vs extends Ee{get name(){return"Capella"}readScore(){q.debug(this.name,"Loading ZIP entries");let t,e=null;if(t=new Ss(this.data).read(),q.debug(this.name,"Zip entries loaded"),t.length>0){for(const s of t)if("score.xml"===s.fileName)e=fe.toString(s.data,this.settings.importer.encoding)}else this.data.reset(),e=fe.toString(this.data.readAll(),this.settings.importer.encoding);if(!e)throw new Fe("No valid capella file");q.debug(this.name,"Start Parsing score.xml");try{const t=new Gs;t.parseXml(e,this.settings),q.debug(this.name,"score.xml parsed");return t.score}catch(t){throw new Fe("Failed to parse CapXML",t)}}}!function(t){t[t.TargetFine=0]="TargetFine",t[t.TargetSegno=1]="TargetSegno",t[t.TargetSegnoSegno=2]="TargetSegnoSegno",t[t.TargetCoda=3]="TargetCoda",t[t.TargetDoubleCoda=4]="TargetDoubleCoda",t[t.JumpDaCapo=5]="JumpDaCapo",t[t.JumpDaCapoAlCoda=6]="JumpDaCapoAlCoda",t[t.JumpDaCapoAlDoubleCoda=7]="JumpDaCapoAlDoubleCoda",t[t.JumpDaCapoAlFine=8]="JumpDaCapoAlFine",t[t.JumpDalSegno=9]="JumpDalSegno",t[t.JumpDalSegnoAlCoda=10]="JumpDalSegnoAlCoda",t[t.JumpDalSegnoAlDoubleCoda=11]="JumpDalSegnoAlDoubleCoda",t[t.JumpDalSegnoAlFine=12]="JumpDalSegnoAlFine",t[t.JumpDalSegnoSegno=13]="JumpDalSegnoSegno",t[t.JumpDalSegnoSegnoAlCoda=14]="JumpDalSegnoSegnoAlCoda",t[t.JumpDalSegnoSegnoAlDoubleCoda=15]="JumpDalSegnoSegnoAlDoubleCoda",t[t.JumpDalSegnoSegnoAlFine=16]="JumpDalSegnoSegnoAlFine",t[t.JumpDaCoda=17]="JumpDaCoda",t[t.JumpDaDoubleCoda=18]="JumpDaDoubleCoda"}(Xe||(Xe={}));class $s extends Ee{static Or="FICHIER GUITAR PRO ";Gr=0;Be;Vr=A.NoTripletFeel;$r=0;Hr=[];Ur=0;zr=0;Xr=[];jr=new Set;Jr=new Map;qr=new Map;Yr=new Map;Kr=new Map;Cn;get name(){return"Guitar Pro 3-5"}readScore(){if(this.Kr.clear(),this.readVersion(),this.Be=new $t,this.readScoreInformation(),this.Gr<500&&(this.Vr=Hs.gpReadBool(this.data)?A.Triplet8th:A.NoTripletFeel),this.Gr>=400&&this.readLyrics(),this.Gr>=510&&this.data.skip(19),this.Cn=U.buildTempoAutomation(!1,0,0,0),this.Gr>=500&&(this.readPageSetup(),this.Cn.text=Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this.Cn.value=fe.readInt32LE(this.data),this.Gr>=510&&Hs.gpReadBool(this.data),fe.readInt32LE(this.data),this.Gr>=400&&this.data.readByte(),this.readPlaybackInfos(),this.Gr>=500&&(this.Qr(Xe.TargetCoda),this.Qr(Xe.TargetDoubleCoda),this.Qr(Xe.TargetSegno),this.Qr(Xe.TargetSegnoSegno),this.Qr(Xe.TargetFine),this.Qr(Xe.JumpDaCapo),this.Qr(Xe.JumpDaCapoAlCoda),this.Qr(Xe.JumpDaCapoAlDoubleCoda),this.Qr(Xe.JumpDaCapoAlFine),this.Qr(Xe.JumpDalSegno),this.Qr(Xe.JumpDalSegnoAlCoda),this.Qr(Xe.JumpDalSegnoAlDoubleCoda),this.Qr(Xe.JumpDalSegnoAlFine),this.Qr(Xe.JumpDalSegnoSegno),this.Qr(Xe.JumpDalSegnoSegnoAlCoda),this.Qr(Xe.JumpDalSegnoSegnoAlDoubleCoda),this.Qr(Xe.JumpDalSegnoSegnoAlFine),this.Qr(Xe.JumpDaCoda),this.Qr(Xe.JumpDaDoubleCoda),this.data.skip(4)),this.Ur=fe.readInt32LE(this.data),this.zr=fe.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),this.Be.masterBars.length>0){const t=U.buildTempoAutomation(!1,0,this.Be.tempo,2);t.text=this.Be.tempoLabel,this.Be.masterBars[0].tempoAutomations.push(t)}return Xt.consolidate(this.Be),this.Be.finish(this.settings),this.Hr&&this.$r>=0&&this.Be.tracks[this.$r].applyLyrics(this.Hr),this.Be}Qr(t){let e,s=fe.readInt16LE(this.data);-1!==s&&(s--,this.Kr.has(s)?e=this.Kr.get(s):(e=[],this.Kr.set(s,e)),e.push(t))}readVersion(){let t=Hs.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!t.startsWith($s.Or))throw new Fe("Unsupported format");t=t.substr($s.Or.length+1);const e=t.indexOf(String.fromCharCode(46));this.Gr=100*Number.parseInt(t.substr(0,e),10)+Number.parseInt(t.substr(e+1),10),q.debug(this.name,`Guitar Pro version ${t} detected`)}readScoreInformation(){this.Be.title=Hs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.Be.subTitle=Hs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.Be.artist=Hs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.Be.album=Hs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.Be.words=Hs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.Be.music=this.Gr>=500?Hs.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this.Be.words,this.Be.copyright=Hs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.Be.tab=Hs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this.Be.instructions=Hs.gpReadStringIntUnused(this.data,this.settings.importer.encoding);const t=fe.readInt32LE(this.data);let e="";for(let s=0;s<t;s++)s>0&&(e+="\r\n"),e+=Hs.gpReadStringIntUnused(this.data,this.settings.importer.encoding)?.toString();this.Be.notices=e}readLyrics(){this.Hr=[],this.$r=fe.readInt32LE(this.data)-1;for(let t=0;t<5;t++){const t=new _e;t.startBar=fe.readInt32LE(this.data)-1,t.text=Hs.gpReadStringInt(this.data,this.settings.importer.encoding),this.Hr.push(t)}}readPageSetup(){this.data.skip(28);const t=fe.readInt16LE(this.data);Xt.getOrCreateHeaderFooterStyle(this.Be,ct.Title).isVisible=!!(1&t),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.Title).template=Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.SubTitle).isVisible=!!(2&t),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.SubTitle).template=Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.Artist).isVisible=!!(4&t),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.Artist).template=Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.Album).isVisible=!!(8&t),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.Album).template=Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.Words).isVisible=!!(16&t),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.Words).template=Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.Music).isVisible=!!(32&t),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.Music).template=Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.WordsAndMusic).isVisible=!!(64&t),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.WordsAndMusic).template=Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.Copyright).isVisible=!!(128&t),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.Copyright).template=Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.CopyrightSecondLine).isVisible=!!(128&t),Xt.getOrCreateHeaderFooterStyle(this.Be,ct.CopyrightSecondLine).template=Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this.Xr=[];let t=0;for(let e=0;e<64;e++){const e=new ve;e.primaryChannel=t++,e.secondaryChannel=t++,e.program=fe.readInt32LE(this.data),e.volume=this.data.readByte(),e.balance=this.data.readByte(),this.data.skip(6),this.Xr.push(e)}}readMasterBars(){for(let t=0;t<this.Ur;t++)this.readMasterBar()}readMasterBar(){let t=null;this.Be.masterBars.length>0&&(t=this.Be.masterBars[this.Be.masterBars.length-1]);const e=new et;!t&&this.Cn.value>0&&e.tempoAutomations.push(this.Cn);const s=this.data.readByte();if(1&s?e.timeSignatureNumerator=this.data.readByte():t&&(e.timeSignatureNumerator=t.timeSignatureNumerator),2&s?e.timeSignatureDenominator=this.data.readByte():t&&(e.timeSignatureDenominator=t.timeSignatureDenominator),e.isRepeatStart=!!(4&s),8&s&&(e.repeatCount=this.data.readByte()+(this.Gr>=500?0:1)),16&s&&this.Gr<500){let s=t,i=0;for(;s&&(!s.isRepeatEnd||s===t)&&!s.isRepeatStart;)i|=s.alternateEndings,s=s.previousMasterBar;let n=0;const r=this.data.readByte();for(let t=0;t<8;t++){const e=1<<t;r>t&&0===(i&e)&&(n|=e)}e.alternateEndings=n}if(32&s){const t=new Te;t.text=Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding),t.marker="",Hs.gpReadColor(this.data,!1),e.section=t}if(64&s&&this.qr.set(this.Be.masterBars.length,[fe.readSInt8(this.data),this.data.readByte()]),this.Gr>=500&&3&s&&this.data.skip(4),this.Gr>=500&&(e.alternateEndings=this.data.readByte()),this.Gr>=500){switch(this.data.readByte()){case 1:e.tripletFeel=A.Triplet8th;break;case 2:e.tripletFeel=A.Triplet16th}this.data.readByte()}else e.tripletFeel=this.Vr;const i=!!(128&s);e.isDoubleBar=i;const n=this.Be.masterBars.length;if(this.Kr.has(n))for(const t of this.Kr.get(n))e.addDirection(t);this.Be.addMasterBar(e),i&&this.jr.add(e.index)}readTracks(){for(let t=0;t<this.zr;t++)this.readTrack()}static Zr=Xt.parseTuning("B2").realValue;readTrack(){const t=new Pe;t.ensureStaveCount(1),this.Be.addTrack(t);const e=t.staves[0],s=this.data.readByte();t.name=Hs.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),1&s&&(e.isPercussion=!0),this.Gr>=500&&(t.isVisibleOnMultiTrack=!!(8&s)),null===this.Be.stylesheet.perTrackDisplayTuning&&(this.Be.stylesheet.perTrackDisplayTuning=new Map),this.Be.stylesheet.perTrackDisplayTuning.set(t.index,!!(128&s));const i=fe.readInt32LE(this.data),n=[];for(let t=0;t<7;t++){const e=fe.readInt32LE(this.data);i>t&&n.push(e)}e.stringTuning.tunings=n;const r=fe.readInt32LE(this.data),a=fe.readInt32LE(this.data)-1,h=fe.readInt32LE(this.data)-1;if(this.data.skip(4),a>=0&&a<this.Xr.length){const i=this.Xr[a];i.port=r,i.isSolo=!!(16&s),i.isMute=!!(32&s),i.secondaryChannel=h,we.isGuitar(i.program)&&(e.displayTranspositionPitch=-12),t.playbackInfo=i}if(e.capo=fe.readInt32LE(this.data),t.color=Hs.gpReadColor(this.data,!1),this.Gr>=500){const s=this.data.readByte();e.showTablature=!!(1&s),e.showStandardNotation=!!(2&s);const i=!!(100&s);null===this.Be.stylesheet.perTrackChordDiagramsOnTop&&(this.Be.stylesheet.perTrackChordDiagramsOnTop=new Map),this.Be.stylesheet.perTrackChordDiagramsOnTop.set(t.index,i),this.data.readByte(),this.data.readByte(),t.playbackInfo.bank=this.data.readByte(),this.data.readByte();12===fe.readInt32LE(this.data)||n[n.length-1]<$s.Zr?this.Jr.set(t.index,M.F4):this.Jr.set(t.index,M.G2),fe.readInt32LE(this.data),fe.readInt32LE(this.data),this.data.skip(10),this.data.readByte(),this.data.readByte(),this.ta(),this.Gr>=510&&(this.data.skip(4),Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding))}else n[n.length-1]<$s.Zr?this.Jr.set(t.index,M.F4):this.Jr.set(t.index,M.G2)}readBars(){for(let t=0;t<this.Ur;t++)for(let t=0;t<this.zr;t++)this.readBar(this.Be.tracks[t])}readBar(t){const e=new Z,s=t.staves[0];if(s.isPercussion?e.clef=M.Neutral:this.Jr.has(t.index)&&(e.clef=this.Jr.get(t.index)),s.addBar(e),this.qr.has(e.index)){const t=this.qr.get(e.index);e.keySignature=t[0],e.keySignatureType=t[1]}else e.index>0&&(e.keySignature=e.previousBar.keySignature,e.keySignatureType=e.previousBar.keySignatureType);this.jr.has(e.index)&&(e.barLineRight=F.LightLight);let i=1;this.Gr>=500&&(this.data.readByte(),i=2);for(let s=0;s<i;s++)this.readVoice(t,e)}readVoice(t,e){const s=fe.readInt32LE(this.data);if(0===s)return;const i=new at;e.addVoice(i);for(let n=0;n<s;n++)this.readBeat(t,e,i)}readBeat(t,e,s){const i=new se,n=this.data.readByte();if(1&n&&(i.dots=1),64&n){const t=this.data.readByte();i.isEmpty=!(2&t)}s.addBeat(i);switch(fe.readSInt8(this.data)){case-2:i.duration=l.Whole;break;case-1:i.duration=l.Half;break;case 0:i.duration=l.Quarter;break;case 1:i.duration=l.Eighth;break;case 2:i.duration=l.Sixteenth;break;case 3:i.duration=l.ThirtySecond;break;case 4:i.duration=l.SixtyFourth;break;default:i.duration=l.Quarter}if(32&n)switch(i.tupletNumerator=fe.readInt32LE(this.data),i.tupletNumerator){case 1:i.tupletDenominator=1;break;case 3:i.tupletDenominator=2;break;case 5:case 6:case 7:i.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:i.tupletDenominator=8;break;case 2:case 4:case 8:break;default:i.tupletNumerator=1,i.tupletDenominator=1}2&n&&this.readChord(i);const r=this.settings.importer.beatTextAsLyrics&&t.index!==this.$r;if(4&n){const e=Hs.gpReadStringIntUnused(this.data,this.settings.importer.encoding);if(r){const s=new _e;s.text=e.trim(),s.finish(!0);const i=[];for(let t=s.chunks.length-1;t>=0;t--)i.push(s.chunks[t]);this.Yr.set(t.index,i)}else i.text=e}let a=p.None;8&n&&(a=this.readBeatEffects(i)),16&n&&this.readMixTableChange(i);const h=this.data.readByte();for(let n=6;n>=0;n--)if(h&1<<n&&6-n<e.staff.tuning.length){const r=this.readNote(t,e,s,i,6-n);a!==p.None&&(r.harmonicType=a,r.harmonicType===p.Natural&&(r.harmonicValue=Xt.deltaFretToHarmonicValue(r.fret)))}if(this.Gr>=500){const t=fe.readInt16LE(this.data);if(1&t&&i.index>0&&(s.beats[i.index-1].beamingMode=Bt.ForceSplitToNext),2&t&&(i.preferredBeamDirection=Rt.Down),4&t&&i.index>0&&(s.beats[i.index-1].beamingMode=Bt.ForceMergeWithNext),8&t&&(i.preferredBeamDirection=Rt.Up),16&t&&(i.ottava=m._),32&t&&(i.ottava=m.T),64&t&&(i.ottava=m.S),256&t&&(i.ottava=m.M),2048&t){const t=0!==this.data.readByte();i.index>0&&t&&(s.beats[i.index-1].beamingMode=Bt.ForceSplitOnSecondaryToNext)}}r&&!i.isRest&&this.Yr.has(t.index)&&this.Yr.get(t.index).length>0&&(i.lyrics=[this.Yr.get(t.index).pop()])}readChord(t){const e=new ye,s=Xt.newGuid();if(this.Gr>=500){this.data.skip(17),e.name=Hs.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),e.firstFret=fe.readInt32LE(this.data);for(let s=0;s<7;s++){const i=fe.readInt32LE(this.data);s<t.voice.bar.staff.tuning.length&&e.strings.push(i)}const s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let t=0;t<s;t++)e.barreFrets.push(i[t]);this.data.skip(26)}else if(0!==this.data.readByte())if(this.Gr>=400){this.data.skip(16),e.name=Hs.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),e.firstFret=fe.readInt32LE(this.data);for(let s=0;s<7;s++){const i=fe.readInt32LE(this.data);s<t.voice.bar.staff.tuning.length&&e.strings.push(i)}const s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let t=0;t<s;t++)e.barreFrets.push(i[t]);this.data.skip(26)}else{this.data.skip(25),e.name=Hs.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),e.firstFret=fe.readInt32LE(this.data);for(let s=0;s<6;s++){const i=fe.readInt32LE(this.data);s<t.voice.bar.staff.tuning.length&&e.strings.push(i)}this.data.skip(36)}else{const s=this.Gr>=406?7:6;if(e.name=Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding),e.firstFret=fe.readInt32LE(this.data),e.firstFret>0)for(let i=0;i<s;i++){const s=fe.readInt32LE(this.data);i<t.voice.bar.staff.tuning.length&&e.strings.push(s)}}e.name&&(t.chordId=s,t.voice.bar.staff.addChord(t.chordId,e))}readBeatEffects(t){const e=this.data.readByte();let s=0;if(this.Gr>=400&&(s=this.data.readByte()),16&e&&(t.fade=gt.FadeIn),(this.Gr<400&&1&e||2&e)&&(t.vibrato=y.Slight),1&s&&(t.rasgueado=kt.Ii),32&e&&this.Gr>=400){switch(fe.readSInt8(this.data)){case 1:t.tap=!0;break;case 2:t.slap=!0;break;case 3:t.pop=!0}}else if(32&e){switch(fe.readSInt8(this.data)){case 1:t.tap=!0;break;case 2:t.slap=!0;break;case 3:t.pop=!0}this.data.skip(4)}if(4&s&&this.readTremoloBarEffect(t),64&e){let e=0,s=0;this.Gr<500?(s=this.data.readByte(),e=this.data.readByte()):(e=this.data.readByte(),s=this.data.readByte()),e>0?(t.brushType=o.BrushUp,t.brushDuration=$s.ea(e)):s>0&&(t.brushType=o.BrushDown,t.brushDuration=$s.ea(s))}if(2&s)switch(fe.readSInt8(this.data)){case 0:t.pickStroke=lt.None;break;case 1:t.pickStroke=lt.Up;break;case 2:t.pickStroke=lt.Down}if(this.Gr<400){if(4&e)return p.Natural;if(8&e)return p.Artificial}return p.None}readTremoloBarEffect(t){this.data.readByte(),fe.readInt32LE(this.data);const e=fe.readInt32LE(this.data);if(e>0)for(let s=0;s<e;s++){const e=new z(0,0);e.offset=fe.readInt32LE(this.data),e.value=fe.readInt32LE(this.data)/$s.sa|0,Hs.gpReadBool(this.data),t.addWhammyBarPoint(e)}}static ea(t){switch(t){case 1:case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}ta(){this.data.skip(4),this.data.skip(4),this.data.skip(4),this.data.skip(4)}readMixTableChange(t){const e=new Us;e.instrument=fe.readSInt8(this.data),this.Gr>=500&&this.ta(),e.volume=fe.readSInt8(this.data),e.balance=fe.readSInt8(this.data);const s=fe.readSInt8(this.data),i=fe.readSInt8(this.data),n=fe.readSInt8(this.data),a=fe.readSInt8(this.data);if(this.Gr>=500&&(e.tempoName=Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding)),e.tempo=fe.readInt32LE(this.data),e.volume>=0&&this.data.readByte(),e.balance>=0&&this.data.readByte(),s>=0&&this.data.readByte(),i>=0&&this.data.readByte(),n>=0&&this.data.readByte(),a>=0&&this.data.readByte(),e.tempo>=0&&(e.duration=fe.readSInt8(this.data),this.Gr>=510&&this.data.readByte()),this.Gr>=400&&this.data.readByte(),this.Gr>=500){const e=fe.readSInt8(this.data);e>=100?t.wahPedal=wt.Closed:e>=0&&(t.wahPedal=wt.Open)}if(this.Gr>=510&&(Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Hs.gpReadStringIntByte(this.data,this.settings.importer.encoding)),e.volume>=0){const s=new U;s.isLinear=!0,s.type=r.Volume,s.value=e.volume,t.automations.push(s)}if(e.balance>=0){const s=new U;s.isLinear=!0,s.type=r.Balance,s.value=e.balance,t.automations.push(s)}if(e.instrument>=0){const s=new U;s.isLinear=!0,s.type=r.Instrument,s.value=e.instrument,t.automations.push(s)}if(e.tempo>=0){const s=new U;s.isLinear=!0,s.type=r.Tempo,s.value=e.tempo,t.automations.push(s),t.voice.bar.masterBar.tempoAutomations.some(t=>t.ratioPosition===s.ratioPosition&&t.value===s.value)||t.voice.bar.masterBar.tempoAutomations.push(s)}}readNote(t,e,s,i,n){const r=new Qt;r.string=e.staff.tuning.length-n;const a=this.data.readByte();if(2&a?r.accentuated=d.Heavy:64&a&&(r.accentuated=d.Normal),r.isGhost=!!(4&a),32&a){const t=this.data.readByte();3===t?r.isDead=!0:2===t&&(r.isTieDestination=!0)}if(1&a&&this.Gr<500&&(this.data.readByte(),this.data.readByte()),16&a){const t=fe.readSInt8(this.data);r.dynamics=this.toDynamicValue(t),i.dynamics=r.dynamics}32&a&&(r.fret=fe.readSInt8(this.data)),128&a&&(r.leftHandFinger=fe.readSInt8(this.data),r.rightHandFinger=fe.readSInt8(this.data));let h=!1;if(this.Gr>=500){1&a&&(r.durationPercent=fe.readFloat64BE(this.data));h=!!(2&this.data.readByte())}if(i.addNote(r),8&a&&this.readNoteEffects(t,s,i,r),e.staff.isPercussion&&(r.percussionArticulation=r.fret,r.string=-1,r.fret=-1),h){const t=Xt.computeAccidental(e.keySignature,b.Default,r.realValueWithoutHarmonic,!1);t===x.Sharp?r.accidentalMode=b.ForceFlat:t===x.Flat&&(r.accidentalMode=b.ForceSharp)}return r}toDynamicValue(t){switch(t){case 1:return n.PPP;case 2:return n.PP;case 3:return n.P;case 4:return n.MP;case 5:return n.MF;case 6:default:return n.F;case 7:return n.FF;case 8:return n.FFF}}readNoteEffects(t,e,s,i){const n=this.data.readByte();let r=0;this.Gr>=400&&(r=this.data.readByte()),1&n&&this.readBend(i),16&n&&this.readGrace(e,i),4&r&&this.readTremoloPicking(s),8&r?this.readSlide(i):this.Gr<400&&4&n&&(i.slideOutType=w.Shift),16&r&&this.readArtificialHarmonic(i),32&r&&this.readTrill(i),i.isLetRing=!!(8&n),i.isHammerPullOrigin=!!(2&n),64&r&&(i.vibrato=y.Slight),i.isPalmMute=!!(2&r),i.isStaccato=!!(1&r)}static sa=25;readBend(t){this.data.readByte(),fe.readInt32LE(this.data);const e=fe.readInt32LE(this.data);if(e>0)for(let s=0;s<e;s++){const e=new z(0,0);e.offset=fe.readInt32LE(this.data),e.value=fe.readInt32LE(this.data)/$s.sa|0,Hs.gpReadBool(this.data),t.addBendPoint(e)}}readGrace(t,e){const s=new se,i=new Qt;i.string=e.string,i.fret=fe.readSInt8(this.data),s.duration=l.ThirtySecond,s.dynamics=this.toDynamicValue(fe.readSInt8(this.data));switch(fe.readSInt8(this.data)){case 0:case 2:break;case 1:i.slideOutType=w.Legato,i.slideTarget=e;break;case 3:i.isHammerPullOrigin=!0}if(i.dynamics=s.dynamics,this.data.skip(1),this.Gr<500)s.graceType=u.BeforeBeat;else{const t=this.data.readByte();i.isDead=!!(1&t),s.graceType=2&t?u.OnBeat:u.BeforeBeat}t.addGraceBeat(s),s.addNote(i)}readTremoloPicking(t){const e=new te;t.tremoloPicking=e,e.marks=this.data.readByte()}readSlide(t){if(this.Gr>=500){const e=fe.readSInt8(this.data);1&e?t.slideOutType=w.Shift:2&e?t.slideOutType=w.Legato:4&e?t.slideOutType=w.OutDown:8&e&&(t.slideOutType=w.OutUp),16&e?t.slideInType=g.IntoFromBelow:32&e&&(t.slideInType=g.IntoFromAbove)}else{switch(fe.readSInt8(this.data)){case 1:t.slideOutType=w.Shift;break;case 2:t.slideOutType=w.Legato;break;case 3:t.slideOutType=w.OutDown;break;case 4:t.slideOutType=w.OutUp;break;case-1:t.slideInType=g.IntoFromBelow;break;case-2:t.slideInType=g.IntoFromAbove}}}readArtificialHarmonic(t){const e=this.data.readByte();if(this.Gr>=500)switch(e){case 1:t.harmonicType=p.Natural,t.harmonicValue=Xt.deltaFretToHarmonicValue(t.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),t.harmonicType=p.Artificial;break;case 3:t.harmonicType=p.Tap,t.harmonicValue=Xt.deltaFretToHarmonicValue(this.data.readByte());break;case 4:t.harmonicType=p.Pinch,t.harmonicValue=12;break;case 5:t.harmonicType=p.Semi,t.harmonicValue=12}else if(this.Gr>=400)switch(e){case 1:t.harmonicType=p.Natural;break;case 3:t.harmonicType=p.Tap;break;case 4:t.harmonicType=p.Pinch;break;case 5:t.harmonicType=p.Semi;break;case 15:case 17:case 22:t.harmonicType=p.Artificial}}readTrill(t){switch(t.trillValue=this.data.readByte()+t.stringTuning,this.data.readByte()){case 1:t.trillSpeed=l.Sixteenth;break;case 2:t.trillSpeed=l.ThirtySecond;break;case 3:t.trillSpeed=l.SixtyFourth}}}class Hs{static gpReadColor(t,e=!1){const s=t.readByte(),i=t.readByte(),n=t.readByte();let r=255;return e?r=t.readByte():t.skip(1),new Se(s,i,n,r)}static gpReadBool(t){return 0!==t.readByte()}static gpReadStringIntUnused(t,e){return t.skip(4),Hs.gpReadString(t,t.readByte(),e)}static gpReadStringInt(t,e){return Hs.gpReadString(t,fe.readInt32LE(t),e)}static gpReadStringIntByte(t,e){const s=fe.readInt32LE(t)-1;return t.readByte(),Hs.gpReadString(t,s,e)}static gpReadString(t,e,s){const i=new Uint8Array(e);return t.read(i,0,i.length),fe.toString(i,s)}static gpWriteString(t,e){const s=fe.stringToBytes(e);t.writeByte(e.length),t.write(s,0,s.length)}static gpReadStringByteLength(t,e,s){const i=t.readByte(),n=Hs.gpReadString(t,i,s);return i<e&&t.skip(e-i),n}}class Us{volume=-1;balance=-1;instrument=-1;tempoName="";tempo=-1;duration=-1}class zs{x;y;w;h;scaleWith(t){this.x*=t,this.y*=t,this.w*=t,this.h*=t}constructor(t=0,e=0,s=0,i=0){this.x=t,this.y=e,this.h=i,this.w=s}}!function(t){t[t.Boolean=0]="Boolean",t[t.Integer=1]="Integer",t[t.Float=2]="Float",t[t.String=3]="String",t[t.Point=4]="Point",t[t.Size=5]="Size",t[t.Rectangle=6]="Rectangle",t[t.Color=7]="Color"}(je||(je={}));class Xs{ia=new Map;raw=new Map;constructor(t){t&&this.na(t)}na(t){const e=Ae.fromBuffer(t),s=fe.readInt32BE(e);for(let t=0;t<s;t++){const t=Hs.gpReadString(e,e.readByte(),"utf-8"),s=e.readByte();switch(this.ia.set(t,s),s){case je.Boolean:const s=1===e.readByte();this.addValue(t,s);break;case je.Integer:const i=fe.readInt32BE(e);this.addValue(t,i);break;case je.Float:const n=fe.readFloat32BE(e);this.addValue(t,n);break;case je.String:const r=Hs.gpReadString(e,fe.readInt16BE(e),"utf-8");this.addValue(t,r);break;case je.Point:const a=fe.readInt32BE(e),h=fe.readInt32BE(e);this.addValue(t,new z(a,h));break;case je.Size:const o=fe.readInt32BE(e),c=fe.readInt32BE(e);this.addValue(t,new z(o,c));break;case je.Rectangle:const l=new zs;l.x=fe.readInt32BE(e),l.y=fe.readInt32BE(e),l.w=fe.readInt32BE(e),l.h=fe.readInt32BE(e),this.addValue(t,l);break;case je.Color:const u=Hs.gpReadColor(e,!0);this.addValue(t,u)}}}apply(t){for(const[e,s]of this.raw)switch(e){case"StandardNotation/hideDynamics":t.stylesheet.hideDynamics=s;break;case"System/bracketExtendMode":t.stylesheet.bracketExtendMode=s;break;case"Global/useSystemSignSeparator":t.stylesheet.useSystemSignSeparator=s;break;case"Global/DisplayTuning":t.stylesheet.globalDisplayTuning=s;break;case"Global/DrawChords":t.stylesheet.globalDisplayChordDiagramsOnTop=s;break;case"System/drawChordInScore":t.stylesheet.globalDisplayChordDiagramsInScore=s;break;case"System/showTrackNameSingle":s||(t.stylesheet.singleTrackTrackNamePolicy=L.Hidden);break;case"System/showTrackNameMulti":s||(t.stylesheet.multiTrackTrackNamePolicy=L.Hidden);break;case"System/trackNameModeSingle":if(t.stylesheet.singleTrackTrackNamePolicy!==L.Hidden)switch(s){case 0:case 1:t.stylesheet.singleTrackTrackNamePolicy=L.FirstSystem;break;case 2:t.stylesheet.singleTrackTrackNamePolicy=L.AllSystems}break;case"System/trackNameModeMulti":if(t.stylesheet.multiTrackTrackNamePolicy!==L.Hidden)switch(s){case 0:case 1:t.stylesheet.multiTrackTrackNamePolicy=L.FirstSystem;break;case 2:t.stylesheet.multiTrackTrackNamePolicy=L.AllSystems}break;case"System/shortTrackNameOnFirstSystem":t.stylesheet.firstSystemTrackNameMode=s?W.ShortName:W.FullName;break;case"System/shortTrackNameOnOtherSystems":t.stylesheet.otherSystemsTrackNameMode=s?W.ShortName:W.FullName;break;case"System/horizontalTrackNameOnFirstSystem":t.stylesheet.firstSystemTrackNameOrientation=s?R.Horizontal:R.Vertical;break;case"System/horizontalTrackNameOnOtherSystems":t.stylesheet.otherSystemsTrackNameOrientation=s?R.Horizontal:R.Vertical;break;case"System/ExtendedBarLines":t.stylesheet.extendBarLines=s;break;case"Header/Title":Xt.getOrCreateHeaderFooterStyle(t,ct.Title).template=s;break;case"Header/TitleAlignment":Xt.getOrCreateHeaderFooterStyle(t,ct.Title).textAlign=this.ra(s);break;case"Header/drawTitle":Xt.getOrCreateHeaderFooterStyle(t,ct.Title).isVisible=s;break;case"Header/Subtitle":Xt.getOrCreateHeaderFooterStyle(t,ct.SubTitle).template=s;break;case"Header/SubtitleAlignment":Xt.getOrCreateHeaderFooterStyle(t,ct.SubTitle).textAlign=this.ra(s);break;case"Header/drawSubtitle":Xt.getOrCreateHeaderFooterStyle(t,ct.SubTitle).isVisible=s;break;case"Header/Artist":Xt.getOrCreateHeaderFooterStyle(t,ct.Artist).template=s;break;case"Header/ArtistAlignment":Xt.getOrCreateHeaderFooterStyle(t,ct.Artist).textAlign=this.ra(s);break;case"Header/drawArtist":Xt.getOrCreateHeaderFooterStyle(t,ct.Artist).isVisible=s;break;case"Header/Album":Xt.getOrCreateHeaderFooterStyle(t,ct.Album).template=s;break;case"Header/AlbumAlignment":Xt.getOrCreateHeaderFooterStyle(t,ct.Album).textAlign=this.ra(s);break;case"Header/drawAlbum":Xt.getOrCreateHeaderFooterStyle(t,ct.Album).isVisible=s;break;case"Header/Words":Xt.getOrCreateHeaderFooterStyle(t,ct.Words).template=s;break;case"Header/WordsAlignment":Xt.getOrCreateHeaderFooterStyle(t,ct.Words).textAlign=this.ra(s);break;case"Header/drawWords":Xt.getOrCreateHeaderFooterStyle(t,ct.Words).isVisible=s;break;case"Header/Music":Xt.getOrCreateHeaderFooterStyle(t,ct.Music).template=s;break;case"Header/MusicAlignment":Xt.getOrCreateHeaderFooterStyle(t,ct.Music).textAlign=this.ra(s);break;case"Header/drawMusic":Xt.getOrCreateHeaderFooterStyle(t,ct.Music).isVisible=s;break;case"Header/WordsAndMusic":Xt.getOrCreateHeaderFooterStyle(t,ct.WordsAndMusic).template=s;break;case"Header/WordsAndMusicAlignment":Xt.getOrCreateHeaderFooterStyle(t,ct.WordsAndMusic).textAlign=this.ra(s);break;case"Header/drawWordsAndMusic":Xt.getOrCreateHeaderFooterStyle(t,ct.WordsAndMusic).isVisible=s;break;case"Header/Tabber":Xt.getOrCreateHeaderFooterStyle(t,ct.Transcriber).template=s;break;case"Header/TabberAlignment":Xt.getOrCreateHeaderFooterStyle(t,ct.Transcriber).textAlign=this.ra(s);break;case"Header/drawTabber":Xt.getOrCreateHeaderFooterStyle(t,ct.Transcriber).isVisible=s;break;case"Footer/Copyright":Xt.getOrCreateHeaderFooterStyle(t,ct.Copyright).template=s;break;case"Footer/CopyrightAlignment":Xt.getOrCreateHeaderFooterStyle(t,ct.Copyright).textAlign=this.ra(s);break;case"Footer/drawCopyright":Xt.getOrCreateHeaderFooterStyle(t,ct.Copyright).isVisible=s;break;case"Footer/Copyright2":Xt.getOrCreateHeaderFooterStyle(t,ct.CopyrightSecondLine).template=s;break;case"Footer/Copyright2Alignment":Xt.getOrCreateHeaderFooterStyle(t,ct.CopyrightSecondLine).textAlign=this.ra(s);break;case"Footer/drawCopyright2":Xt.getOrCreateHeaderFooterStyle(t,ct.CopyrightSecondLine).isVisible=s;break;case"System/barIndexDrawType":switch(s){case 0:t.stylesheet.barNumberDisplay=I.AllBars;break;case 1:t.stylesheet.barNumberDisplay=I.FirstOfSystem;break;case 2:t.stylesheet.barNumberDisplay=I.Hide}}}ra(t){switch(t){case 0:return ht.Left;case 1:return ht.Center;case 2:return ht.Right}return ht.Left}addValue(t,e,s){this.raw.set(t,e),void 0!==s&&this.ia.set(t,s)}writeTo(t){fe.writeInt32BE(t,this.raw.size);for(const[e,s]of this.raw){const i=this.aa(e,s);switch(Hs.gpWriteString(t,e),t.writeByte(i),i){case je.Boolean:t.writeByte(s?1:0);break;case je.Integer:fe.writeInt32BE(t,s);break;case je.Float:fe.writeFloat32BE(t,s);break;case je.String:const e=fe.stringToBytes(s);fe.writeInt16BE(t,e.length),t.write(e,0,e.length);break;case je.Point:case je.Size:fe.writeInt32BE(t,s.offset),fe.writeInt32BE(t,s.value);break;case je.Rectangle:fe.writeInt32BE(t,s.x),fe.writeInt32BE(t,s.y),fe.writeInt32BE(t,s.w),fe.writeInt32BE(t,s.h);break;case je.Color:t.writeByte(s.r),t.writeByte(s.g),t.writeByte(s.b),t.writeByte(s.a)}}}aa(e,s){if(this.ia.has(e))return this.ia.get(e);const i=typeof s;switch(typeof s){case"string":return je.String;case"number":return s===(0|s)?je.Integer:je.Float;case"object":if(s instanceof z)return je.Point;if(s instanceof zs)return je.Rectangle;if(s instanceof Se)return je.Color}throw new G(t.AlphaTabErrorType.General,`Unknown value type in BinaryStylesheet: ${i}`)}static writeForScore(t){const e=new Xs;switch(e.addValue("StandardNotation/hideDynamics",t.stylesheet.hideDynamics,je.Boolean),e.addValue("System/bracketExtendMode",t.stylesheet.bracketExtendMode,je.Integer),e.addValue("Global/useSystemSignSeparator",t.stylesheet.useSystemSignSeparator,je.Boolean),e.addValue("Global/DisplayTuning",t.stylesheet.globalDisplayTuning,je.Boolean),e.addValue("Global/DrawChords",t.stylesheet.globalDisplayChordDiagramsOnTop,je.Boolean),e.addValue("System/drawChordInScore",t.stylesheet.globalDisplayChordDiagramsInScore,je.Boolean),t.stylesheet.singleTrackTrackNamePolicy){case L.Hidden:e.addValue("System/showTrackNameSingle",!1,je.Boolean);break;case L.FirstSystem:e.addValue("System/trackNameModeSingle",0,je.Integer);break;case L.AllSystems:e.addValue("System/trackNameModeSingle",2,je.Integer)}switch(t.stylesheet.multiTrackTrackNamePolicy){case L.Hidden:e.addValue("System/showTrackNameMulti",!1,je.Boolean);break;case L.FirstSystem:e.addValue("System/trackNameModeMulti",0,je.Integer);break;case L.AllSystems:e.addValue("System/trackNameModeMulti",2,je.Integer)}switch(t.stylesheet.firstSystemTrackNameMode){case W.FullName:e.addValue("System/shortTrackNameOnFirstSystem",!1,je.Boolean);break;case W.ShortName:e.addValue("System/shortTrackNameOnFirstSystem",!0,je.Boolean)}switch(t.stylesheet.otherSystemsTrackNameMode){case W.FullName:e.addValue("System/shortTrackNameOnOtherSystems",!1,je.Boolean);break;case W.ShortName:e.addValue("System/shortTrackNameOnOtherSystems",!0,je.Boolean)}switch(t.stylesheet.firstSystemTrackNameOrientation){case R.Horizontal:e.addValue("System/horizontalTrackNameOnFirstSystem",!0,je.Boolean);break;case R.Vertical:e.addValue("System/horizontalTrackNameOnFirstSystem",!1,je.Boolean)}switch(t.stylesheet.otherSystemsTrackNameOrientation){case R.Horizontal:e.addValue("System/horizontalTrackNameOnOtherSystems",!0,je.Boolean);break;case R.Vertical:e.addValue("System/horizontalTrackNameOnOtherSystems",!1,je.Boolean)}e.addValue("System/ExtendedBarLines",t.stylesheet.extendBarLines,je.Boolean);const s=t.style;if(s)for(const[t,i]of s.headerAndFooter)switch(t){case ct.Title:Xs.ha(e,i,"Header/","Title");break;case ct.SubTitle:Xs.ha(e,i,"Header/","Subtitle");break;case ct.Artist:Xs.ha(e,i,"Header/","Artist");break;case ct.Album:Xs.ha(e,i,"Header/","Album");break;case ct.Words:Xs.ha(e,i,"Header/","Words");break;case ct.Music:Xs.ha(e,i,"Header/","Music");break;case ct.WordsAndMusic:Xs.ha(e,i,"Header/","WordsAndMusic");break;case ct.Transcriber:Xs.ha(e,i,"Header/","Tabber");break;case ct.Copyright:Xs.ha(e,i,"Footer/","Copyright");break;case ct.CopyrightSecondLine:Xs.ha(e,i,"Footer/","Copyright2")}switch(t.stylesheet.barNumberDisplay){case I.AllBars:e.addValue("System/barIndexDrawType",0,je.Integer);break;case I.FirstOfSystem:e.addValue("System/barIndexDrawType",1,je.Integer);break;case I.Hide:e.addValue("System/barIndexDrawType",2,je.Integer)}const i=Ae.withCapacity(128);return e.writeTo(i),i.toArray()}static ha(t,e,s,i){t.addValue(`${s}${i}`,e.template,je.String),t.addValue(`${s}${i}Alignment`,e.textAlign,je.Integer),void 0!==e.isVisible&&t.addValue(`${s}draw${i}`,e.isVisible,je.Boolean)}}class js{rawAudioFile}class Js{id="";dots=0;tupletDenominator=-1;tupletNumerator=-1;value=l.Quarter}class qs{name="";path="";role="";get uniqueId(){return`${this.path};${this.name};${this.role}`}program=0;bank=0}class Ys{static oa="-1";static ca=z.MaxPosition/100;static la=.04;static ua=44100;score;da;fa;pa;ba;ma;ga;wa;ya;ka;Sa;Ba;_a;Ta;xa;Ma;va;Na;Pa;Ca;Ea;Fa=!1;Aa;Da=!1;La=0;jr=new Set;qr=new Map;loadAsset;parseXml(t,e){this.fa=new Map,this.pa=new Map,this.ba=new Map,this.ma=[],this.ga=new Map,this.wa=[],this.ya=[],this.Sa=new Map,this.ka=new Map,this.Ba=new Map,this._a=new Map,this.xa=new Map,this.Ta=new Map,this.Ma=new Map,this.Na=new Map,this.va=new Map,this.Pa=new Map,this.Ca=new Map,this.Ea=new Map,this.Da=!1;const s=new Ms;try{s.parse(t)}catch(t){throw new Fe("Could not parse XML",t)}if(this.Ln(s),this.Wa(),Xt.consolidate(this.score),this.score.finish(e),!this.Da&&this.Ca.size>0)for(const[t,e]of this.Ca){this.ga.get(t).applyLyrics(e)}}Ln(t){const e=t.firstElement;if(e){if("GPIF"!==e.localName)throw new Fe("Root node of XML was not GPIF");this.score=new $t;for(const t of e.childElements())switch(t.localName){case"Score":this.Ra(t);break;case"MasterTrack":this.Ia(t);break;case"BackingTrack":this.Oa(t);break;case"Tracks":this.Ga(t);break;case"MasterBars":this.Va(t);break;case"Bars":this.$a(t);break;case"Voices":this.ar(t);break;case"Beats":this.Ha(t);break;case"Notes":this.Ua(t);break;case"Rhythms":this.za(t);break;case"Assets":this.Xa(t)}}}Xa(t){for(const e of t.childElements())if("Asset"===e.localName)e.getAttribute("id")===this.da&&this.ja(e)}ja(t){let e="";for(const s of t.childElements())if("EmbeddedFilePath"===s.localName)e=s.innerText;const s=this.loadAsset;if(s){const t=s(e);t?this.score.backingTrack.rawAudioFile=t:this.score.backingTrack=void 0}}Ra(t){for(const e of t.childElements())switch(e.localName){case"Title":this.score.title=e.innerText;break;case"SubTitle":this.score.subTitle=e.innerText;break;case"Artist":this.score.artist=e.innerText;break;case"Album":this.score.album=e.innerText;break;case"Words":this.score.words=e.innerText;break;case"Music":this.score.music=e.innerText;break;case"WordsAndMusic":const t=e.innerText;""!==t&&(t&&!this.score.words&&(this.score.words=t),t&&!this.score.music&&(this.score.music=t));break;case"Copyright":this.score.copyright=e.innerText;break;case"Tabber":this.score.tab=e.innerText;break;case"Instructions":this.score.instructions=e.innerText;break;case"Notices":this.score.notices=e.innerText;break;case"ScoreSystemsDefaultLayout":this.score.defaultSystemsLayout=Ys.Ja(e.innerText,4);break;case"ScoreSystemsLayout":this.score.systemsLayout=Ys.qa(e.innerText).map(t=>Ys.Ja(t,4))}}static Ja(t,e){if(!t)return e;const s=Number.parseInt(t,10);return Number.isNaN(s)?e:s}static Ya(t,e){if(!t)return e;const s=Number.parseFloat(t);return Number.isNaN(s)?e:s}static qa(t,e=" "){return t?t.split(e).map(t=>t.trim()).filter(t=>t.length>0):[]}Oa(t){const e=new js;let s=!1,i="",n="";for(const e of t.childElements())switch(e.localName){case"Enabled":s="true"===e.innerText;break;case"Source":i=e.innerText;break;case"AssetId":n=e.innerText;break;case"FramePadding":this.La=Ys.Ja(e.innerText,0)/Ys.ua*1e3}s&&"Local"===i&&(this.score.backingTrack=e,this.da=n)}Ia(t){for(const e of t.childElements())switch(e.localName){case"Automations":this.Ka(e,this.fa,null,null);break;case"Tracks":this.ma=Ys.qa(e.innerText);break;case"Anacrusis":this.Fa=!0}}Ka(t,e,s,i){for(const n of t.childElements())if("Automation"===n.localName)this.Qa(n,e,s,i)}Qa(t,e,s,i){let n,a=null,h=!1,o=-1,c=0,l=0,u=null,d=0,f=null,p=!0;for(const e of t.childElements())switch(e.localName){case"Type":a=e.innerText;break;case"Linear":h="true"===e.innerText.toLowerCase();break;case"Bar":o=Ys.Ja(e.innerText,0);break;case"Position":c=Ys.Ya(e.innerText,0);break;case"Value":if(e.firstElement&&e.firstElement.nodeType===He.CDATA)u=e.innerText;else if(e.firstElement&&e.firstElement.nodeType===He.Element&&"SyncPoint"===a){n=new H;for(const t of e.childElements())switch(t.localName){case"BarIndex":o=Ys.Ja(t.innerText,0);break;case"BarOccurrence":n.barOccurence=Ys.Ja(t.innerText,0);break;case"FrameOffset":const e=Ys.Ya(t.innerText,0);n.millisecondOffset=e/Ys.ua*1e3}}else{const t=Ys.qa(e.innerText);1===t.length?(l=Ys.Ya(t[0],0),d=1):(l=Ys.Ya(t[0],0),d=Ys.Ja(t[1],0))}break;case"Text":f=e.innerText;break;case"Visible":p="true"===e.innerText.toLowerCase()}if(!a)return;const b=[];switch(a){case"Tempo":b.push(U.buildTempoAutomation(h,c,l,d,p));break;case"SyncPoint":const t=new U;t.type=r.SyncPoint,t.isLinear=h,t.ratioPosition=c,t.syncPointValue=n,t.isVisible=p,b.push(t);break;case"Sound":if(u&&s&&s.has(u)){const t=new U;t.type=r.Bank,t.ratioPosition=c,t.value=s.get(u).bank,t.isVisible=p,b.push(t);const e=U.buildInstrumentAutomation(h,c,s.get(u).program);b.push(e)}break;case"SustainPedal":if(i){let t;i.has(o)?t=i.get(o):(t=[],i.set(o,t));const e=new K;switch(e.ratioPosition=c,d){case 1:e.pedalType=C.Down;break;case 3:e.pedalType=C.Up}t.push(e)}}if(b.length){if(f)for(const t of b)t.text=f;if(o>=0){e.has(o)||e.set(o,[]);for(const t of b)e.get(o).push(t)}}}Ga(t){for(const e of t.childElements())if("Track"===e.localName)this.Za(e)}Za(t){this.Aa=new Map;const e=new Pe;e.ensureStaveCount(1);e.staves[0].showStandardNotation=!0;const s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Name":e.name=i.innerText;break;case"Color":const t=Ys.qa(i.innerText);if(t.length>=3){const s=Ys.Ja(t[0],0),i=Ys.Ja(t[1],0),n=Ys.Ja(t[2],0);e.color=new Se(s,i,n,255)}break;case"Instrument":const n=i.getAttribute("ref");(n.endsWith("-gs")||n.endsWith("GrandStaff"))&&(e.ensureStaveCount(2),e.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this.th(e,i);break;case"NotationPatch":this.eh(e,i);break;case"ShortName":e.shortName=i.innerText;break;case"SystemsDefautLayout":e.defaultSystemsLayout=Ys.Ja(i.innerText,4);break;case"SystemsLayout":e.systemsLayout=Ys.qa(i.innerText).map(t=>Ys.Ja(t,4));break;case"Lyrics":this.sh(s,i);break;case"Properties":this.ih(e,i);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this.nh(e,i);break;case"Sounds":this.rh(s,e,i);break;case"PlaybackState":const r=i.innerText;e.playbackInfo.isSolo="Solo"===r,e.playbackInfo.isMute="Mute"===r;break;case"PartSounding":this.ah(s,e,i);break;case"Staves":this.tr(e,i);break;case"Transpose":this.hh(s,e,i);break;case"RSE":this.oh(e,i);break;case"Automations":this.uh(s,i)}this.ga.set(s,e)}uh(t,e){const s=new Map;this.pa.set(t,s);const i=new Map;this.ba.set(t,i),this.Ka(e,s,this.Ea.get(t),i)}eh(t,e){for(const s of e.childElements())switch(s.localName){case"LineCount":const e=Ys.Ja(s.innerText,5);for(const s of t.staves)s.standardNotationLineCount=e;break;case"Elements":this.dh(t,s,!1)}}th(t,e){for(const s of e.childElements())switch(s.localName){case"Type":if("drumKit"===s.innerText)for(const e of t.staves)e.isPercussion=!0;break;case"Elements":this.dh(t,s,!0);break;case"LineCount":const e=Ys.Ja(s.innerText,5);for(const s of t.staves)s.standardNotationLineCount=e}}dh(t,e,s){for(const i of e.childElements())if("Element"===i.localName)this.fh(t,i,s)}fh(t,e,s){const i=e.findChildElement("Name")?.innerText??"";for(const n of e.childElements())switch(n.localName){case"Name":case"Articulations":this.ph(t,n,s,i)}}ph(t,e,s,i){for(const n of e.childElements())if("Articulation"===n.localName)this.bh(t,n,s,i)}bh(t,e,s,i){const n=new Jt;n.outputMidiNumber=-1,n.elementType=i;let r="";for(const t of e.childElements()){const e=t.innerText;switch(t.localName){case"Name":r=t.innerText;break;case"InputMidiNumbers":n.id=Ys.Ja(e.split(" ")[0],0);break;case"OutputMidiNumber":n.outputMidiNumber=Ys.Ja(e,0);break;case"TechniqueSymbol":n.techniqueSymbol=Ys.parseTechniqueSymbol(e);break;case"TechniquePlacement":n.techniqueSymbolPlacement=Ys.parseTechniqueSymbolPlacement(e);break;case"Noteheads":const s=Ys.qa(e);s.length>=1&&(n.noteHeadDefault=Ys.parseNoteHead(s[0])),s.length>=2&&(n.noteHeadHalf=Ys.parseNoteHead(s[1])),s.length>=3&&(n.noteHeadWhole=Ys.parseNoteHead(s[2])),n.noteHeadHalf===ut.None&&(n.noteHeadHalf=n.noteHeadDefault),n.noteHeadWhole===ut.None&&(n.noteHeadWhole=n.noteHeadDefault);break;case"StaffLine":n.staffLine=Ys.Ja(e,0)}}const a=`${i}.${r}`;s?(t.percussionArticulations.push(n),this.Aa.set(a,n)):this.Aa.has(a)&&(this.Aa.get(a).staffLine=n.staffLine)}static parseTechniqueSymbol(t){switch(t){case"pictEdgeOfCymbal":return ut.PictEdgeOfCymbal;case"articStaccatoAbove":return ut.ArticStaccatoAbove;case"noteheadParenthesis":return ut.NoteheadParenthesis;case"stringsUpBow":return ut.StringsUpBow;case"stringsDownBow":return ut.StringsDownBow;case"guitarGolpe":return ut.GuitarGolpe;default:return ut.None}}static parseTechniqueSymbolPlacement(t){switch(t){case"outside":default:return dt.Outside;case"inside":return dt.Inside;case"above":return dt.Above;case"below":return dt.Below}}static parseNoteHead(t){switch(t){case"noteheadDoubleWholeSquare":return ut.NoteheadDoubleWholeSquare;case"noteheadDoubleWhole":return ut.NoteheadDoubleWhole;case"noteheadWhole":return ut.NoteheadWhole;case"noteheadHalf":return ut.NoteheadHalf;case"noteheadBlack":return ut.NoteheadBlack;case"noteheadNull":return ut.NoteheadNull;case"noteheadXOrnate":return ut.NoteheadXOrnate;case"noteheadTriangleUpWhole":return ut.NoteheadTriangleUpWhole;case"noteheadTriangleUpHalf":return ut.NoteheadTriangleUpHalf;case"noteheadTriangleUpBlack":return ut.NoteheadTriangleUpBlack;case"noteheadDiamondBlackWide":return ut.NoteheadDiamondBlackWide;case"noteheadDiamondWhite":return ut.NoteheadDiamondWhite;case"noteheadDiamondWhiteWide":return ut.NoteheadDiamondWhiteWide;case"noteheadCircleX":return ut.NoteheadCircleX;case"noteheadXWhole":return ut.NoteheadXWhole;case"noteheadXHalf":return ut.NoteheadXHalf;case"noteheadXBlack":return ut.NoteheadXBlack;case"noteheadParenthesis":return ut.NoteheadParenthesis;case"noteheadSlashedBlack2":return ut.NoteheadSlashedBlack2;case"noteheadCircleSlash":return ut.NoteheadCircleSlash;case"noteheadHeavyX":return ut.NoteheadHeavyX;case"noteheadHeavyXHat":return ut.NoteheadHeavyXHat;default:return q.warning("GPIF","Unknown notehead symbol",t),ut.None}}tr(t,e){let s=0;for(const i of e.childElements())if("Staff"===i.localName){t.ensureStaveCount(s+1);const e=t.staves[s];this.er(e,i),s++}}er(t,e){for(const s of e.childElements())if("Properties"===s.localName)this.mh(t,s)}mh(t,e){for(const s of e.childElements())if("Property"===s.localName)this.gh(t,s)}gh(t,e){switch(e.getAttribute("name")){case"Tuning":for(const s of e.childElements())switch(s.localName){case"Pitches":const i=Ys.qa(e.findChildElement("Pitches")?.innerText),n=new Array(i.length);for(let t=0;t<n.length;t++)n[n.length-1-t]=Ys.Ja(i[t],0);t.stringTuning.tunings=n;break;case"Label":t.stringTuning.name=s.innerText}t.isPercussion||(t.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this.wh(t,e);break;case"CapoFret":const s=Ys.Ja(e.findChildElement("Fret")?.innerText,0);t.capo=s}}sh(t,e){const s=[];for(const t of e.childElements())if("Line"===t.localName)s.push(this.yh(t));this.Ca.set(t,s)}yh(t){const e=new _e;for(const s of t.childElements())switch(s.localName){case"Offset":e.startBar=Ys.Ja(s.innerText,0);break;case"Text":e.text=s.innerText}return e}kh(t,e){const s=e.findChildElement("Items");if(s)for(const e of s.childElements())if("Item"===e.localName)this.Sh(t,e)}wh(t,e){const s=e.findChildElement("Items");if(s)for(const e of s.childElements())if("Item"===e.localName)this.Bh(t,e)}Sh(t,e){const s=new ye,i=e.getAttribute("id");for(const e of t.staves)e.addChord(i,s);this._h(s,e)}Bh(t,e){const s=new ye,i=e.getAttribute("id");t.addChord(i,s),this._h(s,e)}_h(t,e){t.name=e.getAttribute("name");const s=e.findChildElement("Diagram");if(!s)return t.showDiagram=!1,void(t.showFingering=!1);const i=Ys.Ja(s.getAttribute("stringCount"),6),n=Ys.Ja(s.getAttribute("baseFret"),0);t.firstFret=n+1;for(let e=0;e<i;e++)t.strings.push(-1);for(const e of s.childElements())switch(e.localName){case"Fret":const s=Ys.Ja(e.getAttribute("string"),0);t.strings[i-s-1]=n+Ys.Ja(e.getAttribute("fret"),0);break;case"Fingering":const r=new Map;for(const s of e.childElements())if("Position"===s.localName){let e=f.Unknown;const i=n+Ys.Ja(s.getAttribute("fret"),0);switch(s.getAttribute("finger")){case"Index":e=f.IndexFinger;break;case"Middle":e=f.MiddleFinger;break;case"Rank":e=f.AnnularFinger;break;case"Pinky":e=f.LittleFinger;break;case"Thumb":e=f.Thumb}e!==f.Unknown&&(r.has(e)?t.barreFrets.push(i):r.set(e,!0))}break;case"Property":switch(e.getAttribute("name")){case"ShowName":t.showName="true"===e.getAttribute("value");break;case"ShowDiagram":t.showDiagram="true"===e.getAttribute("value");break;case"ShowFingering":t.showFingering="true"===e.getAttribute("value")}}}ih(t,e){for(const s of e.childElements())if("Property"===s.localName)this.Th(t,s)}Th(t,e){switch(e.getAttribute("name")){case"Tuning":const s=Ys.qa(e.findChildElement("Pitches")?.innerText),i=new Array(s.length);for(let t=0;t<i.length;t++)i[i.length-1-t]=Ys.Ja(s[t],0);for(const e of t.staves)e.stringTuning.tunings=i,e.showStandardNotation=!0,e.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this.kh(t,e);break;case"CapoFret":const n=Ys.Ja(e.findChildElement("Fret")?.innerText,0);for(const e of t.staves)e.capo=n}}nh(t,e){for(const s of e.childElements())switch(s.localName){case"Program":t.playbackInfo.program=Ys.Ja(s.innerText,0);break;case"Port":t.playbackInfo.port=Ys.Ja(s.innerText,0);break;case"PrimaryChannel":t.playbackInfo.primaryChannel=Ys.Ja(s.innerText,0);break;case"SecondaryChannel":t.playbackInfo.secondaryChannel=Ys.Ja(s.innerText,0)}if("Percussion"===e.getAttribute("table"))for(const e of t.staves)e.isPercussion=!0}rh(t,e,s){for(const i of s.childElements())if("Sound"===i.localName)this.xh(t,e,i)}xh(t,e,s){const i=new qs;for(const t of s.childElements())switch(t.localName){case"Name":i.name=t.innerText;break;case"Path":i.path=t.innerText;break;case"Role":i.role=t.innerText;break;case"MIDI":this.Mh(i,t)}this.Ea.has(t)||(this.Ea.set(t,new Map),e.playbackInfo.program=i.program,e.playbackInfo.bank=i.bank),this.Ea.get(t).set(i.uniqueId,i)}Mh(t,e){let s=0,i=0;for(const n of e.childElements())switch(n.localName){case"Program":t.program=Ys.Ja(n.innerText,0);break;case"MSB":s=Ys.Ja(n.innerText,0);break;case"LSB":i=Ys.Ja(n.innerText,0)}t.bank=(127&s)<<7|i}ah(t,e,s){for(const i of s.childElements())switch(i.localName){case"TranspositionPitch":for(const t of e.staves)t.displayTranspositionPitch=Ys.Ja(i.innerText,0);break;case"NominalKey":const s=Math.max(0,xe.noteNames.indexOf(i.innerText));this.Nh.set(t,s)}}Nh=new Map;hh(t,e,s){let i=0,n=0;for(const t of s.childElements())switch(t.localName){case"Chromatic":n=Ys.Ja(t.innerText,0);break;case"Octave":i=Ys.Ja(t.innerText,0)}const r=12*i+n;for(const t of e.staves)t.displayTranspositionPitch=r;const a=Xt.flooredDivision(r,12);this.Nh.set(t,a)}oh(t,e){for(const s of e.childElements())if("ChannelStrip"===s.localName)this.Ph(t,s)}Ph(t,e){for(const s of e.childElements())if("Parameters"===s.localName)this.Ch(t,s)}Ch(t,e){if(e.firstChild&&e.firstChild.value){const s=Ys.qa(e.firstChild.value);s.length>=12&&(t.playbackInfo.balance=Math.floor(16*Ys.Ya(s[11],.5)),t.playbackInfo.volume=Math.floor(16*Ys.Ya(s[12],.9)))}}Va(t){for(const e of t.childElements())if("MasterBar"===e.localName)this.Eh(e)}Eh(t){const e=new et;0===this.wa.length&&this.Fa&&(e.isAnacrusis=!0);for(const s of t.childElements())switch(s.localName){case"Time":const t=s.innerText.split("/");e.timeSignatureNumerator=Ys.Ja(t[0],4),e.timeSignatureDenominator=Ys.Ja(t[1],4);break;case"FreeTime":e.isFreeTime=!0;break;case"DoubleBar":e.isDoubleBar=!0,this.jr.add(e);break;case"Section":e.section=new Te,e.section.marker=s.findChildElement("Letter")?.innerText??"",e.section.text=s.findChildElement("Text")?.innerText??"";break;case"Repeat":"true"===s.getAttribute("start").toLowerCase()&&(e.isRepeatStart=!0),"true"===s.getAttribute("end").toLowerCase()&&s.getAttribute("count")&&(e.repeatCount=Ys.Ja(s.getAttribute("count"),1));break;case"AlternateEndings":const i=Ys.qa(s.innerText);let n=0;for(let t=0;t<i.length;t++)n|=1<<-1+Ys.Ja(i[t],0);e.alternateEndings=n;break;case"Bars":this.ya.push(Ys.qa(s.innerText));break;case"TripletFeel":switch(s.innerText){case"NoTripletFeel":e.tripletFeel=A.NoTripletFeel;break;case"Triplet8th":e.tripletFeel=A.Triplet8th;break;case"Triplet16th":e.tripletFeel=A.Triplet16th;break;case"Dotted8th":e.tripletFeel=A.Dotted8th;break;case"Dotted16th":e.tripletFeel=A.Dotted16th;break;case"Scottish8th":e.tripletFeel=A.Scottish8th;break;case"Scottish16th":e.tripletFeel=A.Scottish16th}break;case"Key":const r=Ys.Ja(s.findChildElement("AccidentalCount")?.innerText,0),a=s.findChildElement("Mode");let h=P.Major;if(a)switch(a.innerText.toLowerCase()){case"major":h=P.Major;break;case"minor":h=P.Minor}this.qr.set(this.wa.length,[r,h]);break;case"Fermatas":this.Fh(e,s);break;case"XProperties":this.Ah(e,s);break;case"Directions":this.Dh(e,s)}this.wa.push(e)}Dh(t,e){for(const s of e.childElements())switch(s.localName){case"Target":switch(s.innerText){case"Coda":t.addDirection(Xe.TargetCoda);break;case"DoubleCoda":t.addDirection(Xe.TargetDoubleCoda);break;case"Segno":t.addDirection(Xe.TargetSegno);break;case"SegnoSegno":t.addDirection(Xe.TargetSegnoSegno);break;case"Fine":t.addDirection(Xe.TargetFine)}break;case"Jump":switch(s.innerText){case"DaCapo":t.addDirection(Xe.JumpDaCapo);break;case"DaCapoAlCoda":t.addDirection(Xe.JumpDaCapoAlCoda);break;case"DaCapoAlDoubleCoda":t.addDirection(Xe.JumpDaCapoAlDoubleCoda);break;case"DaCapoAlFine":t.addDirection(Xe.JumpDaCapoAlFine);break;case"DaSegno":t.addDirection(Xe.JumpDalSegno);break;case"DaSegnoAlCoda":t.addDirection(Xe.JumpDalSegnoAlCoda);break;case"DaSegnoAlDoubleCoda":t.addDirection(Xe.JumpDalSegnoAlDoubleCoda);break;case"DaSegnoAlFine":t.addDirection(Xe.JumpDalSegnoAlFine);break;case"DaSegnoSegno":t.addDirection(Xe.JumpDalSegnoSegno);break;case"DaSegnoSegnoAlCoda":t.addDirection(Xe.JumpDalSegnoSegnoAlCoda);break;case"DaSegnoSegnoAlDoubleCoda":t.addDirection(Xe.JumpDalSegnoSegnoAlDoubleCoda);break;case"DaSegnoSegnoAlFine":t.addDirection(Xe.JumpDalSegnoSegnoAlFine);break;case"DaCoda":t.addDirection(Xe.JumpDaCoda);break;case"DaDoubleCoda":t.addDirection(Xe.JumpDaDoubleCoda)}}}Fh(t,e){for(const s of e.childElements())if("Fermata"===s.localName)this.Lh(t,s)}Lh(t,e){let s=0;const i=new Be;for(const t of e.childElements())switch(t.localName){case"Type":switch(t.innerText){case"Short":i.type=Dt.Short;break;case"Medium":i.type=Dt.Medium;break;case"Long":i.type=Dt.Long}break;case"Length":i.length=Ys.Ya(t.innerText,0);break;case"Offset":const e=t.innerText.split("/");if(2===e.length){s=Ys.Ja(e[0],4)/Ys.Ja(e[1],4)*$.QuarterTime|0}}t.addFermata(s,i)}$a(t){for(const e of t.childElements())if("Bar"===e.localName)this.Wh(e)}Wh(t){const e=new Z,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Voices":this.Sa.set(s,Ys.qa(i.innerText));break;case"Clef":switch(i.innerText){case"Neutral":e.clef=M.Neutral;break;case"G2":e.clef=M.G2;break;case"F4":e.clef=M.F4;break;case"C4":e.clef=M.C4;break;case"C3":e.clef=M.C3}break;case"Ottavia":switch(i.innerText){case"8va":e.clefOttava=m._;break;case"15ma":e.clefOttava=m.S;break;case"8vb":e.clefOttava=m.T;break;case"15mb":e.clefOttava=m.M}break;case"SimileMark":switch(i.innerText){case"Simple":e.simileMark=v.Simple;break;case"FirstOfDouble":e.simileMark=v.FirstOfDouble;break;case"SecondOfDouble":e.simileMark=v.SecondOfDouble}break;case"XProperties":this.Rh(i,e)}this.ka.set(s,e)}ar(t){for(const e of t.childElements())if("Voice"===e.localName)this.hr(e)}hr(t){const e=new at,s=t.getAttribute("id");for(const e of t.childElements())if("Beats"===e.localName)this._a.set(s,Ys.qa(e.innerText));this.Ba.set(s,e)}Ha(t){for(const e of t.childElements())if("Beat"===e.localName)this.Ih(e)}Ih(t){const e=new se,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Notes":this.Na.set(s,Ys.qa(i.innerText));break;case"Rhythm":this.Ta.set(s,i.getAttribute("ref"));break;case"Fadding":switch(i.innerText){case"FadeIn":e.fade=gt.FadeIn;break;case"FadeOut":e.fade=gt.FadeOut;break;case"VolumeSwell":e.fade=gt.VolumeSwell}break;case"Tremolo":const t=new te;switch(e.tremoloPicking=t,i.innerText){case"1/2":t.marks=1;break;case"1/4":t.marks=2;break;case"1/8":t.marks=3}break;case"Chord":e.chordId=i.innerText;break;case"Hairpin":switch(i.innerText){case"Crescendo":e.crescendo=c.Crescendo;break;case"Decrescendo":e.crescendo=c.Decrescendo}break;case"Arpeggio":"Up"===i.innerText?e.brushType=o.ArpeggioUp:e.brushType=o.ArpeggioDown;break;case"Properties":this.Oh(i,e);break;case"XProperties":this.Gh(i,e);break;case"FreeText":e.text=i.innerText;break;case"TransposedPitchStemOrientation":switch(i.innerText){case"Upward":e.preferredBeamDirection=Rt.Up;break;case"Downward":e.preferredBeamDirection=Rt.Down}break;case"Dynamic":switch(i.innerText){case"PPP":e.dynamics=n.PPP;break;case"PP":e.dynamics=n.PP;break;case"P":e.dynamics=n.P;break;case"MP":e.dynamics=n.MP;break;case"MF":e.dynamics=n.MF;break;case"F":e.dynamics=n.F;break;case"FF":e.dynamics=n.FF;break;case"FFF":e.dynamics=n.FFF}break;case"GraceNotes":switch(i.innerText){case"OnBeat":e.graceType=u.OnBeat;break;case"BeforeBeat":e.graceType=u.BeforeBeat}break;case"Legato":"true"===i.getAttribute("origin")&&(e.isLegatoOrigin=!0);break;case"Whammy":const r=new z(0,0);r.value=this.Vh(Ys.Ya(i.getAttribute("originValue"),0)),r.offset=this.$h(Ys.Ya(i.getAttribute("originOffset"),0)),e.addWhammyBarPoint(r);const a=new z(0,0);a.value=this.Vh(Ys.Ya(i.getAttribute("middleValue"),0)),a.offset=this.$h(Ys.Ya(i.getAttribute("middleOffset1"),0)),e.addWhammyBarPoint(a);const h=new z(0,0);h.value=this.Vh(Ys.Ya(i.getAttribute("middleValue"),0)),h.offset=this.$h(Ys.Ya(i.getAttribute("middleOffset2"),0)),e.addWhammyBarPoint(h);const l=new z(0,0);l.value=this.Vh(Ys.Ya(i.getAttribute("destinationValue"),0)),l.offset=this.$h(Ys.Ya(i.getAttribute("destinationOffset"),0)),e.addWhammyBarPoint(l);break;case"Ottavia":switch(i.innerText){case"8va":e.ottava=m._;break;case"8vb":e.ottava=m.T;break;case"15ma":e.ottava=m.S;break;case"15mb":e.ottava=m.M}break;case"Lyrics":e.lyrics=this.Hh(i),this.Da=!0;break;case"Slashed":e.slashed=!0;break;case"DeadSlapped":e.deadSlapped=!0;break;case"Golpe":switch(i.innerText){case"Finger":e.golpe=mt.Finger;break;case"Thumb":e.golpe=mt.Thumb}break;case"Wah":switch(i.innerText){case"Open":e.wahPedal=wt.Open;break;case"Closed":e.wahPedal=wt.Closed}break;case"UserTransposedPitchStemOrientation":switch(i.innerText){case"Downward":e.preferredBeamDirection=Rt.Down;break;case"Upward":e.preferredBeamDirection=Rt.Up}break;case"Timer":e.showTimer=!0,e.timer=Ys.Ja(i.innerText,-1),e.timer<0&&(e.timer=null)}this.xa.set(s,e)}Hh(t){const e=[];for(const s of t.childElements())if("Line"===s.localName)e.push(s.innerText);return e}Gh(t,e){for(const s of t.childElements())if("XProperty"===s.localName){let t=0;switch(s.getAttribute("id")){case"1124204546":switch(t=Ys.Ja(s.findChildElement("Int")?.innerText,0),t){case 1:e.beamingMode=Bt.ForceMergeWithNext;break;case 2:e.beamingMode=Bt.ForceSplitToNext}break;case"1124204552":if(t=Ys.Ja(s.findChildElement("Int")?.innerText,0),1===t)e.beamingMode!==Bt.ForceSplitToNext&&(e.beamingMode=Bt.ForceSplitOnSecondaryToNext);break;case"1124204545":t=Ys.Ja(s.findChildElement("Int")?.innerText,0),e.invertBeamDirection=1===t;break;case"687935489":t=Ys.Ja(s.findChildElement("Int")?.innerText,0),e.brushDuration=t}}}Rh(t,e){for(const s of t.childElements())if("XProperty"===s.localName){if("1124139520"===s.getAttribute("id")){const t=s.findChildElement("Double")??s.findChildElement("Float");e.displayScale=Ys.Ya(t?.innerText,1)}}}Ah(t,e){let s,i=Number.NaN;for(const n of e.childElements())if("XProperty"===n.localName){const e=n.getAttribute("id");switch(e){case"1124073984":t.displayScale=Ys.Ya(n.findChildElement("Double")?.innerText,1);break;case"1124139010":i=Ys.Ja(n.findChildElement("Int")?.innerText,Number.NaN);break;default:const r=Ys.Ja(e,0);if(r>=1124139264&&r<=1124139295){const t=r-1124139264,e=Ys.Ja(n.findChildElement("Int")?.innerText,Number.NaN);for(void 0===s&&(s=[]);s.length<t+1;)s.push(0);s[t]=e}}}if(!Number.isNaN(i)&&s){const e=new tt;e.groups.set(i,s),t.beamingRules=e}}Oh(t,e){let s=!1,i=null,n=null,r=null,a=null,h=null;for(const c of t.childElements())if("Property"===c.localName){switch(c.getAttribute("name")){case"Brush":"Up"===c.findChildElement("Direction")?.innerText?e.brushType=o.BrushUp:e.brushType=o.BrushDown;break;case"PickStroke":"Up"===c.findChildElement("Direction")?.innerText?e.pickStroke=lt.Up:e.pickStroke=lt.Down;break;case"Slapped":c.findChildElement("Enable")&&(e.slap=!0);break;case"Popped":c.findChildElement("Enable")&&(e.pop=!0);break;case"VibratoWTremBar":switch(c.findChildElement("Strength")?.innerText){case"Wide":e.vibrato=y.Wide;break;case"Slight":e.vibrato=y.Slight}break;case"WhammyBar":s=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":i||(i=new z(0,0)),i.value=this.Vh(Ys.Ya(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarOriginOffset":i||(i=new z(0,0)),i.offset=this.$h(Ys.Ya(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleValue":n=this.Vh(Ys.Ya(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset1":r=this.$h(Ys.Ya(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset2":a=this.$h(Ys.Ya(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationValue":h||(h=new z(z.MaxPosition,0)),h.value=this.Vh(Ys.Ya(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationOffset":h||(h=new z(0,0)),h.offset=this.$h(Ys.Ya(c.findChildElement("Float")?.innerText,0));break;case"BarreFret":e.barreFret=Ys.Ja(c.findChildElement("Fret")?.innerText,0);break;case"BarreString":switch(c.findChildElement("String")?.innerText){case"0":e.barreShape=yt.Full;break;case"1":e.barreShape=yt.Half}break;case"Rasgueado":switch(c.findChildElement("Rasgueado")?.innerText){case"ii_1":e.rasgueado=kt.Ii;break;case"mi_1":e.rasgueado=kt.Mi;break;case"mii_1":e.rasgueado=kt.MiiTriplet;break;case"mii_2":e.rasgueado=kt.MiiAnapaest;break;case"pmp_1":e.rasgueado=kt.PmpTriplet;break;case"pmp_2":e.rasgueado=kt.PmpAnapaest;break;case"pei_1":e.rasgueado=kt.PeiTriplet;break;case"pei_2":e.rasgueado=kt.PeiAnapaest;break;case"pai_1":e.rasgueado=kt.PaiTriplet;break;case"pai_2":e.rasgueado=kt.PaiAnapaest;break;case"ami_1":e.rasgueado=kt.AmiTriplet;break;case"ami_2":e.rasgueado=kt.AmiAnapaest;break;case"ppp_1":e.rasgueado=kt.Ppp;break;case"amii_1":e.rasgueado=kt.Amii;break;case"amip_1":e.rasgueado=kt.Amip;break;case"eami_1":e.rasgueado=kt.Eami;break;case"eamii_1":e.rasgueado=kt.Eamii;break;case"peami_1":e.rasgueado=kt.Peami}}}s&&(i||(i=new z(0,0)),h||(h=new z(z.MaxPosition,0)),e.addWhammyBarPoint(i),r&&n&&e.addWhammyBarPoint(new z(r,n)),a&&n&&e.addWhammyBarPoint(new z(a,n)),r||a||!n||e.addWhammyBarPoint(new z(z.MaxPosition/2|0,n)),e.addWhammyBarPoint(h))}Ua(t){for(const e of t.childElements())if("Note"===e.localName)this.Uh(e)}Uh(t){const e=new Qt,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Properties":this.zh(i,e,s);break;case"AntiAccent":"normal"===i.innerText.toLowerCase()&&(e.isGhost=!0);break;case"LetRing":e.isLetRing=!0;break;case"Trill":e.trillValue=Ys.Ja(i.innerText,-1),e.trillSpeed=l.Sixteenth;break;case"Accent":const t=Ys.Ja(i.innerText,0);1&t&&(e.isStaccato=!0),4&t&&(e.accentuated=d.Heavy),8&t&&(e.accentuated=d.Normal),16&t&&(e.accentuated=d.Tenuto);break;case"Tie":"true"===i.getAttribute("destination").toLowerCase()&&(e.isTieDestination=!0);break;case"Vibrato":switch(i.innerText){case"Slight":e.vibrato=y.Slight;break;case"Wide":e.vibrato=y.Wide}break;case"LeftFingering":switch(i.innerText){case"P":e.leftHandFinger=f.Thumb;break;case"I":e.leftHandFinger=f.IndexFinger;break;case"M":e.leftHandFinger=f.MiddleFinger;break;case"A":e.leftHandFinger=f.AnnularFinger;break;case"C":e.leftHandFinger=f.LittleFinger}break;case"RightFingering":switch(i.innerText){case"P":e.rightHandFinger=f.Thumb;break;case"I":e.rightHandFinger=f.IndexFinger;break;case"M":e.rightHandFinger=f.MiddleFinger;break;case"A":e.rightHandFinger=f.AnnularFinger;break;case"C":e.rightHandFinger=f.LittleFinger}break;case"InstrumentArticulation":e.percussionArticulation=Ys.Ja(i.innerText,0);break;case"Ornament":switch(i.innerText){case"Turn":e.ornament=ft.Turn;break;case"InvertedTurn":e.ornament=ft.InvertedTurn;break;case"UpperMordent":e.ornament=ft.UpperMordent;break;case"LowerMordent":e.ornament=ft.LowerMordent}}this.va.set(s,e)}zh(t,e,s){let i=!1,n=null,r=null,a=null,h=null,o=null,c=-1,l=-1,u=!1;for(const d of t.childElements())if("Property"===d.localName){switch(d.getAttribute("name")){case"ShowStringNumber":d.findChildElement("Enable")&&(e.showStringNumber=!0);break;case"String":e.string=Ys.Ja(d.findChildElement("String")?.innerText,0)+1;break;case"Fret":e.fret=Ys.Ja(d.findChildElement("Fret")?.innerText,0);break;case"Element":c=Ys.Ja(d.findChildElement("Element")?.innerText,0);break;case"Variation":l=Ys.Ja(d.findChildElement("Variation")?.innerText,0);break;case"Tapped":this.Pa.set(s,!0);break;case"HarmonicType":const t=d.findChildElement("HType");if(t)switch(t.innerText){case"NoHarmonic":e.harmonicType=p.None;break;case"Natural":e.harmonicType=p.Natural;break;case"Artificial":e.harmonicType=p.Artificial;break;case"Pinch":e.harmonicType=p.Pinch;break;case"Tap":e.harmonicType=p.Tap;break;case"Semi":e.harmonicType=p.Semi;break;case"Feedback":e.harmonicType=p.Feedback}break;case"HarmonicFret":const f=d.findChildElement("HFret");f&&(e.harmonicValue=Ys.Ya(f.innerText,0));break;case"Muted":d.findChildElement("Enable")&&(e.isDead=!0);break;case"PalmMuted":d.findChildElement("Enable")&&(e.isPalmMute=!0);break;case"Octave":e.octave=Ys.Ja(d.findChildElement("Number")?.innerText,0),-1===e.tone&&(e.tone=0);break;case"Tone":e.tone=Ys.Ja(d.findChildElement("Step")?.innerText,0);break;case"ConcertPitch":u||this.Xh(d,e);break;case"TransposedPitch":e.accidentalMode=b.Default,this.Xh(d,e),u=!0;break;case"Bended":i=!0;break;case"BendOriginValue":n||(n=new z(0,0)),n.value=this.Vh(Ys.Ya(d.findChildElement("Float")?.innerText,0));break;case"BendOriginOffset":n||(n=new z(0,0)),n.offset=this.$h(Ys.Ya(d.findChildElement("Float")?.innerText,0));break;case"BendMiddleValue":r=this.Vh(Ys.Ya(d.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset1":a=this.$h(Ys.Ya(d.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset2":h=this.$h(Ys.Ya(d.findChildElement("Float")?.innerText,0));break;case"BendDestinationValue":o||(o=new z(z.MaxPosition,0)),o.value=this.Vh(Ys.Ya(d.findChildElement("Float")?.innerText,0));break;case"BendDestinationOffset":o||(o=new z(0,0)),o.offset=this.$h(Ys.Ya(d.findChildElement("Float")?.innerText,0));break;case"HopoOrigin":d.findChildElement("Enable")&&(e.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"LeftHandTapped":e.isLeftHandTapped=!0;break;case"Slide":const m=Ys.Ja(d.findChildElement("Flags")?.innerText,0);1&m?e.slideOutType=w.Shift:2&m?e.slideOutType=w.Legato:4&m?e.slideOutType=w.OutDown:8&m&&(e.slideOutType=w.OutUp),16&m?e.slideInType=g.IntoFromBelow:32&m&&(e.slideInType=g.IntoFromAbove),64&m?e.slideOutType=w.PickSlideDown:128&m&&(e.slideOutType=w.PickSlideUp)}}i&&(n||(n=new z(0,0)),o||(o=new z(z.MaxPosition,0)),e.addBendPoint(n),a&&r&&e.addBendPoint(new z(a,r)),h&&r&&e.addBendPoint(new z(h,r)),a||h||!r||e.addBendPoint(new z(z.MaxPosition/2|0,r)),e.addBendPoint(o)),-1!==c&&-1!==l&&(e.percussionArticulation=qt.articulationFromElementVariation(c,l))}Xh(t,e){const s=t.findChildElement("Pitch");if(s)for(const t of s.childElements())if("Accidental"===t.localName)switch(t.innerText){case"x":e.accidentalMode=b.ForceDoubleSharp;break;case"#":e.accidentalMode=b.ForceSharp;break;case"b":e.accidentalMode=b.ForceFlat;break;case"bb":e.accidentalMode=b.ForceDoubleFlat}}Vh(t){return t*Ys.la|0}$h(t){return t*Ys.ca}za(t){for(const e of t.childElements())if("Rhythm"===e.localName)this.jh(e)}jh(t){const e=new Js,s=t.getAttribute("id");e.id=s;for(const s of t.childElements())switch(s.localName){case"NoteValue":switch(s.innerText){case"Long":e.value=l.QuadrupleWhole;break;case"DoubleWhole":e.value=l.DoubleWhole;break;case"Whole":e.value=l.Whole;break;case"Half":e.value=l.Half;break;case"Quarter":e.value=l.Quarter;break;case"Eighth":e.value=l.Eighth;break;case"16th":e.value=l.Sixteenth;break;case"32nd":e.value=l.ThirtySecond;break;case"64th":e.value=l.SixtyFourth;break;case"128th":e.value=l.OneHundredTwentyEighth;break;case"256th":e.value=l.TwoHundredFiftySixth}break;case"PrimaryTuplet":e.tupletNumerator=Ys.Ja(s.getAttribute("num"),-1),e.tupletDenominator=Ys.Ja(s.getAttribute("den"),-1);break;case"AugmentationDot":e.dots=Ys.Ja(s.getAttribute("count"),0)}this.Ma.set(s,e)}Wa(){for(let t=0,e=this.wa.length;t<e;t++){const e=this.wa[t];this.score.addMasterBar(e)}const t=this.wa[this.wa.length-1];this.jr.has(t)&&(this.jr.delete(t),t.isDoubleBar=!1);const e=[];for(const t of this.ma){if(!t)continue;const s=this.ga.get(t);this.score.addTrack(s),e.push(t)}let s;for(const t of this.ya){let i=0,n=0;s=[N.C,P.Major],this.Nh.has(e[0])&&(s=[Xt.transposeKey(s[0],this.Nh.get(e[0])),s[1]]);for(let r=0;r<t.length&&n<this.score.tracks.length;r++){const a=t[r];if(a!==Ys.oa){const t=this.ka.get(a),r=this.score.tracks[n],h=r.staves[i];h.addBar(t);const o=h.bars.length-1;if(this.qr.has(o)&&(s=this.qr.get(o),this.Nh.has(e[n])&&(s=[Xt.transposeKey(s[0],this.Nh.get(e[n])),s[1]])),t.keySignature=s[0],t.keySignatureType=s[1],this.jr.has(t.masterBar)&&(t.barLineRight=F.LightLight),this.Sa.has(a))for(const e of this.Sa.get(a))if(e!==Ys.oa){const s=this.Ba.get(e);if(t.addVoice(s),this._a.has(e))for(const t of this._a.get(e))if(t!==Ys.oa){const e=oe.clone(this.xa.get(t));s.addBeat(e);const i=this.Ta.get(t),n=this.Ma.get(i);if(e.duration=n.value,e.dots=n.dots,e.tupletNumerator=n.tupletNumerator,e.tupletDenominator=n.tupletDenominator,this.Na.has(t))for(const s of this.Na.get(t))if(s!==Ys.oa){const t=ne.clone(this.va.get(s));h.isPercussion?(t.fret=-1,t.string=-1):t.percussionArticulation=-1,e.addNote(t),this.Pa.has(s)&&(e.tap=!0)}}}else{const e=new at;t.addVoice(e);const s=new se;s.isEmpty=!0,s.duration=l.Quarter,e.addBeat(s)}i===r.staves.length-1?(n++,i=0):i++,s=[N.C,P.Major],n<e.length&&this.Nh.has(e[n])&&(s=[Xt.transposeKey(s[0],this.Nh.get(e[n])),s[1]])}else n++}}for(const t of this.ma){if(!t)continue;const e=this.ga.get(t);let s=!1;for(const t of e.staves)if(t.isPercussion){s=!0;break}if(s||(e.percussionArticulations=[]),this.pa.has(t)){const s=this.pa.get(t);for(const[t,i]of s)if(e.staves.length>0&&t<e.staves[0].bars.length){const s=e.staves[0].bars[t];if(s.voices.length>0&&s.voices[0].beats.length>0){const t=s.voices[0].beats[0];for(const e of i){e.type===r.Bank&&0===e.value&&0===s.index||t.automations.push(e)}}}}if(this.ba.has(t)){const s=this.ba.get(t);for(const[t,i]of s)if(e.staves.length>0&&t<e.staves[0].bars.length){e.staves[0].bars[t].sustainPedals=i}}}for(const[t,e]of this.fa){const s=this.score.masterBars[t];for(let t=0,i=e.length;t<i;t++){const i=e[t];switch(i.type){case r.Tempo:s.tempoAutomations.push(i);break;case r.SyncPoint:i.syncPointValue.millisecondOffset-=this.La,s.addSyncPoint(i)}}}}}class Ks{isMultiRest=!1;trackViewGroups=[]}class Qs{showNumbered=!1;showSlash=!1;showStandardNotation=!1;showTablature=!1}class Zs{scoreViews=[];apply(t){if(this.scoreViews.length>0){let e=0;t.stylesheet.multiTrackMultiBarRest=this.scoreViews[0].isMultiRest;for(const s of this.scoreViews[0].trackViewGroups){if(e<t.tracks.length){const i=t.tracks[e];for(const t of i.staves)t.isPercussion||(t.showTablature=s.showTablature),t.showStandardNotation=s.showStandardNotation,t.showSlash=s.showSlash,t.showNumbered=s.showNumbered}e++}for(let s=1;s<this.scoreViews.length;s++)this.scoreViews[s].isMultiRest&&(t.stylesheet.perTrackMultiBarRest||(t.stylesheet.perTrackMultiBarRest=new Set),e=s-1,t.stylesheet.perTrackMultiBarRest.add(e))}}constructor(t){const e=Ae.fromBuffer(t),s=fe.readInt32BE(e);for(let t=0;t<s;t++){const t=new Ks;this.scoreViews.push(t),t.isMultiRest=Hs.gpReadBool(e);const s=fe.readInt32BE(e);for(let i=0;i<s;i++){let s=e.readByte();0===s&&(s=1);const i=new Qs;i.showStandardNotation=!!(1&s),i.showTablature=!!(2&s),i.showSlash=!!(4&s),i.showNumbered=!!(8&s),t.trackViewGroups.push(i)}}}static writeForScore(t){const e=Ae.withCapacity(128),s=[new Ks];s[0].isMultiRest=t.stylesheet.multiTrackMultiBarRest;for(const e of t.tracks){const i=new Qs;i.showStandardNotation=e.staves[0].showStandardNotation,i.showTablature=e.staves[0].showTablature,i.showSlash=e.staves[0].showSlash,i.showNumbered=e.staves[0].showNumbered,s[0].trackViewGroups.push(i);const n=new Ks;n.isMultiRest=!0===t.stylesheet.perTrackMultiBarRest?.has(e.index),n.trackViewGroups.push(i),s.push(n)}fe.writeInt32BE(e,s.length);for(const t of s){e.writeByte(t.isMultiRest?1:0),fe.writeInt32BE(e,t.trackViewGroups.length);for(const s of t.trackViewGroups){let t=0;s.showStandardNotation&&(t|=1),s.showTablature&&(t|=2),s.showSlash&&(t|=4),s.showNumbered&&(t|=8),e.writeByte(t)}}return fe.writeInt32BE(e,1),e.toArray()}}class ti{trackViewGroups=[]}class ei{isVisible=!1}!function(t){t[t.PageVertical=0]="PageVertical",t[t.PageGrid=1]="PageGrid",t[t.PageParchment=2]="PageParchment",t[t.ScreenVertical=3]="ScreenVertical",t[t.ScreenHorizontal=4]="ScreenHorizontal",t[t.PageHorizontal=5]="PageHorizontal"}(Je||(Je={}));class si{zoomLevel=4;view=Je.PageVertical;muiltiVoiceCursor=!1;scoreViews=[];constructor(t,e){const s=Ae.fromBuffer(e);this.zoomLevel=fe.readInt32BE(s),this.view=s.readByte(),this.muiltiVoiceCursor=0!==s.readByte();const i=t.scoreViews.length;for(let e=0;e<i;e++){const i=new ti;this.scoreViews.push(i);const n=t.scoreViews[e];for(let t=0;t<n.trackViewGroups.length;t++){const t=new ei;t.isVisible=0!==s.readByte(),i.trackViewGroups.push(t)}}}apply(t){if(this.scoreViews.length>0){let e=0;for(const s of this.scoreViews[0].trackViewGroups){if(e<t.tracks.length){t.tracks[e].isVisibleOnMultiTrack=s.isVisible}e++}}}static writeForScore(t){const e=Ae.withCapacity(128);fe.writeInt32BE(e,4),e.writeByte(0);const s=t.tracks.length>0&&t.tracks[0].staves[0].bars[0].isMultiVoice;e.writeByte(s?255:0);for(const s of t.tracks)e.writeByte(s.isVisibleOnMultiTrack?255:0);for(const s of t.tracks)e.writeByte(255);return e.toArray()}}class ii extends Ee{get name(){return"Guitar Pro 7-8"}readScore(){q.debug(this.name,"Loading ZIP entries");const t=new Ss(this.data);let e;try{e=t.read()}catch(t){throw new Fe("No Zip archive",t)}q.debug(this.name,"Zip entries loaded");let s=null,i=null,n=null,r=null;const a=new Map;for(const t of e)switch(a.set(t.fullName,t),t.fileName){case"score.gpif":s=fe.toString(t.data,this.settings.importer.encoding);break;case"BinaryStylesheet":i=t.data;break;case"PartConfiguration":n=t.data;break;case"LayoutConfiguration":r=t.data}if(!s)throw new Fe("No score.gpif found in zip archive");q.debug(this.name,"Start Parsing score.gpif");const h=new Ys;h.loadAsset=t=>{if(a.has(t))return a.get(t).data},h.parseXml(s,this.settings),q.debug(this.name,"score.gpif parsed");const o=h.score;if(i){q.debug(this.name,"Start Parsing BinaryStylesheet");new Xs(i).apply(o),q.debug(this.name,"BinaryStylesheet parsed")}let c=null;if(n&&(q.debug(this.name,"Start Parsing Part Configuration"),c=new Zs(n),c.apply(o),q.debug(this.name,"Part Configuration parsed")),r&&null!=c){q.debug(this.name,"Start Parsing Layout Configuration");new si(c,r).apply(o),q.debug(this.name,"Layout Configuration parsed")}return o}}class ni extends G{constructor(){super(t.AlphaTabErrorType.Format,"Unexpected end of data within reader")}}class ri{static Jh=8;qh=0;Yh=ri.Jh;Kh;constructor(t){this.Kh=t}readByte(){return this.readBits(8)}readBytes(t){const e=new Uint8Array(t);for(let s=0;s<t;s++)e[s]=255&this.readByte();return e}readBits(t){let e=0,s=t-1;for(;s>=0;)e|=this.readBit()<<s,s--;return e}readBitsReversed(t){let e=0;for(let s=0;s<t;s++)e|=this.readBit()<<s;return e}readBit(){if(this.Yh>=8){if(this.qh=this.Kh.readByte(),-1===this.qh)throw new ni;this.Yh=0}const t=this.qh>>ri.Jh-this.Yh-1&1;return this.Yh++,t}readAll(){const t=Ae.empty();try{for(;;)t.writeByte(255&this.readByte())}catch(t){if(!(t instanceof ni))throw t}return t.toArray()}}class ai{fileName="";fileSize=0;data=null}class hi{static HeaderBcFs="BCFS";static HeaderBcFz="BCFZ";fileFilter;files=[];constructor(){this.files=[],this.fileFilter=t=>!0}load(t){const e=new ri(t);this.Qh(e)}readHeader(t){return this.Zh(t.readBytes(4),0,4)}decompress(t,e=!1){const s=Ae.empty();let i;const n=this.eo(t.readBytes(4),0);try{for(;s.length<n;){if(1===t.readBits(1)){const e=t.readBits(4),n=t.readBitsReversed(e),r=t.readBitsReversed(e),a=s.length-n,h=Math.min(n,r);i=s.getBuffer(),s.write(i,a,h)}else{const e=t.readBitsReversed(2);for(let i=0;i<e;i++)s.writeByte(t.readByte())}}}catch(t){if(!(t instanceof ni))throw t}i=s.getBuffer();const r=e?4:0,a=s.length-r,h=new Uint8Array(a),o=a;return h.set(i.subarray(r,r+o),0),h}Qh(t){const e=this.readHeader(t);if("BCFZ"===e)this.so(this.decompress(t,!0));else{if("BCFS"!==e)throw new Fe("Unsupported format");this.so(t.readAll())}}so(t){const e=4096;let s=e;for(;s+3<t.length;){if(2===this.eo(t,s)){const i=new ai;i.fileName=this.Zh(t,s+4,127),i.fileSize=this.eo(t,s+140);const n=!this.fileFilter||this.fileFilter(i.fileName);n&&this.files.push(i);const r=s+148;let a=0,h=0;const o=n?Ae.withCapacity(i.fileSize):null;for(;a=this.eo(t,r+4*h++),0!==a;)s=a*e,n&&o.write(t,s,e);if(n){i.data=new Uint8Array(Math.min(i.fileSize,o.length));const t=o.toArray();i.data.set(t.subarray(0,0+i.data.length),0)}}s+=e}}Zh(t,e,s){let i="";for(let n=0;n<s;n++){const s=255&t[e+n];if(0===s)break;i+=String.fromCharCode(s)}return i}eo(t,e){return t[e+3]<<24|t[e+2]<<16|t[e+1]<<8|t[e]}}class oi extends Ee{get name(){return"Guitar Pro 6"}readScore(){q.debug(this.name,"Loading GPX filesystem");const t=new hi;t.fileFilter=t=>t.endsWith("score.gpif")||t.endsWith("BinaryStylesheet")||t.endsWith("PartConfiguration")||t.endsWith("LayoutConfiguration"),t.load(this.data),q.debug(this.name,"GPX filesystem loaded");let e=null,s=null,i=null,n=null;for(const r of t.files)switch(r.fileName){case"score.gpif":e=fe.toString(r.data,this.settings.importer.encoding);break;case"BinaryStylesheet":s=r.data;break;case"PartConfiguration":i=r.data;break;case"LayoutConfiguration":n=r.data}if(!e)throw new Fe("No score.gpif found in GPX");q.debug(this.name,"Start Parsing score.gpif");const r=new Ys;r.parseXml(e,this.settings),q.debug(this.name,"score.gpif parsed");const a=r.score;if(s){q.debug(this.name,"Start Parsing BinaryStylesheet");new Xs(s).apply(a),q.debug(this.name,"BinaryStylesheet parsed")}let h=null;if(i&&(q.debug(this.name,"Start Parsing Part Configuration"),h=new Zs(i),h.apply(a),q.debug(this.name,"Part Configuration parsed")),n&&null!=h){q.debug(this.name,"Start Parsing Layout Configuration");new si(h,n).apply(a),q.debug(this.name,"Layout Configuration parsed")}return a}}class ci{maxSteps=-1e3;maxStepsNote=null;minSteps=-1e3;minStepsNote=null}class li{Te;no;static ro=7;static ao=[38,32,30,26,38];static sharpNoteSteps=[0,0,1,1,2,3,3,4,4,5,5,6];static flatNoteSteps=[0,1,1,2,2,3,4,4,5,5,6,6];ho=new Map;oo=new Map;co=new Map;lo=new Map;uo=new Map;maxStepsBeat=null;minStepsBeat=null;maxSteps=-1e3;minSteps=-1e3;constructor(t){this.no=t,this.Te=t.bar}static getPercussionSteps(t){return qt.getArticulation(t)?.staffLine??0}static getNoteValue(t){let e=t.displayValue;switch(t.accidentalMode){case b.ForceDoubleFlat:e+=2;break;case b.ForceDoubleSharp:e-=2;break;case b.ForceFlat:e+=1;break;case b.ForceSharp:e-=1}return e}applyAccidental(t){const e=li.getNoteValue(t),s=t.hasQuarterToneOffset;return this.do(e,s,t.beat,!1,t)}applyAccidentalForValue(t,e,s,i){return this.do(e,s,t,i,null)}static computeStepsWithoutAccidentals(t,e){let s=0;const i=li.getNoteValue(e);return s=e.isPercussion?li.getPercussionSteps(e):li.calculateNoteSteps(t.keySignature,t.clef,i),s}do(t,e,s,i,n=null){let r=0,a=x.None;if(null!=n&&n.isPercussion)r=li.getPercussionSteps(n);else{const s=n?n.accidentalMode:b.Default;r=li.calculateNoteSteps(this.Te.keySignature,this.Te.clef,t);const i=this.ho.has(r)?this.ho.get(r):null;a=Xt.computeAccidental(this.Te.keySignature,s,t,e,i);let h=!1;switch(a){case x.NaturalQuarterNoteUp:case x.SharpQuarterNoteUp:case x.FlatQuarterNoteUp:break;default:if(n&&n.isTieDestination&&0===n.beat.index){const t=this.no.scoreRenderer.layout?.getRendererForBar(this.no.staff.staffId,n.tieOrigin.beat.voice.bar);if(t&&t.staff===this.no.staff){t.accidentalHelper.getNoteSteps(n.tieOrigin)===r&&(h=!0)}}h?a=x.None:a!==x.None&&this.ho.set(r,a)}}return n?(this.oo.set(n.id,r),this.lo.set(t,n)):this.co.set(t,r),(-1e3===this.minSteps||this.minSteps<r)&&(this.minSteps=r,this.minStepsBeat=s),(-1e3===this.maxSteps||this.maxSteps>r)&&(this.maxSteps=r,this.maxStepsBeat=s),i||this.fo(s,r,n),a}fo(t,e,s){let i;this.uo.has(t.id)?i=this.uo.get(t.id):(i=new ci,this.uo.set(t.id,i)),(-1e3===i.minSteps||e<i.minSteps)&&(i.minSteps=e,i.minStepsNote=s),(-1e3===i.minSteps||e>i.maxSteps)&&(i.maxSteps=e,i.maxStepsNote=s)}getMaxSteps(t){return this.uo.has(t.id)?this.uo.get(t.id).maxSteps:0}getMaxStepsNote(t){return this.uo.has(t.id)?this.uo.get(t.id).maxStepsNote:null}getMinSteps(t){return this.uo.has(t.id)?this.uo.get(t.id).minSteps:0}getMinStepsNote(t){return this.uo.has(t.id)?this.uo.get(t.id).minStepsNote:null}static calculateNoteSteps(t,e,s){const i=t,n=e,r=s%12,a=(s/12|0)-1;let h=li.ao[n];h-=a*li.ro;return h-=(Xt.keySignatureIsSharp(i)||Xt.keySignatureIsNatural(i)?li.sharpNoteSteps:li.flatNoteSteps)[r],h}getNoteSteps(t){return this.oo.get(t.id)}getNoteStepsForValue(t,e=!1){return this.co.has(t)?this.co.get(t):e&&this.lo.has(t)?this.getNoteSteps(this.lo.get(t)):0}}class ui{slurStarts;currentDynamics=n.F;tieStarts;tieStartIds;slideOrigins=new Map;transpose=0;isExplicitlyBeamed=!1;constructor(){this.tieStarts=new Set,this.tieStartIds=new Map,this.slideOrigins=new Map,this.slurStarts=new Map}}class di extends Jt{outputMidiChannel=-1;outputMidiProgram=-1;outputMidiBank=-1;outputVolume=-1;outputBalance=-1}class fi{track;firstArticulation;instruments=new Map;po=new Map;bo=0;mo=new Map;constructor(t){this.track=t}getLyricLine(t){if(this.mo.has(t))return this.mo.get(t);const e=this.bo;return this.mo.set(t,e),this.bo++,e}static wo=Jt.create(0,"Default",0,0,ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole);getOrCreateArticulation(t,e){const s=12*e.octave+e.tone,i=`${t}_${s}`;if(this.po.has(i))return this.po.get(i);let n;n=this.instruments.has(t)?this.instruments.get(t):fi.wo;const r=this.track.percussionArticulations.length,a=e.beat.voice.bar;let h;h=0===s?4:li.calculateNoteSteps(a.keySignature,a.clef,s);const o=h-(9-(2*e.beat.voice.bar.staff.standardNotationLineCount-1)),c=Jt.create(n.id,n.elementType,o,n.outputMidiNumber,n.noteHeadDefault,n.noteHeadHalf,n.noteHeadWhole,n.techniqueSymbol,n.techniqueSymbolPlacement);return this.po.set(i,r),this.track.percussionArticulations.push(c),r}}class pi extends Ee{Be;yo=new Map;ko=new Map;So=new Map;Bo;_o;To=1;xo=n.F;get name(){return"MusicXML"}readScore(){const t=this.Mo(),e=new Ms;try{e.parse(t)}catch(t){throw new Fe("Unsupported format",t)}return this.Be=new $t,this.Be.stylesheet.hideDynamics=!0,this.Ln(e),Xt.consolidate(this.Be),this.Be.finish(this.settings),this.Be.rebuildRepeatGroups(),this.Be}Mo(){const t=new Ss(this.data);let e;try{e=t.read()}catch{e=[]}if(0===e.length)return this.data.reset(),fe.toString(this.data.readAll(),this.settings.importer.encoding);const s=e.find(t=>"META-INF/container.xml"===t.fullName);if(!s)throw new Fe("No compressed MusicXML");const i=new Ms;try{i.parse(fe.toString(s.data,this.settings.importer.encoding))}catch(t){throw new Fe("Malformed container.xml, could not parse as XML",t)}const n=i.firstElement;if(!n||"container"!==n.localName)throw new Fe("Malformed container.xml, root element not 'container'");const r=n.findChildElement("rootfiles");if(!r)throw new Fe("Malformed container.xml, 'container/rootfiles' not found");let a="";for(const t of r.childElements())if("rootfile"===t.localName){a=t.getAttribute("full-path");break}if(!a)throw new Fe("Unsupported compressed MusicXML, missing rootfile");const h=e.find(t=>t.fullName===a);if(!h)throw new Fe(`Malformed container.xml, '${a}' not contained in zip`);return fe.toString(h.data,this.settings.importer.encoding)}Ln(t){const e=t.firstElement;if(!e)throw new Fe("Unsupported format");switch(e.localName){case"score-partwise":this.vo(e);break;case"score-timewise":this.No(e);break;default:throw new Fe("Unsupported format")}}vo(t){for(const e of t.childElements())switch(e.localName){case"credit":this.Po(e);break;case"identification":this.Co(e);break;case"movement-title":this.Eo(e);break;case"part":this.Fo(e);break;case"part-list":this.Ao(e);break;case"work":this.Do(e)}}No(t){let e=0;for(const s of t.childElements())switch(s.localName){case"credit":this.Po(s);break;case"identification":this.Co(s);break;case"movement-title":this.Eo(s);break;case"part-list":this.Ao(s);break;case"work":this.Do(s);break;case"measure":this.Lo(s,e),e++}}Po(t){if("1"!==t.getAttribute("page","1"))return;const e=[];let s=null,i="";for(const n of t.childElements())switch(n.localName){case"credit-type":e.push(n.innerText);break;case"credit-words":null===s&&(s=n),i+=n.innerText}if(e.length>0)for(const t of e)switch(t){case"title":this.Be.title=pi.Wo(i);break;case"subtitle":this.Be.subTitle=pi.Wo(i);break;case"composer":case"arranger":this.Be.artist=pi.Wo(i);break;case"lyricist":this.Be.words=pi.Wo(i);break;case"rights":this.Be.copyright=pi.Wo(i)}else if(s){const t=s.getAttribute("font-size","0"),e=s.getAttribute("font-size","top"),n=s.getAttribute("halign","left");if("top"===e){if(i.includes("copyright")||i.includes("Copyright")||i.includes("©")||i.includes("(c)")||i.includes("(C)"))return void(this.Be.copyright=pi.Wo(i));if("center"===n||"center"===t){if(0===this.Be.title.length)return void(this.Be.title=pi.Wo(i));if(0===this.Be.subTitle.length)return void(this.Be.subTitle=pi.Wo(i));if(0===this.Be.album.length)return void(this.Be.album=pi.Wo(i))}else if(("right"===n||"right"===t)&&0===this.Be.music.length)return void(this.Be.music=pi.Wo(i));if(0===this.Be.artist.length)return void(this.Be.artist=pi.Wo(i));if(0===this.Be.words.length)return void(this.Be.words=pi.Wo(i))}}}static Wo(t){return t.replaceAll("\r","").replaceAll("\n"," ").replaceAll("\t","  ").replaceAll(" "," ")}Co(t){for(const e of t.childElements())switch(e.localName){case"creator":if(e.attributes.has("type"))switch(e.attributes.get("type")){case"composer":this.Be.artist=pi.Wo(e.innerText);break;case"lyricist":this.Be.words=pi.Wo(e.innerText);break;case"arranger":this.Be.music=pi.Wo(e.innerText)}else this.Be.artist=pi.Wo(e.innerText);break;case"rights":this.Be.copyright.length>0&&(this.Be.copyright+=", "),this.Be.copyright+=e.innerText,e.attributes.has("type")&&(this.Be.copyright+=` (${e.attributes.get("type")})`);break;case"encoding":this.Ro(e)}}Ro(t){for(const e of t.childElements())switch(e.localName){case"encoder":this.Be.tab.length>0&&(this.Be.tab+=", "),this.Be.tab+=e.innerText,e.attributes.has("type")&&(this.Be.tab+=` (${e.attributes.get("type")})`);break;case"encoding-description":this.Be.notices+=pi.Wo(e.innerText)}}Eo(t){0===this.Be.title.length?this.Be.title=pi.Wo(t.innerText):this.Be.subTitle=pi.Wo(t.innerText)}Ao(t){for(const e of t.childElements())if("score-part"===e.localName)this.Io(e)}Io(t){const e=new Pe;e.ensureStaveCount(1),this.Be.addTrack(e);const s=t.attributes.get("id"),i=new fi(e);this.yo.set(s,i),this.ko.set(e.index,i);for(const s of t.childElements())switch(s.localName){case"part-name":e.name=pi.Wo(s.innerText);break;case"part-name-display":e.name=this.Oo(s);break;case"part-abbreviation":e.shortName=pi.Wo(s.innerText);break;case"part-abbreviation-display":e.shortName=this.Oo(s);break;case"score-instrument":this.Go(s,i);break;case"midi-device":s.attributes.has("port")&&(e.playbackInfo.port=Number.parseInt(s.attributes.get("port"),10));break;case"midi-instrument":this.Vo(s,i)}i.firstArticulation&&(i.firstArticulation.outputMidiProgram>=0&&(e.playbackInfo.program=i.firstArticulation.outputMidiProgram),i.firstArticulation.outputMidiBank>=0&&(e.playbackInfo.bank=i.firstArticulation.outputMidiBank),i.firstArticulation.outputBalance>=0&&(e.playbackInfo.balance=i.firstArticulation.outputBalance),i.firstArticulation.outputVolume>=0&&(e.playbackInfo.volume=i.firstArticulation.outputVolume),i.firstArticulation.outputMidiChannel>=0&&(e.playbackInfo.primaryChannel=i.firstArticulation.outputMidiChannel,e.playbackInfo.secondaryChannel=i.firstArticulation.outputMidiChannel))}Go(t,e){const s=new di;e.firstArticulation||(e.firstArticulation=s),e.instruments.set(t.getAttribute("id",""),s)}Vo(t,e){const s=t.getAttribute("id","");if(!e.instruments.has(s))return;const i=e.instruments.get(s);for(const e of t.childElements())switch(e.localName){case"midi-channel":i.outputMidiChannel=Number.parseInt(e.innerText,10)-1;break;case"midi-bank":i.outputMidiBank=Number.parseInt(e.innerText,10)-1;break;case"midi-program":i.outputMidiProgram=Number.parseInt(e.innerText,10)-1;break;case"midi-unpitched":i.outputMidiNumber=Number.parseInt(e.innerText,10)-1;break;case"volume":i.outputVolume=pi.$o(Number.parseFloat(e.innerText));break;case"pan":i.outputBalance=pi.Ho(Number.parseFloat(e.innerText))}i.id=qt.tryMatchKnownArticulation(i),i.id<0&&(i.id=0)}static $o(t){return 0|pi.Uo(0,100,0,16,t)}static Ho(t){return 0|pi.Uo(-90,90,0,16,t)}static Uo(t,e,s,i,n){return s+(i-s)*((n-t)/(e-t))}Oo(t){let e="";for(const s of t.childElements())switch(s.localName){case"display-text":e+=s.innerText;break;case"accidental-text":switch(s.innerText){case"sharp":e+="♯";break;case"natural":e+="♮";break;case"flat":e+="♭";break;case"double-sharp":e+="𝄪";break;case"sharp-sharp":e+="♯♯";break;case"flat-flat":e+="𝄫";break;case"natural-sharp":e+="♮♯";break;case"natural-flat":e+="♮♭";break;case"sharp-down":e+="𝄱";break;case"sharp-up":e+="𝄰";break;case"natural-down":e+="𝄯";break;case"natural-up":e+="𝄮";break;case"flat-down":e+="𝄭";break;case"flat-up":e+="𝄬";break;case"arrow-down":e+="↓";break;case"arrow-up":e+="↑";break;case"triple-sharp":e+="♯𝄪";break;case"triple-flat":e+="𝄬𝄬𝄬";break;case"sharp-1":e+="♯¹";break;case"sharp-2":e+="♯²";break;case"sharp-3":e+="♯³";break;case"sharp-4":e+="♯⁴";break;case"sharp-5":e+="♯⁵";break;case"flat-1":e+="♭¹";break;case"flat-2":e+="♭²";break;case"flat-3":e+="♭³";break;case"flat-4":e+="♭⁴";break;case"flat-5":e+="♭⁵"}}return pi.Wo(e)}Do(t){for(const e of t.childElements())if("work-title"===e.localName)this.Be.title=pi.Wo(e.innerText)}Fo(t){const e=t.attributes.get("id");if(!e||!this.yo.has(e))return;const s=this.yo.get(e).track;let i=0;for(const e of t.childElements())if("measure"===e.localName)this.zo(e,s,i),i++;this.Bo=void 0}zo(t,e,s){const i=this.Xo(t,s),n="yes"===t.attributes.get("implicit");this.jo(t,i,e,n,!0),this._o=void 0}Lo(t,e){const s=this.Xo(t,e),i="yes"===t.attributes.get("implicit");for(const e of t.childElements())switch(e.localName){case"part":this.Jo(e,s,i),this.Bo=void 0;break;case"print":this.qo(e,s,void 0,!0)}this._o=void 0}Xo(t,e){const s="yes"===t.attributes.get("implicit");for(;this.Be.masterBars.length<=e;){const t=new et;s&&(t.isAnacrusis=!0),this.Be.addMasterBar(t),t.index>0&&(t.timeSignatureDenominator=t.previousMasterBar.timeSignatureDenominator,t.timeSignatureNumerator=t.previousMasterBar.timeSignatureNumerator,t.tripletFeel=t.previousMasterBar.tripletFeel)}return this.Be.masterBars[e]}Jo(t,e,s){const i=t.attributes.get("id");if(!i||!this.yo.has(i))return;const n=this.yo.get(i).track;this.jo(t,e,n,s,!1)}Yo=0;Ko=null;jo(t,e,s,i,n){this.Yo=0,this.Ko=null,e.alternateEndings=this.Qo;const r=[];for(const i of t.childElements())switch(i.localName){case"note":this.Uh(i,e,s);break;case"backup":this.Zo(i);break;case"forward":this.tc(i);break;case"direction":this.ec(i,e,s);break;case"attributes":this.sc(i,e,s);break;case"harmony":this.nc(i,s);break;case"print":this.qo(i,e,s,!0);break;case"sound":this.xh(i,e,s);break;case"barline":r.push(i)}for(const t of r)this.rc(t,e,s);this.ac(e,s);const a=this.hc(s,0),h=this.cr(a,e);h.barNumberDisplay=i?I.Hide:n?this._o??this.Bo:this.Bo??this._o,this.oc=null}qo(t,e,s,i){let n;void 0!==s&&("yes"===t.getAttribute("new-system","no")||"yes"===t.getAttribute("new-page","no"))&&s.addLineBreaks(e.index);for(const e of t.childElements())if("measure-numbering"===e.localName)switch(e.innerText){case"none":n=I.Hide;break;case"measure":n=I.AllBars;break;case"system":n=I.FirstOfSystem}i?this._o=n:this.Bo=n}ac(t,e){if(null!==this.cc){for(const s of e.staves){const e=this.cr(s,t);e.simileMark=this.cc,e.simileMark!==v.None&&this.lc(e)}this.cc===v.FirstOfDouble?this.cc=v.SecondOfDouble:this.cc=null}if(null!==this.uc){const s=Array.from(this.uc.keys());for(const i of s){const s=this.hc(e,i),n=this.cr(s,t);n.simileMark=this.uc.get(i),n.simileMark!==v.None&&this.lc(n),n.simileMark===v.FirstOfDouble?this.uc.set(i,v.SecondOfDouble):this.uc.delete(i)}0===this.uc.size&&(this.uc=null)}}lc(t){for(const e of t.voices){const t=new se;t.isEmpty=!0,e.addBeat(t)}}rc(t,e,s){for(const i of t.childElements())switch(i.localName){case"bar-style":this.dc(i,e,s,t.getAttribute("location","right"));break;case"ending":this.fc(i,e);break;case"repeat":this.bc(i,e)}}bc(t,e){const s=t.getAttribute("direction");let i=Number.parseInt(t.getAttribute("times"),10);(i<0||Number.isNaN(i))&&(i=2),"backward"===s?e.repeatCount=i:"forward"===s&&(e.isRepeatStart=!0)}Qo=0;fc(t,e){const s=t.getAttribute("number").split(",").map(t=>Number.parseInt(t,10));let i=0;for(const t of s)i|=1<<t-1&255;switch(e.alternateEndings=i,t.getAttribute("type","")){case"start":this.Qo=this.Qo|i;break;case"stop":case"discontinue":this.Qo=this.Qo&~i}}dc(t,e,s,i){let n=F.Automatic;switch(t.innerText){case"dashed":n=F.Dashed;break;case"dotted":n=F.Dotted;break;case"heavy":n=F.Heavy;break;case"heavy-heavy":n=F.HeavyHeavy;break;case"heavy-light":n=F.HeavyLight;break;case"light-heavy":n=F.LightHeavy;break;case"light-light":n=F.LightLight;break;case"none":n=F.None;break;case"regular":n=F.Regular;break;case"short":n=F.Short;break;case"tick":n=F.Tick}for(const t of s.staves){const s=this.cr(t,e);switch(i){case"left":s.barLineLeft=n;break;case"right":s.barLineRight=n}}}xh(t,e,s){for(const s of t.childElements())switch(s.localName){case"midi-instrument":this.mc(s,e);break;case"swing":this.gc(s,e)}if(t.attributes.has("coda")&&e.addDirection(Xe.TargetCoda),t.attributes.has("tocoda")&&e.addDirection(Xe.JumpDaCoda),t.attributes.has("dacapo")&&e.addDirection(Xe.JumpDaCapo),t.attributes.has("dalsegno")&&e.addDirection(Xe.JumpDalSegno),t.attributes.has("fine")&&e.addDirection(Xe.TargetFine),t.attributes.has("segno")&&e.addDirection(Xe.TargetSegno),t.attributes.has("pan")){this.wc||(this.wc=[]);const e=new U;e.type=r.Balance,e.value=pi.Ho(Number.parseFloat(t.attributes.get("pan"))),this.wc.push(e)}if(t.attributes.has("tempo")){this.wc||(this.wc=[]);const e=new U;e.type=r.Tempo,e.value=pi.$o(Number.parseFloat(t.attributes.get("tempo"))),this.wc.push(e)}}gc(t,e){let s=0,i=0,n=null;for(const r of t.childElements())switch(r.localName){case"straight":return void(e.tripletFeel=A.NoTripletFeel);case"first":s=Number.parseInt(r.innerText,10);break;case"second":i=Number.parseInt(r.innerText,10);break;case"swing-type":n=this.yc(r)}n||(n=l.Eighth),n===l.Eighth?2===s&&1===i?e.tripletFeel=A.Triplet8th:3===s&&1===i?e.tripletFeel=A.Dotted8th:1===s&&3===i&&(e.tripletFeel=A.Scottish8th):n===l.Sixteenth&&(2===s&&1===i?e.tripletFeel=A.Triplet16th:3===s&&1===i?e.tripletFeel=A.Dotted16th:1===s&&3===i&&(e.tripletFeel=A.Scottish16th))}wc=null;kc=null;Sc=null;Bc=!1;_c=!1;Tc=null;xc=null;mc(t,e){let s;for(const e of t.childElements())switch(e.localName){case"midi-bank":this.wc||(this.wc=[]),s=new U,s.type=r.Bank,s.value=Number.parseInt(e.innerText,10)-1,this.wc.push(s);break;case"midi-program":this.wc||(this.wc=[]),s=new U,s.type=r.Instrument,s.value=Number.parseInt(e.innerText,10)-1,this.wc.push(s);break;case"volume":this.wc||(this.wc=[]),s=new U,s.type=r.Volume,s.value=pi.$o(Number.parseFloat(e.innerText)),this.wc.push(s);break;case"pan":this.wc||(this.wc=[]),s=new U,s.type=r.Balance,s.value=pi.Ho(Number.parseFloat(e.innerText)),this.wc.push(s)}}nc(t,e){const s=new ye;let i=!1,n="";for(const e of t.childElements())switch(e.localName){case"root":s.name=this.Mc(e);break;case"kind":s.name=s.name+this.vc(e),"yes"===e.getAttribute("parentheses-degrees","no")&&(i=!0);break;case"frame":this.Nc(e,s);break;case"degree":n+=this.Pc(e)}n&&(s.name+=i?`(${n})`:n),"yes"===t.getAttribute("print-frame","no")&&(s.showDiagram=!0,this.Be.stylesheet.globalDisplayChordDiagramsInScore=!0),"yes"===t.getAttribute("print-object","yes")&&(s.showDiagram=!0),null===this.kc&&(this.kc=s)}Pc(t){let e="",s="",i="";for(const n of t.childElements())switch(n.localName){case"degree-value":e=n.innerText;break;case"degree-alter":switch(n.innerText){case"-1":s="♭";break;case"1":s="♯"}break;case"degree-type":i+=n.getAttribute("text","")}return`${i}${s}${e}`}Mc(t){let e="",s="";for(const i of t.childElements())switch(i.localName){case"root-step":e=i.innerText;break;case"root-alter":switch(Number.parseFloat(i.innerText)){case-2:s="bb";break;case-1:s="b";break;case 0:s="";break;case 1:s="#";break;case 2:s="##"}}return e+s}vc(t){const e=t.getAttribute("text");let s="";if(e)s=e;else{const e=t.innerText;switch(e){case"major":s="";break;case"minor":s="m";break;case"augmented":s="+";break;case"diminished":s="○";break;case"dominant":s="7";break;case"major-seventh":s="7M";break;case"minor-seventh":s="m7";break;case"diminished-seventh":s="○7";break;case"augmented-seventh":s="+7";break;case"half-diminished":s="⍉";break;case"major-minor":s="mMaj";break;case"major-sixth":s="maj6";break;case"minor-sixth":s="m6";break;case"dominant-ninth":s="9";break;case"major-ninth":s="maj9";break;case"minor-ninth":s="m9";break;case"dominant-11th":s="11";break;case"major-11th":s="maj11";break;case"minor-11th":s="m11";break;case"dominant-13th":s="13";break;case"major-13th":s="maj13";break;case"minor-13th":s="m13";break;case"suspended-second":s="sus2";break;case"suspended-fourth":s="sus4";break;case"Neapolitan":s="♭II";break;case"Italian":s="It⁺⁶";break;case"French":case"German":s="Fr⁺⁶";break;default:s=e}}return s}Nc(t,e){for(const s of t.childElements())switch(s.localName){case"frame-strings":const t=Number.parseInt(s.innerText,10);e.strings=new Array(t);for(let s=0;s<t;s++)e.strings[s]=-1;break;case"first-fret":e.firstFret=Number.parseInt(s.innerText,10);break;case"frame-note":let i=null,n=null;for(const t of s.childElements())switch(t.localName){case"string":i=Number.parseInt(t.innerText,10);break;case"fret":n=Number.parseInt(t.innerText,10),i&&n>=0&&(e.strings[i-1]=n);break;case"barre":i&&n&&"start"===t.getAttribute("type")&&e.barreFrets.push(n)}}}sc(t,e,s){let i,n,r;if(null==this.Ko)for(const a of t.childElements())switch(a.localName){case"divisions":this.To=Number.parseFloat(a.innerText);break;case"key":this.Cc(a,e,s);break;case"time":this.nr(a,e);break;case"staves":s.ensureStaveCount(Number.parseInt(a.innerText,10));break;case"clef":i=Number.parseInt(a.getAttribute("number","1"),10)-1,n=this.hc(s,i),r=this.cr(n,e),this.Kn(a,r);break;case"staff-details":i=Number.parseInt(a.getAttribute("number","1"),10)-1,n=this.hc(s,i),this.Ec(a,n);break;case"transpose":this.hh(a,s);break;case"measure-style":this.Fc(a,s,!1)}else for(const e of t.childElements())switch(e.localName){case"divisions":this.To=Number.parseFloat(e.innerText);break;case"measure-style":this.Fc(e,s,!0)}}cc=null;uc=null;Ac=!1;Fc(t,e,s){for(const e of t.childElements())switch(e.localName){case"measure-repeat":if(!s){let s=null;switch(e.getAttribute("type")){case"start":switch(Number.parseInt(e.getAttribute("slashes","1"),10)){case 1:s=v.Simple;break;case 2:s=v.FirstOfDouble}break;case"stop":s=null}if(t.attributes.has("number")){this.uc=this.uc??new Map;const e=Number.parseInt(t.attributes.get("number"),10)-1;null==s?this.uc.delete(e):this.uc.set(e,s)}else this.cc=s}break;case"slash":switch(e.getAttribute("type")){case"start":this.Ac=!0;break;case"stop":this.Ac=!1}}}hh(t,e){let s=0;for(const e of t.childElements())switch(e.localName){case"chromatic":s+=Number.parseFloat(e.innerText);break;case"octave-change":s+=12*Number.parseFloat(e.innerText)}if(t.attributes.has("number")){const i=this.hc(e,Number.parseInt(t.attributes.get("number"),10)-1);this.Dc(i).transpose=s,i.displayTranspositionPitch=s}else for(const t of e.staves)this.Dc(t).transpose=s,t.displayTranspositionPitch=s}Ec(t,e){for(const s of t.childElements())switch(s.localName){case"staff-lines":e.standardNotationLineCount=Number.parseInt(s.innerText,10);break;case"staff-tuning":this.Lc(s,e);break;case"capo":e.capo=Number.parseInt(s.innerText,10)}}Lc(t,e){0===e.stringTuning.tunings.length&&(e.showTablature=!0,e.showStandardNotation=!1,e.stringTuning.tunings=new Array(e.standardNotationLineCount).fill(0));const s=Number.parseInt(t.getAttribute("line"),10);let i="C",n="",r=0;for(const e of t.childElements())switch(e.localName){case"tuning-step":i=e.innerText;break;case"tuning-alter":r=Number.parseFloat(e.innerText);break;case"tuning-octave":n=e.innerText}const a=Xt.getTuningForText(i+n)+r;e.tuning[e.tuning.length-s]=a}Kn(t,e){let s="s",i=0;for(const n of t.childElements())switch(n.localName){case"sign":s=n.innerText.toLowerCase();break;case"line":i=Number.parseInt(n.innerText,10);break;case"clef-octave-change":switch(Number.parseInt(n.innerText,10)){case-2:e.clefOttava=m.M;break;case-1:e.clefOttava=m.T;break;case 1:e.clefOttava=m._;break;case 2:e.clefOttava=m.M}}switch(s){case"g":default:e.clef=M.G2;break;case"f":e.clef=M.F4;break;case"c":e.clef=3===i?M.C3:M.C4;break;case"percussion":e.clef=M.Neutral,e.staff.isPercussion=!0;break;case"tab":e.clef=M.G2,e.staff.showTablature=!0}}nr(t,e){let s=!1,i=!1;for(const n of t.childElements()){const t=n.innerText;switch(n.localName){case"beats":s||(-1===t.indexOf("+")?e.timeSignatureNumerator=Number.parseInt(t,10):e.timeSignatureNumerator=t.split("+").map(t=>Number.parseInt(t,10)).reduce((t,e)=>e+t,0),s=!0);break;case"beat-type":i||(-1===t.indexOf("+")?e.timeSignatureDenominator=Number.parseInt(t,10):e.timeSignatureDenominator=t.split("+").map(t=>Number.parseInt(t,10)).reduce((t,e)=>e+t,0),i=!0)}}switch(t.getAttribute("symbol","")){case"common":case"cut":e.timeSignatureCommon=!0}}oc=null;Cc(t,e,s){let i,n,r=-N.C,a="";for(const e of t.childElements())switch(e.localName){case"fifths":r=Number.parseInt(e.innerText,10);break;case"mode":a=e.innerText}if(i=-7<=r&&r<=7?r:N.C,n="minor"===a?P.Minor:P.Major,t.attributes.has("number")){const r=this.hc(s,Number.parseInt(t.attributes.get("number"),10)-1),a=this.cr(r,e);a.keySignature=i,a.keySignatureType=n}else{this.oc=[i,n];for(const t of s.staves)t.bars.length>e.index&&(t.bars[e.index].keySignature=i,t.bars[e.index].keySignatureType=n)}}ec(t,e,s){const i=[];let n=null,a=-1,h=-1;for(const e of t.childElements())switch(e.localName){case"direction-type":const t=e.firstElement;t&&i.push(t);break;case"offset":n=Number.parseFloat(e.innerText);break;case"voice":break;case"staff":a=Number.parseInt(e.innerText,10)-1;break;case"sound":e.attributes.has("tempo")&&(h=Number.parseFloat(e.attributes.get("tempo")))}let o=null;o=a>=0?this.hc(s,a):null!==this.Ko?this.Ko.voice.bar.staff:this.hc(s,0);const l=o?this.cr(o,e):null,u=()=>{let t=this.Yo;null!==n&&(t+=n);return t/e.calculateDuration(!1)};if(h>0){const t=new U;t.type=r.Tempo,t.value=h,t.ratioPosition=u(),this.Wc(e,t)||e.tempoAutomations.push(t)}let d="";for(const t of i)switch(t.localName){case"rehearsal":e.section=new Te,e.section.marker=t.innerText;break;case"segno":e.addDirection(Xe.TargetSegno);break;case"coda":e.addDirection(Xe.TargetCoda);break;case"words":d=t.innerText;break;case"wedge":switch(t.getAttribute("type")){case"crescendo":this.Sc=c.Crescendo;break;case"diminuendo":this.Sc=c.Decrescendo;break;case"stop":this.Sc=null}break;case"dynamics":const s=this.Rc(t);null!==s&&(this.xo=s,this.Be.stylesheet.hideDynamics=!1);break;case"dashes":const i=t.getAttribute("type","start");switch(d){case"LetRing":this.Bc="start"===i||"continue"===i;break;case"P.M.":this._c="start"===i||"continue"===i}d="";break;case"pedal":const n=this.Ic(t);if(n&&l){n.ratioPosition=u();const t=l.sustainPedals.length>0&&l.sustainPedals[l.sustainPedals.length-1].pedalType!==C.Up;(n.pedalType!==C.Up||t)&&l.sustainPedals.push(n)}break;case"metronome":this.Oc(t,e,u());break;case"octave-shift":this.Tc=this.Gc(t)}d&&(this.xc=d)}Gc(t){const e=t.getAttribute("type");switch(Number.parseInt(t.getAttribute("size","8"),10)){case 15:switch(e){case"up":return m.M;case"down":return m.S;case"stop":return m.Regular;case"continue":return this.Tc}break;case 8:switch(e){case"up":return m.T;case"down":return m._;case"stop":return m.Regular;case"continue":return this.Tc}}return null}Oc(t,e,s){let i=null,n=-1;for(const e of t.childElements())switch(e.localName){case"beat-unit":i=this.yc(e);break;case"per-minute":n=Number.parseFloat(e.innerText)}if(null!==i&&n>0){const t=new U;t.type=r.Tempo,t.value=n*(i/4),t.ratioPosition=s,this.Wc(e,t)||e.tempoAutomations.push(t)}}Wc(t,e){for(const s of t.tempoAutomations)if(e.ratioPosition===s.ratioPosition&&e.value===s.value)return!0;return!1}Ic(t){const e=new K;switch(t.getAttribute("type")){case"start":e.pedalType=C.Down;break;case"stop":e.pedalType=C.Up;break;case"continue":e.pedalType=C.Hold;break;default:return null}return e}Rc(t){for(const e of t.childElements()){const t=e.localName.toUpperCase();switch(t){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":return n[t]}}return null}tc(t){for(const e of t.childElements())if("duration"===e.localName)this.Yo+=this.Vc(Number.parseFloat(e.innerText))}Zo(t){for(const e of t.childElements())if("duration"===e.localName){if(this.Ko){let t=this.Yo;t-=this.Vc(Number.parseFloat(e.innerText)),t<0&&(t=0),this.Yo=t}}}hc(t,e){for(;t.staves.length<=e;){const e=new Me;t.addStaff(e),this.Be.masterBars.length>0&&this.cr(e,this.Be.masterBars[this.Be.masterBars.length-1])}return t.staves[e]}cr(t,e){const s=0===t.bars.length?1:t.bars[0].voices.length;for(;t.bars.length<=e.index;){const e=new Z;t.addBar(e),e.previousBar&&(e.clef=e.previousBar.clef,e.clefOttava=e.previousBar.clefOttava,e.keySignature=e.previousBar.keySignature,e.keySignatureType=e.previousBar.keySignatureType),null!=this.oc&&(e.keySignature=this.oc[0],e.keySignatureType=this.oc[1]);for(let t=0;t<s;t++){const t=new at;e.addVoice(t)}}return t.bars[e.index]}$c(t,e){let s=!1;for(;t.voices.length<=e;)t.addVoice(new at),s=!0;if(s)for(const s of t.staff.bars)for(;s.voices.length<=e;)s.addVoice(new at);return t.voices[e]}Uh(t,e,s){let i=null,n=u.None,r=0,a=null,h=!1,o=0,c=0,d=-1,f=null,p=0,b=-1,m=-1,g=null,w=null,y=!1,k=null;const S="no"!==t.getAttribute("print-object","yes"),B=()=>{if(null!==i)return;h&&!this.Ko&&(q.warning("MusicXML","Malformed MusicXML, <chord /> cannot be set on the first note of a measure"),h=!1),h&&!w&&(q.warning("MusicXML","Cannot mix <chord /> and <rest />"),h=!1);const t=this.hc(s,o);if(h)return i=this.Ko,void i.addNote(w);const B=this.cr(t,e),_=this.$c(B,c),T=0===_.beats.length?0:_.beats[_.beats.length-1].displayEnd;let x=this.Yo-T;if(x>0){if(this.Ko&&this.Ko.beamingMode===Bt.ForceMergeWithNext&&this.Ko.voice.bar.staff.index!==o&&_.beats.length>0&&_.beats[_.beats.length-1].beamingMode===Bt.ForceMergeWithNext){const t=_.beats[_.beats.length-1].duration;for(;x>0;){const e=this.Hc(x,t);if(null===e)break;this.Uc(e,_),x-=e.playbackDuration}}if(x>0){const t=new se;t.dynamics=this.xo,t.isEmpty=!0,t.duration=l.TwoHundredFiftySixth,t.overrideDisplayDuration=x,t.updateDurations(),this.Uc(t,_)}}else x<0&&q.error("MusicXML","Unsupported forward/backup detected. Cannot fill new beats into already filled area of voice");d<0&&null!==f&&(d=$.toTicks(f),p>0&&(d=$.applyDot(d,2===p)));const M=new se;i=M,null===a?M.beamingMode=this.Dc(t).isExplicitlyBeamed?Bt.ForceSplitToNext:Bt.Auto:(M.beamingMode=a,this.Dc(t).isExplicitlyBeamed=!0),M.isEmpty=!1,M.dynamics=this.xo,this.Ac&&(M.slashed=!0);const v=this.wc;if(this.wc=null,null!==v)for(const t of v)M.automations.push(t);const N=this.kc;this.kc=null,null!==N&&(M.chordId=N.uniqueId,_.bar.staff.hasChord(N.uniqueId)||_.bar.staff.addChord(M.chordId,N));const P=this.Sc;null!==P&&(M.crescendo=P);const C=this.Tc;if(null!==C&&(M.ottava=C),M.isLetRing=this.Bc,M.isPalmMute=this._c,this.xc&&(M.text=this.xc,this.xc=null),null!==w&&M.addNote(w),this.Uc(M,_),null!==w){w.isVisible=S;const t=this.ko.get(s.index);null!==k?w.percussionArticulation=t.getOrCreateArticulation(k,w):y||(w.percussionArticulation=t.getOrCreateArticulation("",w))}n!==u.None?(M.graceType=n,this.zc(M,r,null,!1)):(M.tupletNumerator=b,M.tupletDenominator=m,M.dots=p,M.preferredBeamDirection=g,this.zc(M,d,f,!0)),this.Yo=M.displayEnd,this.Ko=M};for(const e of t.childElements())switch(e.localName){case"grace":const t=Number.parseFloat(e.getAttribute("make-time","-1"));t>=0?(r=this.Vc(t),n=u.BeforeBeat):n=u.OnBeat,"yes"===e.getAttribute("slash")&&(n=u.BeforeBeat);break;case"chord":h=!0;break;case"cue":return;case"pitch":w=this.Xc(e),y=!0;break;case"unpitched":w=this.jc(e,s);break;case"rest":w=null,null===f&&(f=l.Whole);break;case"duration":d=this.wi(e);break;case"instrument":k=e.getAttribute("id","");break;case"voice":c=Number.parseInt(e.innerText,10),Number.isNaN(c)?(q.warning("MusicXML","Voices need to be specified as numbers"),c=0):c-=1;break;case"type":f=this.yc(e);break;case"dot":p++;break;case"accidental":null===w?q.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.Jc(e,w);break;case"time-modification":for(const t of e.childElements())switch(t.localName){case"actual-notes":b=Number.parseInt(t.innerText,10);break;case"normal-notes":m=Number.parseInt(t.innerText,10)}break;case"stem":g=this.qc(e);break;case"notehead":null===w?q.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.Yc(e,w,f??l.Quarter,g??this.Kc(w));break;case"staff":o=Number.parseInt(e.innerText,10)-1;break;case"beam":if("1"===e.getAttribute("number","1"))switch(e.innerText){case"begin":case"continue":a=Bt.ForceMergeWithNext;break;case"end":a=Bt.ForceSplitToNext}break;case"notations":B(),this.Qc(e,w,i);break;case"lyric":B(),this.Br(e,i,s);break;case"play":this.Zc(e,w)}if(y){const t=this.hc(s,o),e=this.Dc(t).transpose;if(0!==e){const t=12*w.octave+w.tone+e;w.octave=t/12|0,w.tone=t-12*w.octave}}B()}Zc(t,e){for(const s of t.childElements())if("mute"===s.localName)e&&"palm"===s.innerText&&(e.isPalmMute=!0)}static tl=71;Kc(t){return t.calculateRealValue(!1,!1)<pi.tl?Rt.Down:Rt.Up}Yc(t,e,s,i){"yes"===t.getAttribute("parentheses","no")&&(e.isGhost=!0);const n=t.getAttribute("filled","");let r;switch("yes"===n?r=!0:"no"===n&&(r=!1),e.style=new Kt,t.innerText){case"arrow down":e.style.noteHeadCenterOnStem=!0,this.el(e,s,r,ut.NoteheadTriangleDownDoubleWhole,ut.NoteheadTriangleDownWhole,ut.NoteheadTriangleDownHalf,ut.NoteheadTriangleDownBlack);break;case"arrow up":e.style.noteHeadCenterOnStem=!0,this.el(e,s,r,ut.NoteheadTriangleUpDoubleWhole,ut.NoteheadTriangleUpWhole,ut.NoteheadTriangleUpHalf,ut.NoteheadTriangleUpBlack);break;case"back slashed":this.el(e,s,r,ut.NoteheadSlashedDoubleWhole2,ut.NoteheadSlashedWhole2,ut.NoteheadSlashedHalf2,ut.NoteheadSlashedBlack2);break;case"circle dot":e.style.noteHead=ut.NoteheadRoundWhiteWithDot;break;case"circle-x":this.el(e,s,r,ut.NoteheadCircleXDoubleWhole,ut.NoteheadCircleXWhole,ut.NoteheadCircleXHalf,ut.NoteheadCircleX);break;case"circled":this.el(e,s,r,ut.NoteheadCircledDoubleWhole,ut.NoteheadCircledWhole,ut.NoteheadCircledHalf,ut.NoteheadCircledBlack);break;case"cluster":this.el(e,s,r,ut.NoteheadClusterDoubleWhole3rd,ut.NoteheadClusterWhole3rd,ut.NoteheadClusterHalf3rd,ut.NoteheadClusterQuarter3rd);break;case"cross":this.el(e,s,r,ut.NoteheadPlusDoubleWhole,ut.NoteheadPlusWhole,ut.NoteheadPlusHalf,ut.NoteheadPlusBlack);break;case"diamond":this.el(e,s,r,ut.NoteheadDiamondDoubleWhole,ut.NoteheadDiamondWhole,ut.NoteheadDiamondHalf,ut.NoteheadDiamondBlack);break;case"do":this.el(e,s,r,ut.NoteShapeTriangleUpWhite,ut.NoteShapeTriangleUpWhite,ut.NoteShapeTriangleUpWhite,ut.NoteShapeTriangleUpBlack);break;case"fa":i===Rt.Up?this.el(e,s,r,ut.NoteShapeTriangleRightWhite,ut.NoteShapeTriangleRightWhite,ut.NoteShapeTriangleRightWhite,ut.NoteShapeTriangleRightBlack):this.el(e,s,r,ut.NoteShapeTriangleLeftWhite,ut.NoteShapeTriangleLeftWhite,ut.NoteShapeTriangleLeftWhite,ut.NoteShapeTriangleLeftBlack);break;case"fa up":this.el(e,s,r,ut.NoteShapeTriangleLeftWhite,ut.NoteShapeTriangleLeftWhite,ut.NoteShapeTriangleLeftWhite,ut.NoteShapeTriangleLeftBlack);break;case"inverted triangle":this.el(e,s,r,ut.NoteheadTriangleDownDoubleWhole,ut.NoteheadTriangleDownWhole,ut.NoteheadTriangleDownHalf,ut.NoteheadTriangleDownBlack);break;case"la":case"square":this.el(e,s,r,ut.NoteShapeSquareWhite,ut.NoteShapeSquareWhite,ut.NoteShapeSquareWhite,ut.NoteShapeSquareBlack);break;case"left triangle":this.el(e,s,r,ut.NoteheadTriangleRightWhite,ut.NoteheadTriangleRightWhite,ut.NoteheadTriangleRightWhite,ut.NoteheadTriangleRightBlack);break;case"mi":this.el(e,s,r,ut.NoteShapeDiamondWhite,ut.NoteShapeDiamondWhite,ut.NoteShapeDiamondWhite,ut.NoteShapeDiamondBlack);break;case"none":e.style.noteHead=ut.NoteheadNull;break;case"normal":this.el(e,s,r,ut.NoteheadDoubleWhole,ut.NoteheadWhole,ut.NoteheadHalf,ut.NoteheadBlack);break;case"re":this.el(e,s,r,ut.NoteShapeMoonWhite,ut.NoteShapeMoonWhite,ut.NoteShapeMoonWhite,ut.NoteShapeMoonBlack);break;case"rectangle":this.el(e,s,r,ut.NoteheadSquareWhite,ut.NoteheadSquareWhite,ut.NoteheadSquareWhite,ut.NoteheadSquareBlack);break;case"slash":this.el(e,s,r,ut.NoteheadSlashWhiteWhole,ut.NoteheadSlashWhiteWhole,ut.NoteheadSlashWhiteHalf,ut.NoteheadSlashHorizontalEnds);break;case"slashed":this.el(e,s,r,ut.NoteheadSlashedDoubleWhole1,ut.NoteheadSlashedWhole1,ut.NoteheadSlashedHalf1,ut.NoteheadSlashedBlack1);break;case"so":this.el(e,s,r,ut.NoteShapeRoundWhite,ut.NoteShapeRoundWhite,ut.NoteShapeRoundWhite,ut.NoteShapeRoundBlack);break;case"ti":this.el(e,s,r,ut.NoteShapeTriangleRoundWhite,ut.NoteShapeTriangleRoundWhite,ut.NoteShapeTriangleRoundWhite,ut.NoteShapeTriangleRoundBlack);break;case"triangle":this.el(e,s,r,ut.NoteheadTriangleUpDoubleWhole,ut.NoteheadTriangleUpWhole,ut.NoteheadTriangleUpHalf,ut.NoteheadTriangleUpBlack);break;case"x":this.el(e,s,r,ut.NoteheadXDoubleWhole,ut.NoteheadXWhole,ut.NoteheadXHalf,ut.NoteheadXBlack)}}Hc(t,e){let s=$.toTicks(e);for(;s>t;){if(e===l.TwoHundredFiftySixth)return null;e*=2,s=$.toTicks(e)}const i=new se;return i.dynamics=this.xo,i.isEmpty=!1,i.duration=e,i.overrideDisplayDuration=s,i.updateDurations(),i}Uc(t,e){if(e.beats.length>0){const s=e.beats[e.beats.length-1];s.nextBeat=t,t.previousBeat=s;let i=s;for(;null!==i&&i.graceType!==u.None;)i=i.index>0?i.previousBeat:null;null!==i&&(t.displayStart=i.displayEnd)}e.addBeat(t)}Vc(t){return t*$.QuarterTime/this.To}yc(t){switch(t.innerText){case"1024th":case"512th":case"256th":return l.TwoHundredFiftySixth;case"128th":return l.OneHundredTwentyEighth;case"64th":return l.SixtyFourth;case"32nd":return l.ThirtySecond;case"16th":return l.Sixteenth;case"eighth":return l.Eighth;case"quarter":return l.Quarter;case"half":return l.Half;case"whole":return l.Whole;case"breve":return l.DoubleWhole;case"long":return l.QuadrupleWhole}return null}static sl=[l.TwoHundredFiftySixth,l.OneHundredTwentyEighth,l.SixtyFourth,l.ThirtySecond,l.Sixteenth,l.Eighth,l.Quarter,l.Half,l.Whole,l.DoubleWhole,l.QuadrupleWhole];static il=pi.sl.map(t=>$.toTicks(t));zc(t,e,s,i){if(!s)for(let t=0;t<pi.sl.length;t++){if(!(e>=pi.il[t]))break;s=pi.sl[t]}t.duration=s??l.Sixteenth,i&&(t.overrideDisplayDuration=e),t.updateDurations()}Br(t,e,s){const i=this.ko.get(s.index).getLyricLine(t.getAttribute("number",""));for(null===e.lyrics&&(e.lyrics=[]);e.lyrics.length<=i;)e.lyrics.push("");for(const s of t.childElements())switch(s.localName){case"text":e.lyrics[i]?e.lyrics[i]+=` ${s.innerText}`:e.lyrics[i]=s.innerText;break;case"elision":e.lyrics[i]+=s.innerText}}Qc(t,e,s){for(const i of t.childElements())switch(i.localName){case"tied":e&&this.nl(i,e,s.voice.bar.staff);break;case"slur":e&&this.Fr(i,e);break;case"glissando":e&&this.rl(i,e);break;case"slide":e&&this.al(i,e);break;case"ornaments":e&&this.hl(i,e);break;case"technical":this.ol(i,e,s);break;case"articulations":e&&this.ph(i,e);break;case"dynamics":const t=this.Rc(i);null!==t&&(s.dynamics=t,this.xo=t);break;case"fermata":this.Lh(i,s);break;case"arpeggiate":this.cl(i,s)}}Dc(t){if(!this.So.has(t)){const e=new ui;return this.So.set(t,e),e}return this.So.get(t)}rl(t,e){const s=t.getAttribute("type"),i=t.getAttribute("number","1"),n=this.Dc(e.beat.voice.bar.staff);switch(s){case"start":n.slideOrigins.set(i,e);break;case"stop":if(n.slideOrigins.has(i)){const t=n.slideOrigins.get(i);t.slideTarget=e,e.slideOrigin=t,t.slideOutType=w.Shift}}}Fr(t,e){const s=t.getAttribute("number","1"),i=this.Dc(e.beat.voice.bar.staff);switch(t.getAttribute("type")){case"start":i.slurStarts.set(s,e);break;case"stop":if(i.slurStarts.has(s)){e.isSlurDestination=!0;const t=i.slurStarts.get(s);t.slurDestination=e,e.slurOrigin=t,i.slurStarts.delete(s)}}}cl(t,e){switch(t.getAttribute("direction","down")){case"down":e.brushType=o.ArpeggioDown;break;case"up":e.brushType=o.ArpeggioUp}}Lh(t,e){let s;switch(t.innerText){case"normal":default:s=Dt.Medium;break;case"angled":s=Dt.Short;break;case"square":s=Dt.Long}e.fermata=new Be,e.fermata.type=s}ph(t,e){for(const s of t.childElements())switch(s.localName){case"accent":e.accentuated=d.Normal;break;case"strong-accent":e.accentuated=d.Heavy;break;case"staccato":e.isStaccato=!0;break;case"tenuto":e.accentuated=d.Tenuto}}ol(t,e,s){const i=[];for(const n of t.childElements())switch(n.localName){case"up-bow":s.pickStroke=lt.Up;break;case"down-bow":s.pickStroke=lt.Down;break;case"harmonic":break;case"fingering":e&&(e.leftHandFinger=this.ll(n));break;case"pluck":e&&(e.rightHandFinger=this.ll(n));break;case"fret":e&&(e.fret=Number.parseInt(n.innerText,10));break;case"string":e&&(e.string=s.voice.bar.staff.tuning.length-Number.parseInt(n.innerText,10)+1);break;case"hammer-on":case"pull-off":e&&(e.isHammerPullOrigin=!0);break;case"bend":i.push(n);break;case"tap":s.tap=!0;break;case"smear":e&&(e.vibrato=y.Slight);break;case"golpe":switch(n.getAttribute("placement","above")){case"above":s.golpe=mt.Finger;break;case"below":s.golpe=mt.Thumb}}e&&i.length>0&&this.ul(i,e)}ul(t,e){const s=z.MaxPosition/t.length;let i=0,n=0,r=!0;for(const a of t){const t=a.findChildElement("bend-alter");if(t){const h=Math.round(2*Math.abs(Number.parseFloat(t.innerText)));a.findChildElement("pre-bend")?r?(i+=h,e.addBendPoint(new z(n,i)),n+=s,e.addBendPoint(new z(n,i)),r=!1):n+=s:a.findChildElement("release")?(r&&(i+=h),e.addBendPoint(new z(n,i)),n+=s,i-=h,e.addBendPoint(new z(n,i)),r=!1):(e.addBendPoint(new z(n,i)),i+=h,n+=s,e.addBendPoint(new z(n,i)),r=!1)}}}ll(t){switch(t.innerText){case"0":return f.NoOrDead;case"1":case"p":case"t":return f.Thumb;case"2":case"i":return f.IndexFinger;case"3":case"m":return f.MiddleFinger;case"4":case"a":return f.AnnularFinger;case"5":case"c":return f.LittleFinger}return f.Unknown}dl=-1;hl(t,e){let s=-1;for(const i of t.childElements())switch(i.localName){case"trill-mark":s=Number.parseInt(i.getAttribute("trill-step","2"),10),e.isStringed?e.trillValue=e.stringTuning+s:e.isPercussion||(e.trillValue=e.calculateRealValue(!1,!1)+s);break;case"turn":e.ornament=ft.Turn;break;case"inverted-turn":e.ornament=ft.InvertedTurn;break;case"wavy-line":s>0?"start"===i.getAttribute("type")&&(this.dl=s):this.dl>0?"stop"===i.getAttribute("type")?this.dl=-1:e.isStringed?e.trillValue=e.stringTuning+this.dl:e.isPercussion||(e.trillValue=e.calculateRealValue(!1,!1)+this.dl):e.vibrato=y.Slight;break;case"mordent":e.ornament=ft.LowerMordent;break;case"inverted-mordent":e.ornament=ft.UpperMordent;break;case"tremolo":const t=new te;e.beat.tremoloPicking=t,t.marks=Number.parseInt(i.innerText,10),("unmeasured"===i.getAttribute("type","")&&0===t.marks||"buzzRoll"===i.getAttribute("smufl",""))&&(t.style=St.BuzzRoll)}}al(t,e){const s=t.getAttribute("type"),i=t.getAttribute("number","1"),n=this.Dc(e.beat.voice.bar.staff);switch(s){case"start":n.slideOrigins.set(i,e);break;case"stop":if(n.slideOrigins.has(i)){const t=n.slideOrigins.get(i);t.slideTarget=e,e.slideOrigin=t,t.slideOutType=w.Shift}}}nl(t,e,s){const i=t.getAttribute("type"),n=t.getAttribute("number",""),r=this.Dc(s);if("start"===i){if(n){if(r.tieStartIds.has(n)){const t=r.tieStartIds.get(n);r.tieStarts.delete(t)}r.tieStartIds.set(n,e)}r.tieStarts.add(e)}else if("stop"===i&&!e.isTieDestination){let t=null;if(n){if(!r.tieStartIds.has(n))return;t=r.tieStartIds.get(n),r.tieStartIds.delete(n),r.tieStarts.delete(e)}else{const s=this.fl(e);for(const e of r.tieStarts)if(this.fl(e)===s){t=e,r.tieStarts.delete(t);break}}if(!t)return;e.isTieDestination=!0,e.tieOrigin=t}}qc(t){switch(t.innerText){case"down":return Rt.Down;case"up":return Rt.Up;default:return null}}Jc(t,e){switch(t.innerText){case"sharp":e.accidentalMode=b.ForceSharp;break;case"natural":e.accidentalMode=b.ForceNatural;break;case"flat":e.accidentalMode=b.ForceFlat;break;case"double-sharp":e.accidentalMode=b.ForceDoubleSharp;break;case"flat-flat":e.accidentalMode=b.ForceDoubleFlat}}fl(t){return 12*t.octave+t.tone}wi(t){return this.Vc(Number.parseFloat(t.innerText))}jc(t,e){let s="",i=0;for(const e of t.childElements())switch(e.localName){case"display-step":s=e.innerText;break;case"display-octave":i=Number.parseInt(e.innerText,10)+1}const n=new Qt;if(""===s)n.octave=0,n.tone=0;else{const t=12*i+(Xt.getToneForText(s)?.noteValue??0);n.octave=t/12|0,n.tone=t-12*n.octave}return n}Xc(t){let e="",s=0,i=0;for(const n of t.childElements())switch(n.localName){case"step":e=n.innerText;break;case"alter":s=Number.parseFloat(n.innerText),Number.isNaN(s)&&(s=0);break;case"octave":i=Number.parseInt(n.innerText,10)+1}s|=0;const n=12*i+(Xt.getToneForText(e)?.noteValue??0)+s,r=new Qt;return r.octave=n/12|0,r.tone=n-12*r.octave,r}el(t,e,s,i,n,r,a){if(void 0===s)switch(e){case l.QuadrupleWhole:case l.DoubleWhole:t.style.noteHead=i;break;case l.Whole:t.style.noteHead=n;break;case l.Half:t.style.noteHead=r;break;default:t.style.noteHead=a}else if(!0===s)t.style.noteHead=a;else switch(e){case l.QuadrupleWhole:case l.DoubleWhole:t.style.noteHead=i;break;case l.Whole:t.style.noteHead=n;break;case l.Half:default:t.style.noteHead=r}}}t.LayoutMode=void 0,(qe=t.LayoutMode||(t.LayoutMode={}))[qe.Page=0]="Page",qe[qe.Horizontal=1]="Horizontal",qe[qe.Parchment=2]="Parchment";class bi{ni;pl=0;bl=0;count=0;constructor(t){this.ni=new Float32Array(t)}clear(){this.bl=0,this.pl=0,this.count=0,this.ni=new Float32Array(this.ni.length)}write(t,e,s){let i=0;s>this.ni.length-this.count&&(s=this.ni.length-this.count);const n=Math.min(this.ni.length-this.pl,s);return this.ni.set(t.subarray(e,e+n),this.pl),this.pl+=n,this.pl%=this.ni.length,i+=n,i<s&&(this.ni.set(t.subarray(e+i,e+i+s-i),this.pl),this.pl+=s-i,i=s),this.count+=i,i}read(t,e,s){s>this.count&&(s=this.count);let i=0;const n=Math.min(this.ni.length-this.bl,s);return t.set(this.ni.subarray(this.bl,this.bl+n),e),i+=n,this.bl+=n,this.bl%=this.ni.length,i<s&&(t.set(this.ni.subarray(this.bl,this.bl+s-i),e+i),this.bl+=s-i,i=s),this.count-=i,i}}class mi{ml=[];gl;constructor(t=void 0){this.gl=t}on(t){return this.ml.push(t),this.gl?.()&&t(),()=>{this.off(t)}}off(t){this.ml=this.ml.filter(e=>e!==t)}trigger(){for(const t of this.ml)t()}}class gi{ml=[];gl;constructor(t=void 0){this.gl=t}on(t){if(this.ml.push(t),this.gl){const e=this.gl();null!==e&&t(e)}return()=>{this.off(t)}}off(t){this.ml=this.ml.filter(e=>e!==t)}trigger(t){for(const e of this.ml)e(t)}}class wi{static CmdOutputPrefix="alphaSynth.output.";static CmdOutputAddSamples=`${wi.CmdOutputPrefix}addSamples`;static CmdOutputPlay=`${wi.CmdOutputPrefix}play`;static CmdOutputPause=`${wi.CmdOutputPrefix}pause`;static CmdOutputResetSamples=`${wi.CmdOutputPrefix}resetSamples`;static CmdOutputStop=`${wi.CmdOutputPrefix}stop`;static CmdOutputSampleRequest=`${wi.CmdOutputPrefix}sampleRequest`;static CmdOutputSamplesPlayed=`${wi.CmdOutputPrefix}samplesPlayed`;static preferredSampleRate=0;wl;get sampleRate(){return wi.preferredSampleRate}open(){q.debug("AlphaSynth","Initializing synth worker"),this.wl=Nu.globalThis,this.wl.addEventListener("message",this.yl.bind(this)),this.ready.trigger()}destroy(){this.wl.postMessage({cmd:"alphaSynth.output.destroy"})}yl(t){const e=t.data;switch(e.cmd){case wi.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case wi.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(e.samples)}}ready=new mi;samplesPlayed=new gi;sampleRequest=new mi;addSamples(t){this.wl.postMessage({cmd:"alphaSynth.output.addSamples",samples:Nu.prepareForPostMessage(t)})}play(){this.wl.postMessage({cmd:"alphaSynth.output.play"})}pause(){this.wl.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this.wl.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(t){}async getOutputDevice(){return null}}class yi{device;constructor(t){this.device=t}get deviceId(){return this.device.deviceId}get label(){return this.device.label}isDefault=!1}class ki{static kl=[];static findKnownDevice(t){return ki.kl.find(e=>e.deviceId===t)}static createAudioContext(){if("AudioContext"in Nu.globalThis)return new AudioContext;if("webkitAudioContext"in Nu.globalThis)return new webkitAudioContext;throw new G(t.AlphaTabErrorType.General,"AudioContext not found")}static async checkSinkIdSupport(){return"setSinkId"in ki.createAudioContext()||(q.warning("WebAudio","Browser does not support changing the output device"),!1)}static async enumerateOutputDevices(){try{if(!await ki.checkSinkIdSupport())return[];try{await navigator.mediaDevices.getUserMedia({audio:!0})}catch(t){q.warning("WebAudio","Output device permission rejected",t)}const t=await navigator.mediaDevices.enumerateDevices();let e="",s="";const i=new Map;for(const n of t)"audiooutput"===n.kind&&(i.set(n.groupId,new yi(n)),"default"!==n.deviceId&&""!==n.deviceId||(e=n.groupId,s=n.deviceId));const n=Array.from(i.values());let r=n.find(t=>t.deviceId===s);return r||(r=n.find(t=>t.device.groupId===e)),!r&&n.length>0&&(r=n[0]),r&&(r.isDefault=!0),ki.kl=n,n}catch(t){return q.error("WebAudio","Failed to enumerate output devices",t),[]}}}class Si{static BufferSize=4096;static PreferredSampleRate=44100;context=null;buffer=null;source=null;Sl;get sampleRate(){return this.context?this.context.sampleRate:Si.PreferredSampleRate}activate(t){this.context||(this.context=ki.createAudioContext()),"suspended"!==this.context.state&&"interrupted"!==this.context.state||(q.debug("WebAudio","Audio Context is suspended, trying resume"),this.context.resume().then(()=>{q.debug("WebAudio",`Audio Context resume success: state=${this.context?.state}, sampleRate:${this.context?.sampleRate}`),t&&t()},t=>{q.warning("WebAudio",`Audio Context resume failed: state=${this.context?.state}, sampleRate:${this.context?.sampleRate}, reason=${t}`)}))}Bl(){const t=navigator.userAgent;if(-1!==t.indexOf("iPhone")||-1!==t.indexOf("iPad")){const t=ki.createAudioContext(),e=t.createBuffer(1,1,Si.PreferredSampleRate),s=t.createBufferSource();s.buffer=e,s.connect(t.destination),s.start(0),s.disconnect(0),t.close()}}open(t){this.Bl(),this.context=ki.createAudioContext();"suspended"===this.context.state&&this._l()}_l(){this.Sl=(()=>{this.activate(()=>{this.Tl()})}).bind(this),document.body.addEventListener("touchend",this.Sl,!1),document.body.addEventListener("click",this.Sl,!1)}Tl(){const t=this.Sl;t&&(document.body.removeEventListener("touchend",t,!1),document.body.removeEventListener("click",t,!1))}play(){const t=this.context;this.activate(),this.buffer=t.createBuffer(2,Si.BufferSize,t.sampleRate),this.source=t.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0}pause(){this.source&&(this.source.stop(0),this.source.disconnect()),this.source=null}destroy(){this.pause(),this.context?.close(),this.context=null,this.Tl()}ready=new mi;samplesPlayed=new gi;sampleRequest=new mi;onSamplesPlayed(t){this.samplesPlayed.trigger(t)}onSampleRequest(){this.sampleRequest.trigger()}onReady(){this.ready.trigger()}enumerateOutputDevices(){return ki.enumerateOutputDevices()}async setOutputDevice(t){await ki.checkSinkIdSupport()&&(t?await this.context.setSinkId(t.deviceId):await this.context.setSinkId(""))}async getOutputDevice(){if(!await ki.checkSinkIdSupport())return null;const t=this.context.sinkId;if("string"!=typeof t||""===t||"default"===t)return null;let e=ki.findKnownDevice(t);if(e)return e;const s=await this.enumerateOutputDevices();return e=s.find(e=>e.deviceId===t),e||(q.warning("WebAudio","Could not find output device in device list",t,s),null)}}class Bi{static xl=!1;static init(){Bi.xl||(Bi.xl=!0,registerProcessor("alphatab",class t extends AudioWorkletProcessor{static BufferSize=4096;Ml=new Float32Array(0);vl;Nl=0;Pl=0;Cl=!1;constructor(e){super(e),q.debug("WebAudio","creating processor"),this.Nl=Math.floor(e.processorOptions.bufferTimeInMilliseconds*sampleRate/1e3/t.BufferSize),this.vl=new bi(t.BufferSize*this.Nl),this.port.onmessage=this.yl.bind(this)}yl(t){const e=t.data;switch(e.cmd){case wi.CmdOutputAddSamples:const t=e.samples;this.vl.write(t,0,t.length),this.Pl--;break;case wi.CmdOutputResetSamples:this.vl.clear();break;case wi.CmdOutputStop:this.Cl=!0}}process(t,e,s){if(1!==e.length&&2!==e[0].length)return!1;const i=e[0][0],n=e[0][1];if(!i||!n)return!0;const r=i.length+n.length;let a=this.Ml;a.length!==r&&(a=new Float32Array(r),this.Ml=a);const h=this.vl.read(a,0,Math.min(a.length,this.vl.count));let o=0;const c=Math.min(i.length,h);for(let t=0;t<c;t++)i[t]=a[o++],n[t]=a[o++];if(h<i.length)for(let t=h;t<i.length;t++)i[t]=0,n[t]=0;return this.port.postMessage({cmd:wi.CmdOutputSamplesPlayed,samples:h/Ht.AudioChannels}),this.El(),this.vl.count>0||!this.Cl}El(){const e=this.Nl/2|0,s=e*t.BufferSize;if(this.vl.count+this.Pl*t.BufferSize<s){for(let t=0;t<e;t++)this.port.postMessage({cmd:wi.CmdOutputSampleRequest});this.Pl+=e}}}))}}class _i extends Si{Fl=null;Al=0;Dl;constructor(t){super(),this.Dl=t}open(t){super.open(t),this.Al=t,this.onReady()}play(){super.play();const t=this.context;Nu.createAudioWorklet(t,this.Dl).then(()=>{this.Fl=new AudioWorkletNode(t,"alphatab",{numberOfOutputs:1,outputChannelCount:[2],processorOptions:{bufferTimeInMilliseconds:this.Al}}),this.Fl.port.onmessage=this.yl.bind(this),this.source.connect(this.Fl),this.source.start(0),this.Fl.connect(t.destination)},t=>{q.error("WebAudio",`Audio Worklet creation failed: reason=${t}`)})}yl(t){const e=t.data;switch(e.cmd){case wi.CmdOutputSamplesPlayed:this.onSamplesPlayed(e.samples);break;case wi.CmdOutputSampleRequest:this.onSampleRequest()}}pause(){super.pause(),this.Fl&&(this.Fl.port.postMessage({cmd:wi.CmdOutputStop}),this.Fl.port.onmessage=null,this.Fl.disconnect()),this.Fl=null}addSamples(t){this.Fl?.port.postMessage({cmd:wi.CmdOutputAddSamples,samples:Nu.prepareForPostMessage(t)})}resetSamples(){this.Fl?.port.postMessage({cmd:wi.CmdOutputResetSamples})}}!function(t){t[t.SingleTrackMultiChannel=0]="SingleTrackMultiChannel",t[t.MultiTrack=1]="MultiTrack"}(Ye||(Ye={}));class Ti{events=[];addEvent(t){if(0===this.events.length||t.tick>=this.events[this.events.length-1].tick)this.events.push(t);else{let e=this.events.length;for(;e>0;){if(!(this.events[e-1].tick>t.tick))break;e--}this.events.splice(e,0,t)}}writeTo(t){const e=Ae.empty();let s=0;for(const t of this.events){const i=t.tick-s;xi.writeVariableInt(e,i),t.writeTo(e),s=t.tick}const i=new Uint8Array([77,84,114,107]);t.write(i,0,i.length);const n=e.toArray();fe.writeInt32BE(t,n.length),t.write(n,0,n.length)}}class xi{format=Ye.SingleTrackMultiChannel;division=$.QuarterTime;tickShift=0;get events(){if(1===this.tracks.length)return this.tracks[0].events;const t=[];for(const t of this.tracks)this.events.push(...t.events);return t.sort((t,e)=>t.tick-e.tick),t}tracks=[];Ll(t){for(;this.tracks.length<t;)this.tracks.push(new Ti)}addEvent(t){this.format===Ye.SingleTrackMultiChannel?(this.Ll(1),this.tracks[0].addEvent(t)):(this.Ll(t.track+1),this.tracks[t.track].addEvent(t))}toBinary(){const t=Ae.empty();return this.writeTo(t),t.toArray()}writeTo(t){const e=new Uint8Array([77,84,104,100]);t.write(e,0,e.length),fe.writeInt32BE(t,6),fe.writeInt16BE(t,this.format),fe.writeInt16BE(t,this.tracks.length),fe.writeInt16BE(t,this.division);for(const e of this.tracks)e.writeTo(t)}static writeVariableInt(t,e){const s=new Uint8Array(4);let i=0;do{s[i++]=127&e,e>>=7}while(e>0);for(;i>0;)i--,i>0?t.writeByte(128|s[i]):t.writeByte(s[i])}}!function(t){t[t.TimeSignature=88]="TimeSignature",t[t.NoteOn=128]="NoteOn",t[t.NoteOff=144]="NoteOff",t[t.ControlChange=176]="ControlChange",t[t.ProgramChange=192]="ProgramChange",t[t.TempoChange=81]="TempoChange",t[t.PitchBend=224]="PitchBend",t[t.PerNotePitchBend=96]="PerNotePitchBend",t[t.EndOfTrack=47]="EndOfTrack",t[t.AlphaTabRest=241]="AlphaTabRest",t[t.AlphaTabMetronome=242]="AlphaTabMetronome",t[t.SystemExclusive=240]="SystemExclusive",t[t.SystemExclusive2=247]="SystemExclusive2",t[t.Meta=255]="Meta"}(Ke||(Ke={}));class Mi{track;tick;type;constructor(t,e,s){this.track=t,this.tick=e,this.type=s}get command(){return this.type}get message(){return 0}get data1(){return 0}get data2(){return 0}}class vi extends Mi{numerator;denominatorIndex;midiClocksPerMetronomeClick;thirtySecondNodesInQuarter;constructor(t,e,s,i,n,r){super(t,e,Ke.TimeSignature),this.track=t,this.tick=e,this.numerator=s,this.denominatorIndex=i,this.midiClocksPerMetronomeClick=n,this.thirtySecondNodesInQuarter=r}writeTo(t){t.writeByte(255),t.writeByte(88),xi.writeVariableInt(t,4),t.writeByte(255&this.numerator),t.writeByte(255&this.denominatorIndex),t.writeByte(255&this.midiClocksPerMetronomeClick),t.writeByte(255&this.thirtySecondNodesInQuarter)}}class Ni extends Mi{static AlphaTabManufacturerId=125;static MetronomeEventId=0;static RestEventId=1;writeTo(t){t.writeByte(240);const e=Ae.withCapacity(16);e.writeByte(Ni.AlphaTabManufacturerId),this.writeEventData(e),e.writeByte(247),xi.writeVariableInt(t,e.length),e.copyTo(t)}}class Pi extends Ni{metronomeNumerator;metronomeDurationInTicks;metronomeDurationInMilliseconds;isMetronome=!0;constructor(t,e,s,i,n){super(t,e,Ke.AlphaTabMetronome),this.metronomeNumerator=s,this.metronomeDurationInMilliseconds=n,this.metronomeDurationInTicks=i}writeEventData(t){t.writeByte(Ni.MetronomeEventId),t.writeByte(this.metronomeNumerator),fe.writeInt32LE(t,this.metronomeDurationInTicks),fe.writeInt32LE(t,this.metronomeDurationInMilliseconds)}}class Ci extends Ni{channel;constructor(t,e,s){super(t,e,Ke.AlphaTabRest),this.channel=s}writeEventData(t){t.writeByte(Ni.RestEventId),t.writeByte(this.channel)}}class Ei extends Mi{channel;noteKey;noteVelocity;constructor(t,e,s,i,n,r){super(t,e,s),this.channel=i,this.noteKey=n,this.noteVelocity=r}get data1(){return this.noteKey}get data2(){return this.noteVelocity}}class Fi extends Ei{constructor(t,e,s,i,n){super(t,e,Ke.NoteOn,s,i,n)}writeTo(t){t.writeByte(15&this.channel|144),t.writeByte(255&this.noteKey),t.writeByte(255&this.noteVelocity)}}class Ai extends Ei{constructor(t,e,s,i,n){super(t,e,Ke.NoteOff,s,i,n)}writeTo(t){t.writeByte(15&this.channel|128),t.writeByte(255&this.noteKey),t.writeByte(255&this.noteVelocity)}}class Di extends Mi{channel;controller;value;constructor(t,e,s,i,n){super(t,e,Ke.ControlChange),this.channel=s,this.controller=i,this.value=n}writeTo(t){t.writeByte(15&this.channel|176),t.writeByte(255&this.controller),t.writeByte(255&this.value)}get data1(){return this.controller}get data2(){return this.value}}class Li extends Mi{channel;program;constructor(t,e,s,i){super(t,e,Ke.ProgramChange),this.channel=s,this.program=i}writeTo(t){t.writeByte(15&this.channel|192),t.writeByte(255&this.program)}get data1(){return this.program}}class Wi extends Mi{get microSecondsPerQuarterNote(){return 6e7/this.beatsPerMinute}set microSecondsPerQuarterNote(t){this.beatsPerMinute=6e7/t}beatsPerMinute=0;constructor(t,e){super(0,t,Ke.TempoChange),this.microSecondsPerQuarterNote=e}writeTo(t){t.writeByte(255),t.writeByte(81),t.writeByte(3),t.writeByte(this.microSecondsPerQuarterNote>>16&255),t.writeByte(this.microSecondsPerQuarterNote>>8&255),t.writeByte(255&this.microSecondsPerQuarterNote)}}class Ri extends Mi{channel;value;constructor(t,e,s,i){super(t,e,Ke.PitchBend),this.channel=s,this.value=i}writeTo(t){t.writeByte(15&this.channel|224),t.writeByte(127&this.value),t.writeByte(this.value>>7&127)}get data1(){return 127&this.value}get data2(){return this.value>>7&127}}class Ii extends Mi{channel;noteKey;value;constructor(t,e,s,i,n){super(t,e,Ke.PerNotePitchBend),this.channel=s,this.noteKey=i,this.value=n}writeTo(e){throw new G(t.AlphaTabErrorType.General,"Note Bend (Midi2.0) events cannot be exported to SMF1.0")}}class Oi extends Mi{constructor(t,e){super(t,e,Ke.EndOfTrack)}writeTo(t){t.writeByte(255),t.writeByte(47),t.writeByte(0)}}class Gi{eventIndex;event;isMetronome;time=0;constructor(t,e){this.eventIndex=t,this.event=e,this.isMetronome=this.event.type===Ke.AlphaTabMetronome}static newMetronomeEvent(t,e,s,i,n){const r=new Pi(0,e,s,i,n);return new Gi(t,r)}}class Vi{masterBarIndex=0;masterBarOccurence=0;synthBpm=0;synthTime=0;synthTick=0;syncTime=0;syncBpm=0;updateSyncBpm(t,e){const s=(t-this.synthTime)/(e-this.syncTime)*this.synthBpm;this.syncBpm=s}}class $i{bpm;ticks;time;constructor(t,e,s){this.bpm=t,this.ticks=e,this.time=s}}class Hi{tempoChanges=[];tempoChangeIndex=0;syncPoints=[];firstProgramEventPerChannel=new Map;firstTimeSignatureNumerator=0;firstTimeSignatureDenominator=0;synthData=[];division=$.QuarterTime;eventIndex=0;currentTime=0;syncPointIndex=0;playbackRange=null;playbackRangeStartTime=0;playbackRangeEndTime=0;endTick=0;endTime=0;currentTempo=0;syncPointTempo=0}class Ui{Wl;Rl;Il;Ol=null;Gl=null;get isPlayingMain(){return this.Rl===this.Il}get isPlayingOneTimeMidi(){return this.Rl===this.Ol}get isPlayingCountIn(){return this.Rl===this.Gl}constructor(t){this.Wl=t,this.Il=new Hi,this.Rl=this.Il}get mainPlaybackRange(){return this.Il.playbackRange}set mainPlaybackRange(t){this.Il.playbackRange=t,t&&(this.Il.playbackRangeStartTime=this.Vl(this.Il,t.startTick,1),this.Il.playbackRangeEndTime=this.Vl(this.Il,t.endTick,1))}isLooping=!1;get currentTime(){return this.Rl.currentTime/this.playbackSpeed}get currentEndTick(){return this.Rl.endTick}get currentEndTime(){return this.Rl.endTime/this.playbackSpeed}get currentTempo(){return this.Rl.currentTempo}get modifiedTempo(){return this.Rl.syncPointTempo*this.playbackSpeed}get syncPointTempo(){return this.Rl.syncPointTempo}get currentSyncPoints(){return this.Rl.syncPoints}playbackSpeed=1;mainSeek(t){if(t*=this.playbackSpeed,this.mainPlaybackRange&&(t<this.Il.playbackRangeStartTime?t=this.Il.playbackRangeStartTime:t>this.Il.playbackRangeEndTime&&(t=this.Il.playbackRangeEndTime)),t>this.Il.currentTime)this.$l(t-this.Il.currentTime);else if(t<this.Il.currentTime){if(this.Il.currentTime=0,this.Il.eventIndex=0,this.Il.syncPointIndex=0,this.Il.tempoChangeIndex=0,this.Il.currentTempo=this.Il.tempoChanges[0].bpm,this.Il.syncPointTempo=this.Il.syncPoints.length>0?this.Il.syncPoints[0].syncBpm:this.Il.currentTempo,this.isPlayingMain){const t=this.Wl.metronomeVolume;this.Wl.noteOffAll(!0),this.Wl.resetSoft(),this.Wl.setupMetronomeChannel(t)}this.$l(t)}}$l(t){if(t<=0)return;const e=Date.now(),s=this.Il.currentTime+t;if(this.isPlayingMain)for(;this.Il.currentTime<s;)this.Hl(s-this.Il.currentTime)&&this.Wl.synthesizeSilent(Ht.MicroBufferSize);this.Il.currentTime=s;const i=Date.now()-e;q.debug("Sequencer",`Silent seek finished in ${i}ms (main)`)}loadOneTimeMidi(t){this.Ol=this.createStateFromFile(t),this.Rl=this.Ol}instrumentPrograms=new Set;percussionKeys=new Set;loadMidi(t){this.instrumentPrograms.clear(),this.percussionKeys.clear(),this.Il=this.createStateFromFile(t),this.Rl=this.Il}createStateFromFile(t){const e=new Hi;this.percussionKeys.add(Ht.MetronomeKey),e.tempoChanges=[],e.division=t.division,e.eventIndex=0,e.currentTime=0,e.synthData=[];let s=120,i=0,n=0,r=0,a=0,h=0,o=t.tickShift,c=0,l=0;for(const u of t.events){const d=new Gi(e.synthData.length,u);e.synthData.push(d);const f=u.tick-l;if(i+=f,n+=f*(6e4/(s*t.division)),d.time=n,l=u.tick,a>0)for(;o<i;){const t=Gi.newMetronomeEvent(e.synthData.length,o,Math.floor(o/a)%r,a,h);e.synthData.push(t),t.time=c,o+=a,c+=h}if(u.type===Ke.TempoChange){const r=u;s=Ui.Ul(r.beatsPerMinute),e.tempoChanges.push(new $i(s,i,n)),h=a*(6e4/(s*t.division))}else if(u.type===Ke.TimeSignature){const i=u,n=Math.pow(2,i.denominatorIndex);r=i.numerator,a=e.division*(4/n)|0,h=a*(6e4/(s*t.division)),0===e.firstTimeSignatureDenominator&&(e.firstTimeSignatureNumerator=i.numerator,e.firstTimeSignatureDenominator=n)}else if(u.type===Ke.ProgramChange){const t=u,s=t.channel;e.firstProgramEventPerChannel.has(s)||e.firstProgramEventPerChannel.set(s,d);s===Ht.PercussionChannel||this.instrumentPrograms.add(t.program)}else if(u.type===Ke.NoteOn){const t=u;t.channel===Ht.PercussionChannel&&this.percussionKeys.add(t.noteKey)}}return e.currentTempo=e.tempoChanges.length>0?e.tempoChanges[0].bpm:s,e.syncPointTempo=e.currentTempo,e.synthData.sort((t,e)=>t.time>e.time?1:t.time<e.time?-1:t.eventIndex-e.eventIndex),e.endTime=n,e.endTick=i,e}fillMidiEventQueue(){return this.Hl(-1)}fillMidiEventQueueToEndTime(t){for(;this.Il.currentTime<t;)this.Hl(t-this.Il.currentTime)&&this.Wl.synthesizeSilent(Ht.MicroBufferSize);let e=!1;for(this.Rl.currentTime=t;this.Rl.eventIndex<this.Rl.synthData.length&&this.Rl.synthData[this.Rl.eventIndex].time<this.Rl.currentTime;){const t=this.Rl.synthData[this.Rl.eventIndex];this.Wl.dispatchEvent(t),this.Rl.eventIndex++,e=!0}return e}Hl(t){let e=Ht.MicroBufferSize/this.Wl.outSampleRate*1e3*this.playbackSpeed,s=this.zl;t>0&&(t<e&&(e=t),s=Math.min(this.zl,this.Rl.currentTime+t));let i=!1;for(this.Rl.currentTime+=e;this.Rl.eventIndex<this.Rl.synthData.length&&this.Rl.synthData[this.Rl.eventIndex].time<this.Rl.currentTime&&this.Rl.currentTime<s;)this.Wl.dispatchEvent(this.Rl.synthData[this.Rl.eventIndex]),this.Rl.eventIndex++,i=!0;return i}mainTickPositionToTimePosition(t){return this.Vl(this.Il,t,this.playbackSpeed)}mainUpdateSyncPoints(t){const e=this.Il;if(t.sort((t,e)=>t.synthTick-e.synthTick),e.syncPoints=[],t.length>=0){let s=120,i=0,n=0,r=0;for(let a=0;a<t.length;a++){const h=t[a];let o,c,l,u=0;if(0===a)o=s,c=0,l=0;else{const e=t[a-1];o=Ui.Ul(e.syncBpm),c=e.syncTime,l=e.synthTick}for(;r<e.tempoChanges.length&&e.tempoChanges[r].ticks<=h.synthTick;){if(u=e.tempoChanges[r].ticks-i,u>0){i+=u,n+=u*(6e4/(s*e.division));const t=(i-l)*((h.syncTime-c)/(h.synthTick-l))+c,r=new Vi;r.synthTick=i,r.synthBpm=s,r.synthTime=n,r.syncTime=t,r.syncBpm=o}s=Ui.Ul(e.tempoChanges[r].bpm),r++}u=h.synthTick-i,i+=u,n+=u*(6e4/(s*e.division)),e.syncPoints.push(h)}}e.syncPointIndex=0,e.syncPointTempo=e.syncPoints.length>0?e.syncPoints[0].syncBpm:e.currentTempo}currentTimePositionToTickPosition(t){const e=this.Rl;if(0===e.tempoChanges.length)return 0;t*=this.playbackSpeed,this.Xl(e,t);const s=e.tempoChanges[e.tempoChangeIndex],i=(t-s.time)/(6e4/(Ui.Ul(s.bpm)*e.division))|0;return s.ticks+i+1}static Ul(t){return Math.max(t,1)}currentUpdateCurrentTempo(t){this.Xl(this.Il,t*this.playbackSpeed)}Xl(t,e){let s=t.tempoChangeIndex;for(e<t.tempoChanges[s].time&&(s=0);s+1<t.tempoChanges.length&&t.tempoChanges[s+1].time<=e;)s++;s!==t.tempoChangeIndex&&(t.tempoChangeIndex=s,t.currentTempo=t.tempoChanges[t.tempoChangeIndex].bpm,0===t.syncPoints.length&&(t.syncPointTempo=t.currentTempo))}currentUpdateSyncPoints(t){this.jl(this.Il,t)}jl(t,e){const s=t.syncPoints;if(s.length>0){let i=Math.min(t.syncPointIndex,s.length-1);for(e<s[i].syncTime&&(i=0);i+1<s.length&&s[i+1].syncTime<=e;)i++;i!==t.syncPointIndex&&(t.syncPointIndex=i,t.syncPointTempo=s[i].syncBpm)}else t.syncPointTempo=t.currentTempo}mainTimePositionFromBackingTrack(t,e){const s=this.Il,i=s.syncPoints;if(t<0||0===i.length)return t;this.jl(this.Il,t);const n=Math.min(s.syncPointIndex,i.length-1),r=i[n],a=t-r.syncTime;let h;if(n+1<i.length){const t=i[n+1],e=a/(t.syncTime-r.syncTime);h=(t.synthTime-r.synthTime)*e}else{const t=a/(e-r.syncTime);h=(s.endTime-r.synthTime)*t}return(r.synthTime+h)/this.playbackSpeed}mainTimePositionToBackingTrack(t,e){const s=this.Il,i=s.syncPoints;if(t<0||0===i.length)return t;t*=this.playbackSpeed;let n=Math.min(s.syncPointIndex,i.length-1);for(t<i[n].synthTime&&(n=0);n+1<i.length&&i[n+1].synthTime<=t;)n++;const r=i[n],a=t-r.synthTime;let h;if(n+1<i.length){const t=i[n+1],e=a/(t.synthTime-r.synthTime),s=t.syncTime-r.syncTime;h=r.syncTime+s*e}else{const t=a/(s.endTime-r.synthTime),i=e-r.syncTime;h=r.syncTime+i*t}return h}Vl(t,e,s){let i=0,n=120,r=0;for(const s of t.tempoChanges){if(e<s.ticks)break;i=s.time,n=s.bpm,r=s.ticks}return i+=(e-=r)*(6e4/(n*t.division)),i/s}get zl(){return this.isPlayingMain&&this.mainPlaybackRange?this.Rl.playbackRangeEndTime:this.Rl.endTime}get isFinished(){return this.Rl.currentTime>=this.zl}stop(){this.isPlayingMain&&this.mainPlaybackRange?this.Rl.currentTime=this.mainPlaybackRange.startTick:this.Rl.currentTime=0,this.Rl.eventIndex=0}resetOneTimeMidi(){this.Ol=null,this.Rl=this.Il}resetCountIn(){this.Gl=null,this.Rl=this.Il}startCountIn(){this.generateCountInMidi(),this.Rl=this.Gl,this.stop(),this.Wl.noteOffAll(!0)}generateCountInMidi(){const t=new Hi;t.division=this.Il.division;let e=120,s=4,i=4;0===this.Il.eventIndex?(e=this.Il.tempoChanges[0].bpm,s=this.Il.firstTimeSignatureNumerator,i=this.Il.firstTimeSignatureDenominator):(e=this.Wl.currentTempo,s=this.Wl.timeSignatureNumerator,i=this.Wl.timeSignatureDenominator),t.tempoChanges.push(new $i(e,0,0));const n=t.division*(4/i)|0,r=n*(6e4/(e*this.Il.division));let a=0,h=0;for(let e=0;e<s;e++){const s=Gi.newMetronomeEvent(t.synthData.length,a,e,n,r);t.synthData.push(s),s.time=h,a+=n,h+=r}t.synthData.sort((t,e)=>t.time>e.time?1:t.time<e.time?-1:t.eventIndex-e.eventIndex),t.endTime=h,t.endTick=a,t.currentTempo=e,t.syncPointTempo=e,this.Gl=t}}!function(t){t[t.Paused=0]="Paused",t[t.Playing=1]="Playing"}(Qe||(Qe={}));class zi{state;stopped;constructor(t,e){this.state=t,this.stopped=e}}class Xi{currentTime;endTime;currentTick;endTick;isSeek;originalTempo=0;modifiedTempo=0;constructor(t,e,s,i,n,r,a){this.currentTime=t,this.endTime=e,this.currentTick=s,this.endTick=i,this.isSeek=n,this.originalTempo=r,this.modifiedTempo=a}}class ji{static HeaderSize=8;id="";size=0;static load(t,e,s){if(t&&ji.HeaderSize>t.size)return!1;if(s.position+ji.HeaderSize>=s.length)return!1;if(e.id=fe.read8BitStringLength(s,4),e.id.charCodeAt(0)<=32||e.id.charCodeAt(0)>=122)return!1;if(e.size=fe.readUInt32LE(s),t&&ji.HeaderSize+e.size>t.size)return!1;t&&(t.size-=ji.HeaderSize+e.size);const i="RIFF"===e.id,n="LIST"===e.id;return(!i||!t)&&(!i&&!n||(e.id=fe.read8BitStringLength(s,4),!(e.id.charCodeAt(0)<=32||e.id.charCodeAt(0)>=122)&&(e.size-=4,!0)))}}class Ji{packetData;isBeginningOfStream;isEndOfStream;granulePosition;constructor(t,e,s,i){this.packetData=t,this.isBeginningOfStream=e,this.isEndOfStream=s,this.granulePosition=s?i:null}addData(t){const e=this.packetData,s=new Uint8Array(e.length+t.length);s.set(e,0),s.set(t,e.length)}}!function(t){t[t.ContinuesPacket=1]="ContinuesPacket",t[t.BeginningOfStream=2]="BeginningOfStream",t[t.EndOfStream=4]="EndOfStream"}(Ze||(Ze={}));class qi{cn;constructor(t){this.cn=t}read(){const t=[];for(;this.Jl(t););return t}Jl(t){return!!this.ql()&&this.Yl(t)}ql(){for(let t=0;t<65536;t++){if(1399285583===fe.readInt32LE(this.cn))return!0;this.cn.position-=3}return!1}Yl(e){const s=this.cn.readByte();if(-1===s||0!==s)return!1;const i=this.cn.readByte(),n=fe.readInt64LE(this.cn);this.cn.skip(4),this.cn.skip(4),this.cn.skip(4);const r=this.cn.readByte();if(-1===r)return!1;const a=[];let h=0;for(let t=0;t<r;t++){const t=this.cn.readByte();h===a.length&&a.push(0),a[h]+=t,t<255&&h++}for(let s=0;s<a.length;s++){const r=new Uint8Array(a[s]);if(this.cn.read(r,0,r.length)!==r.length)return!1;if(0!==(i&Ze.ContinuesPacket)){if(0===e.length)throw new G(t.AlphaTabErrorType.Format,"OGG: Continuation page without any previous packets");e[e.length-1].addData(r)}else{const t=new Ji(r,0!==(i&Ze.BeginningOfStream)&&0===s,0!==(i&Ze.EndOfStream)&&s===a.length-1,n);e.push(t)}}return!0}}class Yi{audioChannels=0;audioSampleRate=0;samples=new Float32Array(0);bitrateMaximum=0;bitrateNominal=0;bitrateMinimum=0;blocksize0=0;blocksize1=0}class Ki{value=0;bitsRead=0}class Qi{static Jh=8;Kh;Kl=0n;Ql=0n;Zl=0n;constructor(t){this.Kh=t}readByte(){return this.readBits(Qi.Jh)}readBit(){return 1===this.readBits(1)}readBytes(t){const e=new Uint8Array(t);for(let s=0;s<t;s++)e[s]=255&this.readByte();return e}readBits(t){if(0===t)return 0;const e=this.tryPeekBits(t);return this.skipBits(t),e.value}tryPeekBits(e){if(e<0||e>32)throw new G(t.AlphaTabErrorType.General,"IO: Cannot read more than 32 bits in one go");if(0===e)return new Ki;const s=new Ki;for(;this.Ql<e;){const t=BigInt(this.Kh.readByte());if(-1n===t)return s.bitsRead=Number(this.Ql),s.value=Number(this.Kl),this.Kl=0n,this.Ql=0n,s;this.Kl=(0xffn&t)<<this.Ql|this.Kl,this.Ql+=8n,this.Ql>32&&(this.Zl=t>>40n-this.Ql&0xffn)}let i=this.Kl;return e<64&&(i&=(1n<<BigInt(e))-1n),s.value=Number(i),s.bitsRead=e,s}skipBits(t){let e=BigInt(t);if(0===t);else if(this.Ql>e){if(this.Kl=t>31?0n:this.Kl>>e,this.Ql>32){const s=this.Ql-32n;this.Kl=this.Kl|this.Zl<<this.Ql-e-s,s>t&&(this.Zl=this.Zl>>e&0xffn)}this.Ql-=e}else if(this.Ql===e)this.Kl=0n,this.Ql=0n;else{for(e-=this.Ql,this.Ql=0n,this.Kl=0n;e>8;){if(-1===this.Kh.readByte()){e=0n;break}e-=8n}if(e>0){const t=BigInt(this.Kh.readByte());-1n===t||(this.Kl=t>>e,this.Ql=8n-e)}}}}class Zi{codebooks=[];timeDomainTransforms=[];floors=[];residues=[];mappings=[];modes=[]}class tn{static ilog(t){let e=0;for(;t>0;)++e,t>>=1;return e}static bitReverse(t,e=32){let s=BigInt(t);s=(s&BigInt(2863311530))>>1n|(s&BigInt(1431655765))<<1n,s=(s&BigInt(3435973836))>>2n|(s&BigInt(858993459))<<2n,s=(s&BigInt(4042322160))>>4n|(s&BigInt(252645135))<<4n,s=(s&BigInt(4278255360))>>8n|(s&BigInt(16711935))<<8n,s=(s>>16n|s<<16n)>>32n-BigInt(e);return Number(BigInt.asUintN(32,s))}static convertFromVorbisFloat32(t){const e=BigInt(t);let s=e&BigInt(2097151);const i=e&BigInt(2147483648),n=(e&BigInt(2145386496))>>21n;return 0n!==i&&(s=-s),Number(s)*Math.pow(2,Number(n)-788)}}class en{tu;constructor(t){this.tu=t}get(t){return this.tu[t]}}class sn{static instance=new sn;get(t){return t}}class nn{Ji;eu=0;su=null;iu=null;nu=0;ru;dimensions=0;entries=0;mapType=0;constructor(e,s){if(5653314!==e.readBits(24))throw new G(t.AlphaTabErrorType.Format,"Vorbis: Book header had invalid signature!");this.dimensions=e.readBits(16),this.entries=e.readBits(24),this.Ji=new Int32Array(this.entries),this.au(e,s),this.hu(e)}get(t,e){return this.ru[t*this.dimensions+e]}decodeScalar(t){let e=t.tryPeekBits(this.nu);if(0===e.bitsRead)return-1;let s=this.iu[e.value];if(null!=s)return t.skipBits(s.length),s.value;if(e=t.tryPeekBits(this.eu),null!==this.su)for(let i=0;i<this.su.length;i++){s=this.su[i];const n=e.value&s.mask;if(s.bits===n)return t.skipBits(s.length),s.value}return-1}au(e,s){let i,n,r=0;if(e.readBit()){let t=e.readBits(5)+1;for(let s=0;s<this.entries;){let i=e.readBits(tn.ilog(this.entries-s));for(;--i>=0;)this.Ji[s++]=t;++t}r=0,i=!1,n=t}else{n=-1,i=e.readBit();for(let t=0;t<this.entries;t++)!i||e.readBit()?(this.Ji[t]=e.readBits(5)+1,++r):this.Ji[t]=-1,this.Ji[t]>n&&(n=this.Ji[t])}if(this.eu=n,n>-1){let e,n=null;i&&r>=this.entries>>2&&(n=new Int32Array(this.entries),n.set(this.Ji.subarray(0,this.entries),0),i=!1),e=i?r:0;let a=null,h=null;if(i?0!==e&&(n=new Int32Array(e),h=new Int32Array(e),a=new Int32Array(e)):h=new Int32Array(this.entries),!this.ou(i,h,n,this.Ji,this.entries,a))throw new G(t.AlphaTabErrorType.Format,"Vorbis: Failed to compute codewords");const o=null==a?sn.instance:new en(a);s.generateTable(o,n??this.Ji,h),this.iu=s.prefixTree,this.nu=s.tableBits,this.su=s.overflowList}}ou(t,e,s,i,n,r){const a=new Uint32Array(32);let h=0,o=0;for(h=0;h<n&&!(i[h]>0);++h);if(h===n)return!0;this.cu(t,e,s,0,h,o++,i[h],r);for(let t=1;t<=i[h];++t)a[t]=1<<32-t;for(let c=h+1;c<n;++c){let n=i[c];if(n<=0)continue;for(;n>0&&0===a[n];)--n;if(0===n)return!1;const h=a[n];if(a[n]=0,this.cu(t,e,s,tn.bitReverse(h),c,o++,i[c],r),n!==i[c])for(let t=i[c];t>n;--t)a[t]=h+(1<<32-t)}return!0}cu(t,e,s,i,n,r,a,h){t?(e[r]=i,s[r]=a,h[r]=n):e[n]=i}hu(t){if(this.mapType=t.readBits(4),0===this.mapType)return;const e=tn.convertFromVorbisFloat32(t.readBits(32)),s=tn.convertFromVorbisFloat32(t.readBits(32)),i=t.readBits(4)+1,n=t.readBit();let r=this.entries*this.dimensions;const a=new Float32Array(r);1===this.mapType&&(r=this.lu());const h=new Uint32Array(r);for(let e=0;e<r;e++)h[e]=t.readBits(i);if(1===this.mapType)for(let t=0;t<this.entries;t++){let i=0,o=1;for(let c=0;c<this.dimensions;c++){const l=h[t/o%r|0]*s+e+i;a[t*this.dimensions+c]=l,n&&(i=l),o*=r}}else for(let t=0;t<this.entries;t++){let i=0,r=t*this.dimensions;for(let o=0;o<this.dimensions;o++){const c=h[r]*s+e+i;a[t*this.dimensions+o]=c,n&&(i=c),++r}}this.ru=a}lu(){let t=Math.floor(Math.exp(Math.log(this.entries)/this.dimensions));return Math.floor(Math.pow(t+1,this.dimensions))<=this.entries&&++t,t}}class rn{value=0;length=0;bits=0;mask=0}class an{static maxTableBits=10;tableBits=0;prefixTree=[];overflowList=null;generateTable(t,e,s){const i=new Array(e.length);let n=0;for(let r=0;r<i.length;r++){const a=new rn;a.value=t.get(r),a.length=e[r]<=0?99999:e[r],a.bits=s[r],a.mask=(1<<e[r])-1,i[r]=a,e[r]>0&&n<e[r]&&(n=e[r])}i.sort((t,e)=>{const s=t.length-e.length;return 0===s?t.bits-e.bits:s});const r=n>an.maxTableBits?an.maxTableBits:n,a=[];let h=null;for(let t=0;t<i.length&&i[t].length<99999;t++){const e=i[t].length;if(e>r)for(h=[];t<i.length&&i[t].length<99999;t++)h.push(i[t]);else{const s=1<<r-e,n=i[t];for(let t=0;t<s;t++){const s=t<<e|n.bits;for(;a.length<=s;)a.push(null);a[s]=n}}}for(;a.length<1<<r;)a.push(null);this.tableBits=r,this.prefixTree=a,this.overflowList=h}}class hn{constructor(t){t.readBits(16)}}class on{coeff;amp=0;get executeChannel(){return(this.forceEnergy||this.amp>0)&&!this.forceNoEnergy}forceEnergy=!1;forceNoEnergy=!1;constructor(t){this.coeff=t}}class cn{uu;du;fu;pu;bu;mu;gu;wu;yu;ku;constructor(e,s,i,n){if(this.uu=e.readBits(8),this.du=e.readBits(16),this.fu=e.readBits(16),this.pu=e.readBits(6),this.bu=e.readBits(8),this.gu=new Array(e.readBits(4)+1),this.uu<1||this.du<1||this.fu<1||0===this.gu.length)throw new G(t.AlphaTabErrorType.Format,"Vorbis: Invalid Floor0 Data");this.mu=(1<<this.pu)-1;for(let s=0;s<this.gu.length;s++){const i=e.readBits(8);if(i<0||i>=n.length)throw new G(t.AlphaTabErrorType.Format,"Vorbis: Invalid Floor0 Data");const r=n[i];if(0===r.mapType||r.dimensions<1)throw new G(t.AlphaTabErrorType.Format,"Vorbis: Invalid Floor0 Data");this.gu[s]=r}this.wu=tn.ilog(this.gu.length),this.ku=new Map([[s,this.Su(s/2)],[i,this.Su(i/2)]]),this.yu=new Map([[s,this.Bu(s/2)],[i,this.Bu(i/2)]])}Su(t){const e=this.fu/cn._u(this.du/2),s=new Int32Array(t+1);for(let i=0;i<t-1;i++)s[i]=Math.min(this.fu-1,Math.floor(cn._u(this.du/2/t*i)*e));return s[t]=-1,s}static _u(t){return 13.1*Math.atan(74e-5*t)+2.24*Math.atan(1.85e-8*t*t)+1e-4*t}Bu(t){const e=Math.PI/this.fu,s=new Float32Array(t);for(let i=0;i<t;i++)s[i]=2*Math.cos(e*i);return s}unpack(t,e,s){const i=new on(new Float32Array(this.uu+1));if(i.amp=t.readBits(this.pu),i.amp>0){i.amp=i.amp/this.mu*this.bu;const e=t.readBits(this.wu);if(e>=this.gu.length)return i.amp=0,i;const s=this.gu[e];for(let e=0;e<this.uu;){const n=s.decodeScalar(t);if(-1===n)return i.amp=0,i;for(let t=0;e<this.uu&&t<s.dimensions;t++,e++)i.coeff[e]=s.get(n,t)}let n=0;for(let t=0;t<this.uu;){for(let e=0;t<this.uu&&e<s.dimensions;t++,e++)i.coeff[t]+=n;n=i.coeff[t-1]}}return i}apply(t,e,s){const i=t,n=e/2;if(i.amp>0){const t=this.ku.get(e),r=this.yu.get(e);let a=0;for(a=0;a<this.uu;a++)i.coeff[a]=2*Math.cos(i.coeff[a]);for(a=0;a<n;){let e=0;const n=t[a];let h=.5,o=.5;const c=r[n];for(e=1;e<this.uu;e+=2)o*=c-i.coeff[e-1],h*=c-i.coeff[e];for(e===this.uu?(o*=c-i.coeff[e-1],h*=h*(4-c*c),o*=o):(h*=h*(2-c),o*=o*(2+c)),o=i.amp/Math.sqrt(h+o)-this.bu,o=Math.exp(.11512925*o),s[a]*=o;t[++a]===n;)s[a]*=o}}else s.fill(0,0,n)}}class ln{posts=new Int32Array(64);postCount=0;get executeChannel(){return(this.forceEnergy||this.postCount>0)&&!this.forceNoEnergy}forceEnergy=!1;forceNoEnergy=!1}class un{static Tu=[256,128,86,64];static xu=[8,7,7,6];Mu;vu;Nu;Pu;Cu;Eu;Fu;Au;Du;Lu;Wu;Ru;Iu;Ou;constructor(e,s){let i=-1;this.Mu=new Int32Array(e.readBits(5));for(let t=0;t<this.Mu.length;t++)this.Mu[t]=e.readBits(4),this.Mu[t]>i&&(i=this.Mu[t]);++i,this.vu=new Int32Array(i),this.Nu=new Int32Array(i),this.Ru=new Array(i),this.Cu=new Int32Array(i),this.Iu=new Array(i),this.Ou=new Array(i);for(let t=0;t<i;t++){this.vu[t]=e.readBits(3)+1,this.Nu[t]=e.readBits(2),this.Nu[t]>0&&(this.Cu[t]=e.readBits(8),this.Ru[t]=s[this.Cu[t]]),this.Iu[t]=new Array(1<<this.Nu[t]),this.Ou[t]=new Int32Array(this.Iu[t].length);for(let i=0;i<this.Iu[t].length;i++){const n=e.readBits(8)-1;n>=0&&(this.Iu[t][i]=s[n]),this.Ou[t][i]=n}}this.Du=e.readBits(2),this.Lu=un.Tu[this.Du],this.Wu=un.xu[this.Du],++this.Du;const n=e.readBits(4),r=[];r.push(0),r.push(1<<n);for(let t=0;t<this.Mu.length;t++){const s=this.Mu[t];for(let t=0;t<this.vu[s];t++)r.push(e.readBits(n))}this.Pu=new Int32Array(r),this.Fu=new Int32Array(r.length),this.Eu=new Int32Array(r.length),this.Au=new Int32Array(r.length),this.Au[0]=0,this.Au[1]=1;for(let t=2;t<this.Fu.length;t++){this.Fu[t]=0,this.Eu[t]=1,this.Au[t]=t;for(let e=2;e<t;e++){const s=this.Pu[e];s<this.Pu[t]?s>this.Pu[this.Fu[t]]&&(this.Fu[t]=e):s<this.Pu[this.Eu[t]]&&(this.Eu[t]=e)}}for(let e=0;e<this.Au.length-1;e++)for(let s=e+1;s<this.Au.length;s++){if(this.Pu[e]===this.Pu[s])throw new G(t.AlphaTabErrorType.Format,"Vorbis: Invalid Floor1 Data");if(this.Pu[this.Au[e]]>this.Pu[this.Au[s]]){const t=this.Au[e];this.Au[e]=this.Au[s],this.Au[s]=t}}}unpack(t,e,s){const i=new ln;if(t.readBit()){let e=2;i.posts[0]=t.readBits(this.Wu),i.posts[1]=t.readBits(this.Wu);for(let s=0;s<this.Mu.length;s++){const n=this.Mu[s],r=this.vu[n],a=this.Nu[n],h=(1<<a)-1;let o=0;if(a>0&&(o=this.Ru[n].decodeScalar(t),-1===o)){e=0;break}for(let c=0;c<r;c++){const r=this.Iu[n][o&h];if(o>>=a,null!=r&&(i.posts[e]=r.decodeScalar(t),-1===i.posts[e])){e=0,s=this.Mu.length;break}++e}}i.postCount=e}return i}apply(t,e,s){const i=t,n=e/2;if(i.postCount>0){const t=this.Gu(i);let e=0,r=i.posts[0]*this.Du;for(let a=1;a<i.postCount;a++){const h=this.Au[a];if(t[h]){const t=this.Pu[h],a=i.posts[h]*this.Du;e<n&&this.Vu(e,r,Math.min(t,n),a,s),e=t,r=a}if(e>=n)break}e<n&&this.Vu(e,r,n,r,s)}else s.fill(0,0,n)}Gu(t){const e=new Array(64);e.fill(!1),e[0]=!0,e[1]=!0;const s=new Int32Array(64);s[0]=t.posts[0],s[1]=t.posts[1];for(let i=2;i<t.postCount;i++){const n=this.Fu[i],r=this.Eu[i],a=this.$u(this.Pu[n],s[n],this.Pu[r],s[r],this.Pu[i]),h=t.posts[i],o=this.Lu-a,c=a;let l;l=o<c?2*o:2*c,0!==h?(e[n]=!0,e[r]=!0,e[i]=!0,s[i]=h>=l?o>c?h-c+a:a-h+o-1:h%2==1?a-(h+1)/2:a+h/2):(e[i]=!1,s[i]=a)}for(let e=0;e<t.postCount;e++)t.posts[e]=s[e];return e}$u(t,e,s,i,n){const r=i-e,a=s-t,h=Math.abs(r)*(n-t)/a|0;return r<0?e-h:e+h}Vu(t,e,s,i,n){const r=i-e,a=s-t;let h=Math.abs(r);const o=1-2*(r>>31&1),c=r/a|0;let l=t,u=e,d=-a;for(n[t]*=un.Hu[e],h-=Math.abs(c)*a;++l<s;)u+=c,d+=h,d>=0&&(d-=a,u+=o),n[l]*=un.Hu[u]}static Hu=new Float32Array([1.0649863e-7,1.1341951e-7,1.2079015e-7,1.2863978e-7,1.3699951e-7,1.4590251e-7,1.5538408e-7,1.6548181e-7,1.7623575e-7,1.8768855e-7,1.9988561e-7,2.128753e-7,2.2670913e-7,2.4144197e-7,2.5713223e-7,2.7384213e-7,2.9163793e-7,3.1059021e-7,3.3077411e-7,3.5226968e-7,3.7516214e-7,3.9954229e-7,4.255068e-7,4.5315863e-7,4.8260743e-7,5.1396998e-7,5.4737065e-7,5.8294187e-7,6.2082472e-7,6.6116941e-7,7.0413592e-7,7.4989464e-7,7.9862701e-7,8.505263e-7,9.0579828e-7,9.6466216e-7,10273513e-13,10941144e-13,11652161e-13,12409384e-13,13215816e-13,14074654e-13,14989305e-13,15963394e-13,17000785e-13,18105592e-13,19282195e-13,20535261e-13,21869758e-13,23290978e-13,24804557e-13,26416497e-13,2813319e-12,29961443e-13,31908506e-13,33982101e-13,36190449e-13,38542308e-13,41047004e-13,4371447e-12,46555282e-13,49580707e-13,5280274e-12,5623416e-12,59888572e-13,63780469e-13,67925283e-13,72339451e-13,77040476e-13,82047e-10,87378876e-13,93057248e-13,99104632e-13,10554501e-12,11240392e-12,11970856e-12,12748789e-12,13577278e-12,14459606e-12,15399272e-12,16400004e-12,17465768e-12,18600792e-12,19809576e-12,21096914e-12,22467911e-12,23928002e-12,25482978e-12,27139006e-12,28902651e-12,30780908e-12,32781225e-12,34911534e-12,37180282e-12,39596466e-12,42169667e-12,4491009e-11,47828601e-12,50936773e-12,54246931e-12,57772202e-12,61526565e-12,65524908e-12,69783085e-12,74317983e-12,79147585e-12,8429104e-11,89768747e-12,95602426e-12,.00010181521,.00010843174,.00011547824,.00012298267,.00013097477,.00013948625,.00014855085,.00015820453,.00016848555,.00017943469,.00019109536,.00020351382,.00021673929,.00023082423,.00024582449,.00026179955,.00027881276,.00029693158,.00031622787,.00033677814,.00035866388,.00038197188,.00040679456,.00043323036,.00046138411,.00049136745,.00052329927,.00055730621,.00059352311,.00063209358,.00067317058,716917e-9,.0007635063,.00081312324,.00086596457,.00092223983,.00098217216,.0010459992,.0011139742,.0011863665,.0012634633,.0013455702,.0014330129,.0015261382,.0016253153,.0017309374,.0018434235,.0019632195,.0020908006,.0022266726,.0023713743,.0025254795,.0026895994,.0028643847,.0030505286,.0032487691,.0034598925,.0036847358,.0039241906,.0041792066,.004450795,.0047400328,.0050480668,.0053761186,.0057254891,.0060975636,.0064938176,.0069158225,.0073652516,.0078438871,.0083536271,.0088964928,.009474637,.010090352,.01074608,.011444421,.012188144,.012980198,.013823725,.014722068,.015678791,.016697687,.017782797,.018938423,.020169149,.021479854,.022875735,.02436233,.025945531,.027631618,.029427276,.031339626,.033376252,.035545228,.037855157,.040315199,.042935108,.045725273,.048696758,.051861348,.055231591,.05882085,.062643361,.066714279,.071049749,.075666962,.080584227,.085821044,.091398179,.097337747,.1036633,.11039993,.11757434,.12521498,.13335215,.14201813,.15124727,.16107617,.1715438,.18269168,.19456402,.20720788,.22067342,.23501402,.25028656,.26655159,.28387361,.30232132,.32196786,.34289114,.36517414,.38890521,.41417847,.44109412,.4697589,.50028648,.53279791,.56742212,.6042964,.64356699,.68538959,.72993007,.77736504,.8278826,.88168307,.9389798,1])}class dn{floor;constructor(e,s,i,n){const r=e.readBits(16);switch(r){case 0:this.floor=new cn(e,s,i,n);break;case 1:this.floor=new un(e,n);break;default:throw new G(t.AlphaTabErrorType.Format,`Vorbis: Invalid Floor type: ${r}`)}}apply(t,e,s){this.floor.apply(t,e,s)}unpack(t,e,s){return this.floor.unpack(t,e,s)}}class fn{Uu;zu;Xu;ju;Ju;qu;gu;Yu;Ku;Qu;constructor(e,s,i){this.zu=e.readBits(24),this.Xu=e.readBits(24),this.ju=e.readBits(24)+1,this.Ju=e.readBits(6)+1,this.Yu=i[e.readBits(8)],this.Ku=new Int32Array(this.Ju);let n=0;for(let t=0;t<this.Ju;t++){const s=e.readBits(3);e.readBit()?this.Ku[t]=e.readBits(5)<<3|s:this.Ku[t]=s,n+=fn.Zu(this.Ku[t])}const r=new Int32Array(n);for(let s=0;s<n;s++)if(r[s]=e.readBits(8),0===i[r[s]].mapType)throw new G(t.AlphaTabErrorType.Format,"Vorbis: Invalid Residue 0");const a=this.Yu.entries;let h=this.Yu.dimensions,o=1;for(;h>0;){if(o*=this.Ju,o>a)throw new G(t.AlphaTabErrorType.Format,"Vorbis: Invalid Residue 0");--h}this.gu=new Array(this.Ju),n=0;let c,l=0;for(let t=0;t<this.Ju;t++)if(c=tn.ilog(this.Ku[t]),this.gu[t]=new Array(c),c>0){l=Math.max(l,c);for(let e=0;e<c;e++)(this.Ku[t]&1<<e)>0&&(this.gu[t][e]=i[r[n++]])}this.qu=l,this.Qu=new Array(o);for(let t=0;t<o;t++){let e=t,s=o/this.Ju|0;this.Qu[t]=new Int32Array(this.Yu.dimensions);for(let i=0;i<this.Yu.dimensions;i++){const n=e/s|0;e-=n*s,s=s/this.Ju|0,this.Qu[t][i]=n}}this.Uu=s}static Zu(t){let e=0;for(;0!==t;)e+=1&t,t>>=1;return e}decode(t,e,s,i){const n=(this.Xu<s/2?this.Xu:s/2)-this.zu;if(n>0&&-1!==e.indexOf(!1)){const e=n/this.ju,s=(e+this.Yu.dimensions-1)/this.Yu.dimensions|0,r=[];for(let t=0;t<this.Uu;t++)r.push(new Array(s));for(let s=0;s<this.qu;s++)for(let n=0,a=0;n<e;a++){if(0===s)for(let i=0;i<this.Uu;i++){const h=this.Yu.decodeScalar(t);if(!(h>=0&&h<this.Qu.length)){n=e,s=this.qu;break}r[i][a]=this.Qu[h]}for(let h=0;n<e&&h<this.Yu.dimensions;h++,n++){const o=this.zu+n*this.ju;for(let c=0;c<this.Uu;c++){const l=r[c][a][h];if(this.Ku[l]&1<<s){const r=this.gu[l][s];if(r&&this.writeVectors(r,t,i,c,o,this.ju)){n=e,s=this.qu;break}}}}}}}writeVectors(t,e,s,i,n,r){const a=s[i],h=r/t.dimensions,o=new Int32Array(h);for(let s=0;s<h;s++)if(o[s]=t.decodeScalar(e),-1===o[s])return!0;for(let e=0;e<t.dimensions;e++)for(let s=0;s<h;s++,n++)a[n]+=t.get(o[s],e);return!1}}class pn extends fn{writeVectors(t,e,s,i,n,r){const a=s[i];for(let s=0;s<r;){const i=t.decodeScalar(e);if(-1===i)return!0;for(let e=0;e<t.dimensions;s++,e++)a[n+s]+=t.get(i,e)}return!1}}class bn extends fn{td;constructor(t,e,s){super(t,1,s),this.td=e}decode(t,e,s,i){super.decode(t,e,s*this.td,i)}writeVectors(t,e,s,i,n,r){let a=0;n/=this.td;for(let i=0;i<r;){const r=t.decodeScalar(e);if(-1===r)return!0;for(let e=0;e<t.dimensions;e++,i++)s[a][n]+=t.get(r,e),++a===this.td&&(a=0,n++)}return!1}}class mn{residue;constructor(e,s,i){const n=e.readBits(16);switch(n){case 0:this.residue=new fn(e,s,i);break;case 1:this.residue=new pn(e,s,i);break;case 2:this.residue=new bn(e,s,i);break;default:throw new G(t.AlphaTabErrorType.Format,`Vorbis: Invalid Residue type: ${n}`)}}decode(t,e,s,i){this.residue.decode(t,e,s,i)}}class gn{ed;sd;nd;rd;ad;hd;od;constructor(e,s,i,n,r){if(0!==e.readBits(16))throw new G(t.AlphaTabErrorType.Format,"Vorbis: Invalid mapping type!");let a=1;e.readBit()&&(a+=e.readBits(4));let h=0;e.readBit()&&(h=e.readBits(8)+1);const o=tn.ilog(s-1);this.sd=new Int32Array(h),this.nd=new Int32Array(h);for(let i=0;i<h;i++){const n=e.readBits(o),r=e.readBits(o);if(n===r||n>s-1||r>s-1)throw new G(t.AlphaTabErrorType.Format,"Vorbis: Invalid magnitude or angle in mapping header!");this.sd[i]=r,this.nd[i]=n}if(0!==e.readBits(2))throw new G(t.AlphaTabErrorType.Format,"Vorbis: Reserved bits not 0 in mapping header.");const c=new Int32Array(s);if(a>1)for(let i=0;i<s;i++)if(c[i]=e.readBits(4),c[i]>a)throw new G(t.AlphaTabErrorType.Format,"Vorbis: Invalid channel mux submap index in mapping header!");this.rd=new Array(a),this.ad=new Array(a);for(let s=0;s<a;s++){e.skipBits(8);const r=e.readBits(8);if(r>=i.length)throw new G(t.AlphaTabErrorType.Format,"Vorbis: Invalid floor number in mapping header!");const a=e.readBits(8);if(a>=n.length)throw new G(t.AlphaTabErrorType.Format,"Vorbis: Invalid residue number in mapping header!");this.rd[s]=i[r],this.ad[s]=n[a]}this.hd=new Array(s),this.od=new Array(s);for(let t=0;t<s;t++)this.hd[t]=this.rd[c[t]],this.od[t]=this.ad[c[t]];this.ed=r}decodePacket(t,e,s){const i=e>>1,n=new Array(this.hd.length),r=new Array(this.hd.length);r.fill(!1);for(let a=0;a<this.hd.length;a++)n[a]=this.hd[a].unpack(t,e,a),r[a]=!n[a].executeChannel,s[a].fill(0,0,i);for(let t=0;t<this.sd.length;t++)(n[this.sd[t]].executeChannel||n[this.nd[t]].executeChannel)&&(n[this.sd[t]].forceEnergy=!0,n[this.nd[t]].forceEnergy=!0);for(let i=0;i<this.rd.length;i++){for(let t=0;t<this.hd.length;t++)this.rd[i]===this.hd[t]&&this.ad[i]===this.od[t]||(n[t].forceNoEnergy=!0);this.ad[i].decode(t,r,e,s)}for(let t=this.sd.length-1;t>=0;t--)if(n[this.sd[t]].executeChannel||n[this.nd[t]].executeChannel){const e=s[this.nd[t]],n=s[this.sd[t]];for(let t=0;t<i;t++){let s,i;const r=e[t],a=n[t];r>0?a>0?(s=r,i=r-a):(i=r,s=r+a):a>0?(s=r,i=r+a):(i=r,s=r-a),e[t]=s,n[t]=i}}for(let t=0;t<this.hd.length;t++)n[t].executeChannel?(this.hd[t].apply(n[t],e,s[t]),this.ed.reverse(s[t],e)):s[t].fill(0,i,2*i)}}class wn{packetStartIndex=0;packetTotalLength=0;packetValidLength=0}class yn{overlapInfo=new wn;windowIndex=0}class kn{samplePosition=null;constructor(t=null){this.samplePosition=t}}class Sn{static ld=1.57079632695;Uu;ud;dd;fd;pd;bd=null;constructor(e,s,i,n,r){if(this.Uu=s,this.ud=e.readBit(),0!==e.readBits(32))throw new G(t.AlphaTabErrorType.Format,"Vorbis: Mode header had invalid window or transform type!");const a=e.readBits(8);if(a>=r.length)throw new G(t.AlphaTabErrorType.Format,"Vorbis: Mode header had invalid mapping index!");this.fd=r[a],this.ud?(this.dd=n,this.pd=[Sn.md(i,n,i),Sn.md(n,n,i),Sn.md(i,n,n),Sn.md(n,n,n)],this.bd=[Sn.gd(i,n,i),Sn.gd(n,n,i),Sn.gd(i,n,n),Sn.gd(n,n,n)]):(this.dd=i,this.pd=[Sn.md(i,i,i)])}decode(t,e){const s=this.wd(t);this.fd.decodePacket(t,this.dd,e);const i=this.pd[s.windowIndex];for(let t=0;t<this.dd;t++)for(let s=0;s<this.Uu;s++)e[s][t]*=i[t];return s.overlapInfo}wd(t){const e=new yn;if(this.ud){const s=t.readBit(),i=t.readBit();e.windowIndex=(s?1:0)+(i?2:0);const n=this.bd[e.windowIndex];e.overlapInfo.packetStartIndex=n.packetStartIndex,e.overlapInfo.packetValidLength=n.packetValidLength,e.overlapInfo.packetTotalLength=n.packetTotalLength}else e.windowIndex=0,e.overlapInfo.packetStartIndex=0,e.overlapInfo.packetValidLength=this.dd/2,e.overlapInfo.packetTotalLength=this.dd;return e}static md(t,e,s){const i=new Float32Array(e),n=t/2,r=s/2,a=e/4-n/2,h=e-e/4-r/2;for(let t=0;t<n;t++){let e=Math.sin((t+.5)/n*Sn.ld);e*=e,i[a+t]=Math.sin(e*Sn.ld)}for(let t=a+n;t<h;t++)i[t]=1;for(let t=0;t<r;t++){let e=Math.sin((r-t-.5)/r*Sn.ld);e*=e,i[h+t]=Math.sin(e*Sn.ld)}return i}static gd(t,e,s){const i=s/4,n=e/4-t/4,r=e/4*3+i,a=r-2*i,h=new wn;return h.packetStartIndex=n,h.packetValidLength=a,h.packetTotalLength=r,h}}class Bn{static yd=3.141592653589793;kd;Sd;Bd;_d;Td;xd;Md;vd;Nd;constructor(t){this.kd=t,this.Sd=t>>1,this.Bd=this.Sd>>1,this._d=this.Bd>>1,this.Td=tn.ilog(t)-1,this.xd=new Float32Array(this.Sd),this.Md=new Float32Array(this.Sd),this.vd=new Float32Array(this.Bd);let e=0,s=0;for(;e<this.Bd;++e,s+=2)this.xd[s]=Math.cos(4*e*Bn.yd/t),this.xd[s+1]=-Math.sin(4*e*Bn.yd/t),this.Md[s]=.5*Math.cos((s+1)*Bn.yd/t/2),this.Md[s+1]=.5*Math.sin((s+1)*Bn.yd/t/2);for(e=0,s=0;e<this._d;++e,s+=2)this.vd[s]=Math.cos(2*(s+1)*Bn.yd/t),this.vd[s+1]=-Math.sin(2*(s+1)*Bn.yd/t);this.Nd=new Uint16Array(this._d);for(let t=0;t<this._d;++t)this.Nd[t]=de.int32ToUint16(tn.bitReverse(t,this.Td-3)<<2)}calcReverse(t){let e,s;const i=new Float32Array(this.Sd);{let e=this.Sd-2,s=0,n=0;const r=this.Sd;for(;n!==r;)i[e+1]=t[n]*this.xd[s]-t[n+2]*this.xd[s+1],i[e]=t[n]*this.xd[s+1]+t[n+2]*this.xd[s],e-=2,s+=2,n+=4;for(n=this.Sd-3;e>=0;)i[e+1]=-t[n+2]*this.xd[s]- -t[n]*this.xd[s+1],i[e]=-t[n+2]*this.xd[s+1]+-t[n]*this.xd[s],e-=2,s+=2,n-=4}e=t,s=i;{let t=this.Sd-8,i=this.Bd,n=0,r=this.Bd,a=0;for(;t>=0;){let h,o;o=s[i+1]-s[n+1],h=s[i]-s[n],e[r+1]=s[i+1]+s[n+1],e[r]=s[i]+s[n],e[a+1]=o*this.xd[t+4]-h*this.xd[t+5],e[a]=h*this.xd[t+4]+o*this.xd[t+5],o=s[i+3]-s[n+3],h=s[i+2]-s[n+2],e[r+3]=s[i+3]+s[n+3],e[r+2]=s[i+2]+s[n+2],e[a+3]=o*this.xd[t]-h*this.xd[t+1],e[a+2]=h*this.xd[t]+o*this.xd[t+1],t-=8,r+=4,a+=4,i+=4,n+=4}}this.Pd(this.kd>>4,e,this.Sd-1-0*this.Bd,-this._d),this.Pd(this.kd>>4,e,this.Sd-1-1*this.Bd,-this._d),this.Cd(this.kd>>5,e,this.Sd-1-0*this._d,-(this.kd>>4),16),this.Cd(this.kd>>5,e,this.Sd-1-1*this._d,-(this.kd>>4),16),this.Cd(this.kd>>5,e,this.Sd-1-2*this._d,-(this.kd>>4),16),this.Cd(this.kd>>5,e,this.Sd-1-3*this._d,-(this.kd>>4),16);let n=2;for(;n<this.Td-3>>1;++n){const t=this.kd>>n+2,s=t>>1,i=1<<n+1;for(let r=0;r<i;++r)this.Cd(this.kd>>n+4,e,this.Sd-1-t*r,-s,1<<n+3)}for(;n<this.Td-6;++n){const t=this.kd>>n+2,s=1<<n+3,i=t>>1,r=this.kd>>n+6,a=1<<n+1;let h=this.Sd-1,o=0;for(let n=r;n>0;--n)this.Ed(a,e,h,-i,o,s,t),o+=4*s,h-=8}this.Fd(this.kd>>5,e,this.Sd-1,this.kd);{let t=0,i=this.Bd-4,n=this.Sd-4;for(;i>=0;){let r;r=this.Nd[t],s[n+3]=e[r],s[n+2]=e[r+1],s[i+3]=e[r+2],s[i+2]=e[r+3],r=this.Nd[t+1],s[n+1]=e[r],s[n]=e[r+1],s[i+1]=e[r+2],s[i]=e[r+3],i-=4,n-=4,t+=2}}{let t=0,e=0,i=this.Sd-4;for(;e<i;){let n,r,a,h,o,c;n=s[e]-s[i+2],r=s[e+1]+s[i+3],a=this.vd[t+1]*n+this.vd[t]*r,h=this.vd[t+1]*r-this.vd[t]*n,o=s[e]+s[i+2],c=s[e+1]-s[i+3],s[e]=o+a,s[e+1]=c+h,s[i+2]=o-a,s[i+3]=h-c,n=s[e+2]-s[i],r=s[e+3]+s[i+1],a=this.vd[t+3]*n+this.vd[t+2]*r,h=this.vd[t+3]*r-this.vd[t+2]*n,o=s[e+2]+s[i],c=s[e+3]-s[i+1],s[e+2]=o+a,s[e+3]=c+h,s[i]=o-a,s[i+1]=h-c,t+=4,e+=4,i-=4}}{let e=this.Sd-8,s=this.Sd-8,n=0,r=this.Sd-4,a=this.Sd,h=this.kd-4;for(;s>=0;){let o,c,l,u;u=i[s+6]*this.Md[e+7]-i[s+7]*this.Md[e+6],l=-i[s+6]*this.Md[e+6]-i[s+7]*this.Md[e+7],t[n]=u,t[r+3]=-u,t[a]=l,t[h+3]=l,c=i[s+4]*this.Md[e+5]-i[s+5]*this.Md[e+4],o=-i[s+4]*this.Md[e+4]-i[s+5]*this.Md[e+5],t[n+1]=c,t[r+2]=-c,t[a+1]=o,t[h+2]=o,u=i[s+2]*this.Md[e+3]-i[s+3]*this.Md[e+2],l=-i[s+2]*this.Md[e+2]-i[s+3]*this.Md[e+3],t[n+2]=u,t[r+1]=-u,t[a+2]=l,t[h+1]=l,c=i[s]*this.Md[e+1]-i[s+1]*this.Md[e],o=-i[s]*this.Md[e]-i[s+1]*this.Md[e+1],t[n+3]=c,t[r]=-c,t[a+3]=o,t[h]=o,e-=8,s-=8,n+=4,a+=4,r-=4,h-=4}}}Cd(t,e,s,i,n){let r,a,h=s,o=h+i,c=0;for(let s=t>>2;s>0;--s)r=e[h]-e[o],a=e[h-1]-e[o-1],e[h]+=e[o],e[h-1]+=e[o-1],e[o]=r*this.xd[c]-a*this.xd[c+1],e[o-1]=a*this.xd[c]+r*this.xd[c+1],c+=n,r=e[h-2]-e[o-2],a=e[h-3]-e[o-3],e[h-2]+=e[o-2],e[h-3]+=e[o-3],e[o-2]=r*this.xd[c]-a*this.xd[c+1],e[o-3]=a*this.xd[c]+r*this.xd[c+1],c+=n,r=e[h-4]-e[o-4],a=e[h-5]-e[o-5],e[h-4]+=e[o-4],e[h-5]+=e[o-5],e[o-4]=r*this.xd[c]-a*this.xd[c+1],e[o-5]=a*this.xd[c]+r*this.xd[c+1],c+=n,r=e[h-6]-e[o-6],a=e[h-7]-e[o-7],e[h-6]+=e[o-6],e[h-7]+=e[o-7],e[o-6]=r*this.xd[c]-a*this.xd[c+1],e[o-7]=a*this.xd[c]+r*this.xd[c+1],c+=n,h-=8,o-=8}Pd(t,e,s,i){let n=s,r=n+i,a=0;for(let s=t>>2;s>0;--s){let t,s;t=e[n]-e[r],s=e[n-1]-e[r-1],e[n]+=e[r],e[n-1]+=e[r-1],e[r]=t*this.xd[a]-s*this.xd[a+1],e[r-1]=s*this.xd[a]+t*this.xd[a+1],a+=8,t=e[n-2]-e[r-2],s=e[n-3]-e[r-3],e[n-2]+=e[r-2],e[n-3]+=e[r-3],e[r-2]=t*this.xd[a]-s*this.xd[a+1],e[r-3]=s*this.xd[a]+t*this.xd[a+1],a+=8,t=e[n-4]-e[r-4],s=e[n-5]-e[r-5],e[n-4]+=e[r-4],e[n-5]+=e[r-5],e[r-4]=t*this.xd[a]-s*this.xd[a+1],e[r-5]=s*this.xd[a]+t*this.xd[a+1],a+=8,t=e[n-6]-e[r-6],s=e[n-7]-e[r-7],e[n-6]+=e[r-6],e[n-7]+=e[r-7],e[r-6]=t*this.xd[a]-s*this.xd[a+1],e[r-7]=s*this.xd[a]+t*this.xd[a+1],a+=8,n-=8,r-=8}}Ed(t,e,s,i,n,r,a){const h=this.xd[n],o=this.xd[n+1],c=this.xd[n+r],l=this.xd[n+r+1],u=this.xd[n+2*r],d=this.xd[n+2*r+1],f=this.xd[n+3*r],p=this.xd[n+3*r+1];let b,m,g=s,w=g+i;for(let s=t;s>0;--s)b=e[g]-e[w],m=e[g-1]-e[w-1],e[g]+=e[w],e[g-1]+=e[w-1],e[w]=b*h-m*o,e[w-1]=m*h+b*o,b=e[g-2]-e[w-2],m=e[g-3]-e[w-3],e[g-2]+=e[w-2],e[g-3]+=e[w-3],e[w-2]=b*c-m*l,e[w-3]=m*c+b*l,b=e[g-4]-e[w-4],m=e[g-5]-e[w-5],e[g-4]+=e[w-4],e[g-5]+=e[w-5],e[w-4]=b*u-m*d,e[w-5]=m*u+b*d,b=e[g-6]-e[w-6],m=e[g-7]-e[w-7],e[g-6]+=e[w-6],e[g-7]+=e[w-7],e[w-6]=b*f-m*p,e[w-7]=m*f+b*p,g-=a,w-=a}Fd(t,e,s,i){const n=i>>3,r=this.xd[n];let a=s;const h=a-16*t;for(;a>h;){let t,s;t=e[a]-e[a-8],s=e[a-1]-e[a-9],e[a]+=e[a-8],e[a-1]+=e[a-9],e[a-8]=t,e[a-9]=s,t=e[a-2]-e[a-10],s=e[a-3]-e[a-11],e[a-2]+=e[a-10],e[a-3]+=e[a-11],e[a-10]=(t+s)*r,e[a-11]=(s-t)*r,t=e[a-12]-e[a-4],s=e[a-5]-e[a-13],e[a-4]+=e[a-12],e[a-5]+=e[a-13],e[a-12]=s,e[a-13]=t,t=e[a-14]-e[a-6],s=e[a-7]-e[a-15],e[a-6]+=e[a-14],e[a-7]+=e[a-15],e[a-14]=(t+s)*r,e[a-15]=(t-s)*r,this.Ad(e,a),this.Ad(e,a-8),a-=16}}Ad(t,e){const s=t[e]-t[e-4],i=t[e]+t[e-4],n=t[e-2]+t[e-6],r=t[e-2]-t[e-6];t[e]=i+n,t[e-2]=i-n;const a=t[e-3]-t[e-7];t[e-4]=s+a,t[e-6]=s-a;const h=t[e-1]-t[e-5],o=t[e-1]+t[e-5],c=t[e-3]+t[e-7];t[e-1]=o+c,t[e-3]=o-c,t[e-5]=h-r,t[e-7]=h+r}}class _n{Dd=new Map;reverse(t,e){let s;this.Dd.has(e)?s=this.Dd.get(e):(s=new Bn(e),this.Dd.set(e,s)),s.calcReverse(t)}}class Tn{Ld;Wd;Rd;Id=0;Od;Gd;Vd;$d;Hd;Ud;zd;Xd;jd;constructor(t,e,s){this.Ld=t,this.Wd=e,this.Rd=s,this.Ud=0,this.Gd=null,this.Vd=0,this.$d=0,this.Hd=0,this.Od=null,this.Xd=!1,this.zd=!1,this.jd=tn.ilog(e.modes.length-1)}decode(){let t=new Float32Array(this.Rd[this.Rd.length-1].granulePosition*this.Ld.audioChannels);const e=new Float32Array(.2*this.Ld.audioSampleRate*this.Ld.audioChannels);let s=0,i=0;for(;s=this.read(e,0,e.length),0!==s;){if(i+s>=t.length){const s=new Float32Array(t.length+e.length);s.set(t,0),t=s}t.set(e.subarray(0,s),i),i+=s}return t.subarray(0,i)}read(t,e,s){if(0===s)return 0;let i=e;const n=e+s;for(;i<n;){if(this.Vd===this.$d){if(this.Xd){this.Od=null,this.Gd=null;break}const t=this.Jd((i-e)/this.Ld.audioChannels);null===t&&(this.$d=this.Hd),null===t||null===t.samplePosition||this.zd||(this.zd=!0,this.Ud=t.samplePosition-(this.$d-this.Vd)-(i-e)/this.Ld.audioChannels)}const s=Math.min((n-i)/this.Ld.audioChannels,this.$d-this.Vd);s>0&&(i+=this.qd(t,i,s))}return s=i-e,this.Ud+=s/this.Ld.audioChannels,s}qd(t,e,s){let i=e;for(;s>0;this.Vd++,s--)for(let e=0;e<this.Ld.audioChannels;e++)t[i++]=this.Gd[e][this.Vd];return i-e}Jd(t){const e=this.Yd();if(this.Xd=this.Xd||e.isEndOfStream,null==e.curPacket)return null;if(null!==e.samplePosition&&e.isEndOfStream){const s=this.Ud+t+e.validLen-e.startIndex,i=e.samplePosition-s;i<0&&(e.validLen+=i,e.validLen<0&&(e.validLen=0))}return this.$d>0?(Tn.Kd(this.Gd,e.curPacket,this.Vd,this.Hd,e.startIndex,this.Ld.audioChannels),this.Vd=e.startIndex):null==this.Gd&&(this.Vd=e.validLen),this.Od=this.Gd,this.$d=e.validLen,this.Hd=e.totalLen,this.Gd=e.curPacket,new kn(e.samplePosition)}static Kd(t,e,s,i,n,r){for(;s<i;s++,n++)for(let i=0;i<r;i++)e[i][n]+=t[i][s]}Yd(){const t=new xn;let e=null;if(this.Id>=this.Rd.length)t.isEndOfStream=!0;else{e=this.Rd[this.Id++];const s=new Qi(Ae.fromBuffer(e.packetData));if(t.isEndOfStream=e.isEndOfStream,!s.readBit()){const i=this.Wd.modes[s.readBits(this.jd)];if(null==this.Od){this.Od=new Array(this.Ld.audioChannels);for(let t=0;t<this.Ld.audioChannels;t++)this.Od[t]=new Float32Array(this.Ld.blocksize1)}const n=i.decode(s,this.Od);return t.startIndex=n.packetStartIndex,t.validLen=n.packetValidLength,t.totalLen=n.packetTotalLength,t.samplePosition=e.granulePosition,t.curPacket=this.Od,t}}return t}}class xn{curPacket=null;startIndex=0;validLen=0;totalLen=0;isEndOfStream=!1;samplePosition=null}!function(t){t[t.IdentificationHeader=1]="IdentificationHeader",t[t.Comment=3]="Comment",t[t.SetupHeader=5]="SetupHeader"}(ts||(ts={}));class Mn{static vorbisHeaderMarker=new Uint8Array(["v".charCodeAt(0),"o".charCodeAt(0),"r".charCodeAt(0),"b".charCodeAt(0),"i".charCodeAt(0),"s".charCodeAt(0)]);Rd;Id;constructor(t){this.Id=-1,this.Rd=t}read(){let t;for(;;){if(t=this.Qd(),null==t)return null;if(t.isBeginningOfStream){const e=this.Zd(t);if(null!=e)return e}}}Qd(){return this.Id++,this.Id<this.Rd.length?this.Rd[this.Id]:null}Zd(t){const e=new Yi;if(!this.tf(e,t))return null;if(!this.ef(this.Qd()))return null;const s=new Zi;if(!this.sf(e,s,this.Qd()))return null;const i=[];let n;for(;n=this.Qd(),null!=n&&(i.push(n),!n.isEndOfStream););const r=new Tn(e,s,i);return e.samples=r.decode(),e}if(t,e){const s=new Uint8Array(7);if(e.read(s,0,s.length),s[0]!==t)return!1;for(let t=0;t<Mn.vorbisHeaderMarker.length;t++)if(s[1+t]!==Mn.vorbisHeaderMarker[t])return!1;return!0}nf(t,e){const s=e.readBytes(7);if(s[0]!==t)return!1;for(let t=0;t<Mn.vorbisHeaderMarker.length;t++)if(s[1+t]!==Mn.vorbisHeaderMarker[t])return!1;return!0}tf(t,e){const s=Ae.fromBuffer(e.packetData);if(!this.if(ts.IdentificationHeader,s))return!1;if(0!==fe.readUInt32LE(s))return!1;if(t.audioChannels=s.readByte(),t.audioSampleRate=fe.readUInt32LE(s),t.audioChannels<=0||t.audioSampleRate<=0)return!1;t.bitrateMaximum=fe.readInt32LE(s),t.bitrateNominal=fe.readInt32LE(s),t.bitrateMinimum=fe.readInt32LE(s);const i=s.readByte();if(t.blocksize0=1<<(15&i),t.blocksize1=1<<(i>>4),t.blocksize0>t.blocksize1||!Mn.rf(t.blocksize0)||!Mn.rf(t.blocksize0))return!1;return 0!==s.readByte()}static rf(t){switch(t){case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:return!0;default:return!1}}ef(t){if(null==t)return!1;const e=Ae.fromBuffer(t.packetData);if(!this.if(ts.Comment,e))return!1;const s=fe.readUInt32LE(e);e.skip(s);const i=fe.readUInt32LE(e);for(let t=0;t<i;t++){const t=fe.readUInt32LE(e);e.skip(t)}return 0!==e.readByte()}sf(t,e,s){if(null==s)return!1;const i=new Qi(Ae.fromBuffer(s.packetData)),n=new _n,r=new an;if(!this.nf(ts.SetupHeader,i))return!1;let a=i.readByte()+1;for(let t=0;t<a;t++)e.codebooks.push(new nn(i,r));a=i.readBits(6)+1;for(let t=0;t<a;t++)e.timeDomainTransforms.push(new hn(i));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.floors.push(new dn(i,t.blocksize0,t.blocksize1,e.codebooks));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.residues.push(new mn(i,t.audioChannels,e.codebooks));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.mappings.push(new gn(i,t.audioChannels,e.floors,e.residues,n));a=i.readBits(6)+1;for(let s=0;s<a;s++)e.modes.push(new Sn(i,t.audioChannels,t.blocksize0,t.blocksize1,e.mappings));return!!i.readBit()}}class vn{streams=[];constructor(t){const e=new qi(t).read(),s=new Mn(e);for(;;){const t=s.read();if(null==t)break;this.streams.push(t)}}}class Nn{phdrs=[];pbags=[];pmods=[];pgens=[];insts=[];ibags=[];imods=[];igens=[];sHdrs=[];sampleData=new Uint8Array(0);af=new Map;decodeSamples(t,e,s){const i=`${t}_${e}_${s}`;if(!this.af.has(i)){let n;const r=this.sampleData.slice(t,e);if(s){n=new vn(Ae.fromBuffer(r)).streams[0].samples}else{const t=new DataView(r.buffer,r.byteOffset,r.length);n=new Float32Array(r.length/2);for(let e=0;e<n.length;e++)n[e]=t.getInt16(2*e,!0)/32767}return this.af.set(i,n),n}return this.af.get(i)}load(t){const e=new ji,s=new ji;if(!ji.load(null,e,t)||"sfbk"!==e.id)throw new ke("Soundfont is not a valid Soundfont2 file");for(;ji.load(e,s,t);){const e=new ji;if("pdta"===s.id)for(;ji.load(s,e,t);)switch(e.id){case"phdr":for(let s=0,i=e.size/Ln.SizeInFile|0;s<i;s++)this.phdrs.push(new Ln(t));break;case"pbag":for(let s=0,i=e.size/An.SizeInFile|0;s<i;s++)this.pbags.push(new An(t));break;case"pmod":for(let s=0,i=e.size/Wn.SizeInFile|0;s<i;s++)this.pmods.push(new Wn(t));break;case"pgen":for(let s=0,i=e.size/Dn.SizeInFile|0;s<i;s++)this.pgens.push(new Dn(t));break;case"inst":for(let s=0,i=e.size/Fn.SizeInFile|0;s<i;s++)this.insts.push(new Fn(t));break;case"ibag":for(let s=0,i=e.size/Pn.SizeInFile|0;s<i;s++)this.ibags.push(new Pn(t));break;case"imod":for(let s=0,i=e.size/Cn.SizeInFile|0;s<i;s++)this.imods.push(new Cn(t));break;case"igen":for(let s=0,i=e.size/En.SizeInFile|0;s<i;s++)this.igens.push(new En(t));break;case"shdr":for(let s=0,i=e.size/Rn.SizeInFile|0;s<i;s++)this.sHdrs.push(new Rn(t));break;default:t.position+=e.size}else if("sdta"===s.id)for(;ji.load(s,e,t);)if("smpl"===e.id)this.sampleData=new Uint8Array(e.size),t.read(this.sampleData,0,e.size);else t.position+=e.size;else t.position+=s.size}}}class Pn{static SizeInFile=4;instGenNdx;instModNdx;constructor(t){this.instGenNdx=fe.readUInt16LE(t),this.instModNdx=fe.readUInt16LE(t)}}class Cn{static SizeInFile=10;modSrcOper;modDestOper;modAmount;modAmtSrcOper;modTransOper;constructor(t){this.modSrcOper=fe.readUInt16LE(t),this.modDestOper=fe.readUInt16LE(t),this.modAmount=fe.readInt16LE(t),this.modAmtSrcOper=fe.readUInt16LE(t),this.modTransOper=fe.readUInt16LE(t)}}class En{static SizeInFile=4;genOper;genAmount;constructor(t){this.genOper=fe.readUInt16LE(t),this.genAmount=new In(t)}}class Fn{static SizeInFile=22;instName;instBagNdx;constructor(t){this.instName=fe.read8BitStringLength(t,20),this.instBagNdx=fe.readUInt16LE(t)}}class An{static SizeInFile=4;genNdx;modNdx;constructor(t){this.genNdx=fe.readUInt16LE(t),this.modNdx=fe.readUInt16LE(t)}}class Dn{static SizeInFile=4;static GenInstrument=41;static GenKeyRange=43;static GenVelRange=44;static GenSampleId=53;genOper;genAmount;constructor(t){this.genOper=fe.readUInt16LE(t),this.genAmount=new In(t)}}class Ln{static SizeInFile=38;presetName;preset;bank;presetBagNdx;library;genre;morphology;constructor(t){this.presetName=fe.read8BitStringLength(t,20),this.preset=fe.readUInt16LE(t),this.bank=fe.readUInt16LE(t),this.presetBagNdx=fe.readUInt16LE(t),this.library=fe.readUInt32LE(t),this.genre=fe.readUInt32LE(t),this.morphology=fe.readUInt32LE(t)}}class Wn{static SizeInFile=10;modSrcOper;modDestOper;modAmount;modAmtSrcOper;modTransOper;constructor(t){this.modSrcOper=fe.readUInt16LE(t),this.modDestOper=fe.readUInt16LE(t),this.modAmount=fe.readUInt16LE(t),this.modAmtSrcOper=fe.readUInt16LE(t),this.modTransOper=fe.readUInt16LE(t)}}class Rn{static SizeInFile=46;sampleName;start;end;startLoop;endLoop;sampleRate;originalPitch;pitchCorrection;sampleLink;sampleType;constructor(t){this.sampleName=fe.read8BitStringLength(t,20),this.start=fe.readUInt32LE(t),this.end=fe.readUInt32LE(t),this.startLoop=fe.readUInt32LE(t),this.endLoop=fe.readUInt32LE(t),this.sampleRate=fe.readUInt32LE(t),this.originalPitch=t.readByte(),this.pitchCorrection=fe.readSInt8(t),this.sampleLink=fe.readUInt16LE(t),this.sampleType=fe.readUInt16LE(t)}}class In{wordAmount;get shortAmount(){return de.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return 255&this.wordAmount}get highByteAmount(){return(65280&this.wordAmount)>>8&255}constructor(t){this.wordAmount=fe.readUInt16LE(t)}}class On{presetIndex=0;bank=0;pitchWheel=0;perNotePitchWheel=new Map;midiPan=0;midiVolume=0;midiExpression=0;midiRpn=0;midiData=0;panOffset=0;gainDb=0;pitchRange=0;tuning=0;mixVolume=0;mute=!1;solo=!1}class Gn{activeChannel=0;channelList=[];setupVoice(t,e){const s=this.channelList[this.activeChannel],i=e.region.pan+s.panOffset;e.playingChannel=this.activeChannel,e.mixVolume=s.mixVolume,e.noteGainDb+=s.gainDb,e.updatePitchRatio(s,t.outSampleRate),i<=-.5?(e.panFactorLeft=1,e.panFactorRight=0):i>=.5?(e.panFactorLeft=0,e.panFactorRight=1):(e.panFactorLeft=Math.sqrt(.5-i),e.panFactorRight=Math.sqrt(.5+i))}}!function(t){t[t.None=0]="None",t[t.Continuous=1]="Continuous",t[t.Sustain=2]="Sustain"}(es||(es={})),function(t){t[t.StereoInterleaved=0]="StereoInterleaved",t[t.StereoUnweaved=1]="StereoUnweaved",t[t.Mono=2]="Mono"}(ss||(ss={}));class Vn{name="";presetNumber=0;bank=0;regions=null}class $n{static timecents2Secs(t){return Math.pow(2,t/1200)}static decibelsToGain(t){return t>-100?Math.pow(10,.05*t):0}static gainToDecibels(t){return t<=1e-5?-100:20*Math.log10(t)}static cents2Hertz(t){return 8.176*Math.pow(2,t/1200)}}class Hn{delay=0;attack=0;hold=0;decay=0;sustain=0;release=0;keynumToHold=0;keynumToDecay=0;constructor(t){t&&(this.delay=t.delay,this.attack=t.attack,this.hold=t.hold,this.decay=t.decay,this.sustain=t.sustain,this.release=t.release,this.keynumToHold=t.keynumToHold,this.keynumToDecay=t.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(t){this.delay=this.delay<-11950?0:$n.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:$n.timecents2Secs(this.attack),this.release=this.release<-11950?0:$n.timecents2Secs(this.release),0===this.keynumToHold&&(this.hold=this.hold<-11950?0:$n.timecents2Secs(this.hold)),0===this.keynumToDecay&&(this.decay=this.decay<-11950?0:$n.timecents2Secs(this.decay)),this.sustain<0?this.sustain=0:this.sustain=t?$n.decibelsToGain(-this.sustain/10):1-this.sustain/1e3}}!function(t){t[t.StartAddrsOffset=0]="StartAddrsOffset",t[t.EndAddrsOffset=1]="EndAddrsOffset",t[t.StartloopAddrsOffset=2]="StartloopAddrsOffset",t[t.EndloopAddrsOffset=3]="EndloopAddrsOffset",t[t.StartAddrsCoarseOffset=4]="StartAddrsCoarseOffset",t[t.ModLfoToPitch=5]="ModLfoToPitch",t[t.VibLfoToPitch=6]="VibLfoToPitch",t[t.ModEnvToPitch=7]="ModEnvToPitch",t[t.InitialFilterFc=8]="InitialFilterFc",t[t.InitialFilterQ=9]="InitialFilterQ",t[t.ModLfoToFilterFc=10]="ModLfoToFilterFc",t[t.ModEnvToFilterFc=11]="ModEnvToFilterFc",t[t.EndAddrsCoarseOffset=12]="EndAddrsCoarseOffset",t[t.ModLfoToVolume=13]="ModLfoToVolume",t[t.Unused1=14]="Unused1",t[t.ChorusEffectsSend=15]="ChorusEffectsSend",t[t.ReverbEffectsSend=16]="ReverbEffectsSend",t[t.Pan=17]="Pan",t[t.Unused2=18]="Unused2",t[t.Unused3=19]="Unused3",t[t.Unused4=20]="Unused4",t[t.DelayModLFO=21]="DelayModLFO",t[t.FreqModLFO=22]="FreqModLFO",t[t.DelayVibLFO=23]="DelayVibLFO",t[t.FreqVibLFO=24]="FreqVibLFO",t[t.DelayModEnv=25]="DelayModEnv",t[t.AttackModEnv=26]="AttackModEnv",t[t.HoldModEnv=27]="HoldModEnv",t[t.DecayModEnv=28]="DecayModEnv",t[t.SustainModEnv=29]="SustainModEnv",t[t.ReleaseModEnv=30]="ReleaseModEnv",t[t.KeynumToModEnvHold=31]="KeynumToModEnvHold",t[t.KeynumToModEnvDecay=32]="KeynumToModEnvDecay",t[t.DelayVolEnv=33]="DelayVolEnv",t[t.AttackVolEnv=34]="AttackVolEnv",t[t.HoldVolEnv=35]="HoldVolEnv",t[t.DecayVolEnv=36]="DecayVolEnv",t[t.SustainVolEnv=37]="SustainVolEnv",t[t.ReleaseVolEnv=38]="ReleaseVolEnv",t[t.KeynumToVolEnvHold=39]="KeynumToVolEnvHold",t[t.KeynumToVolEnvDecay=40]="KeynumToVolEnvDecay",t[t.Instrument=41]="Instrument",t[t.Reserved1=42]="Reserved1",t[t.KeyRange=43]="KeyRange",t[t.VelRange=44]="VelRange",t[t.StartloopAddrsCoarseOffset=45]="StartloopAddrsCoarseOffset",t[t.Keynum=46]="Keynum",t[t.Velocity=47]="Velocity",t[t.InitialAttenuation=48]="InitialAttenuation",t[t.Reserved2=49]="Reserved2",t[t.EndloopAddrsCoarseOffset=50]="EndloopAddrsCoarseOffset",t[t.CoarseTune=51]="CoarseTune",t[t.FineTune=52]="FineTune",t[t.SampleID=53]="SampleID",t[t.SampleModes=54]="SampleModes",t[t.Reserved3=55]="Reserved3",t[t.ScaleTuning=56]="ScaleTuning",t[t.ExclusiveClass=57]="ExclusiveClass",t[t.OverridingRootKey=58]="OverridingRootKey",t[t.Unused5=59]="Unused5",t[t.EndOper=60]="EndOper"}(is||(is={}));class Un{static hf=new Float32Array(0);loopMode=es.None;samples=Un.hf;sampleRate=0;loKey=0;hiKey=0;loVel=0;hiVel=0;group=0;offset=0;end=0;loopStart=0;loopEnd=0;transpose=0;tune=0;pitchKeyCenter=0;pitchKeyTrack=0;attenuation=0;pan=0;ampEnv=new Hn;modEnv=new Hn;initialFilterQ=0;initialFilterFc=0;modEnvToPitch=0;modEnvToFilterFc=0;modLfoToFilterFc=0;modLfoToVolume=0;delayModLFO=0;freqModLFO=0;modLfoToPitch=0;delayVibLFO=0;freqVibLFO=0;vibLfoToPitch=0;constructor(t){t&&(this.loopMode=t.loopMode,this.samples=t.samples,this.sampleRate=t.sampleRate,this.loKey=t.loKey,this.hiKey=t.hiKey,this.loVel=t.loVel,this.hiVel=t.hiVel,this.group=t.group,this.offset=t.offset,this.end=t.end,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.transpose=t.transpose,this.tune=t.tune,this.pitchKeyCenter=t.pitchKeyCenter,this.pitchKeyTrack=t.pitchKeyTrack,this.attenuation=t.attenuation,this.pan=t.pan,this.ampEnv=new Hn(t.ampEnv),this.modEnv=new Hn(t.modEnv),this.initialFilterQ=t.initialFilterQ,this.initialFilterFc=t.initialFilterFc,this.modEnvToPitch=t.modEnvToPitch,this.modEnvToFilterFc=t.modEnvToFilterFc,this.modLfoToFilterFc=t.modLfoToFilterFc,this.modLfoToVolume=t.modLfoToVolume,this.delayModLFO=t.delayModLFO,this.freqModLFO=t.freqModLFO,this.modLfoToPitch=t.modLfoToPitch,this.delayVibLFO=t.delayVibLFO,this.freqVibLFO=t.freqVibLFO,this.vibLfoToPitch=t.vibLfoToPitch)}clear(t){this.loopMode=es.None,this.samples=Un.hf,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=127,this.hiVel=127,this.pitchKeyCenter=60,t||(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=-12e3,this.ampEnv.attack=-12e3,this.ampEnv.hold=-12e3,this.ampEnv.decay=-12e3,this.ampEnv.release=-12e3,this.modEnv.delay=-12e3,this.modEnv.attack=-12e3,this.modEnv.hold=-12e3,this.modEnv.decay=-12e3,this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(t,e){switch(t){case is.StartAddrsOffset:this.offset+=de.int16ToUint32(e.shortAmount);break;case is.EndAddrsOffset:this.end+=de.int16ToUint32(e.shortAmount);break;case is.StartloopAddrsOffset:this.loopStart+=de.int16ToUint32(e.shortAmount);break;case is.EndloopAddrsOffset:this.loopEnd+=de.int16ToUint32(e.shortAmount);break;case is.StartAddrsCoarseOffset:this.offset+=32768*de.int16ToUint32(e.shortAmount);break;case is.ModLfoToPitch:this.modLfoToPitch=e.shortAmount;break;case is.VibLfoToPitch:this.vibLfoToPitch=e.shortAmount;break;case is.ModEnvToPitch:this.modEnvToPitch=e.shortAmount;break;case is.InitialFilterFc:this.initialFilterFc=e.shortAmount;break;case is.InitialFilterQ:this.initialFilterQ=e.shortAmount;break;case is.ModLfoToFilterFc:this.modLfoToFilterFc=e.shortAmount;break;case is.ModEnvToFilterFc:this.modEnvToFilterFc=e.shortAmount;break;case is.EndAddrsCoarseOffset:this.end+=32768*de.int16ToUint32(e.shortAmount);break;case is.ModLfoToVolume:this.modLfoToVolume=e.shortAmount;break;case is.Pan:this.pan=e.shortAmount/1e3;break;case is.DelayModLFO:this.delayModLFO=e.shortAmount;break;case is.FreqModLFO:this.freqModLFO=e.shortAmount;break;case is.DelayVibLFO:this.delayVibLFO=e.shortAmount;break;case is.FreqVibLFO:this.freqVibLFO=e.shortAmount;break;case is.DelayModEnv:this.modEnv.delay=e.shortAmount;break;case is.AttackModEnv:this.modEnv.attack=e.shortAmount;break;case is.HoldModEnv:this.modEnv.hold=e.shortAmount;break;case is.DecayModEnv:this.modEnv.decay=e.shortAmount;break;case is.SustainModEnv:this.modEnv.sustain=e.shortAmount;break;case is.ReleaseModEnv:this.modEnv.release=e.shortAmount;break;case is.KeynumToModEnvHold:this.modEnv.keynumToHold=e.shortAmount;break;case is.KeynumToModEnvDecay:this.modEnv.keynumToDecay=e.shortAmount;break;case is.DelayVolEnv:this.ampEnv.delay=e.shortAmount;break;case is.AttackVolEnv:this.ampEnv.attack=e.shortAmount;break;case is.HoldVolEnv:this.ampEnv.hold=e.shortAmount;break;case is.DecayVolEnv:this.ampEnv.decay=e.shortAmount;break;case is.SustainVolEnv:this.ampEnv.sustain=e.shortAmount;break;case is.ReleaseVolEnv:this.ampEnv.release=e.shortAmount;break;case is.KeynumToVolEnvHold:this.ampEnv.keynumToHold=e.shortAmount;break;case is.KeynumToVolEnvDecay:this.ampEnv.keynumToDecay=e.shortAmount;break;case is.KeyRange:this.loKey=e.lowByteAmount,this.hiKey=e.highByteAmount;break;case is.VelRange:this.loVel=e.lowByteAmount,this.hiVel=e.highByteAmount;break;case is.StartloopAddrsCoarseOffset:this.loopStart+=32768*de.int16ToUint32(e.shortAmount);break;case is.InitialAttenuation:this.attenuation+=.1*e.shortAmount;break;case is.EndloopAddrsCoarseOffset:this.loopEnd+=32768*de.int16ToUint32(e.shortAmount);break;case is.CoarseTune:this.transpose+=e.shortAmount;break;case is.FineTune:this.tune+=e.shortAmount;break;case is.SampleModes:this.loopMode=3&~e.wordAmount?1==(3&e.wordAmount)?es.Continuous:es.None:es.Sustain;break;case is.ScaleTuning:this.pitchKeyTrack=e.shortAmount;break;case is.ExclusiveClass:this.group=e.wordAmount;break;case is.OverridingRootKey:this.pitchKeyCenter=e.shortAmount}}}!function(t){t[t.None=0]="None",t[t.Delay=1]="Delay",t[t.Attack=2]="Attack",t[t.Hold=3]="Hold",t[t.Decay=4]="Decay",t[t.Sustain=5]="Sustain",t[t.Release=6]="Release",t[t.Done=7]="Done"}(ns||(ns={}));class zn{static cf=.01;level=0;slope=0;samplesUntilNextSegment=0;segment=ns.None;midiVelocity=0;parameters=null;segmentIsExponential=!1;isAmpEnv=!1;nextSegment(t,e){if(this.parameters)for(;;)switch(t){case ns.None:if(this.samplesUntilNextSegment=this.parameters.delay*e|0,this.samplesUntilNextSegment>0)return this.segment=ns.Delay,this.segmentIsExponential=!1,this.level=0,void(this.slope=0);t=ns.Delay;break;case ns.Delay:if(this.samplesUntilNextSegment=this.parameters.attack*e|0,this.samplesUntilNextSegment>0)return this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*e|0),this.segment=ns.Attack,this.segmentIsExponential=!1,this.level=0,void(this.slope=1/this.samplesUntilNextSegment);t=ns.Attack;break;case ns.Attack:if(this.samplesUntilNextSegment=this.parameters.hold*e|0,this.samplesUntilNextSegment>0)return this.segment=ns.Hold,this.segmentIsExponential=!1,this.level=1,void(this.slope=0);t=ns.Hold;break;case ns.Hold:if(this.samplesUntilNextSegment=this.parameters.decay*e|0,this.samplesUntilNextSegment>0){if(this.segment=ns.Decay,this.level=1,this.isAmpEnv){const t=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(t),this.segmentIsExponential=!0,this.parameters.sustain>0&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/t|0)}else this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*e|0,this.segmentIsExponential=!1;return}t=ns.Decay;break;case ns.Decay:return this.segment=ns.Sustain,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=2147483647,void(this.segmentIsExponential=!1);case ns.Sustain:if(this.segment=ns.Release,this.samplesUntilNextSegment=(this.parameters.release<=0?zn.cf:this.parameters.release)*e|0,this.isAmpEnv){const t=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(t),this.segmentIsExponential=!0}else this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1;return;default:return this.segment=ns.Done,this.segmentIsExponential=!1,this.level=0,this.slope=0,void(this.samplesUntilNextSegment=134217727)}}setup(t,e,s,i,n){this.parameters=new Hn(t),this.parameters.keynumToHold>0&&(this.parameters.hold+=this.parameters.keynumToHold*(60-e),this.parameters.hold=this.parameters.hold<-1e4?0:$n.timecents2Secs(this.parameters.hold)),this.parameters.keynumToDecay>0&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-e),this.parameters.decay=this.parameters.decay<-1e4?0:$n.timecents2Secs(this.parameters.decay)),this.midiVelocity=0|s,this.isAmpEnv=i,this.nextSegment(ns.None,n)}process(t,e){this.slope>0&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,t):this.level+=this.slope*t),this.samplesUntilNextSegment-=t,this.samplesUntilNextSegment<=0&&this.nextSegment(this.segment,e)}}class Xn{samplesUntil=0;level=0;delta=0;setup(t,e,s){this.samplesUntil=t*s|0,this.delta=4*$n.cents2Hertz(e)/s,this.level=0}process(t){this.samplesUntil>t?this.samplesUntil-=t:(this.level+=this.delta*t,this.level>1?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level))}}class jn{qInv=0;a0=0;a1=0;b1=0;b2=0;z1=0;z2=0;active=!1;constructor(t){t&&(this.qInv=t.qInv,this.a0=t.a0,this.a1=t.a1,this.b1=t.b1,this.b2=t.b2,this.z1=t.z1,this.z2=t.z2,this.active=t.active)}setup(t){const e=Math.tan(Math.PI*t),s=e*e,i=1/(1+e*this.qInv+s);this.a0=s*i,this.a1=2*this.a0,this.b1=2*(s-1)*i,this.b2=(1-e*this.qInv+s)*i}process(t){const e=t*this.a0+this.z1;return this.z1=t*this.a1+this.z2-this.b1*e,this.z2=t*this.a0-this.b2*e,e}}class Jn{static renderEffectSampleBlock=Ht.MicroBufferSize;playingPreset=0;playingKey=0;playingChannel=0;region=null;pitchInputTimecents=0;pitchOutputFactor=0;sourceSamplePosition=0;noteGainDb=0;panFactorLeft=0;panFactorRight=0;playIndex=0;loopStart=0;loopEnd=0;ampEnv=new zn;modEnv=new zn;lowPass=new jn;modLfo=new Xn;vibLfo=new Xn;mixVolume=0;mute=!1;updatePitchRatio(t,e){let s=t.pitchWheel;t.perNotePitchWheel.has(this.playingKey)&&(s+=t.perNotePitchWheel.get(this.playingKey)-8192);const i=8192===s?t.tuning:s/16383*t.pitchRange*2-t.pitchRange+t.tuning;this.calcPitchRatio(i,e)}calcPitchRatio(t,e){if(!this.region)return;const s=this.playingKey+this.region.transpose+this.region.tune/100;let i=this.region.pitchKeyCenter+(s-this.region.pitchKeyCenter)*(this.region.pitchKeyTrack/100);0!==t&&(i+=t),this.pitchInputTimecents=100*i,this.pitchOutputFactor=this.region.sampleRate/($n.timecents2Secs(100*this.region.pitchKeyCenter)*e)}end(t){this.region&&(this.ampEnv.nextSegment(ns.Sustain,t),this.modEnv.nextSegment(ns.Sustain,t),this.region.loopMode===es.Sustain&&(this.loopEnd=this.loopStart))}endQuick(t){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(ns.Sustain,t),this.modEnv.parameters.release=0,this.modEnv.nextSegment(ns.Sustain,t)}render(t,e,s,i,n){if(!this.region)return;const r=this.region,a=r.samples;let h=0,o=t.outputMode===ss.StereoUnweaved?i:-1;const c=0!==r.modEnvToPitch||0!==r.modEnvToFilterFc,l=this.modLfo.delta>0&&(0!==r.modLfoToPitch||0!==r.modLfoToFilterFc||0!==r.modLfoToVolume),u=this.vibLfo.delta>0&&0!==r.vibLfoToPitch,d=this.loopStart<this.loopEnd,f=this.loopStart,p=this.loopEnd,b=r.end,m=p+1;let g=this.sourceSamplePosition;const w=new jn(this.lowPass),y=0!==r.modLfoToFilterFc||0!==r.modEnvToFilterFc;let k=0,S=0,B=0,_=0;const T=0!==r.modLfoToPitch||0!==r.modEnvToPitch||0!==r.vibLfoToPitch;let x=0,M=0,v=0,N=0;const P=0!==r.modLfoToVolume;let C=0,E=0;for(y?(k=t.outSampleRate,S=r.initialFilterFc,B=r.modLfoToFilterFc,_=r.modEnvToFilterFc):(k=0,S=0,B=0,_=0),T?(x=0,M=r.modLfoToPitch,v=r.vibLfoToPitch,N=r.modEnvToPitch):(x=$n.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,M=0,v=0,N=0),P?E=.1*r.modLfoToVolume:(C=$n.decibelsToGain(this.noteGainDb),E=0);i>0;){let r,F,A=0,D=i>Jn.renderEffectSampleBlock?Jn.renderEffectSampleBlock:i;if(i-=D,y){const t=S+this.modLfo.level*B+this.modEnv.level*_;w.active=t<=13500,w.active&&w.setup($n.cents2Hertz(t)/k)}switch(T&&(x=$n.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*M+this.vibLfo.level*v+this.modEnv.level*N))*this.pitchOutputFactor),P&&(C=$n.decibelsToGain(this.noteGainDb+this.modLfo.level*E)),r=C*this.ampEnv.level,n?r=0:r*=this.mixVolume,this.ampEnv.process(D,t.outSampleRate),c&&this.modEnv.process(D,t.outSampleRate),l&&this.modLfo.process(D),u&&this.vibLfo.process(D),t.outputMode){case ss.StereoInterleaved:for(F=r*this.panFactorLeft,A=r*this.panFactorRight;D-- >0&&g<b;){const t=0|g,i=t>=p&&d?f:t+1,n=g-t;let r=a[t]*(1-n)+a[i]*n;w.active&&(r=w.process(r)),e[s+h]+=r*F,h++,e[s+h]+=r*A,h++,g+=x,g>=m&&d&&(g-=p-f+1)}break;case ss.StereoUnweaved:for(F=r*this.panFactorLeft,A=r*this.panFactorRight;D-- >0&&g<b;){const t=0|g,i=t>=p&&d?f:t+1,n=g-t;let r=a[t]*(1-n)+a[i]*n;w.active&&(r=w.process(r)),e[s+h]+=r*F,h++,e[s+o]+=r*A,o++,g+=x,g>=m&&d&&(g-=p-f+1)}break;case ss.Mono:for(;D-- >0&&g<b;){const t=0|g,i=t>=p&&d?f:t+1,n=g-t;let o=a[t]*(1-n)+a[i]*n;w.active&&(o=w.process(o)),e[s+h]=o*r,h++,g+=x,g>=m&&d&&(g-=p-f+1)}}if(g>=b||this.ampEnv.segment===ns.Done)return void this.kill()}this.sourceSamplePosition=g,(w.active||y)&&(this.lowPass=w)}kill(){this.playingPreset=-1}}class qn{value;next;constructor(t){this.value=t}}class Yn{lf;uf;get isEmpty(){return void 0===this.lf}clear(){this.lf=void 0,this.uf=void 0}enqueue(t){const e=new qn(t);this.uf?(this.uf.next=e,this.uf=e):(this.lf=e,this.uf=e)}enqueueFront(t){const e=new qn(t);e.next=this.lf,this.lf?this.lf=e:(this.lf=e,this.uf=e)}peek(){const t=this.lf;if(t)return t.value}dequeue(){const t=this.lf;if(!t)return;const e=t.next;return this.lf=e,e||(this.uf=void 0),t.value}}!function(t){t[t.BankSelectCoarse=0]="BankSelectCoarse",t[t.ModulationCoarse=1]="ModulationCoarse",t[t.DataEntryCoarse=6]="DataEntryCoarse",t[t.VolumeCoarse=7]="VolumeCoarse",t[t.PanCoarse=10]="PanCoarse",t[t.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",t[t.BankSelectFine=32]="BankSelectFine",t[t.ModulationFine=33]="ModulationFine",t[t.DataEntryFine=38]="DataEntryFine",t[t.VolumeFine=39]="VolumeFine",t[t.PanFine=42]="PanFine",t[t.ExpressionControllerFine=43]="ExpressionControllerFine",t[t.HoldPedal=64]="HoldPedal",t[t.LegatoPedal=68]="LegatoPedal",t[t.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",t[t.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",t[t.RegisteredParameterFine=100]="RegisteredParameterFine",t[t.RegisteredParameterCourse=101]="RegisteredParameterCourse",t[t.AllSoundOff=120]="AllSoundOff",t[t.ResetControllers=121]="ResetControllers",t[t.AllNotesOff=123]="AllNotesOff"}(rs||(rs={}));class Kn{df=new Yn;ff=new Map;pf=new Map;bf=!1;mf=new Map;gf=new Map;currentTempo=0;timeSignatureNumerator=0;timeSignatureDenominator=0;constructor(t){this.outSampleRate=t}synthesize(t,e,s){return this.wf(t,e,s)}synthesizeSilent(t){this.wf(null,0,t)}channelGetMixVolume(t){return this.Uu&&t<this.Uu.channelList.length?this.Uu.channelList[t].mixVolume:1}channelSetMixVolume(t,e){const s=this.yf(t);for(const s of this.kf)s.playingChannel===t&&-1!==s.playingPreset&&(s.mixVolume=e);s.mixVolume=e}channelSetMute(t,e){e?this.ff.set(t,!0):this.ff.delete(t)}channelSetSolo(t,e){e?this.pf.set(t,!0):this.pf.delete(t),this.bf=this.pf.size>0}resetChannelStates(){this.ff=new Map,this.pf=new Map,this.gf=new Map,this.applyTranspositionPitches(new Map),this.bf=!1}setChannelTranspositionPitch(t,e){let s=0;this.gf.has(t)&&(s=this.gf.get(t)),0===e?this.gf.delete(t):this.gf.set(t,e);for(const i of this.kf)if(i.playingChannel===t&&9!==i.playingChannel){let t=0;t-=s,t+=e,i.playingKey+=t,this.Uu&&i.updatePitchRatio(this.Uu.channelList[i.playingChannel],this.outSampleRate)}}applyTranspositionPitches(t){const e=this.mf;for(const s of this.kf)if(s.playingChannel>=0&&9!==s.playingChannel){let i=0;e.has(s.playingChannel)&&(i-=e.get(s.playingChannel)),t.has(s.playingChannel)&&(i+=t.get(s.playingChannel)),s.playingKey+=i,this.Uu&&s.updatePitchRatio(this.Uu.channelList[s.playingChannel],this.outSampleRate)}this.mf=t}dispatchEvent(t){this.df.enqueue(t)}wf(t,e,s){const i=this.bf,n=[];for(;!this.df.isEmpty;){const t=this.df.dequeue();t.isMetronome&&this.metronomeVolume>0?(this.channelNoteOff(Ht.MetronomeChannel,Ht.MetronomeKey),this.channelNoteOn(Ht.MetronomeChannel,Ht.MetronomeKey,95/127)):t.event&&this.processMidiMessage(t.event),n.push(t)}for(const n of this.kf)if(-1!==n.playingPreset){const r=n.playingChannel,a=this.ff.has(r)||i&&r!==Ht.MetronomeChannel&&!this.pf.has(r);t?n.render(this,t,e,s,a):n.kill()}return n}processMidiMessage(t){switch(t.type){case Ke.TimeSignature:const e=t;this.timeSignatureNumerator=e.numerator,this.timeSignatureDenominator=Math.pow(2,e.denominatorIndex);break;case Ke.NoteOn:const s=t;this.channelNoteOn(s.channel,s.noteKey,s.noteVelocity/127);break;case Ke.NoteOff:const i=t;this.channelNoteOff(i.channel,i.noteKey);break;case Ke.ControlChange:const n=t;this.channelMidiControl(n.channel,n.controller,n.value);break;case Ke.ProgramChange:const r=t;this.channelSetPresetNumber(r.channel,r.program,9===r.channel);break;case Ke.TempoChange:const a=t;this.currentTempo=a.beatsPerMinute;break;case Ke.PitchBend:const h=t;this.channelSetPitchWheel(h.channel,h.value);break;case Ke.PerNotePitchBend:const o=t;let c=o.value;c=c*Ht.MaxPitchWheel/Ht.MaxPitchWheel20,this.channelSetPerNotePitchWheel(o.channel,o.noteKey,c)}}get metronomeVolume(){return this.channelGetMixVolume(Ht.MetronomeChannel)}set metronomeVolume(t){this.setupMetronomeChannel(t)}setupMetronomeChannel(t){this.channelSetMixVolume(Ht.MetronomeChannel,t),t>0&&(this.channelSetVolume(Ht.MetronomeChannel,1),this.channelSetPresetNumber(Ht.MetronomeChannel,0,!0))}get masterVolume(){return $n.decibelsToGain(this.globalGainDb)}set masterVolume(t){const e=$n.gainToDecibels(t),s=e-this.globalGainDb;if(0!==s){for(const t of this.kf)-1!==t.playingPreset&&(t.noteGainDb+=s);this.globalGainDb=e}}resetSoft(){for(const t of this.kf)-1!==t.playingPreset&&(t.ampEnv.segment<ns.Release||0!==t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate);if(this.Uu)for(const t of this.Uu.channelList)t.presetIndex=0,t.bank=0,t.pitchWheel=8192,t.midiPan=8192,t.perNotePitchWheel.clear(),t.midiVolume=16383,t.midiExpression=16383,t.midiRpn=65535,t.midiData=0,t.panOffset=0,t.gainDb=0,t.pitchRange=2,t.tuning=0}presets=null;kf=[];Uu=null;Sf=0;get presetCount(){return this.presets?.length??0}outputMode=ss.StereoInterleaved;outSampleRate=0;globalGainDb=0;reset(){for(const t of this.kf)-1!==t.playingPreset&&(t.ampEnv.segment<ns.Release||0!==t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate);this.Uu=null}setOutput(t,e,s){this.outputMode=t,this.outSampleRate=e>=1?e:44100,this.globalGainDb=s}noteOn(t,e,s){if(!this.presets)return;const i=127*s|0;if(t<0||t>=this.presets.length)return;if(s<=0)return void this.noteOff(t,e);const n=this.Sf++;for(const r of this.presets[t].regions){if(e<r.loKey||e>r.hiKey||i<r.loVel||i>r.hiVel)continue;let a=null;if(0!==r.group)for(const e of this.kf)e.playingPreset===t&&e.region.group===r.group?e.endQuick(this.outSampleRate):-1!==e.playingPreset||a||(a=e);else for(const t of this.kf)-1===t.playingPreset&&(a=t);if(!a){for(let t=0;t<4;t++){const t=new Jn;t.playingPreset=-1,this.kf.push(t)}a=this.kf[this.kf.length-4]}a.region=r,a.playingPreset=t,a.playingKey=e,a.playIndex=n,a.noteGainDb=this.globalGainDb-r.attenuation-$n.gainToDecibels(1/s),this.Uu?this.Uu.setupVoice(this,a):(a.calcPitchRatio(0,this.outSampleRate),a.panFactorLeft=Math.sqrt(.5-r.pan),a.panFactorRight=Math.sqrt(.5+r.pan)),a.sourceSamplePosition=r.offset;const h=r.loopMode!==es.None&&r.loopStart<r.loopEnd;a.loopStart=h?r.loopStart:0,a.loopEnd=h?r.loopEnd:0,a.ampEnv.setup(r.ampEnv,e,i,!0,this.outSampleRate),a.modEnv.setup(r.modEnv,e,i,!1,this.outSampleRate);const o=r.initialFilterQ/10;a.lowPass.qInv=1/Math.pow(10,o/20),a.lowPass.z1=0,a.lowPass.z2=0,a.lowPass.active=r.initialFilterFc<=13500,a.lowPass.active&&a.lowPass.setup($n.cents2Hertz(r.initialFilterFc)/this.outSampleRate),a.modLfo.setup(r.delayModLFO,r.freqModLFO,this.outSampleRate),a.vibLfo.setup(r.delayVibLFO,r.freqVibLFO,this.outSampleRate)}}bankNoteOn(t,e,s,i){const n=this.Bf(t,e);return-1!==n&&(this.noteOn(n,s,i),!0)}noteOff(t,e){let s=null,i=null;const n=[];for(const r of this.kf)r.playingPreset!==t||r.playingKey!==e||r.ampEnv.segment>=ns.Release||(!s||r.playIndex<s.playIndex?(s=r,i=r,n.push(r)):r.playIndex===s.playIndex&&(i=r,n.push(r)));if(s)for(const r of n)r!==s&&r!==i&&(r.playIndex!==s.playIndex||r.playingPreset!==t||r.playingKey!==e||r.ampEnv.segment>=ns.Release)||r.end(this.outSampleRate)}bankNoteOff(t,e,s){const i=this.Bf(t,e);return-1!==i&&(this.noteOff(i,s),!0)}noteOffAll(t){for(const e of this.kf)-1!==e.playingPreset&&(t?e.endQuick(this.outSampleRate):e.ampEnv.segment<ns.Release&&e.end(this.outSampleRate))}get activeVoiceCount(){let t=0;for(const e of this.kf)-1!==e.playingPreset&&t++;return t}yf(t){if(this.Uu&&t<this.Uu.channelList.length)return this.Uu.channelList[t];this.Uu||(this.Uu=new Gn);for(let e=this.Uu.channelList.length;e<=t;e++){const t=new On;t.presetIndex=0,t.bank=0,t.pitchWheel=8192,t.midiPan=8192,t.midiVolume=16383,t.midiExpression=16383,t.midiRpn=65535,t.midiData=0,t.panOffset=0,t.gainDb=0,t.pitchRange=2,t.tuning=0,t.mixVolume=1,this.Uu.channelList.push(t)}return this.Uu.channelList[t]}Bf(t,e){if(!this.presets)return-1;for(let s=this.presets.length-1;s>=0;s--){const i=this.presets[s];if(i.presetNumber===e&&i.bank===t)return s}return-1}getPresetName(t){return this.presets?t<0||t>=this.presets.length?null:this.presets[t].name:null}bankGetPresetName(t,e){return this.getPresetName(this.Bf(t,e))}channelNoteOn(t,e,s){!this.Uu||t>this.Uu.channelList.length||(this.mf.has(t)&&(e+=this.mf.get(t)),this.gf.has(t)&&(e+=this.gf.get(t)),this.Uu.activeChannel=t,this.noteOn(this.Uu.channelList[t].presetIndex,e,s))}channelNoteOff(t,e){this.mf.has(t)&&(e+=this.mf.get(t)),this.gf.has(t)&&(e+=this.gf.get(t));const s=[];let i=null,n=null;for(const r of this.kf)-1===r.playingPreset||r.playingChannel!==t||r.playingKey!==e||r.ampEnv.segment>=ns.Release||(!i||r.playIndex<i.playIndex?(i=r,n=r,s.push(r)):r.playIndex===i.playIndex&&(n=r,s.push(r)));if(this.yf(t).perNotePitchWheel.delete(e),i)for(const r of s)r!==i&&r!==n&&(r.playIndex!==i.playIndex||-1===r.playingPreset||r.playingChannel!==t||r.playingKey!==e||r.ampEnv.segment>=ns.Release)||r.end(this.outSampleRate)}channelNoteOffAll(t){this.yf(t).perNotePitchWheel.clear();for(const e of this.kf)-1!==e.playingPreset&&e.playingChannel===t&&e.ampEnv.segment<ns.Release&&e.end(this.outSampleRate)}channelSoundsOffAll(t){this.yf(t).perNotePitchWheel.clear();for(const e of this.kf)-1!==e.playingPreset&&e.playingChannel===t&&(e.ampEnv.segment<ns.Release||0===e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate)}channelSetPresetIndex(t,e){this.yf(t).presetIndex=de.int32ToUint16(e)}channelSetPresetNumber(t,e,s=!1){const i=this.yf(t);let n=0;return s?(n=this.Bf(128|32767&i.bank,e),-1===n&&(n=this.Bf(128,e)),-1===n&&(n=this.Bf(128,0)),-1===n&&(n=this.Bf(2047&i.bank,e))):n=this.Bf(2047&i.bank,e),i.presetIndex=n,-1!==n}channelSetBank(t,e){this.yf(t).bank=de.int32ToUint16(e)}channelSetBankPreset(t,e,s){const i=this.yf(t),n=this.Bf(e,s);return-1!==n&&(i.presetIndex=de.int32ToUint16(n),i.bank=de.int32ToUint16(e),!0)}channelSetPan(t,e){for(const s of this.kf)if(s.playingChannel===t&&-1!==s.playingPreset){const t=s.region.pan+e-.5;t<=-.5?(s.panFactorLeft=1,s.panFactorRight=0):t>=.5?(s.panFactorLeft=0,s.panFactorRight=1):(s.panFactorLeft=Math.sqrt(.5-t),s.panFactorRight=Math.sqrt(.5+t))}this.yf(t).panOffset=e-.5}channelSetVolume(t,e){const s=this.yf(t),i=$n.gainToDecibels(e),n=i-s.gainDb;if(0!==n){for(const e of this.kf)e.playingChannel===t&&-1!==e.playingPreset&&(e.noteGainDb+=n);s.gainDb=i}}channelSetPitchWheel(t,e){const s=this.yf(t);s.pitchWheel!==e&&(s.pitchWheel=de.int32ToUint16(e),this._f(t,s))}channelSetPerNotePitchWheel(t,e,s){this.mf.has(t)&&(e+=this.mf.get(t)),this.gf.has(t)&&(e+=this.gf.get(t));const i=this.yf(t);i.perNotePitchWheel.has(e)&&i.perNotePitchWheel.get(e)===s||(i.perNotePitchWheel.set(e,s),this._f(t,i,e))}_f(t,e,s=-1){for(const i of this.kf)i.playingChannel!==t||-1===i.playingPreset||-1!==s&&i.playingKey!==s||i.updatePitchRatio(e,this.outSampleRate)}channelSetPitchRange(t,e){const s=this.yf(t);s.pitchRange!==e&&(s.pitchRange=e,8192!==s.pitchWheel&&this._f(t,s))}channelSetTuning(t,e){const s=this.yf(t);s.tuning!==e&&(s.tuning=e,this._f(t,s))}channelMidiControl(t,e,s){const i=this.yf(t);switch(e){case rs.DataEntryFine:return i.midiData=de.int32ToUint16(16256&i.midiData|s),void(0===i.midiRpn?this.channelSetPitchRange(t,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(t,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&this.channelSetTuning(t,s-64+(i.tuning-(0|i.tuning))));case rs.VolumeCoarse:return i.midiVolume=de.int32ToUint16(127&i.midiVolume|s<<7),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case rs.VolumeFine:return i.midiVolume=de.int32ToUint16(16256&i.midiVolume|s),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case rs.ExpressionControllerCoarse:return i.midiExpression=de.int32ToUint16(127&i.midiExpression|s<<7),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case rs.ExpressionControllerFine:return i.midiExpression=de.int32ToUint16(16256&i.midiExpression|s),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case rs.PanCoarse:return i.midiPan=de.int32ToUint16(127&i.midiPan|s<<7),void this.channelSetPan(t,i.midiPan/16383);case rs.PanFine:return i.midiPan=de.int32ToUint16(16256&i.midiPan|s),void this.channelSetPan(t,i.midiPan/16383);case rs.DataEntryCoarse:return i.midiData=de.int32ToUint16(127&i.midiData|s<<7),void(0===i.midiRpn?this.channelSetPitchRange(t,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(t,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&e===rs.DataEntryCoarse&&this.channelSetTuning(t,s-64+(i.tuning-(0|i.tuning))));case rs.BankSelectCoarse:return void(i.bank=de.int32ToUint16(32768|s));case rs.BankSelectFine:return void(i.bank=de.int32ToUint16((32768&i.bank?(127&i.bank)<<7:0)|s));case rs.RegisteredParameterCourse:return void(i.midiRpn=de.int32ToUint16(127&(65535===i.midiRpn?0:i.midiRpn)|s<<7));case rs.RegisteredParameterFine:return void(i.midiRpn=de.int32ToUint16(16256&(65535===i.midiRpn?0:i.midiRpn)|s));case rs.NonRegisteredParameterFine:case rs.NonRegisteredParameterCourse:return void(i.midiRpn=65535);case rs.AllSoundOff:return void this.channelSoundsOffAll(t);case rs.AllNotesOff:return void this.channelNoteOffAll(t);case rs.ResetControllers:return i.midiVolume=16383,i.midiExpression=16383,i.midiPan=8192,i.bank=0,this.channelSetVolume(t,1),this.channelSetPan(t,.5),void this.channelSetPitchRange(t,2)}}channelGetPresetIndex(t){return this.Uu&&t<this.Uu.channelList.length?this.Uu.channelList[t].presetIndex:0}channelGetPresetBank(t){return this.Uu&&t<this.Uu.channelList.length?32767&this.Uu.channelList[t].bank:0}channelGetPan(t){return this.Uu&&t<this.Uu.channelList.length?this.Uu.channelList[t].panOffset-.5:.5}channelGetVolume(t){return this.Uu&&t<this.Uu.channelList.length?$n.decibelsToGain(this.Uu.channelList[t].gainDb):1}channelGetPitchWheel(t){return this.Uu&&t<this.Uu.channelList.length?this.Uu.channelList[t].pitchWheel:8192}channelGetPitchRange(t){return this.Uu&&t<this.Uu.channelList.length?this.Uu.channelList[t].pitchRange:2}channelGetTuning(t){return this.Uu&&t<this.Uu.channelList.length?this.Uu.channelList[t].tuning:0}resetPresets(){this.presets=[]}loadPresets(t,e,s,i){const n=[];for(let i=0;i<t.phdrs.length-1;i++){const r=t.phdrs[i];let a=0;const h=new Vn;n.push(h),h.name=r.presetName,h.bank=r.bank,h.presetNumber=r.preset;let o=0;for(let e=r.presetBagNdx;e<t.phdrs[i+1].presetBagNdx;e++){let s=0,i=127,n=0,r=127;for(let a=t.pbags[e].genNdx;a<t.pbags[e+1].genNdx;a++){const e=t.pgens[a];if(e.genOper===Dn.GenKeyRange){s=e.genAmount.lowByteAmount,i=e.genAmount.highByteAmount;continue}if(e.genOper===Dn.GenVelRange){n=e.genAmount.lowByteAmount,r=e.genAmount.highByteAmount;continue}if(e.genOper!==Dn.GenInstrument)continue;if(e.genAmount.wordAmount>=t.insts.length)continue;for(let a=t.insts[e.genAmount.wordAmount].instBagNdx;a<t.insts[e.genAmount.wordAmount+1].instBagNdx;a++){let e=0,h=127,c=0,l=127;for(let u=t.ibags[a].instGenNdx;u<t.ibags[a+1].instGenNdx;u++){const a=t.igens[u];a.genOper!==Dn.GenKeyRange?a.genOper!==Dn.GenVelRange?53===a.genOper&&h>=s&&e<=i&&l>=n&&c<=r&&o++:(c=a.genAmount.lowByteAmount,l=a.genAmount.highByteAmount):(e=a.genAmount.lowByteAmount,h=a.genAmount.highByteAmount)}}}}h.regions=new Array(o);let c=new Un;c.clear(!0);for(let n=r.presetBagNdx;n<t.phdrs[i+1].presetBagNdx;n++){const i=t.pbags[n],o=new Un(c);let l=!1;for(let c=i.genNdx;c<t.pbags[n+1].genNdx;c++){const i=t.pgens[c];if(i.genOper===Dn.GenInstrument){const n=i.genAmount.wordAmount;if(n>=t.insts.length)continue;let c=new Un;c.clear(!1);const u=t.insts[n];for(let i=u.instBagNdx;i<t.insts[n+1].instBagNdx;i++){const n=t.ibags[i],l=new Un(c);let d=!1;for(let c=n.instGenNdx;c<t.ibags[i+1].instGenNdx;c++){const i=t.igens[c];if(i.genOper===Dn.GenSampleId){if(l.hiKey<o.loKey||l.loKey>o.hiKey)continue;if(l.hiVel<o.loVel||l.loVel>o.hiVel)continue;o.loKey>l.loKey&&(l.loKey=o.loKey),o.hiKey<l.hiKey&&(l.hiKey=o.hiKey),o.loVel>l.loVel&&(l.loVel=o.loVel),o.hiVel<l.hiVel&&(l.hiVel=o.hiVel),l.offset+=o.offset,l.end+=o.end,l.loopStart+=o.loopStart,l.loopEnd+=o.loopEnd,l.transpose+=o.transpose,l.tune+=o.tune,l.pitchKeyTrack+=o.pitchKeyTrack,l.attenuation+=o.attenuation,l.pan+=o.pan,l.ampEnv.delay+=o.ampEnv.delay,l.ampEnv.attack+=o.ampEnv.attack,l.ampEnv.hold+=o.ampEnv.hold,l.ampEnv.decay+=o.ampEnv.decay,l.ampEnv.sustain+=o.ampEnv.sustain,l.ampEnv.release+=o.ampEnv.release,l.modEnv.delay+=o.modEnv.delay,l.modEnv.attack+=o.modEnv.attack,l.modEnv.hold+=o.modEnv.hold,l.modEnv.decay+=o.modEnv.decay,l.modEnv.sustain+=o.modEnv.sustain,l.modEnv.release+=o.modEnv.release,l.initialFilterQ+=o.initialFilterQ,l.initialFilterFc+=o.initialFilterFc,l.modEnvToPitch+=o.modEnvToPitch,l.modEnvToFilterFc+=o.modEnvToFilterFc,l.delayModLFO+=o.delayModLFO,l.freqModLFO+=o.freqModLFO,l.modLfoToPitch+=o.modLfoToPitch,l.modLfoToFilterFc+=o.modLfoToFilterFc,l.modLfoToVolume+=o.modLfoToVolume,l.delayVibLFO+=o.delayVibLFO,l.freqVibLFO+=o.freqVibLFO,l.vibLfoToPitch+=o.vibLfoToPitch,l.ampEnv.envToSecs(!0),l.modEnv.envToSecs(!1),l.delayModLFO=l.delayModLFO<-11950?0:$n.timecents2Secs(l.delayModLFO),l.delayVibLFO=l.delayVibLFO<-11950?0:$n.timecents2Secs(l.delayVibLFO),l.pan<-.5?l.pan=-.5:l.pan>.5&&(l.pan=.5),(l.initialFilterQ<1500||l.initialFilterQ>13500)&&(l.initialFilterQ=0);const n=t.sHdrs[i.genAmount.wordAmount];l.offset+=n.start,l.end+=n.end,l.loopStart+=n.startLoop,l.loopEnd+=n.endLoop,n.endLoop>0&&(l.loopEnd-=1),-1===l.pitchKeyCenter&&(l.pitchKeyCenter=n.originalPitch),l.tune+=n.pitchCorrection,l.sampleRate=n.sampleRate;const c=r.bank===Ht.PercussionBank;if(c&&Kn.Tf(s,l.loKey,l.hiKey)||!c&&e.has(r.preset))if(1&n.sampleType){q.debug("AlphaSynth",`Loading of used sample ${n.sampleName} for preset ${r.presetName} (bank ${h.bank} program ${h.presetNumber})`);!!(16&n.sampleType)?l.samples=t.decodeSamples(n.start,n.end,!0):(l.samples=t.decodeSamples(2*l.offset,2*l.end,!1),l.loopStart>0&&(l.loopStart-=l.offset),l.loopEnd>0&&(l.loopEnd-=l.offset)),l.offset=0,l.end=l.samples.length-1}else q.warning("AlphaSynth",`Skipping load of unsupported sample ${n.sampleName} for preset ${r.presetName}, sample type ${n.sampleType} is not supported (bank ${h.bank} program ${h.presetNumber})`),l.samples=new Float32Array(0);else q.debug("AlphaSynth",`Skipping load of unused sample ${n.sampleName} for preset ${r.presetName} (bank ${h.bank} program ${h.presetNumber})`),l.samples=new Float32Array(0);h.regions[a]=new Un(l),a++,d=!0}else l.operator(i.genOper,i.genAmount)}n!==t.ibags[u.instBagNdx]||d||(c=new Un(l))}l=!0}else o.operator(i.genOper,i.genAmount)}i!==t.pbags[r.presetBagNdx]||l||(c=o)}}if(i&&this.presets)for(const t of n)this.presets.push(t);else this.presets=n}static Tf(t,e,s){for(let i=e;i<=s;i++)if(t.has(i))return!0;return!1}hasSamplesForProgram(t){const e=this.presets;if(!e)return!1;for(const s of e)if(s.presetNumber===t)for(const t of s.regions)if(t.samples.length>0)return!0;return!1}hasSamplesForPercussion(t){const e=this.presets;if(!e)return!1;for(const s of e)if(s.bank===Ht.PercussionBank)for(const e of s.regions)if(e.loKey>=t&&e.hiKey<=t&&e.samples.length>0)return!0;return!1}}class Qn{events;constructor(t){this.events=t}}class Zn{playbackRange;constructor(t){this.playbackRange=t}}class tr{soundFonts;sampleRate=44100;useSyncPoints=!1;masterVolume=1;metronomeVolume=0;playbackRange;trackVolume=new Map;trackTranspositionPitches=new Map}class er{samples;currentTime=0;endTime=0;currentTick=0;endTick=0}class sr{sequencer;synthesizer;isSoundFontLoaded=!1;xf=!1;Mf=0;vf=0;Nf=0;Pf=0;playedEventsQueue=new Yn;midiEventsPlayedFilterSet=new Set;Cf=0;Ef=!1;zi;Ff;Ud=new Xi(0,0,0,0,!1,120,120);get output(){return this.zi}isReady=!1;get isReadyForPlayback(){return this.isReady&&this.isSoundFontLoaded&&this.xf}state=Qe.Paused;get logLevel(){return q.logLevel}set logLevel(t){q.logLevel=t}get masterVolume(){return this.synthesizer.masterVolume}set masterVolume(t){t=Math.max(t,Ht.MinVolume),this.updateMasterVolume(t)}updateMasterVolume(t){this.synthesizer.masterVolume=t}get metronomeVolume(){return this.Nf}set metronomeVolume(t){t=Math.max(t,Ht.MinVolume),this.Nf=t,this.synthesizer.metronomeVolume=t}get countInVolume(){return this.Pf}set countInVolume(t){t=Math.max(t,Ht.MinVolume),this.Pf=t}get midiEventsPlayedFilter(){return Array.from(this.midiEventsPlayedFilterSet)}set midiEventsPlayedFilter(t){this.midiEventsPlayedFilterSet=new Set(t)}get playbackSpeed(){return this.sequencer.playbackSpeed}set playbackSpeed(t){t=Xt.clamp(t,Ht.MinPlaybackSpeed,Ht.MaxPlaybackSpeed),this.updatePlaybackSpeed(t)}updatePlaybackSpeed(t){const e=this.sequencer.playbackSpeed;this.sequencer.playbackSpeed=t,this.timePosition=this.timePosition*(e/t)}get loadedMidiInfo(){return this.Ff}get currentPosition(){return this.Ud}get tickPosition(){return this.Mf}set tickPosition(t){this.timePosition=this.sequencer.mainTickPositionToTimePosition(t)}get timePosition(){return this.vf}set timePosition(t){q.debug("AlphaSynth",`Seeking to position ${t}ms (main)`),this.sequencer.mainSeek(t),this.updateTimePosition(t,!0),this.sequencer.isPlayingMain&&(this.Cf=0,this.output.resetSamples())}get playbackRange(){return this.sequencer.mainPlaybackRange}set playbackRange(t){this.sequencer.mainPlaybackRange=t,t&&(this.tickPosition=t.startTick),this.playbackRangeChanged.trigger(new Zn(t))}get isLooping(){return this.sequencer.isLooping}set isLooping(t){this.sequencer.isLooping=t}destroy(){q.debug("AlphaSynth","Destroying player"),this.stop(),this.output.destroy()}constructor(t,e,s){q.debug("AlphaSynth","Initializing player"),this.state=Qe.Paused,this.ready=new mi(()=>this.isReady),this.readyForPlayback=new mi(()=>this.isReadyForPlayback),this.midiLoaded=new gi(()=>this.Ff?this.Ff:null),this.stateChanged=new gi(()=>new zi(this.state,!1)),this.positionChanged=new gi(()=>this.Ud),this.playbackRangeChanged=new gi(()=>this.playbackRange?new Zn(this.playbackRange):null),q.debug("AlphaSynth","Creating output"),this.zi=t,q.debug("AlphaSynth","Creating synthesizer"),this.synthesizer=e,this.sequencer=new Ui(this.synthesizer),q.debug("AlphaSynth","Opening output"),this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this.Af()}),this.output.sampleRequest.on(()=>{this.onSampleRequest()}),this.output.samplesPlayed.on(this.Df.bind(this)),this.output.open(s)}onSampleRequest(){if(this.state===Qe.Playing&&(!this.sequencer.isFinished||this.synthesizer.activeVoiceCount>0)){let t=new Float32Array(Ht.MicroBufferSize*Ht.MicroBufferCount*Ht.AudioChannels),e=0;for(let s=0;s<Ht.MicroBufferCount;s++){this.sequencer.fillMidiEventQueue();const s=this.synthesizer.synthesize(t,e,Ht.MicroBufferSize);e+=Ht.MicroBufferSize*Ht.AudioChannels;for(const t of s)this.midiEventsPlayedFilterSet.has(t.event.type)&&this.playedEventsQueue.enqueue(t);if(this.sequencer.isFinished)break}e<t.length&&(t=t.subarray(0,e)),this.Cf+=t.length,this.output.addSamples(t)}else{const t=new Float32Array(0);this.output.addSamples(t)}}play(){return!(this.state!==Qe.Paused||!this.xf)&&(this.output.activate(),this.Lf(),this.Pf>0&&(q.debug("AlphaSynth","Starting countin"),this.sequencer.startCountIn(),this.synthesizer.setupMetronomeChannel(this.Pf),this.updateTimePosition(0,!0)),this.output.play(),!0)}Lf(){this.sequencer.isPlayingOneTimeMidi&&(q.debug("AlphaSynth","Cancelling one time midi"),this.Wf()),q.debug("AlphaSynth","Starting playback"),this.synthesizer.setupMetronomeChannel(this.metronomeVolume),this.Ef=!1,this.state=Qe.Playing,this.stateChanged.trigger(new zi(this.state,!1))}pause(){this.state!==Qe.Paused&&this.xf&&(q.debug("AlphaSynth","Pausing playback"),this.state=Qe.Paused,this.stateChanged.trigger(new zi(this.state,!1)),this.output.pause(),this.synthesizer.noteOffAll(!1))}playPause(){this.state===Qe.Paused&&this.xf?this.play():this.pause()}stop(){this.xf&&(q.debug("AlphaSynth","Stopping playback"),this.state=Qe.Paused,this.output.pause(),this.Cf=0,this.sequencer.stop(),this.synthesizer.noteOffAll(!0),this.tickPosition=this.sequencer.mainPlaybackRange?this.sequencer.mainPlaybackRange.startTick:0,this.stateChanged.trigger(new zi(this.state,!0)))}playOneTimeMidiFile(t){this.sequencer.isPlayingOneTimeMidi?this.Wf():this.pause(),this.sequencer.loadOneTimeMidi(t),this.synthesizer.noteOffAll(!0),this.updateTimePosition(0,!0),this.Cf=0,this.output.resetSamples(),this.output.play()}resetSoundFonts(){this.stop(),this.synthesizer.resetPresets(),this.Rf=[],this.isSoundFontLoaded=!1,this.soundFontLoaded.trigger()}Rf=[];loadSoundFont(t,e){this.pause();const s=Ae.fromBuffer(t);try{q.debug("AlphaSynth","Loading soundfont from bytes");const t=new Nn;t.load(s),e||(this.Rf=[]),this.Rf.push(t),this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),q.debug("AlphaSynth","soundFont successfully loaded"),this.Af()}catch(t){q.error("AlphaSynth",`Could not load soundfont from bytes ${t}`),this.soundFontLoadFailed.trigger(t)}}Af(){if(this.isReadyForPlayback){this.synthesizer.setupMetronomeChannel(this.metronomeVolume);const t=this.sequencer.instrumentPrograms,e=this.sequencer.percussionKeys;let s=!1;for(const i of this.Rf)this.synthesizer.loadPresets(i,t,e,s),s=!0;this.readyForPlayback.trigger()}}loadMidiFile(t){this.stop();try{q.debug("AlphaSynth","Loading midi from model"),this.sequencer.loadMidi(t),this.xf=!0,this.Ff=new Xi(0,this.sequencer.currentEndTime,0,this.sequencer.currentEndTick,!1,this.sequencer.currentTempo,this.sequencer.modifiedTempo),this.midiLoaded.trigger(this.Ff),q.debug("AlphaSynth","Midi successfully loaded"),this.Af(),this.tickPosition=0}catch(t){q.error("AlphaSynth",`Could not load midi from model ${t}`),this.midiLoadFailed.trigger(t)}}applyTranspositionPitches(t){this.synthesizer.applyTranspositionPitches(t)}setChannelTranspositionPitch(t,e){this.synthesizer.setChannelTranspositionPitch(t,e)}setChannelMute(t,e){this.synthesizer.channelSetMute(t,e)}resetChannelStates(){this.synthesizer.resetChannelStates()}setChannelSolo(t,e){this.synthesizer.channelSetSolo(t,e)}setChannelVolume(t,e){e=Math.max(e,Ht.MinVolume),this.synthesizer.channelSetMixVolume(t,e)}Df(t){if(0===t)return;const e=t/this.synthesizer.outSampleRate*1e3;this.Cf-=t*Ht.AudioChannels,this.updateTimePosition(this.vf+e,!1),this.checkForFinish()}checkForFinish(){let t=0,e=0;this.playbackRange&&this.sequencer.isPlayingMain?(t=this.playbackRange.startTick,e=this.playbackRange.endTick):e=this.sequencer.currentEndTick,this.Mf>=e&&(this.Cf<=0?(this.Cf=0,this.sequencer.isPlayingCountIn?(q.debug("AlphaSynth","Finished playback (count-in)"),this.sequencer.resetCountIn(),this.timePosition=this.sequencer.currentTime,this.Lf(),this.output.resetSamples()):this.sequencer.isPlayingOneTimeMidi?(q.debug("AlphaSynth","Finished playback (one time)"),this.output.resetSamples(),this.state=Qe.Paused,this.Wf()):this.isLooping?(q.debug("AlphaSynth","Finished playback (main looping)"),this.finished.trigger(),this.tickPosition=t,this.Ef=!1):this.synthesizer.activeVoiceCount>0?this.Ef||(q.debug("AlphaSynth","Signaling synth to stop all voices (all samples played)"),this.synthesizer.noteOffAll(!0),this.Ef=!0):(this.Ef=!1,q.debug("AlphaSynth","Finished playback (main)"),this.finished.trigger(),this.stop())):this.Ef||(q.debug("AlphaSynth","Signaling synth to stop all voices (not all samples played)"),this.synthesizer.noteOffAll(!0),this.Ef=!0))}Wf(){this.output.pause(),this.synthesizer.noteOffAll(!0),this.sequencer.resetOneTimeMidi(),this.timePosition=this.sequencer.currentTime}If(t){let e=this.vf,s=this.sequencer.currentTimePositionToTickPosition(e);const i=this.sequencer.currentEndTime,n=this.sequencer.currentEndTick;return e>i&&(e=i,s=n),new Xi(e,i,s,n,t,this.sequencer.currentTempo,this.sequencer.modifiedTempo)}updateTimePosition(t,e){this.vf=t;const s=this.If(e);this.Mf=s.currentTick;const i=this.sequencer.isPlayingMain?"main":this.sequencer.isPlayingCountIn?"count-in":"one-time";if(q.debug("AlphaSynth",`Position changed: (time: ${s.currentTime}/${s.endTime}, tick: ${s.currentTick}/${s.endTick}, Active Voices: ${this.synthesizer.activeVoiceCount} (${i}), Tempo original: ${this.sequencer.currentTempo}, Tempo modified: ${this.sequencer.modifiedTempo})`),this.sequencer.isPlayingMain&&(this.Ud=s,this.positionChanged.trigger(s)),e)this.playedEventsQueue.clear();else{const t=[];for(;!this.playedEventsQueue.isEmpty&&this.playedEventsQueue.peek().time<s.currentTime;){const e=this.playedEventsQueue.dequeue();t.push(e.event)}t.length>0&&(t.reverse(),this.midiEventsPlayed.trigger(new Qn(t)))}}ready;readyForPlayback=new mi;finished=new mi;soundFontLoaded=new mi;soundFontLoadFailed=new gi;midiLoaded;midiLoadFailed=new gi;stateChanged;positionChanged;midiEventsPlayed=new gi;playbackRangeChanged;hasSamplesForProgram(t){return this.synthesizer.hasSamplesForProgram(t)}hasSamplesForPercussion(t){return this.synthesizer.hasSamplesForPercussion(t)}loadBackingTrack(t){}updateSyncPoints(t){}}class ir extends sr{constructor(t,e){super(t,new Kn(t.sampleRate),e)}exportAudio(t,e,s,i){const n=new nr(t);n.loadMidiFile(e),t.useSyncPoints&&n.updateSyncPoints(s),n.applyTranspositionPitches(i);for(const[e,s]of t.trackTranspositionPitches)n.setChannelTranspositionPitch(e,s);for(const[e,s]of t.trackVolume)n.channelSetMixVolume(e,s);if(t.soundFonts)for(const e of t.soundFonts)n.loadSoundFont(e);else n.loadPresets(this.synthesizer.presets);return t.playbackRange&&n.limitExport(t.playbackRange),n.setup(),n}}class nr{Of;Gf;constructor(t){this.Of=new Kn(t.sampleRate),this.Gf=new Ui(this.Of),this.Of.masterVolume=Math.max(t.masterVolume,Ht.MinVolume),this.Of.metronomeVolume=Math.max(t.metronomeVolume,Ht.MinVolume)}loadSoundFont(t){const e=Ae.fromBuffer(t),s=new Nn;s.load(e);const i=this.Gf.instrumentPrograms,n=this.Gf.percussionKeys;this.Of.loadPresets(s,i,n,!0)}loadPresets(t){this.Of.presets=t}limitExport(t){this.Gf.mainPlaybackRange=t,this.Gf.mainSeek(this.Gf.mainTickPositionToTimePosition(t.startTick))}setChannelTranspositionPitch(t,e){this.Of.setChannelTranspositionPitch(t,e)}applyTranspositionPitches(t){this.Of.applyTranspositionPitches(t)}loadMidiFile(t){this.Gf.loadMidi(t)}updateSyncPoints(t){this.Gf.mainUpdateSyncPoints(t)}channelSetMixVolume(t,e){e=Math.max(e,Ht.MinVolume),this.Of.channelSetMixVolume(t,e)}Vf=0;$f=0;setup(){this.Of.setupMetronomeChannel(this.Of.metronomeVolume);const t=this.Gf.currentSyncPoints,e=this.Gf.currentEndTime;if(0===t.length)this.$f=e;else{const e=t[t.length-1];let s=e.syncTime;const i=this.Gf.currentEndTick-e.synthTick;i>0&&(s+=$.ticksToMillis(i,e.syncBpm)),this.$f=s}}render(t){if(this.Gf.isFinished)return;const e=1e3*Ht.MicroBufferSize/this.Of.outSampleRate,s=Math.ceil(t/e);let i=new Float32Array(Ht.MicroBufferSize*s*Ht.AudioChannels);const n=this.Gf.currentSyncPoints;let r=0,a=this.Vf;for(let t=0;t<s;t++){if(n.length>0){this.Gf.currentUpdateSyncPoints(a),this.Gf.currentUpdateCurrentTempo(this.Gf.currentTime);const t=this.Gf.syncPointTempo/this.Gf.currentTempo;this.Gf.playbackSpeed!==t&&(this.Gf.playbackSpeed=t)}if(this.Gf.fillMidiEventQueue(),this.Of.synthesize(i,r,Ht.MicroBufferSize),r+=Ht.MicroBufferSize*Ht.AudioChannels,a+=e,this.Gf.isFinished)break}r<i.length&&(i=i.subarray(0,r));const h=new er;return h.currentTime=this.Vf,h.endTime=this.$f,h.currentTick=this.Gf.currentTimePositionToTickPosition(this.Gf.currentTime),h.endTick=this.Gf.currentEndTick,this.Vf+=t,h.samples=i,this.Gf.isFinished&&this.Of.noteOffAll(!0),h}}class rr{static parseEnum(e,s){switch(typeof e){case"string":const t=Number.parseInt(e,10);return Number.isNaN(t)?s[Object.keys(s).find(t=>t.toLowerCase()===e.toLowerCase())]:t;case"number":return e;case"undefined":case"object":return}throw new G(t.AlphaTabErrorType.Format,`Could not parse enum value '${e}'`)}static parseEnumExact(t,e){if(t in e)return e[t]}static forEach(t,e){if(t instanceof Map)t.forEach(e);else if("object"==typeof t)for(const s in t)e(t[s],s)}static getValue(t,e){return t instanceof Map?t.get(e):"object"==typeof t?t[e]:null}}class ar{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>ar.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("groups",s);for(const[e,i]of t.groups)s.set(e.toString(),i)}return e}static setProperty(t,e,s){return"groups"===e&&(t.groups=new Map,rr.forEach(s,(e,s)=>{t.groups.set(rr.parseEnum(s,l),e)}),!0)}}class hr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>hr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("marker",t.marker),e.set("text",t.text),e}static setProperty(t,e,s){switch(e){case"marker":return t.marker=s,!0;case"text":return t.text=s,!0}return!1}}class or{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>or.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("baroccurence",t.barOccurence),e.set("millisecondoffset",t.millisecondOffset),e}static setProperty(t,e,s){switch(e){case"baroccurence":return t.barOccurence=s,!0;case"millisecondoffset":return t.millisecondOffset=s,!0}return!1}}class cr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>cr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("islinear",t.isLinear),e.set("type",t.type),e.set("value",t.value),t.syncPointValue&&e.set("syncpointvalue",or.toJson(t.syncPointValue)),e.set("ratioposition",t.ratioPosition),e.set("text",t.text),e.set("isvisible",t.isVisible),e}static setProperty(t,e,s){switch(e){case"islinear":return t.isLinear=s,!0;case"type":return t.type=rr.parseEnum(s,r),!0;case"value":return t.value=s,!0;case"syncpointvalue":return s?(t.syncPointValue=new H,or.fromJson(t.syncPointValue,s)):t.syncPointValue=void 0,!0;case"ratioposition":return t.ratioPosition=s,!0;case"text":return t.text=s,!0;case"isvisible":return t.isVisible=s,!0}return!1}}class lr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>lr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("type",t.type),e.set("length",t.length),e}static setProperty(t,e,s){switch(e){case"type":return t.type=rr.parseEnum(s,Dt),!0;case"length":return t.length=s,!0}return!1}}class ur{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>ur.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("alternateendings",t.alternateEndings),e.set("isdoublebar",t.isDoubleBar),e.set("isrepeatstart",t.isRepeatStart),e.set("repeatcount",t.repeatCount),e.set("timesignaturenumerator",t.timeSignatureNumerator),e.set("timesignaturedenominator",t.timeSignatureDenominator),e.set("timesignaturecommon",t.timeSignatureCommon),t.beamingRules&&e.set("beamingrules",ar.toJson(t.beamingRules)),e.set("isfreetime",t.isFreeTime),e.set("tripletfeel",t.tripletFeel),t.section&&e.set("section",hr.toJson(t.section)),e.set("tempoautomations",t.tempoAutomations.map(t=>cr.toJson(t))),void 0!==t.syncPoints&&e.set("syncpoints",t.syncPoints?.map(t=>cr.toJson(t))),null!==t.fermata){const s=new Map;e.set("fermata",s);for(const[e,i]of t.fermata)s.set(e.toString(),lr.toJson(i))}if(e.set("start",t.start),e.set("isanacrusis",t.isAnacrusis),e.set("displayscale",t.displayScale),e.set("displaywidth",t.displayWidth),null!==t.directions){const s=[];e.set("directions",s);for(const e of t.directions)s.push(e)}return e}static setProperty(t,e,s){switch(e){case"alternateendings":return t.alternateEndings=s,!0;case"isdoublebar":return t.isDoubleBar=s,!0;case"isrepeatstart":return t.isRepeatStart=s,!0;case"repeatcount":return t.repeatCount=s,!0;case"timesignaturenumerator":return t.timeSignatureNumerator=s,!0;case"timesignaturedenominator":return t.timeSignatureDenominator=s,!0;case"timesignaturecommon":return t.timeSignatureCommon=s,!0;case"beamingrules":return s?(t.beamingRules=new tt,ar.fromJson(t.beamingRules,s)):t.beamingRules=void 0,!0;case"isfreetime":return t.isFreeTime=s,!0;case"tripletfeel":return t.tripletFeel=rr.parseEnum(s,A),!0;case"section":return s?(t.section=new Te,hr.fromJson(t.section,s)):t.section=null,!0;case"tempoautomations":t.tempoAutomations=[];for(const e of s){const s=new U;cr.fromJson(s,e),t.tempoAutomations.push(s)}return!0;case"syncpoints":if(s){t.syncPoints=[];for(const e of s){const s=new U;cr.fromJson(s,e),t.addSyncPoint(s)}}return!0;case"fermata":return t.fermata=new Map,rr.forEach(s,(e,s)=>{const i=new Be;lr.fromJson(i,e),t.addFermata(Number.parseInt(s),i)}),!0;case"start":return t.start=s,!0;case"isanacrusis":return t.isAnacrusis=s,!0;case"displayscale":return t.displayScale=s,!0;case"displaywidth":return t.displayWidth=s,!0;case"directions":for(const e of s)t.addDirection(rr.parseEnum(e,Xe));return!0}return!1}}class dr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>dr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("offset",t.offset),e.set("value",t.value),e}static setProperty(t,e,s){switch(e){case"offset":return t.offset=s,!0;case"value":return t.value=s,!0}return!1}}class fr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>fr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;e.set("notehead",t.noteHead),e.set("noteheadcenteronstem",t.noteHeadCenterOnStem);{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),Se.toJson(i))}return e}static setProperty(t,e,s){switch(e){case"notehead":return t.noteHead=rr.parseEnum(s,ut),!0;case"noteheadcenteronstem":return t.noteHeadCenterOnStem=s,!0;case"colors":return t.colors=new Map,rr.forEach(s,(e,s)=>{t.colors.set(rr.parseEnum(s,pt),Se.fromJson(e))}),!0}return!1}}class pr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>pr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("accentuated",t.accentuated),e.set("bendtype",t.bendType),e.set("bendstyle",t.bendStyle),e.set("iscontinuedbend",t.isContinuedBend),null!==t.bendPoints&&e.set("bendpoints",t.bendPoints?.map(t=>dr.toJson(t))),e.set("fret",t.fret),e.set("string",t.string),e.set("showstringnumber",t.showStringNumber),e.set("octave",t.octave),e.set("tone",t.tone),e.set("percussionarticulation",t.percussionArticulation),e.set("isvisible",t.isVisible),e.set("islefthandtapped",t.isLeftHandTapped),e.set("ishammerpullorigin",t.isHammerPullOrigin),e.set("isslurdestination",t.isSlurDestination),e.set("harmonictype",t.harmonicType),e.set("harmonicvalue",t.harmonicValue),e.set("isghost",t.isGhost),e.set("isletring",t.isLetRing),e.set("ispalmmute",t.isPalmMute),e.set("isdead",t.isDead),e.set("isstaccato",t.isStaccato),e.set("slideintype",t.slideInType),e.set("slideouttype",t.slideOutType),e.set("vibrato",t.vibrato),e.set("istiedestination",t.isTieDestination),e.set("lefthandfinger",t.leftHandFinger),e.set("righthandfinger",t.rightHandFinger),e.set("trillvalue",t.trillValue),e.set("trillspeed",t.trillSpeed),e.set("durationpercent",t.durationPercent),e.set("accidentalmode",t.accidentalMode),e.set("dynamics",t.dynamics),e.set("ornament",t.ornament),t.style&&e.set("style",fr.toJson(t.style)),t.toJson(e),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"accentuated":return t.accentuated=rr.parseEnum(s,d),!0;case"bendtype":return t.bendType=rr.parseEnum(s,h),!0;case"bendstyle":return t.bendStyle=rr.parseEnum(s,a),!0;case"iscontinuedbend":return t.isContinuedBend=s,!0;case"bendpoints":if(s){t.bendPoints=[];for(const e of s){const s=new z;dr.fromJson(s,e),t.addBendPoint(s)}}return!0;case"fret":return t.fret=s,!0;case"string":return t.string=s,!0;case"showstringnumber":return t.showStringNumber=s,!0;case"octave":return t.octave=s,!0;case"tone":return t.tone=s,!0;case"percussionarticulation":return t.percussionArticulation=s,!0;case"isvisible":return t.isVisible=s,!0;case"islefthandtapped":return t.isLeftHandTapped=s,!0;case"ishammerpullorigin":return t.isHammerPullOrigin=s,!0;case"isslurdestination":return t.isSlurDestination=s,!0;case"harmonictype":return t.harmonicType=rr.parseEnum(s,p),!0;case"harmonicvalue":return t.harmonicValue=s,!0;case"isghost":return t.isGhost=s,!0;case"isletring":return t.isLetRing=s,!0;case"ispalmmute":return t.isPalmMute=s,!0;case"isdead":return t.isDead=s,!0;case"isstaccato":return t.isStaccato=s,!0;case"slideintype":return t.slideInType=rr.parseEnum(s,g),!0;case"slideouttype":return t.slideOutType=rr.parseEnum(s,w),!0;case"vibrato":return t.vibrato=rr.parseEnum(s,y),!0;case"istiedestination":return t.isTieDestination=s,!0;case"lefthandfinger":return t.leftHandFinger=rr.parseEnum(s,f),!0;case"righthandfinger":return t.rightHandFinger=rr.parseEnum(s,f),!0;case"trillvalue":return t.trillValue=s,!0;case"trillspeed":return t.trillSpeed=rr.parseEnum(s,l),!0;case"durationpercent":return t.durationPercent=s,!0;case"accidentalmode":return t.accidentalMode=rr.parseEnum(s,b),!0;case"dynamics":return t.dynamics=rr.parseEnum(s,n),!0;case"ornament":return t.ornament=rr.parseEnum(s,ft),!0;case"style":return s?(t.style=new Kt,fr.fromJson(t.style,s)):t.style=void 0,!0}return t.setProperty(e,s)}}class br{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>br.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("marks",t.marks),e.set("style",t.style),e}static setProperty(t,e,s){switch(e){case"marks":return t.marks=s,!0;case"style":return t.style=rr.parseEnum(s,St),!0}return!1}}class mr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>mr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),Se.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,rr.forEach(s,(e,s)=>{t.colors.set(rr.parseEnum(s,_t),Se.fromJson(e))}),!0)}}class gr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>gr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("notes",t.notes.map(t=>pr.toJson(t))),e.set("isempty",t.isEmpty),e.set("whammystyle",t.whammyStyle),e.set("ottava",t.ottava),e.set("islegatoorigin",t.isLegatoOrigin),e.set("duration",t.duration),e.set("automations",t.automations.map(t=>cr.toJson(t))),e.set("dots",t.dots),e.set("fade",t.fade),e.set("lyrics",t.lyrics),e.set("pop",t.pop),e.set("slap",t.slap),e.set("tap",t.tap),e.set("text",t.text),e.set("slashed",t.slashed),e.set("deadslapped",t.deadSlapped),e.set("brushtype",t.brushType),e.set("brushduration",t.brushDuration),e.set("tupletdenominator",t.tupletDenominator),e.set("tupletnumerator",t.tupletNumerator),e.set("iscontinuedwhammy",t.isContinuedWhammy),e.set("whammybartype",t.whammyBarType),null!==t.whammyBarPoints&&e.set("whammybarpoints",t.whammyBarPoints?.map(t=>dr.toJson(t))),e.set("vibrato",t.vibrato),e.set("chordid",t.chordId),e.set("gracetype",t.graceType),e.set("pickstroke",t.pickStroke),t.tremoloPicking&&e.set("tremolopicking",br.toJson(t.tremoloPicking)),e.set("crescendo",t.crescendo),e.set("displaystart",t.displayStart),e.set("playbackstart",t.playbackStart),e.set("displayduration",t.displayDuration),e.set("playbackduration",t.playbackDuration),e.set("overridedisplayduration",t.overrideDisplayDuration),e.set("golpe",t.golpe),e.set("dynamics",t.dynamics),e.set("invertbeamdirection",t.invertBeamDirection),e.set("preferredbeamdirection",t.preferredBeamDirection),e.set("beamingmode",t.beamingMode),e.set("wahpedal",t.wahPedal),e.set("barrefret",t.barreFret),e.set("barreshape",t.barreShape),e.set("rasgueado",t.rasgueado),e.set("showtimer",t.showTimer),e.set("timer",t.timer),t.style&&e.set("style",mr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"notes":t.notes=[];for(const e of s){const s=new Qt;pr.fromJson(s,e),t.addNote(s)}return!0;case"isempty":return t.isEmpty=s,!0;case"whammystyle":return t.whammyStyle=rr.parseEnum(s,a),!0;case"ottava":return t.ottava=rr.parseEnum(s,m),!0;case"islegatoorigin":return t.isLegatoOrigin=s,!0;case"duration":return t.duration=rr.parseEnum(s,l),!0;case"automations":t.automations=[];for(const e of s){const s=new U;cr.fromJson(s,e),t.automations.push(s)}return!0;case"dots":return t.dots=s,!0;case"fade":return t.fade=rr.parseEnum(s,gt),!0;case"lyrics":return t.lyrics=s,!0;case"pop":return t.pop=s,!0;case"slap":return t.slap=s,!0;case"tap":return t.tap=s,!0;case"text":return t.text=s,!0;case"slashed":return t.slashed=s,!0;case"deadslapped":return t.deadSlapped=s,!0;case"brushtype":return t.brushType=rr.parseEnum(s,o),!0;case"brushduration":return t.brushDuration=s,!0;case"tupletdenominator":return t.tupletDenominator=s,!0;case"tupletnumerator":return t.tupletNumerator=s,!0;case"iscontinuedwhammy":return t.isContinuedWhammy=s,!0;case"whammybartype":return t.whammyBarType=rr.parseEnum(s,bt),!0;case"whammybarpoints":if(s){t.whammyBarPoints=[];for(const e of s){const s=new z;dr.fromJson(s,e),t.addWhammyBarPoint(s)}}return!0;case"vibrato":return t.vibrato=rr.parseEnum(s,y),!0;case"chordid":return t.chordId=s,!0;case"gracetype":return t.graceType=rr.parseEnum(s,u),!0;case"pickstroke":return t.pickStroke=rr.parseEnum(s,lt),!0;case"tremolopicking":return s?(t.tremoloPicking=new te,br.fromJson(t.tremoloPicking,s)):t.tremoloPicking=void 0,!0;case"crescendo":return t.crescendo=rr.parseEnum(s,c),!0;case"displaystart":return t.displayStart=s,!0;case"playbackstart":return t.playbackStart=s,!0;case"displayduration":return t.displayDuration=s,!0;case"playbackduration":return t.playbackDuration=s,!0;case"overridedisplayduration":return t.overrideDisplayDuration=s,!0;case"golpe":return t.golpe=rr.parseEnum(s,mt),!0;case"dynamics":return t.dynamics=rr.parseEnum(s,n),!0;case"invertbeamdirection":return t.invertBeamDirection=s,!0;case"preferredbeamdirection":return t.preferredBeamDirection=rr.parseEnum(s,Rt)??null,!0;case"beamingmode":return t.beamingMode=rr.parseEnum(s,Bt),!0;case"wahpedal":return t.wahPedal=rr.parseEnum(s,wt),!0;case"barrefret":return t.barreFret=s,!0;case"barreshape":return t.barreShape=rr.parseEnum(s,yt),!0;case"rasgueado":return t.rasgueado=rr.parseEnum(s,kt),!0;case"showtimer":return t.showTimer=s,!0;case"timer":return t.timer=s,!0;case"style":return s?(t.style=new ee,mr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class wr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>wr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),Se.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,rr.forEach(s,(e,s)=>{t.colors.set(rr.parseEnum(s,O),Se.fromJson(e))}),!0)}}class yr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>yr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("beats",t.beats.map(t=>gr.toJson(t))),t.style&&e.set("style",wr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"beats":t.beats=[];for(const e of s){const s=new se;gr.fromJson(s,e),t.addBeat(s)}return!0;case"style":return s?(t.style=new rt,wr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class kr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>kr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("ratioposition",t.ratioPosition),e.set("pedaltype",t.pedalType),e}static setProperty(t,e,s){switch(e){case"ratioposition":return t.ratioPosition=s,!0;case"pedaltype":return t.pedalType=rr.parseEnum(s,C),!0}return!1}}class Sr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Sr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),Se.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,rr.forEach(s,(e,s)=>{t.colors.set(rr.parseEnum(s,E),Se.fromJson(e))}),!0)}}class Br{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Br.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("clef",t.clef),e.set("clefottava",t.clefOttava),e.set("voices",t.voices.map(t=>yr.toJson(t))),e.set("similemark",t.simileMark),e.set("displayscale",t.displayScale),e.set("displaywidth",t.displayWidth),e.set("sustainpedals",t.sustainPedals.map(t=>kr.toJson(t))),e.set("barlineleft",t.barLineLeft),e.set("barlineright",t.barLineRight),e.set("keysignature",t.keySignature),e.set("keysignaturetype",t.keySignatureType),e.set("barnumberdisplay",t.barNumberDisplay),t.style&&e.set("style",Sr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"clef":return t.clef=rr.parseEnum(s,M),!0;case"clefottava":return t.clefOttava=rr.parseEnum(s,m),!0;case"voices":t.voices=[];for(const e of s){const s=new at;yr.fromJson(s,e),t.addVoice(s)}return!0;case"similemark":return t.simileMark=rr.parseEnum(s,v),!0;case"displayscale":return t.displayScale=s,!0;case"displaywidth":return t.displayWidth=s,!0;case"sustainpedals":t.sustainPedals=[];for(const e of s){const s=new K;kr.fromJson(s,e),t.sustainPedals.push(s)}return!0;case"barlineleft":return t.barLineLeft=rr.parseEnum(s,F),!0;case"barlineright":return t.barLineRight=rr.parseEnum(s,F),!0;case"keysignature":return t.keySignature=rr.parseEnum(s,N),!0;case"keysignaturetype":return t.keySignatureType=rr.parseEnum(s,P),!0;case"barnumberdisplay":return t.barNumberDisplay=rr.parseEnum(s,I),!0;case"style":return s?(t.style=new Q,Sr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class _r{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>_r.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("name",t.name),e.set("firstfret",t.firstFret),e.set("strings",t.strings),e.set("barrefrets",t.barreFrets),e.set("showname",t.showName),e.set("showdiagram",t.showDiagram),e.set("showfingering",t.showFingering),e}static setProperty(t,e,s){switch(e){case"name":return t.name=s,!0;case"firstfret":return t.firstFret=s,!0;case"strings":return t.strings=s,!0;case"barrefrets":return t.barreFrets=s,!0;case"showname":return t.showName=s,!0;case"showdiagram":return t.showDiagram=s,!0;case"showfingering":return t.showFingering=s,!0}return!1}}class Tr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Tr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("isstandard",t.isStandard),e.set("name",t.name),e.set("tunings",t.tunings),e}static setProperty(t,e,s){switch(e){case"isstandard":return t.isStandard=s,!0;case"name":return t.name=s,!0;case"tunings":return t.tunings=s,!0}return!1}}class xr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>xr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("bars",t.bars.map(t=>Br.toJson(t))),null!==t.chords){const s=new Map;e.set("chords",s);for(const[e,i]of t.chords)s.set(e.toString(),_r.toJson(i))}return e.set("capo",t.capo),e.set("transpositionpitch",t.transpositionPitch),e.set("displaytranspositionpitch",t.displayTranspositionPitch),e.set("stringtuning",Tr.toJson(t.stringTuning)),e.set("showslash",t.showSlash),e.set("shownumbered",t.showNumbered),e.set("showtablature",t.showTablature),e.set("showstandardnotation",t.showStandardNotation),e.set("ispercussion",t.isPercussion),e.set("standardnotationlinecount",t.standardNotationLineCount),e}static setProperty(t,e,s){switch(e){case"bars":t.bars=[];for(const e of s){const s=new Z;Br.fromJson(s,e),t.addBar(s)}return!0;case"chords":return t.chords=new Map,rr.forEach(s,(e,s)=>{const i=new ye;_r.fromJson(i,e),t.addChord(s,i)}),!0;case"capo":return t.capo=s,!0;case"transpositionpitch":return t.transpositionPitch=s,!0;case"displaytranspositionpitch":return t.displayTranspositionPitch=s,!0;case"stringtuning":return Tr.fromJson(t.stringTuning,s),!0;case"showslash":return t.showSlash=s,!0;case"shownumbered":return t.showNumbered=s,!0;case"showtablature":return t.showTablature=s,!0;case"showstandardnotation":return t.showStandardNotation=s,!0;case"ispercussion":return t.isPercussion=s,!0;case"standardnotationlinecount":return t.standardNotationLineCount=s,!0}return!1}}class Mr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Mr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("volume",t.volume),e.set("balance",t.balance),e.set("port",t.port),e.set("program",t.program),e.set("bank",t.bank),e.set("primarychannel",t.primaryChannel),e.set("secondarychannel",t.secondaryChannel),e.set("ismute",t.isMute),e.set("issolo",t.isSolo),e}static setProperty(t,e,s){switch(e){case"volume":return t.volume=s,!0;case"balance":return t.balance=s,!0;case"port":return t.port=s,!0;case"program":return t.program=s,!0;case"bank":return t.bank=s,!0;case"primarychannel":return t.primaryChannel=s,!0;case"secondarychannel":return t.secondaryChannel=s,!0;case"ismute":return t.isMute=s,!0;case"issolo":return t.isSolo=s,!0}return!1}}class vr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>vr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("elementtype",t.elementType),e.set("staffline",t.staffLine),e.set("noteheaddefault",t.noteHeadDefault),e.set("noteheadhalf",t.noteHeadHalf),e.set("noteheadwhole",t.noteHeadWhole),e.set("techniquesymbol",t.techniqueSymbol),e.set("techniquesymbolplacement",t.techniqueSymbolPlacement),e.set("outputmidinumber",t.outputMidiNumber),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"elementtype":return t.elementType=s,!0;case"staffline":return t.staffLine=s,!0;case"noteheaddefault":return t.noteHeadDefault=rr.parseEnum(s,ut),!0;case"noteheadhalf":return t.noteHeadHalf=rr.parseEnum(s,ut),!0;case"noteheadwhole":return t.noteHeadWhole=rr.parseEnum(s,ut),!0;case"techniquesymbol":return t.techniqueSymbol=rr.parseEnum(s,ut),!0;case"techniquesymbolplacement":return t.techniqueSymbolPlacement=rr.parseEnum(s,dt),!0;case"outputmidinumber":return t.outputMidiNumber=s,!0}return!1}}class Nr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Nr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),Se.toJson(i))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,rr.forEach(s,(e,s)=>{t.colors.set(rr.parseEnum(s,Wt),Se.fromJson(e))}),!0)}}class Pr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Pr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("staves",t.staves.map(t=>xr.toJson(t))),e.set("playbackinfo",Mr.toJson(t.playbackInfo)),e.set("color",Se.toJson(t.color)),e.set("name",t.name),e.set("isvisibleonmultitrack",t.isVisibleOnMultiTrack),e.set("shortname",t.shortName),e.set("defaultsystemslayout",t.defaultSystemsLayout),e.set("systemslayout",t.systemsLayout),void 0!==t.lineBreaks){const s=[];e.set("linebreaks",s);for(const e of t.lineBreaks)s.push(e)}return e.set("percussionarticulations",t.percussionArticulations.map(t=>vr.toJson(t))),t.style&&e.set("style",Nr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"staves":t.staves=[];for(const e of s){const s=new Me;xr.fromJson(s,e),t.addStaff(s)}return!0;case"playbackinfo":return Mr.fromJson(t.playbackInfo,s),!0;case"color":return t.color=Se.fromJson(s),!0;case"name":return t.name=s,!0;case"isvisibleonmultitrack":return t.isVisibleOnMultiTrack=s,!0;case"shortname":return t.shortName=s,!0;case"defaultsystemslayout":return t.defaultSystemsLayout=s,!0;case"systemslayout":return t.systemsLayout=s,!0;case"linebreaks":for(const e of s)t.addLineBreaks(e);return!0;case"percussionarticulations":t.percussionArticulations=[];for(const e of s){const s=new Jt;vr.fromJson(s,e),t.percussionArticulations.push(s)}return!0;case"style":return s?(t.style=new Ne,Nr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Cr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Cr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("hidedynamics",t.hideDynamics),e.set("bracketextendmode",t.bracketExtendMode),e.set("usesystemsignseparator",t.useSystemSignSeparator),e.set("globaldisplaytuning",t.globalDisplayTuning),null!==t.perTrackDisplayTuning){const s=new Map;e.set("pertrackdisplaytuning",s);for(const[e,i]of t.perTrackDisplayTuning)s.set(e.toString(),i)}if(e.set("globaldisplaychorddiagramsontop",t.globalDisplayChordDiagramsOnTop),null!==t.perTrackChordDiagramsOnTop){const s=new Map;e.set("pertrackchorddiagramsontop",s);for(const[e,i]of t.perTrackChordDiagramsOnTop)s.set(e.toString(),i)}if(e.set("globaldisplaychorddiagramsinscore",t.globalDisplayChordDiagramsInScore),e.set("singletracktracknamepolicy",t.singleTrackTrackNamePolicy),e.set("multitracktracknamepolicy",t.multiTrackTrackNamePolicy),e.set("firstsystemtracknamemode",t.firstSystemTrackNameMode),e.set("othersystemstracknamemode",t.otherSystemsTrackNameMode),e.set("firstsystemtracknameorientation",t.firstSystemTrackNameOrientation),e.set("othersystemstracknameorientation",t.otherSystemsTrackNameOrientation),e.set("multitrackmultibarrest",t.multiTrackMultiBarRest),null!==t.perTrackMultiBarRest){const s=[];e.set("pertrackmultibarrest",s);for(const e of t.perTrackMultiBarRest)s.push(e)}return e.set("extendbarlines",t.extendBarLines),e.set("hideemptystaves",t.hideEmptyStaves),e.set("hideemptystavesinfirstsystem",t.hideEmptyStavesInFirstSystem),e.set("showsinglestaffbrackets",t.showSingleStaffBrackets),e.set("barnumberdisplay",t.barNumberDisplay),e}static setProperty(t,e,s){switch(e){case"hidedynamics":return t.hideDynamics=s,!0;case"bracketextendmode":return t.bracketExtendMode=rr.parseEnum(s,D),!0;case"usesystemsignseparator":return t.useSystemSignSeparator=s,!0;case"globaldisplaytuning":return t.globalDisplayTuning=s,!0;case"pertrackdisplaytuning":return t.perTrackDisplayTuning=new Map,rr.forEach(s,(e,s)=>{t.perTrackDisplayTuning.set(Number.parseInt(s),e)}),!0;case"globaldisplaychorddiagramsontop":return t.globalDisplayChordDiagramsOnTop=s,!0;case"pertrackchorddiagramsontop":return t.perTrackChordDiagramsOnTop=new Map,rr.forEach(s,(e,s)=>{t.perTrackChordDiagramsOnTop.set(Number.parseInt(s),e)}),!0;case"globaldisplaychorddiagramsinscore":return t.globalDisplayChordDiagramsInScore=s,!0;case"singletracktracknamepolicy":return t.singleTrackTrackNamePolicy=rr.parseEnum(s,L),!0;case"multitracktracknamepolicy":return t.multiTrackTrackNamePolicy=rr.parseEnum(s,L),!0;case"firstsystemtracknamemode":return t.firstSystemTrackNameMode=rr.parseEnum(s,W),!0;case"othersystemstracknamemode":return t.otherSystemsTrackNameMode=rr.parseEnum(s,W),!0;case"firstsystemtracknameorientation":return t.firstSystemTrackNameOrientation=rr.parseEnum(s,R),!0;case"othersystemstracknameorientation":return t.otherSystemsTrackNameOrientation=rr.parseEnum(s,R),!0;case"multitrackmultibarrest":return t.multiTrackMultiBarRest=s,!0;case"pertrackmultibarrest":return t.perTrackMultiBarRest=new Set(s),!0;case"extendbarlines":return t.extendBarLines=s,!0;case"hideemptystaves":return t.hideEmptyStaves=s,!0;case"hideemptystavesinfirstsystem":return t.hideEmptyStavesInFirstSystem=s,!0;case"showsinglestaffbrackets":return t.showSingleStaffBrackets=s,!0;case"barnumberdisplay":return t.barNumberDisplay=rr.parseEnum(s,I),!0}return!1}}class Er{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Er.setProperty(t,s,e))}static toJson(t){if(!t)return null;return new Map}static setProperty(t,e,s){return!1}}class Fr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Fr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("template",t.template),e.set("isvisible",t.isVisible),e.set("textalign",t.textAlign),e}static setProperty(t,e,s){switch(e){case"template":return t.template=s,!0;case"isvisible":return t.isVisible=s,!0;case"textalign":return t.textAlign=rr.parseEnum(s,ht),!0}return!1}}class Ar{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Ar.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("headerandfooter",s);for(const[e,i]of t.headerAndFooter)s.set(e.toString(),Fr.toJson(i))}{const s=new Map;e.set("colors",s);for(const[e,i]of t.colors)s.set(e.toString(),Se.toJson(i))}return e}static setProperty(t,e,s){switch(e){case"headerandfooter":return t.headerAndFooter=new Map,rr.forEach(s,(e,s)=>{const i=new Gt;Fr.fromJson(i,e),t.headerAndFooter.set(rr.parseEnum(s,ct),i)}),!0;case"colors":return t.colors=new Map,rr.forEach(s,(e,s)=>{t.colors.set(rr.parseEnum(s,ct),Se.fromJson(e))}),!0}return!1}}class Dr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Dr.setProperty(t,s,e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("album",t.album),e.set("artist",t.artist),e.set("copyright",t.copyright),e.set("instructions",t.instructions),e.set("music",t.music),e.set("notices",t.notices),e.set("subtitle",t.subTitle),e.set("title",t.title),e.set("words",t.words),e.set("tab",t.tab),e.set("masterbars",t.masterBars.map(t=>ur.toJson(t))),e.set("tracks",t.tracks.map(t=>Pr.toJson(t))),e.set("defaultsystemslayout",t.defaultSystemsLayout),e.set("systemslayout",t.systemsLayout),e.set("stylesheet",Cr.toJson(t.stylesheet)),t.backingTrack&&e.set("backingtrack",Er.toJson(t.backingTrack)),t.style&&e.set("style",Ar.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"album":return t.album=s,!0;case"artist":return t.artist=s,!0;case"copyright":return t.copyright=s,!0;case"instructions":return t.instructions=s,!0;case"music":return t.music=s,!0;case"notices":return t.notices=s,!0;case"subtitle":return t.subTitle=s,!0;case"title":return t.title=s,!0;case"words":return t.words=s,!0;case"tab":return t.tab=s,!0;case"masterbars":t.masterBars=[];for(const e of s){const s=new et;ur.fromJson(s,e),t.addMasterBar(s)}return!0;case"tracks":t.tracks=[];for(const e of s){const s=new Pe;Pr.fromJson(s,e),t.addTrack(s)}return!0;case"defaultsystemslayout":return t.defaultSystemsLayout=s,!0;case"systemslayout":return t.systemsLayout=s,!0;case"stylesheet":return Cr.fromJson(t.stylesheet,s),!0;case"backingtrack":return s?(t.backingTrack=new js,Er.fromJson(t.backingTrack,s)):t.backingTrack=void 0,!0;case"style":return s?(t.style=new Vt,Ar.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Lr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Lr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("scriptfile",t.scriptFile),e.set("fontdirectory",t.fontDirectory),null!==t.smuflFontSources){const s=new Map;e.set("smuflfontsources",s);for(const[e,i]of t.smuflFontSources)s.set(e.toString(),i)}return e.set("file",t.file),e.set("tex",t.tex),e.set("tracks",t.tracks),e.set("enablelazyloading",t.enableLazyLoading),e.set("engine",t.engine),e.set("loglevel",t.logLevel),e.set("useworkers",t.useWorkers),e.set("includenotebounds",t.includeNoteBounds),e}static setProperty(e,s,i){switch(s){case"scriptfile":return e.scriptFile=i,!0;case"fontdirectory":return e.fontDirectory=i,!0;case"smuflfontsources":return e.smuflFontSources=new Map,rr.forEach(i,(s,i)=>{e.smuflFontSources.set(rr.parseEnum(i,t.FontFileFormat),s)}),!0;case"file":return e.file=i,!0;case"tex":return e.tex=i,!0;case"tracks":return e.tracks=i,!0;case"enablelazyloading":return e.enableLazyLoading=i,!0;case"engine":return e.engine=i,!0;case"loglevel":return e.logLevel=rr.parseEnum(i,t.LogLevel),!0;case"useworkers":return e.useWorkers=i,!0;case"includenotebounds":return e.includeNoteBounds=i,!0}return!1}}class Wr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Wr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("topy",t.topY),e.set("bottomy",t.bottomY),e.set("x",t.x),e}static setProperty(t,e,s){switch(e){case"topy":return t.topY=s,!0;case"bottomy":return t.bottomY=s,!0;case"x":return t.x=s,!0}return!1}}class Rr{static clone(t){const e=new Or;return e.musicFontSize=t.musicFontSize,e.oneStaffSpace=t.oneStaffSpace,e.tabLineSpacing=t.tabLineSpacing,e.arrowShaftThickness=t.arrowShaftThickness,e.barlineSeparation=t.barlineSeparation,e.beamSpacing=t.beamSpacing,e.beamThickness=t.beamThickness,e.bracketThickness=t.bracketThickness,e.dashedBarlineDashLength=t.dashedBarlineDashLength,e.dashedBarlineGapLength=t.dashedBarlineGapLength,e.dashedBarlineThickness=t.dashedBarlineThickness,e.hairpinThickness=t.hairpinThickness,e.legerLineThickness=t.legerLineThickness,e.legerLineExtension=t.legerLineExtension,e.octaveLineThickness=t.octaveLineThickness,e.pedalLineThickness=t.pedalLineThickness,e.repeatBarlineDotSeparation=t.repeatBarlineDotSeparation,e.repeatEndingLineThickness=t.repeatEndingLineThickness,e.slurMidpointThickness=t.slurMidpointThickness,e.staffLineThickness=t.staffLineThickness,e.stemThickness=t.stemThickness,e.thickBarlineThickness=t.thickBarlineThickness,e.thinBarlineThickness=t.thinBarlineThickness,e.thinThickBarlineSeparation=t.thinThickBarlineSeparation,e.tieMidpointThickness=t.tieMidpointThickness,e.tupletBracketThickness=t.tupletBracketThickness,e.stemUp=new Map(t.stemUp),e.stemDown=new Map(t.stemDown),e.repeatOffsetX=new Map(t.repeatOffsetX),e.standardStemLength=t.standardStemLength,e.stemFlagOffsets=new Map(t.stemFlagOffsets),e.glyphTop=new Map(t.glyphTop),e.glyphBottom=new Map(t.glyphBottom),e.glyphWidths=new Map(t.glyphWidths),e.glyphHeights=new Map(t.glyphHeights),e.numberedBarRendererBarSize=t.numberedBarRendererBarSize,e.numberedBarRendererBarSpacing=t.numberedBarRendererBarSpacing,e.numberedDashGlyphPadding=t.numberedDashGlyphPadding,e.numberedDashGlyphWidth=t.numberedDashGlyphWidth,e.lineRangedGlyphDashGap=t.lineRangedGlyphDashGap,e.lineRangedGlyphDashSize=t.lineRangedGlyphDashSize,e.preNoteEffectPadding=t.preNoteEffectPadding,e.postNoteEffectPadding=t.postNoteEffectPadding,e.onNoteEffectPadding=t.onNoteEffectPadding,e.stringNumberCirclePadding=t.stringNumberCirclePadding,e.rowContainerPadding=t.rowContainerPadding,e.rowContainerGap=t.rowContainerGap,e.alternateEndingsPadding=t.alternateEndingsPadding,e.sustainPedalLinePadding=t.sustainPedalLinePadding,e.tieHeight=t.tieHeight,e.beatTimerPadding=t.beatTimerPadding,e.bendNoteHeadElementPadding=t.bendNoteHeadElementPadding,e.ghostParenthesisWidth=t.ghostParenthesisWidth,e.ghostParenthesisPadding=t.ghostParenthesisPadding,e.brokenBeamWidth=t.brokenBeamWidth,e.tabWhammyTextPadding=t.tabWhammyTextPadding,e.tabWhammyPerHalfHeight=t.tabWhammyPerHalfHeight,e.tabWhammyDashSize=t.tabWhammyDashSize,e.songBookWhammyDipHeight=t.songBookWhammyDipHeight,e.deadSlappedLineWidth=t.deadSlappedLineWidth,e.leftHandTabTieWidth=t.leftHandTabTieWidth,e.tabBendDashSize=t.tabBendDashSize,e.tabBendStaffPadding=t.tabBendStaffPadding,e.tabBendPerValueHeight=t.tabBendPerValueHeight,e.tabBendLabelPadding=t.tabBendLabelPadding,e.simpleSlideWidth=t.simpleSlideWidth,e.simpleSlideHeight=t.simpleSlideHeight,e.chordDiagramPaddingX=t.chordDiagramPaddingX,e.chordDiagramPaddingY=t.chordDiagramPaddingY,e.chordDiagramStringSpacing=t.chordDiagramStringSpacing,e.chordDiagramFretSpacing=t.chordDiagramFretSpacing,e.chordDiagramNutHeight=t.chordDiagramNutHeight,e.chordDiagramFretHeight=t.chordDiagramFretHeight,e.chordDiagramLineWidth=t.chordDiagramLineWidth,e.tripletFeelBracketPadding=t.tripletFeelBracketPadding,e.accidentalPadding=t.accidentalPadding,e.preBeatGlyphSpacing=t.preBeatGlyphSpacing,e.tempoNoteScale=t.tempoNoteScale,e.tuningGlyphCircleNumberScale=t.tuningGlyphCircleNumberScale,e.tuningGlyphStringColumnScale=t.tuningGlyphStringColumnScale,e.tuningGlyphStringRowPadding=t.tuningGlyphStringRowPadding,e.directionsScale=t.directionsScale,e.multiVoiceDisplacedNoteHeadSpacing=t.multiVoiceDisplacedNoteHeadSpacing,e.stemFlagHeight=new Map(t.stemFlagHeight),e}}class Ir{topY=0;bottomY=0;x=0}class Or{static Hf;static GraceScale=.75;static get bravuraDefaults(){let t=Or.Hf;return t||(t=new Or,t.fillFromSmufl(Or.bravuraMetadata),Or.Hf=t),Rr.clone(t)}musicFontSize=0;oneStaffSpace=0;tabLineSpacing=0;arrowShaftThickness=0;barlineSeparation=0;beamSpacing=0;beamThickness=0;bracketThickness=0;dashedBarlineDashLength=0;dashedBarlineGapLength=0;dashedBarlineThickness=0;hairpinThickness=0;legerLineThickness=0;legerLineExtension=0;octaveLineThickness=0;pedalLineThickness=0;repeatBarlineDotSeparation=0;repeatEndingLineThickness=0;slurMidpointThickness=0;staffLineThickness=0;stemThickness=0;thickBarlineThickness=0;thinBarlineThickness=0;thinThickBarlineSeparation=0;tieMidpointThickness=0;tupletBracketThickness=0;stemUp=new Map;stemDown=new Map;repeatOffsetX=new Map;standardStemLength=0;stemFlagOffsets=new Map;glyphTop=new Map;glyphBottom=new Map;glyphWidths=new Map;glyphHeights=new Map;hasSymbol(t){return this.glyphWidths.get(t)>0&&this.glyphHeights.get(t)>0}fillFromSmufl(t,e=36){this.musicFontSize=e,this.oneStaffSpace=e/4,this.tabLineSpacing=Math.floor(1.5*this.oneStaffSpace),this.arrowShaftThickness=t.engravingDefaults.arrowShaftThickness*this.oneStaffSpace,this.barlineSeparation=t.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.beamSpacing=t.engravingDefaults.beamSpacing*this.oneStaffSpace,this.beamThickness=t.engravingDefaults.beamThickness*this.oneStaffSpace,this.bracketThickness=t.engravingDefaults.bracketThickness*this.oneStaffSpace,this.dashedBarlineDashLength=t.engravingDefaults.dashedBarlineDashLength*this.oneStaffSpace,this.dashedBarlineGapLength=t.engravingDefaults.dashedBarlineGapLength*this.oneStaffSpace,this.dashedBarlineThickness=t.engravingDefaults.dashedBarlineThickness*this.oneStaffSpace,this.hairpinThickness=t.engravingDefaults.hairpinThickness*this.oneStaffSpace,this.legerLineExtension=t.engravingDefaults.legerLineExtension*this.oneStaffSpace,this.legerLineThickness=t.engravingDefaults.legerLineThickness*this.oneStaffSpace,this.octaveLineThickness=t.engravingDefaults.octaveLineThickness*this.oneStaffSpace,this.pedalLineThickness=t.engravingDefaults.pedalLineThickness*this.oneStaffSpace,this.repeatBarlineDotSeparation=t.engravingDefaults.repeatBarlineDotSeparation*this.oneStaffSpace,this.repeatEndingLineThickness=t.engravingDefaults.repeatEndingLineThickness*this.oneStaffSpace,this.slurMidpointThickness=t.engravingDefaults.slurMidpointThickness*this.oneStaffSpace,this.staffLineThickness=t.engravingDefaults.staffLineThickness*this.oneStaffSpace,this.stemThickness=t.engravingDefaults.stemThickness*this.oneStaffSpace,this.thickBarlineThickness=t.engravingDefaults.thickBarlineThickness*this.oneStaffSpace,this.thinBarlineThickness=t.engravingDefaults.thinBarlineThickness*this.oneStaffSpace,"number"==typeof t.engravingDefaults.thinThickBarlineSeparation?this.thinThickBarlineSeparation=t.engravingDefaults.thinThickBarlineSeparation*this.oneStaffSpace:this.thinThickBarlineSeparation=t.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.tieMidpointThickness=t.engravingDefaults.tieMidpointThickness*this.oneStaffSpace,this.tupletBracketThickness=t.engravingDefaults.tupletBracketThickness*this.oneStaffSpace;const s=3*this.oneStaffSpace;this.standardStemLength=s,this.stemFlagOffsets.set(l.QuadrupleWhole,0),this.stemFlagOffsets.set(l.DoubleWhole,0),this.stemFlagOffsets.set(l.Whole,0),this.stemFlagOffsets.set(l.Half,0),this.stemFlagOffsets.set(l.Quarter,0),this.stemFlagOffsets.set(l.Eighth,0),this.stemFlagOffsets.set(l.Sixteenth,0),this.stemFlagOffsets.set(l.ThirtySecond,0),this.stemFlagOffsets.set(l.SixtyFourth,0),this.stemFlagOffsets.set(l.OneHundredTwentyEighth,0),this.stemFlagOffsets.set(l.TwoHundredFiftySixth,0),this.stemFlagHeight.set(l.QuadrupleWhole,0),this.stemFlagHeight.set(l.DoubleWhole,0),this.stemFlagHeight.set(l.Whole,0),this.stemFlagHeight.set(l.Half,0),this.stemFlagHeight.set(l.Quarter,0),this.stemFlagHeight.set(l.Eighth,1*this.oneStaffSpace),this.stemFlagHeight.set(l.Sixteenth,1.5*this.oneStaffSpace),this.stemFlagHeight.set(l.ThirtySecond,2*this.oneStaffSpace),this.stemFlagHeight.set(l.SixtyFourth,3*this.oneStaffSpace),this.stemFlagHeight.set(l.OneHundredTwentyEighth,3.5*this.oneStaffSpace),this.stemFlagHeight.set(l.TwoHundredFiftySixth,4.2*this.oneStaffSpace);for(const[e,s]of Object.entries(t.glyphsWithAnchors)){const t=Or.Uf(e);if(t){if(s.stemDownNW){const e=new Ir;e.x=s.stemDownNW[0]*this.oneStaffSpace,e.topY=s.stemDownNW[1]*this.oneStaffSpace,s.stemDownSW?e.bottomY=s.stemDownSW[1]*this.oneStaffSpace:e.bottomY=0,this.stemDown.set(t,e)}if(s.stemUpSE){const e=new Ir,i=s.stemUpSE[0]*this.oneStaffSpace;e.bottomY=s.stemUpSE[1]*this.oneStaffSpace,s.stemUpNW?(e.x=s.stemUpNW[0]*this.oneStaffSpace,e.topY=s.stemUpNW[1]*this.oneStaffSpace):(e.x=i-this.stemThickness,e.topY=0),this.stemUp.set(t,e)}if(s.repeatOffset&&this.repeatOffsetX.set(t,s.repeatOffset[0]*this.oneStaffSpace),s.stemUpNW){const e=s.stemUpNW[1]*this.oneStaffSpace;switch(t){case ut.Flag8thUp:this.stemFlagOffsets.set(l.Eighth,e);break;case ut.Flag16thUp:this.stemFlagOffsets.set(l.Sixteenth,e);break;case ut.Flag32ndUp:this.stemFlagOffsets.set(l.ThirtySecond,e);break;case ut.Flag64thUp:this.stemFlagOffsets.set(l.SixtyFourth,e);break;case ut.Flag128thUp:this.stemFlagOffsets.set(l.OneHundredTwentyEighth,e);break;case ut.Flag256thUp:this.stemFlagOffsets.set(l.TwoHundredFiftySixth,e)}}}}const i=new Set,n=t.glyphBBoxes;if(n)for(const[t,e]of Object.entries(n)){const s=Or.Uf(t);s&&(i.add(s),this.glyphTop.set(s,e.bBoxNE[1]*this.oneStaffSpace),this.glyphBottom.set(s,e.bBoxSW[1]*this.oneStaffSpace),this.glyphWidths.set(s,(e.bBoxNE[0]-e.bBoxSW[0])*this.oneStaffSpace),this.glyphHeights.set(s,(e.bBoxNE[1]-e.bBoxSW[1])*this.oneStaffSpace))}const r=new Set([ut.None,ut.Space,ut.NoteheadNull]);for(const t of jt.getAllMusicFontSymbols())i.has(t)||(r.has(t)||q.warning("SmuFL",`The provided SmuFL font is missing the glyph ${ut[t]} needed by alphaTab, the music notation might not show all details`),this.glyphTop.set(t,0),this.glyphBottom.set(t,0),this.glyphWidths.set(t,0),this.glyphHeights.set(t,0));this.numberedBarRendererBarSize=2*this.staffLineThickness,this.numberedBarRendererBarSpacing=this.beamSpacing,this.preNoteEffectPadding=.4*this.oneStaffSpace,this.postNoteEffectPadding=.2*this.oneStaffSpace,this.lineRangedGlyphDashGap=.5*this.oneStaffSpace,this.lineRangedGlyphDashSize=1*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.stringNumberCirclePadding=.3*this.oneStaffSpace,this.rowContainerPadding=Math.ceil(.3*this.oneStaffSpace),this.rowContainerGap=Math.ceil(1*this.oneStaffSpace),this.onNoteEffectPadding=.2*this.oneStaffSpace,this.alternateEndingsPadding=.3*this.oneStaffSpace,this.sustainPedalLinePadding=.5*this.oneStaffSpace,this.tieHeight=1.2*this.oneStaffSpace,this.beatTimerPadding=.22*this.oneStaffSpace,this.bendNoteHeadElementPadding=.22*this.oneStaffSpace,this.ghostParenthesisWidth=.6*this.oneStaffSpace,this.ghostParenthesisPadding=.3*this.oneStaffSpace,this.brokenBeamWidth=1*this.oneStaffSpace,this.tabWhammyTextPadding=.4*this.oneStaffSpace,this.tabWhammyDashSize=.4*this.oneStaffSpace,this.tabBendDashSize=.4*this.oneStaffSpace,this.songBookWhammyDipHeight=.6*this.oneStaffSpace,this.tabWhammyPerHalfHeight=.6*this.oneStaffSpace,this.tabBendStaffPadding=.5*this.oneStaffSpace,this.tabBendPerValueHeight=.6*this.oneStaffSpace,this.tabBendLabelPadding=.3*this.oneStaffSpace,this.leftHandTabTieWidth=2.2*this.oneStaffSpace,this.numberedDashGlyphWidth=1.5*this.oneStaffSpace,this.deadSlappedLineWidth=.25*this.oneStaffSpace,this.simpleSlideWidth=1.3*this.oneStaffSpace,this.simpleSlideHeight=.3*this.oneStaffSpace,this.chordDiagramPaddingX=Math.ceil(.5*this.oneStaffSpace),this.chordDiagramPaddingY=Math.ceil(.2*this.oneStaffSpace),this.chordDiagramStringSpacing=Math.ceil(1.1*this.oneStaffSpace),this.chordDiagramFretSpacing=Math.ceil(1.3*this.oneStaffSpace),this.chordDiagramNutHeight=Math.ceil(.33*this.oneStaffSpace),this.chordDiagramFretHeight=Math.ceil(.1*this.oneStaffSpace),this.chordDiagramLineWidth=Math.ceil(.11*this.oneStaffSpace),this.tripletFeelBracketPadding=.2*this.oneStaffSpace,this.accidentalPadding=.1*this.oneStaffSpace,this.preBeatGlyphSpacing=.5*this.oneStaffSpace,this.multiVoiceDisplacedNoteHeadSpacing=.2*this.oneStaffSpace,this.tuningGlyphStringRowPadding=.2*this.oneStaffSpace}static smuflNameToGlyphNameMapping=new Map([["4stringTabClef","FourStringTabClef"],["6stringTabClef","SixStringTabClef"]]);static Uf(t){const e=Or.smuflNameToGlyphNameMapping.has(t)?Or.smuflNameToGlyphNameMapping.get(t):t.substring(0,1).toUpperCase()+t.substring(1);return rr.parseEnumExact(e,ut)}numberedBarRendererBarSize=0;numberedBarRendererBarSpacing=0;numberedDashGlyphPadding=0;numberedDashGlyphWidth=0;lineRangedGlyphDashGap=0;lineRangedGlyphDashSize=0;preNoteEffectPadding=0;postNoteEffectPadding=0;onNoteEffectPadding=0;stringNumberCirclePadding=0;rowContainerPadding=0;rowContainerGap=0;alternateEndingsPadding=0;sustainPedalLinePadding=0;tieHeight=0;beatTimerPadding=0;bendNoteHeadElementPadding=0;ghostParenthesisWidth=0;ghostParenthesisPadding=0;brokenBeamWidth=0;tabWhammyTextPadding=0;tabWhammyPerHalfHeight=0;tabWhammyDashSize=0;songBookWhammyDipHeight=0;deadSlappedLineWidth=0;leftHandTabTieWidth=0;tabBendDashSize=0;tabBendStaffPadding=0;tabBendPerValueHeight=0;tabBendLabelPadding=0;simpleSlideWidth=0;simpleSlideHeight=0;chordDiagramPaddingX=0;chordDiagramPaddingY=0;chordDiagramStringSpacing=0;chordDiagramFretSpacing=0;chordDiagramNutHeight=0;chordDiagramFretHeight=0;chordDiagramLineWidth=0;tripletFeelBracketPadding=0;accidentalPadding=0;preBeatGlyphSpacing=0;tempoNoteScale=.7;tuningGlyphCircleNumberScale=.7;tuningGlyphStringColumnScale=1.5;tuningGlyphStringRowPadding=0;directionsScale=.6;multiVoiceDisplacedNoteHeadSpacing=0;getStemLength(t,e){return this.standardStemLength+(e?this.stemFlagOffsets.get(t):0)}stemFlagHeight=new Map;static bravuraMetadata={engravingDefaults:{arrowShaftThickness:.16,barlineSeparation:.4,beamSpacing:.25,beamThickness:.5,bracketThickness:.5,dashedBarlineDashLength:.5,dashedBarlineGapLength:.25,dashedBarlineThickness:.16,hairpinThickness:.16,legerLineExtension:.4,legerLineThickness:.16,lyricLineThickness:.16,octaveLineThickness:.16,pedalLineThickness:.16,repeatBarlineDotSeparation:.16,repeatEndingLineThickness:.16,slurEndpointThickness:.1,slurMidpointThickness:.22,staffLineThickness:.13,stemThickness:.12,subBracketThickness:.16,textEnclosureThickness:.16,thickBarlineThickness:.5,thinBarlineThickness:.16,tieEndpointThickness:.1,tieMidpointThickness:.22,thinThickBarlineSeparation:.4,tupletBracketThickness:.16},glyphBBoxes:{FourStringTabClef:{bBoxNE:[1.088,2.016],bBoxSW:[-.012,-2.032]},SixStringTabClef:{bBoxNE:[1.632,3.056],bBoxSW:[-.012,-2.992]},accidentalDoubleFlat:{bBoxNE:[1.644,1.748],bBoxSW:[0,-.7]},accidentalDoubleSharp:{bBoxNE:[.988,.508],bBoxSW:[0,-.5]},accidentalFlat:{bBoxNE:[.904,1.756],bBoxSW:[0,-.7]},accidentalNatural:{bBoxNE:[.672,1.364],bBoxSW:[0,-1.34]},accidentalQuarterToneFlatArrowUp:{bBoxNE:[.992,2.316],bBoxSW:[-.168,-.708]},accidentalQuarterToneSharpNaturalArrowUp:{bBoxNE:[.848,2.188],bBoxSW:[-.104,-1.36]},accidentalSharp:{bBoxNE:[.996,1.4],bBoxSW:[0,-1.392]},accidentalThreeQuarterTonesSharpArrowUp:{bBoxNE:[1.1,2.12],bBoxSW:[0,-1.388]},arrowheadBlackDown:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},arrowheadBlackUp:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},articAccentAbove:{bBoxNE:[1.356,.98],bBoxSW:[0,.004]},articAccentBelow:{bBoxNE:[1.356,0],bBoxSW:[0,-.976]},articMarcatoAbove:{bBoxNE:[.94,1.012],bBoxSW:[-.004,-.004]},articMarcatoBelow:{bBoxNE:[.94,0],bBoxSW:[-.004,-1.016]},articStaccatoAbove:{bBoxNE:[.336,.336],bBoxSW:[0,0]},articStaccatoBelow:{bBoxNE:[.336,0],bBoxSW:[0,-.336]},articTenutoAbove:{bBoxNE:[1.352,.192],bBoxSW:[-.004,0]},articTenutoBelow:{bBoxNE:[1.352,0],bBoxSW:[-.004,-.192]},augmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},brace:{bBoxNE:[.328,3.988],bBoxSW:[.008,0]},bracketBottom:{bBoxNE:[1.876,0],bBoxSW:[0,-1.18]},bracketTop:{bBoxNE:[1.876,1.18],bBoxSW:[0,0]},buzzRoll:{bBoxNE:[.624,.464],bBoxSW:[-.62,-.464]},cClef:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.024]},cClef8vb:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.964]},clef15:{bBoxNE:[1.436,1.02],bBoxSW:[0,-.012]},clef8:{bBoxNE:[.82,.988],bBoxSW:[0,0]},coda:{bBoxNE:[3.82,3.592],bBoxSW:[-.016,-.632]},dynamicCrescendoHairpin:{bBoxNE:[2.944,1.424],bBoxSW:[.016,.372]},dynamicFF:{bBoxNE:[2.44,1.776],bBoxSW:[-.54,-.608]},dynamicFFF:{bBoxNE:[3.32,1.776],bBoxSW:[-.62,-.608]},dynamicFFFF:{bBoxNE:[4.28,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFF:{bBoxNE:[5.24,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFFF:{bBoxNE:[6.2,1.776],bBoxSW:[-.62,-.608]},dynamicForte:{bBoxNE:[1.456,1.776],bBoxSW:[-.564,-.608]},dynamicFortePiano:{bBoxNE:[2.476,1.776],bBoxSW:[-.564,-.608]},dynamicForzando:{bBoxNE:[1.988,1.776],bBoxSW:[-.564,-.608]},dynamicMF:{bBoxNE:[3.272,1.724],bBoxSW:[-.08,-.66]},dynamicMP:{bBoxNE:[3.3,1.096],bBoxSW:[-.08,-.568]},dynamicNiente:{bBoxNE:[1.232,1.096],bBoxSW:[-.092,-.04]},dynamicPF:{bBoxNE:[3.08,1.776],bBoxSW:[-.288,-.608]},dynamicPP:{bBoxNE:[2.912,1.096],bBoxSW:[-.328,-.568]},dynamicPPP:{bBoxNE:[4.292,1.096],bBoxSW:[-.368,-.568]},dynamicPPPP:{bBoxNE:[5.672,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPP:{bBoxNE:[7.092,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPPP:{bBoxNE:[8.512,1.096],bBoxSW:[-.408,-.568]},dynamicPiano:{bBoxNE:[1.464,1.096],bBoxSW:[-.356,-.568]},dynamicRinforzando1:{bBoxNE:[2.5,1.776],bBoxSW:[-.08,-.608]},dynamicRinforzando2:{bBoxNE:[2.976,1.776],bBoxSW:[-.08,-.608]},dynamicSforzando1:{bBoxNE:[2.416,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPianissimo:{bBoxNE:[4.796,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPiano:{bBoxNE:[3.38,1.776],bBoxSW:[0,-.608]},dynamicSforzato:{bBoxNE:[2.932,1.776],bBoxSW:[0,-.608]},dynamicSforzatoFF:{bBoxNE:[3.856,1.776],bBoxSW:[0,-.608]},dynamicSforzatoPiano:{bBoxNE:[4.304,1.776],bBoxSW:[0,-.608]},fClef:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.54]},fClef15ma:{bBoxNE:[2.736,1.984],bBoxSW:[-.02,-2.54]},fClef15mb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.968]},fClef8va:{bBoxNE:[2.736,1.98],bBoxSW:[-.02,-2.54]},fClef8vb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.976]},fermataAbove:{bBoxNE:[2.42,1.316],bBoxSW:[.012,-.012]},fermataLongAbove:{bBoxNE:[2.412,1.332],bBoxSW:[0,-.004]},fermataShortAbove:{bBoxNE:[2.416,1.364],bBoxSW:[0,0]},fingering0:{bBoxNE:[.94,1.004],bBoxSW:[.08,-.004]},fingering1:{bBoxNE:[.548,1.016],bBoxSW:[.08,0]},fingering2:{bBoxNE:[.888,1.012],bBoxSW:[.08,-.012]},fingering3:{bBoxNE:[.82,1.008],bBoxSW:[.08,0]},fingering4:{bBoxNE:[.864,1.012],bBoxSW:[.08,.004]},fingering5:{bBoxNE:[.82,1.032],bBoxSW:[.08,0]},fingeringALower:{bBoxNE:[1.068,1.032],bBoxSW:[0,-.02]},fingeringCLower:{bBoxNE:[.888,1.044],bBoxSW:[0,-.028]},fingeringILower:{bBoxNE:[.656,1.54],bBoxSW:[-.052,-.028]},fingeringMLower:{bBoxNE:[1.66,1.028],bBoxSW:[-.032,-.016]},fingeringPLower:{bBoxNE:[1.088,1.028],bBoxSW:[-.216,-.612]},fingeringTLower:{bBoxNE:[.604,1.484],bBoxSW:[0,-.028]},flag128thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-2.32]},flag128thUp:{bBoxNE:[1.044,2.132],bBoxSW:[0,-3.248]},flag16thDown:{bBoxNE:[1.1635806326044895,3.2480256],bBoxSW:[0,-.036]},flag16thUp:{bBoxNE:[1.116,.008],bBoxSW:[0,-3.252]},flag256thDown:{bBoxNE:[1.196,3.252],bBoxSW:[0,-3.004]},flag256thUp:{bBoxNE:[1.056,2.816],bBoxSW:[0,-3.248]},flag32ndDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-.688]},flag32ndUp:{bBoxNE:[1.044,.596],bBoxSW:[0,-3.248]},flag64thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-1.504]},flag64thUp:{bBoxNE:[1.044,1.388],bBoxSW:[0,-3.248]},flag8thDown:{bBoxNE:[1.224,3.232896633157715],bBoxSW:[0,-.056]},flag8thUp:{bBoxNE:[1.056,.036],bBoxSW:[0,-3.240768470618394]},fretboardFilledCircle:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardO:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardX:{bBoxNE:[.596,.596],bBoxSW:[0,0]},gClef:{bBoxNE:[2.684,4.392],bBoxSW:[0,-2.632]},gClef15ma:{bBoxNE:[2.684,5.276],bBoxSW:[0,-2.632]},gClef15mb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.524]},gClef8va:{bBoxNE:[2.684,5.28],bBoxSW:[0,-2.632]},gClef8vb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.512]},graceNoteSlashStemDown:{bBoxNE:[2.02,0],bBoxSW:[0,-1.604]},graceNoteSlashStemUp:{bBoxNE:[2.02,1.604],bBoxSW:[0,0]},guitarClosePedal:{bBoxNE:[1.144,1.14],bBoxSW:[0,-.004]},guitarFadeIn:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarFadeOut:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarGolpe:{bBoxNE:[1.08,1.128],bBoxSW:[.004,0]},guitarLeftHandTapping:{bBoxNE:[1.588,1.364],bBoxSW:[0,-.224]},guitarOpenPedal:{bBoxNE:[1.144,1.144],bBoxSW:[0,0]},guitarString0:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString1:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString2:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString3:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString4:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString5:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString6:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString7:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString8:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString9:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarVibratoStroke:{bBoxNE:[.668,.476],bBoxSW:[-.056,0]},guitarVolumeSwell:{bBoxNE:[2.896,1.46],bBoxSW:[0,0]},guitarWideVibratoStroke:{bBoxNE:[.908,.896],bBoxSW:[-.096,0]},keyboardPedalPed:{bBoxNE:[4.076,2.22],bBoxSW:[0,-.032]},keyboardPedalUp:{bBoxNE:[1.8,1.8],bBoxSW:[0,0]},metAugmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},metNote8thUp:{bBoxNE:[2.132,2.784],bBoxSW:[0,-.564]},metNoteQuarterUp:{bBoxNE:[1.328,2.752],bBoxSW:[0,-.564]},note8thUp:{bBoxNE:[2.264,3.492],bBoxSW:[0,-.552]},noteQuarterUp:{bBoxNE:[1.328,3.5],bBoxSW:[0,-.564]},noteShapeDiamondBlack:{bBoxNE:[1.444,.548],bBoxSW:[0,-.552]},noteShapeDiamondWhite:{bBoxNE:[1.444,.544],bBoxSW:[0,-.556]},noteShapeMoonBlack:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeMoonWhite:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeRoundBlack:{bBoxNE:[1.456,.552],bBoxSW:[0,-.552]},noteShapeRoundWhite:{bBoxNE:[1.464,.548],bBoxSW:[0,-.548]},noteShapeSquareBlack:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeSquareWhite:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeTriangleLeftBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleLeftWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteheadBlack:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadCircleSlash:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleX:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircleXDoubleWhole:{bBoxNE:[1.688,.62],bBoxSW:[0,-.62]},noteheadCircleXHalf:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleXWhole:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircledBlack:{bBoxNE:[1.284,.668],bBoxSW:[-.084,-.684]},noteheadCircledDoubleWhole:{bBoxNE:[2.412,.852],bBoxSW:[0,-.872]},noteheadCircledHalf:{bBoxNE:[1.244,.668],bBoxSW:[-.072,-.648]},noteheadCircledWhole:{bBoxNE:[1.748,.844],bBoxSW:[0,-.9]},noteheadClusterDoubleWhole3rd:{bBoxNE:[2.428,1.62],bBoxSW:[0,-.62]},noteheadClusterHalf3rd:{bBoxNE:[1.264,1.5],bBoxSW:[0,-.5]},noteheadClusterQuarter3rd:{bBoxNE:[1.44,1.5],bBoxSW:[0,-.5]},noteheadClusterWhole3rd:{bBoxNE:[1.7,1.5],bBoxSW:[0,-.5]},noteheadDiamondBlack:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondBlackWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondDoubleWhole:{bBoxNE:[1.728,.62],bBoxSW:[0,-.62]},noteheadDiamondHalf:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadDiamondWhite:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondWhiteWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondWhole:{bBoxNE:[1.08,.5],bBoxSW:[0,-.5]},noteheadDoubleWhole:{bBoxNE:[2.396,.62],bBoxSW:[0,-.62]},noteheadDoubleWholeSquare:{bBoxNE:[1.664,.792],bBoxSW:[0,-.76]},noteheadHalf:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadHeavyX:{bBoxNE:[1.54,.5],bBoxSW:[0,-.5]},noteheadHeavyXHat:{bBoxNE:[1.828,1.04],bBoxSW:[-.292,-.5]},noteheadParenthesis:{bBoxNE:[1.472,.728],bBoxSW:[-.292,-.72]},noteheadPlusBlack:{bBoxNE:[.996,.5],bBoxSW:[-.004,-.5]},noteheadPlusDoubleWhole:{bBoxNE:[1.892,.62],bBoxSW:[0,-.62]},noteheadPlusHalf:{bBoxNE:[1.044,.5],bBoxSW:[0,-.5]},noteheadPlusWhole:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadRoundWhiteWithDot:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadSlashHorizontalEnds:{bBoxNE:[2.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteHalf:{bBoxNE:[3.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteWhole:{bBoxNE:[3.92,1],bBoxSW:[0,-1]},noteheadSlashedBlack1:{bBoxNE:[1.5,.668],bBoxSW:[-.32,-.66]},noteheadSlashedBlack2:{bBoxNE:[1.504,.672],bBoxSW:[-.316,-.656]},noteheadSlashedDoubleWhole1:{bBoxNE:[2.384,.672],bBoxSW:[0,-.716]},noteheadSlashedDoubleWhole2:{bBoxNE:[2.384,.676],bBoxSW:[0,-.712]},noteheadSlashedHalf1:{bBoxNE:[1.544,.64],bBoxSW:[-.268,-.568]},noteheadSlashedHalf2:{bBoxNE:[1.52,.672],bBoxSW:[-.292,-.536]},noteheadSlashedWhole1:{bBoxNE:[1.732,.592],bBoxSW:[-.088,-.628]},noteheadSlashedWhole2:{bBoxNE:[1.744,.604],bBoxSW:[-.072,-.616]},noteheadSquareBlack:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadSquareBlackLarge:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareBlackWhite:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareWhite:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadTriangleDownBlack:{bBoxNE:[1.168,.5],bBoxSW:[0,-.5]},noteheadTriangleDownDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleDownHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleDownWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadTriangleRightBlack:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleRightWhite:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleUpBlack:{bBoxNE:[1.172,.5],bBoxSW:[0,-.5]},noteheadTriangleUpDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleUpHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleUpWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadWhole:{bBoxNE:[1.688,.5],bBoxSW:[0,-.5]},noteheadXBlack:{bBoxNE:[1.16,.5],bBoxSW:[0,-.5]},noteheadXDoubleWhole:{bBoxNE:[2.184,.62],bBoxSW:[0,-.62]},noteheadXHalf:{bBoxNE:[1.336,.5],bBoxSW:[0,-.5]},noteheadXOrnate:{bBoxNE:[.988,.504],bBoxSW:[0,-.504]},noteheadXWhole:{bBoxNE:[1.508,.5],bBoxSW:[0,-.5]},octaveBaselineB:{bBoxNE:[.796,1.352],bBoxSW:[0,-.04]},octaveBaselineM:{bBoxNE:[1.524,.928],bBoxSW:[0,-.02]},ornamentMordent:{bBoxNE:[2.916,1.276],bBoxSW:[.004,-.292]},ornamentShortTrill:{bBoxNE:[2.9,.98],bBoxSW:[0,0]},ornamentTrill:{bBoxNE:[2.084,1.56],bBoxSW:[0,-.04]},ornamentTurn:{bBoxNE:[1.84,.872],bBoxSW:[0,0]},ornamentTurnInverted:{bBoxNE:[1.828,.872],bBoxSW:[-.012,0]},ottava:{bBoxNE:[1.544,1.852],bBoxSW:[0,-.04]},ottavaAlta:{bBoxNE:[3.54,1.852],bBoxSW:[0,-.04]},ottavaBassaVb:{bBoxNE:[3.184,1.852],bBoxSW:[0,-.04]},pictEdgeOfCymbal:{bBoxNE:[4.828,2.14],bBoxSW:[.004,0]},quindicesima:{bBoxNE:[2.668,1.844],bBoxSW:[0,-.04]},quindicesimaAlta:{bBoxNE:[5.26,1.844],bBoxSW:[0,-.04]},repeat1Bar:{bBoxNE:[2.128,1.116],bBoxSW:[0,-1]},repeat2Bars:{bBoxNE:[3.048,1.116],bBoxSW:[0,-1]},repeatDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},rest128th:{bBoxNE:[1.94,2.756],bBoxSW:[0,-3]},rest16th:{bBoxNE:[1.28,.716],bBoxSW:[0,-2]},rest256th:{bBoxNE:[2.164,2.784],bBoxSW:[0,-4]},rest32nd:{bBoxNE:[1.452,1.704],bBoxSW:[0,-2]},rest64th:{bBoxNE:[1.692,1.72],bBoxSW:[0,-3.012]},rest8th:{bBoxNE:[.988,.696],bBoxSW:[0,-1.004]},restDoubleWhole:{bBoxNE:[.5,1],bBoxSW:[0,0]},restHBarLeft:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHBarMiddle:{bBoxNE:[1.42,.384],bBoxSW:[-.108,-.416]},restHBarRight:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHalf:{bBoxNE:[1.128,.568],bBoxSW:[0,-.008]},restLonga:{bBoxNE:[.5,1],bBoxSW:[0,-.996]},restQuarter:{bBoxNE:[1.08,1.492],bBoxSW:[.004,-1.5]},restWhole:{bBoxNE:[1.128,.036],bBoxSW:[0,-.54]},segno:{bBoxNE:[2.2,3.036],bBoxSW:[.016,-.108]},stringsDownBow:{bBoxNE:[1.248,1.272],bBoxSW:[0,0]},stringsUpBow:{bBoxNE:[.996,1.98],bBoxSW:[.004,.004]},systemDivider:{bBoxNE:[4.232,4.24],bBoxSW:[0,-.272]},textAugmentationDot:{bBoxNE:[.4,.256],bBoxSW:[0,-.144]},textBlackNoteFrac16thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac32ndLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac8thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteLongStem:{bBoxNE:[1.328,3.512],bBoxSW:[0,-.564]},textCont16thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,2.264]},textCont32ndBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,1.504]},textCont8thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,3.012]},textTuplet3LongStem:{bBoxNE:[.94,5.3],bBoxSW:[0,4.2]},textTupletBracketEndLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},textTupletBracketStartLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},timeSig0:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig1:{bBoxNE:[1.256,1.004],bBoxSW:[.08,-1]},timeSig2:{bBoxNE:[1.704,1.016],bBoxSW:[.08,-1.028]},timeSig3:{bBoxNE:[1.604,.996],bBoxSW:[.08,-1.004]},timeSig4:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig5:{bBoxNE:[1.532,.984],bBoxSW:[.08,-1.004]},timeSig6:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSig7:{bBoxNE:[1.684,.996],bBoxSW:[.08,-1]},timeSig8:{bBoxNE:[1.664,1.036],bBoxSW:[.08,-1.036]},timeSig9:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSigCommon:{bBoxNE:[1.696,1.004],bBoxSW:[.02,-.996]},timeSigCutCommon:{bBoxNE:[1.672,1.444],bBoxSW:[0,-1.436]},tremolo1:{bBoxNE:[.6,.376],bBoxSW:[-.6,-.372]},tremolo2:{bBoxNE:[.596,.748],bBoxSW:[-.604,-.748]},tremolo3:{bBoxNE:[.6,1.112],bBoxSW:[-.6,-1.12]},tremolo4:{bBoxNE:[.6,1.496],bBoxSW:[-.6,-1.48]},tremolo5:{bBoxNE:[.6,1.88],bBoxSW:[-.604,-1.84]},tuplet0:{bBoxNE:[1.2731041262817027,1.5],bBoxSW:[-.001204330173715796,-.032]},tuplet1:{bBoxNE:[1.024,1.488],bBoxSW:[.04,0]},tuplet2:{bBoxNE:[1.316,1.5],bBoxSW:[.04,-.024]},tuplet3:{bBoxNE:[1.224,1.5],bBoxSW:[.04,-.032]},tuplet4:{bBoxNE:[1.252,1.488],bBoxSW:[.04,0]},tuplet5:{bBoxNE:[1.308,1.492],bBoxSW:[.04,-.032]},tuplet6:{bBoxNE:[1.256,1.5],bBoxSW:[.04105974105482295,-.032]},tuplet7:{bBoxNE:[1.332,1.488],bBoxSW:[.12,-.016]},tuplet8:{bBoxNE:[1.292,1.5],bBoxSW:[.04,-.032]},tuplet9:{bBoxNE:[1.254940258945177,1.5],bBoxSW:[.04,-.032]},tupletColon:{bBoxNE:[.484,1.072],bBoxSW:[.04,.232]},unpitchedPercussionClef1:{bBoxNE:[1.528,1],bBoxSW:[0,-1]},wiggleSawtooth:{bBoxNE:[3.06,1.06],bBoxSW:[-.068,-1.068]},wiggleSawtoothNarrow:{bBoxNE:[2.06,1.064],bBoxSW:[-.072,-1.064]},wiggleTrill:{bBoxNE:[1.08,.836],bBoxSW:[-.144,.392]},wiggleVibratoMediumFast:{bBoxNE:[1.292,.8],bBoxSW:[-.104,-.164]}},glyphsWithAnchors:{accidentalDoubleFlat:{cutOutNE:[.988,.644],cutOutSE:[1.336,-.396]},accidentalFlat:{cutOutNE:[.252,.656],cutOutSE:[.504,-.476]},accidentalNatural:{cutOutNE:[.192,.776],cutOutSW:[.476,-.828]},accidentalQuarterToneFlatArrowUp:{cutOutNE:[.604,.664],cutOutSE:[.62,-.452]},accidentalQuarterToneSharpNaturalArrowUp:{cutOutSW:[.616,-.868]},accidentalSharp:{cutOutNE:[.84,.896],cutOutNW:[.144,.568],cutOutSE:[.84,-.596],cutOutSW:[.144,-.896]},accidentalThreeQuarterTonesSharpArrowUp:{cutOutNW:[.272,1.304],cutOutSE:[.86,-.584],cutOutSW:[.132,-.888]},dynamicFF:{opticalCenter:[1.852,0]},dynamicFFF:{opticalCenter:[2.472,0]},dynamicFFFF:{opticalCenter:[2.824,0]},dynamicFFFFF:{opticalCenter:[2.976,0]},dynamicFFFFFF:{opticalCenter:[3.504,0]},dynamicForte:{opticalCenter:[1.256,0]},dynamicFortePiano:{opticalCenter:[1.5,0]},dynamicForzando:{opticalCenter:[1.352,0]},dynamicMF:{opticalCenter:[1.796,0]},dynamicMP:{opticalCenter:[1.848,0]},dynamicNiente:{opticalCenter:[.616,0]},dynamicPF:{opticalCenter:[1.68,0]},dynamicPP:{opticalCenter:[1.708,0]},dynamicPPP:{opticalCenter:[2.368,0]},dynamicPPPP:{opticalCenter:[3.004,0]},dynamicPPPPP:{opticalCenter:[3.552,0]},dynamicPPPPPP:{opticalCenter:[4.248,0]},dynamicPiano:{opticalCenter:[1.22,0]},dynamicRinforzando1:{opticalCenter:[1.564,0]},dynamicRinforzando2:{opticalCenter:[2.084,0]},dynamicSforzando1:{opticalCenter:[1.3,0]},dynamicSforzandoPianissimo:{opticalCenter:[1.972,0]},dynamicSforzandoPiano:{opticalCenter:[1.904,0]},dynamicSforzato:{opticalCenter:[1.76,0]},dynamicSforzatoFF:{opticalCenter:[2.276,0]},dynamicSforzatoPiano:{opticalCenter:[1.848,0]},flag128thDown:{stemDownSW:[0,-2.076]},flag128thUp:{stemUpNW:[0,1.9]},flag16thDown:{stemDownSW:[0,.128]},flag16thUp:{stemUpNW:[0,-.088]},flag256thDown:{stemDownSW:[0,-2.812]},flag256thUp:{stemUpNW:[0,2.592]},flag32ndDown:{stemDownSW:[0,-.448]},flag32ndUp:{stemUpNW:[0,.376]},flag64thDown:{stemDownSW:[0,-1.244]},flag64thUp:{stemUpNW:[0,1.172]},flag8thDown:{graceNoteSlashNW:[-.596,2.168],graceNoteSlashSE:[1.328,.628],stemDownSW:[0,.132]},flag8thUp:{graceNoteSlashNE:[1.284,-.796],graceNoteSlashSW:[-.644,-2.456],stemUpNW:[0,-.04]},guitarVibratoStroke:{repeatOffset:[.608,0]},guitarWideVibratoStroke:{repeatOffset:[.82,0]},noteShapeDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1.444,0]},noteShapeDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1.436,0]},noteShapeMoonBlack:{stemDownNW:[0,.068],stemUpSE:[1.44,.068]},noteShapeMoonWhite:{stemDownNW:[0,.072],stemUpSE:[1.444,.068]},noteShapeRoundBlack:{stemDownNW:[0,-.168],stemUpSE:[1.444,.184]},noteShapeRoundWhite:{stemDownNW:[0,-.168],stemUpSE:[1.456,.192]},noteShapeSquareBlack:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeSquareWhite:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeTriangleLeftBlack:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleLeftWhite:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleRightBlack:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRightWhite:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRoundBlack:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleRoundWhite:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteShapeTriangleUpWhite:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteheadBlack:{cutOutNW:[.208,.3],cutOutSE:[.94,-.296],splitStemDownNE:[.968,-.248],splitStemDownNW:[.12,-.416],splitStemUpSE:[1.092,.392],splitStemUpSW:[.312,.356],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadCircleSlash:{stemDownNW:[.004,0],stemUpSE:[1,0]},noteheadCircleX:{stemDownNW:[0,0],stemUpSE:[.996,0]},noteheadCircleXDoubleWhole:{noteheadOrigin:[.352,0]},noteheadCircleXHalf:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadCircledBlack:{stemDownNW:[0,-.164],stemUpSE:[1.18,.168]},noteheadCircledDoubleWhole:{noteheadOrigin:[.356,0]},noteheadCircledHalf:{stemDownNW:[0,-.144],stemUpSE:[1.172,.156]},noteheadClusterDoubleWhole3rd:{noteheadOrigin:[.364,0]},noteheadClusterHalf3rd:{stemDownNW:[0,-.164],stemUpSE:[1.264,1.144]},noteheadClusterQuarter3rd:{stemDownNW:[0,.26],stemUpSE:[1.44,.744]},noteheadDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondBlackWide:{stemDownNW:[0,0],stemUpSE:[1.4,0]},noteheadDiamondDoubleWhole:{noteheadOrigin:[.324,0]},noteheadDiamondHalf:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondWhiteWide:{stemDownNW:[0,.004],stemUpSE:[1.4,0]},noteheadDoubleWhole:{noteheadOrigin:[.36,0]},noteheadHalf:{cutOutNW:[.204,.296],cutOutSE:[.98,-.3],splitStemDownNE:[.956,-.3],splitStemDownNW:[.128,-.428],splitStemUpSE:[1.108,.372],splitStemUpSW:[.328,.38],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadHeavyX:{stemDownNW:[0,-.436],stemUpSE:[1.54,.44]},noteheadHeavyXHat:{stemDownNW:[0,-.436],stemUpSE:[1.54,.456]},noteheadPlusBlack:{stemDownNW:[-.004,0],stemUpSE:[.996,0]},noteheadPlusDoubleWhole:{noteheadOrigin:[.372,0]},noteheadPlusHalf:{stemDownNW:[0,-.112],stemUpSE:[1.044,.088]},noteheadRoundWhiteWithDot:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadSlashHorizontalEnds:{stemDownNW:[0,-1],stemUpSE:[2.12,1]},noteheadSlashWhiteHalf:{stemDownNW:[0,-1],stemUpSE:[3.12,1]},noteheadSlashedBlack1:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedBlack2:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedDoubleWhole1:{noteheadOrigin:[.356,0]},noteheadSlashedDoubleWhole2:{noteheadOrigin:[.356,0]},noteheadSlashedHalf1:{stemDownNW:[0,-.168],stemUpSE:[1.168,.164]},noteheadSlashedHalf2:{stemDownNW:[0,-.164],stemUpSE:[1.172,.168]},noteheadSquareBlack:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadSquareBlackLarge:{stemDownNW:[0,0],stemUpSE:[2,0]},noteheadSquareBlackWhite:{stemDownNW:[0,-1],stemUpSE:[2,1]},noteheadSquareWhite:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadTriangleDownBlack:{stemDownNW:[0,.5],stemUpSE:[1.168,.5]},noteheadTriangleDownDoubleWhole:{noteheadOrigin:[.384,0]},noteheadTriangleDownHalf:{stemDownNW:[0,.464],stemUpSE:[1.14,.464]},noteheadTriangleRightBlack:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleRightWhite:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.172,-.5]},noteheadTriangleUpDoubleWhole:{noteheadOrigin:[.34,0]},noteheadTriangleUpHalf:{stemDownNW:[0,-.46],stemUpSE:[1.14,-.46]},noteheadWhole:{cutOutNW:[.172,.332],cutOutSE:[1.532,-.364]},noteheadXBlack:{stemDownNW:[0,-.44],stemUpSE:[1.16,.444]},noteheadXDoubleWhole:{noteheadOrigin:[.348,0]},noteheadXHalf:{stemDownNW:[0,-.412],stemUpSE:[1.336,.412]},noteheadXOrnate:{stemDownNW:[0,-.312],stemUpSE:[.988,.316]},wiggleSawtooth:{repeatOffset:[2.992,0]},wiggleSawtoothNarrow:{repeatOffset:[1.996,0]},wiggleTrill:{repeatOffset:[.948,0]},wiggleVibratoMediumFast:{repeatOffset:[1.18,0]}}}}class Gr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Gr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;e.set("musicfontsize",t.musicFontSize),e.set("onestaffspace",t.oneStaffSpace),e.set("tablinespacing",t.tabLineSpacing),e.set("arrowshaftthickness",t.arrowShaftThickness),e.set("barlineseparation",t.barlineSeparation),e.set("beamspacing",t.beamSpacing),e.set("beamthickness",t.beamThickness),e.set("bracketthickness",t.bracketThickness),e.set("dashedbarlinedashlength",t.dashedBarlineDashLength),e.set("dashedbarlinegaplength",t.dashedBarlineGapLength),e.set("dashedbarlinethickness",t.dashedBarlineThickness),e.set("hairpinthickness",t.hairpinThickness),e.set("legerlinethickness",t.legerLineThickness),e.set("legerlineextension",t.legerLineExtension),e.set("octavelinethickness",t.octaveLineThickness),e.set("pedallinethickness",t.pedalLineThickness),e.set("repeatbarlinedotseparation",t.repeatBarlineDotSeparation),e.set("repeatendinglinethickness",t.repeatEndingLineThickness),e.set("slurmidpointthickness",t.slurMidpointThickness),e.set("stafflinethickness",t.staffLineThickness),e.set("stemthickness",t.stemThickness),e.set("thickbarlinethickness",t.thickBarlineThickness),e.set("thinbarlinethickness",t.thinBarlineThickness),e.set("thinthickbarlineseparation",t.thinThickBarlineSeparation),e.set("tiemidpointthickness",t.tieMidpointThickness),e.set("tupletbracketthickness",t.tupletBracketThickness);{const s=new Map;e.set("stemup",s);for(const[e,i]of t.stemUp)s.set(e.toString(),Wr.toJson(i))}{const s=new Map;e.set("stemdown",s);for(const[e,i]of t.stemDown)s.set(e.toString(),Wr.toJson(i))}{const s=new Map;e.set("repeatoffsetx",s);for(const[e,i]of t.repeatOffsetX)s.set(e.toString(),i)}e.set("standardstemlength",t.standardStemLength);{const s=new Map;e.set("stemflagoffsets",s);for(const[e,i]of t.stemFlagOffsets)s.set(e.toString(),i)}{const s=new Map;e.set("glyphtop",s);for(const[e,i]of t.glyphTop)s.set(e.toString(),i)}{const s=new Map;e.set("glyphbottom",s);for(const[e,i]of t.glyphBottom)s.set(e.toString(),i)}{const s=new Map;e.set("glyphwidths",s);for(const[e,i]of t.glyphWidths)s.set(e.toString(),i)}{const s=new Map;e.set("glyphheights",s);for(const[e,i]of t.glyphHeights)s.set(e.toString(),i)}e.set("numberedbarrendererbarsize",t.numberedBarRendererBarSize),e.set("numberedbarrendererbarspacing",t.numberedBarRendererBarSpacing),e.set("numbereddashglyphpadding",t.numberedDashGlyphPadding),e.set("numbereddashglyphwidth",t.numberedDashGlyphWidth),e.set("linerangedglyphdashgap",t.lineRangedGlyphDashGap),e.set("linerangedglyphdashsize",t.lineRangedGlyphDashSize),e.set("prenoteeffectpadding",t.preNoteEffectPadding),e.set("postnoteeffectpadding",t.postNoteEffectPadding),e.set("onnoteeffectpadding",t.onNoteEffectPadding),e.set("stringnumbercirclepadding",t.stringNumberCirclePadding),e.set("rowcontainerpadding",t.rowContainerPadding),e.set("rowcontainergap",t.rowContainerGap),e.set("alternateendingspadding",t.alternateEndingsPadding),e.set("sustainpedallinepadding",t.sustainPedalLinePadding),e.set("tieheight",t.tieHeight),e.set("beattimerpadding",t.beatTimerPadding),e.set("bendnoteheadelementpadding",t.bendNoteHeadElementPadding),e.set("ghostparenthesiswidth",t.ghostParenthesisWidth),e.set("ghostparenthesispadding",t.ghostParenthesisPadding),e.set("brokenbeamwidth",t.brokenBeamWidth),e.set("tabwhammytextpadding",t.tabWhammyTextPadding),e.set("tabwhammyperhalfheight",t.tabWhammyPerHalfHeight),e.set("tabwhammydashsize",t.tabWhammyDashSize),e.set("songbookwhammydipheight",t.songBookWhammyDipHeight),e.set("deadslappedlinewidth",t.deadSlappedLineWidth),e.set("lefthandtabtiewidth",t.leftHandTabTieWidth),e.set("tabbenddashsize",t.tabBendDashSize),e.set("tabbendstaffpadding",t.tabBendStaffPadding),e.set("tabbendpervalueheight",t.tabBendPerValueHeight),e.set("tabbendlabelpadding",t.tabBendLabelPadding),e.set("simpleslidewidth",t.simpleSlideWidth),e.set("simpleslideheight",t.simpleSlideHeight),e.set("chorddiagrampaddingx",t.chordDiagramPaddingX),e.set("chorddiagrampaddingy",t.chordDiagramPaddingY),e.set("chorddiagramstringspacing",t.chordDiagramStringSpacing),e.set("chorddiagramfretspacing",t.chordDiagramFretSpacing),e.set("chorddiagramnutheight",t.chordDiagramNutHeight),e.set("chorddiagramfretheight",t.chordDiagramFretHeight),e.set("chorddiagramlinewidth",t.chordDiagramLineWidth),e.set("tripletfeelbracketpadding",t.tripletFeelBracketPadding),e.set("accidentalpadding",t.accidentalPadding),e.set("prebeatglyphspacing",t.preBeatGlyphSpacing),e.set("temponotescale",t.tempoNoteScale),e.set("tuningglyphcirclenumberscale",t.tuningGlyphCircleNumberScale),e.set("tuningglyphstringcolumnscale",t.tuningGlyphStringColumnScale),e.set("tuningglyphstringrowpadding",t.tuningGlyphStringRowPadding),e.set("directionsscale",t.directionsScale),e.set("multivoicedisplacednoteheadspacing",t.multiVoiceDisplacedNoteHeadSpacing);{const s=new Map;e.set("stemflagheight",s);for(const[e,i]of t.stemFlagHeight)s.set(e.toString(),i)}return e}static setProperty(t,e,s){switch(e){case"musicfontsize":return t.musicFontSize=s,!0;case"onestaffspace":return t.oneStaffSpace=s,!0;case"tablinespacing":return t.tabLineSpacing=s,!0;case"arrowshaftthickness":return t.arrowShaftThickness=s,!0;case"barlineseparation":return t.barlineSeparation=s,!0;case"beamspacing":return t.beamSpacing=s,!0;case"beamthickness":return t.beamThickness=s,!0;case"bracketthickness":return t.bracketThickness=s,!0;case"dashedbarlinedashlength":return t.dashedBarlineDashLength=s,!0;case"dashedbarlinegaplength":return t.dashedBarlineGapLength=s,!0;case"dashedbarlinethickness":return t.dashedBarlineThickness=s,!0;case"hairpinthickness":return t.hairpinThickness=s,!0;case"legerlinethickness":return t.legerLineThickness=s,!0;case"legerlineextension":return t.legerLineExtension=s,!0;case"octavelinethickness":return t.octaveLineThickness=s,!0;case"pedallinethickness":return t.pedalLineThickness=s,!0;case"repeatbarlinedotseparation":return t.repeatBarlineDotSeparation=s,!0;case"repeatendinglinethickness":return t.repeatEndingLineThickness=s,!0;case"slurmidpointthickness":return t.slurMidpointThickness=s,!0;case"stafflinethickness":return t.staffLineThickness=s,!0;case"stemthickness":return t.stemThickness=s,!0;case"thickbarlinethickness":return t.thickBarlineThickness=s,!0;case"thinbarlinethickness":return t.thinBarlineThickness=s,!0;case"thinthickbarlineseparation":return t.thinThickBarlineSeparation=s,!0;case"tiemidpointthickness":return t.tieMidpointThickness=s,!0;case"tupletbracketthickness":return t.tupletBracketThickness=s,!0;case"stemup":return t.stemUp=new Map,rr.forEach(s,(e,s)=>{const i=new Ir;Wr.fromJson(i,e),t.stemUp.set(rr.parseEnum(s,ut),i)}),!0;case"stemdown":return t.stemDown=new Map,rr.forEach(s,(e,s)=>{const i=new Ir;Wr.fromJson(i,e),t.stemDown.set(rr.parseEnum(s,ut),i)}),!0;case"repeatoffsetx":return t.repeatOffsetX=new Map,rr.forEach(s,(e,s)=>{t.repeatOffsetX.set(rr.parseEnum(s,ut),e)}),!0;case"standardstemlength":return t.standardStemLength=s,!0;case"stemflagoffsets":return t.stemFlagOffsets=new Map,rr.forEach(s,(e,s)=>{t.stemFlagOffsets.set(rr.parseEnum(s,l),e)}),!0;case"glyphtop":return t.glyphTop=new Map,rr.forEach(s,(e,s)=>{t.glyphTop.set(rr.parseEnum(s,ut),e)}),!0;case"glyphbottom":return t.glyphBottom=new Map,rr.forEach(s,(e,s)=>{t.glyphBottom.set(rr.parseEnum(s,ut),e)}),!0;case"glyphwidths":return t.glyphWidths=new Map,rr.forEach(s,(e,s)=>{t.glyphWidths.set(rr.parseEnum(s,ut),e)}),!0;case"glyphheights":return t.glyphHeights=new Map,rr.forEach(s,(e,s)=>{t.glyphHeights.set(rr.parseEnum(s,ut),e)}),!0;case"numberedbarrendererbarsize":return t.numberedBarRendererBarSize=s,!0;case"numberedbarrendererbarspacing":return t.numberedBarRendererBarSpacing=s,!0;case"numbereddashglyphpadding":return t.numberedDashGlyphPadding=s,!0;case"numbereddashglyphwidth":return t.numberedDashGlyphWidth=s,!0;case"linerangedglyphdashgap":return t.lineRangedGlyphDashGap=s,!0;case"linerangedglyphdashsize":return t.lineRangedGlyphDashSize=s,!0;case"prenoteeffectpadding":return t.preNoteEffectPadding=s,!0;case"postnoteeffectpadding":return t.postNoteEffectPadding=s,!0;case"onnoteeffectpadding":return t.onNoteEffectPadding=s,!0;case"stringnumbercirclepadding":return t.stringNumberCirclePadding=s,!0;case"rowcontainerpadding":return t.rowContainerPadding=s,!0;case"rowcontainergap":return t.rowContainerGap=s,!0;case"alternateendingspadding":return t.alternateEndingsPadding=s,!0;case"sustainpedallinepadding":return t.sustainPedalLinePadding=s,!0;case"tieheight":return t.tieHeight=s,!0;case"beattimerpadding":return t.beatTimerPadding=s,!0;case"bendnoteheadelementpadding":return t.bendNoteHeadElementPadding=s,!0;case"ghostparenthesiswidth":return t.ghostParenthesisWidth=s,!0;case"ghostparenthesispadding":return t.ghostParenthesisPadding=s,!0;case"brokenbeamwidth":return t.brokenBeamWidth=s,!0;case"tabwhammytextpadding":return t.tabWhammyTextPadding=s,!0;case"tabwhammyperhalfheight":return t.tabWhammyPerHalfHeight=s,!0;case"tabwhammydashsize":return t.tabWhammyDashSize=s,!0;case"songbookwhammydipheight":return t.songBookWhammyDipHeight=s,!0;case"deadslappedlinewidth":return t.deadSlappedLineWidth=s,!0;case"lefthandtabtiewidth":return t.leftHandTabTieWidth=s,!0;case"tabbenddashsize":return t.tabBendDashSize=s,!0;case"tabbendstaffpadding":return t.tabBendStaffPadding=s,!0;case"tabbendpervalueheight":return t.tabBendPerValueHeight=s,!0;case"tabbendlabelpadding":return t.tabBendLabelPadding=s,!0;case"simpleslidewidth":return t.simpleSlideWidth=s,!0;case"simpleslideheight":return t.simpleSlideHeight=s,!0;case"chorddiagrampaddingx":return t.chordDiagramPaddingX=s,!0;case"chorddiagrampaddingy":return t.chordDiagramPaddingY=s,!0;case"chorddiagramstringspacing":return t.chordDiagramStringSpacing=s,!0;case"chorddiagramfretspacing":return t.chordDiagramFretSpacing=s,!0;case"chorddiagramnutheight":return t.chordDiagramNutHeight=s,!0;case"chorddiagramfretheight":return t.chordDiagramFretHeight=s,!0;case"chorddiagramlinewidth":return t.chordDiagramLineWidth=s,!0;case"tripletfeelbracketpadding":return t.tripletFeelBracketPadding=s,!0;case"accidentalpadding":return t.accidentalPadding=s,!0;case"prebeatglyphspacing":return t.preBeatGlyphSpacing=s,!0;case"temponotescale":return t.tempoNoteScale=s,!0;case"tuningglyphcirclenumberscale":return t.tuningGlyphCircleNumberScale=s,!0;case"tuningglyphstringcolumnscale":return t.tuningGlyphStringColumnScale=s,!0;case"tuningglyphstringrowpadding":return t.tuningGlyphStringRowPadding=s,!0;case"directionsscale":return t.directionsScale=s,!0;case"multivoicedisplacednoteheadspacing":return t.multiVoiceDisplacedNoteHeadSpacing=s,!0;case"stemflagheight":return t.stemFlagHeight=new Map,rr.forEach(s,(e,s)=>{t.stemFlagHeight.set(rr.parseEnum(s,l),e)}),!0}return!1}}class Vr{startPos;endPos;text;constructor(t,e,s){this.text=t,this.startPos=e,this.endPos=s}}class $r{style="normal";variant="normal";weight="normal";stretch="normal";lineHeight="normal";size="1rem";families=[];parseOnlyFamilies=!1;zf;Xf=-1;ji="";jf=null;constructor(t){this.ji=t,this.zf=this.Jf(t)}Jf(t){const e=[];let s=0;for(;s<t.length;){let i=s;for(;i<t.length&&" "!==t.charAt(i);)i++;i>s&&e.push(new Vr(t.substring(s,i),s,i)),s=i+1}return e}parse(){if(this.qf(),1===this.zf.length)switch(this.jf?.text){case"caption":case"icon":case"menu":case"message-box":case"small-caption":case"status-bar":case"inherit":return}this.parseOnlyFamilies||(this.Yf(),this.Kf()),this.Qf()}static parseFamilies(t){const e=new $r(t);return e.parseOnlyFamilies=!0,e.parse(),e.families}Qf(){if(!this.jf){if(this.parseOnlyFamilies)return;throw new Error("Missing font list")}const t=this.ji.substr(this.jf.startPos).trim();let e=0;for(;e<t.length;){const s=t.charAt(e);if(" "===s||","===s)e++;else if('"'===s||"'"===s){const i=this.Zf(t,e+1,s);this.families.push(t.substring(e+1,i).split(`\\${s}`).join(s)),e=i+1}else{const s=this.Zf(t,e+1,",");this.families.push(t.substring(e,s).trim()),e=s+1}}}Zf(t,e,s){let i=!1;for(;e<t.length;){const n=t.charAt(e);if(!i&&n===s)return e;i=!i&&"\\"===n,e+=1}return t.length}Kf(){if(!this.jf)throw new Error("Missing font size");const t=this.jf.text.split("/");if(t.length>=3)throw new Error(`Invalid font size '${this.jf}' specified`);if(this.tp(),t.length>=2)if("/"===t[1]){if(!this.jf)throw new Error("Missing line-height after font size");this.lineHeight=this.jf.text,this.tp()}else this.size=t[0],this.lineHeight=t[1];else{if(!(t.length>=1))throw new Error("Missing font size");if(this.size=t[0],this.jf&&0===this.jf.text.indexOf("/"))if("/"===this.jf.text){if(this.tp(),!this.jf)throw new Error("Missing line-height after font size");this.lineHeight=this.jf.text,this.tp()}else this.lineHeight=this.jf.text.substr(1),this.tp()}}tp(){this.Xf++,this.Xf<this.zf.length?this.jf=this.zf[this.Xf]:this.jf=null}Yf(){let t=!1,e=!1,s=!1,i=3;const n=[];for(;;){if(!this.jf)return;const r=this.jf.text;switch(r){case"normal":case"inherit":n.push(r),i--,this.tp();break;case"italic":case"oblique":this.style=r,t=!0,i--,this.tp();break;case"small-caps":this.variant=r,e=!0,i--,this.tp();break;case"bold":case"bolder":case"lighter":case"100":case"200":case"300":case"400":case"500":case"600":case"700":case"800":case"900":this.weight=r,s=!0,i--,this.tp();break;default:return}if(0===i)break}for(;n.length>0;){const i=n.pop();s?e?t||(this.style=i):this.variant=i:this.weight=i}}qf(){this.Xf=-1,this.tp()}static quoteFont(t){if(-1===t.indexOf(" "))return t;return`"${t.replaceAll('"','\\"')}"`}}!function(t){t[t.Plain=0]="Plain",t[t.Italic=1]="Italic"}(as||(as={})),function(t){t[t.Regular=0]="Regular",t[t.Bold=1]="Bold"}(hs||(hs={}));class Hr{ep;sp=0;ip;np;rp;xi;qf(){this.sp=0,this.ep=this.toCssString()}get family(){return this.ip[0]}set family(t){this.families=$r.parseFamilies(t)}get families(){return this.ip}set families(t){this.ip=t,this.qf()}get size(){return this.xi}set size(t){this.xi=t,this.qf()}get style(){return this.np}set style(t){this.np=t,this.qf()}get weight(){return this.rp}set weight(t){this.rp=t,this.qf()}get isBold(){return this.weight===hs.Bold}get isItalic(){return this.style===as.Italic}constructor(t,e,s=as.Plain,i=hs.Regular){this.ip=$r.parseFamilies(t),this.xi=e,this.np=s,this.rp=i,this.ep=this.toCssString()}withSize(t){return Hr.withFamilyList(this.ip,t,this.np,this.rp)}static withFamilyList(t,e,s=as.Plain,i=hs.Regular){const n=new Hr("",e,s,i);return n.families=t,n}toCssString(t=1){if(!(this.ep&&Math.abs(t-this.sp)<.01)){let e="";this.isBold&&(e+="bold "),this.isItalic&&(e+="italic "),e+=this.size*t,e+="px ",e+=this.families.map(t=>$r.quoteFont(t)).join(", "),this.ep=e,this.sp=t}return this.ep}static fromJson(t){if(t instanceof Hr)return t;switch(typeof t){case"undefined":default:return;case"object":{const e=t,s=e.get("families"),i=e.get("size"),n=rr.parseEnum(e.get("style"),as),r=rr.parseEnum(e.get("weight"),hs);return Hr.withFamilyList(s,i,n,r)}case"string":{const e=new $r(t);e.parse();const s=e.families,i=e.size.toLowerCase();let n=0;switch(i){case"xx-small":n=7;break;case"x-small":n=10;break;case"small":case"smaller":n=13;break;case"medium":n=16;break;case"large":case"larger":n=18;break;case"x-large":n=24;break;case"xx-large":n=32;break;default:try{n=i.endsWith("em")?16*Number.parseFloat(i.substr(0,i.length-2)):i.endsWith("pt")?16*Number.parseFloat(i.substr(0,i.length-2))/12:i.endsWith("px")?Number.parseFloat(i.substr(0,i.length-2)):12}catch{n=12}}let r=as.Plain;"italic"===e.style&&(r=as.Italic);let a=hs.Regular;switch(e.weight.toLowerCase()){case"normal":case"lighter":break;default:a=hs.Bold}return Hr.withFamilyList(s,n,r,a)}}}static toJson(t){if(!t)return;const e=new Map;return e.set("families",t.families),e.set("size",t.size),e.set("style",t.style),e.set("weight",t.weight),e}}class Ur{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Ur.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;e.set("smuflfontfamilyname",t.smuflFontFamilyName),e.set("engravingsettings",Gr.toJson(t.engravingSettings));{const s=new Map;e.set("elementfonts",s);for(const[e,i]of t.elementFonts)s.set(e.toString(),Hr.toJson(i))}return e.set("numberednotationfont",Hr.toJson(t.numberedNotationFont)),e.set("numberednotationgracefont",Hr.toJson(t.numberedNotationGraceFont)),e.set("tablaturefont",Hr.toJson(t.tablatureFont)),e.set("gracefont",Hr.toJson(t.graceFont)),e.set("stafflinecolor",Se.toJson(t.staffLineColor)),e.set("barseparatorcolor",Se.toJson(t.barSeparatorColor)),e.set("barnumbercolor",Se.toJson(t.barNumberColor)),e.set("mainglyphcolor",Se.toJson(t.mainGlyphColor)),e.set("secondaryglyphcolor",Se.toJson(t.secondaryGlyphColor)),e.set("scoreinfocolor",Se.toJson(t.scoreInfoColor)),e}static setProperty(e,s,i){switch(s){case"smuflfontfamilyname":return e.smuflFontFamilyName=i,!0;case"elementfonts":return rr.forEach(i,(s,i)=>{e.elementFonts.set(rr.parseEnum(i,t.NotationElement),Hr.fromJson(s))}),!0;case"numberednotationfont":return e.numberedNotationFont=Hr.fromJson(i),!0;case"numberednotationgracefont":return e.numberedNotationGraceFont=Hr.fromJson(i),!0;case"tablaturefont":return e.tablatureFont=Hr.fromJson(i),!0;case"gracefont":return e.graceFont=Hr.fromJson(i),!0;case"stafflinecolor":return e.staffLineColor=Se.fromJson(i),!0;case"barseparatorcolor":return e.barSeparatorColor=Se.fromJson(i),!0;case"barnumbercolor":return e.barNumberColor=Se.fromJson(i),!0;case"mainglyphcolor":return e.mainGlyphColor=Se.fromJson(i),!0;case"secondaryglyphcolor":return e.secondaryGlyphColor=Se.fromJson(i),!0;case"scoreinfocolor":return e.scoreInfoColor=Se.fromJson(i),!0}return["engravingsettings"].indexOf(s)>=0&&(Gr.fromJson(e.engravingSettings,i),!0)}}t.StaveProfile=void 0,(os=t.StaveProfile||(t.StaveProfile={}))[os.Default=0]="Default",os[os.ScoreTab=1]="ScoreTab",os[os.Score=2]="Score",os[os.Tab=3]="Tab",os[os.TabMixed=4]="TabMixed";class zr{static ap="Arial, sans-serif";static hp="Georgia, serif";static op=new Hr(zr.hp,12,as.Italic);static defaultFonts=new Map([[t.NotationElement.ScoreTitle,new Hr(zr.hp,32,as.Plain)],[t.NotationElement.ScoreSubTitle,new Hr(zr.hp,20,as.Plain)],[t.NotationElement.ScoreArtist,new Hr(zr.hp,20,as.Plain)],[t.NotationElement.ScoreAlbum,new Hr(zr.hp,20,as.Plain)],[t.NotationElement.ScoreWords,new Hr(zr.hp,15,as.Plain)],[t.NotationElement.ScoreMusic,new Hr(zr.hp,15,as.Plain)],[t.NotationElement.ScoreWordsAndMusic,new Hr(zr.hp,15,as.Plain)],[t.NotationElement.ScoreCopyright,new Hr(zr.ap,12,as.Plain,hs.Bold)],[t.NotationElement.EffectBeatTimer,new Hr(zr.hp,12,as.Plain)],[t.NotationElement.EffectDirections,new Hr(zr.hp,14,as.Plain)],[t.NotationElement.ChordDiagramFretboardNumbers,new Hr(zr.ap,11,as.Plain)],[t.NotationElement.EffectFingering,new Hr(zr.hp,14,as.Plain)],[t.NotationElement.EffectMarker,new Hr(zr.hp,14,as.Plain,hs.Bold)],[t.NotationElement.EffectCapo,zr.op],[t.NotationElement.EffectFreeTime,zr.op],[t.NotationElement.EffectLyrics,zr.op],[t.NotationElement.EffectTap,zr.op],[t.NotationElement.ChordDiagrams,zr.op],[t.NotationElement.EffectChordNames,zr.op],[t.NotationElement.EffectText,zr.op],[t.NotationElement.EffectPalmMute,zr.op],[t.NotationElement.EffectLetRing,zr.op],[t.NotationElement.EffectBeatBarre,zr.op],[t.NotationElement.EffectTripletFeel,zr.op],[t.NotationElement.EffectHarmonics,zr.op],[t.NotationElement.EffectPickSlide,zr.op],[t.NotationElement.GuitarTuning,zr.op],[t.NotationElement.EffectRasgueado,zr.op],[t.NotationElement.EffectWhammyBar,zr.op],[t.NotationElement.TrackNames,zr.op],[t.NotationElement.RepeatCount,new Hr(zr.ap,11,as.Plain)],[t.NotationElement.BarNumber,new Hr(zr.ap,11,as.Plain)],[t.NotationElement.ScoreBendSlur,new Hr(zr.ap,11,as.Plain)],[t.NotationElement.EffectAlternateEndings,new Hr(zr.hp,15,as.Plain)]]);smuflFontFamilyName;engravingSettings=Or.bravuraDefaults;get copyrightFont(){return this.elementFonts.get(t.NotationElement.ScoreCopyright)}set copyrightFont(e){this.elementFonts.set(t.NotationElement.ScoreCopyright,e)}get titleFont(){return this.elementFonts.get(t.NotationElement.ScoreTitle)}set titleFont(e){this.elementFonts.set(t.NotationElement.ScoreTitle,e)}get subTitleFont(){return this.elementFonts.get(t.NotationElement.ScoreSubTitle)}set subTitleFont(e){this.elementFonts.set(t.NotationElement.ScoreSubTitle,e)}get wordsFont(){return this.elementFonts.get(t.NotationElement.ScoreWords)}set wordsFont(e){this.elementFonts.set(t.NotationElement.ScoreWords,e)}get timerFont(){return this.elementFonts.get(t.NotationElement.EffectBeatTimer)}set timerFont(e){this.elementFonts.set(t.NotationElement.EffectBeatTimer,e)}get directionsFont(){return this.elementFonts.get(t.NotationElement.EffectDirections)}set directionsFont(e){this.elementFonts.set(t.NotationElement.EffectDirections,e)}get fretboardNumberFont(){return this.elementFonts.get(t.NotationElement.ChordDiagramFretboardNumbers)}set fretboardNumberFont(e){this.elementFonts.set(t.NotationElement.ChordDiagramFretboardNumbers,e)}fingeringFont=zr.op;inlineFingeringFont=zr.op;get markerFont(){return this.elementFonts.get(t.NotationElement.EffectMarker)}set markerFont(e){this.elementFonts.set(t.NotationElement.EffectMarker,e)}effectFont=zr.op;get barNumberFont(){return this.elementFonts.get(t.NotationElement.BarNumber)}set barNumberFont(e){this.elementFonts.set(t.NotationElement.BarNumber,e)}elementFonts=new Map;numberedNotationFont=new Hr(zr.ap,16,as.Plain);numberedNotationGraceFont=new Hr(zr.ap,14,as.Plain);tablatureFont=new Hr(zr.ap,14,as.Plain);graceFont=new Hr(zr.ap,12,as.Plain);staffLineColor=new Se(165,165,165,255);barSeparatorColor=new Se(34,34,17,255);barNumberColor=new Se(200,0,0,255);mainGlyphColor=new Se(0,0,0,255);secondaryGlyphColor=new Se(0,0,0,100);scoreInfoColor=new Se(0,0,0,255);constructor(){for(const[t,e]of zr.defaultFonts)this.elementFonts.set(t,e.withSize(e.size))}getFontForElement(e){let s=t.NotationElement.ScoreWords;switch(e){case ct.Title:s=t.NotationElement.ScoreTitle;break;case ct.SubTitle:s=t.NotationElement.ScoreSubTitle;break;case ct.Artist:s=t.NotationElement.ScoreArtist;break;case ct.Album:s=t.NotationElement.ScoreAlbum;break;case ct.Words:s=t.NotationElement.ScoreWords;break;case ct.Music:s=t.NotationElement.ScoreMusic;break;case ct.WordsAndMusic:s=t.NotationElement.ScoreWordsAndMusic;break;case ct.Copyright:case ct.CopyrightSecondLine:s=t.NotationElement.ScoreCopyright;break;default:s=t.NotationElement.ScoreWords}return this.elementFonts.has(s)?this.elementFonts.get(s):zr.defaultFonts.get(t.NotationElement.ScoreWords)}}t.SystemsLayoutMode=void 0,(cs=t.SystemsLayoutMode||(t.SystemsLayoutMode={}))[cs.Automatic=0]="Automatic",cs[cs.UseModelLayout=1]="UseModelLayout";class Xr{scale=1;stretchForce=1;layoutMode=t.LayoutMode.Page;staveProfile=t.StaveProfile.Default;barsPerRow=-1;startBar=1;barCount=-1;barCountPerPartial=10;justifyLastSystem=!1;resources=new zr;padding=[35,35];firstSystemPaddingTop=0;systemPaddingTop=10;systemPaddingBottom=10;lastSystemPaddingBottom=5;systemLabelPaddingLeft=0;systemLabelPaddingRight=3;accoladeBarPaddingRight=3;firstNotationStaffPaddingTop=0;lastNotationStaffPaddingBottom=0;notationStaffPaddingTop=0;notationStaffPaddingBottom=0;effectStaffPaddingTop=0;effectStaffPaddingBottom=0;firstStaffPaddingLeft=6;staffPaddingLeft=2;effectBandPaddingBottom=2;trackStaffPaddingBetween=5;lyricLinesPaddingBetween=5;systemsLayoutMode=t.SystemsLayoutMode.Automatic}class jr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>jr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("scale",t.scale),e.set("stretchforce",t.stretchForce),e.set("layoutmode",t.layoutMode),e.set("staveprofile",t.staveProfile),e.set("barsperrow",t.barsPerRow),e.set("startbar",t.startBar),e.set("barcount",t.barCount),e.set("barcountperpartial",t.barCountPerPartial),e.set("justifylastsystem",t.justifyLastSystem),e.set("resources",Ur.toJson(t.resources)),e.set("padding",t.padding),e.set("firstsystempaddingtop",t.firstSystemPaddingTop),e.set("systempaddingtop",t.systemPaddingTop),e.set("systempaddingbottom",t.systemPaddingBottom),e.set("lastsystempaddingbottom",t.lastSystemPaddingBottom),e.set("systemlabelpaddingleft",t.systemLabelPaddingLeft),e.set("systemlabelpaddingright",t.systemLabelPaddingRight),e.set("accoladebarpaddingright",t.accoladeBarPaddingRight),e.set("firstnotationstaffpaddingtop",t.firstNotationStaffPaddingTop),e.set("lastnotationstaffpaddingbottom",t.lastNotationStaffPaddingBottom),e.set("notationstaffpaddingtop",t.notationStaffPaddingTop),e.set("notationstaffpaddingbottom",t.notationStaffPaddingBottom),e.set("effectstaffpaddingtop",t.effectStaffPaddingTop),e.set("effectstaffpaddingbottom",t.effectStaffPaddingBottom),e.set("firststaffpaddingleft",t.firstStaffPaddingLeft),e.set("staffpaddingleft",t.staffPaddingLeft),e.set("effectbandpaddingbottom",t.effectBandPaddingBottom),e.set("trackstaffpaddingbetween",t.trackStaffPaddingBetween),e.set("lyriclinespaddingbetween",t.lyricLinesPaddingBetween),e.set("systemslayoutmode",t.systemsLayoutMode),e}static setProperty(e,s,i){switch(s){case"scale":return e.scale=i,!0;case"stretchforce":return e.stretchForce=i,!0;case"layoutmode":return e.layoutMode=rr.parseEnum(i,t.LayoutMode),!0;case"staveprofile":return e.staveProfile=rr.parseEnum(i,t.StaveProfile),!0;case"barsperrow":return e.barsPerRow=i,!0;case"startbar":return e.startBar=i,!0;case"barcount":return e.barCount=i,!0;case"barcountperpartial":return e.barCountPerPartial=i,!0;case"justifylastsystem":return e.justifyLastSystem=i,!0;case"padding":return e.padding=i,!0;case"firstsystempaddingtop":return e.firstSystemPaddingTop=i,!0;case"systempaddingtop":return e.systemPaddingTop=i,!0;case"systempaddingbottom":return e.systemPaddingBottom=i,!0;case"lastsystempaddingbottom":return e.lastSystemPaddingBottom=i,!0;case"systemlabelpaddingleft":return e.systemLabelPaddingLeft=i,!0;case"systemlabelpaddingright":return e.systemLabelPaddingRight=i,!0;case"accoladebarpaddingright":return e.accoladeBarPaddingRight=i,!0;case"firstnotationstaffpaddingtop":return e.firstNotationStaffPaddingTop=i,!0;case"lastnotationstaffpaddingbottom":return e.lastNotationStaffPaddingBottom=i,!0;case"notationstaffpaddingtop":return e.notationStaffPaddingTop=i,!0;case"notationstaffpaddingbottom":return e.notationStaffPaddingBottom=i,!0;case"effectstaffpaddingtop":return e.effectStaffPaddingTop=i,!0;case"effectstaffpaddingbottom":return e.effectStaffPaddingBottom=i,!0;case"firststaffpaddingleft":return e.firstStaffPaddingLeft=i,!0;case"staffpaddingleft":return e.staffPaddingLeft=i,!0;case"effectbandpaddingbottom":return e.effectBandPaddingBottom=i,!0;case"trackstaffpaddingbetween":return e.trackStaffPaddingBetween=i,!0;case"lyriclinespaddingbetween":return e.lyricLinesPaddingBetween=i,!0;case"systemslayoutmode":return e.systemsLayoutMode=rr.parseEnum(i,t.SystemsLayoutMode),!0}if(["resources"].indexOf(s)>=0)return Ur.fromJson(e.resources,i),!0;for(const t of["resources"])if(0===s.indexOf(t)&&Ur.setProperty(e.resources,s.substring(t.length),i))return!0;return!1}}class Jr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Jr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;e.set("notationmode",t.notationMode),e.set("fingeringmode",t.fingeringMode);{const s=new Map;e.set("elements",s);for(const[e,i]of t.elements)s.set(e.toString(),i)}return e.set("rhythmmode",t.rhythmMode),e.set("rhythmheight",t.rhythmHeight),e.set("transpositionpitches",t.transpositionPitches),e.set("displaytranspositionpitches",t.displayTranspositionPitches),e.set("smallgracetabnotes",t.smallGraceTabNotes),e.set("extendbendarrowsontiednotes",t.extendBendArrowsOnTiedNotes),e.set("extendlineeffectstobeatend",t.extendLineEffectsToBeatEnd),e.set("slurheight",t.slurHeight),e}static setProperty(e,s,i){switch(s){case"notationmode":return e.notationMode=rr.parseEnum(i,t.NotationMode),!0;case"fingeringmode":return e.fingeringMode=rr.parseEnum(i,t.FingeringMode),!0;case"elements":return e.elements=new Map,rr.forEach(i,(s,i)=>{e.elements.set(rr.parseEnum(i,t.NotationElement),s)}),!0;case"rhythmmode":return e.rhythmMode=rr.parseEnum(i,t.TabRhythmMode),!0;case"rhythmheight":return e.rhythmHeight=i,!0;case"transpositionpitches":return e.transpositionPitches=i,!0;case"displaytranspositionpitches":return e.displayTranspositionPitches=i,!0;case"smallgracetabnotes":return e.smallGraceTabNotes=i,!0;case"extendbendarrowsontiednotes":return e.extendBendArrowsOnTiedNotes=i,!0;case"extendlineeffectstobeatend":return e.extendLineEffectsToBeatEnd=i,!0;case"slurheight":return e.slurHeight=i,!0}return!1}}class qr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>qr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("encoding",t.encoding),e.set("mergepartgroupsinmusicxml",t.mergePartGroupsInMusicXml),e.set("beattextaslyrics",t.beatTextAsLyrics),e}static setProperty(t,e,s){switch(e){case"encoding":return t.encoding=s,!0;case"mergepartgroupsinmusicxml":return t.mergePartGroupsInMusicXml=s,!0;case"beattextaslyrics":return t.beatTextAsLyrics=s,!0}return!1}}class Yr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Yr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("notewidelength",t.noteWideLength),e.set("notewideamplitude",t.noteWideAmplitude),e.set("noteslightlength",t.noteSlightLength),e.set("noteslightamplitude",t.noteSlightAmplitude),e.set("beatwidelength",t.beatWideLength),e.set("beatwideamplitude",t.beatWideAmplitude),e.set("beatslightlength",t.beatSlightLength),e.set("beatslightamplitude",t.beatSlightAmplitude),e}static setProperty(t,e,s){switch(e){case"notewidelength":return t.noteWideLength=s,!0;case"notewideamplitude":return t.noteWideAmplitude=s,!0;case"noteslightlength":return t.noteSlightLength=s,!0;case"noteslightamplitude":return t.noteSlightAmplitude=s,!0;case"beatwidelength":return t.beatWideLength=s,!0;case"beatwideamplitude":return t.beatWideAmplitude=s,!0;case"beatslightlength":return t.beatSlightLength=s,!0;case"beatslightamplitude":return t.beatSlightAmplitude=s,!0}return!1}}class Kr{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>Kr.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("simpleslidepitchoffset",t.simpleSlidePitchOffset),e.set("simpleslidedurationratio",t.simpleSlideDurationRatio),e.set("shiftslidedurationratio",t.shiftSlideDurationRatio),e}static setProperty(t,e,s){switch(e){case"simpleslidepitchoffset":return t.simpleSlidePitchOffset=s,!0;case"simpleslidedurationratio":return t.simpleSlideDurationRatio=s,!0;case"shiftslidedurationratio":return t.shiftSlideDurationRatio=s,!0}return!1}}t.ScrollMode=void 0,(ls=t.ScrollMode||(t.ScrollMode={}))[ls.Off=0]="Off",ls[ls.Continuous=1]="Continuous",ls[ls.OffScreen=2]="OffScreen",ls[ls.Smooth=3]="Smooth";class Qr{noteWideLength=240;noteWideAmplitude=1;noteSlightLength=360;noteSlightAmplitude=.5;beatWideLength=480;beatWideAmplitude=2;beatSlightLength=480;beatSlightAmplitude=2}class Zr{simpleSlidePitchOffset=6;simpleSlideDurationRatio=.25;shiftSlideDurationRatio=.5}t.PlayerOutputMode=void 0,(us=t.PlayerOutputMode||(t.PlayerOutputMode={}))[us.WebAudioAudioWorklets=0]="WebAudioAudioWorklets",us[us.WebAudioScriptProcessor=1]="WebAudioScriptProcessor",t.PlayerMode=void 0,(ds=t.PlayerMode||(t.PlayerMode={}))[ds.Disabled=0]="Disabled",ds[ds.EnabledAutomatic=1]="EnabledAutomatic",ds[ds.EnabledSynthesizer=2]="EnabledSynthesizer",ds[ds.EnabledBackingTrack=3]="EnabledBackingTrack",ds[ds.EnabledExternalMedia=4]="EnabledExternalMedia";class ta{soundFont=null;scrollElement="html,body";outputMode=t.PlayerOutputMode.WebAudioAudioWorklets;enablePlayer=!1;playerMode=t.PlayerMode.Disabled;enableCursor=!0;enableAnimatedBeatCursor=!0;enableElementHighlighting=!0;enableUserInteraction=!0;scrollOffsetX=0;scrollOffsetY=0;scrollMode=t.ScrollMode.Continuous;scrollSpeed=300;nativeBrowserSmoothScroll=!0;songBookBendDuration=75;songBookDipDuration=150;vibrato=new Qr;slide=new Zr;playTripletFeel=!0;bufferTimeInMilliseconds=500}class ea{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>ea.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("soundfont",t.soundFont),e.set("outputmode",t.outputMode),e.set("enableplayer",t.enablePlayer),e.set("playermode",t.playerMode),e.set("enablecursor",t.enableCursor),e.set("enableanimatedbeatcursor",t.enableAnimatedBeatCursor),e.set("enableelementhighlighting",t.enableElementHighlighting),e.set("enableuserinteraction",t.enableUserInteraction),e.set("scrolloffsetx",t.scrollOffsetX),e.set("scrolloffsety",t.scrollOffsetY),e.set("scrollmode",t.scrollMode),e.set("scrollspeed",t.scrollSpeed),e.set("nativebrowsersmoothscroll",t.nativeBrowserSmoothScroll),e.set("songbookbendduration",t.songBookBendDuration),e.set("songbookdipduration",t.songBookDipDuration),e.set("vibrato",Yr.toJson(t.vibrato)),e.set("slide",Kr.toJson(t.slide)),e.set("playtripletfeel",t.playTripletFeel),e.set("buffertimeinmilliseconds",t.bufferTimeInMilliseconds),e}static setProperty(e,s,i){switch(s){case"soundfont":return e.soundFont=i,!0;case"scrollelement":return e.scrollElement=i,!0;case"outputmode":return e.outputMode=rr.parseEnum(i,t.PlayerOutputMode),!0;case"enableplayer":return e.enablePlayer=i,!0;case"playermode":return e.playerMode=rr.parseEnum(i,t.PlayerMode),!0;case"enablecursor":return e.enableCursor=i,!0;case"enableanimatedbeatcursor":return e.enableAnimatedBeatCursor=i,!0;case"enableelementhighlighting":return e.enableElementHighlighting=i,!0;case"enableuserinteraction":return e.enableUserInteraction=i,!0;case"scrolloffsetx":return e.scrollOffsetX=i,!0;case"scrolloffsety":return e.scrollOffsetY=i,!0;case"scrollmode":return e.scrollMode=rr.parseEnum(i,t.ScrollMode),!0;case"scrollspeed":return e.scrollSpeed=i,!0;case"nativebrowsersmoothscroll":return e.nativeBrowserSmoothScroll=i,!0;case"songbookbendduration":return e.songBookBendDuration=i,!0;case"songbookdipduration":return e.songBookDipDuration=i,!0;case"playtripletfeel":return e.playTripletFeel=i,!0;case"buffertimeinmilliseconds":return e.bufferTimeInMilliseconds=i,!0}if(["vibrato"].indexOf(s)>=0)return Yr.fromJson(e.vibrato,i),!0;for(const t of["vibrato"])if(0===s.indexOf(t)&&Yr.setProperty(e.vibrato,s.substring(t.length),i))return!0;if(["slide"].indexOf(s)>=0)return Kr.fromJson(e.slide,i),!0;for(const t of["slide"])if(0===s.indexOf(t)&&Kr.setProperty(e.slide,s.substring(t.length),i))return!0;return!1}}class sa{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>sa.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("indent",t.indent),e.set("comments",t.comments),e}static setProperty(t,e,s){switch(e){case"indent":return t.indent=s,!0;case"comments":return t.comments=s,!0}return!1}}class ia{static fromJson(t,e){e&&rr.forEach(e,(e,s)=>ia.setProperty(t,s.toLowerCase(),e))}static toJson(t){if(!t)return null;const e=new Map;return e.set("core",Lr.toJson(t.core)),e.set("display",jr.toJson(t.display)),e.set("notation",Jr.toJson(t.notation)),e.set("importer",qr.toJson(t.importer)),e.set("player",ea.toJson(t.player)),e.set("exporter",sa.toJson(t.exporter)),e}static setProperty(t,e,s){if(["core",""].indexOf(e)>=0)return Lr.fromJson(t.core,s),!0;for(const i of["core",""])if(0===e.indexOf(i)&&Lr.setProperty(t.core,e.substring(i.length),s))return!0;if(["display",""].indexOf(e)>=0)return jr.fromJson(t.display,s),!0;for(const i of["display",""])if(0===e.indexOf(i)&&jr.setProperty(t.display,e.substring(i.length),s))return!0;if(["notation"].indexOf(e)>=0)return Jr.fromJson(t.notation,s),!0;for(const i of["notation"])if(0===e.indexOf(i)&&Jr.setProperty(t.notation,e.substring(i.length),s))return!0;if(["importer"].indexOf(e)>=0)return qr.fromJson(t.importer,s),!0;for(const i of["importer"])if(0===e.indexOf(i)&&qr.setProperty(t.importer,e.substring(i.length),s))return!0;if(["player"].indexOf(e)>=0)return ea.fromJson(t.player,s),!0;for(const i of["player"])if(0===e.indexOf(i)&&ea.setProperty(t.player,e.substring(i.length),s))return!0;if(["exporter"].indexOf(e)>=0)return sa.fromJson(t.exporter,s),!0;for(const i of["exporter"])if(0===e.indexOf(i)&&sa.setProperty(t.exporter,e.substring(i.length),s))return!0;return!1}}class na{encoding="utf-8";mergePartGroupsInMusicXml=!1;beatTextAsLyrics=!1}class ra{indent=2;comments=!1}class aa{core=new Pu;display=new Xr;notation=new X;importer=new na;player=new ta;exporter=new ra;setSongBookModeSettings(){this.notation.notationMode=t.NotationMode.SongBook,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=t.FingeringMode.SingleNoteEffectBand,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.elements.set(t.NotationElement.ParenthesisOnTiedBends,!1),this.notation.elements.set(t.NotationElement.TabNotesOnTiedBends,!1),this.notation.elements.set(t.NotationElement.ZerosOnDiveWhammys,!0)}static get songBook(){const t=new aa;return t.setSongBookModeSettings(),t}fillFromJson(t){ia.fromJson(this,t)}handleBackwardsCompatibility(){this.player.playerMode===t.PlayerMode.Disabled&&this.player.enablePlayer&&(this.player.playerMode=t.PlayerMode.EnabledAutomatic)}}class ha{static cp(t,e){if(e instanceof Map){if("fromEntries"in Object)return Object.fromEntries(e);const t={};for(const[s,i]of e)t[s]=i;return t}return ArrayBuffer.isView(e)?Array.apply([],[e]):e}static scoreToJson(t){const e=ha.scoreToJsObject(t);return JSON.stringify(e,ha.cp)}static jsonToScore(t,e){return ha.jsObjectToScore(JSON.parse(t),e)}static scoreToJsObject(t){return Dr.toJson(t)}static jsObjectToScore(t,e){const s=new $t;return Dr.fromJson(s,t),s.finish(e??new aa),s}static settingsToJson(t){const e=ha.settingsToJsObject(t);return JSON.stringify(e,ha.cp)}static jsonToSettings(t){return ha.jsObjectToSettings(JSON.parse(t))}static settingsToJsObject(t){return ia.toJson(t)}static jsObjectToSettings(t){const e=new aa;return ia.fromJson(e,t),e}static jsObjectToMidiFile(t){const e=new xi;return rr.forEach(t,(t,s)=>{switch(s){case"tickShift":e.tickShift=t;break;case"division":e.division=t;break;case"tracks":for(const s of t){const t=ha.lp(s);e.tracks.push(t)}}}),e}static lp(t){const e=new Ti;return rr.forEach(t,(t,s)=>{if("events"===s)for(const s of t){const t=ha.jsObjectToMidiEvent(s);e.events.push(t)}}),e}static jsObjectToMidiEvent(e){const s=rr.getValue(e,"track"),i=rr.getValue(e,"tick"),n=rr.getValue(e,"type");switch(n){case Ke.TimeSignature:return new vi(s,i,rr.getValue(e,"numerator"),rr.getValue(e,"denominatorIndex"),rr.getValue(e,"midiClocksPerMetronomeClick"),rr.getValue(e,"thirdySecondNodesInQuarter"));case Ke.AlphaTabRest:return new Ci(s,i,rr.getValue(e,"channel"));case Ke.AlphaTabMetronome:return new Pi(s,i,rr.getValue(e,"metronomeNumerator"),rr.getValue(e,"metronomeDurationInTicks"),rr.getValue(e,"metronomeDurationInMilliseconds"));case Ke.NoteOn:return new Fi(s,i,rr.getValue(e,"channel"),rr.getValue(e,"noteKey"),rr.getValue(e,"noteVelocity"));case Ke.NoteOff:return new Ai(s,i,rr.getValue(e,"channel"),rr.getValue(e,"noteKey"),rr.getValue(e,"noteVelocity"));case Ke.ControlChange:return new Di(s,i,rr.getValue(e,"channel"),rr.getValue(e,"controller"),rr.getValue(e,"value"));case Ke.ProgramChange:return new Li(s,i,rr.getValue(e,"channel"),rr.getValue(e,"program"));case Ke.TempoChange:const t=new Wi(i,0);return t.beatsPerMinute=rr.getValue(e,"beatsPerMinute"),t;case Ke.PitchBend:return new Ri(s,i,rr.getValue(e,"channel"),rr.getValue(e,"value"));case Ke.PerNotePitchBend:return new Ii(s,i,rr.getValue(e,"channel"),rr.getValue(e,"noteKey"),rr.getValue(e,"value"));case Ke.EndOfTrack:return new Oi(s,i)}throw new G(t.AlphaTabErrorType.Format,`Unknown Midi Event type: ${n}`)}static midiFileToJsObject(t){const e=new Map;e.set("division",t.division),e.set("tickShift",t.tickShift);const s=[];for(const e of t.tracks)s.push(ha.up(e));return e.set("tracks",s),e}static up(t){const e=new Map,s=[];for(const e of t.events)s.push(ha.midiEventToJsObject(e));return e.set("events",s),e}static midiEventToJsObject(t){const e=new Map;switch(e.set("track",t.track),e.set("tick",t.tick),e.set("type",t.type),t.type){case Ke.TimeSignature:e.set("numerator",t.numerator),e.set("denominatorIndex",t.denominatorIndex),e.set("midiClocksPerMetronomeClick",t.midiClocksPerMetronomeClick),e.set("thirdySecondNodesInQuarter",t.thirtySecondNodesInQuarter);break;case Ke.AlphaTabRest:e.set("channel",t.channel);break;case Ke.AlphaTabMetronome:e.set("metronomeNumerator",t.metronomeNumerator),e.set("metronomeDurationInMilliseconds",t.metronomeDurationInMilliseconds),e.set("metronomeDurationInTicks",t.metronomeDurationInTicks);break;case Ke.NoteOn:case Ke.NoteOff:e.set("channel",t.channel),e.set("noteKey",t.noteKey),e.set("noteVelocity",t.noteVelocity);break;case Ke.ControlChange:e.set("channel",t.channel),e.set("controller",t.controller),e.set("value",t.value);break;case Ke.ProgramChange:e.set("channel",t.channel),e.set("program",t.program);break;case Ke.TempoChange:e.set("beatsPerMinute",t.beatsPerMinute);break;case Ke.PitchBend:e.set("channel",t.channel),e.set("value",t.value);break;case Ke.PerNotePitchBend:e.set("channel",t.channel),e.set("noteKey",t.noteKey),e.set("value",t.value);case Ke.EndOfTrack:}return e}}class oa{dp;fp;pp=new Map;constructor(t,e){this.fp=t,this.fp.addEventListener("message",this.handleMessage.bind(this)),this.dp=new ir(new wi,e),this.dp.positionChanged.on(this.onPositionChanged.bind(this)),this.dp.stateChanged.on(this.onPlayerStateChanged.bind(this)),this.dp.finished.on(this.onFinished.bind(this)),this.dp.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this.dp.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this.dp.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this.dp.midiLoaded.on(this.onMidiLoaded.bind(this)),this.dp.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this.dp.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this.dp.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this.dp.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this.fp.postMessage({cmd:"alphaSynth.ready"})}static init(){const t=Nu.globalThis;t.addEventListener("message",e=>{const s=e.data;if("alphaSynth.initialize"===s.cmd)wi.preferredSampleRate=s.sampleRate,q.logLevel=s.logLevel,Nu.globalThis.alphaSynthWebWorker=new oa(t,s.bufferTimeInMilliseconds)})}handleMessage(t){const e=t.data,s=e.cmd;switch(s){case"alphaSynth.setLogLevel":q.logLevel=e.value;break;case"alphaSynth.setMasterVolume":this.dp.masterVolume=e.value;break;case"alphaSynth.setMetronomeVolume":this.dp.metronomeVolume=e.value;break;case"alphaSynth.setPlaybackSpeed":this.dp.playbackSpeed=e.value;break;case"alphaSynth.setTickPosition":this.dp.tickPosition=e.value;break;case"alphaSynth.setTimePosition":this.dp.timePosition=e.value;break;case"alphaSynth.setPlaybackRange":this.dp.playbackRange=e.value;break;case"alphaSynth.setIsLooping":this.dp.isLooping=e.value;break;case"alphaSynth.setCountInVolume":this.dp.countInVolume=e.value;break;case"alphaSynth.setMidiEventsPlayedFilter":this.dp.midiEventsPlayedFilter=e.value;break;case"alphaSynth.play":this.dp.play();break;case"alphaSynth.pause":this.dp.pause();break;case"alphaSynth.playPause":this.dp.playPause();break;case"alphaSynth.stop":this.dp.stop();break;case"alphaSynth.playOneTimeMidiFile":this.dp.playOneTimeMidiFile(ha.jsObjectToMidiFile(e.midi));break;case"alphaSynth.loadSoundFontBytes":this.dp.loadSoundFont(e.data,e.append);break;case"alphaSynth.resetSoundFonts":this.dp.resetSoundFonts();break;case"alphaSynth.loadMidi":this.dp.loadMidiFile(ha.jsObjectToMidiFile(e.midi));break;case"alphaSynth.setChannelMute":this.dp.setChannelMute(e.channel,e.mute);break;case"alphaSynth.setChannelTranspositionPitch":this.dp.setChannelTranspositionPitch(e.channel,e.semitones);break;case"alphaSynth.setChannelSolo":this.dp.setChannelSolo(e.channel,e.solo);break;case"alphaSynth.setChannelVolume":this.dp.setChannelVolume(e.channel,e.volume);break;case"alphaSynth.resetChannelStates":this.dp.resetChannelStates();break;case"alphaSynth.destroy":this.dp.destroy(),this.fp.postMessage({cmd:"alphaSynth.destroyed"});break;case"alphaSynth.applyTranspositionPitches":this.dp.applyTranspositionPitches(new Map(JSON.parse(e.transpositionPitches)))}s.startsWith("alphaSynth.exporter")&&this.bp(t)}bp(t){const e=t.data,s=e.cmd;try{switch(s){case"alphaSynth.exporter.initialize":const t=this.dp.exportAudio(e.options,ha.jsObjectToMidiFile(e.midi),e.syncPoints,e.transpositionPitches);this.pp.set(e.exporterId,t),this.fp.postMessage({cmd:"alphaSynth.exporter.initialized",exporterId:e.exporterId});break;case"alphaSynth.exporter.render":if(this.pp.has(e.exporterId)){const t=this.pp.get(e.exporterId).render(e.milliseconds);this.fp.postMessage({cmd:"alphaSynth.exporter.rendered",exporterId:e.exporterId,chunk:t})}else this.fp.postMessage({cmd:"alphaSynth.exporter.error",exporterId:e.exporterId,error:new Error("Unknown exporter ID")});break;case"alphaSynth.exporter.destroy":this.pp.delete(e.exporterId)}}catch(t){this.fp.postMessage({cmd:"alphaSynth.exporter.error",exporterId:e.exporterId,error:t})}}onPositionChanged(t){this.fp.postMessage({cmd:"alphaSynth.positionChanged",currentTime:t.currentTime,endTime:t.endTime,currentTick:t.currentTick,endTick:t.endTick,isSeek:t.isSeek,originalTempo:t.originalTempo,modifiedTempo:t.modifiedTempo})}onPlayerStateChanged(t){this.fp.postMessage({cmd:"alphaSynth.playerStateChanged",state:t.state,stopped:t.stopped})}onFinished(){this.fp.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this.fp.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(t){this.fp.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this.mp(Nu.prepareForPostMessage(t))})}mp(t){const e=JSON.parse(JSON.stringify(t));return t.message&&(e.message=t.message),t.stack&&(e.stack=t.stack),t.constructor&&t.constructor.name&&(e.type=t.constructor.name),e}onMidiLoaded(t){this.fp.postMessage({cmd:"alphaSynth.midiLoaded",currentTime:t.currentTime,endTime:t.endTime,currentTick:t.currentTick,endTick:t.endTick,isSeek:t.isSeek,originalTempo:t.originalTempo,modifiedTempo:t.modifiedTempo})}onMidiLoadFailed(t){this.fp.postMessage({cmd:"alphaSynth.midiLoaded",error:this.mp(Nu.prepareForPostMessage(t))})}onReadyForPlayback(){this.fp.postMessage({cmd:"alphaSynth.readyForPlayback"})}onMidiEventsPlayed(t){this.fp.postMessage({cmd:"alphaSynth.midiEventsPlayed",events:t.events.map(ha.midiEventToJsObject)})}onPlaybackRangeChanged(t){this.fp.postMessage({cmd:"alphaSynth.playbackRangeChanged",playbackRange:t.playbackRange})}}t.WebPlatform=void 0,(fs=t.WebPlatform||(t.WebPlatform={}))[fs.Browser=0]="Browser",fs[fs.NodeJs=1]="NodeJs",fs[fs.BrowserModule=2]="BrowserModule";class ca{characterWidths;characterHeights;constructor(t,e){this.characterWidths=t,this.characterHeights=e}}class la{static fontSizeLookupTables=new Map;static ControlChars=32;static generateFontLookup(e){if(!la.fontSizeLookupTables.has(e))if(Nu.isRunningInWorker||Nu.webPlatform===t.WebPlatform.NodeJs){const t=new ca(new Uint8Array([8]),new Uint8Array([10]));la.fontSizeLookupTables.set(e,t)}else{const t=document.createElement("canvas").getContext("2d"),s=11;t.font=`${s}px ${e}`;const i=[],n=[];for(let e=la.ControlChars;e<255;e++){const s=String.fromCharCode(e),r=t.measureText(s);i.push(r.width);const a=r.actualBoundingBoxDescent+r.actualBoundingBoxAscent;n.push(a)}const r=new ca(new Uint8Array(i),new Uint8Array(n));la.fontSizeLookupTables.set(e,r)}}static measureString(t,e,s,i,n){let r;let a=e[0];for(let t=0;t<e.length;t++)if(la.fontSizeLookupTables.has(e[t])){a=e[t];break}la.fontSizeLookupTables.has(a)||la.generateFontLookup(a),r=la.fontSizeLookupTables.get(a);let h=1;i===as.Italic&&(h*=1.1),n===hs.Bold&&(h*=1.1);let o=0,c=0;for(let e=0;e<t.length;e++){const i=Math.min(r.characterWidths.length-1,t.charCodeAt(e)-la.ControlChars);i>=0&&(o+=r.characterWidths[i]*s/11,c=Math.max(c,r.characterHeights[i]*s/11))}return h*=1.07,new It(o*h,c)}}class ua{id=Xt.newGuid();reuseViewport=!0;x=0;y=0;width=0;height=0;totalWidth=0;totalHeight=0;firstMasterBarIndex=-1;lastMasterBarIndex=-1;renderResult=null}class da{masterBarBounds;visualBounds;realBounds;bar;beats=[];addBeat(t){t.barBounds=this,this.beats.push(t),this.masterBarBounds.addBeat(t)}findBeatAtPos(t){let e=null;for(const s of this.beats)if(!e||s.realBounds.x<t)e=s;else if(s.realBounds.x>t)break;return e}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.beats.sort((t,e)=>t.realBounds.x-e.realBounds.x);for(const e of this.beats)e.finish(t)}}class fa{barBounds;visualBounds;onNotesX=0;realBounds;beat;notes=null;addNote(t){this.notes||(this.notes=[]),t.beatBounds=this,this.notes.push(t)}findNoteAtPos(t,e){const s=this.notes;if(!s)return null;for(const i of s){const s=i.noteHeadBounds.y+i.noteHeadBounds.h,n=i.noteHeadBounds.x+i.noteHeadBounds.w;if(i.noteHeadBounds.x<=t&&i.noteHeadBounds.y<=e&&t<=n&&e<=s)return i.note}return null}finish(t=1){if(this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.onNotesX*=t,this.notes)for(const e of this.notes)e.finish(t)}}class pa{index=0;isFirstOfLine=!1;visualBounds;realBounds;lineAlignedBounds;bars=[];staffSystemBounds=null;get staveGroupBounds(){return this.staffSystemBounds}addBar(t){t.masterBarBounds=this,this.bars.push(t)}findBeatAtPos(t){let e=null;for(const s of this.bars){const i=s.findBeatAtPos(t);if(i&&(!e||e.realBounds.x<i.realBounds.x)){const s=Math.abs(i.realBounds.x-t);(!e||s<1e7)&&(e=i)}}return e?e.beat:null}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.lineAlignedBounds.scaleWith(t),this.bars.sort((t,e)=>t.realBounds.y<e.realBounds.y?-1:t.realBounds.y>e.realBounds.y?1:t.realBounds.x<e.realBounds.x?-1:t.realBounds.x>e.realBounds.x?1:0);for(const e of this.bars)e.finish(t)}addBeat(t){this.staffSystemBounds.boundsLookup.addBeat(t)}}class ba{beatBounds;noteHeadBounds;note;finish(t=1){this.noteHeadBounds.scaleWith(t)}}class ma{index=0;visualBounds;realBounds;bars=[];boundsLookup;finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t);for(const e of this.bars)e.finish(t)}addBar(t){this.boundsLookup.addMasterBar(t),t.staffSystemBounds=this,this.bars.push(t)}findBarAtPos(t){let e=null;for(const s of this.bars)if(!e||s.realBounds.x<t)e=s;else if(t>s.realBounds.x+s.realBounds.w)break;return e}}class ga{toJson(){const t={},e=[];t.staffSystems=e;for(const t of this.staffSystems){const s={};s.visualBounds=this.gp(t.visualBounds),s.realBounds=this.gp(t.realBounds),s.bars=[];for(const e of t.bars){const t={};t.lineAlignedBounds=this.gp(e.lineAlignedBounds),t.visualBounds=this.gp(e.visualBounds),t.realBounds=this.gp(e.realBounds),t.index=e.index,t.isFirstOfLine=e.isFirstOfLine,t.bars=[];for(const s of e.bars){const e={};e.visualBounds=this.gp(s.visualBounds),e.realBounds=this.gp(s.realBounds),e.beats=[];for(const t of s.beats){const s={};s.visualBounds=this.gp(t.visualBounds),s.realBounds=this.gp(t.realBounds),s.onNotesX=t.onNotesX;const i=s;if(i.beatIndex=t.beat.index,i.voiceIndex=t.beat.voice.index,i.barIndex=t.beat.voice.bar.index,i.staffIndex=t.beat.voice.bar.staff.index,i.trackIndex=t.beat.voice.bar.staff.track.index,t.notes){const e=[];s.notes=e;for(const s of t.notes){const t={};t.index=s.note.index,t.noteHeadBounds=this.gp(s.noteHeadBounds),e.push(t)}}e.beats.push(s)}t.bars.push(e)}s.bars.push(t)}e.push(s)}return t}static fromJson(t,e){const s=new ga,i=t.staffSystems;for(const t of i){const i=new ma;i.visualBounds=ga.wp(t.visualBounds),i.realBounds=ga.wp(t.realBounds),s.addStaffSystem(i);for(const i of t.bars){const t=new pa;t.index=i.index,t.isFirstOfLine=i.isFirstOfLine,t.lineAlignedBounds=ga.wp(i.lineAlignedBounds),t.visualBounds=ga.wp(i.visualBounds),t.realBounds=ga.wp(i.realBounds),s.addMasterBar(t);for(const s of i.bars){const i=new da;i.visualBounds=ga.wp(s.visualBounds),i.realBounds=ga.wp(s.realBounds),t.addBar(i);for(const t of s.beats){const s=new fa;s.visualBounds=ga.wp(t.visualBounds),s.realBounds=ga.wp(t.realBounds),s.onNotesX=t.onNotesX;const n=t;if(s.beat=e.tracks[n.trackIndex].staves[n.staffIndex].bars[n.barIndex].voices[n.voiceIndex].beats[n.beatIndex],t.notes){s.notes=[];for(const e of t.notes){const t=new ba,i=e;t.note=s.beat.notes[i.index],t.noteHeadBounds=ga.wp(e.noteHeadBounds),s.addNote(t)}}i.addBeat(s)}}}}return s}static wp(t){const e=new zs;return e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e}gp(t){const e={};return e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e}j=new Map;yp=new Map;kp=null;staffSystems=[];isFinished=!1;finish(t=1){for(const e of this.staffSystems)e.finish(t);this.isFinished=!0}addStaffSystem(t){t.index=this.staffSystems.length,t.boundsLookup=this,this.staffSystems.push(t),this.kp=t}addMasterBar(t){t.staffSystemBounds?this.yp.set(t.index,t):(t.staffSystemBounds=this.kp,this.yp.set(t.index,t),this.kp.addBar(t))}addBeat(t){this.j.has(t.beat.id)||this.j.set(t.beat.id,[]),this.j.get(t.beat.id)?.push(t)}findMasterBarByIndex(t){return this.yp.has(t)?this.yp.get(t):null}findMasterBar(t){const e=t.index;return this.yp.has(e)?this.yp.get(e):null}findBeat(t){const e=this.findBeats(t);return e?e[0]:null}findBeats(t){const e=t.id;return this.j.has(e)?this.j.get(e):null}getBeatAtPos(t,e){let s=0,i=this.staffSystems.length-1,n=-1;for(;s<=i;){const t=(i+s)/2|0,r=this.staffSystems[t];if(e>=r.realBounds.y&&e<=r.realBounds.y+r.realBounds.h){n=t;break}e<r.realBounds.y?i=t-1:s=t+1}if(-1===n)return null;const r=this.staffSystems[n].findBarAtPos(t);return r?r.findBeatAtPos(t):null}getNoteAtPos(t,e,s){const i=this.findBeats(t);if(i)for(const t of i){const i=t.findNoteAtPos(e,s);if(i)return i}return null}}class wa{Sp=t.LayoutMode.Page;Bp=null;_p=null;canvas=null;score=null;tracks=null;layout=null;settings;boundsLookup=null;width=0;constructor(t){this.settings=t,this.Tp(),this.xp()}destroy(){this.score=null,this.canvas?.destroy(),this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}Tp(){return this.Bp!==this.settings.core.engine&&(this.canvas?.destroy(),this.canvas=Nu.getRenderEngineFactory(this.settings.core.engine).createCanvas(),this.Bp=this.settings.core.engine,!0)}xp(){return(!this.layout||this.Sp!==this.settings.display.layoutMode)&&(this.layout=Nu.getLayoutEngineFactory(this.settings.display.layoutMode).createLayout(this),this.Sp=this.settings.display.layoutMode,!0)}renderScore(t,e,s){try{this.score=t;let i=null;if(null!=t&&null!=e){if(e){i=[];for(const s of e)s>=0&&s<t.tracks.length&&i.push(t.tracks[s])}else i=t.tracks.slice(0);0===i.length&&t.tracks.length>0&&i.push(t.tracks[0])}this.tracks=i,this.render(s)}catch(t){this.error.trigger(t)}}renderTracks(t){0===t.length?this.score=null:this.score=t[0].score,this.tracks=t,this.render()}updateSettings(t){this.settings=t}renderResult(t){try{const e=this.layout;e?(q.debug("Rendering",`Request render of lazy partial ${t}`),e.renderLazyPartial(t)):q.warning("Rendering",`Request render of lazy partial ${t} ignored, no layout exists`)}catch(t){this.error.trigger(t)}}render(t){if(0!==this.width)if(this.boundsLookup=new ga,this.Tp(),this.canvas.lineWidth=1,this.canvas.settings=this.settings,this.tracks&&0!==this.tracks.length&&this.score){q.debug("Rendering",`Rendering ${this.tracks.length} tracks`);for(let t=0;t<this.tracks.length;t++){const e=this.tracks[t];q.debug("Rendering",`Track ${t}: ${e.name}`)}this.preRender.trigger(!1),this.xp(),this.Mp(t),q.debug("Rendering","Rendering finished")}else q.debug("Rendering","Clearing rendered tracks because no score or tracks are set"),this.preRender.trigger(!1),this._p=null,this.vp(),this.postRenderFinished.trigger(),q.debug("Rendering","Clearing finished");else q.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null)}resizeRender(){this.xp()||this.Tp()||this._p!==this.tracks||!this.tracks?(q.debug("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(q.debug("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new ga,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this.vp(),this.postRenderFinished.trigger()):q.debug("Rendering","Current layout does not support dynamic resizing, nothing was done",null),q.debug("Rendering","Resize finished")}Mp(t){q.debug("Rendering",`Rendering at scale ${this.settings.display.scale} with layout ${this.layout.name}`,null),this.layout.layoutAndRender(t),this._p=this.tracks,this.vp(),this.postRenderFinished.trigger()}preRender=new gi;renderFinished=new gi;partialRenderFinished=new gi;partialLayoutFinished=new gi;postRenderFinished=new mi;error=new gi;vp(){this.boundsLookup?.finish(this.settings.display.scale);const t=new ua;t.totalHeight=this.layout.height,t.totalWidth=this.layout.width,t.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(t)}}class ya{Np;fp;constructor(t){this.fp=t,this.fp.addEventListener("message",this.yl.bind(this),!1)}static init(){Nu.globalThis.alphaTabWebWorker=new ya(Nu.globalThis)}yl(t){const e=t.data;switch(e?e.cmd:""){case"alphaTab.initialize":const t=ha.jsObjectToSettings(e.settings);q.logLevel=t.core.logLevel,this.Np=new wa(t),this.Np.partialRenderFinished.on(t=>{this.fp.postMessage({cmd:"alphaTab.partialRenderFinished",result:t})}),this.Np.partialLayoutFinished.on(t=>{this.fp.postMessage({cmd:"alphaTab.partialLayoutFinished",result:t})}),this.Np.renderFinished.on(t=>{this.fp.postMessage({cmd:"alphaTab.renderFinished",result:t})}),this.Np.postRenderFinished.on(()=>{this.fp.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:this.Np.boundsLookup?.toJson()??null})}),this.Np.preRender.on(t=>{this.fp.postMessage({cmd:"alphaTab.preRender",resize:t})}),this.Np.error.on(this.Pp.bind(this));break;case"alphaTab.render":this.Np.render(e.renderHints);break;case"alphaTab.resizeRender":this.Np.resizeRender();break;case"alphaTab.renderResult":this.Np.renderResult(e.resultId);break;case"alphaTab.setWidth":this.Np.width=e.width;break;case"alphaTab.renderScore":this.Cp(e.fontSizes);const s=null==e.score?null:ha.jsObjectToScore(e.score,this.Np.settings);this.Ep(s,e.trackIndexes);break;case"alphaTab.updateSettings":this.Fp(e.settings)}}Cp(t){if(!(t instanceof Map)){const e=t;t=new Map;for(const s in e)t.set(s,e[s])}if(t)for(const[e,s]of t)la.fontSizeLookupTables.set(e,s)}Fp(t){ia.fromJson(this.Np.settings,t)}Ep(t,e,s){try{this.Np.renderScore(t,e,s)}catch(t){this.Pp(t)}}Pp(t){q.error("Worker","An unexpected error occurred in worker",t),this.fp.postMessage({cmd:"alphaTab.error",error:t})}}class ka{Ap;Dp;Lp=null;Wp;Rp=new Se(0,0,0,255);Ip=new Hr("Arial",10,as.Plain);Op;Gp=0;settings;constructor(){this.Ap=document.createElement("canvas"),this.Ap.width=10,this.Ap.height=10,this.Ap.style.width="10px",this.Ap.style.height="10px",this.Dp=this.Ap.getContext("2d"),this.Dp.textBaseline="hanging"}destroy(){}onRenderFinished(){return null}beginRender(t,e){this.Op=new Hr(this.settings.display.resources.smuflFontFamilyName,this.settings.display.resources.engravingSettings.musicFontSize,as.Plain,hs.Regular);const s=this.settings.display.scale;this.Lp=document.createElement("canvas"),this.Lp.width=t*Nu.highDpiFactor|0,this.Lp.height=e*Nu.highDpiFactor|0,this.Lp.style.width=`${t}px`,this.Lp.style.height=`${e}px`,this.Wp=this.Lp.getContext("2d"),this.Wp.textBaseline="hanging",this.Wp.scale(Nu.highDpiFactor*s,Nu.highDpiFactor*s),this.Wp.lineWidth=this.Gp}endRender(){const t=this.Lp;return this.Lp=null,t}get color(){return this.Rp}set color(t){this.Rp.rgba!==t.rgba&&(this.Rp=t,this.Wp.strokeStyle=t.rgba,this.Wp.fillStyle=t.rgba)}get lineWidth(){return this.Gp}set lineWidth(t){this.Gp=t,this.Wp&&(this.Wp.lineWidth=t)}fillRect(t,e,s,i){s>0&&this.Wp.fillRect(t,e,s,i)}strokeRect(t,e,s,i){const n=this.lineWidth%2==0?0:.5;this.Wp.strokeRect(t+n,e+n,s,i)}beginPath(){this.Wp.beginPath()}closePath(){this.Wp.closePath()}moveTo(t,e){this.Wp.moveTo(t,e)}lineTo(t,e){this.Wp.lineTo(t,e)}quadraticCurveTo(t,e,s,i){this.Wp.quadraticCurveTo(t,e,s,i)}bezierCurveTo(t,e,s,i,n,r){this.Wp.bezierCurveTo(t,e,s,i,n,r)}fillCircle(t,e,s){this.Wp.beginPath(),this.Wp.arc(t,e,s,0,2*Math.PI,!0),this.fill()}strokeCircle(t,e,s){this.Wp.beginPath(),this.Wp.arc(t,e,s,0,2*Math.PI,!0),this.stroke()}fill(){this.Wp.fill(),this.Wp.beginPath()}stroke(){this.Wp.stroke(),this.Wp.beginPath()}get font(){return this.Ip}set font(t){this.Ip=t,this.Wp&&(this.Wp.font=t.toCssString(1)),this.Dp.font=t.toCssString(1)}get textAlign(){switch(this.Wp.textAlign){case"left":default:return ht.Left;case"center":return ht.Center;case"right":return ht.Right}}set textAlign(t){switch(t){case ht.Left:this.Wp.textAlign="left";break;case ht.Center:this.Wp.textAlign="center";break;case ht.Right:this.Wp.textAlign="right"}}get textBaseline(){switch(this.Wp.textBaseline){case"hanging":default:return ot.Top;case"middle":return ot.Middle;case"bottom":return ot.Bottom;case"alphabetic":return ot.Alphabetic}}set textBaseline(t){switch(t){case ot.Top:this.Wp.textBaseline="hanging";break;case ot.Middle:this.Wp.textBaseline="middle";break;case ot.Bottom:this.Wp.textBaseline="bottom";break;case ot.Alphabetic:this.Wp.textBaseline="alphabetic"}}beginGroup(t){}endGroup(){}fillText(t,e,s){this.Wp.fillText(t,e,s)}measureText(t){const e=this.Dp.measureText(t);return new It(e.width,e.actualBoundingBoxDescent+e.actualBoundingBoxAscent)}fillMusicFontSymbol(t,e,s,i,n=!1){i!==ut.None&&this.Vp(t,e,s,String.fromCharCode(i),n)}fillMusicFontSymbols(t,e,s,i,n=!1){let r="";for(const t of i)t!==ut.None&&(r+=String.fromCharCode(t));this.Vp(t,e,s,r,n)}Vp(t,e,s,i,n){const r=this.Wp.textAlign,a=this.Wp.textBaseline,h=this.Wp.font;this.Wp.font=this.Op.toCssString(s),this.Wp.textBaseline="alphabetic",this.Wp.textAlign=n?"center":"left",this.Wp.fillText(i,t,e),this.Wp.textBaseline=a,this.Wp.font=h,this.Wp.textAlign=r}beginRotate(t,e,s){this.Wp.save(),this.Wp.translate(t,e),this.Wp.rotate(s*Math.PI/180)}endRotate(){this.Wp.restore()}}class Sa{$p;Hp;tickShift=0;constructor(t,e=!1){this.$p=t,this.Hp=e}addTickShift(t){this.$p.tickShift=t,this.tickShift=t}addTimeSignature(t,e,s){t+=this.tickShift;let i=0,n=s;for(;n>>=1,n>0;)i++;this.$p.addEvent(new vi(0,t,e,i,48,8))}addRest(t,e,s){e+=this.tickShift,this.Hp||this.$p.addEvent(new Ci(t,e,s))}addNote(t,e,s,i,n,r){e+=this.tickShift,this.$p.addEvent(new Fi(t,e,r,Sa.zp(i),Sa.zp(n))),this.$p.addEvent(new Ai(t,e+s,r,Sa.zp(i),Sa.zp(n)))}static zp(t){return t>127?127:t<0?0:t}addControlChange(t,e,s,i,n){e+=this.tickShift,this.$p.addEvent(new Di(t,e,s,i,Sa.zp(n)))}addProgramChange(t,e,s,i){e+=this.tickShift,this.$p.addEvent(new Li(t,e,s,i))}addTempo(t,e){t+=this.tickShift;const s=new Wi(t,0);s.beatsPerMinute=e,this.$p.addEvent(s)}addBend(t,e,s,i){e+=this.tickShift,i=i>=Ht.MaxPitchWheel?Ht.MaxPitchWheel:Math.floor(i),this.$p.addEvent(new Ri(t,e,s,i))}addNoteBend(t,e,s,i,n){e+=this.tickShift,this.Hp?this.addBend(t,e,s,n):(n=n*Ht.MaxPitchWheel20/Ht.MaxPitchWheel,this.$p.addEvent(new Ii(t,e,s,i,n)))}finishTrack(t,e){e+=this.tickShift,this.$p.format!==Ye.MultiTrack&&0!==t||this.$p.addEvent(new Oi(t,e))}}class Ba{group;opening;iterations;closingIndex=0;constructor(t,e){this.group=t,this.opening=e,t.closings=t.closings.sort((t,e)=>t.index-e.index),this.iterations=t.closings.map(t=>0)}}!function(t){t[t.PlayingNormally=0]="PlayingNormally",t[t.DirectionJumped=1]="DirectionJumped",t[t.DirectionJumpedAlCoda=2]="DirectionJumpedAlCoda",t[t.DirectionJumpedAlDoubleCoda=3]="DirectionJumpedAlDoubleCoda",t[t.DirectionJumpedAlFine=4]="DirectionJumpedAlFine"}(ps||(ps={}));class _a{Be;Xp=[];jp=new Set;Jp=0;li=ps.PlayingNormally;shouldPlay=!0;index=0;currentTick=0;get finished(){return this.index>=this.Be.masterBars.length}constructor(t){this.Be=t}processCurrent(){const t=this.Be.masterBars[this.index];if(this.li===ps.PlayingNormally){let e=t.alternateEndings;if(0===e&&(e=this.Jp),t===t.repeatGroup.opening&&t.repeatGroup.isClosed&&!this.jp.has(t.repeatGroup)){const s=new Ba(t.repeatGroup,t);this.Xp.push(s),this.jp.add(t.repeatGroup),this.Jp=0,e=t.alternateEndings}if(0===this.Xp.length||0===e)this.shouldPlay=!0;else{const t=this.Xp[this.Xp.length-1],s=t.iterations[t.closingIndex];this.Jp=e,this.shouldPlay=!!(e&1<<s)}}else this.shouldPlay=!0;this.shouldPlay&&(this.currentTick+=t.calculateDuration())}moveNext(){this.qp()||this.Yp()}Kp(){this.jp.clear(),this.Jp=0,this.Xp=[]}Qp(t,e,s){return!!t.has(e)&&(this.index=0,this.li=s,this.Kp(),!0)}Zp(t,e,s,i){if(t.has(e)){const t=this.tb(i,this.index,!0);return-1!==t&&(this.index=t,this.li=s,this.Kp(),!0)}return!1}eb(t,e,s){if(t.has(e)){const t=this.tb(s,this.index,!1);return-1===t?(this.index++,!0):(this.index=t,this.li=ps.PlayingNormally,!0)}return!1}qp(){const t=this.Be.masterBars[this.index],e=null!==t.directions&&t.directions.size>0;if(this.li===ps.PlayingNormally&&!e)return!1;if(!e)return this.index++,!0;switch(this.li){case ps.PlayingNormally:return!!(this.Qp(t.directions,Xe.JumpDaCapo,ps.DirectionJumped)||this.Qp(t.directions,Xe.JumpDaCapoAlCoda,ps.DirectionJumpedAlCoda)||this.Qp(t.directions,Xe.JumpDaCapoAlDoubleCoda,ps.DirectionJumpedAlDoubleCoda)||this.Qp(t.directions,Xe.JumpDaCapoAlFine,ps.DirectionJumpedAlFine))||(!!(this.Zp(t.directions,Xe.JumpDalSegno,ps.DirectionJumped,Xe.TargetSegno)||this.Zp(t.directions,Xe.JumpDalSegnoAlCoda,ps.DirectionJumpedAlCoda,Xe.TargetSegno)||this.Zp(t.directions,Xe.JumpDalSegnoAlDoubleCoda,ps.DirectionJumpedAlDoubleCoda,Xe.TargetSegno)||this.Zp(t.directions,Xe.JumpDalSegnoAlFine,ps.DirectionJumpedAlFine,Xe.TargetSegno))||!!(this.Zp(t.directions,Xe.JumpDalSegnoSegno,ps.DirectionJumped,Xe.TargetSegnoSegno)||this.Zp(t.directions,Xe.JumpDalSegnoSegnoAlCoda,ps.DirectionJumpedAlCoda,Xe.TargetSegnoSegno)||this.Zp(t.directions,Xe.JumpDalSegnoSegnoAlDoubleCoda,ps.DirectionJumpedAlDoubleCoda,Xe.TargetSegnoSegno)||this.Zp(t.directions,Xe.JumpDalSegnoSegnoAlFine,ps.DirectionJumpedAlFine,Xe.TargetSegnoSegno)));case ps.DirectionJumped:return this.index++,!0;case ps.DirectionJumpedAlCoda:return this.eb(t.directions,Xe.JumpDaCoda,Xe.TargetCoda)||this.index++,!0;case ps.DirectionJumpedAlDoubleCoda:return this.eb(t.directions,Xe.JumpDaDoubleCoda,Xe.TargetDoubleCoda)||this.index++,!0;case ps.DirectionJumpedAlFine:return t.directions.has(Xe.TargetFine)?(this.index=this.Be.masterBars.length,!0):(this.index++,!0)}return!0}tb(t,e,s){let i;return s?(i=this.sb(t,e),-1===i&&(i=this.ib(t,e)),i):(i=this.ib(t,e),-1===i&&(i=this.sb(t,e)),i)}ib(t,e){let s=e;for(;s<this.Be.masterBars.length;){const e=this.Be.masterBars[s].directions;if(e&&e.has(t))return s;s++}return-1}sb(t,e){let s=e;for(;s>=0;){const e=this.Be.masterBars[s].directions;if(e&&e.has(t))return s;s--}return-1}Yp(){const t=this.Be.masterBars[this.index].repeatCount-1;if(this.Xp.length>0&&t>0){const e=this.Xp[this.Xp.length-1];if(e.iterations[e.closingIndex]<t){this.index=e.opening.index,e.iterations[e.closingIndex]++;for(let t=0;t<e.closingIndex;t++)e.iterations[t]=0;e.closingIndex=0,this.Jp=0}else e.closingIndex<e.group.closings.length-1?(e.closingIndex++,this.index++):(this.Xp.pop(),this.jp.delete(e.group),this.index++)}else this.index++}}class Ta{beat;playbackStart;constructor(t,e){this.beat=t,this.playbackStart=e}}class xa{nb=new Map;start;end;highlightedBeats=[];nextBeat=null;previousBeat=null;get duration(){return this.end-this.start}constructor(t,e){this.start=t,this.end=e}highlightBeat(t,e){t.isEmpty&&!t.voice.isEmpty||this.nb.has(t.id)||(this.nb.set(t.id,!0),this.highlightedBeats.push(new Ta(t,e)))}getVisibleBeatAtStart(t){for(const e of this.highlightedBeats)if(e.playbackStart===this.start&&t.has(e.beat.voice.bar.staff.track.index))return e.beat;return null}getVisibleBeatAtStartWithChecker(t){for(const e of this.highlightedBeats)if(e.playbackStart===this.start&&t.isVisible(e.beat))return e.beat;return null}}class Ma{tick;tempo;constructor(t,e){this.tick=t,this.tempo=e}}class va{start=0;end=0;get tempo(){return this.tempoChanges[0].tempo}tempoChanges=[];masterBar;firstBeat=null;lastBeat=null;rb(t,e){null==this.firstBeat||null==t||null==this.lastBeat?(this.firstBeat=e,this.lastBeat=e):(e.nextBeat=t.nextBeat,e.previousBeat=t,t.nextBeat&&(t.nextBeat.previousBeat=e),t.nextBeat=e,t===this.lastBeat&&(this.lastBeat=e))}ab(t,e){null==this.firstBeat||null==t||null==this.lastBeat?(this.firstBeat=e,this.lastBeat=e):(e.previousBeat=t.previousBeat,e.nextBeat=t,t.previousBeat&&(t.previousBeat.nextBeat=e),t.previousBeat=e,t===this.firstBeat&&(this.firstBeat=e))}nextMasterBar=null;previousMasterBar=null;addBeat(e,s,i,n){const r=i+n;if(null==this.firstBeat){const t=new xa(i,r);t.highlightBeat(e,s),this.rb(this.firstBeat,t)}else if(i>=this.lastBeat.end){const t=new xa(this.lastBeat.end,r);t.highlightBeat(e,s),this.rb(this.lastBeat,t)}else{let n=null;if(i<this.firstBeat.start)n=this.firstBeat;else{let e=this.firstBeat;for(;null!=e;){if(i>=e.start&&i<e.end){n=e;break}e=e.nextBeat}if(null===n)throw new G(t.AlphaTabErrorType.General,"Error on building lookup, unknown variant")}if(i<n.start)if(r===n.start){const t=new xa(i,n.start);t.highlightBeat(e,s),this.ab(this.firstBeat,t)}else if(r<n.end){const t=new xa(i,n.start);t.highlightBeat(e,s),this.ab(n,t);const a=new xa(n.start,r);for(const t of n.highlightedBeats)a.highlightBeat(t.beat,t.playbackStart);a.highlightBeat(e,s),this.ab(n,a),n.start=r}else if(r===n.end){const t=new xa(i,n.start);t.highlightBeat(e,s),n.highlightBeat(e,s),this.ab(n,t)}else{const t=new xa(i,n.start);t.highlightBeat(e,s),n.highlightBeat(e,s),this.ab(n,t),this.addBeat(e,s,n.end,r-n.end)}else if(i>n.start)if(r===n.end){const t=new xa(n.start,i);for(const e of n.highlightedBeats)t.highlightBeat(e.beat,e.playbackStart);n.start=i,n.highlightBeat(e,s),this.ab(n,t)}else if(r<n.end){const t=new xa(n.start,i);this.ab(n,t);const a=new xa(i,r);this.ab(n,a);for(const e of n.highlightedBeats)t.highlightBeat(e.beat,e.playbackStart),a.highlightBeat(e.beat,e.playbackStart);a.highlightBeat(e,s),n.start=r}else{const t=new xa(n.start,i);for(const e of n.highlightedBeats)t.highlightBeat(e.beat,e.playbackStart);n.start=i,n.highlightBeat(e,s),this.ab(n,t),this.addBeat(e,s,n.end,r-n.end)}else if(r===n.end)n.highlightBeat(e,s);else if(r<n.end){const t=new xa(n.start,r);for(const e of n.highlightedBeats)t.highlightBeat(e.beat,e.playbackStart);t.highlightBeat(e,s),n.start=r,this.ab(n,t)}else n.highlightBeat(e,s),this.addBeat(e,s,n.end,r-n.end)}}}!function(t){t[t.Unknown=0]="Unknown",t[t.ToNextBext=1]="ToNextBext",t[t.ToEndOfBar=2]="ToEndOfBar"}(bs||(bs={}));class Na{beat;masterBar;beatLookup;nextBeat=null;tickDuration=0;duration=0;cursorMode=bs.Unknown;get start(){return this.masterBar.start+this.beatLookup.start}get end(){return this.start+this.tickDuration}constructor(t){this.masterBar=t}calculateDuration(){if(1===this.masterBar.tempoChanges.length)this.duration=$.ticksToMillis(this.tickDuration,this.masterBar.tempoChanges[0].tempo);else{let t=0,e=this.start,s=this.masterBar.tempoChanges[0].tempo;const i=this.end;for(const n of this.masterBar.tempoChanges)if(n.tick<e)s=n.tempo;else{if(n.tick>i)break;t+=$.ticksToMillis(n.tick-e,s),s=n.tempo,e=n.tick}i>e&&(t+=$.ticksToMillis(i-e,s)),this.duration=t}}}class Pa{hb;constructor(t){this.hb=t}isVisible(t){return this.hb.has(t.voice.bar.staff.track.index)}}class Ca{ob=null;masterBarLookup=new Map;masterBars=[];multiBarRestInfo=null;findBeat(t,e,s=null){return this.findBeatWithChecker(new Pa(t),e,s)}findBeatWithChecker(t,e,s=null){let i=null;return s&&(i=this.cb(t,s,e)),i||(i=this.lb(t,s,e,!1)),i}cb(t,e,s){if(s>=e.start&&s<e.end)return e;if(e.nextBeat&&s>=e.nextBeat.start&&s<e.nextBeat.end&&(void 0===t||t.isVisible(e.nextBeat.beat))){const s=e.nextBeat;return this.ub(s,t),s}return null}fb(t,e){const s=this.multiBarRestInfo.get(t.masterBar.masterBar.index);let i=t.masterBar;for(let t=0;t<s.length&&i;t++)i=i.nextMasterBar;i?i.nextMasterBar?(t.nextBeat=this.pb(e,i.nextMasterBar,i.nextMasterBar.start,!0),t.nextBeat?(t.tickDuration=t.nextBeat.start-t.start,t.cursorMode=bs.ToNextBext,t.nextBeat.masterBar.masterBar.index!==i.masterBar.index+1&&(t.nextBeat.masterBar.masterBar.index!==i.masterBar.index||t.nextBeat.beat.playbackStart<=t.beat.playbackStart)&&(t.cursorMode=bs.ToEndOfBar)):(t.tickDuration=i.nextMasterBar.end-t.start,t.cursorMode=bs.ToEndOfBar)):(t.tickDuration=i.end-t.start,t.cursorMode=bs.ToEndOfBar):(q.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain fill-next)"),t.tickDuration=(t.masterBar.end-t.masterBar.start)*(s.length+1),t.cursorMode=bs.ToEndOfBar),t.calculateDuration()}ub(t,e){this.bb(t)?this.fb(t,e):this.mb(t,e)}mb(t,e){t.nextBeat=this.gb(t.masterBar,t.beatLookup.nextBeat,t.end,e,!0),null==t.nextBeat&&(t.nextBeat=this.lb(e,t,t.end,!0)),t.nextBeat?(t.tickDuration=t.nextBeat.start-t.start,t.cursorMode=bs.ToNextBext,t.calculateDuration()):(t.tickDuration=t.masterBar.end-t.start,t.cursorMode=bs.ToEndOfBar,t.calculateDuration()),t.nextBeat&&t.nextBeat.masterBar.masterBar.index!==t.masterBar.masterBar.index+1&&(t.nextBeat.masterBar.masterBar.index!==t.masterBar.masterBar.index||t.nextBeat.beat.playbackStart<=t.beat.playbackStart)&&(t.cursorMode=bs.ToEndOfBar)}bb(t){return this.wb(t.masterBar.masterBar.index,t.beat)}wb(t,e){return this.multiBarRestInfo&&this.multiBarRestInfo.has(t)&&e.isRest&&e.voice.bar.isRestOnly}lb(t,e,s,i){let n=null;return null!=e&&(e.masterBar.start<=s&&e.masterBar.end>s?n=e.masterBar:e.masterBar.nextMasterBar&&e.masterBar.nextMasterBar.start<=s&&e.masterBar.nextMasterBar.end>s&&(n=e.masterBar.nextMasterBar)),n||(n=this.yb(s)),n?this.pb(t,n,s,i):null}pb(t,e,s,i){let n=e;for(;n;){if(n.firstBeat){const e=this.gb(n,n.firstBeat,s,t,i);if(e)return e}n=n.nextMasterBar}return null}gb(t,e,s,i,n){if(!e)return null;let r=null,a=null;const h=s-t.start;for(;null!=e&&null==a;){if((e.start<=h||n&&h<0)&&h<e.end){if(r=e,a=e.getVisibleBeatAtStartWithChecker(i),!a)if(n){let s=t;for(;null!=s&&null==a;){for(;null!=e;){if(a=e.getVisibleBeatAtStartWithChecker(i),a){r=e,t=s;break}e=e.nextBeat}a&&r||(s=s.nextMasterBar,e=s?.firstBeat??null)}}else{let s=t;for(;null!=s&&null==a;){for(;null!=e;){if(a=e.getVisibleBeatAtStartWithChecker(i),a){r=e,t=s;break}e=e.previousBeat}a&&r||(s=s.previousMasterBar,e=s?.firstBeat??null)}}}else if(e.end>h)break;e=e?.nextBeat??null}if(null==a)return null;return this.kb(t,r,a,n,i)}kb(t,e,s,i,n){const r=new Na(t);if(r.beat=s,r.beatLookup=e,r.tickDuration=e.end-e.start,i){if(this.bb(r)){const s=this.multiBarRestInfo.get(t.masterBar.index);let i=t;for(let t=0;t<s.length&&i;t++)i=i.nextMasterBar;i?i.nextMasterBar?r.tickDuration=i.nextMasterBar.start-e.start:r.tickDuration=i.end-e.start:q.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain stretch-result)")}}else this.ub(r,n);return r.calculateDuration(),r}yb(t){if(t<=0&&this.masterBars.length>0)return this.masterBars[0];const e=this.masterBars;let s=0,i=e.length-1;for(;s<=i;){const n=(i+s)/2|0,r=e[n];if(t>=r.start&&t<r.end)return r;t<r.start?i=n-1:s=n+1}return null}getMasterBar(t){if(!this.masterBarLookup.has(t.index)){const e=new va;return e.masterBar=t,e}return this.masterBarLookup.get(t.index)}getMasterBarStart(t){return this.masterBarLookup.has(t.index)?this.masterBarLookup.get(t.index).start:0}getBeatStart(t){return this.masterBarLookup.has(t.voice.bar.index)?this.masterBarLookup.get(t.voice.bar.index).start+t.playbackStart:0}addMasterBar(t){this.masterBars.push(t),this.ob&&(t.previousMasterBar=this.ob,this.ob.nextMasterBar=t),this.ob=t,this.masterBarLookup.has(t.masterBar.index)||this.masterBarLookup.set(t.masterBar.index,t)}addBeat(t,e,s){const i=this.ob;if(i)if(e<0&&i.previousMasterBar){const n=i.previousMasterBar.end-i.previousMasterBar.start,r=n+e,a=r+s;if(i.previousMasterBar.addBeat(t,r,r,s),a>n){const n=s+e;i.addBeat(t,e,0,n)}}else i.addBeat(t,e,e,s)}}class Ea{noteOnly=0;untilTieOrSlideEnd=0;letRingEnd=0;beatDurationFactor=1}class Fa{firstBeatDuration=0;secondBeatStartOffset=0;secondBeatDuration=0}class Aa{durations=[];brushInfos=[]}class Da{synthTick=0;synthTime=0;currentTempo=0;automationToSyncPoint=new Map;syncPoints;createNewSyncPoints=!1}class La{static Sb=30;static _b=80;Be;Dl;ci;Tb=new Map;xb=0;Mb=new Set;tickLookup=new Ca;applyTranspositionPitches=!0;syncPoints=[];transpositionPitches=new Map;constructor(t,e,s){this.Be=t,this.Dl=e||new aa,this.ci=s}generate(){this.transpositionPitches.clear(),this.Mb.clear(),this.xb=0;for(const t of this.Be.tracks)this.Nb(t);q.debug("Midi","Begin midi generation"),this.syncPoints=[],La.Pb(this.Be,this.syncPoints,!1,(t,e,s,i,n)=>{this.Fb(t,e,s,i,n),0===t.index&&0===n&&this.Lb()},(t,e,s)=>{for(const i of this.Be.tracks)for(const n of i.staves)t<n.bars.length&&this.Wb(n.bars[t],e,s)},t=>{for(const e of this.Be.tracks)this.ci.finishTrack(e.index,t)}),q.debug("Midi","Midi generation done")}Lb(){let t=0;for(const e of this.Be.tracks)for(const s of e.staves)for(const e of s.bars[0].voices)if(!e.isEmpty){const s=e.beats[0];s.playbackStart<t&&(t=s.playbackStart)}t=Math.abs(t),this.ci.addTickShift(t)}Nb(t){this.Rb(t,t.playbackInfo.primaryChannel,t.playbackInfo),t.playbackInfo.primaryChannel!==t.playbackInfo.secondaryChannel&&this.Rb(t,t.playbackInfo.secondaryChannel,t.playbackInfo)}Ib(t,e,s,i){this.Tb.has(s)&&this.Tb.get(s)===i||(this.ci.addProgramChange(t.index,e,s,i),this.Tb.set(s,i))}Ob(t,e,s,i){const n=we.bankToLsbMsb(i);this.ci.addControlChange(t.index,e,s,rs.BankSelectCoarse,n[1]),this.ci.addControlChange(t.index,e,s,rs.BankSelectFine,n[0])}static buildTranspositionPitches(t,e){const s=new Map;for(const i of t.tracks){const t=i.index<e.notation.transpositionPitches.length?e.notation.transpositionPitches[i.index]:-i.staves[0].transpositionPitch;s.set(i.playbackInfo.primaryChannel,t),s.set(i.playbackInfo.secondaryChannel,t)}return s}Rb(t,e,s){const i=t.index<this.Dl.notation.transpositionPitches.length?this.Dl.notation.transpositionPitches[t.index]:-t.staves[0].transpositionPitch;this.transpositionPitches.set(e,i);const n=La.Vb(s.volume),r=La.Vb(s.balance);this.ci.addControlChange(t.index,0,e,rs.VolumeCoarse,n),this.ci.addControlChange(t.index,0,e,rs.PanCoarse,r),this.ci.addControlChange(t.index,0,e,rs.ExpressionControllerCoarse,127),this.ci.addControlChange(t.index,0,e,rs.RegisteredParameterFine,0),this.ci.addControlChange(t.index,0,e,rs.RegisteredParameterCourse,0),this.ci.addControlChange(t.index,0,e,rs.DataEntryFine,0),this.ci.addControlChange(t.index,0,e,rs.DataEntryCoarse,La.$b),this.Ob(t,0,e,s.bank),this.Ib(t,0,e,s.program)}static generateSyncPoints(t,e=!1){const s=[];return La.Pb(t,s,e,(t,e,s,i,n)=>{},(t,e,s)=>{},t=>{}),s}static buildModifiedTempoLookup(t){return La.Pb(t,[],!1,(t,e,s,i,n)=>{},(t,e,s)=>{},t=>{}).automationToSyncPoint}static Pb(t,e,s,i,n,r){const a=new _a(t),h=new Da;h.currentTempo=t.tempo,h.syncPoints=e,h.createNewSyncPoints=s;let o=null;const c=new Map;for(;!a.finished;){const e=a.index,s=t.masterBars[e],r=a.currentTick;if(a.processCurrent(),a.shouldPlay){let t=c.has(e)?c.get(e):-1;t++,c.set(e,t),i(s,o,r,h.currentTempo,t);n(e,r,s.tempoAutomations.length>0?s.tempoAutomations[0].value:h.currentTempo),h.synthTick=r,La.Hb(s,t,h)}a.moveNext(),o=s}if(e.length>0){const t=e[e.length-1],s=a.currentTick-t.synthTick;if(s>0){const i=new Vi;i.masterBarIndex=o.index,i.masterBarOccurence=c.get(o.index)-1,i.synthTick=a.currentTick,i.synthBpm=h.currentTempo,h.createNewSyncPoints?(i.syncBpm=t.synthBpm,i.synthBpm=t.synthBpm):1===e.length?i.syncBpm=t.synthBpm:i.syncBpm=e[e.length-2].syncBpm,i.synthTime=t.synthTime+$.ticksToMillis(s,t.synthBpm),i.syncTime=t.syncTime+$.ticksToMillis(s,i.syncBpm),h.createNewSyncPoints||t.updateSyncBpm(i.synthTime,i.syncTime),e.push(i)}}return r(a.currentTick),h}static Hb(t,e,s){const i=t.calculateDuration(),n=t.syncPoints,r=s.synthTick;s.createNewSyncPoints?La.Ub(t,e,s):n?La.zb(t,e,s):La.Xb(t,s);const a=r+i,h=a-s.synthTick;h>0&&(s.synthTime+=$.ticksToMillis(h,s.currentTempo),s.synthTick=a)}static Ub(t,e,s){const i=s.synthTick;if(0===t.index&&0===e){s.currentTempo=t.score.tempo;const n=new Vi;n.masterBarIndex=t.index,n.masterBarOccurence=e,n.synthTick=i,n.synthBpm=s.currentTempo,n.synthTime=s.synthTime,n.syncBpm=s.currentTempo,n.syncTime=s.synthTime,s.syncPoints.push(n)}const n=t.calculateDuration();for(const r of t.tempoAutomations){const a=i+r.ratioPosition*n,h=a-s.synthTick;if(h>0&&(s.synthTick=a,s.synthTime+=$.ticksToMillis(h,s.currentTempo)),r.value!==s.currentTempo){s.currentTempo=r.value;const i=new Vi;i.masterBarIndex=t.index,i.masterBarOccurence=e,i.synthTick=a,i.synthBpm=s.currentTempo,i.synthTime=s.synthTime,i.syncBpm=s.currentTempo,i.syncTime=s.synthTime,s.syncPoints.push(i)}}}static zb(t,e,s){const i=s.synthTick,n=t.calculateDuration();let r,a=0;for(const h of t.syncPoints){if(h.syncPointValue.barOccurence!==e)continue;const o=i+h.ratioPosition*n;for(;a<t.tempoAutomations.length&&t.tempoAutomations[a].ratioPosition<=h.ratioPosition;){const e=t.tempoAutomations[a],h=i+e.ratioPosition*n;r=h-s.synthTick,r>0&&(s.synthTick=h,s.synthTime+=$.ticksToMillis(r,s.currentTempo)),s.currentTempo=e.value,a++}r=o-s.synthTick,r>0&&(s.synthTick=o,s.synthTime+=$.ticksToMillis(r,s.currentTempo)),s.syncPoints.length>0&&s.syncPoints[s.syncPoints.length-1].updateSyncBpm(s.synthTime,h.syncPointValue.millisecondOffset);const c=new Vi;c.masterBarIndex=t.index,c.masterBarOccurence=e,c.synthTick=o,c.synthBpm=s.currentTempo,c.synthTime=s.synthTime,c.syncTime=h.syncPointValue.millisecondOffset,c.syncBpm=0,s.syncPoints.push(c),s.automationToSyncPoint.set(h,c)}for(;a<t.tempoAutomations.length;){const e=t.tempoAutomations[a],h=i+e.ratioPosition*n;r=h-s.synthTick,r>0&&(s.synthTick=h,s.synthTime+=$.ticksToMillis(r,s.currentTempo)),s.currentTempo=e.value,a++}}static Xb(t,e){const s=e.synthTick,i=t.calculateDuration();for(const n of t.tempoAutomations){const t=s+n.ratioPosition*i,r=t-e.synthTick;r>0&&(e.synthTick=t,e.synthTime+=$.ticksToMillis(r,e.currentTempo)),e.currentTempo=n.value}}static Vb(t){const e=Math.max(-32768,Math.min(32767,8*t-1));return Math.max(e,-1)+1}Fb(t,e,s,i,n){e&&e.timeSignatureDenominator===t.timeSignatureDenominator&&e.timeSignatureNumerator===t.timeSignatureNumerator||this.ci.addTimeSignature(s,t.timeSignatureNumerator,t.timeSignatureDenominator);const r=t.calculateDuration(),a=new va;if(t.tempoAutomations.length>0){t.tempoAutomations[0].ratioPosition>0&&a.tempoChanges.push(new Ma(s,i));for(const e of t.tempoAutomations){const t=s+r*e.ratioPosition;this.ci.addTempo(t,e.value),a.tempoChanges.push(new Ma(t,e.value))}}else e?a.tempoChanges.push(new Ma(s,i)):(this.ci.addTempo(s,t.score.tempo),a.tempoChanges.push(new Ma(s,t.score.tempo)));a.masterBar=t,a.start=s,a.end=a.start+r,this.tickLookup.addMasterBar(a)}Wb(t,e,s){const i=this.jb(t),n=this.xb;for(const r of i.voices)this.xb=n,this.Jb(r,e,t,s);const r=i.masterBar,a=r.calculateDuration(),h=r.tempoAutomations.slice();if(0===h.length)this.xb=n+$.ticksToMillis(a,s);else{this.xb=n;let t=e,i=s;const r=e+a;for(const e of h){const s=a*e.ratioPosition-t;s>0&&(this.xb+=$.ticksToMillis(s,i)),i=e.value,t+=s}const o=r-t;o>0&&(this.xb+=$.ticksToMillis(o,i))}i.id!==t.id&&this.tickLookup.addBeat(t.voices[0].beats[0],0,a)}jb(t){switch(t.simileMark){case v.Simple:t.previousBar&&(t=this.jb(t.previousBar));break;case v.FirstOfDouble:case v.SecondOfDouble:t.previousBar&&t.previousBar.previousBar&&(t=this.jb(t.previousBar.previousBar))}return t}Jb(t,e,s,i){if(t.isEmpty&&(!t.bar.isEmpty||0!==t.index))return;const n=s.masterBar.tempoAutomations.slice();let r=i;const a=s.masterBar.calculateDuration();for(const i of t.beats){const t=i.playbackStart/a;for(;n.length>0&&n[0].ratioPosition<=t;)r=n.shift().value;this.qb(i,e,s,r)}}Yb=null;qb(t,e,s,i){let n=t.playbackStart,r=t.playbackDuration;const a=t.voice.bar.masterBar.calculateDuration();t.voice.bar.isEmpty?r=a:t.voice.bar.masterBar.tripletFeel!==A.NoTripletFeel&&this.Dl.player.playTripletFeel&&(this.Yb?(n-=this.Yb.secondBeatStartOffset,r=this.Yb.secondBeatDuration,this.Yb=null):(this.Yb=La.Kb(n,r,t),this.Yb&&(r=this.Yb.firstBeatDuration))),t.showTimer&&!this.Mb.has(t.id)&&(t.timer=this.xb,this.Mb.add(t.id)),this.xb+=$.ticksToMillis(r,i),s===t.voice.bar&&this.tickLookup.addBeat(t,n,r);const h=t.voice.bar.staff.track;for(const s of t.automations)this.Qb(t,s,e);if(t.isRest)this.ci.addRest(h.index,e+n,h.playbackInfo.primaryChannel);else if(t.deadSlapped)this.Zb(t,e+n);else{const s=this.tm(t),a=this.sm(t,r);for(const h of t.notes)this.im(h,e+n,r,i,s,a)}if(t.fade!==gt.None&&this.nm(t,e+n,r),t.vibrato!==y.None){let s=240,i=3;switch(t.vibrato){case y.Slight:s=this.Dl.player.vibrato.beatSlightLength,i=this.Dl.player.vibrato.beatSlightAmplitude;break;case y.Wide:s=this.Dl.player.vibrato.beatWideLength,i=this.Dl.player.vibrato.beatWideAmplitude}this.rm(e+n,t.playbackDuration,s,0,i,(e,s)=>{this.ci.addBend(t.voice.bar.staff.track.index,e,h.playbackInfo.secondaryChannel,s)})}}static Kb(t,e,s){let i;switch(s.voice.bar.masterBar.tripletFeel){case A.Triplet8th:case A.Dotted8th:case A.Scottish8th:i=l.Eighth;break;case A.Triplet16th:case A.Dotted16th:case A.Scottish16th:i=l.Sixteenth;break;default:return null}const n=$.toTicks(i);if(e!==n)return null;if(t%n!==0)return null;if(!s.nextBeat||s.nextBeat.voice!==s.voice||s.playbackDuration!==n)return null;const r=new Fa;switch(s.voice.bar.masterBar.tripletFeel){case A.Triplet8th:r.firstBeatDuration=$.applyTuplet($.toTicks(l.Quarter),3,2),r.secondBeatDuration=$.applyTuplet($.toTicks(l.Eighth),3,2);break;case A.Dotted8th:r.firstBeatDuration=$.applyDot($.toTicks(l.Eighth),!1),r.secondBeatDuration=$.toTicks(l.Sixteenth);break;case A.Scottish8th:r.firstBeatDuration=$.toTicks(l.Sixteenth),r.secondBeatDuration=$.applyDot($.toTicks(l.Eighth),!1);break;case A.Triplet16th:r.firstBeatDuration=$.applyTuplet($.toTicks(l.Eighth),3,2),r.secondBeatDuration=$.applyTuplet($.toTicks(l.Sixteenth),3,2);break;case A.Dotted16th:r.firstBeatDuration=$.applyDot($.toTicks(l.Sixteenth),!1),r.secondBeatDuration=$.toTicks(l.ThirtySecond);break;case A.Scottish16th:r.firstBeatDuration=$.toTicks(l.ThirtySecond),r.secondBeatDuration=$.applyDot($.toTicks(l.Sixteenth),!1)}return r.secondBeatStartOffset=e-r.firstBeatDuration,r}Zb(t,e){const s=$.toTicks(l.SixtyFourth),i=t.voice.bar.staff;if(i.tuning.length>0)for(const t of i.tuning)this.ci.addNote(i.track.index,e,s,t,$.dynamicToVelocity(n.F),i.track.playbackInfo.primaryChannel)}am(t){return t.hasBend||t.beat.hasWhammyBar||t.beat.vibrato!==y.None}hm(t,e){if(this.am(e))return t.playbackInfo.secondaryChannel;let s=e;for(;s.isTieDestination;)if(s=s.tieOrigin,this.am(s))return t.playbackInfo.secondaryChannel;for(s=e;s.isTieOrigin;)if(s=s.tieDestination,this.am(s))return t.playbackInfo.secondaryChannel;return t.playbackInfo.primaryChannel}im(t,e,s,i,n,r){const a=t.beat.voice.bar.staff.track,h=t.beat.voice.bar.staff;let o=t.calculateRealValue(this.applyTranspositionPitches,!0);if(t.isPercussion){const e=qt.getArticulation(t);e&&(o=e.outputMidiNumber)}const c=null==r&&t.isStringed&&t.string<=n.length?n[t.string-1]:0,l=e+c,u=this.om(t,s,i);u.untilTieOrSlideEnd-=c,u.noteOnly-=c,u.letRingEnd-=c;const d=La.lm(t),f=this.hm(a,t);let p=0;const b=Math.max(u.untilTieOrSlideEnd,u.letRingEnd);p=t.hasBend?La.getPitchWheel(t.bendPoints[0].value):t.beat.hasWhammyBar?La.getPitchWheel(t.beat.whammyBarPoints[0].value):t.isTieDestination||t.slideOrigin&&t.slideOrigin.slideOutType===w.Legato?-1:La.getPitchWheel(0),p>=0&&this.ci.addNoteBend(a.index,l,f,o,p),t.beat.hasRasgueado?this.um(a,t,l,o,d,f,r):t.ornament===ft.None?!t.isTrill||h.isPercussion?t.beat.isTremolo?this.dm(t,l,u,o,d,f):(t.hasBend?this.fm(t,l,u,o,f,i):t.beat.hasWhammyBar&&0===t.index?this.pm(t.beat,l,u,f,i):t.slideInType!==g.None||t.slideOutType!==w.None?this.bm(t,l,u,o,f,i):(t.vibrato!==y.None||t.isTieDestination&&t.tieOrigin.vibrato!==y.None)&&this.gm(t,l,u,o,f),t.isTieDestination||t.slideOrigin&&t.slideOrigin.slideOutType===w.Legato||this.ci.addNote(a.index,l,b,o,d,f)):this.wm(t,l,u,o,d,f):this.ym(a,t,l,b,o,d,f)}static km=[2,2,2,1,1,2,2,2,2,2,1,1];static ornamentKeysDown=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];ym(t,e,s,i,n,r,a){let h,o;const c=n%12,u=1/3;switch(e.ornament){case ft.Turn:h=[n+La.km[c],n,n+La.ornamentKeysDown[c]],o=[$.toTicks(l.Sixteenth)*u,$.toTicks(l.Sixteenth)*u,$.toTicks(l.Sixteenth)*u];break;case ft.InvertedTurn:h=[n+La.ornamentKeysDown[c],n,n+La.km[c]],o=[$.toTicks(l.Sixteenth)*u,$.toTicks(l.Sixteenth)*u,$.toTicks(l.Sixteenth)*u];break;case ft.UpperMordent:h=[n,n+La.km[c]],o=[$.toTicks(l.ThirtySecond),$.toTicks(l.ThirtySecond)];break;case ft.LowerMordent:h=[n,n+La.ornamentKeysDown[c]],o=[$.toTicks(l.ThirtySecond),$.toTicks(l.ThirtySecond)];break;default:return}let d=1;i<$.QuarterTime&&(d=i/$.QuarterTime),r-=$.VelocityIncrement;let f=0;for(let e=0;e<h.length;e++){const i=o[e]*d;this.ci.addNote(t.index,s,i,h[e],r,a),s+=i,f+=i}const p=i-f;this.ci.addNote(t.index,s,p,n,r,a)}om(e,s,i){const n=new Ea,r=$.toTicks(e.beat.duration);if(n.beatDurationFactor=s/r,n.noteOnly=s,n.untilTieOrSlideEnd=s,n.letRingEnd=s,e.isDead)return n.noteOnly=this.Sm(La.Sb,s,i),n.untilTieOrSlideEnd=n.noteOnly,n.letRingEnd=n.noteOnly,n;if(e.isPalmMute)return n.noteOnly=this.Sm(La._b,s,i),n.untilTieOrSlideEnd=n.noteOnly,n.letRingEnd=n.noteOnly,n;if(e.isStaccato)return n.noteOnly=s/2|0,n.untilTieOrSlideEnd=n.noteOnly,n.letRingEnd=n.noteOnly,n;if(e.isTieOrigin){const t=e.tieDestination;if(t)if(e.isTieDestination){const e=this.om(t,t.beat.playbackDuration,i);n.untilTieOrSlideEnd=s+e.untilTieOrSlideEnd}else{const s=e.beat.absolutePlaybackStart,r=this.om(t,t.beat.playbackDuration,i),a=t.beat.absolutePlaybackStart+r.untilTieOrSlideEnd;n.untilTieOrSlideEnd=a-s}}else if(e.slideOutType===w.Legato){const t=e.slideTarget;if(t){const s=e.beat.absolutePlaybackStart,r=this.om(t,t.beat.playbackDuration,i),a=t.beat.absolutePlaybackStart+r.untilTieOrSlideEnd;n.untilTieOrSlideEnd=a-s}}if(e.isLetRing&&this.Dl.notation.notationMode===t.NotationMode.GuitarPro){let t=e.beat,i=0;const r=e.beat.voice.bar.masterBar.calculateDuration();for(;t.nextBeat;){const s=t.nextBeat;if(s.isRest)break;if(e.isStringed&&s.hasNoteOnString(e.string))break;if(t=t.nextBeat,i=t.absolutePlaybackStart-e.beat.absolutePlaybackStart+t.playbackDuration,i>r){i=r;break}}t===e.beat?n.letRingEnd=s:n.letRingEnd=i}else n.letRingEnd=n.untilTieOrSlideEnd;return n}Sm(t,e,s){const i=s*t/z.MaxPosition|0;return Math.min(i,e)}static lm(t){let e=0;switch(!t.beat.voice.bar.staff.isPercussion&&t.hammerPullOrigin&&e--,t.isGhost&&e--,t.accentuated){case d.Normal:e++;break;case d.Heavy:e+=2}return $.dynamicToVelocity(t.dynamics,e)}nm(t,e,s){const i=t.voice.bar.staff.track;switch(t.fade){case gt.FadeIn:this.Bm(i,e,s,0,La.Vb(i.playbackInfo.volume));break;case gt.FadeOut:this.Bm(i,e,s,La.Vb(i.playbackInfo.volume),0);break;case gt.VolumeSwell:const t=s/2|0;this.Bm(i,e,t,0,La.Vb(i.playbackInfo.volume)),this.Bm(i,e+t,t,La.Vb(i.playbackInfo.volume),0)}}Bm(t,e,s,i,n){const r=(n-i)/(s=.8*s|0),a=s/120+1|0,h=e+s;for(let s=0;s<a;s++){const o=s===a-1,c=o?h:e+120*s,l=o?n:Math.round(i+(c-e)*r);this.ci.addControlChange(t.index,c,t.playbackInfo.primaryChannel,rs.VolumeCoarse,l),this.ci.addControlChange(t.index,c,t.playbackInfo.secondaryChannel,rs.VolumeCoarse,l)}}gm(t,e,s,i,n){let r=0,a=0;switch(t.vibrato!==y.None?t.vibrato:t.isTieDestination?t.tieOrigin.vibrato:y.Slight){case y.Slight:r=this.Dl.player.vibrato.noteSlightLength,a=this.Dl.player.vibrato.noteSlightAmplitude;break;case y.Wide:r=this.Dl.player.vibrato.noteWideLength,a=this.Dl.player.vibrato.noteWideAmplitude;break;default:return}const h=t.beat.voice.bar.staff.track;let o=0;if(t.isTieDestination&&t.tieOrigin.hasBend){const e=t.tieOrigin.bendPoints;o=e[e.length-1].value}this.rm(e,s.noteOnly,r,o,a,(t,e)=>{this.ci.addNoteBend(h.index,t,n,i,e)})}vibratoResolution=16;rm(t,e,s,i,n,r){const a=this.vibratoResolution,h=s/2|0,o=t+e;for(;t<o;){let e=0;const c=t+s<o?s:o-t;for(;e<c;){const s=i+n*Math.sin(e*Math.PI/h);r(t+e|0,La.getPitchWheel(s)),e+=a}t+=s}r(0|o,La.getPitchWheel(i))}static $b=16;static _m=Ht.DefaultPitchWheel/La.$b;static Tm=6;static xm=150;static getPitchWheel(t){return Ht.DefaultPitchWheel+t/2*La._m}bm(t,e,s,i,n,r){const a=t.slideOutType===w.Legato?s.noteOnly:s.untilTieOrSlideEnd,h=[],o=t.beat.voice.bar.staff.track,c=this.Dl.player.slide.simpleSlidePitchOffset,l=Math.floor(z.MaxPosition*this.Dl.player.slide.simpleSlideDurationRatio),u=Math.floor(z.MaxPosition*this.Dl.player.slide.shiftSlideDurationRatio);switch(t.slideInType){case g.IntoFromAbove:h.push(new z(0,c)),h.push(new z(l,0));break;case g.IntoFromBelow:h.push(new z(0,-c)),h.push(new z(l,0))}switch(t.slideOutType){case w.Legato:case w.Shift:h.push(new z(u,0));const e=2*(t.slideTarget.calculateRealValue(this.applyTranspositionPitches,!0)-t.calculateRealValue(this.applyTranspositionPitches,!0));h.push(new z(z.MaxPosition,e));break;case w.OutDown:h.push(new z(z.MaxPosition-l,0)),h.push(new z(z.MaxPosition,-c));break;case w.OutUp:h.push(new z(z.MaxPosition-l,0)),h.push(new z(z.MaxPosition,c))}this.Mm(e,a,h,r,(t,e)=>{this.ci.addNoteBend(o.index,t,n,i,e)})}fm(t,e,s,i,n,r){const o=t.bendPoints,c=t.beat.voice.bar.staff.track,l=(t,e)=>{this.ci.addNoteBend(c.index,t,n,i,e)};let d,f=null;if(t.isTieOrigin&&this.Dl.notation.extendBendArrowsOnTiedNotes){let e=t;for(;e.isTieOrigin&&!e.tieDestination.hasBend&&e.tieDestination.vibrato===y.None;)e=e.tieDestination;d=e.beat.absolutePlaybackStart-t.beat.absolutePlaybackStart+this.om(e,e.beat.playbackDuration,r).noteOnly}else if(t.isTieOrigin&&t.beat.graceType!==u.None){switch(t.tieDestination.bendType){case h.Bend:case h.BendRelease:case h.PrebendBend:f=t.tieDestination.bendPoints[1].value;break;case h.Prebend:case h.PrebendRelease:f=t.tieDestination.bendPoints[0].value}d=Math.max(s.noteOnly,$.millisToTicks(this.Dl.player.songBookBendDuration,r))}else d=s.noteOnly;o[0].value>0&&!t.isContinuedBend&&e>0&&e--;const p=Math.min(d,$.millisToTicks(this.Dl.player.songBookBendDuration,r));let b=[];switch(t.bendType){case h.Custom:b=o;break;case h.Bend:case h.Release:switch(t.bendStyle){case a.Default:b=o;break;case a.Gradual:b.push(new z(0,t.bendPoints[0].value)),(!f||f<t.bendPoints[1].value)&&(f=t.bendPoints[1].value),b.push(new z(z.MaxPosition,f));break;case a.Fast:return(!f||f<t.bendPoints[1].value)&&(f=t.bendPoints[1].value),void(t.beat.graceType===u.BendGrace?this.vm(e,d,!0,[t.bendPoints[0].value,f],p,r,l):this.vm(e,d,!1,[t.bendPoints[0].value,f],p,r,l))}break;case h.BendRelease:switch(t.bendStyle){case a.Default:b=o;break;case a.Gradual:b.push(new z(0,t.bendPoints[0].value)),b.push(new z(z.MaxPosition/2|0,t.bendPoints[1].value)),b.push(new z(z.MaxPosition,t.bendPoints[2].value));break;case a.Fast:return void this.vm(e,d,!1,[t.bendPoints[0].value,t.bendPoints[1].value,t.bendPoints[2].value],p,r,l)}break;case h.Hold:case h.Prebend:b=o;break;case h.PrebendBend:switch(t.bendStyle){case a.Default:b=o;break;case a.Gradual:b.push(new z(0,t.bendPoints[0].value)),b.push(new z(z.MaxPosition,t.bendPoints[1].value));break;case a.Fast:return l(e,0|La.getPitchWheel(t.bendPoints[0].value)),(!f||f<t.bendPoints[1].value)&&(f=t.bendPoints[1].value),void this.vm(e,d,!1,[t.bendPoints[0].value,f],p,r,l)}break;case h.PrebendRelease:switch(t.bendStyle){case a.Default:b=o;break;case a.Gradual:b.push(new z(0,t.bendPoints[0].value)),b.push(new z(z.MaxPosition,t.bendPoints[1].value));break;case a.Fast:return l(e,0|La.getPitchWheel(t.bendPoints[0].value)),void this.vm(e,d,!1,[t.bendPoints[0].value,t.bendPoints[1].value],p,r,l)}}this.Mm(e,d,b,r,l)}vm(t,e,s,i,n,r,a){const h=s?t:t+e-n,o=n/(i.length-1);for(let t=0;t<i.length-1;t++){const e=La.getPitchWheel(i[t]),s=La.getPitchWheel(i[t+1]),n=h+o*t;this.Nm(n,o,e,s,r,a)}}pm(t,e,s,i,n){const r=t.whammyBarPoints,h=t.voice.bar.staff.track,o=s.noteOnly;r[0].value>0&&!t.isContinuedWhammy&&e--;const c=(t,e)=>{this.ci.addBend(h.index,t,i,e)};let l=[];switch(t.whammyBarType){case bt.Custom:l=r;break;case bt.Dive:switch(t.whammyStyle){case a.Default:l=r;break;case a.Gradual:l.push(new z(0,r[0].value)),l.push(new z(z.MaxPosition,r[1].value));break;case a.Fast:const t=Math.min(o,$.millisToTicks(this.Dl.player.songBookBendDuration,n));return void this.vm(e,o,!1,[r[0].value,r[1].value],t,n,c)}break;case bt.Dip:switch(t.whammyStyle){case a.Default:l=r;break;case a.Gradual:l.push(new z(0,r[0].value)),l.push(new z(z.MaxPosition/2|0,r[1].value)),l.push(new z(z.MaxPosition,r[2].value));break;case a.Fast:const t=Math.min(o,$.millisToTicks(this.Dl.player.songBookDipDuration,n));return void this.vm(e,o,!0,[r[0].value,r[1].value,r[2].value],t,n,c)}break;case bt.Hold:case bt.Predive:l=r;break;case bt.PrediveDive:switch(t.whammyStyle){case a.Default:l=r;break;case a.Gradual:l.push(new z(0,r[0].value)),l.push(new z(z.MaxPosition/2|0,r[0].value)),l.push(new z(z.MaxPosition,r[1].value));break;case a.Fast:const t=La.getPitchWheel(r[0].value);this.ci.addBend(h.index,e,i,0|t);const s=Math.min(o,$.millisToTicks(this.Dl.player.songBookBendDuration,n));return void this.vm(e,o,!1,[r[0].value,r[1].value],s,n,c)}}this.Mm(e,o,l,n,c)}Mm(t,e,s,i,n){const r=e/z.MaxPosition;for(let e=0;e<s.length-1;e++){const a=s[e],h=s[e+1],o=La.getPitchWheel(a.value),c=La.getPitchWheel(h.value),l=r*(h.offset-a.offset),u=t+r*a.offset;this.Nm(u,l,o,c,i,n)}}Nm(t,e,s,i,n,r){const a=$.ticksToMillis(e,n),h=Math.abs(i-s)/La._m,o=Math.max(La.Tm*h,a/La.xm),c=e/o,l=(i-s)/o,u=t+e;for(let e=0;e<o;e++)r(0|t,Math.round(s)),s+=l,t+=c;r(0|u,i)}um(t,e,s,i,n,r,a){let h=s;for(let s=0;s<a.durations.length;s++){const o=a.brushInfos[s],c=e.isStringed&&e.string<=o.length?o[e.string-1]:0,l=a.durations[s];this.ci.addNote(t.index,h+c,l-c,i,n,r),h+=l}}wm(t,e,s,i,n,r){const a=t.beat.voice.bar.staff.track,h=t.stringTuning+t.trillFret;let o=$.toTicks(t.trillSpeed),c=!0,l=e;const u=e+s.untilTieOrSlideEnd;for(;l+10<u;)l+o>=u&&(o=u-l),this.ci.addNote(a.index,l,o,c?i:h,n,r),c=!c,l+=o}dm(t,e,s,i,n,r){const a=t.beat.voice.bar.staff.track;if(0===t.beat.tremoloPicking.marks)return;let h=t.beat.tremoloPicking.getDurationAsTicks(t.beat.duration)*s.beatDurationFactor,o=e;const c=e+s.untilTieOrSlideEnd;for(;o+10<c;)o+h>=c&&(h=c-o),this.ci.addNote(a.index,o,h,i,n,r),o+=h}static Pm=new Map([[kt.Ii,[o.BrushDown,o.BrushUp]],[kt.Mi,[o.BrushDown,o.BrushDown]],[kt.MiiTriplet,[o.BrushDown,o.BrushDown,o.BrushUp]],[kt.MiiAnapaest,[o.BrushDown,o.BrushDown,o.BrushUp]],[kt.PmpTriplet,[o.BrushUp,o.BrushDown,o.BrushDown]],[kt.PmpAnapaest,[o.BrushUp,o.BrushDown,o.BrushDown]],[kt.PeiTriplet,[o.BrushUp,o.BrushDown,o.BrushDown]],[kt.PeiAnapaest,[o.BrushUp,o.BrushDown,o.BrushDown]],[kt.PaiTriplet,[o.BrushUp,o.BrushDown,o.BrushDown]],[kt.PaiAnapaest,[o.BrushUp,o.BrushDown,o.BrushDown]],[kt.AmiTriplet,[o.BrushDown,o.BrushDown,o.BrushDown]],[kt.AmiAnapaest,[o.BrushDown,o.BrushDown,o.BrushDown]],[kt.Ppp,[o.None,o.BrushDown,o.BrushUp]],[kt.Amii,[o.BrushDown,o.BrushDown,o.BrushDown,o.BrushUp]],[kt.Amip,[o.BrushDown,o.BrushDown,o.BrushDown,o.BrushUp]],[kt.Eami,[o.BrushDown,o.BrushDown,o.BrushDown,o.BrushDown]],[kt.Eamii,[o.BrushDown,o.BrushDown,o.BrushDown,o.BrushDown,o.BrushUp]],[kt.Peami,[o.BrushDown,o.BrushDown,o.BrushDown,o.BrushDown,o.BrushUp]]]);static Cm=new Map([[kt.Ii,[$.toTicks(l.Eighth),$.toTicks(l.Eighth)]],[kt.Mi,[$.toTicks(l.Eighth),$.toTicks(l.Eighth)]],[kt.MiiTriplet,[$.toTicks(l.Eighth)/3,$.toTicks(l.Eighth)/3,$.toTicks(l.Eighth)/3]],[kt.MiiAnapaest,[$.toTicks(l.Sixteenth),$.toTicks(l.Sixteenth),$.toTicks(l.Eighth)]],[kt.PmpTriplet,[$.toTicks(l.Eighth)/3,$.toTicks(l.Eighth)/3,$.toTicks(l.Eighth)/3]],[kt.PmpAnapaest,[$.toTicks(l.Sixteenth)/3,$.toTicks(l.Sixteenth)/3,$.toTicks(l.Eighth)/3]],[kt.PeiTriplet,[$.toTicks(l.Eighth)/3,$.toTicks(l.Eighth)/3,$.toTicks(l.Eighth)/3]],[kt.PeiAnapaest,[$.toTicks(l.Sixteenth),$.toTicks(l.Sixteenth),$.toTicks(l.Eighth)]],[kt.PaiTriplet,[$.toTicks(l.Eighth)/3,$.toTicks(l.Eighth)/3,$.toTicks(l.Eighth)/3]],[kt.PaiAnapaest,[$.toTicks(l.Sixteenth),$.toTicks(l.Sixteenth),$.toTicks(l.Eighth)]],[kt.AmiTriplet,[$.toTicks(l.Eighth)/3,$.toTicks(l.Eighth)/3,$.toTicks(l.Eighth)/3]],[kt.AmiAnapaest,[$.toTicks(l.Sixteenth)/3,$.toTicks(l.Sixteenth)/3,$.toTicks(l.Eighth)/3]],[kt.Ppp,[$.toTicks(l.Sixteenth)/3,$.toTicks(l.Sixteenth)/3,$.toTicks(l.Eighth)/3]],[kt.Amii,[$.toTicks(l.Sixteenth)/3,$.toTicks(l.Sixteenth)/3,$.toTicks(l.Sixteenth)/3,$.toTicks(l.Eighth)]],[kt.Amip,[$.toTicks(l.Sixteenth)/3,$.toTicks(l.Sixteenth)/3,$.toTicks(l.Sixteenth)/3,$.toTicks(l.Eighth)]],[kt.Eami,[$.toTicks(l.Sixteenth),$.toTicks(l.Sixteenth),$.toTicks(l.Sixteenth),$.toTicks(l.Sixteenth)]],[kt.Eamii,[$.toTicks(l.Sixteenth)/5,$.toTicks(l.Sixteenth)/5,$.toTicks(l.Sixteenth)/5,$.toTicks(l.Sixteenth)/5,$.toTicks(l.Sixteenth)/5]],[kt.Peami,[$.toTicks(l.Sixteenth)/5,$.toTicks(l.Sixteenth)/5,$.toTicks(l.Sixteenth)/5,$.toTicks(l.Sixteenth)/5,$.toTicks(l.Sixteenth)/5]]]);sm(t,e){if(!t.hasRasgueado)return null;const s=new Aa,i=La.Cm.get(t.rasgueado).reduce((t,e)=>t+e,0);s.durations=La.Cm.get(t.rasgueado).map(t=>e*t/i),s.brushInfos=new Array(s.durations.length);const n=$.toTicks(l.Sixteenth);let r=0,a=0;for(const e of t.notes)e.isTieDestination||(r|=1<<e.string-1,a++);const h=La.Pm.get(t.rasgueado);for(let e=0;e<s.durations.length;e++){const i=s.durations[e]*n/$.QuarterTime,c=new Int32Array(t.voice.bar.staff.tuning.length);s.brushInfos[e]=c;const l=h[e];l!==o.None&&this.Em(t,c,l===o.ArpeggioDown||l===o.BrushDown,r,a,i)}return s}tm(t){const e=new Int32Array(t.voice.bar.staff.tuning.length);if(t.brushType){let s=0,i=0;for(const e of t.notes)e.isTieDestination||(s|=1<<e.string-1,i++);this.Em(t,e,t.brushType===o.ArpeggioDown||t.brushType===o.BrushDown,s,i,t.brushDuration)}return e}Em(t,e,s,i,n,r){if(t.notes.length>0){let a=0;const h=r/(n-1)|0;for(let n=0;n<t.voice.bar.staff.tuning.length;n++){const t=s?n:e.length-1-n;i&1<<t&&(e[t]=a,a+=h)}}return e}Qb(t,e,s){switch(e.type){case r.Instrument:this.Ib(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,255&e.value),this.Ib(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,255&e.value);break;case r.Bank:this.Ob(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,e.value),this.Ob(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,e.value);break;case r.Balance:const i=La.Vb(e.value);this.ci.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,rs.PanCoarse,i),this.ci.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,rs.PanCoarse,i);break;case r.Volume:const n=La.Vb(e.value);this.ci.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,rs.VolumeCoarse,n),this.ci.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,rs.VolumeCoarse,n)}}prepareSingleBeat(t){let e=-1,s=-1,i=t;for(;i&&(-1===e||-1===s);){for(const i of t.automations)switch(i.type){case r.Instrument:s=i.value;break;case r.Tempo:e=i.value}i=i.previousBeat}const n=t.voice.bar.staff.track,a=t.voice.bar.masterBar;-1===e&&(e=a.score.tempo);const h=t.playbackStart/a.calculateDuration();for(const t of a.tempoAutomations){if(!(t.ratioPosition<=h))break;e=t.value}-1===s&&(s=n.playbackInfo.program);const o=n.playbackInfo.volume;this.Nb(n),this.ci.addTimeSignature(0,a.timeSignatureNumerator,a.timeSignatureDenominator),this.ci.addTempo(0,e);const c=La.Vb(o);return this.ci.addControlChange(0,0,n.playbackInfo.primaryChannel,rs.VolumeCoarse,c),this.ci.addControlChange(0,0,n.playbackInfo.secondaryChannel,rs.VolumeCoarse,c),e}generateSingleBeat(t){const e=this.prepareSingleBeat(t);this.qb(t,-t.playbackStart,t.voice.bar,e)}generateSingleNote(t){const e=this.prepareSingleBeat(t.beat);this.im(t,0,t.beat.playbackDuration,e,new Int32Array(t.beat.voice.bar.staff.tuning.length),null)}}class Wa{oldWidth=0;newWidth=0;settings=null}!function(t){t[t.PreNotes=0]="PreNotes",t[t.OnNotes=1]="OnNotes",t[t.MiddleNotes=2]="MiddleNotes",t[t.Stem=3]="Stem",t[t.PostNotes=4]="PostNotes",t[t.EndBeat=5]="EndBeat"}(ms||(ms={}));class Ra{x;y;width=0;height=0;renderer;constructor(t,e){this.x=t,this.y=e}getBoundingBoxTop(){return this.y}getBoundingBoxBottom(){return this.getBoundingBoxTop()+this.height}doLayout(){}paint(t,e,s){}}class Ia extends Ra{scaleToWidth(t){this.width=t}}class Oa extends Ia{Fm=[];Am=0;beat;preNotes;onNotes;getLowestNoteY(t){return this.onNotes.getLowestNoteY(t)}getHighestNoteY(t){return this.onNotes.getHighestNoteY(t)}get beatId(){return this.beat.id}get isLastOfVoice(){return this.beat.isLastOfVoice}get displayDuration(){return this.beat.displayDuration}get graceIndex(){return this.beat.graceIndex}get graceType(){return this.beat.graceType}get absoluteDisplayStart(){return this.beat.absoluteDisplayStart}get graceGroup(){return this.beat.graceGroup}get voiceIndex(){return this.beat.voice.index}get isFirstOfTupletGroup(){return this.beat.hasTuplet&&this.beat.tupletGroup.beats[0].id===this.beat.id}get tupletGroup(){return this.beat.tupletGroup}get onTimeX(){return this.onNotes.x+this.onNotes.onTimeX}constructor(t){super(0,0),this.beat=t,this.Fm=[]}getNoteY(t,e){return this.onNotes.y+this.onNotes.getNoteY(t,e)}getRestY(t){return this.onNotes.y+this.onNotes.getRestY(t)}getNoteX(t,e){return this.onNotes.x+this.onNotes.getNoteX(t,e)}addTie(t){t.renderer=this.renderer,this.Fm.push(t),this.renderer.registerTie(t)}getBoundingBoxTop(){let t=Xt.minBoundingBox(this.preNotes.getBoundingBoxTop(),this.onNotes.getBoundingBoxTop());return Number.isNaN(t)&&(t=this.renderer.middleYPosition),t}getBoundingBoxBottom(){let t=Xt.maxBoundingBox(this.preNotes.getBoundingBoxBottom(),this.onNotes.getBoundingBoxBottom());return Number.isNaN(t)&&(t=this.renderer.middleYPosition),t}drawBeamHelperAsFlags(t){return t.hasFlag(!1,void 0)}get postBeatStretch(){return this.onNotes.computedWidth+this.Am-this.onNotes.onTimeX}registerLayoutingInfo(t){const e=this.preNotes.computedWidth+this.onNotes.onTimeX;let s=this.postBeatStretch;for(const t of this.Fm){s+=t.width}t.addBeatSpring(this,e,s),t.setBeatSizes(this,{preBeatSize:this.preNotes.width,onBeatSize:this.onNotes.width})}applyLayoutingInfo(t){this.updateWidth()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,this.preNotes.container=this,this.preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,this.onNotes.container=this,this.onNotes.doLayout(),this.createBeatTies(),this.updateWidth()}createBeatTies(){let t=this.beat.notes.length-1;for(;t>=0;)this.createTies(this.beat.notes[t--])}doMultiVoiceLayout(){}updateWidth(){let t=this.preNotes.width+this.onNotes.width,e=0;for(const t of this.Fm){const s=t;s.width>e&&(e=s.width)}this.Am=e,t+=e,this.width=t}createTies(t){}static getGroupId(t){return`b${t.id}`}paint(t,e,s){if(this.preNotes.isEmpty&&this.onNotes.isEmpty&&0===this.Fm.length)return;s.beginGroup(Oa.getGroupId(this.beat)),this.preNotes.paint(t+this.x,e+this.y,s),this.onNotes.paint(t+this.x,e+this.y,s);const i=t-this.renderer.beatGlyphsStart-this.renderer.x,n=e-this.renderer.y;for(let t=0,e=this.Fm.length;t<e;t++){const e=this.Fm[t];e.renderer=this.renderer,e.paint(i,n,s)}s.endGroup()}buildBoundingsLookup(t,e,s){const i=new fa;if(i.beat=this.beat,this.beat.isEmpty)i.visualBounds=new zs,i.visualBounds.x=e+this.x,i.visualBounds.y=t.visualBounds.y,i.visualBounds.w=this.width,i.visualBounds.h=t.visualBounds.h,i.realBounds=new zs,i.realBounds.x=e+this.x,i.realBounds.y=t.realBounds.y,i.realBounds.w=this.width,i.realBounds.h=t.realBounds.h,i.onNotesX=e+this.x+this.onNotes.x+this.onNotes.onTimeX;else{i.visualBounds=new zs,i.visualBounds.x=e+this.x,this.preNotes.isEmpty?this.onNotes.isEmpty?i.visualBounds.x=e+this.x:i.visualBounds.x=e+this.x+this.onNotes.x:i.visualBounds.x=e+this.x+this.preNotes.x;let s=0;s=this.onNotes.isEmpty?this.preNotes.isEmpty?e+this.x+this.width:e+this.x+this.preNotes.x+this.preNotes.width:e+this.x+this.onNotes.x+this.onNotes.onTimeX+this.postBeatStretch,i.visualBounds.w=s-i.visualBounds.x,i.visualBounds.y=t.visualBounds.y,i.visualBounds.h=t.visualBounds.h,i.realBounds=new zs,i.realBounds.x=e+this.x,i.realBounds.y=t.realBounds.y,i.realBounds.w=this.width,i.realBounds.h=t.realBounds.h,i.onNotesX=e+this.x+this.onNotes.x+this.onNotes.onTimeX}t.addBeat(i),this.renderer.settings.core.includeNoteBounds&&this.onNotes.buildBoundingsLookup(i,e+this.x,s+this.y)}getBeatX(t,e=!1){switch(t){case ms.PreNotes:return this.preNotes.x;case ms.OnNotes:return this.onNotes.x;case ms.MiddleNotes:return this.onNotes.x+this.onNotes.middleX;case ms.Stem:return this.onNotes.x+this.onNotes.stemX;case ms.PostNotes:const t=e?this.renderer.layoutingInfo.getBeatSizes(this.beat)?.onBeatSize??this.onNotes.width:this.onNotes.width;return this.onNotes.x+t;case ms.EndBeat:return this.width}return this.preNotes.x}}class Ga{Dm;Lm;Dl;Wm=0;Be=null;Rm=null;get instance(){return this.Dm}set instance(t){this.Dm=t;const e=this.Lm;if(e)for(const t of e)t();if(t){const e=[];e.push(t.preRender.on(t=>this.preRender.trigger(t))),e.push(t.renderFinished.on(t=>this.renderFinished.trigger(t))),e.push(t.partialRenderFinished.on(t=>this.partialRenderFinished.trigger(t))),e.push(t.partialLayoutFinished.on(t=>this.partialLayoutFinished.trigger(t))),e.push(t.postRenderFinished.on(()=>this.postRenderFinished.trigger())),e.push(t.error.on(t=>this.error.trigger(t))),this.Lm=e,this.Dl&&t.updateSettings(this.Dl),t.width=this.Wm,null!==this.Be&&t.renderScore(this.Be,this.Rm)}else this.Lm=void 0}get boundsLookup(){return this.Dm?this.Dm.boundsLookup:null}get width(){return this.Dm?this.Dm.width:0}set width(t){this.Wm=t,this.Dm&&(this.Dm.width=t)}render(t){this.Dm?.render(t)}resizeRender(){this.Dm?.resizeRender()}renderScore(t,e,s){this.Be=t,this.Rm=e,this.Dm?.renderScore(t,e,s)}renderResult(t){this.Dm?.renderResult(t)}updateSettings(t){this.Dl=t,this.Dm?.updateSettings(t)}destroy(){this.Dm?.destroy(),this.Dm=void 0}preRender=new gi;renderFinished=new gi;partialRenderFinished=new gi;partialLayoutFinished=new gi;postRenderFinished=new mi;error=new gi}class Va{api;lastScroll=-1;constructor(t){this.api=t}[Symbol.dispose](){}forceScrollTo(t){this.Im(t,!0),this.lastScroll=-1}Im(t,e){const s=this.calculateLastScroll(t);(s!==this.lastScroll||e)&&(this.lastScroll=s,this.doScroll(t))}onBeatCursorUpdating(t,e,s,i,n,r){this.Im(t,!1)}}class $a extends Va{calculateLastScroll(t){return t.barBounds.masterBarBounds.realBounds.y}doScroll(t){const e=this.api.uiFacade,s=this.api.settings,i=e.getScrollContainer(),n=e.getOffset(i,this.api.container),r=t.barBounds.masterBarBounds.realBounds.y+s.player.scrollOffsetY;e.scrollToY(i,n.y+r,this.api.settings.player.scrollSpeed)}}class Ha extends Va{calculateLastScroll(t){return t.barBounds.masterBarBounds.realBounds.y}doScroll(t){const e=this.api.uiFacade,s=this.api.settings,i=e.getScrollContainer(),n=i.scrollTop+e.getOffset(null,i).h,r=t.barBounds.masterBarBounds;if(r.visualBounds.y+r.visualBounds.h>=n||r.visualBounds.y<i.scrollTop){const t=r.realBounds.y+s.player.scrollOffsetY;e.scrollToY(i,t,s.player.scrollSpeed)}}}class Ua{Om;Gm=-1;Vm;constructor(t){this.Om=t,this.Vm=t.uiFacade.getScrollContainer().resize.on(()=>{const e=t.uiFacade.getScrollContainer(),s=t.settings.player.scrollOffsetX,i=e.width+s;t.uiFacade.setCanvasOverflow(t.canvasElement,i,!0)})}[Symbol.dispose](){this.Om.uiFacade.setCanvasOverflow(this.Om.canvasElement,0,!0),this.Vm()}forceScrollTo(t){const e=this.Om.uiFacade,s=this.Om.settings,i=e.getScrollContainer(),n=t.barBounds.masterBarBounds.realBounds.y+s.player.scrollOffsetY;e.scrollToY(i,n,0),this.Gm=-1}onBeatCursorUpdating(t,e,s,i,n,r){const a=this.Om.uiFacade,h=this.Om.settings,o=t.barBounds.masterBarBounds,c=o.realBounds.y+h.player.scrollOffsetY;if(c===this.Gm&&r>0)return;const l=a.getScrollContainer();if(a.scrollToY(l,c,0),0===r)return void(this.Gm=-1);this.Gm=c;const u=c+o.realBounds.h,d=this.$m(o);a.scrollToY(l,u,d)}$m(t){const e=t.staffSystemBounds.bars,s=this.Om.tickCache;let i=0;const n=this.Om.score.masterBars;for(const t of e){const e=n[t.index],r=s.getMasterBar(e),a=s.getMasterBar(e).tempoChanges;let h=a[0].tempo,o=a[0].tick;for(let t=1;t<a.length;t++){const e=a[t].tick-o;i+=$.ticksToMillis(e,h),h=a[t].tempo,o=a[t].tick}const c=r.end-o;i+=$.ticksToMillis(c,h)}return i}}class za extends Va{calculateLastScroll(t){return t.barBounds.masterBarBounds.visualBounds.x}doScroll(t){const e=this.api.uiFacade,s=this.api.settings,i=e.getScrollContainer(),n=t.barBounds.masterBarBounds.realBounds.x+s.player.scrollOffsetX;e.scrollToX(i,n,s.player.scrollSpeed)}}class Xa extends Va{calculateLastScroll(t){return t.barBounds.masterBarBounds.visualBounds.x}doScroll(t){const e=this.api.uiFacade,s=this.api.settings,i=e.getScrollContainer(),n=i.scrollLeft+e.getOffset(null,i).w,r=t.barBounds.masterBarBounds;if(r.visualBounds.x+r.visualBounds.w>=n||r.visualBounds.x<i.scrollLeft){const t=r.realBounds.x+s.player.scrollOffsetX;e.scrollToX(i,t,s.player.scrollSpeed)}}}class ja{Om;Gm=-1;Vm;constructor(t){this.Om=t,this.Vm=t.uiFacade.getScrollContainer().resize.on(()=>{const e=t.uiFacade.getScrollContainer(),s=t.settings.player.scrollOffsetX,i=e.width+s;t.uiFacade.setCanvasOverflow(t.canvasElement,i,!1)})}[Symbol.dispose](){this.Vm(),this.Om.uiFacade.setCanvasOverflow(this.Om.canvasElement,0,!1)}forceScrollTo(t){const e=this.Om.uiFacade,s=this.Om.settings,i=e.getScrollContainer(),n=t.onNotesX+s.player.scrollOffsetY;e.scrollToY(i,n,0),this.Gm=-1}onBeatCursorUpdating(t,e,s,i,n,r){const a=this.Om.uiFacade;if(n===this.Gm&&r>0)return;const h=this.Om.settings,o=a.getScrollContainer();if(a.scrollToX(o,i+h.player.scrollOffsetX,0),0===r)return void(this.Gm=-1);this.Gm=n;const c=n+h.player.scrollOffsetX;a.scrollToX(o,c,r)}}class Ja{activeBeats;constructor(t){this.activeBeats=t}}class qa{startTick=0;endTick=0}class Ya{Hm=1;Nf=0;Pf=0;Um=1;zm=!1;Xm=[];Dm;Lm;midiTickShift=0;constructor(){this.ready=new mi(()=>this.isReady),this.readyForPlayback=new mi(()=>this.isReadyForPlayback),this.midiLoaded=new gi(()=>this.Dm?.loadedMidiInfo??null),this.stateChanged=new gi(()=>new zi(this.state,!1)),this.positionChanged=new gi(()=>this.currentPosition),this.playbackRangeChanged=new gi(()=>{const t=this.playbackRange;return t?new Zn(t):null})}get instance(){return this.Dm}set instance(t){this.Dm=t;const e=this.Lm;if(e)for(const t of e)t();if(t){const e=[];e.push(t.ready.on(()=>this.ready.trigger())),e.push(t.readyForPlayback.on(()=>this.readyForPlayback.trigger())),e.push(t.finished.on(()=>this.finished.trigger())),e.push(t.soundFontLoaded.on(()=>this.soundFontLoaded.trigger())),e.push(t.soundFontLoadFailed.on(t=>this.soundFontLoadFailed.trigger(t))),e.push(t.midiLoaded.on(t=>{this.midiLoaded.trigger(this.jm(t))})),e.push(t.midiLoadFailed.on(t=>this.midiLoadFailed.trigger(t))),e.push(t.stateChanged.on(t=>this.stateChanged.trigger(t))),e.push(t.positionChanged.on(t=>{this.positionChanged.trigger(this.jm(t))})),e.push(t.midiEventsPlayed.on(t=>this.midiEventsPlayed.trigger(t))),e.push(t.playbackRangeChanged.on(t=>this.playbackRangeChanged.trigger(this.Jm(t)))),this.Lm=e,this.isReady?(t.masterVolume=this.Hm,t.metronomeVolume=this.Nf,t.countInVolume=this.Pf,t.playbackSpeed=this.Um,t.isLooping=this.zm,t.midiEventsPlayedFilter=this.Xm,this.ready.trigger()):e.push(t.ready.on(()=>{t.masterVolume=this.Hm,t.metronomeVolume=this.Nf,t.countInVolume=this.Pf,t.playbackSpeed=this.Um,t.isLooping=this.zm,t.midiEventsPlayedFilter=this.Xm}))}else this.Lm=void 0}get output(){return this.Dm.output}get isReady(){return!!this.Dm&&this.Dm.isReady}get isReadyForPlayback(){return!!this.Dm&&this.Dm.isReadyForPlayback}get state(){return this.Dm?this.Dm.state:Qe.Paused}get logLevel(){return q.logLevel}set logLevel(t){q.logLevel=t,this.Dm&&(this.Dm.logLevel=t)}get masterVolume(){return this.Hm}set masterVolume(t){t=Math.max(t,Ht.MinVolume),this.Hm=t,this.Dm&&(this.Dm.masterVolume=t)}get metronomeVolume(){return this.Nf}set metronomeVolume(t){t=Math.max(t,Ht.MinVolume),this.Nf=t,this.Dm&&(this.Dm.metronomeVolume=t)}get playbackSpeed(){return this.Um}set playbackSpeed(t){this.Um=t,this.Dm&&(this.Dm.playbackSpeed=t)}get loadedMidiInfo(){return this.Dm?this.jm(this.Dm.loadedMidiInfo):void 0}get currentPosition(){return this.Dm?this.jm(this.Dm.currentPosition):new Xi(0,0,0,0,!1,120,120)}get tickPosition(){return this.Dm?this.qm(this.Dm.tickPosition):0}set tickPosition(t){this.Dm&&(this.Dm.tickPosition=this.Ym(t))}get timePosition(){return this.Dm?this.Dm.timePosition:0}set timePosition(t){this.Dm&&(this.Dm.timePosition=t)}get playbackRange(){return this.Dm?this.Km(this.Dm.playbackRange):null}set playbackRange(t){this.Dm&&(this.Dm.playbackRange=this.Qm(t))}get isLooping(){return this.zm}set isLooping(t){this.zm=t,this.Dm&&(this.Dm.isLooping=t)}get countInVolume(){return this.Pf}set countInVolume(t){this.Pf=t,this.Dm&&(this.Dm.countInVolume=t)}get midiEventsPlayedFilter(){return this.Xm}set midiEventsPlayedFilter(t){this.Xm=t,this.Dm&&(this.Dm.midiEventsPlayedFilter=t)}destroy(){this.Dm&&(this.Dm.destroy(),this.Dm=void 0)}play(){return!!this.Dm&&this.Dm.play()}pause(){this.Dm&&this.Dm.pause()}playPause(){this.Dm&&this.Dm.playPause()}stop(){this.Dm&&this.Dm.stop()}playOneTimeMidiFile(t){this.Dm&&this.Dm.playOneTimeMidiFile(t)}loadSoundFont(t,e){this.Dm&&this.Dm.loadSoundFont(t,e)}resetSoundFonts(){this.Dm&&this.Dm.resetSoundFonts()}loadMidiFile(t){this.Dm&&this.Dm.loadMidiFile(t)}loadBackingTrack(t){this.Dm&&this.Dm.loadBackingTrack(t)}updateSyncPoints(t){this.Dm&&this.Dm.updateSyncPoints(t)}applyTranspositionPitches(t){this.Dm&&this.Dm.applyTranspositionPitches(t)}setChannelTranspositionPitch(t,e){this.Dm&&this.Dm.setChannelTranspositionPitch(t,e)}setChannelMute(t,e){this.Dm&&this.Dm.setChannelMute(t,e)}resetChannelStates(){this.Dm&&this.Dm.resetChannelStates()}setChannelSolo(t,e){this.Dm&&this.Dm.setChannelSolo(t,e)}setChannelVolume(t,e){this.Dm&&this.Dm.setChannelVolume(t,e)}ready;readyForPlayback;finished=new mi;soundFontLoaded=new mi;soundFontLoadFailed=new gi;midiLoaded;midiLoadFailed=new gi;stateChanged;positionChanged;midiEventsPlayed=new gi;playbackRangeChanged;Jm(t){if(null==t.playbackRange)return t;return this.midiTickShift>0?new Zn(this.Km(t.playbackRange)):t}Km(t){if(null==t)return t;const e=this.midiTickShift;if(e>0){const s=new qa;return s.startTick=t.startTick-e,s.endTick=t.endTick-e,s}return t}Qm(t){if(null==t)return t;const e=this.midiTickShift;if(e>0){const s=new qa;return s.startTick=t.startTick+e,s.endTick=t.endTick+e,s}return t}jm(t){if(!t)return t;const e=this.midiTickShift;return e>0?new Xi(t.currentTime,t.endTime,t.currentTick-e,t.endTick-e,t.isSeek,t.originalTempo,t.modifiedTempo):t}qm(t){return t-this.midiTickShift}Ym(t){return t+this.midiTickShift}}class Ka{df=new Yn;masterVolume=1;metronomeVolume=0;outSampleRate=44100;currentTempo=120;timeSignatureNumerator=4;timeSignatureDenominator=4;activeVoiceCount=0;output;noteOffAll(t){}resetSoft(){}resetPresets(){}loadPresets(t,e,s,i){}setupMetronomeChannel(t){}synthesizeSilent(t){this.fakeSynthesize()}Zm(t){}dispatchEvent(t){this.df.enqueue(t)}synthesize(t,e,s){return this.fakeSynthesize()}fakeSynthesize(){const t=[];for(;!this.df.isEmpty;){const e=this.df.dequeue();e.isMetronome&&this.metronomeVolume>0||e.event&&this.Zm(e.event),t.push(e)}return t}applyTranspositionPitches(t){}setChannelTranspositionPitch(t,e){}channelSetMute(t,e){}channelSetSolo(t,e){}resetChannelStates(){}channelSetMixVolume(t,e){}hasSamplesForProgram(t){return!0}hasSamplesForPercussion(t){return!0}}class Qa extends sr{tg;constructor(t,e){super(t,new Ka,e),this.synthesizer.output=t,this.tg=t,t.timeUpdate.on(e=>{const s=this.sequencer.mainTimePositionFromBackingTrack(e,t.backingTrackDuration);this.sequencer.fillMidiEventQueueToEndTime(s),this.synthesizer.fakeSynthesize(),this.updateTimePosition(s,!1),this.checkForFinish()})}updateMasterVolume(t){super.updateMasterVolume(t),this.tg.masterVolume=t}updatePlaybackSpeed(t){super.updatePlaybackSpeed(t),this.tg.playbackRate=t}onSampleRequest(){}loadMidiFile(t){this.isSoundFontLoaded||(this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger()),super.loadMidiFile(t)}updateTimePosition(t,e){super.updateTimePosition(t,e),e&&this.tg.seekTo(this.sequencer.mainTimePositionToBackingTrack(t,this.tg.backingTrackDuration))}loadBackingTrack(t){const e=t.backingTrack;e&&(this.tg.loadBackingTrack(e),this.timePosition=0)}updateSyncPoints(t){this.sequencer.mainUpdateSyncPoints(t),this.tickPosition=this.tickPosition}}class Za{sampleRate=44100;eg=0;ci;get handler(){return this.ci}set handler(t){t&&0!==this.eg&&(t.seekTo(this.eg),this.eg=0),this.ci=t}get backingTrackDuration(){return this.handler?.backingTrackDuration??0}get playbackRate(){return this.handler?.playbackRate??1}set playbackRate(t){const e=this.handler;e&&(e.playbackRate=t)}get masterVolume(){return this.handler?.masterVolume??1}set masterVolume(t){const e=this.handler;e&&(e.masterVolume=t)}seekTo(t){const e=this.handler;e?e.seekTo(t):this.eg=t}loadBackingTrack(t){}open(t){this.ready.trigger()}updatePosition(t){this.timeUpdate.trigger(t)}play(){this.handler?.play()}destroy(){}pause(){this.handler?.pause()}addSamples(t){}resetSamples(){}activate(){}ready=new mi;samplesPlayed=new gi;timeUpdate=new gi;sampleRequest=new mi;async enumerateOutputDevices(){return[]}async setOutputDevice(t){}async getOutputDevice(){return null}}class th extends Qa{get handler(){return this.output.handler}set handler(t){this.output.handler=t}constructor(t){super(new Za,t)}}class eh{bounds=null;isVisible(t){const e=this.bounds;return!!e&&null!==e.findBeat(t)}}class sh{sg=0;Rm=null;ig=null;ng=new eh;rg=!1;Be=null;ag=[];hg=t.PlayerMode.Disabled;dp;Np;og;get midiTickShift(){return this.dp.midiTickShift}get actualPlayerMode(){return this.hg}uiFacade;container;get renderer(){return this.Np}get score(){return this.Be}settings;get tracks(){return this.ag}canvasElement;constructor(e,s){this.uiFacade=e,this.container=e.rootContainer,this.activeBeatsChanged=new gi(()=>this.dp.state===Qe.Playing&&this.cg?new Ja(this.cg.beatLookup.highlightedBeats.map(t=>t.beat)):null),this.playedBeatChanged=new gi(()=>this.dp.state===Qe.Playing&&this.cg?this.cg.beat:null),this.scoreLoaded=new gi(()=>this.Be?this.Be:null),this.midiLoaded=new gi(()=>this.dp.loadedMidiInfo??null),e.initialize(this,s),q.logLevel=this.settings.core.logLevel,this.settings.handleBackwardsCompatibility(),Nu.printEnvironmentInfo(!1),this.canvasElement=e.createCanvasElement(),this.container.appendChild(this.canvasElement),this.Np=new Ga,this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&Nu.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?this.Np.instance=this.uiFacade.createWorkerRenderer():this.Np.instance=new wa(this.settings),this.container.resize.on(Nu.throttle(()=>{this.rg||this.container.width!==this.Np.width&&this.triggerResize()},e.resizeThrottle));const i=new Wa;i.oldWidth=this.Np.width,i.newWidth=0|this.container.width,i.settings=this.settings,this.lg(i),this.Np.preRender.on(this.ug.bind(this)),this.Np.renderFinished.on(t=>{this.vp(t)}),this.Np.postRenderFinished.on(()=>{const t=Date.now()-this.sg;q.debug("rendering",`Rendering completed in ${t}ms`),this.dg()}),this.Np.preRender.on(t=>{this.sg=Date.now()}),this.Np.partialLayoutFinished.on(t=>this.fg(t,!1)),this.Np.partialRenderFinished.on(this.pg.bind(this)),this.Np.renderFinished.on(t=>{this.fg(t,!0)}),this.Np.error.on(this.onError.bind(this)),this.bg(),this.settings.player.playerMode!==t.PlayerMode.Disabled&&this.mg(),this.gg(),this.uiFacade.beginInvoke(()=>{this.uiFacade.initialRender()})}bg(){const t=new Ya;this.dp=t,t.ready.on(()=>{this.loadMidiForScore()}),t.readyForPlayback.on(()=>{if(this.wg(),this.tracks)for(const e of this.tracks){const s=e.playbackInfo.volume/16;t.setChannelVolume(e.playbackInfo.primaryChannel,s),t.setChannelVolume(e.playbackInfo.secondaryChannel,s)}}),t.soundFontLoaded.on(this.yg.bind(this)),t.soundFontLoadFailed.on(t=>{this.onError(t)}),t.midiLoaded.on(this.kg.bind(this)),t.midiLoadFailed.on(t=>{this.onError(t)}),t.stateChanged.on(this.Sg.bind(this)),t.positionChanged.on(this.Bg.bind(this)),t.midiEventsPlayed.on(this._g.bind(this)),t.playbackRangeChanged.on(this.Tg.bind(this)),t.finished.on(this.xg.bind(this))}destroy(){this.rg=!0,this.dp.destroy(),this.uiFacade.destroy(),this.Np.destroy()}updateSettings(){this.settings.handleBackwardsCompatibility();const t=this.score;t&&Xt.applyPitchOffsets(this.settings,t),this.Mg(),this.Np.updateSettings(this.settings),this.mg(),this.vg()}Mg(){const t=this.Np;this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&Nu.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?t.instance instanceof wa&&(t.destroy(),t.instance=this.uiFacade.createWorkerRenderer()):t.instance instanceof wa||(t.destroy(),t.instance=new wa(this.settings))}load(t,e){try{return this.uiFacade.load(t,t=>{this.renderScore(t,e)},t=>{this.onError(t)})}catch(t){return this.onError(t),!1}}renderScore(t,e,s){const i=[];if(e)if(0===e.length)t.tracks.length>0&&i.push(t.tracks[0]);else if(1===e.length&&-1===e[0])for(const e of t.tracks)i.push(e);else for(const s of e)s>=0&&s<=t.tracks.length&&i.push(t.tracks[s]);else t.tracks.length>0&&i.push(t.tracks[0]);this.Ng(t,i,s)}renderTracks(e,s){if(e.length>0){const i=e[0].score;for(const s of e)if(s.score!==i)return void this.onError(new G(t.AlphaTabErrorType.General,"All rendered tracks must belong to the same score."));this.Ng(i,e,s)}}Ng(t,e,s){if(Xt.applyPitchOffsets(this.settings,t),t!==this.score){this.Be=t,this.ag=e,this.Pg=null,this.Rm=[];for(const t of e)this.Rm.push(t.index);this.ig=new Set(this.Rm),this.Cg(t),this.loadMidiForScore(),this.render(s)}else{this.ag=e;const i=Xt.computeFirstDisplayedBarIndex(t,this.settings),n=Xt.computeLastDisplayedBarIndex(t,this.settings,i);this.Pg&&(this.Pg.multiBarRestInfo=Xt.buildMultiBarRestInfo(this.tracks,i,n)),this.Rm=[];for(const t of e)this.Rm.push(t.index);this.ig=new Set(this.Rm),this.render(s)}}triggerResize(){if(this.container.isVisible){const t=new Wa;t.oldWidth=this.Np.width,t.newWidth=this.container.width,t.settings=this.settings,this.lg(t),this.Np.updateSettings(this.settings),this.Np.width=this.container.width,this.Np.resizeRender()}else q.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{q.debug("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()})}fg(t,e){e&&(this.canvasElement.width=t.totalWidth,this.canvasElement.height=t.totalHeight,this.Eg&&(this.Eg.width=t.totalWidth,this.Eg.height=t.totalHeight)),(t.width>0||t.height>0)&&this.uiFacade.beginAppendRenderResults(t),e&&this.uiFacade.beginAppendRenderResults(null)}pg(t){t&&t.renderResult&&this.uiFacade.beginUpdateRenderResults(t)}tex(t,e){try{const s=new We;s.logErrors=!0,s.initFromString(t,this.settings);const i=s.readScore();this.renderScore(i,e)}catch(t){this.onError(t)}}loadSoundFont(t,e=!1){return this.uiFacade.loadSoundFont(t,e)}resetSoundFonts(){this.dp.resetSoundFonts()}render(t){this.uiFacade.canRender?(this.Np.width=this.container.width,this.Np.renderScore(this.score,this.Rm,t)):this.uiFacade.canRenderChanged.on(()=>this.render(t))}Pg=null;customScrollHandler;get tickCache(){return this.Pg}get boundsLookup(){return this.Np.boundsLookup}get player(){return this.dp.instance?this.dp:null}get isReadyForPlayback(){return this.dp.isReadyForPlayback}get playerState(){return this.dp.state}get masterVolume(){return this.dp.masterVolume}set masterVolume(t){this.dp.masterVolume=t}get metronomeVolume(){return this.dp.metronomeVolume}set metronomeVolume(t){this.dp.metronomeVolume=t}get countInVolume(){return this.dp.countInVolume}set countInVolume(t){this.dp.countInVolume=t}get midiEventsPlayedFilter(){return this.dp.midiEventsPlayedFilter}set midiEventsPlayedFilter(t){this.dp.midiEventsPlayedFilter=t}get tickPosition(){return this.dp.tickPosition}set tickPosition(t){this.dp.tickPosition=t}get timePosition(){return this.dp.timePosition}set timePosition(t){this.dp.timePosition=t}get endTick(){return this.dp.currentPosition.endTick}get endTime(){return this.dp.currentPosition.endTime}get playbackRange(){return this.dp.playbackRange}set playbackRange(t){this.dp.playbackRange=t,this.Fg(t)}get playbackSpeed(){return this.dp.playbackSpeed}set playbackSpeed(t){this.dp.playbackSpeed=t}get isLooping(){return this.dp.isLooping}set isLooping(t){this.dp.isLooping=t}Ag(){this.dp.destroy(),this.Dg=0,this.Lg()}mg(){let e=this.settings.player.playerMode;if(e===t.PlayerMode.EnabledAutomatic){const s=this.score;if(!s)return!1;e=s?.backingTrack?.rawAudioFile?t.PlayerMode.EnabledBackingTrack:t.PlayerMode.EnabledSynthesizer}let s=null;if(e===this.hg)return this.Wg(),!1;switch(this.Ag(),this.Wg(),e){case t.PlayerMode.Disabled:s=null;break;case t.PlayerMode.EnabledSynthesizer:s=this.uiFacade.createWorkerPlayer();break;case t.PlayerMode.EnabledBackingTrack:s=this.uiFacade.createBackingTrackPlayer();break;case t.PlayerMode.EnabledExternalMedia:s=new th(this.settings.player.bufferTimeInMilliseconds)}return this.hg=e,!!s&&(this.dp.instance=s,!1)}loadMidiForScore(){if(!this.score)return;const t=this.score;q.debug("AlphaTab","Generating Midi");const e=new xi,s=new Sa(e),i=new La(t,this.settings,s),n=Xt.computeFirstDisplayedBarIndex(t,this.settings),r=Xt.computeLastDisplayedBarIndex(t,this.settings,n);i.tickLookup.multiBarRestInfo=Xt.buildMultiBarRestInfo(this.tracks,n,r),i.applyTranspositionPitches=!1,i.generate(),this.Pg=i.tickLookup,this.Rg(e);const a=this.dp;a.midiTickShift=s.tickShift,a.loadMidiFile(e),a.loadBackingTrack(t),a.updateSyncPoints(i.syncPoints),a.applyTranspositionPitches(i.transpositionPitches)}updateSyncPoints(){if(!this.score)return;const t=this.score;this.dp.updateSyncPoints(La.generateSyncPoints(t))}changeTrackVolume(t,e){for(const s of t)this.dp.setChannelVolume(s.playbackInfo.primaryChannel,e),this.dp.setChannelVolume(s.playbackInfo.secondaryChannel,e)}changeTrackSolo(t,e){for(const s of t)this.dp.setChannelSolo(s.playbackInfo.primaryChannel,e),this.dp.setChannelSolo(s.playbackInfo.secondaryChannel,e)}changeTrackMute(t,e){for(const s of t)this.dp.setChannelMute(s.playbackInfo.primaryChannel,e),this.dp.setChannelMute(s.playbackInfo.secondaryChannel,e)}changeTrackTranspositionPitch(t,e){for(const s of t)this.dp.setChannelTranspositionPitch(s.playbackInfo.primaryChannel,e),this.dp.setChannelTranspositionPitch(s.playbackInfo.secondaryChannel,e)}play(){return this.dp.play()}pause(){this.dp.pause()}playPause(){this.dp.playPause()}stop(){this.dp.stop()}playBeat(t){const e=new xi,s=new Sa(e);new La(t.voice.bar.staff.track.score,this.settings,s).generateSingleBeat(t),this.dp.playOneTimeMidiFile(e)}playNote(t){const e=new xi,s=new Sa(e);new La(t.beat.voice.bar.staff.track.score,this.settings,s).generateSingleNote(t),this.dp.playOneTimeMidiFile(e)}Eg=null;Ig=null;Og=null;Gg=null;Dg=0;cg=null;Vg=null;$g=!0;Hg=Qe.Paused;Ug=null;Lg(){this.Eg&&(this.uiFacade.destroyCursors(),this.Eg=null,this.Ig=null,this.Og=null,this.Gg=null)}zg(){if(this.Eg)return;const t=this.uiFacade.createCursors();t&&(this.Eg=t.cursorWrapper,this.Ig=t.barCursor,this.Og=t.beatCursor,this.Gg=t.selectionWrapper,this.$g=!0),null!==this.cg&&this.Xg(this.cg,!1,this.Dg>10,1,!0)}Wg(){this.jg();const t=this.Jg;t?this.zg():!t&&this.Eg&&this.Lg()}qg=t.ScrollMode.Off;Yg=!0;jg(){const e=this.og,s=this.settings.player.scrollMode,i=Nu.getLayoutEngineFactory(this.settings.display.layoutMode).vertical;if(this.qg!==s||this.Yg!==i){if(e){e[Symbol.dispose]();const t=this.uiFacade.getScrollContainer();this.uiFacade.stopScrolling(t)}switch(s){case t.ScrollMode.Off:this.og=void 0;break;case t.ScrollMode.Continuous:this.og=i?new $a(this):new za(this);break;case t.ScrollMode.OffScreen:this.og=i?new Ha(this):new Xa(this);break;case t.ScrollMode.Smooth:this.og=i?new Ua(this):new ja(this)}}}Kg(t,e,s,i=!1,n=!1){this.Dg=t;const r=this.Pg;if(r){const a=r.findBeatWithChecker(this.ng,t,this.cg);a&&this.Xg(a,e,i,s,n||this.playerState===Qe.Paused)}}Xg(t,e,s,i,n=!1){const r=t.beat,a=t.nextBeat?.beat??null,h=t.duration,o=t.beatLookup.highlightedBeats;if(!r)return;const c=this.Np.boundsLookup;if(!c)return;const l=this.cg,u=this.Ug,d=this.Hg;if(!n&&r===l?.beat&&c===u&&d===this.dp.state&&l?.start===t.start)return;const f=c.findBeat(r);f&&(this.cg=t,this.Ug=c,this.Hg=this.dp.state,this.uiFacade.beginInvoke(()=>{this.Qg(r,a,h,e,o,c,f,s,t.cursorMode,i)}))}scrollToCursor(){const t=this.Vg;if(t){const e=this.customScrollHandler??this.og;e&&e.forceScrollTo(t)}}Qg(e,s,i,n,r,a,h,o,c,l){const u=this.Ig,d=this.Og,f=h.barBounds.masterBarBounds,p=f.visualBounds,b=this.Vg;this.Vg=h,u&&u.setBounds(p.x,p.y,p.w,p.h);const m=this.dp.state===Qe.Playing&&!n;let g=f.visualBounds.x+f.visualBounds.w,w=null;s&&c===bs.ToNextBext&&(w=a.findBeat(s),w&&w.barBounds.masterBarBounds.staffSystemBounds===f.staffSystemBounds&&(g=w.onNotesX));let y=h.onNotesX;if(d){if(this.settings.player.enableAnimatedBeatCursor){const t=g-h.onNotesX,e=this.Dg-this.cg.start,s=this.cg.tickDuration>0?e/this.cg.tickDuration:0;if(y=h.onNotesX+t*s,i-=i*s,m){(!b||this.$g||p.y!==b.barBounds.masterBarBounds.visualBounds.y||y<b.onNotesX||f.index>b.barBounds.masterBarBounds.index+1)&&(d.transitionToX(0,y),d.setBounds(y,p.y,1,p.h));const t=c===bs.ToNextBext?2:1;g=y+(g-y)*t,i=i/l*t,this.uiFacade.beginInvoke(()=>{d.transitionToX(i,g)})}else i=0,d.transitionToX(i,g),d.setBounds(y,p.y,1,p.h)}else i=0,g=y,d.transitionToX(i,g),d.setBounds(y,p.y,1,p.h);this.$g=!1}else this.$g=!0;this.uiFacade.removeHighlights();let k=!1;if(m){if(this.settings.player.enableElementHighlighting)for(const t of r){const s=Oa.getGroupId(t.beat);this.uiFacade.highlightElements(s,e.voice.bar.index)}o=!n,k=!0}if(o&&!this.Zg&&this.settings.player.scrollMode!==t.ScrollMode.Off){const t=this.customScrollHandler??this.og;t&&t.onBeatCursorUpdating(h,null===w?void 0:w,c,y,g,i)}k&&(this.tw(e),this.ew(new Ja(r.map(t=>t.beat))))}playedBeatChanged;tw(t){this.rg||(this.playedBeatChanged.trigger(t),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",t))}activeBeatsChanged;ew(t){this.rg||(this.activeBeatsChanged.trigger(t),this.uiFacade.triggerEvent(this.container,"activeBeatsChanged",t))}Zg=!1;sw=!1;iw;nw;beatMouseDown=new gi;beatMouseMove=new gi;beatMouseUp=new gi;noteMouseDown=new gi;noteMouseMove=new gi;noteMouseUp=new gi;get Jg(){return this.settings.player.playerMode!==t.PlayerMode.Disabled&&this.settings.player.enableCursor}rw(t,e){this.rg||(this.Jg&&this.settings.player.enableUserInteraction&&(this.iw={beat:e},this.nw=void 0),this.Zg=!0,this.beatMouseDown.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseDown",e,t))}aw(t,e){this.rg||(this.sw=!0,this.noteMouseDown.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseDown",e,t))}hw(t,e){this.rg||(this.settings.player.enableUserInteraction&&(this.nw&&this.nw.beat===e||(this.nw={beat:e},this.ow(this.iw,this.nw))),this.beatMouseMove.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseMove",e,t))}cw(t,e){this.rg||(this.noteMouseMove.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseMove",e,t))}lw(t,e){this.rg||(this.Jg&&this.settings.player.enableUserInteraction&&this.applyPlaybackRangeFromHighlight(),this.beatMouseUp.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseUp",e,t),this.Zg=!1)}uw(t,e){this.rg||(this.noteMouseUp.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseUp",e,t),this.sw=!1)}Fg(t){if(this.Pg)if(t){const e=this.Pg.findBeat(this.ig,t.startTick),s=this.Pg.findBeat(this.ig,t.endTick);if(e&&s){const t={beat:e.beat},i={beat:s.beat};this.ow(t,i)}}else this.ow(void 0,void 0)}gg(){this.canvasElement.mouseDown.on(t=>{if(!t.isLeftMouseButton)return;this.settings.player.enableUserInteraction&&t.preventDefault();const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this.Np.boundsLookup?.getBeatAtPos(e,s)??null;if(i&&(this.rw(t,i),this.settings.core.includeNoteBounds)){const n=this.Np.boundsLookup?.getNoteAtPos(i,e,s);n&&this.aw(t,n)}}),this.canvasElement.mouseMove.on(t=>{if(!this.Zg)return;const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this.Np.boundsLookup?.getBeatAtPos(e,s)??null;if(i&&(this.hw(t,i),this.sw)){const n=this.Np.boundsLookup?.getNoteAtPos(i,e,s);n&&this.cw(t,n)}}),this.canvasElement.mouseUp.on(t=>{if(!this.Zg)return;this.settings.player.enableUserInteraction&&t.preventDefault();const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this.Np.boundsLookup?.getBeatAtPos(e,s)??null;if(this.lw(t,i),this.sw)if(i){const n=this.Np.boundsLookup?.getNoteAtPos(i,e,s)??null;this.uw(t,n)}else this.uw(t,null)}),this.Np.postRenderFinished.on(()=>{this.iw&&this.Jg&&this.settings.player.enableUserInteraction&&this.ow(this.iw,this.nw)})}highlightPlaybackRange(t,e){this.iw={beat:t},this.nw={beat:e},this.ow(this.iw,this.nw)}applyPlaybackRangeFromHighlight(){if(this.nw){const t=this.Pg?.getBeatStart(this.iw.beat)??this.iw.beat.absolutePlaybackStart;if((this.Pg?.getBeatStart(this.nw.beat)??this.nw.beat.absolutePlaybackStart)<t){const t=this.iw;this.iw=this.nw,this.nw=t}}if(this.iw&&this.Pg){const t=this.Pg,e=t.getMasterBarStart(this.iw.beat.voice.bar.masterBar);if(this.cg=null,this.dp.state===Qe.Paused&&this.Kg(this.Pg.getBeatStart(this.iw.beat),!1,1),this.tickPosition=e+this.iw.beat.playbackStart,this.nw&&this.iw.beat!==this.nw.beat){const s=t.getMasterBarStart(this.nw.beat.voice.bar.masterBar),i=new qa;i.startTick=e+this.iw.beat.playbackStart,i.endTick=s+this.nw.beat.playbackStart+this.nw.beat.playbackDuration-50,this.playbackRange=i}else this.iw=void 0,this.playbackRange=null,this.ow(this.iw,this.nw)}}clearPlaybackRangeHighlight(){this.ow(void 0,void 0)}playbackRangeHighlightChanged=new gi;ow(t,e){const s=this.Np.boundsLookup;if(!s)return void this.playbackRangeHighlightChanged.trigger({});const i=this.Gg;if(!i)return void this.playbackRangeHighlightChanged.trigger({});if(i.clear(),!t||!e||t.beat===e.beat)return void this.playbackRangeHighlightChanged.trigger({});t.bounds||(t.bounds=s.findBeat(t.beat)??void 0),e.bounds||(e.bounds=s.findBeat(e.beat)??void 0);const n=this.Pg?.getBeatStart(t.beat)??t.beat.absolutePlaybackStart;if((this.Pg?.getBeatStart(e.beat)??e.beat.absolutePlaybackStart)<n){const s=t;t=e,e=s}const r={startBeat:t.beat,startBeatBounds:t.bounds,endBeat:e.beat,endBeatBounds:e.bounds,highlightBlocks:[]};let a=t.bounds.realBounds.x;0===t.beat.index&&(a=t.bounds.barBounds.masterBarBounds.realBounds.x);let h=e.bounds.realBounds.x+e.bounds.realBounds.w;if(e.beat.index===e.beat.voice.beats.length-1&&(h=e.bounds.barBounds.masterBarBounds.realBounds.x+e.bounds.barBounds.masterBarBounds.realBounds.w),t.bounds.barBounds.masterBarBounds.staffSystemBounds!==e.bounds.barBounds.masterBarBounds.staffSystemBounds){const n=t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x,o=t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x+t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.w,c=this.uiFacade.createSelectionElement(),l=new zs(a,t.bounds.barBounds.masterBarBounds.visualBounds.y,o-a,t.bounds.barBounds.masterBarBounds.visualBounds.h);c.setBounds(l.x,l.y,l.w,l.h),r.highlightBlocks.push(l),i.appendChild(c);const u=t.bounds.barBounds.masterBarBounds.staffSystemBounds.index+1,d=e.bounds.barBounds.masterBarBounds.staffSystemBounds.index;for(let t=u;t<d;t++){const e=s.staffSystems[t],a=this.uiFacade.createSelectionElement(),h=new zs(n,e.visualBounds.y,o-n,e.visualBounds.h);r.highlightBlocks.push(h),a.setBounds(h.x,h.y,h.w,h.h),i.appendChild(a)}const f=this.uiFacade.createSelectionElement(),p=new zs(n,e.bounds.barBounds.masterBarBounds.visualBounds.y,h-n,e.bounds.barBounds.masterBarBounds.visualBounds.h);r.highlightBlocks.push(p),f.setBounds(p.x,p.y,p.w,p.h),i.appendChild(f)}else{const e=this.uiFacade.createSelectionElement(),s=new zs(a,t.bounds.barBounds.masterBarBounds.visualBounds.y,h-a,t.bounds.barBounds.masterBarBounds.visualBounds.h);e.setBounds(s.x,s.y,s.w,s.h),r.highlightBlocks.push(s),i.appendChild(e)}this.playbackRangeHighlightChanged.trigger(r)}scoreLoaded;Cg(t){this.rg||(this.scoreLoaded.trigger(t),this.uiFacade.triggerEvent(this.container,"scoreLoaded",t),this.mg()||this.loadMidiForScore())}resize=new gi;lg(t){this.rg||(this.resize.trigger(t),this.uiFacade.triggerEvent(this.container,"resize",t))}renderStarted=new gi;ug(t){this.rg||(this.renderStarted.trigger(t),this.uiFacade.triggerEvent(this.container,"renderStarted",t))}renderFinished=new gi;vp(t){this.rg||(this.renderFinished.trigger(t),this.uiFacade.triggerEvent(this.container,"renderFinished",t))}postRenderFinished=new mi;dg(){this.rg||(this.ng.bounds=this.boundsLookup,this.cg=null,this.Kg(this.Dg,!1,1,!0,!0),this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRenderFinished",null))}error=new gi;onError(t){this.rg||(q.error("API","An unexpected error occurred",t),this.error.trigger(t),this.uiFacade.triggerEvent(this.container,"error",t))}get playerReady(){return this.dp.readyForPlayback}wg(){this.rg||this.uiFacade.triggerEvent(this.container,"playerReady",null)}get playerFinished(){return this.dp.finished}xg(){this.rg||this.uiFacade.triggerEvent(this.container,"playerFinished",null)}get soundFontLoaded(){return this.dp.soundFontLoaded}yg(){this.rg||this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null)}midiLoad=new gi;Rg(t){this.rg||(this.midiLoad.trigger(t),this.uiFacade.triggerEvent(this.container,"midiLoad",t))}midiLoaded;kg(t){this.rg||(this.midiLoaded.trigger(t),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",t))}get playerStateChanged(){return this.dp.stateChanged}Sg(t){if(!this.rg){if(!t.stopped&&t.state===Qe.Paused){const t=this.cg,e=this.Pg;t&&e&&(this.dp.tickPosition=e.getBeatStart(t.beat),this.scrollToCursor())}this.uiFacade.triggerEvent(this.container,"playerStateChanged",t)}}get playerPositionChanged(){return this.dp.positionChanged}Bg(t){if(this.rg)return;const e=t.currentTick;this.Dg=e,this.uiFacade.beginInvoke(()=>{const s=t.modifiedTempo/t.originalTempo;this.Kg(e,!1,s,!1,t.isSeek)}),this.uiFacade.triggerEvent(this.container,"playerPositionChanged",t)}get midiEventsPlayed(){return this.dp.midiEventsPlayed}_g(t){this.rg||this.uiFacade.triggerEvent(this.container,"midiEventsPlayed",t)}get playbackRangeChanged(){return this.dp.playbackRangeChanged}Tg(t){this.rg||this.uiFacade.triggerEvent(this.container,"playbackRangeChanged",t)}settingsUpdated=new mi;vg(){this.rg||(this.settingsUpdated.trigger(),this.uiFacade.triggerEvent(this.container,"settingsUpdated",null))}async enumerateOutputDevices(){return await this.dp.output.enumerateOutputDevices()}async setOutputDevice(t){await this.dp.output.setOutputDevice(t)}async getOutputDevice(){return await this.dp.output.getOutputDevice()}async exportAudio(e){if(!this.score)throw new G(t.AlphaTabErrorType.General,"No song loaded");let s;if(this.hg===t.PlayerMode.EnabledSynthesizer)s=this.uiFacade.createWorkerAudioExporter(this.dp.instance);else s=this.uiFacade.createWorkerAudioExporter(null);const i=this.score,n=new xi,r=new Sa(n),a=new La(i,this.settings,r);a.applyTranspositionPitches=!1,a.generate();const h=new tr;h.soundFonts=e.soundFonts,h.sampleRate=e.sampleRate,h.useSyncPoints=e.useSyncPoints,h.masterVolume=e.masterVolume,h.metronomeVolume=e.metronomeVolume,h.playbackRange=e.playbackRange;for(const[t,s]of e.trackVolume)if(t<this.score.tracks.length){const e=this.score.tracks[t];h.trackVolume.set(e.playbackInfo.primaryChannel,s),h.trackVolume.set(e.playbackInfo.secondaryChannel,s)}for(const[t,s]of e.trackTranspositionPitches)if(t<this.score.tracks.length){const e=this.score.tracks[t];h.trackTranspositionPitches.set(e.playbackInfo.primaryChannel,s),h.trackTranspositionPitches.set(e.playbackInfo.secondaryChannel,s)}return await s.initialize(h,n,a.syncPoints,a.transpositionPitches),s}}class ih extends G{xhr;constructor(e,s){super(t.AlphaTabErrorType.General,e),this.xhr=s}}class nh{static loadAlphaTex(t,e){const s=new We;return s.logErrors=!0,s.initFromString(t,e??new aa),s.readScore()}static loadScoreAsync(t,e,s,i){const n=new XMLHttpRequest;n.open("GET",t,!0,null,null),n.responseType="arraybuffer",n.onreadystatechange=()=>{if(n.readyState===XMLHttpRequest.DONE){const t=n.response;if(200===n.status||0===n.status&&t)try{const t=n.response,s=new Uint8Array(t),r=nh.loadScoreFromBytes(s,i);e(r)}catch(t){s(t)}else 0===n.status?s(new ih("You are offline!!\n Please Check Your Network.",n)):404===n.status?s(new ih("Requested URL not found.",n)):500===n.status?s(new ih("Internel Server Error.",n)):"parsererror"===n.statusText?s(new ih("Error.\nParsing JSON Request failed.",n)):"timeout"===n.statusText?s(new ih("Request Time out.",n)):s(new ih(`Unknow Error: ${n.responseText}`,n))}},n.send()}static loadScoreFromBytes(t,e){e||(e=new aa);const s=Nu.buildImporters();q.debug("ScoreLoader",`Loading score from ${t.length} bytes using ${s.length} importers`);let i=null;const n=Ae.fromBuffer(t);for(const t of s){n.reset();try{q.debug("ScoreLoader",`Importing using importer ${t.name}`),t.init(n,e),i=t.readScore(),q.debug("ScoreLoader",`Score imported using ${t.name}`);break}catch(e){if(!(e instanceof Fe))throw q.error("ScoreLoader","Score import failed due to unexpected error: ",e),e;q.debug("ScoreLoader",`${t.name} does not support the file`)}}if(i)return i;throw new Fe("No compatible importer found for file")}}class rh{mouseEvent;get isLeftMouseButton(){return 0===this.mouseEvent.button}getX(t){const e=t.element,s=e.getBoundingClientRect().left+e.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-s}getY(t){const e=t.element,s=e.getBoundingClientRect().top+e.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-s}preventDefault(){this.mouseEvent.preventDefault()}constructor(t){this.mouseEvent=t}}class ah{static dw=new j(()=>new ResizeObserver(t=>{for(const e of t){const t=new CustomEvent("resize",{detail:e});e.target.dispatchEvent(t)}}));fw=0;get width(){return this.element.offsetWidth}set width(t){this.element.style.width=`${t}px`}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(t){this.element.scrollLeft=t}get scrollTop(){return this.element.scrollTop}set scrollTop(t){this.element.scrollTop=t}get height(){return this.element.offsetHeight}set height(t){this.element.style.height=t>=0?`${t}px`:"100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}element;constructor(t){this.element=t,this.mouseDown={on:t=>{const e=e=>{t(new rh(e))};return this.element.addEventListener("mousedown",e,!0),()=>{this.element.removeEventListener("mousedown",e,!0)}},off:t=>{}},this.mouseUp={on:t=>{const e=e=>{t(new rh(e))};return this.element.addEventListener("mouseup",e,!0),()=>{this.element.removeEventListener("mouseup",e,!0)}},off:t=>{}},this.mouseMove={on:t=>{const e=e=>{t(new rh(e))};return this.element.addEventListener("mousemove",e,!0),()=>{this.element.removeEventListener("mousemove",e,!0)}},off:t=>{}};const e=this;this.resize={on:function(t){return 0===e.fw&&ah.dw.value.observe(e.element),e.element.addEventListener("resize",t,!0),e.fw++,()=>this.off(t)},off:t=>{this.element.removeEventListener("resize",t,!0),this.fw--,this.fw<=0&&(this.fw=0,ah.dw.value.unobserve(this.element))}}}stopAnimation(){this.element.style.transition="none"}transitionToX(t,e){this.element.style.transition=`transform ${t}ms linear`,this.setBounds(e,Number.NaN,Number.NaN,Number.NaN)}lastBounds=new zs;setBounds(t,e,s,i){Number.isNaN(t)&&(t=this.lastBounds.x),Number.isNaN(e)&&(e=this.lastBounds.y),Number.isNaN(s)&&(s=this.lastBounds.w),Number.isNaN(i)&&(i=this.lastBounds.h),this.element.style.transform=`translate(${t}px, ${e}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=t,this.lastBounds.y=e,this.lastBounds.w=s,this.lastBounds.h=i}resize;mouseDown;mouseMove;mouseUp;appendChild(t){this.element.appendChild(t.element)}clear(){this.element.innerText=""}}class hh{pw;ip;bw=!1;isFontLoaded=!1;fontLoaded=new gi;constructor(t){this.pw=t,this.ip=t}checkForFontAvailability(){if(Nu.isRunningInWorker)return void(this.isFontLoaded=!1);if(this.bw)return;this.bw=!0;let t=0;const e=window.setInterval(()=>{q.warning("Rendering",`Could not load font '${this.ip[0]}' within ${5*(t+1)} seconds`,null),this.ip.length>1?(this.ip.shift(),t=0):t++},5e3);q.debug("Font",`Start checking for font availablility: ${this.ip.join(", ")}`);const s=t=>{this.ip.length>1?(q.debug("Font",`[${this.ip[0]}] Loading Failed, switching to ${this.ip[1]}`,t),this.ip.shift(),window.setTimeout(()=>{n()},0)):(q.error("Font",`[${this.pw.join(",")}] Loading Failed, rendering cannot start`,t),window.clearInterval(e))},i=t=>{q.debug("Font",`[${t}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(e),this.fontLoaded.trigger(this.ip[0])},n=async()=>{for(const t of this.ip)if(await this.mw(t,!1))return void i(t);try{await document.fonts.load(`1em ${this.ip[0]}`)}catch(t){s(t)}return q.debug("Font",`[${this.ip[0]}] Font API signaled loaded`),await this.mw(this.ip[0],!0)?i(this.ip[0]):s("Font not available"),!0};document.fonts.ready.then(()=>{n()})}mw(t,e){return new Promise(s=>{const i=`1em ${t}`;if(document.fonts.check(i))s(!0);else if(e){q.debug("Font",`Font ${t} not available, creating test element to trigger load`);const e=document.createElement("div");e.style.font=i,e.style.opacity="0",e.style.position="absolute",e.style.top="0",e.style.left="0",e.innerText=`Trigger ${t} load`,document.body.appendChild(e),setTimeout(()=>{document.body.removeChild(e),document.fonts.check(i)?s(!0):s(!1)},200)}else s(!1)})}}class oh extends Si{gw=null;vl;Nl=0;Pl=0;open(t){super.open(t),this.Nl=Math.floor(t*this.sampleRate/1e3/Si.BufferSize),this.vl=new bi(Si.BufferSize*this.Nl),this.onReady()}play(){super.play();const t=this.context;this.gw=t.createScriptProcessor(4096,0,2),this.gw.onaudioprocess=this.ww.bind(this),this.vl.clear(),this.El(),this.source=t.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.source.connect(this.gw,0,0),this.source.start(0),this.gw.connect(t.destination,0,0)}pause(){super.pause(),this.gw&&this.gw.disconnect(0),this.gw=null}addSamples(t){this.vl.write(t,0,t.length),this.Pl--}resetSamples(){this.vl.clear()}El(){const t=this.Nl/2|0,e=t*Si.BufferSize;if(this.vl.count+this.Pl*Si.BufferSize<e){for(let e=0;e<t;e++)this.onSampleRequest();this.Pl+=t}}Ml=new Float32Array(0);ww(t){const e=t.outputBuffer.getChannelData(0),s=t.outputBuffer.getChannelData(1),i=e.length+s.length;let n=this.Ml;n.length!==i&&(n=new Float32Array(i),this.Ml=n);const r=this.vl.read(n,0,Math.min(n.length,this.vl.count));let a=0;const h=Math.min(e.length,r);for(let t=0;t<h;t++)e[t]=n[a++],s[t]=n[a++];if(r<e.length)for(let t=r;t<e.length;t++)e[t]=0,s[t]=0;this.onSamplesPlayed(r/Ht.AudioChannels),this.El()}}class ch{Of;zi;yw=!1;kw=!1;Sw=!1;li=Qe.Paused;Hm=0;Nf=0;Pf=0;Um=0;zm=!1;Bw=null;Xm=[];Ff;Ud=new Xi(0,0,0,0,!1,120,120);get output(){return this.zi}get isReady(){return this.kw&&this.Sw}get isReadyForPlayback(){return this.yw}get state(){return this.li}get logLevel(){return q.logLevel}get worker(){return this.Of}set logLevel(t){q.logLevel=t,this.Of.postMessage({cmd:"alphaSynth.setLogLevel",value:t})}get masterVolume(){return this.Hm}set masterVolume(t){t=Math.max(t,Ht.MinVolume),this.Hm=t,this.Of.postMessage({cmd:"alphaSynth.setMasterVolume",value:t})}get metronomeVolume(){return this.Nf}set metronomeVolume(t){t=Math.max(t,Ht.MinVolume),this.Nf=t,this.Of.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:t})}get countInVolume(){return this.Pf}set countInVolume(t){t=Math.max(t,Ht.MinVolume),this.Pf=t,this.Of.postMessage({cmd:"alphaSynth.setCountInVolume",value:t})}get midiEventsPlayedFilter(){return this.Xm}set midiEventsPlayedFilter(t){this.Xm=t,this.Of.postMessage({cmd:"alphaSynth.setMidiEventsPlayedFilter",value:Nu.prepareForPostMessage(t)})}get playbackSpeed(){return this.Um}set playbackSpeed(t){t=Xt.clamp(t,Ht.MinPlaybackSpeed,Ht.MaxPlaybackSpeed),this.Um=t,this.Of.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:t})}get loadedMidiInfo(){return this.loadedMidiInfo}get currentPosition(){return this.Ud}get tickPosition(){return this.Ud.currentTick}set tickPosition(t){t<0&&(t=0),this.Ud=new Xi(this.Ud.currentTime,this.Ud.endTime,t,this.Ud.endTick,!0,this.Ud.originalTempo,this.Ud.modifiedTempo),this.Of.postMessage({cmd:"alphaSynth.setTickPosition",value:t})}get timePosition(){return this.Ud.currentTime}set timePosition(t){t<0&&(t=0),this.Ud=new Xi(t,this.Ud.endTime,this.Ud.currentTick,this.Ud.endTick,!0,this.Ud.originalTempo,this.Ud.modifiedTempo),this.Of.postMessage({cmd:"alphaSynth.setTimePosition",value:t})}get isLooping(){return this.zm}set isLooping(t){this.zm=t,this.Of.postMessage({cmd:"alphaSynth.setIsLooping",value:t})}get playbackRange(){return this.Bw}set playbackRange(t){t&&(t.startTick<0&&(t.startTick=0),t.endTick<0&&(t.endTick=0)),this.Bw=t,this.Of.postMessage({cmd:"alphaSynth.setPlaybackRange",value:Nu.prepareForPostMessage(t)})}constructor(t,e){this.yw=!1,this.kw=!1,this.Sw=!1,this.li=Qe.Paused,this.Hm=0,this.Nf=0,this.Um=0,this.zm=!1,this.Bw=null,this.zi=t,this.zi.ready.on(this._w.bind(this)),this.zi.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this.zi.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this.zi.open(e.player.bufferTimeInMilliseconds);try{this.Of=Nu.createWebWorker(e)}catch(t){q.error("AlphaSynth",`Failed to create WebWorker: ${t}`)}this.Of.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this.Of.postMessage({cmd:"alphaSynth.initialize",sampleRate:this.zi.sampleRate,logLevel:e.core.logLevel,bufferTimeInMilliseconds:e.player.bufferTimeInMilliseconds}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}destroy(){this.Of.postMessage({cmd:"alphaSynth.destroy"})}play(){return this.zi.activate(),this.Of.postMessage({cmd:"alphaSynth.play"}),!0}pause(){this.Of.postMessage({cmd:"alphaSynth.pause"})}playPause(){this.zi.activate(),this.Of.postMessage({cmd:"alphaSynth.playPause"})}stop(){this.Of.postMessage({cmd:"alphaSynth.stop"})}playOneTimeMidiFile(t){this.Of.postMessage({cmd:"alphaSynth.playOneTimeMidiFile",midi:ha.midiFileToJsObject(Nu.prepareForPostMessage(t))})}loadSoundFont(t,e){this.Of.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:Nu.prepareForPostMessage(t),append:e})}resetSoundFonts(){this.Of.postMessage({cmd:"alphaSynth.resetSoundFonts"})}loadMidiFile(t){this.Of.postMessage({cmd:"alphaSynth.loadMidi",midi:ha.midiFileToJsObject(Nu.prepareForPostMessage(t))})}applyTranspositionPitches(t){this.Of.postMessage({cmd:"alphaSynth.applyTranspositionPitches",transpositionPitches:JSON.stringify(Array.from(Nu.prepareForPostMessage(t).entries()))})}setChannelTranspositionPitch(t,e){this.Of.postMessage({cmd:"alphaSynth.setChannelTranspositionPitch",channel:t,semitones:e})}setChannelMute(t,e){this.Of.postMessage({cmd:"alphaSynth.setChannelMute",channel:t,mute:e})}resetChannelStates(){this.Of.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(t,e){this.Of.postMessage({cmd:"alphaSynth.setChannelSolo",channel:t,solo:e})}setChannelVolume(t,e){e=Math.max(e,Ht.MinVolume),this.Of.postMessage({cmd:"alphaSynth.setChannelVolume",channel:t,volume:e})}handleWorkerMessage(t){const e=t.data;switch(e.cmd){case"alphaSynth.ready":this.kw=!0,this.Tw();break;case"alphaSynth.destroyed":this.Of.terminate();break;case"alphaSynth.readyForPlayback":this.yw=!0,this.Af();break;case"alphaSynth.positionChanged":this.Ud=new Xi(e.currentTime,e.endTime,e.currentTick,e.endTick,e.isSeek,e.originalTempo,e.modifiedTempo),this.positionChanged.trigger(this.Ud);break;case"alphaSynth.midiEventsPlayed":this.midiEventsPlayed.trigger(new Qn(e.events.map(ha.jsObjectToMidiEvent)));break;case"alphaSynth.playerStateChanged":this.li=e.state,this.stateChanged.trigger(new zi(e.state,e.stopped));break;case"alphaSynth.playbackRangeChanged":this.Bw=e.playbackRange,this.playbackRangeChanged.trigger(new Zn(this.Bw));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(e.error);break;case"alphaSynth.midiLoaded":this.Af(),this.Ff=new Xi(e.currentTime,e.endTime,e.currentTick,e.endTick,e.isSeek,e.originalTempo,e.modifiedTempo),this.midiLoaded.trigger(this.Ff);break;case"alphaSynth.midiLoadFailed":this.Af(),this.midiLoadFailed.trigger(e.error);break;case"alphaSynth.output.addSamples":this.zi.addSamples(e.samples);break;case"alphaSynth.output.play":this.zi.play();break;case"alphaSynth.output.pause":this.zi.pause();break;case"alphaSynth.output.destroy":this.zi.destroy();break;case"alphaSynth.output.resetSamples":this.zi.resetSamples()}}Tw(){this.isReady&&this.ready.trigger()}Af(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}ready=new mi;readyForPlayback=new mi;finished=new mi;soundFontLoaded=new mi;soundFontLoadFailed=new gi;midiLoaded=new gi;midiLoadFailed=new gi;stateChanged=new gi;positionChanged=new gi;midiEventsPlayed=new gi;playbackRangeChanged=new gi;onOutputSampleRequest(){this.Of.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputSamplesPlayed(t){this.Of.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:t})}_w(){this.Sw=!0,this.Tw()}loadBackingTrack(t){}updateSyncPoints(t){}}class lh{Om;wl;Wm=0;boundsLookup=null;constructor(t,e){this.Om=t;try{this.wl=Nu.createWebWorker(e)}catch(t){return void q.error("Rendering",`Failed to create WebWorker: ${t}`)}this.wl.postMessage({cmd:"alphaTab.initialize",settings:this.xw(e)}),this.wl.addEventListener("message",this.Mw.bind(this))}destroy(){this.wl.terminate()}updateSettings(t){this.wl.postMessage({cmd:"alphaTab.updateSettings",settings:this.xw(t)})}xw(t){const e=ha.settingsToJsObject(Nu.prepareForPostMessage(t));return e.delete("player"),e}render(t){this.wl.postMessage({cmd:"alphaTab.render",renderHints:t})}resizeRender(){this.wl.postMessage({cmd:"alphaTab.resizeRender"})}renderResult(t){this.wl.postMessage({cmd:"alphaTab.renderResult",resultId:t})}get width(){return this.Wm}set width(t){this.Wm=t,this.wl.postMessage({cmd:"alphaTab.setWidth",width:t})}Mw(t){const e=t.data;switch(e.cmd){case"alphaTab.preRender":this.preRender.trigger(e.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(e.result);break;case"alphaTab.partialLayoutFinished":this.partialLayoutFinished.trigger(e.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(e.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=ga.fromJson(e.boundsLookup,this.Om.score),this.boundsLookup.finish(),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(e.error)}}renderScore(t,e,s){const i=null==t?null:ha.scoreToJsObject(Nu.prepareForPostMessage(t));this.wl.postMessage({cmd:"alphaTab.renderScore",score:i,trackIndexes:Nu.prepareForPostMessage(e),fontSizes:la.fontSizeLookupTables,renderHints:s})}preRender=new gi;partialRenderFinished=new gi;partialLayoutFinished=new gi;renderFinished=new gi;postRenderFinished=new mi;error=new gi}class uh{cursorWrapper;barCursor;beatCursor;selectionWrapper;constructor(t,e,s,i){this.cursorWrapper=t,this.barCursor=e,this.beatCursor=s,this.selectionWrapper=i}}class dh extends ah{Nw;Pw;centerAtPosition=!1;constructor(t,e,s){super(t),this.Nw=e,this.Pw=s}get width(){return this.element.offsetWidth/this.Nw}set width(t){this.element.style.width=t*this.Nw+"px"}get height(){return this.element.offsetHeight/this.Pw}set height(t){this.element.style.height=t>=0?t*this.Pw+"px":"100%"}setBounds(t,e,s,i){Number.isNaN(t)&&(t=this.lastBounds.x),Number.isNaN(e)&&(e=this.lastBounds.y),Number.isNaN(s)?s=this.lastBounds.w:s/=this.Nw,Number.isNaN(i)?i=this.lastBounds.h:i/=this.Pw;let n=`translate(${t}px, ${e}px) scale(${s}, ${i})`;this.centerAtPosition&&(n+=" translateX(-50%)"),this.element.style.transform=n,this.element.style.transformOrigin="top left",this.lastBounds.x=t,this.lastBounds.y=e,this.lastBounds.w=s,this.lastBounds.h=i}}class fh{sampleRate=44100;audioElement;Cw=0;get backingTrackDuration(){const t=this.audioElement.duration??0;return Number.isFinite(t)?1e3*t:0}get playbackRate(){return this.audioElement.playbackRate}set playbackRate(t){this.audioElement.playbackRate=t}get masterVolume(){return this.audioElement.volume}set masterVolume(t){this.audioElement.volume=t}seekTo(t){this.audioElement.currentTime=t/1e3}loadBackingTrack(t){this.audioElement?.src&&URL.revokeObjectURL(this.audioElement.src);const e=new Blob([t.rawAudioFile]),s=this.audioElement.playbackRate;this.audioElement.src=URL.createObjectURL(e),this.audioElement.playbackRate=s}open(t){const e=document.createElement("audio");e.style.display="none",document.body.appendChild(e),e.addEventListener("seeked",()=>{this.Ew()}),e.addEventListener("timeupdate",()=>{this.Ew()}),this.audioElement=e,this.ready.trigger()}Ew(){const t=1e3*this.audioElement.currentTime;this.timeUpdate.trigger(t)}play(){this.audioElement.play(),this.Cw=window.setInterval(()=>{this.Ew()},50)}destroy(){const t=this.audioElement;t&&document.body.removeChild(t)}pause(){this.audioElement.pause(),window.clearInterval(this.Cw)}addSamples(t){}resetSamples(){}activate(){}ready=new mi;samplesPlayed=new gi;timeUpdate=new gi;sampleRequest=new mi;async enumerateOutputDevices(){return ki.enumerateOutputDevices()}async setOutputDevice(t){await ki.checkSinkIdSupport()&&(t?await this.audioElement.setSinkId(t.deviceId):await this.audioElement.setSinkId(""))}async getOutputDevice(){if(!await ki.checkSinkIdSupport())return null;const t=this.audioElement.sinkId;if("string"!=typeof t||""===t||"default"===t)return null;let e=ki.findKnownDevice(t);if(e)return e;const s=await this.enumerateOutputDevices();return e=s.find(e=>e.deviceId===t),e||(q.warning("WebAudio","Could not find output device in device list",t,s),null)}}class ph{static Fw=1;wl;Aw;Dw;Lw;Ww=null;constructor(t,e){this.Dw=ph.Fw++,this.wl=t,this.Lw=e}async initialize(t,e,s,i){const n=this.handleWorkerMessage.bind(this);this.wl.worker.addEventListener("message",n,!1),this.Aw=()=>{this.wl.worker.removeEventListener("message",n,!1)},this.Ww=Promise.withResolvers(),this.wl.worker.postMessage({cmd:"alphaSynth.exporter.initialize",exporterId:this.Dw,options:Nu.prepareForPostMessage(t),midi:ha.midiFileToJsObject(Nu.prepareForPostMessage(e)),syncPoints:Nu.prepareForPostMessage(s),transpositionPitches:Nu.prepareForPostMessage(i)}),await this.Ww.promise}handleWorkerMessage(e){const s=e.data;if(s.exporterId!==this.Dw)return;switch(s.cmd){case"alphaSynth.exporter.initialized":this.Ww?.resolve(null),this.Ww=null;break;case"alphaSynth.exporter.error":this.Ww?.reject(s.error),this.Ww=null;break;case"alphaSynth.exporter.rendered":this.Ww?.resolve(s.chunk),this.Ww=null;break;case"alphaSynth.destroyed":this.Ww?.reject(new G(t.AlphaTabErrorType.General,"Worker was destroyed")),this.Ww=null}}async render(e){if(this.Ww)throw new G(t.AlphaTabErrorType.General,"There is already an ongoing operation, wait for initialize to complete before requesting render");return this.Ww=Promise.withResolvers(),this.wl.worker.postMessage({cmd:"alphaSynth.exporter.render",exporterId:this.Dw,milliseconds:e}),await this.Ww.promise}destroy(){this.wl.worker.postMessage({cmd:"alphaSynth.exporter.destroy",exporterId:this.Dw}),this.Aw(),this.Lw&&this.wl.destroy()}[Symbol.dispose](){this.destroy()}}!function(t){t[t.LayoutDone=0]="LayoutDone",t[t.RenderRequested=1]="RenderRequested",t[t.RenderDone=2]="RenderDone",t[t.Detached=3]="Detached"}(gs||(gs={}));class bh{Rw=new Map;Om;Iw=null;Ow=null;Gw=0;Vw=null;$w;Hw=new Map;Uw=new Map;zw;rootContainerBecameVisible=new mi;canRenderChanged=new mi;get resizeThrottle(){return 10}rootContainer;areWorkersSupported;get canRender(){return this.Xw()}Xw(){let t=!1;for(const e of this.Rw.values())e.isFontLoaded||(t=!0);return!t&&(q.debug("Font",`All fonts loaded: ${this.Rw.size}`),!0)}jw(t){la.generateFontLookup(t),this.Xw()&&this.canRenderChanged.trigger()}constructor(e){if(Nu.webPlatform!==t.WebPlatform.Browser&&Nu.webPlatform!==t.WebPlatform.BrowserModule)throw new G(t.AlphaTabErrorType.General,"Usage of AlphaTabApi is only possible in browser environments. For usage in node use the Low Level APIs");e.classList.add("alphaTab"),this.rootContainer=new ah(e),this.areWorkersSupported="Worker"in window,this.$w=new IntersectionObserver(this.Jw.bind(this),{threshold:[0,.01,1]}),this.$w.observe(e)}Jw(t){for(const e of t){const t=e.target;if(t===this.rootContainer.element)e.isIntersecting&&(this.rootContainerBecameVisible.trigger(),this.$w.unobserve(this.rootContainer.element));else if("layoutResultId"in t&&this.Om.settings.core.enableLazyLoading){const s=t;e.isIntersecting?s.renderedResultId!==s.layoutResultId?this.Uw.has(s.layoutResultId)?s.resultState!==gs.RenderRequested&&(s.resultState=gs.RenderRequested,this.Om.renderer.renderResult(s.layoutResultId)):t.replaceChildren():s.resultState===gs.Detached&&(t.replaceChildren(...s.renderedResult),s.resultState=gs.RenderDone):s.resultState===gs.RenderDone&&(s.resultState=gs.Detached,s.replaceChildren())}}}createWorkerRenderer(){return new lh(this.Om,this.Om.settings)}initialize(e,s){let i;this.Om=e,i=s instanceof aa?s:ha.jsObjectToSettings(s);const n=this.qw();ia.fromJson(i,n),i.notation.notationMode===t.NotationMode.SongBook&&i.setSongBookModeSettings(),e.settings=i,this.Yw(i),this.Vw=this.parseTracks(i.core.tracks),this.Iw="";const r=e.container;i.core.tex&&(this.Iw=r.element.textContent,r.element.innerText=""),this.Kw(i),this.Ow=i.core.file}Yw(t){for(const e of t.display.resources.elementFonts.values())this.Qw(e);this.Qw(t.display.resources.graceFont),this.Qw(t.display.resources.tablatureFont),this.Qw(t.display.resources.numberedNotationFont),this.Qw(t.display.resources.numberedNotationGraceFont)}Qw(t){if(!this.Rw.has(t.families.join(", "))){const e=new hh(t.families);this.Rw.set(t.families.join(", "),e),e.fontLoaded.on(this.jw.bind(this)),e.checkForFontAvailability()}}destroy(){const t=this.rootContainer.element;t.innerHTML="";const e=this.zw,s=e.elements.get(t.ownerDocument);s&&(s.usages--,s.usages<=0&&(s.element.remove(),e.elements.delete(t.ownerDocument))),0===e.elements.size&&bh.Zw.delete(e.hash)}createCanvasElement(){const t=document.createElement("div");return t.classList.add("at-surface",`at${this.zw.fontSuffix}`),t.style.fontSize="0",t.style.overflow="hidden",t.style.lineHeight="0",t.style.position="relative",new ah(t)}setCanvasOverflow(t,e,s){const i=t.element;0===e?(i.style.boxSizing="",i.style.paddingRight="",i.style.paddingBottom=""):s?(i.style.boxSizing="content-box",i.style.paddingBottom=`${e}px`):(i.style.boxSizing="content-box",i.style.paddingRight=`${e}px`)}triggerEvent(t,e,s=null,i){const n=t.element;e=`alphaTab.${e}`;const r=document.createEvent("CustomEvent"),a=i?i.mouseEvent:null;if(r.initCustomEvent(e,!1,!1,s),a&&(r.originalEvent=a),n.dispatchEvent(r),window&&"jQuery"in window){const t=window.jQuery,i=[];i.push(s),a&&i.push(a),t(n).trigger(e,i)}}load(t,e,s){if(t instanceof $t)return e(t),!0;if(t instanceof ArrayBuffer){const s=new Uint8Array(t);return e(nh.loadScoreFromBytes(s,this.Om.settings)),!0}return t instanceof Uint8Array?(e(nh.loadScoreFromBytes(t,this.Om.settings)),!0):"string"==typeof t&&(nh.loadScoreAsync(t,e,s,this.Om.settings),!0)}loadSoundFont(t,e){return!!this.Om.player&&(t instanceof ArrayBuffer?(this.Om.player.loadSoundFont(new Uint8Array(t),e),!0):t instanceof Uint8Array?(this.Om.player.loadSoundFont(t,e),!0):"string"==typeof t&&(this.Om.loadSoundFontFromUrl(t,e),!0))}initialRender(){this.Om.renderer.preRender.on(t=>{this.Gw=0,this.Uw.clear(),this.Hw.clear()});const t=()=>{this.Om.renderer.width=0|this.rootContainer.width,this.Om.renderer.updateSettings(this.Om.settings),this.Iw?(this.Om.tex(this.Iw,this.Vw??void 0),this.Vw=null):this.Ow&&nh.loadScoreAsync(this.Ow,t=>{this.Om.renderScore(t,this.Vw??void 0),this.Vw=null},t=>{this.Om.onError(t)},this.Om.settings)};this.rootContainer.isVisible?t():this.rootContainerBecameVisible.on(t)}Kw(t){const e=this.Om.container.element.ownerDocument;bh.createSharedStyleElement(e);const s=t.core.smuflFontSources??Pu.buildDefaultSmuflFontSources(t.core.fontDirectory),i=bh.ty(s.values()),n=bh.Zw;if(n.has(i)){const t=n.get(i);return t.checker.fontLoaded.on(this.jw.bind(this)),this.ey(t,e),void(this.zw=t)}const r=0===n.size?"":String(n.size),a=`alphaTab${r}`,h=`\n            @font-face {\n                font-display: block;\n                font-family: '${a}';\n                src: ${Array.from(s.entries()).map(t=>`url(${JSON.stringify(t[1])}) format('${bh.sy(t[0])}')`).join(",")};\n                font-weight: normal;\n                font-style: normal;\n            }\n            .at-surface.at${r} .at {\n                font-family: '${a}';\n                speak: none;\n                font-style: normal;\n                font-weight: normal;\n                font-variant: normal;\n                text-transform: none;\n                line-height: 1;\n                line-height: 1;\n                -webkit-font-smoothing: antialiased;\n                -moz-osx-font-smoothing: grayscale;\n                font-size: ${t.display.resources.engravingSettings.musicFontSize}px;\n                overflow: visible !important;\n            }`,o=new hh([a]);o.fontLoaded.on(this.jw.bind(this)),this.Rw.set(a,o),o.checkForFontAvailability(),t.display.resources.smuflFontFamilyName=a;const c={hash:i,elements:new Map,fontSuffix:r,checker:o,cssSource:h};this.ey(c,e),n.set(i,c),this.zw=c}ey(t,e){if(t.elements.has(e))return void t.elements.get(e).usages++;const s=e.createElement("style");s.id=`alphaTabStyle${t.fontSuffix}`,s.innerHTML=t.cssSource,e.getElementsByTagName("head").item(0).appendChild(s),t.elements.set(e,{element:s,usages:1})}static sy(e){switch(e){case t.FontFileFormat.EmbeddedOpenType:return"embedded-opentype";case t.FontFileFormat.Woff:return"woff";case t.FontFileFormat.Woff2:return"woff2";case t.FontFileFormat.OpenType:return"opentype";case t.FontFileFormat.TrueType:return"truetype";case t.FontFileFormat.Svg:return"svg"}}static Zw=new Map;static ty(t,e=0){let s=3735928559^e,i=1103547991^e;for(const e of t)for(let t=0;t<e.length;t++){const n=e.charCodeAt(t);s=Math.imul(s^n,2654435761),i=Math.imul(i^n,1597334677)}return s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),i^=Math.imul(s^s>>>13,3266489909),4294967296*(2097151&i)+(s>>>0)}static createSharedStyleElement(t){let e=t.getElementById("alphaTabStyle");if(!e){e=document.createElement("style"),e.id="alphaTabStyleShared";const t="\n                .at-surface * {\n                    cursor: default;\n                    vertical-align: top;\n                    overflow: visible;\n                }\n                .at-surface-svg text {\n                    dominant-baseline: alphabetic;\n                    white-space:pre;\n                }";e.innerHTML=t,document.getElementsByTagName("head").item(0).appendChild(e)}}parseTracks(t){if(!t)return[];const e=[];if("string"==typeof t)try{if("all"===t)return[-1];t=JSON.parse(t)}catch{t=[0]}if("number"==typeof t)e.push(t);else if("length"in t){const s=t.length,i=t;for(let t=0;t<s;t++){const s=i[t];let n=0;n="number"==typeof s?s:"index"in s?s.index:Number.parseInt(s.toString(),10),(n>=0||-1===n)&&e.push(n)}}else"index"in t&&e.push(t.index);return e}qw(){const t=new Map,e=this.Om.container.element;if(e.dataset)for(const s of Object.keys(e.dataset)){let i=e.dataset[s];try{const t=i;i=JSON.parse(t)}catch{""===i&&(i=null)}t.set(s,i)}else for(let s=0;s<e.attributes.length;s++){const i=e.attributes.item(s),n=i.nodeName;if(n.startsWith("data-")){const e=n.substr(5).split("-");let s=e[0];for(let t=1;t<e.length;t++)s+=e[t].substr(0,1).toUpperCase()+e[t].substr(1);let r=i.nodeValue;try{r=JSON.parse(r)}catch{""===r&&(r=null)}t.set(s,r)}}return t}beginUpdateRenderResults(t){if(!this.Uw.has(t.id))return;const e=this.Uw.get(t.id),s=t.renderResult;"string"==typeof s?e.innerHTML=s:"nodeType"in s&&e.replaceChildren(s),e.resultState=gs.RenderDone,e.renderedResultId=t.id,e.renderedResult=Array.from(e.children)}beginAppendRenderResults(t){const e=this.Om.canvasElement.element;if(t){let s;this.Gw<e.childElementCount?s=e.childNodes.item(this.Gw):(s=document.createElement("div"),e.appendChild(s)),s.style.zIndex="1",s.style.position="absolute",s.style.left=`${t.x}px`,s.style.top=`${t.y}px`,s.style.width=`${t.width}px`,s.style.height=`${t.height}px`,s.style.display="inline-block",s.layoutResultId=t.id,s.resultState=gs.LayoutDone,s.renderedResultId=void 0,s.renderedResult=void 0,t.reuseViewport||(s.textContent=""),this.Uw.set(t.id,s);for(let e=t.firstMasterBarIndex;e<=t.lastMasterBarIndex;e++)e>=0&&this.Hw.set(e,s);this.Om.settings.core.enableLazyLoading&&(this.$w.unobserve(s),this.$w.observe(s)),this.Gw++}else for(;e.childElementCount>this.Gw;)this.Om.settings.core.enableLazyLoading&&this.$w.unobserve(e.lastChild),e.removeChild(e.lastElementChild)}createWorkerPlayer(){let e=null;const s="ScriptProcessorNode"in window;return window.isSecureContext&&"AudioWorkletNode"in window&&this.Om.settings.player.outputMode===t.PlayerOutputMode.WebAudioAudioWorklets?(q.debug("Player","Will use webworkers for synthesizing and web audio api with worklets for playback"),e=new ch(new _i(this.Om.settings),this.Om.settings)):s&&(q.debug("Player","Will use webworkers for synthesizing and web audio api with ScriptProcessor for playback"),e=new ch(new oh,this.Om.settings)),e?e.ready.on(()=>{this.Om.settings.player.soundFont&&this.Om.loadSoundFontFromUrl(this.Om.settings.player.soundFont,!1)}):q.error("Player","Player requires webworkers and web audio api, browser unsupported",null),e}createWorkerAudioExporter(t){const e=null===t||!(t instanceof ch);return e&&(t=this.createWorkerPlayer()),new ph(t,e)}beginInvoke(t){window.requestAnimationFrame(()=>{t()})}iy=[];highlightElements(t,e){const s=this.Hw.get(e);if(s){const e=s.getElementsByClassName(t);for(let t=0;t<e.length;t++)e.item(t).classList.add("at-highlight"),this.iy.push(e.item(t))}}removeHighlights(){const t=this.iy;if(t){for(const e of t)e.classList.remove("at-highlight");this.iy=[]}}destroyCursors(){const t=this.Om.container.element,e=t.querySelector(".at-cursors");t.removeChild(e)}createCursors(){const t=this.Om.container.element,e=document.createElement("div");e.classList.add("at-cursors");const s=document.createElement("div");s.classList.add("at-selection");const i=this.createScalingElement(),n=this.createScalingElement(),r=i.element;r.classList.add("at-cursor-bar");const a=n.element;return a.classList.add("at-cursor-beat"),t.style.position="relative",t.style.textAlign="left",e.style.position="absolute",e.style.zIndex="1000",e.style.display="inline",e.style.pointerEvents="none",s.style.position="absolute",r.style.position="absolute",r.style.left="0",r.style.top="0",r.style.willChange="transform",i.width=1,i.height=1,i.setBounds(0,0,1,1),a.style.position="absolute",a.style.transition="all 0s linear",a.style.left="0",a.style.top="0",a.style.willChange="transform",n.width=3,n.height=1,n.centerAtPosition=!0,n.setBounds(0,0,1,1),t.insertBefore(e,t.firstChild),e.appendChild(s),e.appendChild(r),e.appendChild(a),new uh(new ah(e),i,n,new ah(s))}getOffset(t,e){const s=e.element,i=s.getBoundingClientRect();let n=i.top+s.ownerDocument.defaultView.pageYOffset,r=i.left+s.ownerDocument.defaultView.pageXOffset;if(t){const e=t.element,s=e.nodeName.toLowerCase();if("html"!==s&&"body"!==s){const s=this.getOffset(null,t);n=n+e.scrollTop-s.y,r=r+e.scrollLeft-s.x}}const a=new zs;return a.x=r,a.y=n,a.w=i.width,a.h=i.height,a}ny=null;getScrollContainer(){if(this.ny)return this.ny;let t="string"==typeof this.Om.settings.player.scrollElement?document.querySelector(this.Om.settings.player.scrollElement):this.Om.settings.player.scrollElement;const e=t.nodeName.toLowerCase();if("html"===e||"body"===e)if("scrollingElement"in document)t=document.scrollingElement;else{t=-1!==navigator.userAgent.indexOf("WebKit")?document.body:document.documentElement}return this.ny=new ah(t),this.ny}createSelectionElement(){return this.createScalingElement()}createScalingElement(){const t=document.createElement("div");t.style.position="absolute";const e=new dh(t,100,100);return e.width=1,e.height=1,e.setBounds(0,0,1,1),e}scrollToY(t,e,s){this.hy(t.element,e,s)}scrollToX(t,e,s){this.oy(t.element,e,s)}stopScrolling(t){const e=this.ly.get(t.element);void 0!==e&&this.uy.delete(e)}get py(){const e=this.Om.settings.player;return e.nativeBrowserSmoothScroll&&e.scrollMode!==t.ScrollMode.Smooth}by=0;uy=new Set;ly=new Map;hy(t,e,s){this.py?t.scrollTo({top:e,behavior:"smooth"}):this.my(t,t.scrollTop,e,s,e=>{t.scrollTop=e})}my(t,e,s,i,n){const r=this.ly.get(t);if(void 0!==r&&this.uy.delete(r),0===i)return void n(s);const a=this.by++;this.ly.set(t,a),this.uy.add(a);const h=s-e;let o=0;const c=t=>{if(!this.uy.has(a))return;0===o&&(o=t);const s=t-o,r=Math.min(s/i,1);n(e+h*r|0),s<i?window.requestAnimationFrame(c):this.uy.delete(a)};window.requestAnimationFrame(c)}oy(t,e,s){this.py?t.scrollTo({left:e,behavior:"smooth"}):this.my(t,t.scrollLeft,e,s,e=>{t.scrollLeft=e})}createBackingTrackPlayer(){return new Qa(new fh,this.Om.settings.player.bufferTimeInMilliseconds)}}class mh{loaded;total;constructor(t,e){this.loaded=t,this.total=e}}class gh extends sh{constructor(t,e){super(new bh(t),e)}tex(t,e){const s=this.uiFacade;super.tex(t,s.parseTracks(e))}print(e,s=null){const i=window.open("","","width=0,height=0"),n=i.document.createElement("div");e?n.style.width=e:this.settings.display.layoutMode===t.LayoutMode.Horizontal?n.style.width="297mm":n.style.width="210mm",i.document.write("\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <style>\n            .at-surface {\n                width: auto !important;\n                height: auto !important;\n            }\n            .at-surface > div {\n                position: relative!important;\n                left: auto !important;\n                top: auto !important;\n                break-inside: avoid;\n            }\n            </style>\n          </head>\n          <body></body>\n        </html>\n        ");const r=this.score;r&&(r.artist&&r.title?i.document.title=`${r.title} - ${r.artist}`:r.title&&(i.document.title=`${r.title}`)),i.document.body.appendChild(n);const a=void 0!==window.screenLeft?window.screenLeft:window.left,h=void 0!==window.screenTop?window.screenTop:window.top,o="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,c="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,l=n.offsetWidth+50,u=window.innerHeight,d=(o/2|0)-(l/2|0)+a,f=(c/2|0)-(u/2|0)+h;i.resizeTo(l,u),i.moveTo(d,f),i.focus();const p=ha.jsObjectToSettings(ha.settingsToJsObject(this.settings));p.core.enableLazyLoading=!1,p.core.useWorkers=!0,p.core.file=null,p.core.tracks=null,p.player.enableCursor=!1,p.player.playerMode=t.PlayerMode.Disabled,p.player.enableElementHighlighting=!1,p.player.enableUserInteraction=!1,p.player.soundFont=null,p.display.scale=.8,p.display.stretchForce=.8,ia.fromJson(p,s);const b=new gh(n,p);i.onunload=()=>{b.destroy()},b.renderer.postRenderFinished.on(()=>{i.print()}),b.renderTracks(this.tracks)}downloadMidi(t=Ye.SingleTrackMultiChannel){if(!this.score)return;const e=new xi;e.format=t;const s=new Sa(e,!0);new La(this.score,this.settings,s).generate();const i=e.toBinary(),n=this.score.title?`${this.score.title}.mid`:"File.mid",r=document.createElement("a");r.download=n;const a=new Blob([i],{type:"audio/midi"}),h=URL.createObjectURL(a);r.href=h,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}changeTrackMute(t,e){const s=this.gy(this.uiFacade.parseTracks(t));super.changeTrackMute(s,e)}changeTrackSolo(t,e){const s=this.gy(this.uiFacade.parseTracks(t));super.changeTrackSolo(s,e)}changeTrackVolume(t,e){const s=this.gy(this.uiFacade.parseTracks(t));super.changeTrackVolume(s,e)}gy(t){if(!this.score)return[];const e=[];if(1===t.length&&-1===t[0])for(const t of this.score.tracks)e.push(t);else for(const s of t)s>=0&&s<this.score.tracks.length&&e.push(this.score.tracks[s]);return e}soundFontLoad=new gi;loadSoundFontFromUrl(t,e){const s=this.player;if(!s)return;q.debug("AlphaSynth",`Start loading Soundfont from url ${t}`);const i=new XMLHttpRequest;i.open("GET",t,!0,null,null),i.responseType="arraybuffer",i.onload=t=>{const s=new Uint8Array(i.response);this.loadSoundFont(s,e)},i.onerror=t=>{q.error("AlphaSynth",`Loading failed: ${t.message}`),s.soundFontLoadFailed.trigger(new ih(t.message,i))},i.onprogress=t=>{q.debug("AlphaSynth",`Soundfont downloading: ${t.loaded}/${t.total} bytes`);const e=new mh(t.loaded,t.total);this.soundFontLoad.trigger(e),this.uiFacade.triggerEvent(this.container,"soundFontLoad",e)},i.send()}}class wh{exec(t,e,s){if("string"!=typeof e&&(s=[e],e="init"),95===e.charCodeAt(0)||"exec"===e)return null;const i=new jQuery(t),n=i.data("alphaTab");if("destroy"===e&&!n)return null;if("init"!==e&&!n)throw new Error("alphaTab not initialized");const r=this[e];if(r){const t=[i,n].concat(s);return r.apply(this,t)}return q.error("Api",`Method '${e}' does not exist on jQuery.alphaTab`),null}init(t,e,s){if(!e){e=new gh(t[0],s),t.data("alphaTab",e);for(const i of this.wy)i(t,e,s)}}destroy(t,e){t.removeData("alphaTab"),e.destroy()}print(t,e,s,i){e.print(s,i)}load(t,e,s,i){return e.load(s,i)}render(t,e){e.render()}renderScore(t,e,s,i){e.renderScore(s,i)}renderTracks(t,e,s){e.renderTracks(s)}invalidate(t,e){e.render()}tex(t,e,s,i){e.tex(s,i)}muteTrack(t,e,s,i){e.changeTrackMute(s,i)}soloTrack(t,e,s,i){e.changeTrackSolo(s,i)}trackVolume(t,e,s,i){e.changeTrackVolume(s,i)}loadSoundFont(t,e,s,i){e.loadSoundFont(s,i)}resetSoundFonts(t,e){e.resetSoundFonts()}pause(t,e){e.pause()}play(t,e){return e.play()}playPause(t,e){e.playPause()}stop(t,e){e.stop()}api(t,e){return e}player(t,e){return e.player}isReadyForPlayback(t,e){return e.isReadyForPlayback}playerState(t,e){return e.playerState}masterVolume(t,e,s){return"number"==typeof s&&(e.masterVolume=s),e.masterVolume}metronomeVolume(t,e,s){return"number"==typeof s&&(e.metronomeVolume=s),e.metronomeVolume}countInVolume(t,e,s){return"number"==typeof s&&(e.countInVolume=s),e.countInVolume}midiEventsPlayedFilter(t,e,s){return Array.isArray(s)&&(e.midiEventsPlayedFilter=s),e.midiEventsPlayedFilter}playbackSpeed(t,e,s){return"number"==typeof s&&(e.playbackSpeed=s),e.playbackSpeed}tickPosition(t,e,s){return"number"==typeof s&&(e.tickPosition=s),e.tickPosition}timePosition(t,e,s){return"number"==typeof s&&(e.timePosition=s),e.timePosition}loop(t,e,s){return"boolean"==typeof s&&(e.isLooping=s),e.isLooping}renderer(t,e){return e.renderer}score(t,e){return e.score}settings(t,e){return e.settings}tracks(t,e){return e.tracks}wy=[];yy(t){this.wy.push(t)}static restore(t){new jQuery(t).empty().removeData("alphaTab")}}var yh,kh,Sh,Bh,_h,Th,xh,Mh="function"==typeof SuppressedError?SuppressedError:function(t,e,s){var i=new Error(s);return i.name="SuppressedError",i.error=t,i.suppressed=e,i};class vh{static ky;static Sy=null;static enable(t,e){vh.ky=e,vh.initializeMusicFont(vh.ky.AlphaSkiaTypeface.register(t))}static initializeMusicFont(t){vh.Sy=new vh.ky.AlphaSkiaTextStyle([t.familyName],t.weight,t.isItalic)}static registerFont(t,e){const s=vh.ky.AlphaSkiaTypeface.register(t.buffer);return e||(e=Hr.withFamilyList([s.familyName],12,s.isItalic?as.Italic:as.Plain,s.weight>400?hs.Bold:hs.Regular)),e}Lp;Rp=new Se(0,0,0,0);Gp=0;By=null;_y=1;Ty=new Map;Ip=new Hr("Arial",10,as.Plain);xy=null;settings;get font(){return this.Ip}set font(t){if(this.Ip===t)return;this.Ip=t;const e=this.My(t);if(this.Ty.has(e))this.By=this.Ty.get(e);else{const s=new vh.ky.AlphaSkiaTextStyle(t.families,t.weight===hs.Bold?700:400,t.isItalic);this.Ty.set(e,s),this.By=s}}My(t){return[...t.families,t.weight.toString(),t.isItalic?"italic":"upright"].join("_")}constructor(){this.Lp=new vh.ky.AlphaSkiaCanvas,this.color=new Se(0,0,0,255)}destroy(){this.Lp[Symbol.dispose]();for(const t of this.Ty.values())t[Symbol.dispose]()}onRenderFinished(){return null}beginRender(t,e){this._y=this.settings.display.scale,this.Lp.beginRender(t,e,Nu.highDpiFactor);const s=this.settings.display.resources.smuflFontFamilyName;s&&s!==vh.Sy.familyNames[0]?this.Ty.has(s)?this.xy=this.Ty.get(s):(this.xy=new vh.ky.AlphaSkiaTextStyle([s],vh.Sy.weight,vh.Sy.isItalic),this.Ty.set(s,this.xy)):this.xy=vh.Sy}endRender(){return this.Lp.endRender()}get color(){return this.Rp}set color(t){this.Rp.rgba!==t.rgba&&(this.Rp=t,this.Lp.color=vh.ky.AlphaSkiaCanvas.rgbaToColor(t.r,t.g,t.b,t.a))}get lineWidth(){return this.Gp}set lineWidth(t){this.Gp=t,this.Lp.lineWidth=t}fillRect(t,e,s,i){s>0&&this.Lp.fillRect(t*this._y,e*this._y,s*this._y,i*this._y)}strokeRect(t,e,s,i){const n=this.lineWidth%2==0?0:.5;this.Lp.strokeRect(t*this._y+n,e*this._y+n,s*this._y,i*this._y)}beginPath(){this.Lp.beginPath()}closePath(){this.Lp.closePath()}moveTo(t,e){this.Lp.moveTo(t*this._y,e*this._y)}lineTo(t,e){this.Lp.lineTo(t*this._y,e*this._y)}quadraticCurveTo(t,e,s,i){this.Lp.quadraticCurveTo(t*this._y,e*this._y,s*this._y,i*this._y)}bezierCurveTo(t,e,s,i,n,r){this.Lp.bezierCurveTo(t*this._y,e*this._y,s*this._y,i*this._y,n*this._y,r*this._y)}fillCircle(t,e,s){this.Lp.fillCircle(t*this._y,e*this._y,s*this._y)}strokeCircle(t,e,s){this.Lp.strokeCircle(t*this._y,e*this._y,s*this._y)}fill(){this.Lp.fill()}stroke(){this.Lp.stroke()}textAlign=ht.Left;textBaseline=ot.Top;beginGroup(t){}endGroup(){}fillText(t,e,s){if(0===t.length)return;let i=vh.ky.AlphaSkiaTextAlign.Left;switch(this.textAlign){case ht.Left:i=vh.ky.AlphaSkiaTextAlign.Left;break;case ht.Center:i=vh.ky.AlphaSkiaTextAlign.Center;break;case ht.Right:i=vh.ky.AlphaSkiaTextAlign.Right}let n=vh.ky.AlphaSkiaTextBaseline.Top;switch(this.textBaseline){case ot.Top:n=vh.ky.AlphaSkiaTextBaseline.Top;break;case ot.Middle:n=vh.ky.AlphaSkiaTextBaseline.Middle;break;case ot.Bottom:n=vh.ky.AlphaSkiaTextBaseline.Bottom;break;case ot.Alphabetic:n=vh.ky.AlphaSkiaTextBaseline.Alphabetic}this.Lp.fillText(t,this.By,this.Ip.size*this._y,e*this._y,s*this._y,i,n)}measureText(t){const e={stack:[],error:void 0,hasError:!1};try{const s=function(t,e,s){if(null!=e){if("object"!=typeof e&&"function"!=typeof e)throw new TypeError("Object expected.");var i,n;if(s){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");i=e[Symbol.asyncDispose]}if(void 0===i){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");i=e[Symbol.dispose],s&&(n=i)}if("function"!=typeof i)throw new TypeError("Object not disposable.");n&&(i=function(){try{n.call(this)}catch(t){return Promise.reject(t)}}),t.stack.push({value:e,dispose:i,async:s})}else s&&t.stack.push({async:!0});return e}(e,this.Lp.measureText(t,this.By,this.Ip.size,vh.ky.AlphaSkiaTextAlign.Left,vh.ky.AlphaSkiaTextBaseline.Alphabetic),!1),[i,n]=this.vy(s,t);return new It(i,n)}catch(t){e.error=t,e.hasError=!0}finally{!function(t){function e(e){t.error=t.hasError?new Mh(e,t.error,"An error was suppressed during disposal."):e,t.hasError=!0}var s,i=0;(function n(){for(;s=t.stack.pop();)try{if(!s.async&&1===i)return i=0,t.stack.push(s),Promise.resolve().then(n);if(s.dispose){var r=s.dispose.call(s.value);if(s.async)return i|=2,Promise.resolve(r).then(n,function(t){return e(t),n()})}else i|=1}catch(t){e(t)}if(1===i)return t.hasError?Promise.reject(t.error):Promise.resolve();if(t.hasError)throw t.error})()}(e)}}vy(t,e){let s=t.width;if(e.length>0&&s<1)for(let e=0;e<5&&(s=t.width,!(s>1));e++);return[s,t.actualBoundingBoxAscent+t.actualBoundingBoxDescent]}fillMusicFontSymbol(t,e,s,i,n){i!==ut.None&&this.Vp(t,e,s,String.fromCharCode(i),n)}fillMusicFontSymbols(t,e,s,i,n){let r="";for(const t of i)t!==ut.None&&(r+=String.fromCharCode(t));this.Vp(t,e,s,r,n)}Vp(t,e,s,i,n){this.Lp.fillText(i,this.xy,this.settings.display.resources.engravingSettings.musicFontSize*this._y*s,t*this._y,e*this._y,n?vh.ky.AlphaSkiaTextAlign.Center:vh.ky.AlphaSkiaTextAlign.Left,vh.ky.AlphaSkiaTextBaseline.Alphabetic)}beginRotate(t,e,s){this.Lp.beginRotate(t*this._y,e*this._y,s)}endRotate(){this.Lp.endRotate()}}class Nh{buffer="";Ny="";Py=!0;scale=1;color=new Se(255,255,255,255);lineWidth=1;font=new Hr("Arial",10,as.Plain);textAlign=ht.Left;textBaseline=ot.Top;settings;destroy(){}beginRender(t,e){this.scale=this.settings.display.scale,this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${0|t}px" height="${0|e}px" class="at-surface-svg">\n`,this.Ny="",this.Py=!0,this.textBaseline=ot.Top}beginGroup(t){this.buffer+=`<g class="${t}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(t,e,s,i){s>0&&(this.buffer+=`<rect x="${t*this.scale}" y="${e*this.scale}" width="${s*this.scale}" height="${i*this.scale}" fill="${this.color.rgba}" />\n`)}strokeRect(t,e,s,i){const n=this.lineWidth*this.scale%2==0?0:.5;this.buffer+=`<rect x="${t*this.scale+n}" y="${e*this.scale+n}" width="${s*this.scale}" height="${i*this.scale}" stroke="${this.color.rgba}"`,1!==this.lineWidth&&(this.buffer+=` stroke-width="${this.lineWidth*this.scale}"`),this.buffer+=' fill="transparent" />\n'}beginPath(){}closePath(){this.Ny+=" z"}moveTo(t,e){this.Ny+=` M${t*this.scale},${e*this.scale}`}lineTo(t,e){this.Py=!1,this.Ny+=` L${t*this.scale},${e*this.scale}`}quadraticCurveTo(t,e,s,i){this.Py=!1,this.Ny+=` Q${t*this.scale},${e*this.scale},${s*this.scale},${i*this.scale}`}bezierCurveTo(t,e,s,i,n,r){this.Py=!1,this.Ny+=` C${t*this.scale},${e*this.scale},${s*this.scale},${i*this.scale},${n*this.scale},${r*this.scale}`}fillCircle(t,e,s){this.Py=!1,t*=this.scale,e*=this.scale,s*=this.scale,this.Ny+=` M${t-s},${e} A1,1 0 0,0 ${t+s},${e} A1,1 0 0,0 ${t-s},${e} z`,this.fill()}strokeCircle(t,e,s){this.Py=!1,t*=this.scale,e*=this.scale,s*=this.scale,this.Ny+=` M${t-s},${e} A1,1 0 0,0 ${t+s},${e} A1,1 0 0,0 ${t-s},${e} z`,this.stroke()}fill(){this.Py||(this.buffer+=`<path d="${this.Ny}"`,"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this.Ny="",this.Py=!0}stroke(){if(!this.Py){let t=`<path d="${this.Ny}" stroke="${this.color.rgba}"`;1===this.lineWidth&&1===this.scale||(t+=` stroke-width="${this.lineWidth*this.scale}"`),t+=' style="fill: none" />',this.buffer+=t}this.Ny="",this.Py=!0}fillText(t,e,s){if(""===t)return;let i=`<text x="${e*this.scale}" y="${s*this.scale}" style='stroke: none; font:${this.font.toCssString(this.settings.display.scale)}; ${this.getSvgBaseLine()}'`;"#000000"!==this.color.rgba&&(i+=` fill="${this.color.rgba}"`),this.textAlign!==ht.Left&&(i+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),i+=`>${Nh.Cy(t)}</text>`,this.buffer+=i}static Cy(t){return t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}getSvgTextAlignment(t){switch(t){case ht.Left:return"start";case ht.Center:return"middle";case ht.Right:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case ot.Top:return"dominant-baseline: hanging";case ot.Bottom:return"dominant-baseline: ideographic";case ot.Alphabetic:return"";case ot.Middle:return"dominant-baseline: middle";default:return""}}measureText(t){return t?la.measureString(t,this.font.families,this.font.size,this.font.style,this.font.weight):new It(0,0)}onRenderFinished(){return null}beginRotate(t,e,s){this.buffer+=`<g transform="translate(${t*this.scale} ,${e*this.scale}) rotate( ${s})">`}endRotate(){this.buffer+="</g>"}}class Ph extends Nh{fillMusicFontSymbol(t,e,s,i,n){i!==ut.None&&this.Vp(t,e,s,`&#${i};`,n)}fillMusicFontSymbols(t,e,s,i,n){let r="";for(const t of i)t!==ut.None&&(r+=`&#${t};`);this.Vp(t,e,s,r,n)}Vp(t,e,s,i,n){t*=this.scale,e*=this.scale,this.buffer+=`<g transform="translate(${t} ${e})" class="at" ><text`;const r=this.scale*s;this.buffer+=1!==r?` style="font-size: ${100*r}%; stroke:none"`:' style="stroke:none"',"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),n&&(this.buffer+=` text-anchor="${this.getSvgTextAlignment(ht.Center)}"`),this.buffer+=`>${i}</text></g>`}}!function(t){t[t.OwnedTop=0]="OwnedTop",t[t.OwnedBottom=1]="OwnedBottom",t[t.SharedTop=2]="SharedTop",t[t.SharedBottom=3]="SharedBottom"}(yh||(yh={}));class Ch{hideOnMultiTrack=!1;hideOnPercussionTrack=!1;effectBands;constructor(t){this.effectBands=t}canCreate(t,e){return!this.hideOnPercussionTrack||!e.isPercussion}}!function(t){t[t.SinglePreBeat=0]="SinglePreBeat",t[t.SingleOnBeat=1]="SingleOnBeat",t[t.SingleOnBeatToEnd=2]="SingleOnBeatToEnd",t[t.GroupedOnBeat=3]="GroupedOnBeat",t[t.GroupedOnBeatToEnd=4]="GroupedOnBeatToEnd",t[t.FullBar=5]="FullBar"}(kh||(kh={}));class Eh extends Ra{beat=null;nextGlyph=null;previousGlyph=null;constructor(t=0,e=0){super(t,e)}}class Fh extends Eh{Ey;Fy="";Ay;Dy;_n;constructor(t,e,s,i,n,r){super(t,e),this.Ey=Xt.getAlternateEndingsList(s),this.Ay=i,this.Dy=n,this._n=r}doLayout(){super.doLayout(),this.height=this.renderer.resources.elementFonts.get(t.NotationElement.EffectAlternateEndings).size+2*this.renderer.smuflMetrics.alternateEndingsPadding;let e="";for(let t=0,s=this.Ey.length;t<s;t++)e+=this.Ey[t]+1,e+=". ";this.Fy=e}paint(e,s,i){let n=this.Dy?this.width-i.lineWidth:this.width;if(this.renderer.bar.getActualBarLineRight()===F.LightHeavy&&(n-=this.renderer.smuflMetrics.thickBarlineThickness+this.renderer.smuflMetrics.barlineSeparation),e=(0|e)+i.lineWidth/2,s=(0|s)+i.lineWidth/2,this._n&&(e+=this.renderer.smuflMetrics.alternateEndingsPadding,n-=this.renderer.smuflMetrics.alternateEndingsPadding),this.Ay?(i.moveTo(e+this.x,s+this.y+this.height),i.lineTo(e+this.x,s+this.y)):i.moveTo(e+this.x,s+this.y),i.lineTo(e+this.x+n,s+this.y),this.Dy&&i.lineTo(e+this.x+n,s+this.y+this.height),i.stroke(),this.Ay){const n=i.textBaseline;i.textBaseline=ot.Top;const r=this.renderer.resources;i.font=r.elementFonts.get(t.NotationElement.EffectAlternateEndings),i.fillText(this.Fy,e+this.x+this.renderer.smuflMetrics.alternateEndingsPadding,s+this.y+this.renderer.smuflMetrics.alternateEndingsPadding),i.textBaseline=n}}}class Ah{get effectId(){return this.notationElement.toString()}finalizeBand(t){}onAlignGlyphs(t){}}class Dh extends Ah{get notationElement(){return t.NotationElement.EffectAlternateEndings}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return kh.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&0!==e.voice.bar.masterBar.alternateEndings}createNewGlyph(t,e){const s=e.voice.bar.masterBar,i=null===s.previousMasterBar||s.alternateEndings!==s.previousMasterBar.alternateEndings;let n=s.isRepeatEnd||null===s.nextMasterBar||s.alternateEndings!==s.nextMasterBar.alternateEndings;s.repeatGroup.closings.some(t=>t.index>=s.index)||(n=!1);const r=null!==s.previousMasterBar&&s.alternateEndings!==s.previousMasterBar.alternateEndings&&s.previousMasterBar.alternateEndings>0;return new Fh(0,0,s.alternateEndings,i,n,r)}canExpand(t,e){return!0}}class Lh extends Eh{endPosition;forceGroupedRendering=!1;endOnBarLine=!1;constructor(t){super(),this.endPosition=t}get isLinkedWithPrevious(){return!!this.previousGlyph&&this.previousGlyph.renderer.staff?.system===this.renderer.staff.system}get isLinkedWithNext(){return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&this.nextGlyph.renderer.staff?.system===this.renderer.staff.system}paint(t,e,s){if(this.isLinkedWithPrevious)return;if(!this.isLinkedWithNext&&!this.forceGroupedRendering)return void this.paintNonGrouped(t,e,s);let i;if(!this.isLinkedWithNext&&this.forceGroupedRendering)i=this;else for(i=this.nextGlyph;i.isLinkedWithNext;)i=i.nextGlyph;const n=i.renderer,r=i.beat,a=this.endPosition,h=t-this.renderer.x,o=this.calculateEndX(n,r,h,a);this.paintGrouped(t,e,o,s)}calculateEndX(t,e,s,i){return e?s+t.x+t.getBeatX(e,i):s+t.x+this.x+this.width}paintNonGrouped(t,e,s){const i=t-this.renderer.x,n=this.calculateEndX(this.renderer,this.beat,i,this.endPosition);this.paintGrouped(t,e,n,s)}}class Wh extends Lh{Ly;Wy;Ry=0;Iy;constructor(t,e,s=!0){super(ms.OnNotes),this.Ly=t,this.Wy=s,this.Iy=e}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=ms.EndBeat,this.forceGroupedRendering=!0),super.doLayout(),this.renderer.scoreRenderer.canvas.font=this.renderer.resources.elementFonts.get(this.Iy);const t=this.renderer.scoreRenderer.canvas.measureText(this.Ly);this.height=t.height,this.Ry=t.width}paintNonGrouped(t,e,s){const i=this.renderer.resources;s.font=i.elementFonts.get(this.Iy);const n=s.textBaseline;s.textBaseline=ot.Middle,s.fillText(this.Ly,t+this.x-this.Ry/2,e+this.y+this.height/2),s.textBaseline=n}paintGrouped(t,e,s,i){this.paintNonGrouped(t,e,i);const n=this.renderer.smuflMetrics.lineRangedGlyphDashGap,r=this.renderer.smuflMetrics.lineRangedGlyphDashSize,a=this.renderer.smuflMetrics.pedalLineThickness,h=t+this.x+this.Ry/2+n/2,o=e+this.y+this.height/2-a/2;if(this.Wy){if(s>h){let t=h;for(;t<s;){const e=Math.min(t+r,s);i.fillRect(t,o,e-t,a),t+=r+n}i.fillRect(s,o-r/2+a/2,a,r)}}else i.fillRect(h,o,s-h,a),i.fillRect(s-a,o,a,r/2)}}class Rh extends Ah{get notationElement(){return t.NotationElement.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.isBarre}get sizingMode(){return kh.GroupedOnBeat}createNewGlyph(e,s){let i="";switch(s.barreShape){case yt.None:case yt.Full:break;case yt.Half:i+="1/2"}return i+=`B ${Rh.toRoman(s.barreFret)}`,new Wh(i,t.NotationElement.EffectBeatBarre,!1)}static Oy=new Map([["L",50],["XL",40],["X",10],["IX",9],["V",5],["IV",4],["I",1]]);static toRoman(t){let e="";if(t>0)for(const[s,i]of Rh.Oy){const n=Math.floor(t/i);t-=n*i,e+=s.repeat(n)}return e}canExpand(t,e){return t.barreFret===e.barreFret&&t.barreShape===e.barreShape}}class Ih extends Eh{u;Gy="";Vy=0;$y=0;constructor(t){super(0,0),this.u=t}doLayout(){const e=this.u/6e4|0,s=(this.u-6e4*e)/1e3|0;this.Gy=`${e}:${s.toString().padStart(2,"0")}`;const i=this.renderer.scoreRenderer.canvas;i.font=this.renderer.resources.elementFonts.get(t.NotationElement.EffectBeatTimer);const n=i.measureText(this.Gy);this.$y=i.font.size+2*this.renderer.smuflMetrics.beatTimerPadding,this.Vy=n.width+2*this.renderer.smuflMetrics.beatTimerPadding,this.height=this.$y+2*this.renderer.smuflMetrics.beatTimerPadding}paint(e,s,i){const n=this.Vy/2|0;i.strokeRect(e+this.x-n,s+this.y+this.renderer.smuflMetrics.beatTimerPadding,this.Vy,this.$y);const r=i.font,a=i.textBaseline,h=i.textAlign;i.font=this.renderer.resources.elementFonts.get(t.NotationElement.EffectBeatTimer),i.textBaseline=ot.Middle,i.textAlign=ht.Center,i.fillText(this.Gy,e+this.x,s+this.y+this.height/2),i.font=r,i.textBaseline=a,i.textAlign=h}}class Oh extends Ah{get notationElement(){return t.NotationElement.EffectBeatTimer}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(t,e){return e.showTimer}createNewGlyph(t,e){return new Ih(e.timer??0)}canExpand(t,e){return!0}}class Gh extends Eh{Hy;Uy=null;font;textAlign;textBaseline;colorOverride;constructor(t,e,s,i,n=ht.Left,r=null,a){super(t,e),this.Hy=s.split("\n"),this.font=i,this.textAlign=n,this.textBaseline=r,this.colorOverride=a}doLayout(){super.doLayout(),this.Uy=[];const t=this.renderer.scoreRenderer.canvas;for(const e of this.Hy){t.font=this.font;const s=t.measureText(e),i=s.height;this.Uy.push(i),this.height+=i,this.width=Math.max(this.width,s.width)}}paint(t,e,s){const i=s.color;s.color=this.colorOverride??i,s.font=this.font;const n=s.textAlign,r=s.textBaseline;s.textAlign=this.textAlign,null!==this.textBaseline&&(s.textBaseline=this.textBaseline);let a=e+this.y;for(let e=0;e<this.Hy.length;e++)s.fillText(this.Hy[e],t+this.x,a),a+=this.Uy[e];s.textAlign=n,s.textBaseline=r,s.color=i}}class Vh extends Ah{get notationElement(){return t.NotationElement.EffectCapo}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(t,e){return 0===e.index&&0===e.voice.bar.index&&0!==e.voice.bar.staff.capo}createNewGlyph(e,s){return new Gh(0,0,`Capo. fret ${s.voice.bar.staff.capo}`,e.resources.elementFonts.get(t.NotationElement.EffectCapo),ht.Left)}canExpand(t,e){return!1}}class $h extends Eh{static zy=5;Xy;jy=0;Jy=0;qy=0;Yy;Iy;constructor(t,e,s,i,n=!1){super(t,e),this.Xy=s,this.Yy=n,this.Iy=i}doLayout(){super.doLayout();const e=this.renderer.resources.elementFonts.get(this.Iy);if(this.jy=1.5*e.size,this.Jy=1.5*e.size,this.height=this.jy,this.width=2*this.renderer.smuflMetrics.chordDiagramPaddingX,this.renderer.settings.notation.isNotationElementVisible(t.NotationElement.ChordDiagramFretboardNumbers))this.Xy.firstFret>1?this.qy=this.renderer.smuflMetrics.chordDiagramFretSpacing:this.qy=0,this.height+=this.Jy+$h.zy*this.renderer.smuflMetrics.chordDiagramFretSpacing+2*this.renderer.smuflMetrics.chordDiagramPaddingY,this.width+=this.qy+(this.Xy.strings.length-1)*this.renderer.smuflMetrics.chordDiagramStringSpacing;else if(this.Xy.showName){const t=this.renderer.scoreRenderer.canvas;t.font=e,this.width+=t.measureText(this.Xy.name).width}}paint(e,s,i){e+=this.x+this.renderer.smuflMetrics.chordDiagramPaddingX+this.qy,s+=this.y,this.Yy&&(e-=this.width/2);const n=this.renderer.resources,r=n.engravingSettings.chordDiagramLineWidth,a=this.width-2*this.renderer.smuflMetrics.chordDiagramPaddingX-this.qy+r,h=i.textAlign,o=i.textBaseline,c=n.elementFonts.get(this.Iy);i.font=c,i.textAlign=ht.Center,i.textBaseline=ot.Top,this.Xy.showName&&i.fillText(this.Xy.name,e+a/2,s+c.size/2),this.renderer.settings.notation.isNotationElementVisible(t.NotationElement.ChordDiagramFretboardNumbers)&&this.Ky(e,s,i,a),i.textAlign=h,i.textBaseline=o}Ky(e,s,i,n){s+=this.jy;const r=this.renderer.resources,a=this.renderer.smuflMetrics.chordDiagramStringSpacing,h=this.renderer.smuflMetrics.chordDiagramFretSpacing,o=r.engravingSettings.glyphHeights.get(ut.FretboardFilledCircle),c=r.engravingSettings.glyphTop.get(ut.FretboardFilledCircle),l=r.engravingSettings.glyphHeights.get(ut.FretboardX)/2,u=r.engravingSettings.glyphHeights.get(ut.FretboardO)/2,d=r.engravingSettings.chordDiagramLineWidth;i.font=r.elementFonts.get(t.NotationElement.ChordDiagramFretboardNumbers),i.textBaseline=ot.Middle;for(let t=0;t<this.Xy.strings.length;t++){const n=e+t*a,r=s+this.Jy/2;let h=this.Xy.strings[this.Xy.strings.length-t-1];h<0?Ot.fillMusicFontSymbolSafe(i,n,r+l,1,ut.FretboardX,!0):0===h?Ot.fillMusicFontSymbolSafe(i,n,r+u,1,ut.FretboardO,!0):(h-=this.Xy.firstFret-1,i.fillText(h.toString(),n,r))}s+=this.Jy;for(let t=0;t<this.Xy.strings.length;t++){const n=e+t*a;i.fillRect(n,s,d,h*$h.zy+1)}this.Xy.firstFret>1?(i.textAlign=ht.Left,i.fillText(this.Xy.firstFret.toString(),e-this.qy,s+h/2),i.fillRect(e,s,n,d)):i.fillRect(e,s-this.renderer.smuflMetrics.chordDiagramNutHeight/2,n,this.renderer.smuflMetrics.chordDiagramNutHeight);for(let t=0;t<=$h.zy;t++){const r=s+t*h;i.fillRect(e,r,n,this.renderer.smuflMetrics.chordDiagramFretHeight)}const f=new Map;for(const t of this.Xy.barreFrets){const e=[-1,-1];f.set(t-this.Xy.firstFret,e)}for(let t=0;t<this.Xy.strings.length;t++){let n=this.Xy.strings[t];if(n>0){if(n-=this.Xy.firstFret,f.has(n)){const e=f.get(n);(-1===e[0]||t<e[0])&&(e[0]=t),(-1===e[1]||t>e[1])&&(e[1]=t)}const r=s+n*h+h/2+.5,l=e+(this.Xy.strings.length-t-1)*a+d/2;Ot.fillMusicFontSymbolSafe(i,l,r+c-o/2,1,ut.FretboardFilledCircle,!0)}}for(const[t,n]of f){const r=s+t*h+h/2+.5,c=e+(this.Xy.strings.length-n[1]-1)*a,l=e+(this.Xy.strings.length-n[0]-1)*a;i.fillRect(c,r-o/2,l-c,o)}}}class Hh extends Ah{get notationElement(){return t.NotationElement.EffectChordNames}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(t,e){return e.hasChord}createNewGlyph(e,s){return s.voice.bar.staff.track.score.stylesheet.globalDisplayChordDiagramsInScore?new $h(0,0,s.chord,t.NotationElement.EffectChordNames,!0):new Gh(0,0,s.chord.name,e.resources.elementFonts.get(t.NotationElement.EffectChordNames),ht.Center)}canExpand(t,e){return!1}}class Uh extends Lh{Dn;constructor(t,e,s){super(ms.EndBeat),this.Dn=c.None,this.Dn=s,this.x=t,this.y=e}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(ut.DynamicCrescendoHairpin)}paintGrouped(t,e,s,i){const n=t+this.x,r=this.height,a=this.renderer.smuflMetrics.glyphWidths.get(ut.NoteheadBlack)/2;i.beginPath(),this.Dn===c.Crescendo?(s-=a,i.moveTo(s,e+this.y),i.lineTo(n,e+this.y+r/2),i.lineTo(s,e+this.y+r)):(s-=a,i.moveTo(n,e+this.y),i.lineTo(s,e+this.y+r/2),i.lineTo(n,e+this.y+r));const h=i.lineWidth;i.lineWidth=this.renderer.smuflMetrics.hairpinThickness,i.stroke(),i.lineWidth=h}}class zh extends Ah{get notationElement(){return t.NotationElement.EffectCrescendo}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return kh.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.crescendo!==c.None}createNewGlyph(t,e){return new Uh(0,0,e.crescendo)}canExpand(t,e){return t.crescendo===e.crescendo}}class Xh extends Ra{Qy;_y=1;constructor(t){super(0,0),this.Qy=t}doLayout(){this.height=0;const t=this.renderer.smuflMetrics.directionsScale;this._y=t;for(const e of this.Qy){const s=this.renderer.smuflMetrics.glyphHeights.get(e)*t;s>this.height&&(this.height=s)}}paint(t,e,s){s.fillMusicFontSymbols(t+this.x,e+this.y+this.height,this._y,this.Qy,!0)}}class jh extends Ra{Gy;constructor(t){super(0,0),this.Gy=t}doLayout(){const e=this.renderer.scoreRenderer.canvas;e.font=this.renderer.resources.elementFonts.get(t.NotationElement.EffectDirections),this.height=e.measureText(this.Gy).height}paint(e,s,i){const n=i.font,r=i.textBaseline,a=i.textAlign;i.font=this.renderer.resources.elementFonts.get(t.NotationElement.EffectDirections),i.textBaseline=ot.Middle,i.textAlign=ht.Right,i.fillText(this.Gy,e+this.x,s+this.y+this.height/2),i.font=n,i.textBaseline=r,i.textAlign=a}}class Jh extends Eh{Zy;tk=[];ek=[];constructor(t,e,s){super(t,e),this.Zy=s}doLayout(){const t=this.Zy;t.has(Xe.TargetSegnoSegno)&&this.tk.push(new Xh([ut.Segno,ut.Segno])),t.has(Xe.TargetSegno)&&this.tk.push(new Xh([ut.Segno])),t.has(Xe.TargetDoubleCoda)&&this.tk.push(new Xh([ut.Coda,ut.Coda])),t.has(Xe.TargetCoda)&&this.tk.push(new Xh([ut.Coda])),t.has(Xe.TargetFine)&&this.ek.push(new jh("Fine")),t.has(Xe.JumpDaDoubleCoda)&&this.ek.push(new jh("To Double Coda")),t.has(Xe.JumpDaCoda)&&this.ek.push(new jh("To Coda")),t.has(Xe.JumpDalSegnoSegno)&&this.ek.push(new jh("D.S.S.")),t.has(Xe.JumpDalSegnoSegnoAlCoda)&&this.ek.push(new jh("D.S.S. al Coda")),t.has(Xe.JumpDalSegnoSegnoAlDoubleCoda)&&this.ek.push(new jh("D.S.S. al Double Coda")),t.has(Xe.JumpDalSegnoSegnoAlFine)&&this.ek.push(new jh("D.S.S. al Fine")),t.has(Xe.JumpDalSegno)&&this.ek.push(new jh("D.S.")),t.has(Xe.JumpDalSegnoAlCoda)&&this.ek.push(new jh("D.S. al Coda")),t.has(Xe.JumpDalSegnoAlDoubleCoda)&&this.ek.push(new jh("D.S. al Double Coda")),t.has(Xe.JumpDalSegnoAlFine)&&this.ek.push(new jh("D.S. al Fine")),t.has(Xe.JumpDaCapo)&&this.ek.push(new jh("D.C.")),t.has(Xe.JumpDaCapoAlCoda)&&this.ek.push(new jh("D.C. al Coda")),t.has(Xe.JumpDaCapoAlDoubleCoda)&&this.ek.push(new jh("D.C. al Double Coda")),t.has(Xe.JumpDaCapoAlFine)&&this.ek.push(new jh("D.C. al Fine"));const e=this.sk(this.tk),s=this.sk(this.ek);this.height=Math.max(e,s)}sk(t){let e=0;const s=this.renderer.settings.display.effectBandPaddingBottom;for(const i of t)i.y=e,i.renderer=this.renderer,i.doLayout(),e+=i.height+s;return e}paint(t,e,s){for(const i of this.tk)i.paint(t+this.x,e+this.y,s);for(const i of this.ek)i.paint(t+this.x+this.width,e+this.y,s)}}class qh extends Ah{get notationElement(){return t.NotationElement.EffectDirections}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return kh.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&null!==e.voice.bar.masterBar.directions&&e.voice.bar.masterBar.directions.size>0}createNewGlyph(t,e){return new Jh(0,0,e.voice.bar.masterBar.directions)}canExpand(t,e){return!0}}class Yh extends Eh{glyphScale=0;symbol;center=!1;colorOverride;offsetX=0;offsetY=0;constructor(t,e,s,i){super(t,e),this.glyphScale=s,this.symbol=i}getBoundingBoxTop(){const t=this.renderer.smuflMetrics.glyphTop.get(this.symbol);return this.y-this.offsetY-t}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(this.symbol)*this.glyphScale,this.height=this.renderer.smuflMetrics.glyphHeights.get(this.symbol)*this.glyphScale}paint(t,e,s){if(0===this.width&&0===this.height)return;const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbol(t+this.x+this.offsetX,e+this.y+this.offsetY,this.glyphScale,this.symbol,this.center),s.color=i}}class Kh extends Eh{glyphScale=0;symbols;center=!1;colorOverride;offsetX=0;offsetY=0;constructor(t,e,s,i){super(t,e),this.glyphScale=s,this.symbols=i}getBoundingBoxTop(){let t=0;for(let e=0;e<this.symbols.length;e++){const s=this.renderer.smuflMetrics.glyphTop.get(this.symbols[e]);(0===e||s<t)&&(t=s)}return this.y-this.offsetY-t}doLayout(){this.width=0,this.height=0;for(let t=0;t<this.symbols.length;t++){const e=this.renderer.smuflMetrics.glyphWidths.get(this.symbols[t])*this.glyphScale,s=this.renderer.smuflMetrics.glyphHeights.get(this.symbols[t])*this.glyphScale;(0===t||e>this.width)&&(this.width=e),(0===t||s>this.height)&&(this.height=s)}}paint(t,e,s){if(0===this.width&&0===this.height)return;const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbols(t+this.x+this.offsetX,e+this.y+this.offsetY,this.glyphScale,this.symbols,this.center),s.color=i}}class Qh extends Yh{constructor(t,e,s){super(t,e,1,Qh.ik(s))}doLayout(){super.doLayout(),this.center=!0,this.height=this.renderer.smuflMetrics.glyphHeights.get(ut.DynamicForte);const t=this.renderer.smuflMetrics.glyphTop.get(ut.DynamicForte);this.offsetY=t}static ik(t){switch(t){case n.PPP:return ut.DynamicPPP;case n.PP:return ut.DynamicPP;case n.P:return ut.DynamicPiano;case n.MP:return ut.DynamicMP;case n.MF:return ut.DynamicMF;case n.F:return ut.DynamicForte;case n.FF:return ut.DynamicFF;case n.FFF:return ut.DynamicFFF;case n.PPPP:return ut.DynamicPPPP;case n.PPPPP:case n.PPPPPP:return ut.DynamicPPPPP;case n.FFFF:return ut.DynamicFFFF;case n.FFFFF:return ut.DynamicFFFFF;case n.FFFFFF:return ut.DynamicFFFFFF;case n.SF:return ut.DynamicSforzando1;case n.SFP:return ut.DynamicSforzandoPiano;case n.SFPP:return ut.DynamicSforzandoPianissimo;case n.FP:return ut.DynamicFortePiano;case n.RF:return ut.DynamicRinforzando1;case n.RFZ:return ut.DynamicRinforzando2;case n.SFZ:return ut.DynamicSforzato;case n.SFFZ:return ut.DynamicSforzatoFF;case n.FZ:return ut.DynamicForzando;case n.N:return ut.DynamicNiente;case n.PF:return ut.DynamicPF;case n.SFZP:return ut.DynamicSforzatoPiano;default:return ut.None}}}class Zh extends Ah{get notationElement(){return t.NotationElement.EffectDynamics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(t,e){return this.nk(e)}nk(t){if(t.voice.bar.staff.track.score.stylesheet.hideDynamics||t.isEmpty||t.voice.isEmpty||t.isRest)return!1;const e=this.rk(t);let s=0===t.voice.index&&!e||t.dynamics!==e?.dynamics;if(s&&t.voice.index>0)for(const e of t.voice.bar.voices)if(e.index<t.voice.index){const i=e.getBeatAtPlaybackStart(t.playbackStart);i&&t.dynamics===i.dynamics&&this.nk(i)&&(s=!1)}return s}rk(t){let e=t.previousBeat;for(;null!=e;){if(!e.isRest)return e;e=e.previousBeat}return null}createNewGlyph(t,e){return new Qh(0,0,e.dynamics)}canExpand(t,e){return!0}}class to extends Yh{constructor(t){super(0,0,1,to.ik(t)),this.center=!0}static ik(t){switch(t){case gt.FadeIn:return ut.GuitarFadeIn;case gt.FadeOut:return ut.GuitarFadeOut;case gt.VolumeSwell:return ut.GuitarVolumeSwell}return ut.None}paint(t,e,s){super.paint(t,e+this.height,s)}}class eo extends Ah{get notationElement(){return t.NotationElement.EffectFadeIn}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(t,e){return e.fade!==gt.None}createNewGlyph(t,e){return new to(e.fade)}canExpand(t,e){return!0}}class so extends Yh{constructor(t,e,s){super(t,e,1,so.ik(s))}static ik(t){switch(t){case Dt.Short:return ut.FermataShortAbove;case Dt.Medium:return ut.FermataAbove;case Dt.Long:return ut.FermataLongAbove;default:return ut.None}}paint(t,e,s){super.paint(t-this.width/2,e+this.height,s)}}class io extends Ah{get notationElement(){return t.NotationElement.EffectFermata}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(t,e){return 0===e.voice.index&&!!e.fermata}createNewGlyph(t,e){return new so(0,0,e.fermata.type)}canExpand(t,e){return!0}}class no extends Ra{glyphs=null;get isEmpty(){return!this.glyphs||0===this.glyphs.length}getBoundingBoxTop(){let t=Number.NaN;const e=this.glyphs;if(e)for(const s of e)t=Xt.minBoundingBox(t,s.getBoundingBoxTop());return t}getBoundingBoxBottom(){let t=Number.NaN;const e=this.glyphs;if(e)for(const s of e)t=Xt.maxBoundingBox(t,s.getBoundingBoxBottom());return t}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);let t=0,e=0;for(let s=0,i=this.glyphs.length;s<i;s++){const i=this.glyphs[s];i.renderer=this.renderer,i.doLayout(),t=Math.max(t,i.width),e=Math.max(e,i.y+i.height)}this.width=t,this.height=e}addGlyph(t){this.glyphs||(this.glyphs=[]),this.renderer&&(t.renderer=this.renderer),this.glyphs.push(t)}paint(t,e,s){const i=this.glyphs;if(i&&0!==i.length)for(const n of i)n.paint(t+this.x,e+this.y,s)}}class ro{static score(t,e,s,i=!1){if(!s.style&&!i)return;const n=ro.ak(t.settings.display.resources,e);return new ao(t,e,s.style,n)}static scoreColor(t,e,s){const i=ro.ak(t,e);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static ak(t,e){return t.mainGlyphColor}static bar(t,e,s,i=!1){if(!s.style&&!i)return;let n=t.settings.display.resources.mainGlyphColor;switch(e){case E.StandardNotationRepeats:case E.GuitarTabsRepeats:case E.SlashRepeats:case E.NumberedRepeats:case E.StandardNotationClef:case E.GuitarTabsClef:case E.StandardNotationKeySignature:case E.NumberedKeySignature:case E.StandardNotationTimeSignature:case E.GuitarTabsTimeSignature:case E.SlashTimeSignature:case E.NumberedTimeSignature:break;case E.StandardNotationBarLines:case E.GuitarTabsBarLines:case E.SlashBarLines:case E.NumberedBarLines:n=t.settings.display.resources.barSeparatorColor;break;case E.StandardNotationBarNumber:case E.SlashBarNumber:case E.NumberedBarNumber:case E.GuitarTabsBarNumber:n=t.settings.display.resources.barNumberColor;break;case E.StandardNotationStaffLine:case E.GuitarTabsStaffLine:case E.SlashStaffLine:case E.NumberedStaffLine:n=t.settings.display.resources.staffLineColor}return new ao(t,e,s.style,n)}static voice(t,e,s,i=!1){if(!s.style&&!i)return;const n=0===s.index?t.settings.display.resources.mainGlyphColor:t.settings.display.resources.secondaryGlyphColor;return new ao(t,e,s.style,n)}static trackColor(t,e,s){const i=ro.hk(t,e);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static hk(t,e){let s=t.mainGlyphColor;switch(e){case Wt.TrackName:case Wt.SystemSeparator:case Wt.StringTuning:break;case Wt.BracesAndBrackets:s=t.barSeparatorColor}return s}static track(t,e,s,i=!1){if(!s.style&&!i)return;const n=ro.hk(t.settings.display.resources,e);return new ao(t,e,s.style,n)}static beatColor(t,e,s){const i=ro.ck(t,e,s);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static ck(t,e,s){return 0===s.voice.index?t.mainGlyphColor:t.secondaryGlyphColor}static beat(t,e,s,i=!1){if(!s.style&&!i)return;const n=ro.ck(t.settings.display.resources,e,s);return new ao(t,e,s.style,n)}static noteColor(t,e,s){const i=ro.lk(t,e,s);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static lk(t,e,s){return 0===s.beat.voice.index?t.mainGlyphColor:t.secondaryGlyphColor}static note(t,e,s,i=!1){if(!s.style&&!i)return;const n=0===s.beat.voice.index?t.settings.display.resources.mainGlyphColor:t.settings.display.resources.secondaryGlyphColor;return new ao(t,e,s.style,n)}}class ao{Lp;uk;constructor(t,e,s,i){this.Lp=t,s&&s.colors.has(e)?(this.uk=t.color,t.color=s.colors.get(e)??i):s||(this.uk=t.color,t.color=i)}[Symbol.dispose](){this.uk&&(this.Lp.color=this.uk)}}class ho{line=0;symbols;color;constructor(t,e){this.line=t,this.symbols=e}}class oo extends no{dk=new Map;constructor(){super(0,0)}get isEmpty(){return 0===this.dk.size}addFingers(e){const s=this.renderer.settings;if(s.notation.fingeringMode!==t.FingeringMode.ScoreDefault&&s.notation.fingeringMode!==t.FingeringMode.ScoreForcePiano)return;const i=oo.fingerToMusicFontSymbol(this.renderer.settings,e.beat,e.leftHandFinger,!0);i!==ut.None&&this.fk(e,i);const n=oo.fingerToMusicFontSymbol(this.renderer.settings,e.beat,e.rightHandFinger,!1);n!==ut.None&&this.fk(e,n)}static fingerToMusicFontSymbol(e,s,i,n){if(e.notation.fingeringMode===t.FingeringMode.ScoreForcePiano||e.notation.fingeringMode===t.FingeringMode.SingleNoteEffectBandForcePiano||we.isPiano(s.voice.bar.staff.track.playbackInfo.program))switch(i){case f.Unknown:case f.NoOrDead:return ut.None;case f.Thumb:return ut.Fingering1;case f.IndexFinger:return ut.Fingering2;case f.MiddleFinger:return ut.Fingering3;case f.AnnularFinger:return ut.Fingering4;case f.LittleFinger:return ut.Fingering5;default:return ut.None}if(n)switch(i){case f.Unknown:return ut.None;case f.NoOrDead:return ut.Fingering0;case f.Thumb:return ut.FingeringTLower;case f.IndexFinger:return ut.Fingering1;case f.MiddleFinger:return ut.Fingering2;case f.AnnularFinger:return ut.Fingering3;case f.LittleFinger:return ut.Fingering4;default:return ut.None}switch(i){case f.Unknown:case f.NoOrDead:return ut.None;case f.Thumb:return ut.FingeringPLower;case f.IndexFinger:return ut.FingeringILower;case f.MiddleFinger:return ut.FingeringMLower;case f.AnnularFinger:return ut.FingeringALower;case f.LittleFinger:return ut.FingeringCLower;default:return ut.None}}fk(t,e){const s=this.renderer,i=s.getNoteSteps(t);if(this.dk.has(i)){this.dk.get(i).symbols.push(e)}else{const n=new ho(i,[e]);n.color=ro.noteColor(s.resources,pt.StandardNotationEffects,t),this.dk.set(i,n)}}doLayout(){const t=this.renderer;for(const[e,s]of this.dk){const e=new Kh(0,0,1,s.symbols);e.colorOverride=s.color,e.renderer=t,e.y=t.getScoreY(s.line),e.doLayout(),e.offsetY=e.height/2,this.addGlyph(e),this.width=Math.max(this.width,e.width)}for(const t of this.glyphs){const e=t;e.x=this.width/2,e.center=!0}}}class co extends Ah{get notationElement(){return t.NotationElement.EffectFingering}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(e,s){return!(0!==s.voice.index||s.isRest||e.notation.fingeringMode!==t.FingeringMode.SingleNoteEffectBand&&e.notation.fingeringMode!==t.FingeringMode.SingleNoteEffectBandForcePiano)&&(1===s.notes.length&&s.notes[0].isFingering)}createNewGlyph(t,e){let s=f.Unknown,i=!1;const n=e.notes[0];n.leftHandFinger!==f.Unknown?(s=n.leftHandFinger,i=!0):n.rightHandFinger!==f.Unknown&&(s=n.rightHandFinger);const r=oo.fingerToMusicFontSymbol(t.settings,e,s,i),a=new Yh(0,0,1,r);return a.center=!0,a.renderer=t,a.doLayout(),a.offsetY=t.smuflMetrics.glyphTop.get(a.symbol),a}canExpand(t,e){return!0}}class lo extends Ah{get notationElement(){return t.NotationElement.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return kh.SinglePreBeat}shouldCreateGlyph(t,e){const s=e.voice.bar.masterBar;return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&s.isFreeTime&&(0===s.index||s.isFreeTime!==s.previousMasterBar.isFreeTime)}createNewGlyph(e,s){return new Gh(0,0,"Free time",e.resources.elementFonts.get(t.NotationElement.EffectFreeTime),ht.Left)}canExpand(t,e){return!0}}class uo extends Yh{constructor(t,e,s=!1){super(t,e,Or.GraceScale,ut.GuitarGolpe),this.center=s}doLayout(){super.doLayout(),this.offsetY=this.height}}class fo extends Ah{pk;constructor(t){super(),this.pk=t}get notationElement(){return t.NotationElement.EffectGolpe}get effectId(){return`${super.effectId}.${mt[this.pk]}`}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(t,e){return e.golpe===this.pk}createNewGlyph(t,e){return new uo(0,0,!0)}canExpand(t,e){return!1}}class po extends Ah{lastCreateInfo=null;shouldCreateGlyph(t,e){this.lastCreateInfo=[];for(let t=0,s=e.notes.length;t<s;t++){const s=e.notes[t];this.shouldCreateGlyphForNote(s)&&this.lastCreateInfo.push(s)}return this.lastCreateInfo.length>0}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(t,e){return!0}}class bo extends po{bk;Ne=null;mk;get effectId(){return this.mk}get notationElement(){return t.NotationElement.EffectHarmonics}constructor(t){switch(super(),this.bk=t,t){case p.None:this.mk="harmonics-none";break;case p.Natural:this.mk="harmonics-natural";break;case p.Artificial:this.mk="harmonics-artificial";break;case p.Pinch:this.mk="harmonics-pinch";break;case p.Tap:this.mk="harmonics-tap";break;case p.Semi:this.mk="harmonics-semi";break;case p.Feedback:this.mk="harmonics-feedback";break;default:this.mk=""}}shouldCreateGlyphForNote(t){return!(!t.isHarmonic||t.harmonicType!==this.bk)&&(t.beat!==this.Ne&&(this.Ne=t.beat),!0)}get sizingMode(){return kh.GroupedOnBeat}createNewGlyph(e,s){return new Wh(bo.harmonicToString(this.bk),t.NotationElement.EffectHarmonics)}static harmonicToString(t){switch(t){case p.Natural:return"N.H.";case p.Artificial:return"A.H.";case p.Pinch:return"P.H.";case p.Tap:return"T.H.";case p.Semi:return"S.H.";case p.Feedback:return"Fdbk."}return""}}class mo extends Yh{constructor(){super(0,0,1,ut.GuitarLeftHandTapping),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(this.symbol)}}class go extends po{get notationElement(){return t.NotationElement.EffectTap}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyphForNote(t){return t.isLeftHandTapped}createNewGlyph(t,e){return new mo}}class wo extends Ah{get notationElement(){return t.NotationElement.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.isLetRing}get sizingMode(){return kh.GroupedOnBeat}createNewGlyph(e,s){return new Wh("LetRing",t.NotationElement.EffectLetRing)}canExpand(t,e){return!0}}class yo extends Eh{Hy;gk=[];font;textAlign;constructor(t,e,s,i,n=ht.Center){super(t,e),this.Hy=s,this.font=i,this.textAlign=n}doLayout(){super.doLayout();const t=this.renderer.settings.display.lyricLinesPaddingBetween,e=this.renderer.scoreRenderer.canvas;e.font=this.font;let s=0;for(const i of this.Hy){this.gk.push(s);s+=e.measureText(i.length>0?i:" ").height+t}s-=t,this.height=s}paint(t,e,s){s.font=this.font;const i=s.textAlign;s.textAlign=this.textAlign;for(let i=0;i<this.Hy.length;i++)this.Hy[i]&&s.fillText(this.Hy[i],t+this.x,e+this.y+this.gk[i]);s.textAlign=i}}class ko extends Ah{get notationElement(){return t.NotationElement.EffectLyrics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(t,e){return!!e.lyrics}createNewGlyph(e,s){return new yo(0,0,s.lyrics,e.resources.elementFonts.get(t.NotationElement.EffectLyrics),ht.Center)}canExpand(t,e){return!0}}class So extends Ah{get notationElement(){return t.NotationElement.EffectMarker}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return kh.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&e.voice.bar.masterBar.isSectionStart}createNewGlyph(e,s){return new Gh(0,0,s.voice.bar.masterBar.section.marker?`[${s.voice.bar.masterBar.section.marker}] ${s.voice.bar.masterBar.section.text}`:s.voice.bar.masterBar.section.text,e.resources.elementFonts.get(t.NotationElement.EffectMarker),ht.Left)}canExpand(t,e){return!0}}class Bo extends Yh{constructor(t){super(0,0,1,Bo.ik(t)),this.center=!0}static ik(t){switch(t){case ft.InvertedTurn:return ut.OrnamentTurnInverted;case ft.Turn:return ut.OrnamentTurn;case ft.UpperMordent:return ut.OrnamentShortTrill;case ft.LowerMordent:return ut.OrnamentMordent}return ut.None}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(ut.OrnamentMordent),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(ut.OrnamentMordent)}}class _o extends Ah{get notationElement(){return t.NotationElement.EffectNoteOrnament}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(t,e){return e.notes.some(t=>t.ornament!==ft.None)}createNewGlyph(t,e){return new Bo(e.notes.find(t=>t.ornament!==ft.None).ornament)}canExpand(t,e){return!1}}class To extends Yh{constructor(t,e,s,i){super(t,e,i,To.getMusicSymbol(s))}static getMusicSymbol(t){switch(t){case x.Natural:return ut.AccidentalNatural;case x.Sharp:return ut.AccidentalSharp;case x.Flat:return ut.AccidentalFlat;case x.NaturalQuarterNoteUp:return ut.AccidentalQuarterToneSharpNaturalArrowUp;case x.SharpQuarterNoteUp:return ut.AccidentalThreeQuarterTonesSharpArrowUp;case x.FlatQuarterNoteUp:return ut.AccidentalQuarterToneFlatArrowUp;case x.DoubleSharp:return ut.AccidentalDoubleSharp;case x.DoubleFlat:return ut.AccidentalDoubleFlat}return ut.None}}class xo extends Eh{wk;yk;Gy="";kk=x.None;Sk=0;Bk=0;constructor(t,e,s,i){super(t,e),this.wk=s,this.yk=i}doLayout(){super.doLayout();const t="1 = ";let e="",s=x.None;switch(this.yk){case P.Major:switch(this.wk){case N.Cb:e="  C",s=x.Flat;break;case N.Gb:e="  G",s=x.Flat;break;case N.Db:e="  D",s=x.Flat;break;case N.Ab:e="  A",s=x.Flat;break;case N.Eb:e="  E",s=x.Flat;break;case N.Bb:e="  B",s=x.Flat;break;case N.F:e="F";break;case N.C:e="C",s=x.None;break;case N.G:e="G",s=x.None;break;case N.D:e="D",s=x.None;break;case N.A:e="A",s=x.None;break;case N.E:e="E",s=x.None;break;case N.B:e="B",s=x.None;break;case N.FSharp:e="  F",s=x.Sharp;break;case N.CSharp:e="  C",s=x.Sharp}break;case P.Minor:switch(this.wk){case N.Cb:e="  a",s=x.Flat;break;case N.Gb:e="  e",s=x.Flat;break;case N.Db:e="  b",s=x.Flat;break;case N.Ab:e="f",s=x.None;break;case N.Eb:e="c",s=x.None;break;case N.Bb:e="g",s=x.None;break;case N.F:e="d";break;case N.C:e="a",s=x.None;break;case N.G:e="e",s=x.None;break;case N.D:e="b",s=x.None;break;case N.A:e="  f",s=x.Sharp;break;case N.E:e="  c",s=x.Sharp;break;case N.B:e="  g",s=x.Sharp;break;case N.FSharp:e="  d",s=x.Sharp;break;case N.CSharp:e="  a",s=x.Sharp}}this.Gy=t+e,this.kk=s;const i=this.renderer.scoreRenderer.canvas,n=this.renderer.settings,r=n.display.resources;i.font=r.numberedNotationFont,this.Sk=i.measureText(t).width;const a=i.measureText(t+e);this.Bk=0===this.renderer.index?n.display.firstStaffPaddingLeft:n.display.staffPaddingLeft,this.width=this.Bk+a.width,this.height=a.height}paint(t,e,s){const i=ro.bar(s,E.NumberedKeySignature,this.renderer.bar);try{const i=this.renderer.resources;s.font=i.numberedNotationFont,s.textBaseline=ot.Alphabetic,s.fillText(this.Gy,t+this.x+this.Bk,e+this.y+this.height),this.kk!==x.None&&Ot.fillMusicFontSymbolSafe(s,t+this.x+this.Bk+this.Sk,e+this.y+this.height,1,To.getMusicSymbol(this.kk),!1)}finally{i?.[Symbol.dispose]?.()}}}class Mo extends Ah{get notationElement(){return t.NotationElement.EffectNumberedNotationKeySignature}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return kh.FullBar}shouldCreateGlyph(t,e){const s=e.voice.bar;return 0===e.index&&0===e.voice.index&&(!s.previousBar||s.keySignature!==s.previousBar.keySignature)}createNewGlyph(t,e){return new xo(0,0,t.bar.keySignature,t.bar.keySignatureType)}canExpand(t,e){return!1}}class vo extends Lh{_k;Tk;constructor(t,e){super(ms.PostNotes),this._k=t,this.Tk=e}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(ut.QuindicesimaAlta)}paintNonGrouped(t,e,s){this.xk(t,e,s)}xk(t,e,s){let i=0;switch(this._k){case m.S:i=this.renderer.smuflMetrics.glyphWidths.get(ut.QuindicesimaAlta),Ot.fillMusicFontSymbolSafe(s,t+this.x-i/2,e+this.y+this.height,1,ut.QuindicesimaAlta,!1);break;case m._:i=this.renderer.smuflMetrics.glyphWidths.get(ut.OttavaAlta),Ot.fillMusicFontSymbolSafe(s,t+this.x-i/2,e+this.y+this.height,1,ut.OttavaAlta,!1);break;case m.T:i=this.renderer.smuflMetrics.glyphWidths.get(ut.OttavaBassaVb),Ot.fillMusicFontSymbolSafe(s,t+this.x-i/2,e+this.y+this.height,1,ut.OttavaBassaVb,!1);break;case m.M:i=1*(this.renderer.smuflMetrics.glyphWidths.get(ut.Quindicesima)+this.renderer.smuflMetrics.glyphWidths.get(ut.OctaveBaselineM)+this.renderer.smuflMetrics.glyphWidths.get(ut.OctaveBaselineB)),Ot.fillMusicFontSymbolsSafe(s,t+this.x-i/2,e+this.y+this.height,1,[ut.Quindicesima,ut.OctaveBaselineM,ut.OctaveBaselineB],!1)}return i/2}paintGrouped(t,e,s,i){const n=this.xk(t,e,i),r=this.renderer.smuflMetrics.lineRangedGlyphDashGap,a=t+this.x+n+r;let h=e+this.y;const o=.5*this.height;h+=this.Tk?0:this.height;const c=this.renderer.smuflMetrics.lineRangedGlyphDashSize,l=i.lineWidth;if(i.lineWidth=this.renderer.smuflMetrics.octaveLineThickness,s>a){let t=a;for(;t<s;)i.beginPath(),i.moveTo(t,0|h),i.lineTo(Math.min(t+c,s),0|h),t+=c+r,i.stroke();i.beginPath(),this.Tk?(i.moveTo(s,h),i.lineTo(s,h+o)):(i.moveTo(s,h),i.lineTo(s,h-o)),i.stroke()}i.lineWidth=l}}class No extends Ah{Tk;get effectId(){return"ottavia-"+(this.Tk?"above":"below")}get notationElement(){return t.NotationElement.EffectOttavia}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return kh.GroupedOnBeat}constructor(t){super(),this.Tk=t}shouldCreateGlyph(t,e){switch(e.ottava){case m.S:case m._:return this.Tk;case m.T:case m.M:return!this.Tk}return!1}createNewGlyph(t,e){return new vo(e.ottava,this.Tk)}canExpand(t,e){return t.ottava===e.ottava}}class Po extends po{get notationElement(){return t.NotationElement.EffectPalmMute}shouldCreateGlyphForNote(t){return t.isPalmMute}get sizingMode(){return kh.GroupedOnBeat}createNewGlyph(e,s){return new Wh("P.M.",t.NotationElement.EffectPalmMute)}}class Co extends po{get notationElement(){return t.NotationElement.EffectPickSlide}shouldCreateGlyphForNote(t){return t.slideOutType===w.PickSlideDown||t.slideOutType===w.PickSlideUp}get sizingMode(){return kh.GroupedOnBeat}createNewGlyph(e,s){return new Wh("P.S.",t.NotationElement.EffectPickSlide)}}class Eo extends Yh{constructor(t,e,s){super(t,e,Or.GraceScale,Eo.ik(s)),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}static ik(t){switch(t){case lt.Up:return ut.StringsUpBow;case lt.Down:return ut.StringsDownBow;default:return ut.None}}}class Fo extends Ah{get notationElement(){return t.NotationElement.EffectPickStroke}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(t,e){return e.pickStroke!==lt.None}createNewGlyph(t,e){return new Eo(0,0,e.pickStroke)}canExpand(t,e){return!0}}class Ao extends Ah{get notationElement(){return t.NotationElement.EffectRasgueado}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.hasRasgueado}get sizingMode(){return kh.GroupedOnBeat}createNewGlyph(e,s){return new Wh("rasg.",t.NotationElement.EffectRasgueado)}canExpand(t,e){return!0}}class Do extends Ra{Mk=[];vk=[];Nk;isEmpty=!0;previousBand=null;isLinkedToPrevious=!1;firstBeat=null;lastBeat=null;height=0;originalHeight=0;voice;info;slot=null;constructor(t,e,s){super(0,0),this.voice=t,this.info=e,this.Nk=s}*iterateAllGlyphs(){for(const t of this.vk)for(const e of t.values())yield e}finalizeBand(){this.info.finalizeBand(this)}doLayout(){super.doLayout();for(let t=0;t<this.renderer.bar.voices.length;t++)this.vk.push(new Map),this.Mk.push([])}static shouldCreateGlyph(t,e,s){return e.shouldCreateGlyph(s.settings,t)&&(!e.hideOnMultiTrack||0===s.staff.trackIndex)}createGlyph(t){if(t.voice===this.voice&&Do.shouldCreateGlyph(t,this.info,this.renderer)){if(this.isEmpty=!1,this.firstBeat&&!t.isBefore(this.firstBeat)||(this.firstBeat=t),!this.lastBeat||t.isAfter(this.lastBeat))switch(this.lastBeat=t,this.info.sizingMode){case kh.SingleOnBeatToEnd:case kh.GroupedOnBeatToEnd:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat)}const e=this.Pk(this.info.sizingMode,t);e.height>this.height&&(this.height=e.height,this.originalHeight=e.height)}}resetHeight(){this.height=this.originalHeight}Pk(t,e){let s;switch(t){case kh.FullBar:case kh.SinglePreBeat:case kh.SingleOnBeat:case kh.SingleOnBeatToEnd:return s=this.info.createNewGlyph(this.renderer,e),s.renderer=this.renderer,s.beat=e,s.doLayout(),this.vk[e.voice.index].set(e.index,s),this.Mk[e.voice.index].push(s),s;case kh.GroupedOnBeat:case kh.GroupedOnBeatToEnd:const i=t===kh.GroupedOnBeat?kh.SingleOnBeat:kh.SingleOnBeatToEnd;if(e.index>0||this.renderer.index>0){const t=e.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,t)){let s=null;if(e.index>0&&this.vk[e.voice.index].has(t.index))s=this.vk[e.voice.index].get(t.index);else if(this.renderer.index>0){const e=this.Nk.previousContainer.getBand(t.voice,this.info.effectId);if(e){const i=e.vk[t.voice.index];i.has(t.index)&&(s=i.get(t.index))}}const n=this.Pk(i,e);return s&&this.info.canExpand(t,e)&&(s.nextGlyph=n,n.previousGlyph=s,this.isLinkedToPrevious=!0),n}return this.Pk(i,e)}return this.Pk(i,e);default:return this.Pk(kh.SingleOnBeat,e)}}paint(t,e,s){super.paint(t,e,s);for(let i=0,n=this.Mk.length;i<n;i++){const n=this.Mk[i];for(let i=0,r=n.length;i<r;i++){const r=n[i],a=ro.beat(s,_t.Effects,r.beat,!1);try{r.paint(t+this.x,e+this.y,s)}finally{a?.[Symbol.dispose]?.()}}}}alignGlyphs(){for(let t=0;t<this.vk.length;t++)for(const e of this.vk[t].keys()){const s=this.renderer.bar.voices[t].beats[e];this.Ck(this.info.sizingMode,s)}this.info.onAlignGlyphs(this)}Ck(t,e){const s=this.vk[e.voice.index].get(e.index),i=this.renderer.getBeatContainer(e);switch(t){case kh.SinglePreBeat:const t=this.renderer.layoutingInfo.getPreBeatSize(e);s.x=this.renderer.beatGlyphsStart+i.x+i.onTimeX-t;break;case kh.SingleOnBeat:case kh.GroupedOnBeat:s.x=this.renderer.beatGlyphsStart+i.x+i.onTimeX;break;case kh.SingleOnBeatToEnd:case kh.GroupedOnBeatToEnd:if(s.x=this.renderer.beatGlyphsStart+i.x+i.onTimeX,i.isLastOfVoice)s.width=this.renderer.width-s.x;else{const t=this.renderer.layoutingInfo.getPostBeatSize(e);s.width=t}break;case kh.FullBar:s.width=this.renderer.width}}}class Lo{uniqueEffectId=null;y=0;height=0;firstBeat=null;lastBeat=null}class Wo{bands;shared;constructor(){this.bands=[],this.shared=new Lo}update(t){t.info.canShareBand||(this.shared.uniqueEffectId=t.info.effectId),t.slot=this,this.bands.push(t),t.height>this.shared.height&&(this.shared.height=t.height),this.shared.firstBeat&&!t.firstBeat.isBefore(this.shared.firstBeat)||(this.shared.firstBeat=t.firstBeat),this.shared.lastBeat&&!t.lastBeat.isAfter(this.shared.lastBeat)||(this.shared.lastBeat=t.lastBeat)}canBeUsed(t){return!((this.shared.uniqueEffectId||!t.info.canShareBand)&&t.info.effectId!==this.shared.uniqueEffectId)&&(!this.shared.firstBeat||(this.shared.lastBeat===t.firstBeat||(!!this.shared.lastBeat.isBefore(t.firstBeat)||!!this.shared.lastBeat.isBefore(this.shared.firstBeat))))}}class Ro{Ek;Fk;slots;owner;constructor(t){this.slots=[],this.Ek=new Map,this.Fk=new Map,this.owner=t}reset(){this.Ek.clear(),this.Fk.clear(),this.slots=[]}getOrCreateSlot(t){if(this.Fk.has(t))return this.Fk.get(t);if(this.Ek.has(t.info.effectId)){const e=this.Ek.get(t.info.effectId);if(e.canBeUsed(t))return this.Fk.set(t,e),e}for(const e of this.slots)if(e.canBeUsed(t))return this.Fk.set(t,e),e;const e=new Wo;return this.slots.push(e),this.Fk.set(t,e),e}register(t){const e=this.getOrCreateSlot(t);e.update(t),this.Ek.set(t.info.effectId,e)}sortSlots(t){for(const e of this.slots)e.bands.sort((e,s)=>t.get(e.info)-t.get(s.info));this.slots.sort((e,s)=>t.get(e.bands[0].info)-t.get(s.bands[0].info))}}class Io{Ak=[];Dk=new Map;Lk=null;Wk=new Map;height=0;infos;Np;Rk;alignGlyphs(){for(const t of this.Ak)t.alignGlyphs()}get previousContainer(){return 0===this.Np.index?void 0:this.Rk?this.Np.previousRenderer.topEffects:this.Np.previousRenderer.bottomEffects}get isLinkedToPreviousRenderer(){return this.Ak.some(t=>t.isLinkedToPrevious)}constructor(t,e){this.Np=t,this.Rk=e}reLayout(){this.resetEffectBandSizingInfo(),this.sizeAndAlignEffectBands()}afterStaffBarReverted(){this.resetEffectBandSizingInfo(),this.sizeAndAlignEffectBands()}createVoiceGlyphs(t){let e=0;const s=this.Np,i=s.settings.notation;for(const n of this.infos){if(!i.isNotationElementVisible(n.effect.notationElement))continue;let r;this.Wk.set(n.effect,n.order??e);for(const e of t.beats)!r&&Do.shouldCreateGlyph(e,n.effect,s)&&(r=new Do(t,n.effect,this),r.renderer=this.Np,r.doLayout(),this.Ak.push(r),this.Dk.set(`${t.index}.${n.effect.effectId}`,r)),void 0!==r&&r.createGlyph(e);e++}}doLayout(){this.Wk.clear(),this.Ak=[],this.Dk=new Map,this.resetEffectBandSizingInfo()}resetEffectBandSizingInfo(){this.Np.index>0?this.Lk=this.previousContainer.Lk:this.Lk&&this.Lk.owner===this?this.Lk.reset():this.Lk=new Ro(this)}finalizeEffects(){return this.Ik(!0)}updateEffectBandHeights(){return this.Ik(!1)}Ik(t){if(!this.Lk)return!1;let e=0;const s=this.Np.settings.display.effectBandPaddingBottom;for(const i of this.Lk.slots){i.shared.y=e;for(const s of i.bands)e+=0,s.y=e,t&&s.finalizeBand(),s.height=i.shared.height;e+=i.shared.height+s}return e=Math.ceil(e),e!==this.height&&(this.height=e,!0)}sizeAndAlignEffectBands(t=!0){for(const e of this.Ak)e.resetHeight(),e.alignGlyphs(),t&&!e.isEmpty&&this.Lk.register(e);t&&this.Lk.sortSlots(this.Wk)}paint(t,e,s){const i=this.Np.resources;for(const n of this.Ak)s.color=0===n.voice.index?i.mainGlyphColor:i.secondaryGlyphColor,n.isEmpty||n.paint(t,e,s)}getBand(t,e){const s=`${t.index}.${e}`;return this.Dk.has(s)?this.Dk.get(s):null}}class Oo extends no{gap=0;constructor(){super(0,0),this.glyphs=[]}doLayout(){}addGlyph(t){t.x=this.width,t.renderer=this.renderer,t.doLayout(),this.width=t.x+t.width+this.gap,super.addGlyph(t)}}class Go extends Ra{static KeySizeBeat="Beat";voiceDrawOrder;Ok=new Map;beatGlyphs=new Map;tupletGroups=new Map;constructor(){super(0,0)}getBoundingBoxTop(){let t=Number.NaN;for(const e of this.beatGlyphs.values())for(const s of e)t=Xt.minBoundingBox(t,s.getBoundingBoxTop());return t}getBoundingBoxBottom(){let t=Number.NaN;for(const e of this.beatGlyphs.values())for(const s of e)t=Xt.maxBoundingBox(t,s.getBoundingBoxBottom());return t}scaleToWidth(t){const e=this.renderer.layoutingInfo.spaceToForce(t);this.Gk(e)}Gk(t){this.width=this.renderer.layoutingInfo.calculateVoiceWidth(t);const e=this.renderer.layoutingInfo.buildOnTimePositions(t);for(const t of this.beatGlyphs.values())for(let s=0,i=t.length;s<i;s++){const n=t[s];if(n.graceType===u.None)n.x=e.get(n.absoluteDisplayStart)-n.onTimeX;else{const i=n.graceGroup.beats[0].absoluteDisplayStart,r=n.graceGroup.id;if(n.graceGroup.isComplete&&e.has(i)){n.x=e.get(i)-n.onTimeX;const t=this.renderer.layoutingInfo.allGraceRods.get(r),s=n.graceGroup.beats[n.graceGroup.beats.length-1].nextBeat,a=s?this.renderer.layoutingInfo.getPreBeatSize(s):0;n.x-=a,n.x-=t[n.graceIndex].postSpringWidth,n.x+=t[n.graceIndex].graceBeatWidth;const h=t[n.graceGroup.beats.length-1];n.x-=h.graceBeatWidth}else{const e=this.renderer.layoutingInfo.incompleteGraceRods.get(r),i=e[n.graceIndex].postSpringWidth-e[n.graceIndex].preSpringWidth;s>0?0===n.graceIndex?n.x=t[s-1].x+t[s-1].width:n.x=t[s-1].x+e[n.graceIndex-1].postSpringWidth-e[n.graceIndex-1].preSpringWidth-i:n.x=-i}}if(s>0){const e=n.x-t[s-1].x;t[s-1].scaleToWidth(e)}if(s===i-1){const e=this.width-t[t.length-1].x;n.scaleToWidth(e)}}}registerLayoutingInfo(t){for(const e of this.beatGlyphs.values())for(const s of e)s.registerLayoutingInfo(t)}applyLayoutingInfo(t){for(const e of this.beatGlyphs.values()){for(const s of e)s.applyLayoutingInfo(t);this.Gk(Math.max(this.renderer.settings.display.stretchForce,t.minStretchForce))}}addGlyph(t){let e;this.beatGlyphs.has(t.voiceIndex)?e=this.beatGlyphs.get(t.voiceIndex):(e=[],this.beatGlyphs.set(t.voiceIndex,e)),t.x=0===e.length?0:e[e.length-1].x+e[e.length-1].width,t.renderer=this.renderer,e.push(t);const s=t.beatId;s>=0&&this.Ok.set(s,t);const i=t.x+t.width;if(i>this.width&&(this.width=i),t.isFirstOfTupletGroup){let e;this.tupletGroups.has(t.voiceIndex)?e=this.tupletGroups.get(t.voiceIndex):(e=[],this.tupletGroups.set(t.voiceIndex,e)),e.push(t.tupletGroup)}}getBeatX(t,e=ms.PreNotes,s=!1){const i=this.getBeatContainer(t);return i?i.x+i.getBeatX(e,s):0}getLowestNoteY(t,e){const s=this.getBeatContainer(t);return s?s.y+s.getLowestNoteY(e):0}getHighestNoteY(t,e){const s=this.getBeatContainer(t);return s?s.y+s.getHighestNoteY(e):0}getNoteX(t,e){const s=this.getBeatContainer(t.beat);return s?s.x+s.getNoteX(t,e):0}getNoteY(t,e){const s=this.getBeatContainer(t.beat);return s?s.y+s.getNoteY(t,e):0}getRestY(t,e){const s=this.getBeatContainer(t);return s?s.y+s.getRestY(e):0}getBeatContainer(t){if(this.Ok.has(t.id))return this.Ok.get(t.id)}buildBoundingsLookup(t,e,s){for(const[i,n]of this.beatGlyphs){const r=this.renderer.bar.voices[i];if(0===i||!r.isEmpty)for(const i of n)i.buildBoundingsLookup(t,e+this.x,s+this.y)}}doLayout(){for(const t of this.beatGlyphs.values()){let e=0;for(const s of t)s.x=e,s.doLayout(),e+=s.width;e>this.width&&(this.width=e)}this.renderer.bar.isMultiVoice&&this.Vk(),this.voiceDrawOrder=Array.from(this.beatGlyphs.keys()),Nu.sortDescending(this.voiceDrawOrder)}Vk(){for(const t of this.beatGlyphs.values()){let e=0;for(const s of t)s.x=e,s.doMultiVoiceLayout(),e+=s.width;e>this.width&&(this.width=e)}}paint(t,e,s){for(const i of this.voiceDrawOrder){const n=this.beatGlyphs.get(i),r=this.renderer.bar.voices[i],a=ro.voice(s,O.Glyphs,r,!0);try{for(let i=0,r=n.length;i<r;i++)n[i].paint(t+this.x,e+this.y,s)}finally{a?.[Symbol.dispose]?.()}}}}class Vo extends Ra{tieDirection=Rt.Up;slurEffectId;isForEnd;constructor(t,e){super(0,0),this.slurEffectId=t,this.isForEnd=e}$k=0;Hk=0;Uk=0;zk=0;Xk=0;jk;Jk=!1;get checkForOverflow(){return this.Jk&&void 0!==this.jk}getBoundingBoxTop(){return this.jk?this.jk.y:this.Hk}getBoundingBoxBottom(){return this.jk?this.jk.y+this.jk.h:this.Hk}doLayout(){this.width=0;const t=this.lookupStartBeatRenderer(),e=this.lookupEndBeatRenderer();this.$k=0,this.Uk=0,this.Hk=0,this.zk=0,this.height=0,this.tieDirection=this.calculateTieDirection();const s=this.isForEnd;if(this.Jk=!1,s){if(t.staff!==e.staff){const s=t.staff.barRenderers[0];this.$k=s.x,this.Uk=this.calculateEndX();const i=t.scoreRenderer.layout.slurRegistry.completeMultiSystemSlur(this);this.Hk=i?i.calculateMultiSystemSlurY(e):this.caclculateEndY(),this.zk=this.caclculateEndY(),this.Jk=t.staff!==e.staff}}else{if(t!==e)if(this.$k=this.calculateStartX(),this.Hk=this.calculateStartY(),e&&t.staff===e.staff)this.Uk=this.calculateEndX(),this.zk=this.caclculateEndY();else{const e=t.staff.barRenderers[t.staff.barRenderers.length-1];this.Uk=e.x+e.width,this.zk=this.Hk,t.scoreRenderer.layout.slurRegistry.startMultiSystemSlur(this)}else this.Jk=!0,this.$k=this.calculateStartX(),this.Uk=this.calculateEndX(),this.Hk=this.calculateStartY(),this.zk=this.caclculateEndY();this.Jk=!0}let i;if(this.jk=void 0,this.y=Math.min(this.Hk,this.zk),this.shouldDrawBendSlur()?(this.Xk=0,i=Vo.calculateBendSlurHeight(this.$k,this.Hk,this.Uk,this.zk,this.tieDirection===Rt.Down,this.renderer.smuflMetrics.tieHeight)):(this.Xk=this.getTieHeight(this.$k,this.Hk,this.Uk,this.zk),i=Vo.calculateActualTieHeight(1,this.$k,this.Hk,this.Uk,this.zk,this.tieDirection===Rt.Down,this.Xk,this.renderer.smuflMetrics.tieMidpointThickness)),this.jk=i,this.height=i.h,this.tieDirection===Rt.Up){const t=this.y-i.y;t>0&&(this.y-=t)}}paint(t,e,s){this.Jk&&(this.shouldDrawBendSlur()?Vo.drawBendSlur(s,t+this.$k,e+this.Hk,t+this.Uk,e+this.zk,this.tieDirection===Rt.Down,this.renderer.smuflMetrics.tieHeight):Vo.paintTie(s,1,t+this.$k,e+this.Hk,t+this.Uk,e+this.zk,this.tieDirection===Rt.Down,this.Xk,this.renderer.smuflMetrics.tieMidpointThickness))}getTieHeight(t,e,s,i){return this.renderer.smuflMetrics.tieHeight}calculateMultiSystemSlurY(t){const e=this.lookupStartBeatRenderer(),s=this.calculateStartY()-e.y;return t.y+s}shouldCreateMultiSystemSlur(t){const e=this.lookupEndBeatRenderer()?.staff;return!e||t.staff.system.index<e.system.index}static calculateActualTieHeight(t,e,s,i,n,r,a,h){const o=Vo.qk(t,e,s,i,n,r,a,h);if(0===o.length)return new zs(e,s,i-e,n-s);const c=o[0],l=o[1],u=o[2],d=o[3],f=o[4],p=o[5],b=o[6],m=o[7],g=.125*c+.375*u+.375*f+.125*b,w=.125*l+.375*d+.375*p+.125*m,y=Math.min(c,b,g),k=Math.max(c,b,g);let S=Math.min(l,m,w),B=Math.max(l,m,w);r?B+=h:S-=h;const _=new zs;return _.x=y,_.y=S,_.w=k-y,_.h=B-S,_}static qk(t,e,s,i,n,r,a,h){if(e===i&&s===n)return[];if(i<e){let t=e;e=i,i=t,t=s,s=n,n=t}a*=t,h*=t,r&&(a*=-1,h*=-1),t>=1&&(h*=1.2);const o=n-s,c=i-e,l=Math.sqrt(c*c+o*o);let u=e+.25*l,d=s-a,f=e+.75*l,p=s-a,b=e+.75*l,m=s-a-h,g=e+.25*l,w=s-a-h;const y=Math.atan2(o,c);return[u,d]=Vo.Yk(u,d,e,s,y),[f,p]=Vo.Yk(f,p,e,s,y),[b,m]=Vo.Yk(b,m,e,s,y),[g,w]=Vo.Yk(g,w,e,s,y),[e,s,u,d,f,p,i,n,b,m,g,w,e,s]}static Yk(t,e,s,i,n){const r=t-s,a=e-i;return[s+(r*Math.cos(n)-a*Math.sin(n)),i+(r*Math.sin(n)+a*Math.cos(n))]}static paintTie(t,e,s,i,n,r,a,h,o){const c=Vo.qk(e,s,i,n,r,a,h,o);t.beginPath(),t.moveTo(c[0],c[1]),t.bezierCurveTo(c[2],c[3],c[4],c[5],c[6],c[7]),t.bezierCurveTo(c[8],c[9],c[10],c[11],c[12],c[13]),t.closePath(),t.fill()}static calculateBendSlurTopY(t,e,s,i,n,r,a){let h=i-e,o=s-t;const c=Math.sqrt(h*h+o*o);n?h*=-1:o*=-1,h/=c,o/=c;let l=a*r;s-t<20&&(l/=2);return(i+e)/2+l*o}static calculateBendSlurHeight(t,e,s,i,n,r){let a=i-e,h=s-t;const o=Math.sqrt(a*a+h*h);n?a*=-1:h*=-1,a/=o,h/=o;let c=r;s-t<20&&(c/=2);const l=(i+e)/2+c*h,u=Math.min(e,i,l),d=Math.max(e,i,l);return new zs(t,Math.min(e,i,l),s-t,d-u)}static drawBendSlur(t,e,s,i,n,r,a,h){let o=n-s,c=i-e;const l=Math.sqrt(o*o+c*c);r?o*=-1:c*=-1,o/=l,c/=l;let u=a;i-e<20&&(u/=2);const d=(i+e)/2+u*o,f=(n+s)/2+u*c;if(t.beginPath(),t.moveTo(e,s),t.lineTo(d,f),t.lineTo(i,n),t.stroke(),h){const e=t.measureText(h).width,s=r?0:-t.font.size;t.fillText(h,d-e/2,f+s)}}}class $o extends Vo{startNote;endNote;startNoteRenderer=null;endNoteRenderer=null;constructor(t,e,s,i){super(t,i),this.startNote=e,this.endNote=s}get isLeftHandTap(){return this.startNote===this.endNote}getTieHeight(t,e,s,i){return this.isLeftHandTap?this.renderer.smuflMetrics.tieHeight:super.getTieHeight(t,e,s,i)}calculateTieDirection(){return this.lookupStartBeatRenderer().getBeatDirection(this.startNote.beat)===Rt.Up?Rt.Down:Rt.Up}calculateStartX(){const t=this.lookupStartBeatRenderer();return this.isLeftHandTap?this.calculateEndX()-t.smuflMetrics.leftHandTabTieWidth:t.x+t.getNoteX(this.startNote,this.getStartNotePosition())}getStartNotePosition(){return Bh.Center}calculateStartY(){const t=this.lookupStartBeatRenderer();return this.isLeftHandTap?t.y+t.getNoteY(this.startNote,Sh.Center):this.tieDirection===Rt.Up?t.y+t.getNoteY(this.startNote,Sh.Top):t.y+t.getNoteY(this.startNote,Sh.Bottom)}calculateEndX(){const t=this.lookupEndBeatRenderer();return t?this.isLeftHandTap?t.x+t.getNoteX(this.endNote,Bh.Left):t.x+t.getNoteX(this.endNote,Bh.Center):this.calculateStartY()+this.renderer.smuflMetrics.leftHandTabTieWidth}getEndNotePosition(){return Bh.Center}caclculateEndY(){const t=this.lookupEndBeatRenderer();return t?this.isLeftHandTap?t.y+t.getNoteY(this.endNote,Sh.Center):this.tieDirection===Rt.Up?t.y+t.getNoteY(this.endNote,Sh.Top):t.y+t.getNoteY(this.endNote,Sh.Bottom):this.calculateStartY()}lookupEndBeatRenderer(){return this.endNoteRenderer||(this.endNoteRenderer=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endNote.beat.voice.bar)),this.endNoteRenderer}lookupStartBeatRenderer(){return this.startNoteRenderer||(this.startNoteRenderer=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startNote.beat.voice.bar)),this.startNoteRenderer}shouldDrawBendSlur(){return!1}}class Ho extends Vo{Kk;constructor(t){super(t.slurEffectId,!1),this.Kk=t}lookupStartBeatRenderer(){return this.renderer}lookupEndBeatRenderer(){return this.renderer}shouldDrawBendSlur(){return!1}calculateTieDirection(){return this.Kk.tieDirection}calculateStartY(){return this.Kk.calculateMultiSystemSlurY(this.renderer)}caclculateEndY(){return this.calculateStartY()}calculateStartX(){return this.renderer.staff.barRenderers[0].x}calculateEndX(){const t=this.renderer.staff.barRenderers[this.renderer.staff.barRenderers.length-1];return t.x+t.width}}class Uo extends Ra{_y=0;Qk;Qy=[];constructor(t,e,s,i,n=1){super(t,e),this.Qy=Uo.getSymbols(s),this._y=n,this.Qk=i}static getSymbols(t){const e=[];for(;t>0;){const s=t%10;e.unshift(Uo.getSymbol(s)),t=t/10|0}return e}static getSymbol(t){switch(t){case 0:return ut.TimeSig0;case 1:return ut.TimeSig1;case 2:return ut.TimeSig2;case 3:return ut.TimeSig3;case 4:return ut.TimeSig4;case 5:return ut.TimeSig5;case 6:return ut.TimeSig6;case 7:return ut.TimeSig7;case 8:return ut.TimeSig8;case 9:return ut.TimeSig9;default:return ut.None}}doLayout(){let t=0;for(const e of this.Qy)t+=this.renderer.smuflMetrics.glyphWidths.get(e);this.width=t}paint(t,e,s){switch(this.Qk){case ot.Top:e+=this.renderer.smuflMetrics.glyphBottom.get(this.Qy[0]);break;case ot.Bottom:e+=this.renderer.smuflMetrics.glyphTop.get(this.Qy[0])}s.fillMusicFontSymbols(t+this.x,e+this.y,this._y,this.Qy)}}class zo extends Ra{static Zk=[ut.RestHBarLeft,ut.RestHBarMiddle,ut.RestHBarMiddle,ut.RestHBarMiddle,ut.RestHBarRight];tS=[];eS=0;constructor(){super(0,0)}doLayout(){const t=this.renderer.smuflMetrics;this.width=zo.Zk.reduce((e,s)=>e+t.glyphWidths.get(s),0);const e=this.renderer.additionalMultiRestBars.length+1;this.tS=Uo.getSymbols(e),this.eS=this.renderer.getLineY(-1.5);const s=t.glyphTop.get(this.tS[0]);this.renderer.registerOverflowTop(Math.abs(this.eS)+s)}paint(t,e,s){s.fillMusicFontSymbols(t+this.x,e+this.y+this.renderer.height/2,1,zo.Zk);const i=this.renderer.getLineY(-1.5);s.fillMusicFontSymbols(t+this.x+this.width/2,e+this.y+i|0,1,this.tS,!0)}}class Xo extends Ia{sS;constructor(){super(0,0)}get absoluteDisplayStart(){return this.renderer.bar.masterBar.start}get beatId(){return-1}get onTimeX(){return 0}get graceType(){return u.None}get graceIndex(){return 0}get graceGroup(){return null}get voiceIndex(){return 0}get isFirstOfTupletGroup(){return!1}get tupletGroup(){return null}get isLastOfVoice(){return!0}get displayDuration(){return 0}getRestY(t){const e=this.sS;if(e)switch(t){case Sh.Top:return e.y;case Sh.TopWithStem:return e.y-this.renderer.smuflMetrics.getStemLength(l.Quarter,!0);case Sh.Center:case Sh.StemUp:case Sh.StemDown:return e.y+e.height/2;case Sh.Bottom:return e.y+e.height;case Sh.BottomWithStem:return e.y+e.height+this.renderer.smuflMetrics.getStemLength(l.Quarter,!0)}return 0}getNoteY(t,e){return this.getRestY(e)}getHighestNoteY(t){return this.getRestY(t)}getLowestNoteY(t){return this.getRestY(t)}getNoteX(t,e){const s=this.sS;if(s)switch(e){case Bh.Left:return s.x;case Bh.Center:return s.x+s.width/2;case Bh.Right:return s.x+s.width}return 0}getBeatX(t,e){const s=this.sS;if(s)switch(t){case ms.PreNotes:return s.x;case ms.OnNotes:case ms.MiddleNotes:case ms.Stem:case ms.PostNotes:return s.x+s.width;case ms.EndBeat:return this.width}return 0}registerLayoutingInfo(t){const e=this.sS?.width??0;t.addBeatSpring(this,0,e)}applyLayoutingInfo(t){}buildBoundingsLookup(t,e,s){}doLayout(){this.renderer.showMultiBarRest&&(this.sS=new zo,this.sS.renderer=this.renderer,this.sS.doLayout(),this.width=this.sS.width)}doMultiVoiceLayout(){}getBoundingBoxTop(){return this.sS?.getBoundingBoxTop()??Number.NaN}getBoundingBoxBottom(){return this.sS?.getBoundingBoxBottom()??Number.NaN}paint(t,e,s){this.sS?.paint(t+this.x,e+this.y,s)}}class jo{startBeat=null;startX=0;startY=0;endBeat=null;endX=0;endY=0;calcY(t){return this.startX===this.endX?this.startY:(this.endY-this.startY)/(this.endX-this.startX)*(t-this.startX)+this.startY}}class Jo{iS;Np;nS;voice=null;beats=[];shortestDuration=l.QuadrupleWhole;hasTuplet=!1;slashBeats=[];restBeats=[];lowestNoteInHelper=null;rS=-1;highestNoteInHelper=null;aS=-1;invertBeamDirection=!1;preferredBeamDirection=null;graceType=u.None;get isRestBeamHelper(){return 1===this.beats.length&&this.beats[0].isRest}hasStem(t,e){return t&&Jo.beatHasStem(e)||!t&&Jo.beatHasStem(e)}static beatHasStem(t){return t.duration>l.Whole}hasFlag(t,e){return t&&Jo.beatHasFlag(e)||!t&&1===this.beats.length&&Jo.beatHasFlag(this.beats[0])}static beatHasFlag(t){return!t.deadSlapped&&!t.isRest&&(t.duration>l.Quarter||t.graceType!==u.None)}constructor(t,e,s){this.iS=t,this.Np=e,this.beats=[],this.nS=s}alignWithBeats(){for(const t of this.drawingInfos.values())t.startX=this.Np.getBeatX(t.startBeat,ms.Stem),t.endX=this.Np.getBeatX(t.endBeat,ms.Stem),this.drawingInfos.clear()}finish(){this.Np.completeBeamingHelper(this)}static computeLineHeightsForRest(t){switch(t){case l.QuadrupleWhole:case l.DoubleWhole:return[2,2];case l.Whole:return[0,1];case l.Half:return[1,0];case l.Quarter:return[3,3];case l.Eighth:return[2,2];case l.Sixteenth:return[2,4];case l.ThirtySecond:return[4,4];case l.SixtyFourth:return[4,6];case l.OneHundredTwentyEighth:return[6,6];case l.TwoHundredFiftySixth:return[6,8]}return[0,0]}checkBeat(t){t.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=t.voice);let e=!1;if(0===this.beats.length)e=!0;else switch(this.beats[this.beats.length-1].beamingMode){case Bt.Auto:case Bt.ForceSplitOnSecondaryToNext:e=this.hS(this.beats[this.beats.length-1],t);break;case Bt.ForceSplitToNext:e=!1;break;case Bt.ForceMergeWithNext:e=!0}return e&&(null==this.preferredBeamDirection&&null!==t.preferredBeamDirection&&(this.preferredBeamDirection=t.preferredBeamDirection),t.hasTuplet&&(this.hasTuplet=!0),t.graceType!==u.None&&(this.graceType=t.graceType),t.isRest?0===this.beats.length?this.beats.push(t):this.restBeats.push(t):(this.isRestBeamHelper&&(this.beats=[]),this.beats.push(t),this.oS(t.minNote),this.oS(t.maxNote),this.shortestDuration<t.duration&&(this.shortestDuration=t.duration)),t.slashed&&this.slashBeats.push(t)),e}oS(t){if(!t)return;let e,s;this.voice&&t.isPercussion?(e=-li.getPercussionSteps(t),s=e):(e=li.getNoteValue(t),s=e,t.harmonicType!==p.None&&t.harmonicType!==p.Natural&&(s=t.realValue-this.iS.displayTranspositionPitch)),(!this.lowestNoteInHelper||e<this.rS)&&(this.lowestNoteInHelper=t,this.rS=e),(!this.highestNoteInHelper||s>this.aS)&&(this.highestNoteInHelper=t,this.aS=s)}hS(t,e){if(!t||!e||t.graceType!==e.graceType||t.graceType===u.BendGrace||e.graceType===u.BendGrace||t.deadSlapped||e.deadSlapped)return!1;if(t.graceType!==u.None&&e.graceType!==u.None)return!0;if(t.voice.bar!==e.voice.bar)return!1;const s=t.playbackStart,i=e.playbackStart;if(!Jo.cS(t.duration)||!Jo.cS(e.duration))return s===i;if(t.tupletGroup!==e.tupletGroup)return!1;if(t.hasTuplet&&e.hasTuplet&&t.tupletGroup===e.tupletGroup&&t.tupletGroup.isFull)return!0;return this.nS.calculateGroupIndex(s)===this.nS.calculateGroupIndex(i)}static cS(t){switch(t){case l.Whole:case l.Half:case l.Quarter:return!1;default:return!0}}static isFullBarJoin(t,e,s){return Xt.getIndex(t.duration)-2-s>0&&Xt.getIndex(e.duration)-2-s>0}get beatOfLowestNote(){return this.lowestNoteInHelper.beat}get beatOfHighestNote(){return this.highestNoteInHelper.beat}drawingInfos=new Map}class qo{topY=0;bottomY=0;constructor(t,e){this.topY=t,this.bottomY=e}}class Yo{beat;topY=-1e3;bottomY=-1e3;slots=[];constructor(t){this.beat=t}addSlot(t,e){if(this.slots.push(new qo(t,e)),-1e3===this.topY)this.topY=t,this.bottomY=e;else{const s=Math.min(t,e),i=Math.max(t,e);s<this.topY&&(this.topY=s),i>this.bottomY&&(this.bottomY=i)}}}class Ko{reservedLayoutAreasByDisplayTime=new Map;restDurationsByDisplayTime=new Map;getBeatMinMaxY(){let t=-1e3,e=-1e3;for(const s of this.reservedLayoutAreasByDisplayTime.values())-1e3===t?(t=s.topY,e=s.bottomY):(t>s.topY&&(t=s.topY),e<s.bottomY&&(e=s.bottomY));return-1e3===t?[0,0]:[t,e]}reserveBeatSlot(t,e,s){e!==s&&(this.reservedLayoutAreasByDisplayTime.has(t.displayStart)||this.reservedLayoutAreasByDisplayTime.set(t.displayStart,new Yo(t)),this.reservedLayoutAreasByDisplayTime.get(t.displayStart).addSlot(e,s),t.isRest&&this.registerRest(t))}registerRest(t){this.restDurationsByDisplayTime.has(t.displayStart)||this.restDurationsByDisplayTime.set(t.displayStart,new Map),this.restDurationsByDisplayTime.get(t.displayStart).has(t.playbackDuration)||this.restDurationsByDisplayTime.get(t.displayStart).set(t.playbackDuration,t.id)}applyRestCollisionOffset(t,e,s){if(t.voice.index>0&&this.reservedLayoutAreasByDisplayTime.has(t.playbackStart)){const i=Jo.computeLineHeightsForRest(t.duration).map(t=>t*s),n=e-i[0],r=e+i[1];let a=n;const h=this.reservedLayoutAreasByDisplayTime.get(t.playbackStart);let o=!1;for(const t of h.slots)if(n>=t.topY&&n<=t.bottomY||r>=t.topY&&r<=t.bottomY){o=!0;break}if(o){a=1===t.voice.index?h.topY-i[1]-i[0]:h.bottomY;const e=a+i[0]+i[1],r=2*s,o=Math.ceil(Math.abs(a-n)/r);return h.addSlot(a,e),a<n?o*-r:o*r}}return 0}}class Qo{lS=0;uS=[];dS;constructor(t,e,s){this.lS=e,this.uS=s,this.dS=t}calculateGroupIndex(t){if(0===this.uS.length)return t;t%=this.dS;const e=Math.floor(t/this.lS);return this.uS[e]}static build(t,e,s){const i=t.calculateDuration(!1),n=$.toTicks(e),r=i/n;if(r<0||0===s.length)return new Qo(0,0,[]);let a=0,h=s[a];const o=[];for(let t=0;t<r;t++)a<s.length?(o.push(a),h--,h<=0&&(a++,a<s.length&&(h=s[a]))):(o.push(a),a++);return new Qo(i,n,o)}}class Zo{Np;fS=new Map;beamHelpers=[];collisionHelper;preferredBeamDirection=null;constructor(t){this.Np=t,this.collisionHelper=new Ko}initialize(){const t=this.Np,e=this.Np.bar,s=e.masterBar,i=s.actualBeamingRules??Zo.pS(s),n=i.findRule(e.shortestDuration),r=`beaming_${i.uniqueId}_${n[0]}`;let a=this.Np.scoreRenderer.layout.beamingRuleLookups.has(r)?this.Np.scoreRenderer.layout.beamingRuleLookups.get(r):void 0;a||(a=Qo.build(s,n[0],n[1]),this.Np.scoreRenderer.layout.beamingRuleLookups.set(r,a));let h=null,o=null;for(let s=0,i=e.voices.length;s<i;s++){const i=e.voices[s];this.beamHelpers.push([]);for(let s=0,n=i.beats.length;s<n;s++){const n=i.beats[s];let r;n.graceType!==u.None?r=o:(r=h,o&&o.finish(),o=null),r&&r.checkBeat(n)||(r&&r.finish(),r=new Jo(e.staff,t,a),r.preferredBeamDirection=this.preferredBeamDirection,r.checkBeat(n),n.graceType!==u.None?o=r:h=r,this.beamHelpers[i.index].push(r)),this.fS.set(n.id,r)}h&&h.finish(),o&&o.finish(),h=null,o=null}}static bS;static pS(t){let e=Zo.bS;e||(e=new Map([tt.createSimple(2,16,l.Sixteenth,[1,1]),tt.createSimple(1,8,l.Eighth,[1]),tt.createSimple(1,4,l.Quarter,[1]),tt.createSimple(3,16,l.Sixteenth,[3]),tt.createSimple(4,16,l.Sixteenth,[2,2]),tt.createSimple(2,8,l.Eighth,[1,1]),tt.createSimple(5,16,l.Sixteenth,[3,2]),tt.createSimple(6,16,l.Sixteenth,[3,3]),tt.createSimple(3,8,l.Eighth,[3]),tt.createSimple(4,8,l.Eighth,[2,2]),tt.createSimple(2,4,l.Quarter,[1,1]),tt.createSimple(9,16,l.Sixteenth,[3,3,3]),tt.createSimple(5,8,l.Eighth,[3,2]),tt.createSimple(12,16,l.Sixteenth,[3,3,3,3]),tt.createSimple(6,8,l.Eighth,[3,3,3]),tt.createSimple(3,4,l.Quarter,[1,1,1]),tt.createSimple(7,8,l.Eighth,[4,3]),tt.createSimple(8,8,l.Eighth,[3,3,2]),tt.createSimple(4,4,l.Quarter,[1,1,1,1]),tt.createSimple(9,8,l.Eighth,[3,3,3]),tt.createSimple(10,8,l.Eighth,[4,3,3]),tt.createSimple(5,4,l.Quarter,[1,1,1,1,1]),tt.createSimple(12,8,l.Eighth,[3,3,3,3]),tt.createSimple(6,4,l.Quarter,[1,1,1,1,1,1]),tt.createSimple(15,8,l.Eighth,[3,3,3,3,3,3]),tt.createSimple(8,4,l.Quarter,[1,1,1,1,1,1,1,1]),tt.createSimple(18,8,l.Eighth,[3,3,3,3,3,3])].map(t=>[`${t.timeSignatureNumerator}_${t.timeSignatureDenominator}`,t])),Zo.bS=e);const s=`${t.timeSignatureNumerator}_${t.timeSignatureDenominator}`;if(e.has(s))return e.get(s);let i=$.QuarterTime;if(8===t.timeSignatureDenominator)t.timeSignatureNumerator%3==0&&(i+=$.QuarterTime/2|0);const n=Math.ceil(t.calculateDuration(!1)/i),r=i/$.QuarterTime*2,a=new tt,h=[];for(let t=0;t<n;t++)h.push(r);return a.groups.set(l.Eighth,h),a.timeSignatureNumerator=t.timeSignatureNumerator,a.timeSignatureDenominator=t.timeSignatureDenominator,a.finish(),e.set(s,a),a}getBeamingHelperForBeat(t){return this.fS.has(t.id)?this.fS.get(t.id):void 0}}!function(t){t[t.TopWithStem=0]="TopWithStem",t[t.Top=1]="Top",t[t.Center=2]="Center",t[t.Bottom=3]="Bottom",t[t.BottomWithStem=4]="BottomWithStem",t[t.StemUp=5]="StemUp",t[t.StemDown=6]="StemDown"}(Sh||(Sh={})),function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(Bh||(Bh={}));class tc{mS=new Oo;voiceContainer=new Go;gS=new Oo;Fm=[];wS;topEffects;bottomEffects;get nextRenderer(){return this.bar&&this.bar.nextBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.nextBar):null}get previousRenderer(){return this.bar&&this.bar.previousBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.previousBar):null}scoreRenderer;staff;layoutingInfo;bar;additionalMultiRestBars=null;get lastBar(){return this.additionalMultiRestBars?this.additionalMultiRestBars[this.additionalMultiRestBars.length-1]:this.bar}x=0;y=0;width=0;computedWidth=0;height=0;index=0;yS=0;kS=0;beatEffectsMinY=Number.NaN;beatEffectsMaxY=Number.NaN;get topOverflow(){return this.yS+this.topEffects.height}get bottomOverflow(){return this.kS+this.bottomEffects.height}helpers;get collisionHelper(){return this.helpers.collisionHelper}isLinkedToPrevious=!1;canWrap=!0;get showMultiBarRest(){return!0}constructor(t,e){this.scoreRenderer=t,this.bar=e,this.helpers=new Zo(this),this.topEffects=new Io(this,!0),this.bottomEffects=new Io(this,!1)}registerTie(t){this.Fm.push(t)}get middleYPosition(){return 0}registerBeatEffectOverflows(t,e){const s=this.beatEffectsMinY;(Number.isNaN(s)||t<s)&&(this.beatEffectsMinY=t);const i=this.beatEffectsMaxY;(Number.isNaN(i)||e>i)&&(this.beatEffectsMaxY=e)}registerOverflowTop(t){return(t=Math.ceil(t))>this.yS&&(this.yS=t,!0)}registerOverflowBottom(t){return(t=Math.ceil(t))>this.kS&&(this.kS=t,!0)}scaleToWidth(t){const e=t-this.mS.width-this.gS.width;this.voiceContainer.scaleToWidth(e);for(const t of this.helpers.beamHelpers)for(const e of t)e.alignWithBeats();this.gS.x=this.mS.x+this.mS.width+e,this.width=t,this.topEffects.alignGlyphs(),this.bottomEffects.alignGlyphs()}get resources(){return this.settings.display.resources}get smuflMetrics(){return this.resources.engravingSettings}get settings(){return this.scoreRenderer.settings}wasFirstOfStaff=!1;get isFirstOfStaff(){return 0===this.index}get isLastOfStaff(){return this.index===this.staff.barRenderers.length-1}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}SS(){const t=this.layoutingInfo,e=this.mS.width;t.preBeatSize<e&&(t.preBeatSize=e);this.voiceContainer.registerLayoutingInfo(t);const s=this.gS.width;t.postBeatSize<s&&(t.postBeatSize=s)}BS=0;afterReverted(){this.staff=void 0,this.registerMultiSystemSlurs(void 0),this.isFinalized=!1}afterStaffBarReverted(){this.topEffects.afterStaffBarReverted(),this.bottomEffects.afterStaffBarReverted(),this._S()}applyLayoutingInfo(){if(this.BS>=this.layoutingInfo.version)return!1;this.topEffects.resetEffectBandSizingInfo(),this.bottomEffects.resetEffectBandSizingInfo(),this.BS=this.layoutingInfo.version,this.mS.width=this.layoutingInfo.preBeatSize;const t=this.voiceContainer;return t.x=this.mS.x+this.mS.width,t.applyLayoutingInfo(this.layoutingInfo),this.gS.x=Math.floor(t.x+t.width),this.gS.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this.gS.x+this.gS.width),this.computedWidth=this.width,this.topEffects.sizeAndAlignEffectBands(),this.bottomEffects.sizeAndAlignEffectBands(),this._S(),!0}isFinalized=!1;registerMultiSystemSlurs(t){if(!t)return void(this.wS=void 0);let e;for(const s of t){const t=new Ho(s);t.renderer=this,t.tieDirection=s.tieDirection,e||(e=[]),e.push(t)}this.wS=e}TS(t,e,s){let i=!1;for(const n of t){const t=n;if(t.doLayout(),n.checkForOverflow){const n=t.getBoundingBoxTop(),r=t.getBoundingBoxBottom()-s;r>0&&this.registerOverflowBottom(r)&&(i=!0);const a=n-e;a<0&&this.registerOverflowTop(-1*a)&&(i=!0)}}return i}finalizeRenderer(){this.isFinalized=!0;let t=!1;const e=this.y,s=this.y+this.height;this.TS(this.Fm,e,s)&&(t=!0);const i=this.wS;i&&this.TS(i,e,s)&&(t=!0);const n=this.topEffects.finalizeEffects(),r=this.bottomEffects.finalizeEffects();return(n||r)&&(t=!0),t&&(this.updateSizes(),this._S()),t}_S(){this.staff.registerOverflowTop(this.topOverflow),this.staff.registerOverflowBottom(this.bottomOverflow)}doLayout(){if(this.bar){this.helpers.initialize(),this.Fm=[],this.mS.renderer=this,this.voiceContainer.renderer=this,this.gS.renderer=this,this.topEffects.doLayout(),this.bottomEffects.doLayout(),this.bar.simileMark===v.SecondOfDouble&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.createBeatGlyphs(),this.createPostBeatGlyphs(),this.SS(),this.topEffects.sizeAndAlignEffectBands(!1),this.bottomEffects.sizeAndAlignEffectBands(!1),this.updateSizes();for(const t of this.helpers.beamHelpers)for(const e of t)e.finish();this.computedWidth=this.width,this.calculateOverflows(0,this.height)}}calculateOverflows(t,e){const s=this.mS.glyphs;if(s)for(const t of s){const s=t.getBoundingBoxTop();s<0&&this.registerOverflowTop(-1*s);const i=t.getBoundingBoxBottom();i>e&&this.registerOverflowBottom(i-e)}const i=this.gS.glyphs;if(i)for(const t of i){const s=t.getBoundingBoxTop();s<0&&this.registerOverflowTop(-1*s);const i=t.getBoundingBoxBottom();i>e&&this.registerOverflowBottom(i-e)}const n=this.voiceContainer,r=n.getBoundingBoxTop();r<0&&this.registerOverflowTop(-1*r);const a=n.getBoundingBoxBottom();a>e&&this.registerOverflowBottom(a-e);const h=this.beatEffectsMinY;!Number.isNaN(h)&&h<0&&this.registerOverflowTop(-1*h);const o=this.beatEffectsMaxY;!Number.isNaN(o)&&o>e&&this.registerOverflowBottom(o-e)}updateSizes(){this.staff.registerStaffTop(0),this.voiceContainer.x=this.mS.x+this.mS.width,this.gS.x=Math.floor(this.voiceContainer.x+this.voiceContainer.width),this.width=Math.ceil(this.gS.x+this.gS.width);const t=this.topEffects.updateEffectBandHeights(),e=this.bottomEffects.updateEffectBandHeights();(t||e)&&this._S(),this.height+=this.layoutingInfo.height,this.height=Math.ceil(this.height),this.staff.registerStaffBottom(this.height)}addPreBeatGlyph(t){t.renderer=this,this.mS.addGlyph(t)}addBeatGlyph(t){t.renderer=this,this.voiceContainer.addGlyph(t)}getBeatContainer(t){return this.voiceContainer.getBeatContainer(t)}paint(t,e,s){this.paintContent(t,e,s);const i=e+this.y-this.staff.topOverflow;this.topEffects.paint(t+this.x,i,s);const n=e+this.y+this.height+this.staff.bottomOverflow-this.bottomEffects.height;this.bottomEffects.paint(t+this.x,n,s)}paintContent(t,e,s){this.paintBackground(t,e,s),s.color=this.resources.mainGlyphColor,this.mS.paint(t+this.x,e+this.y,s),this.voiceContainer.paint(t+this.x,e+this.y,s),s.color=this.resources.mainGlyphColor,this.gS.paint(t+this.x,e+this.y,s),this.xS(t,e,s)}xS(t,e,s){const i=this.wS;if(i)for(const n of i)n.paint(t,e,s)}paintBackground(t,e,s){this.layoutingInfo.paint(t+this.x+this.mS.x+this.mS.width,e+this.y+this.height,s)}buildBoundingsLookup(t,e,s){const i=new da;i.bar=this.bar,i.visualBounds=new zs,i.visualBounds.x=e+this.x,i.visualBounds.y=s+this.y,i.visualBounds.w=this.width,i.visualBounds.h=this.height,i.realBounds=new zs,i.realBounds.x=e+this.x,i.realBounds.y=s+this.y,i.realBounds.w=this.width,i.realBounds.h=this.height,t.addBar(i),this.voiceContainer.buildBoundingsLookup(i,e+this.x,s+this.y)}addPostBeatGlyph(t){this.gS.addGlyph(t)}createPreBeatGlyphs(){this.wasFirstOfStaff=this.isFirstOfStaff}createBeatGlyphs(){if(this.additionalMultiRestBars){const t=new Xo;this.addBeatGlyph(t)}else for(const t of this.bar.filledVoices)this.createVoiceGlyphs(this.bar.voices[t]);this.voiceContainer.doLayout(),(this.topEffects.isLinkedToPreviousRenderer||this.bottomEffects.isLinkedToPreviousRenderer)&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(t){this.topEffects.createVoiceGlyphs(t),this.bottomEffects.createVoiceGlyphs(t)}createPostBeatGlyphs(){}get beatGlyphsStart(){return this.voiceContainer.x}get postBeatGlyphsStart(){return this.gS.x}getBeatX(t,e=ms.PreNotes,s=!1){return this.beatGlyphsStart+this.voiceContainer.getBeatX(t,e,s)}getRatioPositionX(t){const e=this.bar.isEmpty?this.beatGlyphsStart:this.getBeatX(this.bar.voices[0].beats[0],ms.MiddleNotes);return e+(this.postBeatGlyphsStart-e)*t}getNoteX(t,e){return this.beatGlyphsStart+this.voiceContainer.getNoteX(t,e)}getNoteY(t,e){return this.voiceContainer.y+ +this.voiceContainer.getNoteY(t,e)}getRestY(t,e){return this.voiceContainer.y+ +this.voiceContainer.getRestY(t,e)}reLayout(){this.topEffects.reLayout(),this.bottomEffects.reLayout(),this.updateSizes(),(this.wasFirstOfStaff&&!this.isFirstOfStaff||!this.wasFirstOfStaff&&this.isFirstOfStaff)&&(this.recreatePreBeatGlyphs(),this.gS.doLayout()),this.SS(),this.calculateOverflows(0,this.height)}recreatePreBeatGlyphs(){this.mS=new Oo,this.mS.renderer=this,this.createPreBeatGlyphs()}paintSimileMark(t,e,s){const i=ro.voice(s,O.Glyphs,this.bar.voices[0],!0);try{switch(this.bar.simileMark){case v.Simple:s.beginGroup(Oa.getGroupId(this.bar.voices[0].beats[0])),Ot.fillMusicFontSymbolSafe(s,t+this.x+this.width/2,e+this.y+this.height/2,1,ut.Repeat1Bar,!0),s.endGroup();break;case v.SecondOfDouble:s.beginGroup(Oa.getGroupId(this.bar.voices[0].beats[0])),s.beginGroup(Oa.getGroupId(this.bar.previousBar.voices[0].beats[0])),Ot.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+this.height/2,1,ut.Repeat2Bars,!0),s.endGroup(),s.endGroup()}}finally{i?.[Symbol.dispose]?.()}}completeBeamingHelper(t){}}class ec extends Lh{pk;MS=ut.None;vS=0;NS=0;PS;constructor(t,e,s,i=!1){super(ms.EndBeat),this.pk=s,this.x=t,this.y=e,this.PS=i}doLayout(){switch(super.doLayout(),this.pk){case y.Slight:this.MS=this.slightVibratoGlyph;break;case y.Wide:this.MS=this.wideVibratoGlyph}this.vS=this.renderer.smuflMetrics.repeatOffsetX.get(this.MS),this.NS=this.renderer.smuflMetrics.glyphTop.get(this.MS),this.height=this.renderer.smuflMetrics.glyphHeights.get(this.MS)}paintGrouped(t,e,s,i){let n=(s-(t+this.x))/this.vS;this.PS||(n=Math.floor(n)),n<1&&(n=1);const r=[];for(let t=0;t<n;t++)r.push(this.MS);i.fillMusicFontSymbols(t+this.x,e+this.y+this.NS,1,r,!1)}}class sc extends ec{get slightVibratoGlyph(){return ut.GuitarVibratoStroke}get wideVibratoGlyph(){return ut.GuitarWideVibratoStroke}}class ic extends z{lineValue=0;constructor(t=0,e=0){super(t,e),this.lineValue=e}}class nc extends Ra{CS=[];ES=new Map;FS=-1;AS=-1;DS=-1;LS=-1;WS=-1;RS=-1;IS=-1;checkForOverflow=!1;constructor(){super(0,0)}addBends(t){this.CS.push(t);const e=this.OS(t);this.ES.set(t.id,e),(-1===this.IS||this.IS<t.maxBendPoint.value)&&(this.IS=t.maxBendPoint.value);let s=0;switch(t.bendType){case h.Bend:s=e[1].value,t.isTieOrigin?(-1===this.LS||s<this.LS)&&(this.LS=s):(-1===this.DS||s<this.DS)&&(this.DS=s);break;case h.Release:s=e[1].value,t.isTieOrigin?(-1===this.RS||s<this.RS)&&(this.RS=s):s>0&&(-1===this.WS||s<this.WS)&&(this.WS=s);break;case h.BendRelease:s=e[1].value,(-1===this.AS||s<this.AS)&&(this.AS=s),s=e[2].value,t.isTieOrigin?(-1===this.RS||s<this.RS)&&(this.RS=s):s>0&&(-1===this.WS||s<this.WS)&&(this.WS=s);break;case h.Prebend:s=e[0].value,(-1===this.FS||s<this.FS)&&(this.FS=s);break;case h.PrebendBend:s=e[0].value,(-1===this.FS||s<this.FS)&&(this.FS=s),s=e[1].value,t.isTieOrigin?(-1===this.LS||s<this.LS)&&(this.LS=s):(-1===this.DS||s<this.DS)&&(this.DS=s);break;case h.PrebendRelease:s=e[0].value,(-1===this.FS||s<this.FS)&&(this.FS=s),s=e[1].value,t.isTieOrigin?(-1===this.RS||s<this.RS)&&(this.RS=s):s>0&&(-1===this.WS||s<this.WS)&&(this.WS=s)}}doLayout(){super.doLayout(),this.GS();let t=0;for(const e of this.CS){const s=this.ES.get(e.id);switch(e.bendType){case h.Bend:s[1].lineValue=e.isTieOrigin?this.LS:this.DS;break;case h.Release:t=e.isTieOrigin?this.RS:this.WS,t>=0&&(s[1].lineValue=t);break;case h.BendRelease:s[1].lineValue=this.AS,t=e.isTieOrigin?this.RS:this.WS,t>=0&&(s[2].lineValue=t);break;case h.Prebend:s[0].lineValue=this.FS;break;case h.PrebendBend:s[0].lineValue=this.FS,s[1].lineValue=e.isTieOrigin?this.LS:this.DS;break;case h.PrebendRelease:s[0].lineValue=this.FS,t=e.isTieOrigin?this.RS:this.WS,t>=0&&(s[1].lineValue=t)}}this.width=0,this.CS.sort((t,e)=>t.isStringed?t.string-e.string:t.realValue-e.realValue)}GS(){const t=this.renderer.resources,e=this.renderer.smuflMetrics;let s=this.IS*e.tabBendPerValueHeight;s+=e.tabBendStaffPadding;const i=this.renderer.scoreRenderer.canvas;i.font=t.tablatureFont;s+=i.measureText("full").height+t.engravingSettings.tabBendLabelPadding,this.renderer.registerOverflowTop(s)}OS(t){const e=[];switch(t.bendType){case h.Custom:for(const s of t.bendPoints)e.push(new ic(s.offset,s.value));break;case h.BendRelease:e.push(new ic(0,t.bendPoints[0].value)),e.push(new ic(z.MaxPosition/2|0,t.bendPoints[1].value)),e.push(new ic(z.MaxPosition,t.bendPoints[3].value));break;case h.Bend:case h.Hold:case h.Prebend:case h.PrebendBend:case h.PrebendRelease:case h.Release:e.push(new ic(0,t.bendPoints[0].value)),e.push(new ic(z.MaxPosition,t.bendPoints[1].value))}return e}paint(t,e,s){const i=s.color;this.CS.length>1&&(s.color=this.renderer.resources.secondaryGlyphColor);for(const n of this.CS){const r=this.renderer;let a=n,o=!1,c=null,l=!1,u=null;for(;a.isTieOrigin;){const t=a.tieDestination;if(c=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,t.beat.voice.bar),!c||r.staff!==c.staff)break;if(a=t,o=!0,a.hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes||a.vibrato!==y.None){l=!0;break}}u=a.beat,c=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,u.voice.bar),u.isLastOfVoice&&!a.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(u=null);const d=r.smuflMetrics,f=d.glyphWidths.get(ut.ArrowheadBlackDown),p=e+r.y-d.tabBendStaffPadding;let b=t+r.x;const m=this.ES.get(n.id);m[0].value>0||n.isContinuedBend?b+=r.getBeatX(n.beat,ms.MiddleNotes):b+=r.getNoteX(n,Bh.Right);let g=0;!u||u.isLastOfVoice&&!l?(g=t+c.x+c.postBeatGlyphsStart,g-=this.renderer.smuflMetrics.postNoteEffectPadding):l||!u.nextBeat?g=t+c.x+c.getBeatX(u,ms.MiddleNotes):n.bendType===h.Hold?g=t+c.x+c.getBeatX(u.nextBeat,ms.OnNotes):(g=t+c.x+c.getBeatX(u.nextBeat,ms.PreNotes),g-=this.renderer.smuflMetrics.postNoteEffectPadding),o||(g-=f/2),this.VS(s,b,p,g,r,n,m),this.$S(s,t,g+f/2,p-d.tabBendPerValueHeight*m[m.length-1].lineValue,c,a),s.color=i}}$S(t,e,s,i,n,r){if(r.isTieDestination&&r.vibrato!==y.None&&!r.hasBend){const a=e+n.x,h=new sc(s-a,0,r.vibrato);h.beat=r.beat,h.renderer=n,h.doLayout(),h.paint(a,i,t)}}VS(t,e,s,i,n,r,a){const o=t.lineWidth,c=this.renderer.resources,l=t.textBaseline;t.textBaseline=ot.Alphabetic,t.lineWidth=c.engravingSettings.arrowShaftThickness;const u=(i-e)/z.MaxPosition;for(let i=0,o=a.length-1;i<o;i++){const o=a[i];let c=a[i+1];0!==i||0===o.value||r.isTieDestination||this.HS(t,e,s,u,n,r,new ic(0,0),o),r.bendType!==h.Prebend?(0===i&&(e+=this.renderer.smuflMetrics.postNoteEffectPadding),this.HS(t,e,s,u,n,r,o,c)):r.isTieOrigin&&r.tieDestination.hasBend&&(c=new ic(z.MaxPosition,o.value),c.lineValue=o.lineValue,this.HS(t,e,s,u,n,r,o,c))}t.lineWidth=o,t.textBaseline=l}US(t,e,s,i,n,r,a){if(r.value===a.value){if(r.lineValue>0){let n=i;const r=this.renderer.smuflMetrics.tabBendDashSize,a=e+r;if((n-e)/(2*r)<1)t.moveTo(n,s),t.lineTo(e,s);else for(;n>a;)t.moveTo(n,s),t.lineTo(n-r,s),n-=2*r;t.stroke()}}else if(i>e){const h=a.value>r.value?3:-3;t.moveTo(e,s),t.bezierCurveTo((e+i)/2,s,i,s,i,n+h),t.stroke()}else t.moveTo(e,s),t.lineTo(i,n),t.stroke()}HS(t,e,s,i,n,r,a,h){const o=n.lineOffset/2,c=n.resources,l=c.engravingSettings,u=e+i*a.offset;let d;0===a.value?(d=s+l.tabBendStaffPadding,h.offset===a.offset?d+=n.getNoteY(r.beat.maxStringNote,Sh.Top)-o:d+=n.getNoteY(r,Sh.Center)):d=s-l.tabBendPerValueHeight*a.lineValue;const f=e+i*h.offset;let p;p=0===h.lineValue?s+l.tabBendStaffPadding+n.getNoteY(r.beat.maxStringNote,Sh.Center):s-l.tabBendPerValueHeight*h.lineValue,this.US(t,u,d,f,p,a,h);const b=l.glyphWidths.get(ut.ArrowheadBlackDown);if(a.value!==h.value){const e=h.value>a.value;this.zS(t,f,p,d,b,e),this.XS(t,u,d,f,p,r,c.graceFont),this.jS(t,d,f,p-l.tabBendLabelPadding,a,h,c.tablatureFont)}}XS(t,e,s,i,n,r,h){if(r.bendStyle===a.Gradual){const r="grad.",a=t.measureText(r);t.font=h;let o=0,c=0;if(s>n){const t=Math.abs(s-n);o=t>a.height?s-t/2:s,c=(e+i-a.width)/2}else o=s,c=i-a.width;t.fillText(r,c,o)}}jS(t,e,s,i,n,r,a){if(0!==r.value){const h=r.value>n.value;let o=r.value,c="";if(4===o)c="full",o-=4;else if(o>=4||o<=-4){const t=o/4|0;c+=t,o-=4*t}if(o>0&&(c+=nc.getFractionSign(o)),""!==c){const n=h?i:e+1*Math.abs(i-e)/3;t.font=a;const r=s-t.measureText(c).width/2;t.fillText(c,r,n)}}}zS(t,e,s,i,n,r){r?(s+n>i&&(s=i-n),t.beginPath(),t.moveTo(e,s),t.lineTo(e-.5*n,s+n),t.lineTo(e+.5*n,s+n),t.closePath(),t.fill()):(s<i&&(s=i+n),t.beginPath(),t.moveTo(e,s),t.lineTo(e-.5*n,s-n),t.lineTo(e+.5*n,s-n),t.closePath(),t.fill())}static getFractionSign(t){switch(t){case 1:return"¼";case 2:return"½";case 3:return"¾";default:return`${t}/ 4`}}}class rc extends Eh{Ne;ES;JS=!1;originalTopOffset=0;originalBottomOffset=0;topOffset=0;bottomOffset=0;constructor(t){super(0,0),this.Ne=t,this.ES=this.OS(t)}OS(t){if(t.whammyBarType===bt.Custom)return t.whammyBarPoints;const e=[];switch(t.whammyBarType){case bt.Dive:case bt.Hold:case bt.PrediveDive:case bt.Predive:e.push(new z(0,t.whammyBarPoints[0].value)),e.push(new z(z.MaxPosition,t.whammyBarPoints[1].value));break;case bt.Dip:e.push(new z(0,t.whammyBarPoints[0].value)),e.push(new z(z.MaxPosition/2|0,t.whammyBarPoints[1].value)),e.push(new z(z.MaxPosition,t.whammyBarPoints[t.whammyBarPoints.length-1].value))}return e}doLayout(){if(super.doLayout(),this.Ne.whammyBarType===bt.Custom)return;this.JS=this.renderer.settings.notation.notationMode===t.NotationMode.SongBook&&this.Ne.whammyBarType===bt.Dip;const e=this.Ne.minWhammyPoint,s=this.Ne.maxWhammyPoint;let i=s.value>0?-this.qS(s.value):0,n=e.value<0?-this.qS(e.value):0;const r=this.renderer.scoreRenderer.canvas;r.font=this.renderer.resources.tablatureFont;const a=r.measureText("-1").height+this.renderer.smuflMetrics.tabWhammyTextPadding;if((0!==i||0!==this.Ne.whammyBarPoints[0].value||this.renderer.settings.notation.isNotationElementVisible(t.NotationElement.ZerosOnDiveWhammys))&&(i-=a),0!==n)if(this.JS)i-=a;else{const t=n-a;t<i&&(i=t)}i=Math.abs(i),n=Math.abs(n),this.topOffset=i,this.bottomOffset=n,this.originalTopOffset=i,this.originalBottomOffset=n,this.height=i+n,this.width=0}qS(t){if(0===t)return 0;let e=this.renderer.smuflMetrics.tabWhammyPerHalfHeight+Math.log2(Math.abs(t)/2)*this.renderer.smuflMetrics.tabWhammyPerHalfHeight;return t<0&&(e=-e),e}paint(e,s,i){const n=ro.beat(i,_t.StandardNotationEffects,this.Ne);try{const n=this.renderer;let r=this.Ne.nextBeat,h=null,o=ms.PreNotes;r&&(h=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,r.voice.bar),h&&h.staff===n.staff&&(h===n||r.hasWhammyBar)?o=!r.hasWhammyBar||n.settings.notation.notationMode===t.NotationMode.SongBook&&r.whammyBarType===bt.Dip?ms.PreNotes:ms.MiddleNotes:(r=null,h=null));let c=0,l=0;this.JS?(c=e+n.getBeatX(this.Ne,ms.OnNotes,!0),l=e+n.getBeatX(this.Ne,ms.PostNotes,!0)):(c=e+n.getBeatX(this.Ne,ms.MiddleNotes,!0),l=h?e-n.x+h.x+h.getBeatX(r,o,!0):e+n.getBeatX(this.Ne,ms.EndBeat)-n.smuflMetrics.postNoteEffectPadding);const u=i.textAlign,d=i.textBaseline;if(i.textAlign=ht.Center,i.textBaseline=ot.Alphabetic,i.font=this.renderer.resources.tablatureFont,this.ES.length>=2){const t=(l-c)/z.MaxPosition;i.beginPath();const e=s+this.topOffset;let n=this.Ne.whammyStyle===a.Gradual?"grad.":"";for(let s=0,r=this.ES.length-1;s<r;s++){const r=this.ES[s],a=this.ES[s+1];let h=0===s;0!==s||0===r.value||this.Ne.isContinuedWhammy||(this.YS(!1,new z(0,0),r,c,e,t,i),h=!1),this.YS(h,r,a,c,e,t,i,n),n=""}i.stroke()}i.textAlign=u,i.textBaseline=d}finally{n?.[Symbol.dispose]?.()}}YS(e,s,i,n,r,a,h,o){const c=n+a*s.offset,l=n+a*i.offset,u=r-this.qS(s.value),d=r-this.qS(i.value);if(s.offset===i.offset){const t=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(d-u)/(2*t)<1)h.moveTo(c,u),h.lineTo(l,d);else{const e=Math.max(u,d);let s=Math.min(u,d);for(;e>s;)h.moveTo(c,s),h.lineTo(c,s+t),s+=2*t}h.stroke()}else if(s.value===i.value){const t=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(l-c)/(2*t)<1)h.moveTo(c,u),h.lineTo(l,d);else{let e=Math.max(c,l);const s=Math.min(c,l);for(;e>s;)h.moveTo(e,u),h.lineTo(e-t,u),e-=2*t}h.stroke()}else h.moveTo(c,u),h.lineTo(l,d);const f=this.renderer.smuflMetrics.tabWhammyTextPadding;!e||this.Ne.isContinuedWhammy||this.JS||(this.renderer.settings.notation.isNotationElementVisible(t.NotationElement.ZerosOnDiveWhammys)&&h.fillText("0",c,u-f),o&&h.fillText(o,c,u-f));let p=Math.abs(i.value);if((0!==p||this.renderer.settings.notation.isNotationElementVisible(t.NotationElement.ZerosOnDiveWhammys)&&!this.JS)&&s.value!==i.value){let t="";if(i.value<0&&(t+="-"),p>=4){const e=p/4|0;t+=e,p-=4*e}else 0===p&&(t+="0");p>0&&(t+=nc.getFractionSign(p));let e=0;e=this.JS||s.offset===i.offset?Math.min(u,d):d;const n=l;h.fillText(t,n,e-f)}}}class ac extends Ah{get notationElement(){return t.NotationElement.EffectWhammyBar}get effectId(){return`${super.effectId}.simpledip`}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(e,s){return e.notation.notationMode===t.NotationMode.SongBook&&s.hasWhammyBar&&s.whammyBarType===bt.Dip}createNewGlyph(t,e){return new rc(e)}canExpand(t,e){return!0}}class hc extends ec{get slightVibratoGlyph(){return ut.WiggleSawtoothNarrow}get wideVibratoGlyph(){return ut.WiggleSawtooth}}class oc extends Ah{get notationElement(){return t.NotationElement.EffectSlightBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return kh.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.vibrato===y.Slight}createNewGlyph(t,e){return new hc(0,0,y.Slight)}canExpand(t,e){return!0}}class cc extends po{KS;get notationElement(){return t.NotationElement.EffectSlightNoteVibrato}shouldCreateGlyphForNote(t){let e=t.vibrato===y.Slight||t.isTieDestination&&t.tieOrigin.vibrato===y.Slight;return this.KS&&e&&t.isTieDestination&&t.tieOrigin.hasBend&&(e=!1),e}get sizingMode(){return kh.GroupedOnBeatToEnd}createNewGlyph(t,e){return new sc(0,0,y.Slight)}constructor(t){super(),this.KS=t}}class lc extends Eh{constructor(){super(0,0)}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(ut.KeyboardPedalPed)}paint(t,e,s){const i=this.renderer,n=e+this.y,r=this.height,a=i.bar.sustainPedals,h=this.renderer.smuflMetrics.glyphWidths.get(ut.KeyboardPedalPed),o=this.renderer.smuflMetrics.glyphWidths.get(ut.KeyboardPedalUp);let c=0;for(;c<a.length;){let e=a[c];for(;null!=e;){const i=t+this.renderer.getRatioPositionX(e.ratioPosition);let l=0;if(e.pedalType===C.Down?(Ot.fillMusicFontSymbolSafe(s,i,n+r,1,ut.KeyboardPedalPed,!0),l=h/2+this.renderer.smuflMetrics.sustainPedalLinePadding):e.pedalType===C.Up&&(Ot.fillMusicFontSymbolSafe(s,i,n+r,1,ut.KeyboardPedalUp,!0),l=o/2+this.renderer.smuflMetrics.sustainPedalLinePadding),e.nextPedalMarker)if(e.nextPedalMarker.bar===e.bar){let a=t+this.renderer.getRatioPositionX(e.nextPedalMarker.ratioPosition);switch(e.nextPedalMarker.pedalType){case C.Down:a-=h/2;break;case C.Hold:break;case C.Up:a-=o/2}const c=i+l;a>c&&s.fillRect(c,n+r-this.renderer.smuflMetrics.pedalLineThickness,a-c,this.renderer.smuflMetrics.pedalLineThickness)}else{const e=t+this.x+this.width,a=i+l;s.fillRect(a,n+r-this.renderer.smuflMetrics.pedalLineThickness,e-a,this.renderer.smuflMetrics.pedalLineThickness)}if(0===c&&e.previousPedalMarker){const e=t+this.x,a=i-l;s.fillRect(e,n+r-this.renderer.smuflMetrics.pedalLineThickness,a-e,this.renderer.smuflMetrics.pedalLineThickness)}c++,null!=e.nextPedalMarker&&e.nextPedalMarker.bar!==e.bar?(e=null,c=a.length):e=e.nextPedalMarker}}}}class uc extends Ah{get notationElement(){return t.NotationElement.EffectSustainPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return kh.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&e.voice.bar.sustainPedals.length>0}createNewGlyph(t,e){return new lc}canExpand(t,e){return!0}}class dc extends Ah{get notationElement(){return t.NotationElement.EffectWhammyBarLine}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return kh.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.hasWhammyBar}createNewGlyph(t,e){return new rc(e)}canExpand(t,e){return e.hasWhammyBar}static offsetSharedDataKey="tab.whammy.offset";onAlignGlyphs(t){const e=t.renderer.staff.getSharedLayoutData(dc.offsetSharedDataKey,[0,0]);t.renderer.staff.setSharedLayoutData(dc.offsetSharedDataKey,e);for(const s of t.iterateAllGlyphs()){const t=s;t.originalTopOffset>e[0]&&(e[0]=t.originalTopOffset),t.originalBottomOffset>e[1]&&(e[1]=t.originalBottomOffset)}}finalizeBand(t){const e=t.renderer.staff.getSharedLayoutData(dc.offsetSharedDataKey,[0,0]),s=e[0],i=e[1];for(const e of t.iterateAllGlyphs()){const t=e;t.topOffset=s,t.bottomOffset=i,t.height=s+i}t.slot.shared.height=s+i,t.height=s+i}}class fc extends Ah{get notationElement(){return t.NotationElement.EffectTap}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(t,e){return e.slap||e.pop||e.tap}createNewGlyph(e,s){const i=e.resources;return s.slap?new Gh(0,0,"S",i.elementFonts.get(t.NotationElement.EffectTap),ht.Center):s.pop?new Gh(0,0,"P",i.elementFonts.get(t.NotationElement.EffectTap),ht.Center):new Gh(0,0,"T",i.elementFonts.get(t.NotationElement.EffectTap),ht.Center)}canExpand(t,e){return!0}}class pc extends Eh{QS;constructor(t){super(0,0),this.QS=t}doLayout(){super.doLayout();const t=this.renderer.resources;this.height=this.renderer.smuflMetrics.glyphHeights.get(ut.MetNoteQuarterUp)*t.engravingSettings.tempoNoteScale}paint(e,s,i){for(const n of this.QS){let r=e+this.renderer.getRatioPositionX(n.ratioPosition);const a=this.renderer.resources;i.font=a.elementFonts.get(t.NotationElement.EffectMarker);const h=s+this.y+this.height+this.renderer.smuflMetrics.glyphBottom.get(ut.MetNoteQuarterUp)*a.engravingSettings.tempoNoteScale,o=i.textBaseline;if(i.textBaseline=ot.Alphabetic,n.text){const t=`${n.text} `,e=i.measureText(t);i.fillText(t,r,h),r+=e.width}else r-=a.engravingSettings.glyphWidths.get(ut.MetNoteQuarterUp)/2;Ot.fillMusicFontSymbolSafe(i,r,h,a.engravingSettings.tempoNoteScale,ut.MetNoteQuarterUp),r+=this.renderer.smuflMetrics.glyphWidths.get(ut.MetNoteQuarterUp)*a.engravingSettings.tempoNoteScale,i.fillText(` = ${n.value.toString()}`,r,h),i.textBaseline=o,r+=i.measureText(` = ${n.value.toString()}`).width}}}class bc extends Ah{get notationElement(){return t.NotationElement.EffectTempo}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return kh.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&e.voice.bar.masterBar.tempoAutomations.some(t=>t.isVisible)}createNewGlyph(t,e){return new pc(e.voice.bar.masterBar.tempoAutomations.filter(t=>t.isVisible))}canExpand(t,e){return!0}}class mc extends Ah{get notationElement(){return t.NotationElement.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(t,e){return!!e.text}createNewGlyph(e,s){return new Gh(0,0,s.text,e.resources.elementFonts.get(t.NotationElement.EffectText),ht.Left)}canExpand(t,e){return!0}}class gc extends Lh{constructor(t,e){super(ms.EndBeat),this.x=t,this.y=e}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(ut.OrnamentTrill)}paintGrouped(t,e,s,i){const n=this.renderer.smuflMetrics.glyphWidths.get(ut.OrnamentTrill),r=t+this.x+n,a=this.renderer.smuflMetrics.repeatOffsetX.get(ut.WiggleTrill),h=Math.ceil((s-r)/a),o=[ut.OrnamentTrill];for(let t=0;t<h;t++)o.push(ut.WiggleTrill);i.fillMusicFontSymbols(t+this.x-n/2,e+this.y+this.height,1,o,!1)}}class wc extends po{get notationElement(){return t.NotationElement.EffectTrill}shouldCreateGlyphForNote(t){return t.isTrill}get sizingMode(){return kh.GroupedOnBeatToEnd}createNewGlyph(t,e){return new gc(0,0)}}!function(t){t[t.EighthEighth=0]="EighthEighth",t[t.SixteenthSixteenth=1]="SixteenthSixteenth",t[t.QuarterTripletEighthTriplet=2]="QuarterTripletEighthTriplet",t[t.EighthSixteenthTriplet=3]="EighthSixteenthTriplet",t[t.EighthDottedSixteenth=4]="EighthDottedSixteenth",t[t.SixteenthDottedThirtySecond=5]="SixteenthDottedThirtySecond",t[t.SixteenthEighthDotted=6]="SixteenthEighthDotted",t[t.ThirtySecondSixteenthDotted=7]="ThirtySecondSixteenthDotted"}(_h||(_h={}));class yc extends Eh{ZS;tB=0;eB=0;constructor(t){super(0,0),this.ZS=t}doLayout(){super.doLayout();const t=this.renderer.smuflMetrics.tempoNoteScale;this.height=this.renderer.smuflMetrics.glyphHeights.get(ut.MetNoteQuarterUp)*t,this.tB=this.renderer.smuflMetrics.glyphHeights.get(ut.Tuplet3)*t,this.eB=this.renderer.smuflMetrics.tripletFeelBracketPadding,this.height+=this.tB}paint(e,s,i){e+=this.x,s+=this.y;let n=_h.EighthEighth,r=_h.EighthEighth;switch(this.ZS){case A.NoTripletFeel:n=_h.EighthEighth,r=_h.EighthEighth;break;case A.Triplet8th:n=_h.EighthEighth,r=_h.QuarterTripletEighthTriplet;break;case A.Triplet16th:n=_h.SixteenthSixteenth,r=_h.EighthSixteenthTriplet;break;case A.Dotted8th:n=_h.EighthEighth,r=_h.EighthDottedSixteenth;break;case A.Dotted16th:n=_h.SixteenthSixteenth,r=_h.SixteenthDottedThirtySecond;break;case A.Scottish8th:n=_h.EighthEighth,r=_h.SixteenthEighthDotted;break;case A.Scottish16th:n=_h.SixteenthSixteenth,r=_h.ThirtySecondSixteenthDotted}const a=this.renderer.smuflMetrics.tempoNoteScale,h=s+this.renderer.smuflMetrics.glyphTop.get(ut.MetNoteQuarterUp)*a,o=s+this.height,c=i.textBaseline;i.textBaseline=ot.Bottom,i.font=this.renderer.resources.elementFonts.get(t.NotationElement.EffectTripletFeel),i.fillText("(",e,o),e+=i.measureText("( ").width,e=this.sB(e,h+this.tB,i,n),i.fillText(" = ",e,o),e+=i.measureText(" = ").width,e=this.sB(e,h+this.tB,i,r),i.fillText(" )",e,o),i.textBaseline=c}sB(t,e,s,i){const n=this.renderer.smuflMetrics.tempoNoteScale;let r=[],a=[];const h=[];let o=ut.None;switch(i){case _h.EighthEighth:h.push(ht.Center),r=[ut.MetNoteQuarterUp],a=[ut.MetNoteQuarterUp];break;case _h.SixteenthSixteenth:h.push(ht.Center),h.push(ht.Center),r=[ut.MetNoteQuarterUp],a=[ut.MetNoteQuarterUp];break;case _h.QuarterTripletEighthTriplet:r=[ut.MetNoteQuarterUp],a=[ut.MetNote8thUp],o=ut.Tuplet3;break;case _h.EighthSixteenthTriplet:h.push(ht.Center),h.push(ht.Right),r=[ut.MetNoteQuarterUp],a=[ut.MetNoteQuarterUp],o=ut.Tuplet3;break;case _h.EighthDottedSixteenth:h.push(ht.Center),h.push(ht.Right),r=[ut.MetNoteQuarterUp,ut.Space,ut.MetAugmentationDot],a=[ut.MetNoteQuarterUp];break;case _h.SixteenthDottedThirtySecond:h.push(ht.Center),h.push(ht.Center),h.push(ht.Right),r=[ut.MetNoteQuarterUp,ut.Space,ut.MetAugmentationDot],a=[ut.MetNoteQuarterUp];break;case _h.SixteenthEighthDotted:h.push(ht.Center),h.push(ht.Left),r=[ut.MetNoteQuarterUp],a=[ut.MetNoteQuarterUp,ut.Space,ut.MetAugmentationDot];break;case _h.ThirtySecondSixteenthDotted:h.push(ht.Center),h.push(ht.Center),h.push(ht.Left),r=[ut.MetNoteQuarterUp],a=[ut.MetNoteQuarterUp,ut.Space,ut.MetAugmentationDot]}const c=this.renderer.smuflMetrics.glyphWidths.get(ut.MetNoteQuarterUp)*n,l=t+c-this.renderer.smuflMetrics.stemThickness*n,u=l+2*c+this.renderer.smuflMetrics.stemThickness*n,d=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamThickness,f=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamSpacing,p=this.renderer.smuflMetrics.brokenBeamWidth*n;let b=e-this.renderer.smuflMetrics.glyphHeights.get(ut.MetNoteQuarterUp)*n+d;if(o!==ut.None){const e=(t+u)/2,i=b-this.tB-this.eB,r=this.renderer.smuflMetrics.glyphTop.get(o)*n,a=this.renderer.smuflMetrics.glyphWidths.get(o)*n;Ot.fillMusicFontSymbolSafe(s,e,i+r,n,o,!0);const h=e-a/2-this.eB,c=e+a/2+this.eB,l=this.tB/2,d=s.lineWidth;s.beginPath(),s.moveTo(t,i+l+l),s.lineTo(t,i+l),s.lineTo(h,i+l),s.moveTo(c,i+l),s.lineTo(u,i+l),s.lineTo(u,i+l+l),s.lineWidth=this.renderer.smuflMetrics.tupletBracketThickness*n,s.stroke(),s.lineWidth=d}s.fillMusicFontSymbols(t,e,n,r,!1),t+=c,t+=c,s.fillMusicFontSymbols(t,e,n,a,!1),t+=c,a[a.length-1]!==ut.MetAugmentationDot&&a[0]!==ut.MetNote8thUp||(t+=c);for(const t of h){switch(t){case ht.Left:s.fillRect(l,b,p,d);break;case ht.Center:s.fillRect(l,b,u-l,d);break;case ht.Right:s.fillRect(u-p,b,p,d)}b+=d+f}return t}}class kc extends Ah{get notationElement(){return t.NotationElement.EffectTripletFeel}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return kh.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.index&&(0===e.voice.bar.masterBar.index&&e.voice.bar.masterBar.tripletFeel!==A.NoTripletFeel||e.voice.bar.masterBar.index>0&&e.voice.bar.masterBar.tripletFeel!==e.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(t,e){return new yc(e.voice.bar.masterBar.tripletFeel)}canExpand(t,e){return!0}}class Sc extends Yh{constructor(t){super(0,0,1,Sc.ik(t)),this.center=!0}static ik(t){switch(t){case wt.Open:return ut.GuitarOpenPedal;case wt.Closed:return ut.GuitarClosePedal}return ut.None}paint(t,e,s){super.paint(t,e+this.height,s)}}class Bc extends Ah{get notationElement(){return t.NotationElement.EffectWahPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return kh.SingleOnBeat}shouldCreateGlyph(t,e){return e.wahPedal!==wt.None}createNewGlyph(t,e){return new Sc(e.wahPedal)}canExpand(t,e){return!1}}class _c extends Ah{get notationElement(){return t.NotationElement.EffectWhammyBar}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return kh.GroupedOnBeat}shouldCreateGlyph(t,e){return e.hasWhammyBar}createNewGlyph(e,s){return new Wh("w/bar",t.NotationElement.EffectWhammyBar)}canExpand(t,e){return!0}}class Tc extends Ah{get notationElement(){return t.NotationElement.EffectWideBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return kh.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.vibrato===y.Wide}createNewGlyph(t,e){return new hc(0,0,y.Wide)}canExpand(t,e){return!0}}class xc extends po{get notationElement(){return t.NotationElement.EffectWideNoteVibrato}shouldCreateGlyphForNote(t){return t.vibrato===y.Wide||t.isTieDestination&&t.tieOrigin.vibrato===y.Wide}get sizingMode(){return kh.GroupedOnBeatToEnd}createNewGlyph(t,e){return new sc(0,0,y.Wide)}}class Mc extends no{iB=0;nB;constructor(t,e,s=ht.Center){super(t,e),this.glyphs=[],this.nB=s}doLayout(){const t=this.renderer.smuflMetrics.rowContainerGap,e=this.iB-t;let s=0;switch(this.nB){case ht.Left:s=0;break;case ht.Center:s=(this.width-e)/2;break;case ht.Right:s=this.width-e}for(const e of this.glyphs)e.x=s,s+=e.width+t}addGlyphToRow(t){this.glyphs.push(t),this.iB+=t.width+this.renderer.smuflMetrics.rowContainerGap,t.height>this.height&&(this.height=t.height)}}class vc extends no{rB=[];nB;constructor(t,e,s=ht.Center){super(t,e),this.height=0,this.glyphs=[],this.nB=s}doLayout(){let t=0,e=0;const s=this.renderer.smuflMetrics.rowContainerGap;this.rB=[];let i=new Mc(t,e,this.nB);i.renderer=this.renderer,i.width=this.width;for(const n of this.glyphs){const r=t+n.width+s;r<this.width?(i.addGlyphToRow(n),t=Math.ceil(r)):(i.isEmpty||(i.doLayout(),this.rB.push(i),e+=i.height+s),t=0,i=new Mc(t,e,this.nB),i.renderer=this.renderer,i.width=this.width,i.addGlyphToRow(n),t+=Math.ceil(n.width+s))}i.isEmpty||(i.doLayout(),this.rB.push(i),e+=Math.ceil(i.height+this.renderer.smuflMetrics.rowContainerPadding)),this.height=e}paint(t,e,s){for(const i of this.rB)i.paint(t+this.x,e+this.y,s)}}class Nc extends vc{addChord(e){if(e.strings.length>0){const s=new $h(0,0,e,t.NotationElement.ChordDiagrams);s.renderer=this.renderer,s.doLayout(),this.glyphs.push(s)}}paint(t,e,s){if(this.glyphs.length>0){const i=ro.score(s,ct.ChordDiagramList,this.renderer.scoreRenderer.score);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}}class Pc extends vc{constructor(t,e){super(t,e,ht.Left)}}class Cc extends no{aB;hB;colorOverride;constructor(t,e,s,i){super(t,e),this.aB=s,this.hB=i,this.glyphs=[]}doLayout(){if(!(this.glyphs.length>0)){this.oB(this.aB);for(const t of this.glyphs)t.renderer=this.renderer,t.doLayout()}}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),super.paint(t,e,s),s.color=i}oB(e){const s=this.renderer.resources;if(this.height=0,this.hB.length>0){const e=new Gh(0,this.height,this.hB,s.elementFonts.get(t.NotationElement.GuitarTuning),ht.Left);e.renderer=this.renderer,e.doLayout(),this.height+=e.height,this.addGlyph(e)}if(e.name.length>0){const i=new Gh(0,this.height,e.name,s.elementFonts.get(t.NotationElement.GuitarTuning),ht.Left);i.renderer=this.renderer,i.doLayout(),this.height+=i.height,this.addGlyph(i)}const i=this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,n=this.renderer.smuflMetrics.glyphHeights.get(ut.GuitarString0)*i;this.renderer.scoreRenderer.canvas.font=s.elementFonts.get(t.NotationElement.GuitarTuning);const r=(n+this.renderer.scoreRenderer.canvas.measureText(" = Gb").width)*s.engravingSettings.tuningGlyphStringColumnScale;if(this.width=Math.max(this.renderer.scoreRenderer.canvas.measureText(this.hB).width,Math.max(this.renderer.scoreRenderer.canvas.measureText(e.name).width,2*r)),!e.isStandard){const a=0|Math.ceil(e.tunings.length/2);let h=0;const o=this.height+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;let c=o;for(let l=0,u=e.tunings.length;l<u;l++){const u=ut.GuitarString0+(l+1);this.addGlyph(new Yh(h,c+n,i,u));const d=` = ${xe.getTextForTuning(e.tunings[l],!1)}`;this.addGlyph(new Gh(h+n,c+n/2,d,s.elementFonts.get(t.NotationElement.GuitarTuning),ht.Left,ot.Middle)),c+=n+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;const f=c;this.height<f&&(this.height=f),l===a-1&&(c=o,h+=r)}}}}class Ec{Hn=new Map;clear(){this.Hn.clear()}startMultiSystemSlur(t){const e=Ec.cB(t.renderer.staff);let s;this.Hn.has(e)?s=this.Hn.get(e):(s={startedSlurs:new Map},this.Hn.set(e,s)),s.startedSlurs.set(t.slurEffectId,{startGlyph:t})}static cB(t){return`${t.modelStaff.index}.${t.modelStaff.track.index}.${t.staffId}`}completeMultiSystemSlur(t){const e=Ec.cB(t.renderer.staff);if(!this.Hn.has(e))return;const s=this.Hn.get(e);if(s.startedSlurs.has(t.slurEffectId)){const e=s.startedSlurs.get(t.slurEffectId);return e.endGlyph=t,e.startGlyph}}*getAllContinuations(t){const e=Ec.cB(t.staff);if(!this.Hn.has(e)||t.index>0)return;const s=this.Hn.get(e);for(const e of s.startedSlurs.values())e.startGlyph.shouldCreateMultiSystemSlur(t)&&(yield e.startGlyph)}}class Fc{v;lB=new Map;staffTrackGroup;system;barRenderers=[];x=0;y=0;height=0;index=0;staffIndex=0;isVisible=!1;uB=0;get isFirstInSystem(){return this.system.firstVisibleStaff===this}topEffectInfos=[];bottomEffectInfos=[];trackIndex=0;modelStaff;get staffId(){return this.v.staffId}staffTop=0;topPadding=0;bottomPadding=0;staffBottom=0;get contentTop(){return this.y+this.staffTop+this.topPadding+this.topOverflow}get contentBottom(){return this.y+this.topPadding+this.topOverflow+this.staffBottom}constructor(t,e,s,i){this.v=i,this.trackIndex=e,this.modelStaff=s,this.system=t;for(const t of i.effectBands)if(!t.shouldCreate||t.shouldCreate(s))switch(t.mode){case yh.OwnedTop:case yh.SharedTop:this.topEffectInfos.push(t);break;case yh.OwnedBottom:case yh.SharedBottom:this.bottomEffectInfos.push(t)}this.dB()}getSharedLayoutData(t,e){return this.lB.has(t)?this.lB.get(t):e}setSharedLayoutData(t,e){this.lB.set(t,e)}registerStaffTop(t){t>this.staffTop&&(this.staffTop=t)}registerStaffBottom(t){t>this.staffBottom&&(this.staffBottom=t)}addBarRenderer(t){t.staff=this,t.index=this.barRenderers.length,t.reLayout(),this.barRenderers.push(t),this.system.layout.registerBarRenderer(this.staffId,t),(t.bar.isEmpty||t.bar.isRestOnly)&&this.uB++,this.dB()}dB(){const t=this.modelStaff.track.score.stylesheet,e=t.hideEmptyStaves&&(t.hideEmptyStavesInFirstSystem||this.system.index>0);this.isVisible=!e||this.uB<this.barRenderers.length}addBar(t,e,s){const i=this.v.create(this.system.layout.renderer,t);i.topEffects.infos=this.topEffectInfos,i.bottomEffects.infos=this.bottomEffectInfos,i.additionalMultiRestBars=s,i.staff=this,i.index=this.barRenderers.length,i.layoutingInfo=e,i.doLayout(),this.barRenderers.push(i),this.system.layout.registerBarRenderer(this.staffId,i),(t.isEmpty||t.isRestOnly)&&this.uB++,this.dB()}revertLastBar(){this.resetSharedLayoutData();const t=this.barRenderers[this.barRenderers.length-1];this.barRenderers.splice(this.barRenderers.length-1,1),this.topOverflow=0,this.bottomOverflow=0;for(const t of this.barRenderers)t.afterStaffBarReverted();return(t.bar.isEmpty||t.bar.isRestOnly)&&this.uB--,this.dB(),t}resetSharedLayoutData(){this.lB.clear()}topOverflow=0;registerOverflowTop(t){t>this.topOverflow&&(this.topOverflow=t)}bottomOverflow=0;registerOverflowBottom(t){t>this.bottomOverflow&&(this.bottomOverflow=t)}calculateHeightForAccolade(){this.fB(),this.height=this.barRenderers.length>0?this.barRenderers[0].height:0,this.height>0&&(this.height+=Math.ceil(this.topPadding+this.topOverflow+this.bottomOverflow+this.bottomPadding))}fB(){const t=0===this.index,e=this.index===this.system.staves.length-1,s=this.system.layout.renderer.settings.display;this.topPadding=t?s.firstNotationStaffPaddingTop:s.notationStaffPaddingTop,this.bottomPadding=e?s.lastNotationStaffPaddingBottom:s.notationStaffPaddingBottom}finalizeStaff(){this.fB(),this.height=0;let t=!1,e=this.topOverflow;for(const e of this.barRenderers)e.registerMultiSystemSlurs(this.system.layout.slurRegistry.getAllContinuations(e)),e.finalizeRenderer()&&(t=!0),this.height=Math.max(this.height,e.height);if(t){e=this.topOverflow;for(const t of this.barRenderers)t.y=this.topPadding+e;for(const t of this.barRenderers)t.finalizeRenderer()}this.height>0&&(this.height+=this.topPadding+e+this.bottomOverflow+this.bottomPadding),this.height=Math.ceil(this.height),this.dB()}paint(t,e,s,i,n){if(0!==this.height&&0!==n)for(let r=i,a=Math.min(i+n,this.barRenderers.length);r<a;r++)this.barRenderers[r].paint(t+this.x,e+this.y,s)}}class Ac{timePosition=0;longestDuration=0;smallestDuration=0;force=0;springConstant=0;get springWidth(){return this.preSpringWidth+this.postSpringWidth}preBeatWidth=0;graceBeatWidth=0;postSpringWidth=0;get preSpringWidth(){return this.preBeatWidth+this.graceBeatWidth}allDurations=new Set}class Dc{static pB=30;static bB=7;mB=[];gB=-1;wB=0;yB=new Map;kB=0;SB=new Map;BB=Dc.pB;version=0;preBeatSize=0;postBeatSize=0;minStretchForce=0;totalSpringConstant=0;_B(t){this.minStretchForce<t&&(this.minStretchForce=t)}getBeatSizes(t){const e=t.absoluteDisplayStart;if(this.SB.has(e))return this.SB.get(e)}setBeatSizes(t,e){const s=t.absoluteDisplayStart;if(this.SB.has(s)){const t=this.SB.get(s);t.onBeatSize<e.onBeatSize&&(t.onBeatSize=e.onBeatSize),t.preBeatSize<e.preBeatSize&&(t.preBeatSize=e.preBeatSize)}else this.SB.set(s,e)}getPreBeatSize(t){if(t.graceType!==u.None){const e=t.graceGroup.id;return this.allGraceRods.get(e)[t.graceIndex].preBeatWidth}const e=t.absoluteDisplayStart;return this.springs.has(e)?this.springs.get(e).preBeatWidth:0}getPostBeatSize(t){if(t.graceType!==u.None){const e=t.graceGroup.id;return this.allGraceRods.get(e)[t.graceIndex].postSpringWidth}const e=t.absoluteDisplayStart;return this.springs.has(e)?this.springs.get(e).postSpringWidth:0}incompleteGraceRods=new Map;allGraceRods=new Map;springs=new Map;addSpring(t,e,s,i,n){let r;if(this.version++,this.springs.has(t))r=this.springs.get(t),r.postSpringWidth<n&&(r.postSpringWidth=n),r.graceBeatWidth<s&&(r.graceBeatWidth=s),r.preBeatWidth<i&&(r.preBeatWidth=i),e<r.smallestDuration&&(r.smallestDuration=e),e>r.longestDuration&&(r.longestDuration=e),r.allDurations.add(e);else{if(r=new Ac,r.timePosition=t,r.allDurations.add(e),this.mB.length>0){const t=this.mB[this.mB.length-1];for(const e of t.allDurations)t.timePosition;e<this.BB&&(this.BB=e)}r.longestDuration=e,r.postSpringWidth=n,r.graceBeatWidth=s,r.preBeatWidth=i,this.springs.set(t,r);const a=this.mB;let h=a.length-1;for(;h>0&&a[h].timePosition>t;)h--;this.mB.splice(h+1,0,r)}return(-1===this.gB||this.gB>t)&&(this.gB=t),r}addBeatSpring(t,e,s){const i=t.absoluteDisplayStart;if(t.graceType!==u.None){const n=t.graceGroup.id;this.allGraceRods.has(n)||this.allGraceRods.set(n,new Array(t.graceGroup.beats.length)),t.graceGroup.isComplete||this.incompleteGraceRods.has(n)||this.incompleteGraceRods.set(n,new Array(t.graceGroup.beats.length));const r=this.allGraceRods.get(n)[t.graceIndex];if(r)r.postSpringWidth<s&&(r.postSpringWidth=s),r.preBeatWidth<e&&(r.preBeatWidth=e);else{const r=new Ac;r.timePosition=i,r.postSpringWidth=s,r.preBeatWidth=e,t.graceGroup.isComplete||(this.incompleteGraceRods.get(n)[t.graceIndex]=r),this.allGraceRods.get(n)[t.graceIndex]=r}}else{let n=0;if(t.graceGroup&&this.allGraceRods.has(t.graceGroup.id))for(const e of this.allGraceRods.get(t.graceGroup.id))n+=e.springWidth;this.addSpring(i,t.displayDuration,n,e,s)}}finish(){for(const[t,e]of this.allGraceRods){let t=0;for(const s of e)t+=s.preBeatWidth,s.graceBeatWidth=t,t+=s.postSpringWidth}this.kB=0;for(const t of this.incompleteGraceRods.values())for(const e of t)this.kB+=e.preBeatWidth+e.postSpringWidth;this.TB(),this.version++}TB(){let t=0;const e=this.mB;if(0===e.length)return this.totalSpringConstant=-1,void(this.minStretchForce=-1);for(let s=0;s<e.length;s++){const i=e[s];let n=0;if(s===e.length-1)n=i.longestDuration;else{const t=e[s+1];n=Math.abs(t.timePosition-i.timePosition)}i.springConstant=this.xB(i,n),t+=1/i.springConstant}this.totalSpringConstant=1/t,this.minStretchForce=0;for(let t=0;t<e.length;t++){const s=e[t];let i=0;if(t===e.length-1)i=s.postSpringWidth;else{const n=e[t+1];i=s.postSpringWidth+n.preSpringWidth}0===t&&(i+=s.preSpringWidth);const n=i*s.springConstant;this._B(n)}}height=0;paint(t,e,s){}xB(t,e){e<=0&&(e=$.toTicks(l.TwoHundredFiftySixth)),0===t.smallestDuration&&(t.smallestDuration=e);const s=t.smallestDuration,i=this.BB,n=Dc.bB;return s/e*(1/((1+.85*Math.log2(e/i))*n))}spaceToForce(t){return-1!==this.totalSpringConstant?(this.mB.length>0&&(t-=this.mB[0].preSpringWidth),t-=this.kB,Math.max(t,0)*this.totalSpringConstant):-1}calculateVoiceWidth(t){let e=0;return-1!==this.totalSpringConstant&&(e=this.MB(t,this.totalSpringConstant)),this.mB.length>0&&(e+=this.mB[0].preSpringWidth),e+=this.kB,e}MB(t,e){return t/e}buildOnTimePositions(t){if(-1===this.totalSpringConstant)return new Map;if(Xt.isAlmostEqualTo(this.wB,t)&&this.yB)return this.yB;this.wB=t;const e=new Map;this.yB=e;const s=this.mB;if(0===s.length)return e;let i=s[0].preSpringWidth;for(let n=0;n<s.length;n++)e.set(s[n].timePosition,i),i+=this.MB(t,s[n].springConstant);return e}}class Lc{width=0;isLinkedToPrevious=!1;canWrap=!0;masterBar;additionalMultiBarRestIndexes=null;get lastMasterBarIndex(){return this.additionalMultiBarRestIndexes?this.additionalMultiBarRestIndexes[this.additionalMultiBarRestIndexes.length-1]:this.masterBar.index}renderers=[];layoutingInfo}class Wc{track;staffSystem;staves=[];firstVisibleStaff;lastVisibleStaff;bracket=null;constructor(t,e){this.staffSystem=t,this.track=e}addStaff(t){this.staves.push(t)}}class Rc{vB;firstStaffInBracket;lastStaffInBracket;firstVisibleStaffInBracket;lastVisibleStaffInBracket;drawAsBrace=!1;braceScale=1;width=0;index=0;canPaint=!1;constructor(t){this.vB=t}updateCanPaint(){let t,e;for(let s=this.firstStaffInBracket.index;s<=this.lastStaffInBracket.index;s++){const i=this.vB.allStaves[s];i.isVisible&&(t||(t=i),e=i)}if(this.firstVisibleStaffInBracket=t,this.lastVisibleStaffInBracket=e,!t||!e)return void(this.canPaint=!1);this.vB.layout.renderer.score.stylesheet.showSingleStaffBrackets||t!==e?this.canPaint=!0:this.canPaint=!1}finalizeBracket(t){if(!this.canPaint)return void(this.width=0);const e=t.glyphHeights.get(ut.Brace),s=t.glyphWidths.get(ut.Brace);if(this.drawAsBrace?this.width=s:this.width=t.bracketThickness,!this.drawAsBrace)return;const i=this.firstVisibleStaffInBracket.contentTop,n=(this.lastVisibleStaffInBracket.contentBottom-i)/e;this.braceScale=n,this.width=s*this.braceScale}}class Ic extends Rc{track;constructor(t,e){super(t),this.track=e,this.drawAsBrace=Ic.isTrackDrawAsBrace(e)}includesStaff(t){return t.modelStaff.track===this.track}static isTrackDrawAsBrace(t){return t.staves.filter(t=>t.showStandardNotation).length>1}}class Oc extends Ic{includesStaff(t){return t.modelStaff.track===this.track||!this.drawAsBrace&&this.track.playbackInfo.program===t.modelStaff.track.playbackInfo.program}}class Gc{NB=!1;Xn=[];PB=new Map;CB=0;EB=!1;x=0;y=0;index=0;accoladeWidth=0;isFull=!1;width=0;computedWidth=0;totalBarDisplayScale=0;isLast=!1;masterBarsRenderers=[];staves=[];layout;topPadding;bottomPadding;allStaves=[];firstVisibleStaff;constructor(t){this.layout=t,this.topPadding=t.renderer.settings.display.systemPaddingTop,this.bottomPadding=t.renderer.settings.display.systemPaddingBottom}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].lastMasterBarIndex}addMasterBarRenderers(t,e){if(0===t.length)return null;this.masterBarsRenderers.push(e),e.layoutingInfo.preBeatSize=0;let s,i=0,n=!1;for(const t of this.staves){let r,a;for(const h of t.staves){const t=e.renderers[i++];h.addBarRenderer(t),h.isVisible&&(n=!0,r||(r=h),s||(s=h),a=h)}t.firstVisibleStaff=r,t.lastVisibleStaff=a,s||(s=r)}if(!n){const t=this.staves[0],e=t.staves[0];e.isVisible=!0,t.firstVisibleStaff=e,t.lastVisibleStaff=e,s=e}return this.firstVisibleStaff=s,this.FB(t),this.AB(),e}addBars(t,e,s){const i=new Lc;let n;i.additionalMultiBarRestIndexes=s,i.layoutingInfo=new Dc,i.masterBar=t[0].score.masterBars[e],this.masterBarsRenderers.push(i);let r=!1;const a=i.layoutingInfo;for(const t of this.staves){let h,o;for(const n of t.staves){const c=t.track.staves[n.modelStaff.index].bars[e],l=null==s?null:s.map(e=>t.track.staves[n.modelStaff.index].bars[e]);n.addBar(c,a,l),n.isVisible&&(r=!0,h||(h=n),o=n);const u=n.barRenderers[n.barRenderers.length-1];i.renderers.push(u),u.isLinkedToPrevious&&(i.isLinkedToPrevious=!0),u.canWrap||(i.canWrap=!1)}t.firstVisibleStaff=h,t.lastVisibleStaff=o,n||(n=h)}if(!r){const t=this.staves[0],e=t.staves[0];e.isVisible=!0,t.firstVisibleStaff=e,t.lastVisibleStaff=e,n=e}return this.firstVisibleStaff=n,this.FB(t),a.finish(),i.width=this.AB(),i}getBarDisplayScale(t){return this.staves.length>1?t.bar.masterBar.displayScale:t.bar.displayScale}revertLastBar(){if(this.masterBarsRenderers.length>1){const t=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let e,s=0,i=0;for(const t of this.staves){let n,r;for(const e of t.staves){const t=e.revertLastBar(),a=t.computedWidth;a>s&&(s=a),t.afterReverted(),i=this.getBarDisplayScale(t),e.isVisible&&(n||(n=e),r=e)}t.firstVisibleStaff=n,t.lastVisibleStaff=r,e||(e=n)}return this.firstVisibleStaff=e,this.width-=s,this.computedWidth-=s,this.totalBarDisplayScale-=i,t}return null}AB(){let t=0,e=0;for(const s of this.allStaves){const i=s.barRenderers[s.barRenderers.length-1];i.applyLayoutingInfo(),e=this.getBarDisplayScale(i),i.computedWidth>t&&(t=i.computedWidth)}return this.totalBarDisplayScale+=e,this.width+=t,this.computedWidth+=t,t}FB(e){const s=this.layout.renderer.settings;if(this.NB)for(const t of this.Xn)t.updateCanPaint(),t.finalizeBracket(s.display.resources.engravingSettings);else{this.NB=!0,this.accoladeWidth=0;const i=this.layout.renderer.score.stylesheet;if(this.layout.renderer.settings.notation.isNotationElementVisible(t.NotationElement.TrackNames)){const n=1===this.layout.renderer.tracks.length?i.singleTrackTrackNamePolicy:i.multiTrackTrackNamePolicy,r=0===this.index?i.firstSystemTrackNameMode:i.otherSystemsTrackNameMode,a=0===this.index?i.firstSystemTrackNameOrientation:i.otherSystemsTrackNameOrientation;let h=!1;switch(n){case L.Hidden:break;case L.FirstSystem:h=0===this.index;break;case L.AllSystems:h=!0}let o=!1;if(h){const i=this.layout.renderer.canvas,n=s.display.resources.elementFonts.get(t.NotationElement.TrackNames);i.font=n;for(const t of e){let e="";switch(r){case W.FullName:e=t.name;break;case W.ShortName:e=t.shortName}if(e.length>0){o=!0;const t=i.measureText(e);switch(a){case R.Horizontal:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,t.width));break;case R.Vertical:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,t.height))}}}this.accoladeWidth+=s.display.systemLabelPaddingLeft,o&&(this.accoladeWidth+=s.display.systemLabelPaddingRight)}}let n=0;for(const t of this.allStaves)t.y=n,t.calculateHeightForAccolade(),n+=t.height;let r=0;for(const t of this.Xn)t.updateCanPaint(),t.finalizeBracket(s.display.resources.engravingSettings),r=Math.max(r,t.width);this.accoladeWidth+=r,this.width+=this.accoladeWidth,this.computedWidth+=this.accoladeWidth}}DB(t){for(let e=0,s=this.staves.length;e<s;e++){const s=this.staves[e];if(s.track===t)return s}return null}addStaff(t){const e=t.modelStaff.track;let s=this.DB(e);s||(s=new Wc(this,e),this.staves.push(s)),t.staffTrackGroup=s,t.system=this,t.index=this.allStaves.length,this.allStaves.push(t),s.addStaff(t);let i=this.Xn.find(e=>e.includesStaff(t));if(!i)switch(e.score.stylesheet.bracketExtendMode){case D.NoBrackets:break;case D.GroupStaves:i=new Ic(this,e),i.index=this.Xn.length,this.Xn.push(i);break;case D.GroupSimilarInstruments:i=new Oc(this,e),i.index=this.Xn.length,this.Xn.push(i)}i&&(i.firstStaffInBracket||(i.firstStaffInBracket=t),i.lastStaffInBracket=t,s.bracket=i,this.PB.set(t,i))}get height(){return Math.ceil(this.CB+this.topPadding+this.bottomPadding)}paint(t,e,s){if(this.paintPartial(t+this.x,e+this.y+this.topPadding,s,0,this.masterBarsRenderers.length),this.EB){const i=ro.track(s,Wt.SystemSeparator,this.allStaves[0].modelStaff.track);try{const i=this.layout.renderer.settings.display.resources.engravingSettings,n=Math.min(0,i.glyphBottom.get(ut.SystemDivider)??0);Ot.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+this.height+n,1,ut.SystemDivider,!1),Ot.fillMusicFontSymbolSafe(s,t+this.x+this.width-i.glyphWidths.get(ut.SystemDivider),e+this.y+this.height+n,1,ut.SystemDivider,!1)}finally{i?.[Symbol.dispose]?.()}}}paintPartial(e,s,i,n,r){for(const t of this.allStaves)t.isVisible&&t.paint(e,s,i,n,r);const a=this.layout.renderer.settings.display.resources;if(this.staves.length>0&&0===n){i.color=a.barSeparatorColor;const n=this.layout.renderer.settings,r=this.layout.renderer.settings.notation.isNotationElementVisible(t.NotationElement.TrackNames);if(i.font=a.elementFonts.get(t.NotationElement.TrackNames),r){const t=this.layout.renderer.score.stylesheet,r=1===this.layout.renderer.tracks.length?t.singleTrackTrackNamePolicy:t.multiTrackTrackNamePolicy,a=0===this.index?t.firstSystemTrackNameMode:t.otherSystemsTrackNameMode,h=0===this.index?t.firstSystemTrackNameOrientation:t.otherSystemsTrackNameOrientation;let o=!1;switch(r){case L.Hidden:break;case L.FirstSystem:o=0===this.index;break;case L.AllSystems:o=!0}if(o){const t=i.textBaseline,r=i.textAlign;for(const t of this.staves)if(t.firstVisibleStaff){const r=s+t.firstVisibleStaff.contentTop,o=s+t.lastVisibleStaff.contentBottom;let c="";switch(a){case W.FullName:c=t.track.name;break;case W.ShortName:c=t.track.shortName}const l=ro.track(i,Wt.TrackName,t.track);try{if(c.length>0){const s=e+t.staves[0].x-n.display.accoladeBarPaddingRight-(t.bracket?.width??0)-n.display.systemLabelPaddingRight;switch(h){case R.Horizontal:i.textBaseline=ot.Middle,i.textAlign=ht.Right,i.fillText(c,s,(r+o)/2);break;case R.Vertical:i.textBaseline=ot.Bottom,i.textAlign=ht.Center;const t=.1;i.beginRotate(s,(r+o)/2,-90-t),i.fillText(c,0,0),i.endRotate()}}}finally{l?.[Symbol.dispose]?.()}}i.textBaseline=t,i.textAlign=r}}const h=!this.layout.renderer.score.stylesheet.extendBarLines;if(this.allStaves.length>0&&h){let t=null;for(const n of this.allStaves)if(n.isVisible){if(null!==t){const r=t.contentBottom,h=n.contentTop,o=e+t.x,c=t.barRenderers[0],l=ro.bar(i,c.staffLineBarSubElement,c.bar);try{const t=Math.ceil(h-r);i.fillRect(o,s+r,a.engravingSettings.thinBarlineThickness,t)}finally{l?.[Symbol.dispose]?.()}}t=n}}this.LB(e,s,i)}}LB(t,e,s){const i=this.layout.renderer.settings;for(const n of this.Xn)if(n.canPaint){const r=t+n.firstVisibleStaffInBracket.x,a=n.width,h=i.display.accoladeBarPaddingRight;let o=e+n.firstVisibleStaffInBracket.contentTop,c=e+n.lastVisibleStaffInBracket.contentBottom;if(n.drawAsBrace)Ot.fillMusicFontSymbolSafe(s,r-h-a,c,n.braceScale,ut.Brace);else if(n.firstVisibleStaffInBracket!==n.lastVisibleStaffInBracket){const t=.25*i.display.resources.engravingSettings.oneStaffSpace;o-=t,c+=t;const e=3;s.fillRect(r-h-a,o-e,a,Math.ceil(c-o+2*e));const n=r-h-a;Ot.fillMusicFontSymbolSafe(s,n,o,1,ut.BracketTop),Ot.fillMusicFontSymbolSafe(s,n,Math.floor(c),1,ut.BracketBottom)}}}finalizeSystem(){const t=this.layout.renderer.settings;if(0===this.index&&(this.topPadding=t.display.firstSystemPaddingTop),this.isLast)this.bottomPadding=t.display.lastSystemPaddingBottom;else if(this.layout.renderer.score.stylesheet.useSystemSignSeparator&&this.layout.renderer.tracks.length>1){const e=t.display.resources.engravingSettings.glyphHeights.get(ut.SystemDivider);this.bottomPadding=Math.max(this.bottomPadding,e),this.EB=!0}if(!this.WB()){this.staves[0].staves[0].isVisible=!0,this.WB(!0)}for(const e of this.Xn)e.finalizeBracket(t.display.resources.engravingSettings)}WB(t=!1){let e=0;const s=this.layout.renderer.settings,i=s.display.resources.engravingSettings,n=i.glyphHeights.get(ut.BracketTop),r=i.glyphHeights.get(ut.BracketBottom);let a,h=0,o=!1;for(const i of this.staves){let c,l;for(const u of i.staves){void 0!==a&&a.trackIndex!==u.trackIndex&&(e+=s.display.trackStaffPaddingBetween);const i=this.PB.has(u)?this.PB.get(u):void 0,d=i&&!i.drawAsBrace&&i.canPaint;if(d&&i.firstStaffInBracket===u){const t=n-u.topOverflow;t>0&&(e+=t)}if(u.x=this.accoladeWidth,u.y=e,t||u.finalizeStaff(),u.isVisible&&(e+=u.height,o=!0,a=u,c||(c=u),l=u),h=0,d&&i.lastStaffInBracket===u){const t=r-u.bottomOverflow;t>0&&(u.isVisible?e+=t:h=t)}}if(i.firstVisibleStaff=c,i.lastVisibleStaff=l,this.firstVisibleStaff||(this.firstVisibleStaff=c),t)break}return h&&(e+=h),this.CB=e,o}buildBoundingsLookup(t,e){if(this.layout.renderer.boundsLookup.isFinished)return;const s=this.allStaves[0],i=this.allStaves[this.allStaves.length-1],n=(e+=this.topPadding)+this.y+s.y,r=e+this.y+i.y+i.height-n,a=e+this.y,h=e+this.y+this.height-a,o=e+this.y+s.y+s.topPadding+s.topOverflow,c=e+this.y+i.y+i.height-i.bottomPadding-i.bottomOverflow-o,l=this.x+s.x,u=new ma;u.visualBounds=new zs,u.visualBounds.x=t+this.x,u.visualBounds.y=e+this.y,u.visualBounds.w=this.width,u.visualBounds.h=this.height-this.topPadding-this.bottomPadding,u.realBounds=new zs,u.realBounds.x=t+this.x,u.realBounds.y=e+this.y,u.realBounds.w=this.width,u.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaffSystem(u);const d=new Map;for(let t=0;t<this.staves.length;t++)for(const s of this.staves[t].staves)if(s.isVisible)for(const t of s.barRenderers){let i;d.has(t.bar.masterBar.index)?i=d.get(t.bar.masterBar.index):(i=new pa,i.index=t.bar.masterBar.index,i.isFirstOfLine=t.isFirstOfStaff,i.realBounds=new zs,i.realBounds.x=l+t.x,i.realBounds.y=a,i.realBounds.w=t.width,i.realBounds.h=h,i.visualBounds=new zs,i.visualBounds.x=l+t.x,i.visualBounds.y=n,i.visualBounds.w=t.width,i.visualBounds.h=r,i.lineAlignedBounds=new zs,i.lineAlignedBounds.x=l+t.x,i.lineAlignedBounds.y=o,i.lineAlignedBounds.w=t.width,i.lineAlignedBounds.h=c,this.layout.renderer.boundsLookup.addMasterBar(i),d.set(i.index,i)),t.buildBoundingsLookup(i,l,e+this.y+s.y)}}getBarX(t){if(0===this.allStaves.length||0===this.layout.renderer.tracks.length)return 0;const e=this.layout.renderer.tracks[0].staves[0].bars[t];return this.layout.getRendererForBar(this.allStaves[0].staffId,e).x}}class Vc{args;renderCallback;constructor(t,e){this.args=t,this.renderCallback=e}}class $c{RB=new Map;pagePadding=null;profile=new Set;renderer;width=0;height=0;multiBarRestInfo=null;get scaledWidth(){return Math.round(this.width/this.renderer.settings.display.scale)}headerGlyphs=new Map;footerGlyphs=new Map;chordDiagrams=null;tuningGlyph=null;constructor(t){this.renderer=t}slurRegistry=new Ec;beamingRuleLookups=new Map;resize(){this.IB.clear(),this.slurRegistry.clear(),this.doResize()}layoutAndRender(t){this.IB.clear(),this.slurRegistry.clear(),this.beamingRuleLookups.clear(),this.RB.clear(),this.profile=Nu.staveProfiles.get(this.renderer.settings.display.staveProfile);const e=this.renderer.score;this.firstBarIndex=Xt.computeFirstDisplayedBarIndex(e,this.renderer.settings),this.lastBarIndex=Xt.computeLastDisplayedBarIndex(e,this.renderer.settings,this.firstBarIndex),this.multiBarRestInfo=Xt.buildMultiBarRestInfo(this.renderer.tracks,this.firstBarIndex,this.lastBarIndex),this.pagePadding=this.renderer.settings.display.padding.map(t=>t/this.renderer.settings.display.scale),this.pagePadding||(this.pagePadding=[0,0,0,0]),1===this.pagePadding.length?this.pagePadding=[this.pagePadding[0],this.pagePadding[0],this.pagePadding[0],this.pagePadding[0]]:2===this.pagePadding.length&&(this.pagePadding=[this.pagePadding[0],this.pagePadding[1],this.pagePadding[0],this.pagePadding[1]]),this.OB(),this.doLayoutAndRender(t)}IB=new Map;registerPartial(t,e){if(0===t.height)return;const s=this.renderer.settings.display.scale;t.x*=s,t.y*=s,t.width*=s,t.height*=s,t.totalWidth*=s,t.totalHeight*=s,this.renderer.settings.core.enableLazyLoading?(this.IB.set(t.id,new Vc(t,e)),this.renderer.partialLayoutFinished.trigger(t)):(this.renderer.partialLayoutFinished.trigger(t),this.GB(t,e))}GB(t,e){const s=this.renderer.canvas;s.beginRender(t.width,t.height),e(s),t.renderResult=s.endRender(),this.renderer.partialRenderFinished.trigger(t)}renderLazyPartial(t){if(this.IB.has(t)){const e=this.IB.get(t);this.GB(e.args,e.renderCallback)}}static headerElements=new j(()=>new Map([[ct.Title,t.NotationElement.ScoreTitle],[ct.SubTitle,t.NotationElement.ScoreSubTitle],[ct.Artist,t.NotationElement.ScoreArtist],[ct.Album,t.NotationElement.ScoreAlbum],[ct.Words,t.NotationElement.ScoreWords],[ct.Music,t.NotationElement.ScoreMusic],[ct.WordsAndMusic,t.NotationElement.ScoreWordsAndMusic],[ct.Transcriber,void 0]]));static footerElements=new j(()=>new Map([[ct.Copyright,t.NotationElement.ScoreCopyright],[ct.CopyrightSecondLine,void 0]]));VB(t,e,s,i){switch(s){case ct.WordsAndMusic:if(e.words!==e.music)return;break;case ct.Words:case ct.Music:if(e.words===e.music)return;break;case ct.CopyrightSecondLine:if(!this.footerGlyphs.has(ct.Copyright))return}const n=t.display.resources,r=t.notation,a=e.style&&e.style.headerAndFooter.has(s)?e.style.headerAndFooter.get(s):Vt.defaultHeaderAndFooter.get(s);let h=void 0===a.isVisible||a.isVisible;if(void 0!==i&&(h=r.isNotationElementVisible(i)),!h)return;const o=a.buildText(e);return o?new Gh(0,0,o,n.getFontForElement(s),a.textAlign,void 0,ro.scoreColor(n,s,e)):void 0}OB(){q.debug("ScoreLayout","Creating score info glyphs");const e=this.renderer.settings,s=this.renderer.score;this.headerGlyphs=new Map,this.footerGlyphs=new Map;const i=new tc(this.renderer,this.renderer.tracks[0].staves[0].bars[0]);for(const[t,n]of $c.headerElements.value){const r=this.VB(e,s,t,n);r&&(r.renderer=i,r.doLayout(),this.headerGlyphs.set(t,r))}for(const[t,n]of $c.footerElements.value){const r=this.VB(e,s,t,n);r&&(r.renderer=i,r.doLayout(),this.footerGlyphs.set(t,r))}const n=e.notation,r=e.display.resources;if(n.isNotationElementVisible(t.NotationElement.GuitarTuning)){const t=[];for(const e of this.renderer.tracks)for(const i of e.staves){let n=!i.isPercussion&&i.isStringed&&i.tuning.length>0&&i.showTablature;if(s.stylesheet.perTrackDisplayTuning&&s.stylesheet.perTrackDisplayTuning.has(e.index)&&!1===s.stylesheet.perTrackDisplayTuning.get(e.index)&&(n=!1),n){t.push(i);break}}if(t.length>0&&s.stylesheet.globalDisplayTuning){this.tuningGlyph=new Pc(0,0),this.tuningGlyph.renderer=i;for(const e of t)if(e.stringTuning.tunings.length>0){const s=t.length>1?e.track.name:"",n=new Cc(0,0,e.stringTuning,s);n.colorOverride=ro.trackColor(r,Wt.StringTuning,e.track),n.renderer=i,n.doLayout(),this.tuningGlyph.addGlyph(n)}}else this.tuningGlyph=null}if(n.isNotationElementVisible(t.NotationElement.ChordDiagrams)){this.chordDiagrams=new Nc(0,0),this.chordDiagrams.renderer=i;const t=new Set;for(const e of this.renderer.tracks){if(s.stylesheet.globalDisplayChordDiagramsOnTop&&(null==s.stylesheet.perTrackChordDiagramsOnTop||!s.stylesheet.perTrackChordDiagramsOnTop.has(e.index)||s.stylesheet.perTrackChordDiagramsOnTop.get(e.index)))for(const s of e.staves){const e=s.chords;if(e)for(const[,s]of e)t.has(s.uniqueId)||s.showDiagram&&(t.add(s.uniqueId),this.chordDiagrams.addChord(s))}}this.chordDiagrams.isEmpty&&(this.chordDiagrams=null)}else this.chordDiagrams=null}firstBarIndex=0;lastBarIndex=0;createEmptyStaffSystem(t){const e=new Gc(this);e.index=t;const s=Nu.defaultRenderers,i=[];for(let t=0;t<this.renderer.tracks.length;t++){const n=this.renderer.tracks[t];for(let r=0;r<n.staves.length;r++){const a=n.staves[r];let h,o=[],c=[];for(const r of s)if(this.profile.has(r.staffId)&&r.canCreate(n,a)){const s=new Fc(e,t,a,r);s.topEffectInfos.splice(0,0,...o),s.bottomEffectInfos.push(...c),h=s,i.push(s),o=[],c=[]}else for(const t of r.effectBands)switch(t.mode){case yh.SharedTop:o.push(t);break;case yh.SharedBottom:c.push(t)}h&&(o.length>0&&h.bottomEffectInfos.push(...o),c.length>0&&h.bottomEffectInfos.push(...c))}}for(const t of i)e.addStaff(t);return e}registerBarRenderer(t,e){if(this.RB.has(t)||this.RB.set(t,new Map),this.RB.get(t).set(e.bar.id,e),e.additionalMultiRestBars)for(const s of e.additionalMultiRestBars)this.RB.get(t).set(s.id,e)}getRendererForBar(t,e){const s=e.id;return this.RB.has(t)&&this.RB.get(t).has(s)?this.RB.get(t).get(s):null}layoutAndRenderBottomScoreInfo(t){t=Math.round(t);const e=new ua;e.x=0,e.y=t;let s=0;const i=this.renderer.settings.display.resources,n=[];let r=0;for(const[t,e]of $c.footerElements.value)if(this.footerGlyphs.has(t)){const e=this.footerGlyphs.get(t);e.y=s,this.alignScoreInfoGlyph(e),s+=e.height,n.push(e),r=Math.max(r,Math.round(e.x+e.width))}return s=Math.round(s),n.length>0&&(e.width=r,e.height=s,e.totalWidth=this.scaledWidth,e.totalHeight=t+e.height,this.registerPartial(e,t=>{t.color=i.scoreInfoColor,t.textAlign=ht.Left,t.textBaseline=ot.Top;for(const e of n)e.paint(0,0,t)})),t+s}alignScoreInfoGlyph(t){if(Nu.getLayoutEngineFactory(this.renderer.settings.display.layoutMode).vertical)switch(t.textAlign){case ht.Left:t.x=this.pagePadding[0];break;case ht.Center:t.x=this.scaledWidth/2;break;case ht.Right:t.x=this.scaledWidth-this.pagePadding[2]}else t.x=this.firstBarX,t.textAlign=ht.Left}layoutAndRenderAnnotation(e){const s=this.renderer.settings.display.resources,i=s.elementFonts.has(t.NotationElement.ScoreCopyright)?s.elementFonts.get(t.NotationElement.ScoreCopyright).families:s.tablatureFont.families,n=Hr.withFamilyList(i,12,as.Plain,hs.Bold),r=new tc(this.renderer,this.renderer.tracks[0].staves[0].bars[0]),a=new Gh(0,0,"rendered by alphaTab",n,ht.Center,void 0,s.mainGlyphColor);a.renderer=r,a.doLayout(),this.alignScoreInfoGlyph(a);const h=new ua;return h.width=a.x+a.width,h.x=0,h.height=12,h.y=e,h.totalWidth=this.scaledWidth,h.totalHeight=e+12,h.firstMasterBarIndex=-1,h.lastMasterBarIndex=-1,this.registerPartial(h,t=>{t.color=s.mainGlyphColor,t.font=n,t.textAlign=ht.Left,t.textBaseline=ot.Top,a.paint(0,0,t)}),e+12}}class Hc{x=0;width=0;masterBars=[];results=[]}class Uc extends $c{vB=null;get name(){return"HorizontalScreen"}get supportsResize(){return!1}get firstBarX(){let t=this.pagePadding[0];return this.vB&&(t+=this.vB.accoladeWidth),t}doResize(){}doLayoutAndRender(t){const e=this.renderer.score;let s=this.renderer.settings.display.startBar;s--,s=Math.min(e.masterBars.length-1,Math.max(0,s));let i=s,n=this.renderer.settings.display.barCount;n<=0&&(n=e.masterBars.length),n=s+n-1,n=Math.min(e.masterBars.length-1,Math.max(0,n)),this.vB=this.createEmptyStaffSystem(0),this.vB.isLast=!0,this.vB.x=this.pagePadding[0],this.vB.y=this.pagePadding[1];const r=this.renderer.settings.display.barCountPerPartial,a=[];let h=new Hc;for(;i<=n;){const t=this.multiBarRestInfo,s=null!==t&&t.has(i)?t.get(i):null,n=this.vB.addBars(this.renderer.tracks,i,s);h.masterBars.length>=r&&!n.isLinkedToPrevious&&(h=this.$B(a,h)),this.HB(n),h.results.push(n),h.masterBars.push(e.masterBars[i]),h.width+=n.width,i++}h.masterBars.length>0&&this.$B(a,h),this.UB(),this.height=Math.floor(this.vB.y+this.vB.height),this.width=this.vB.x+this.vB.width+this.pagePadding[2],i=0;let o=0;for(let e=0;e<a.length;e++){const s=a[e],n=new ua;n.reuseViewport=t?.reuseViewport??!1,n.x=o,n.y=0,n.totalWidth=this.width,n.totalHeight=this.height,n.width=s.width,n.height=this.height,n.firstMasterBarIndex=s.masterBars[0].index,n.lastMasterBarIndex=s.masterBars[s.masterBars.length-1].index,o+=s.width;const r=i,h=e;this.vB.buildBoundingsLookup(0,0),this.registerPartial(n,t=>{let e=this.vB.getBarX(s.masterBars[0].index)+this.vB.accoladeWidth;0===h&&(e-=this.vB.x+this.vB.accoladeWidth),t.color=this.renderer.settings.display.resources.mainGlyphColor,t.textAlign=ht.Left,q.debug(this.name,`Rendering partial from bar ${s.masterBars[0].index} to ${s.masterBars[s.masterBars.length-1].index}`,null),this.vB.paintPartial(-e,this.vB.y,t,r,s.masterBars.length)}),i+=s.masterBars.length}this.height=this.layoutAndRenderBottomScoreInfo(this.height),this.height=this.layoutAndRenderAnnotation(this.height),this.height+=this.pagePadding[3],this.height*=this.renderer.settings.display.scale}HB(t){t.width=0,this.vB.width-=t.width;for(const e of t.renderers){const s=e.staff.system.staves.length>1?e.bar.masterBar.displayWidth:e.bar.displayWidth;s>0&&e.scaleToWidth(s);const i=e.x+e.width;i>t.width&&(t.width=i)}this.vB.width+=t.width}$B(t,e){0===t.length&&(e.width+=this.vB.accoladeWidth+this.pagePadding[0]),t.push(e),q.debug(this.name,`Finished partial from bar ${e.masterBars[0].index} to ${e.masterBars[e.masterBars.length-1].index}`,null);const s=new Hc;return s.x=e.x+e.width,s}UB(){this.zB(),this.vB.finalizeSystem()}zB(){this.width=0;const t=this.vB;for(const e of t.allStaves){e.resetSharedLayoutData();let s=0;for(const t of e.barRenderers)t.x=s,t.y=e.topPadding+e.topOverflow,t.scaleToWidth(t.width),s+=t.width;s>this.width&&(t.width=s)}t.width+=t.accoladeWidth}}class zc extends $c{XB=[];jB=[];JB=[];qB=!1;doLayoutAndRender(t){let e=this.pagePadding[1];this.width=this.renderer.width,this.jB=[],this.qB=t?.reuseViewport??!1,e=this.YB(e,-1),e=this.KB(e,-1),e=this.QB(e,-1),e=this.ZB(e),e=this.layoutAndRenderBottomScoreInfo(e),e=this.layoutAndRenderAnnotation(e),this.height=(e+this.pagePadding[3])*this.renderer.settings.display.scale}registerPartial(t,e){t.reuseViewport=this.qB,super.registerPartial(t,e)}get supportsResize(){return!0}get firstBarX(){let t=this.pagePadding[0];return this.XB.length>0&&(t+=this.XB[0].accoladeWidth),t}doResize(){let t=this.pagePadding[1];this.width=this.renderer.width;const e=this.height;this.qB=!0,t=this.YB(t,e),t=this.KB(t,e),t=this.QB(t,e),t=this.t_(t,e),t=this.layoutAndRenderBottomScoreInfo(t),t=this.layoutAndRenderAnnotation(t),this.height=(t+this.pagePadding[3])*this.renderer.settings.display.scale}KB(t,e=-1){if(!this.tuningGlyph)return t;const s=this.renderer.settings.display.resources;this.tuningGlyph.x=this.pagePadding[0],this.tuningGlyph.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.tuningGlyph.doLayout();const i=Math.round(this.tuningGlyph.height),n=new ua;return n.x=0,n.y=t,n.width=this.scaledWidth,n.height=i,n.totalWidth=this.scaledWidth,n.totalHeight=e<0?t+n.height:e,this.registerPartial(n,t=>{t.color=s.scoreInfoColor,t.textAlign=ht.Center,this.tuningGlyph.paint(0,0,t)}),t+i}QB(t,e=-1){if(!this.chordDiagrams)return t;const s=this.renderer.settings.display.resources;this.chordDiagrams.x=this.pagePadding[0],this.chordDiagrams.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.chordDiagrams.doLayout();const i=Math.round(this.chordDiagrams.height),n=new ua;return n.x=0,n.y=t,n.width=this.scaledWidth,n.height=i,n.totalWidth=this.scaledWidth,n.totalHeight=e<0?t+i:e,this.registerPartial(n,t=>{t.color=s.scoreInfoColor,t.textAlign=ht.Center,this.chordDiagrams.paint(0,0,t)}),t+i}YB(t,e=-1){q.debug(this.name,"Layouting score info");const s=new ua;s.x=0,s.y=t;let i=0;const n=this.renderer.settings.display.resources,r=[];for(const[t,e]of $c.headerElements.value)if(this.headerGlyphs.has(t)){const e=this.headerGlyphs.get(t);e.y=i,this.alignScoreInfoGlyph(e);let s=e.font.size;if(t===ct.Words&&this.headerGlyphs.has(ct.Music)){this.headerGlyphs.get(ct.Music).textAlign!==e.textAlign&&(s=0)}i+=s,r.push(e)}return r.length>0&&(i=Math.floor(i+17),s.width=this.scaledWidth,s.height=i,s.totalWidth=this.scaledWidth,s.totalHeight=e<0?t+s.height:e,this.registerPartial(s,t=>{t.color=n.scoreInfoColor,t.textAlign=ht.Center;for(const e of r)e.paint(0,0,t)})),t+i}t_(t,e){if(this.getBarsPerSystem(0)>0)for(let s=0;s<this.XB.length;s++){const i=this.XB[s];i.width=i.computedWidth,this.e_(i),t+=this.s_(i,e)}else{for(const t of this.jB)for(const e of t.renderers)e.afterReverted();this.XB=[];let s=0;const i=this.i_;let n=this.createEmptyStaffSystem(this.XB.length);for(n.x=this.pagePadding[0],n.y=t;s<this.jB.length;){let r=this.jB[s];if(n.width+r.width<=i||0===n.masterBarsRenderers.length)n.addMasterBarRenderers(this.renderer.tracks,r),s++,this.n_(s)&&(n.isFull=!0);else{for(;r&&!r.canWrap&&n.masterBarsRenderers.length>1;)r=n.revertLastBar(),s--;n.isFull=!0}n.isFull&&(n.isLast=this.lastBarIndex===n.lastBarIndex,this.XB.push(n),this.e_(n),t+=this.s_(n,e),n=this.createEmptyStaffSystem(this.XB.length),n.x=this.pagePadding[0],n.y=t)}n.isLast=this.lastBarIndex===n.lastBarIndex,this.e_(n),t+=this.s_(n,e)}return t}ZB(t){let e=this.firstBarIndex;const s=this.lastBarIndex;for(this.XB=[];e<=s;){const i=this.r_(e,s);this.XB.push(i),i.x=this.pagePadding[0],i.y=t,e=i.lastBarIndex+1,this.e_(i),q.debug(this.name,`Rendering partial from bar ${i.firstBarIndex} to ${i.lastBarIndex}`,null),t+=this.s_(i,t)}return t}s_(t,e){const s=Math.floor(t.height),i=new ua;return i.x=0,i.y=t.y,i.totalWidth=this.scaledWidth,i.totalHeight=e,i.width=this.scaledWidth,i.height=s,i.firstMasterBarIndex=t.firstBarIndex,i.lastMasterBarIndex=t.lastBarIndex,t.buildBoundingsLookup(0,0),this.registerPartial(i,e=>{this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=ht.Left,t.paint(0,-i.y/this.renderer.settings.display.scale,e)}),s}e_(t){t.isFull||t.width>this.i_||this.renderer.settings.display.justifyLastSystem?this.a_(t,this.i_):this.a_(t,t.width),t.finalizeSystem()}a_(t,e){const s=e-t.accoladeWidth,i=this.shouldApplyBarScale,n=t.totalBarDisplayScale,r=(e-t.computedWidth)/t.masterBarsRenderers.length;for(const e of t.allStaves){e.resetSharedLayoutData();let a=0;for(const h of e.barRenderers){let o;if(h.x=a,h.y=e.topPadding+e.topOverflow,i){o=t.getBarDisplayScale(h)*s/n}else o=h.computedWidth+r;h.scaleToWidth(o),a+=h.width}}t.width=e}r_(t,e){const s=this.createEmptyStaffSystem(this.XB.length),i=this.getBarsPerSystem(s.index),n=this.i_,r=e+1;let a=t;for(;a<r;){if(this.JB.length>0)for(const t of this.JB)s.addMasterBarRenderers(this.renderer.tracks,t),a=t.lastMasterBarIndex;else{const t=this.multiBarRestInfo,e=null!==t&&t.has(a)?t.get(a):null,i=s.addBars(this.renderer.tracks,a,e);this.jB.push(i),a=i.lastMasterBarIndex}this.JB=[];let t=!1;if((-1===i&&s.width>=n&&0!==s.masterBarsRenderers.length||s.masterBarsRenderers.length===i+1)&&(t=!0),t){let t=s.revertLastBar();if(t)for(this.JB.push(t);t&&!t.canWrap&&s.masterBarsRenderers.length>1;)t=s.revertLastBar(),t&&this.JB.push(t);return s.isFull=!0,s.isLast=!1,this.JB.reverse(),s}if(this.n_(a))return s.isFull=!0,s.isLast=!1,s;s.x=0,a++}return s.isLast=e===s.lastBarIndex,s}n_(t){let e=!1,s=!0;for(const i of this.renderer.tracks)i.lineBreaks&&i.lineBreaks.has(t+1)?e=!0:s=!1;return e&&s}get i_(){return this.scaledWidth-this.pagePadding[0]-this.pagePadding[2]}}class Xc extends zc{get name(){return"PageView"}getBarsPerSystem(e){let s=this.renderer.settings.display.barsPerRow;return this.renderer.settings.display.systemsLayoutMode===t.SystemsLayoutMode.UseModelLayout&&(s=Xt.getSystemLayout(this.renderer.score,e,this.renderer.tracks)),s}get shouldApplyBarScale(){return this.renderer.settings.display.systemsLayoutMode===t.SystemsLayoutMode.UseModelLayout}}class jc extends zc{get name(){return"Parchment"}getBarsPerSystem(t){return Xt.getSystemLayout(this.renderer.score,t,this.renderer.tracks)}get shouldApplyBarScale(){return!0}}class Jc extends Ra{doLayout(){this.width=this.renderer.smuflMetrics.thinBarlineThickness}paint(t,e,s){this.paintExtended(t,e,s,this.height)}}class qc extends Jc{h_;constructor(t,e,s){super(t,e),this.h_=s}doLayout(){this.width=this.h_?this.renderer.smuflMetrics.repeatEndingLineThickness:this.renderer.smuflMetrics.thinBarlineThickness}paintExtended(t,e,s,i){s.fillRect(t+this.x,e+this.y,this.renderer.smuflMetrics.thinBarlineThickness,i)}}class Yc extends Jc{paintExtended(t,e,s,i){const n=this.renderer.smuflMetrics.thinBarlineThickness/2,r=this.renderer.getLineHeight(1);let a=e+this.y+.5*r+n;const h=e+this.y+i;for(;a<h;)s.fillCircle(t+this.x,a,n),a+=r}}class Kc extends Jc{paintExtended(t,e,s,i){const n=this.renderer.smuflMetrics.dashedBarlineDashLength,r=t+this.x-this.width/2,a=Math.ceil(i/2/n),h=e+this.y+i,o=this.renderer.smuflMetrics.dashedBarlineGapLength,c=s.lineWidth;if(s.lineWidth=this.renderer.smuflMetrics.dashedBarlineThickness,s.beginPath(),a<1)s.moveTo(r,e+this.y),s.lineTo(r,h);else{let t=e+this.y;for(;t<h;){s.moveTo(r,t);const e=Math.min(h-t,n);s.lineTo(r,t+e),t+=n+o}}s.stroke(),s.lineWidth=c}}class Qc extends Jc{doLayout(){this.width=this.renderer.smuflMetrics.thickBarlineThickness}paintExtended(t,e,s,i){s.fillRect(t+this.x,e+this.y,this.width,i)}}class Zc extends Jc{doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(ut.RepeatDot)}paintExtended(t,e,s,i){const n=this.renderer,r=n.heightLineCount%2==0?1:.5,a=e+this.y+this.height/2,h=n.getLineHeight(r),o=n.smuflMetrics.glyphTop.get(ut.RepeatDot)-n.smuflMetrics.glyphHeights.get(ut.RepeatDot)/2;Ot.fillMusicFontSymbolSafe(s,t+this.x,a+o-h,1,ut.RepeatDot),Ot.fillMusicFontSymbolSafe(s,t+this.x,a+o+h,1,ut.RepeatDot)}}class tl extends Jc{paintExtended(t,e,s,i){const n=this.renderer;if(n.drawnLineCount-1<=2)return;const r=n.smuflMetrics.staffLineThickness/2,a=(n.drawnLineCount-1)/2,h=n.getLineY(a-1)-r,o=n.getLineY(a+1)+r;s.fillRect(t+this.x,e+h,n.smuflMetrics.thinBarlineThickness,o-h)}}class el extends Jc{paintExtended(t,e,s,i){const n=this.renderer.getLineHeight(1),r=-n/2+1;s.fillRect(t+this.x,e+this.y+r,1,n)}}class sl extends Oo{o_;c_;constructor(t,e){super(),this.o_=t,this.c_=e}doLayout(){const t=this.renderer.bar,e=t.masterBar,s=this.o_?t.getActualBarLineRight():t.getActualBarLineLeft(0===this.renderer.index),i=this.o_&&e.isRepeatEnd||!this.o_&&e.isRepeatStart;let n=F.Automatic;if(!this.o_){const t=this.renderer.previousRenderer;if(t&&t.staff===this.renderer.staff&&(n=t.bar.getActualBarLineRight(),s===n))return}switch(this.o_&&e.isRepeatEnd&&(this.addGlyph(new Zc(0,0)),this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation),s){case F.Dashed:this.addGlyph(new Kc(0,0));break;case F.Dotted:this.addGlyph(new Yc(0,0));break;case F.Heavy:n!==F.LightHeavy&&n!==F.HeavyHeavy&&this.addGlyph(new Qc(0,0));break;case F.HeavyHeavy:n!==F.LightHeavy&&n!==F.Heavy&&this.addGlyph(new Qc(0,0)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new Qc(0,0));break;case F.HeavyLight:n!==F.LightHeavy&&n!==F.Heavy&&n!==F.HeavyHeavy&&this.addGlyph(new Qc(0,0)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new qc(0,0,i));break;case F.LightHeavy:n!==F.HeavyLight&&n!==F.Regular&&n!==F.LightLight&&this.addGlyph(new qc(0,0,i)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new Qc(0,0));break;case F.LightLight:n!==F.HeavyLight&&n!==F.Regular&&this.addGlyph(new qc(0,0,i)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new qc(0,0,i));break;case F.None:break;case F.Regular:n!==F.HeavyLight&&n!==F.LightLight&&this.addGlyph(new qc(0,0,i));break;case F.Short:this.addGlyph(new tl(0,0));break;case F.Tick:this.addGlyph(new el(0,0))}this.o_||e.isRepeatStart&&(this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation,this.addGlyph(new Zc(0,0)));const r=this.renderer,a=r.smuflMetrics.staffLineThickness;let h=this.y,o=this.y;r.drawnLineCount<2||!this.o_&&r.isFirstOfStaff||this.o_&&r.isLastOfStaff?(h-=a,o+=r.height):(h+=r.getLineY(0)-a/2,o+=r.getLineY(r.drawnLineCount-1)+a/2);const c=o-h;let l=0;if(this.c_&&this.o_){const t=Math.ceil(this.width);l=t-this.width,this.width=t}for(const t of this.glyphs)t.y=h,t.x+=l,t.height=c}paint(t,e,s){const i=this.glyphs;if(!i)return;const n=this.renderer,r=ro.bar(s,n.barLineBarSubElement,this.renderer.bar,!0);try{let r=this.height;const a=n.staff,h=a.system.allStaves;let o=!1;if(this.c_&&a.index<h.length-1){const t=h[a.index+1],e=a.y+n.y;r=t.y+t.topOverflow+n.smuflMetrics.staffLineThickness-e,o=!0}for(const n of i)o?n.paintExtended(t,e,s,r):n.paint(t,e,s)}finally{r?.[Symbol.dispose]?.()}}}class il extends Ra{l_;constructor(t,e,s){super(t,e),this.l_=`${s}  `}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.elementFonts.get(t.NotationElement.BarNumber);const e=this.renderer.scoreRenderer.canvas.measureText(this.l_);this.width=e.width,this.height=e.height,this.y-=this.height}paint(e,s,i){if(!this.renderer.staff.isFirstInSystem)return;const n=ro.bar(i,this.renderer.barNumberBarSubElement,this.renderer.bar,!0);try{const n=this.renderer.resources,r=i.textBaseline;i.font=n.elementFonts.get(t.NotationElement.BarNumber),i.textBaseline=ot.Top,i.fillText(this.l_,e+this.x,s+this.y),i.textBaseline=r}finally{n?.[Symbol.dispose]?.()}}}class nl extends $o{shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}calculateTieDirection(){return Rt.Up}}class rl{x=0;y=-3e3;width=0}class al extends no{constructor(){super(0,0)}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);this.glyphs.sort((t,e)=>t.y<e.y?-1:t.y>e.y?1:0);const t=[];t.push(new rl);for(let e=0,s=this.glyphs.length;e<s;e++){const s=this.glyphs[e];s.renderer=this.renderer,s.doLayout();let i=0;for(;t[i].y>s.y;)i++,i===t.length&&t.push(new rl);s.x=i,t[i].y=s.y+s.height,t[i].width<s.width&&(t[i].width=s.width)}this.width=0;const e=this.renderer.smuflMetrics.accidentalPadding;for(const s of t)this.width+=s.width+e,s.x=this.width;for(let e=0,s=this.glyphs.length;e<s;e++){const s=this.glyphs[e],i=t[s.x];s.x=this.width-i.x}}}class hl extends Yh{constructor(t,e){super(t,e,1,ut.AugmentationDot)}doLayout(){super.doLayout(),this.offsetX=this.width/2,this.width*=1.5}}class ol extends no{vk=[];u_=[];container;computedWidth=0;constructor(){super(0,0)}doLayout(){let t=0;if(this.glyphs)for(let e=0,s=this.glyphs.length;e<s;e++){const s=this.glyphs[e];s.x=t,s.renderer=this.renderer,s.doLayout(),t+=s.width}this.width=t,this.computedWidth=t}noteLoop(t){for(let e=this.container.beat.notes.length-1;e>=0;e--)t(this.container.beat.notes[e])}addEffect(t){super.addGlyph(t),this.vk.push(t)}addNormal(t){super.addGlyph(t),this.u_.push(t)}get effectElement(){}paint(t,e,s){this.d_(t,e,s),this.f_(t,e,s)}f_(t,e,s){for(const i of this.u_)i.paint(t+this.x,e+this.y,s)}d_(t,e,s){const i=this.effectElement?ro.beat(s,this.effectElement,this.container.beat):void 0;try{for(const i of this.vk)i.paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}}class cl extends ol{onTimeX=0;middleX=0;stemX=0}class ll extends Ra{p_=0;constructor(){super(0,0)}getBoundingBoxTop(){return this.p_}getBoundingBoxBottom(){return this.p_+this.height}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(ut.NoteheadSlashWhiteHalf);const t=this.renderer,e=t.getLineHeight(t.heightLineCount-1),s=t.getLineY(0)+(t.drawnLineCount>0?t.getLineHeight(t.drawnLineCount-1):0)/2-e/2;this.height=e,this.p_=s}paint(t,e,s){const i=this.height,n=this.p_,r=s.lineWidth;s.lineWidth=this.renderer.smuflMetrics.deadSlappedLineWidth,s.moveTo(t+this.x,e+n),s.lineTo(t+this.x+this.width,e+n+i),s.moveTo(t+this.x,e+n+i),s.lineTo(t+this.x+this.width,e+n),s.stroke(),s.lineWidth=r}}class ul extends Ra{b_;Ne;l_;m_;g_=0;w_=0;constructor(t,e,s,i,n,r){super(t,e),this.b_=i,this.l_=s,this.Ne=n,this.m_=r}getBoundingBoxTop(){let t=-this.height/2;return this.m_>0&&this.g_<t&&(t=this.g_),this.y+t}getBoundingBoxBottom(){let t=this.height/2;const e=this.g_+Math.abs(this.m_)*this.w_*2;return this.m_<0&&t<e&&(t=e),this.y+t}paint(t,e,s){const i=this.Ne.isRest?ro.beat(s,_t.NumberedRests,this.Ne):this.Ne.notes.length>0?ro.note(s,pt.NumberedNumber,this.Ne.notes[0]):void 0;try{const i=this.renderer.resources;s.font=this.b_?i.numberedNotationGraceFont:i.numberedNotationFont;const n=s.textBaseline;s.textBaseline=ot.Middle,s.textAlign=ht.Left,s.fillText(this.l_.toString(),t+this.x,e+this.y),s.textBaseline=n;const r=Math.abs(this.m_);let a=this.g_+i.engravingSettings.glyphTop.get(ut.AugmentationDot);for(let i=0;i<r;i++)Ot.fillMusicFontSymbolSafe(s,t+this.x+this.width/2,e+this.y+a,1,ut.AugmentationDot,!0),a+=2*this.w_}finally{i?.[Symbol.dispose]?.()}}doLayout(){const t=this.renderer.resources,e=this.b_?t.numberedNotationGraceFont:t.numberedNotationFont,s=this.renderer.scoreRenderer.canvas;s.font=e;const i=s.measureText(`${this.l_}`);this.height=i.height,this.width=i.width;const n=this.m_,r=t.engravingSettings.glyphHeights.get(ut.AugmentationDot),a=Math.abs(n)*r*2;n>0?this.g_=-this.height/2-a-t.engravingSettings.glyphTop.get(ut.AugmentationDot):n<0&&(this.g_=this.height/2+r+t.engravingSettings.glyphTop.get(ut.AugmentationDot)),this.w_=r}}class dl extends Ra{constructor(t,e,s){super(t,e),this.width=s}getBoundingBoxTop(){return Number.NaN}getBoundingBoxBottom(){return Number.NaN}}class fl extends ol{isNaturalizeAccidental=!1;accidental=x.None;skipLayout=!1;get effectElement(){return _t.NumberedEffects}doLayout(){if(!this.skipLayout){if(!this.container.beat.isRest&&!this.container.beat.isEmpty){const t=new al;if(t.renderer=this.renderer,this.container.beat.notes.length>0){const e=this.container.beat.notes[0],s=e?e.accidentalMode:b.Default,i=li.getNoteValue(e);let n=Xt.computeAccidental(this.renderer.bar.keySignature,s,i,e.hasQuarterToneOffset);if(n===x.Natural){n=this.renderer.bar.keySignature+7<7?x.Sharp:x.Flat,this.isNaturalizeAccidental=!0}if(n!==x.None){this.accidental=n;const s=this.renderer,i=ro.noteColor(s.resources,pt.NumberedAccidentals,e),r=new To(0,s.getLineY(0),n,e.beat.graceType!==u.None?Or.GraceScale*Or.GraceScale:Or.GraceScale);r.colorOverride=i,r.renderer=this.renderer,t.addGlyph(r),this.addNormal(t),this.addNormal(new dl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))}}}super.doLayout()}}}class pl extends cl{noteHeads=null;deadSlapped=null;get effectElement(){return _t.NumberedEffects}getNoteX(t,e){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let t=s.x;switch(e){case Bh.Left:break;case Bh.Center:t+=s.width/2;break;case Bh.Right:t+=s.width}return t}return 0}buildBoundingsLookup(t,e,s){if(this.noteHeads&&this.container.beat.notes.length>0){const i=new ba;i.note=this.container.beat.notes[0],i.noteHeadBounds=new zs,i.noteHeadBounds.x=e+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}getLowestNoteY(t){return this.y_(t)}getHighestNoteY(t){return this.y_(t)}getNoteY(t,e){return this.y_(e)}getRestY(t){return this.y_(t)}y_(t){let e=null;if(this.noteHeads?e=this.noteHeads:this.deadSlapped&&(e=this.deadSlapped),e){let s=this.y+e.y;switch(t){case Sh.Top:case Sh.TopWithStem:s-=e.height/2;break;case Sh.Center:break;case Sh.Bottom:case Sh.BottomWithStem:s+=e.height/2;case Sh.StemUp:case Sh.StemDown:}return s}return 0}static majorKeySignatureOneValues=[59,66,61,68,63,58,65,60,67,62,69,64,71,66,61];static minorKeySignatureOneValues=[71,66,73,68,63,70,65,72,67,74,69,64,71,66,73];doLayout(){const t=this.renderer;t.shortestDuration<this.container.beat.duration&&(t.shortestDuration=this.container.beat.duration);let e=0;if(!this.container.beat.isEmpty){const s=t.getLineY(0);let i="0";if(this.container.beat.notes.length>0){const t=this.container.beat.notes[0],s=this.renderer.bar.keySignatureType,n=this.renderer.bar.keySignature,r=n+7,a=(s===P.Minor?pl.minorKeySignatureOneValues:pl.majorKeySignatureOneValues)[r];if(t.isDead)i="X";else{const s=t.displayValue-a,h=s<0?(s%12+12)%12:s%12;e=s<0?(Math.abs(s)+12)/12|0:s/12|0,s<0&&(e*=-1);let o=(Xt.keySignatureIsSharp(n)||Xt.keySignatureIsNatural(n)?li.flatNoteSteps:li.sharpNoteSteps)[h]+1;Xt.accidentalNotes[h]&&!this.container.preNotes.isNaturalizeAccidental&&(r<7?o++:o--),i=o.toString()}}if(this.container.beat.deadSlapped){const t=new ll;t.renderer=this.renderer,t.doLayout(),this.deadSlapped=t,this.addEffect(t)}else{const t=this.container.beat.graceType!==u.None,n=new ul(0,s,i,t,this.container.beat,e);this.noteHeads=n,this.addNormal(n)}if(this.container.beat.dots>0&&this.container.beat.duration>=l.Quarter)for(let t=0;t<this.container.beat.dots;t++){const t=new hl(0,s);t.renderer=this.renderer,this.addEffect(t)}}super.doLayout(),this.container.beat.isEmpty?this.onTimeX=this.width/2:this.noteHeads?this.onTimeX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.onTimeX=this.deadSlapped.x+this.deadSlapped.width/2),this.middleX=this.onTimeX,this.stemX=this.middleX}}class bl extends $o{calculateTieDirection(){return this.isLeftHandTap?Rt.Up:bl.getBeamDirectionForNote(this.startNote)}static getBeamDirectionForNote(t){return t.string>3?Rt.Up:Rt.Down}}class ml extends bl{k_;constructor(t,e,s,i,n){super(t,e,s,n),this.k_=i}getTieHeight(t,e,s,i){return Math.log(s-t+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(t,e,s,i){if(this.k_!==s)return!1;if(this.startNote.beat.id!==t.beat.id)return!1;if(this.endNote.beat.id!==e.beat.id)return!1;if(this.renderer===this.lookupEndBeatRenderer()!==i)return!1;if(this.tieDirection!==bl.getBeamDirectionForNote(t))return!1;switch(this.tieDirection){case Rt.Up:t.realValue>this.startNote.realValue&&(this.startNote=t),e.realValue>this.endNote.realValue&&(this.endNote=e);break;case Rt.Down:t.realValue<this.startNote.realValue&&(this.startNote=t),e.realValue<this.endNote.realValue&&(this.endNote=e)}return!0}}class gl extends ml{calculateTieDirection(){return Rt.Up}}class wl extends Oa{An=new Map;S_=[];B_;hasAdditionalNumbers=!1;*iterateAdditionalNumbers(){const t=this.B_;if(t)for(const e of t)e instanceof yl&&(yield e)}constructor(t){super(t),this.preNotes=new fl,this.onNotes=new pl}addDash(t){let e=this.B_;e||(e=[],this.B_=e),e.push(t)}addNotes(t){let e=this.B_;e||(e=[],this.B_=e),e.push(t),this.hasAdditionalNumbers=!0}doLayout(){this.An.clear(),this.S_=[],super.doLayout()}buildBoundingsLookup(t,e,s){super.buildBoundingsLookup(t,e,s);const i=this.B_;if(i){const e=t.beats[t.beats.length-1],s=i[i.length-1],n=s.x+s.contentWidth;e.visualBounds.w=n-e.visualBounds.x;const r=s.x+s.width;e.realBounds.w=r-e.realBounds.x}}createTies(t){if(t.isVisible){if(t.isTieOrigin&&t.tieDestination.isVisible&&!this.An.has("numbered.tie")){const e=new nl(`numbered.tie.${t.beat.id}`,t,t.tieDestination,!1);this.addTie(e),this.An.set(e.slurEffectId,e)}if(t.isTieDestination){const e=new nl(`numbered.tie.${t.tieOrigin.beat.id}`,t.tieOrigin,t,!0);this.addTie(e)}if(t.isLeftHandTapped&&!t.isHammerPullDestination&&!this.An.has(`numbered.tie.leftHandTap.${t.beat.id}`)){const e=new nl(`numbered.tie.leftHandTap.${t.beat.id}`,t,t,!1);this.addTie(e),this.An.set(e.slurEffectId,e)}if(t.isEffectSlurOrigin&&t.effectSlurDestination){let e=!1;for(const s of this.S_)if(s.tryExpand(t,t.effectSlurDestination,!1,!1)){e=!0;break}if(!e){const e=new gl("numbered.slur.effect",t,t.effectSlurDestination,!1,!1);this.S_.push(e),this.addTie(e),this.An.set(e.slurEffectId,e),this.An.set("numbered.slur.effect",e)}}if(t.isEffectSlurDestination&&t.effectSlurOrigin){let e=!1;for(const s of this.S_)if(s.tryExpand(t.effectSlurOrigin,t,!1,!0)){e=!0;break}if(!e){const e=new gl("numbered.slur.effect",t.effectSlurOrigin,t,!1,!0);this.S_.push(e),this.addTie(e),this.An.set(e.slurEffectId,e),this.An.set("numbered.slur.effect",e)}}}}}class yl extends wl{__;T_;constructor(t,e,s){super(t),this.__=e,this.T_=s,this.preNotes.skipLayout=!0,this.barCount=yl.x_(s)}static x_(t){return t>=$.toTicks(l.Eighth)?1:t>=$.toTicks(l.Sixteenth)?2:t>=$.toTicks(l.ThirtySecond)?3:t>=$.toTicks(l.SixtyFourth)?4:t>=$.toTicks(l.OneHundredTwentyEighth)?5:t>=$.toTicks(l.TwoHundredFiftySixth)?6:0}barCount;get beatId(){return-1}get contentWidth(){return this.onNotes.width}get absoluteDisplayStart(){return this.__}get displayDuration(){return this.T_}get graceType(){return u.None}get graceIndex(){return 0}get graceGroup(){return null}get isFirstOfTupletGroup(){return!1}get tupletGroup(){return null}get isLastOfVoice(){return!1}buildBoundingsLookup(t,e,s){}}class kl extends Ia{__;M_;constructor(t,e){super(0,0),this.__=e,this.M_=t}get beatId(){return-1}get contentWidth(){return this.renderer.smuflMetrics.numberedDashGlyphWidth}get absoluteDisplayStart(){return this.__}get displayDuration(){return $.QuarterTime}get onTimeX(){return this.renderer.smuflMetrics.numberedDashGlyphWidth/2}get graceType(){return u.None}get graceIndex(){return 0}get graceGroup(){return null}get voiceIndex(){return this.M_}get isFirstOfTupletGroup(){return!1}get tupletGroup(){return null}get isLastOfVoice(){return!1}getLowestNoteY(t){return 0}getHighestNoteY(t){return 0}getNoteY(t,e){return 0}doMultiVoiceLayout(){}getRestY(t){return 0}getNoteX(t,e){return 0}getBeatX(t,e){return 0}registerLayoutingInfo(t){const e=this.renderer.smuflMetrics.numberedDashGlyphWidth;t.addBeatSpring(this,e/2,e/2)}applyLayoutingInfo(t){}buildBoundingsLookup(t,e,s){}paint(t,e,s){const i=this.renderer,n=i.smuflMetrics.numberedDashGlyphWidth,r=i.smuflMetrics.numberedBarRendererBarSize,a=Math.ceil(e+i.getLineY(0)-r);s.fillRect(t+this.x,a,n,r)}}class Sl extends Ra{v_;colorOverride;constructor(t){super(0,0),this.v_=t}doLayout(){super.doLayout(),this.width=this.renderer.smuflMetrics.ghostParenthesisWidth+this.renderer.smuflMetrics.ghostParenthesisPadding}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),this.v_?Vo.paintTie(s,1,t+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,e+this.y+this.height,t+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,e+this.y,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness):Vo.paintTie(s,1,t+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,e+this.y,t+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,e+this.y+this.height,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness),s.color=i}}class Bl extends no{N_=0;P_=0;C_;E_;barSubElement=E.StandardNotationTimeSignature;constructor(t,e,s,i,n,r){super(t,e),this.N_=s,this.P_=i,this.C_=n,this.E_=r}paint(t,e,s){const i=ro.bar(s,this.barSubElement,this.renderer.bar);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){if(this.C_&&2===this.N_&&2===this.P_){const t=new Yh(0,0,this.commonScale,ut.TimeSigCutCommon);this.addGlyph(t),super.doLayout()}else if(this.C_&&4===this.N_&&4===this.P_){const t=new Yh(0,0,this.commonScale,ut.TimeSigCommon);this.addGlyph(t),super.doLayout()}else{const t=new Uo(0,0,this.N_,ot.Top,this.numberScale),e=new Uo(0,0,this.P_,ot.Bottom,this.numberScale);this.addGlyph(t),this.addGlyph(e),super.doLayout();const s=this.width;t.x=(s-t.width)/2,e.x=(s-e.width)/2,this.width=Math.max(t.x+t.width,e.x+e.width)}if(this.E_){const t=2*this.renderer.smuflMetrics.oneStaffSpace,e=new Sl(!0);e.renderer=this.renderer,e.y=-t,e.height=2*t,e.doLayout();for(const t of this.glyphs)t.x+=e.width;this.width+=e.width,this.addGlyph(e);const s=new Sl(!1);s.renderer=this.renderer,s.x=this.width,s.y=-t,s.height=2*t,s.doLayout(),this.addGlyph(s),this.width+=s.width}}}class _l extends Bl{get commonScale(){return 1}get numberScale(){return 1}}class Tl extends Yh{constructor(t,e,s,i,n){super(t,e,n?Or.GraceScale:1,Tl.getSymbol(s,i,n))}paint(t,e,s){const i=s.color;super.paint(t,e,s),s.color=i}static getSymbol(t,e,s){if(s&&(t=l.Eighth),e===Rt.Up)switch(t){case l.Eighth:return ut.Flag8thUp;case l.Sixteenth:return ut.Flag16thUp;case l.ThirtySecond:return ut.Flag32ndUp;case l.SixtyFourth:return ut.Flag64thUp;case l.OneHundredTwentyEighth:return ut.Flag128thUp;case l.TwoHundredFiftySixth:return ut.Flag256thUp;default:return ut.Flag8thUp}switch(t){case l.Eighth:return ut.Flag8thDown;case l.Sixteenth:return ut.Flag16thDown;case l.ThirtySecond:return ut.Flag32ndDown;case l.SixtyFourth:return ut.Flag64thDown;case l.OneHundredTwentyEighth:case l.TwoHundredFiftySixth:return ut.Flag128thDown;default:return ut.Flag8thDown}}}class xl extends Ra{F_=0;constructor(t,e,s){super(t,e),this.F_=0,this.F_=s}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.elementFonts.get(t.NotationElement.RepeatCount);const e=this.renderer.scoreRenderer.canvas.measureText(`x${this.F_}`);this.width=0,this.height=e.height,this.y-=e.height}paint(e,s,i){const n=ro.bar(i,this.renderer.repeatsBarSubElement,this.renderer.bar);try{const n=this.renderer.resources,r=i.textAlign;i.font=n.elementFonts.get(t.NotationElement.RepeatCount),i.textAlign=ht.Right;const a=`x${this.F_}`,h=i.measureText(a).width/1.5;i.fillText(a,e+this.x-h,s+this.y),i.textAlign=r}finally{n?.[Symbol.dispose]?.()}}}class Ml extends tc{firstLineY=0;A_=!1;tupletSize=0;get lineOffset(){return this.lineSpacing}get tupletOffset(){return.5*this.smuflMetrics.oneStaffSpace}get topGlyphOverflow(){return 0}get bottomGlyphOverflow(){return 0}initLineBasedSizes(){this.height=this.lineOffset*(this.heightLineCount-1)}updateSizes(){this.initLineBasedSizes(),this.adjustSizes(),this.updateFirstLineY(),super.updateSizes()}adjustSizes(){}updateFirstLineY(){const t=this.lineOffset*(this.heightLineCount-1),e=0===this.drawnLineCount?0:(this.drawnLineCount-1)*this.lineOffset,s=this.smuflMetrics.staffLineThickness/2;this.firstLineY=((t-e)/2|0)-s}doLayout(){this.initLineBasedSizes(),this.updateFirstLineY(),this.tupletSize=this.smuflMetrics.glyphHeights.get(ut.Tuplet0),super.doLayout()}getLineY(t){return this.firstLineY+this.getLineHeight(t)}getLineHeight(t){return this.lineOffset*t}paintContent(t,e,s){super.paintContent(t,e,s),this.paintBeams(t,e,s,this.flagsSubElement,this.beamsSubElement),this.paintTuplets(t,e,s,this.tupletSubElement)}paintBackground(t,e,s){super.paintBackground(t,e,s),this.paintStaffLines(t,e,s),this.paintSimileMark(t,e,s)}paintStaffLines(t,e,s){const i=ro.bar(s,this.staffLineBarSubElement,this.bar,!0);try{const i=[];for(let t=0,e=this.drawnLineCount;t<e;t++)i.push([]);this.additionalMultiRestBars||this.collectSpaces(i);for(const t of i)t.sort((t,e)=>t[0]>e[0]?1:t[0]<e[0]?-1:0);const n=this.width,r=this.smuflMetrics.staffLineThickness/2;for(let a=0;a<this.drawnLineCount;a++){const h=this.getLineY(a)-r;let o=0;for(const n of i[a])s.fillRect(t+this.x+o,e+this.y+h,n[0]-o,this.smuflMetrics.staffLineThickness),o=n[0]+n[1];s.fillRect(t+this.x+o,e+this.y+h,n-o,this.smuflMetrics.staffLineThickness)}}finally{i?.[Symbol.dispose]?.()}}collectSpaces(t){}createStartSpacing(){if(this.A_)return!1;const t=0===this.index?this.settings.display.firstStaffPaddingLeft:this.settings.display.staffPaddingLeft;return this.addPreBeatGlyph(new dl(0,0,t)),this.A_=!0,!0}paintTuplets(t,e,s,i,n=!1){for(const r of this.voiceContainer.voiceDrawOrder)if(this.voiceContainer.tupletGroups.has(r)){const a=this.voiceContainer.tupletGroups.get(r);for(const r of a)this.D_(t,e,s,r,i,n)}}getBeatDirection(t){const e=this.helpers.getBeamingHelperForBeat(t);return e?this.getBeamDirection(e):Rt.Up}getTupletBeamDirection(t){return this.getBeamDirection(t)}calculateBeamYWithDirection(t,e,s){return this.ensureBeamDrawingInfo(t,s),t.drawingInfos.get(s).calcY(e)}D_(t,e,s,i,n,r){const a=this.resources,h=s.textAlign,o=s.textBaseline;let c;s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.textAlign=ht.Center,s.textBaseline=ot.Middle;const l=i.beats[0].tupletNumerator,u=i.beats[0].tupletDenominator;if(2===l&&3===u)c=[ut.Tuplet2];else if(3===l&&2===u)c=[ut.Tuplet3];else if(4===l&&6===u)c=[ut.Tuplet4];else if(5===l&&4===u)c=[ut.Tuplet5];else if(6===l&&4===u)c=[ut.Tuplet6];else if(7===l&&4===u)c=[ut.Tuplet7];else if(9===l&&8===u)c=[ut.Tuplet9];else if(10===l&&8===u)c=[ut.Tuplet1,ut.Tuplet0];else if(11===l&&8===u)c=[ut.Tuplet1,ut.Tuplet1];else if(12===l&&8===u)c=[ut.Tuplet1,ut.Tuplet2];else if(13===l&&8===u)c=[ut.Tuplet1,ut.Tuplet3];else{c=[];const t=ut.Tuplet0;l>10?(c.push(t+Math.floor(l/10)),c.push(t+(l-10))):c.push(t+l),c.push(ut.TupletColon),u>10?(c.push(t+Math.floor(u/10)),c.push(t+(u-10))):c.push(t+u)}const d=this.tupletOffset,f=this.tupletSize,p=d+.5*f,b=ro.beat(s,n,i.beats[0]);try{const n=s.lineWidth;if(s.lineWidth=this.smuflMetrics.tupletBracketThickness,1!==i.beats.length&&i.isFull){const n=i.beats[0],h=i.beats[i.beats.length-1];let o=null,l=null;for(let t=0;t<i.beats.length;t++)if(!i.beats[t].isRest){o=i.beats[t];break}for(let t=i.beats.length-1;t>=0;t--)if(!i.beats[t].isRest){l=i.beats[t];break}let u=!1;o||(o=n,u=!0),l||(l=h);const d=this.getBeatX(n,ms.OnNotes),b=this.getBeatX(h,ms.PostNotes),m=this.helpers.getBeamingHelperForBeat(o),g=this.helpers.getBeamingHelperForBeat(l),w=this.getTupletBeamDirection(m);let y=this.calculateBeamYWithDirection(m,d,w),k=this.calculateBeamYWithDirection(g,b,w);u&&(y=Math.max(y,k),k=y),w===Rt.Down?(y+=p,k+=p):(y-=p,k-=p);const S=c.reduce((t,e)=>t+a.engravingSettings.glyphWidths.get(e),0),B=.5*a.engravingSettings.oneStaffSpace,_=(d+b)/2,T=_-S/2-B,x=_+S/2+B,M=(k-y)/(b-d),v=y-M*d,N=M*T+v,P=M*_+v,C=M*x+v,E=w===Rt.Down?y-.5*f:y+.5*f,F=w===Rt.Down?k-.5*f:k+.5*f,A=s.lineWidth%2==0?0:.5;t+=A,e+=A,T>d&&(s.beginPath(),s.moveTo(t+this.x+d,e+this.y+E),r?s.quadraticCurveTo(t+this.x+(T+d)/2,e+this.y+N,t+this.x+T,e+this.y+N):(s.lineTo(t+this.x+d,e+this.y+y),s.lineTo(t+this.x+T,e+this.y+N)),s.moveTo(t+this.x+x,e+this.y+C),r?s.quadraticCurveTo(t+this.x+(b+x)/2,e+this.y+C,t+this.x+b,e+this.y+F):(s.lineTo(t+this.x+b,e+this.y+k),s.lineTo(t+this.x+b,e+this.y+F)),s.stroke()),s.fillMusicFontSymbols(t+this.x+_,e+this.y+P+.5*f,1,c,!0)}else for(const n of i.beats){const i=this.helpers.getBeamingHelperForBeat(n);if(!i)continue;const r=this.getTupletBeamDirection(i),a=this.getBeatX(n,ms.Stem);let h=this.calculateBeamYWithDirection(i,a,r);r===Rt.Down?h+=p:h-=p,s.fillMusicFontSymbols(t+this.x+a,e+this.y+h+.5*f,1,c,!0)}s.textAlign=h,s.textBaseline=o,s.lineWidth=n}finally{b?.[Symbol.dispose]?.()}}paintBeams(t,e,s,i,n){for(const r of this.voiceContainer.voiceDrawOrder)for(const a of this.helpers.beamHelpers[r])this.paintBeamHelper(t,e,s,a,i,n)}drawBeamHelperAsFlags(t){return 1===t.beats.length}hasFlag(t){if(t.isRest)return!1;const e=this.helpers.getBeamingHelperForBeat(t);return e?e.hasFlag(this.drawBeamHelperAsFlags(e),t):Jo.beatHasFlag(t)}hasStem(t){if(t.isRest)return!1;const e=this.helpers.getBeamingHelperForBeat(t);return e?e.hasStem(this.drawBeamHelperAsFlags(e),t):Jo.beatHasStem(t)}paintBeamHelper(t,e,s,i,n,r){s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,this.shouldPaintBeamingHelper(i)&&(this.drawBeamHelperAsFlags(i)?this.paintFlag(t,e,s,i,n):this.paintBar(t,e,s,i,r))}shouldPaintBeamingHelper(t){return!t.isRestBeamHelper}shouldPaintFlag(e){return e.graceType!==u.BendGrace&&(!e.deadSlapped&&((e.graceType===u.None||this.settings.notation.notationMode!==t.NotationMode.SongBook)&&(e.duration!==l.Whole&&e.duration!==l.DoubleWhole&&e.duration!==l.QuadrupleWhole)))}paintFlag(t,e,s,i,n){for(const r of i.beats){if(!this.shouldPaintFlag(r))continue;const a=r.graceType!==u.None,h=this.getBeatX(r,ms.Stem),o=this.getBeamDirection(i),c=e+this.y+this.getFlagTopY(r,o),l=e+this.y+this.getFlagBottomY(r,o);let d=0;if(d=o===Rt.Down?l:c,!i.hasStem(!0,r))continue;this.paintBeamingStem(r,e+this.y,t+this.x+h,c,l,s);const f=ro.beat(s,n,r);try{let e=0;if(i.hasFlag(!0,r)){const i=new Tl(t+this.x+h,d,r.duration,o,a);i.renderer=this,i.doLayout(),i.paint(0,0,s),e=i.width/2}r.graceType===u.BeforeBeat&&(o===Rt.Down?Ot.fillMusicFontSymbolSafe(s,t+this.x+h+e/2,(c+l-this.smuflMetrics.glyphHeights.get(ut.GraceNoteSlashStemDown))/2,Or.GraceScale,ut.GraceNoteSlashStemDown,!0):Ot.fillMusicFontSymbolSafe(s,t+this.x+h+e/2,(c+l+this.smuflMetrics.glyphHeights.get(ut.GraceNoteSlashStemUp))/2,Or.GraceScale,ut.GraceNoteSlashStemUp,!0))}finally{f?.[Symbol.dispose]?.()}}}recreatePreBeatGlyphs(){this.A_=!1,super.recreatePreBeatGlyphs()}calculateBeamY(t,e){return this.calculateBeamYWithDirection(t,e,this.getBeamDirection(t))}createPreBeatGlyphs(){super.createPreBeatGlyphs(),this.addPreBeatGlyph(new sl(!1,this.bar.staff.track.score.stylesheet.extendBarLines)),this.createLinePreBeatGlyphs();let t=!1;0===this.index&&(t=this.createStartSpacing()),this.shouldCreateBarNumber()?this.addPreBeatGlyph(new il(0,this.getLineHeight(-.5),this.bar.index+1)):t||this.addPreBeatGlyph(new dl(0,0,this.smuflMetrics.oneStaffSpace))}shouldCreateBarNumber(){let e=I.AllBars;switch(e=this.settings.notation.isNotationElementVisible(t.NotationElement.BarNumber)?void 0!==this.bar.barNumberDisplay?this.bar.barNumberDisplay:this.bar.staff.track.score.stylesheet.barNumberDisplay:I.Hide,e){case I.AllBars:return!0;case I.FirstOfSystem:return this.isFirstOfStaff;case I.Hide:return!1}return!0}createPostBeatGlyphs(){super.createPostBeatGlyphs();const e=this.lastBar;this.addPostBeatGlyph(new sl(!0,this.bar.staff.track.score.stylesheet.extendBarLines)),e.masterBar.isRepeatEnd&&e.masterBar.repeatCount>2&&this.settings.notation.isNotationElementVisible(t.NotationElement.RepeatCount)&&this.addPostBeatGlyph(new xl(0,this.getLineHeight(-.5),this.bar.masterBar.repeatCount))}paintBar(t,e,s,i,n){const r=this.getBeamDirection(i),a=i.graceType!==u.None?Or.GraceScale:1;let h=(this.beamSpacing+this.beamThickness)*a,o=this.beamThickness*a;r===Rt.Down&&(h=-h,o=-o);for(let c=0,l=i.beats.length;c<l;c++){const l=i.beats[c];if(l.deadSlapped)continue;const u=this.getBeatX(l,ms.Stem);let d=e+this.y;r===Rt.Up?d+=this.getFlagBottomY(l,r):d+=this.getFlagTopY(l,r);const f=e+this.y+this.calculateBeamY(i,u);let p,b;d<f?(p=d,b=f):(p=f,b=d),this.paintBeamingStem(l,e+this.y,t+this.x+u,p,b,s);const m=ro.beat(s,n,l);try{const n=this.smuflMetrics.brokenBeamWidth*a,r=Xt.getIndex(l.duration)-2,d=e+this.y,f=this.smuflMetrics.stemThickness;for(let e=0;e<r;e++){let a=Math.floor(u+f),p=0,b=0,m=0;const g=d+e*h;if(c<i.beats.length-1){const h=Jo.isFullBarJoin(l,i.beats[c+1],e);if(e===r-1&&h&&l.beamingMode===Bt.ForceSplitOnSecondaryToNext)p=Math.ceil(a+n),b=g+this.calculateBeamY(i,a),m=g+this.calculateBeamY(i,p),Ml.paintSingleBar(s,t+this.x+a,b,t+this.x+p,m,o),p=Math.floor(this.getBeatX(i.beats[c+1],ms.Stem)),a=Math.floor(p-n),b=g+this.calculateBeamY(i,a),m=g+this.calculateBeamY(i,p),Ml.paintSingleBar(s,t+this.x+a,b,t+this.x+p,m,o);else{if(h)p=Math.ceil(this.getBeatX(i.beats[c+1],ms.Stem));else{if(0!==c&&Jo.isFullBarJoin(i.beats[c-1],l,e))continue;p=Math.ceil(a+n)}b=g+this.calculateBeamY(i,a),m=g+this.calculateBeamY(i,p),Ml.paintSingleBar(s,t+this.x+a,b,t+this.x+p,m,o)}}else c>0&&!Jo.isFullBarJoin(l,i.beats[c-1],e)&&(p=Math.ceil(u),a=Math.floor(u-n),b=g+this.calculateBeamY(i,a),m=g+this.calculateBeamY(i,p),Ml.paintSingleBar(s,t+this.x+a,b,t+this.x+p,m,o))}}finally{m?.[Symbol.dispose]?.()}}if(i.graceType===u.BeforeBeat){const n=this.getBeatX(i.beats[0],ms.Stem),a=this.smuflMetrics.glyphWidths.get(ut.Flag8thUp)*Or.GraceScale;let c=e+this.y+this.calculateBeamY(i,n)|0;c+=o+h,r===Rt.Down?Ot.fillMusicFontSymbolSafe(s,t+this.x+n+a/2,c,Or.GraceScale,ut.GraceNoteSlashStemDown,!0):Ot.fillMusicFontSymbolSafe(s,t+this.x+n+a/2,c,Or.GraceScale,ut.GraceNoteSlashStemUp,!0)}}static paintSingleBar(t,e,s,i,n,r){t.beginPath(),t.moveTo(e,s),t.lineTo(i,n),t.lineTo(i,n+r),t.lineTo(e,s+r),t.closePath(),t.fill()}calculateBeamingOverflows(t,e){let s=0,i=0;for(const t of this.helpers.beamHelpers)for(const e of t)if(this.shouldPaintBeamingHelper(e))if(1===e.beats.length&&e.beats[0].duration>=l.Half){const t=this.getTupletBeamDirection(e),n=this.getBeamDirection(e),r=this.smuflMetrics.stemFlagOffsets.get(e.beats[0].duration);if(n===Rt.Up){let a=this.getFlagTopY(e.beats[0],n)-r;if(e.hasTuplet&&t===n&&(a-=this.tupletSize+this.tupletOffset),a<s&&(s=a),e.hasTuplet&&t!==n){let s=this.getFlagBottomY(e.beats[0],t);s+=this.tupletSize+this.tupletOffset,s>i&&(i=s)}}else{let a=this.getFlagBottomY(e.beats[0],n)+r;if(e.hasTuplet&&t===n&&(a+=this.tupletSize+this.tupletOffset),a>i&&(i=a),e.hasTuplet&&t!==n){let i=this.getFlagTopY(e.beats[0],t);i-=this.tupletSize+this.tupletOffset,i<s&&(s=i)}}}else{const t=this.getBeamDirection(e);this.ensureBeamDrawingInfo(e,t);const n=e.drawingInfos.get(t),r=this.getTupletBeamDirection(e);if(t===Rt.Up){let a=Math.min(n.startY,n.endY);e.hasTuplet&&r===t&&(a-=this.tupletSize+this.tupletOffset),a<s&&(s=a);let h=this.voiceContainer.getLowestNoteY(e.beatOfLowestNote,Sh.Bottom);e.hasTuplet&&r!==t&&(h+=this.tupletSize+this.tupletOffset),h>i&&(i=h)}else{let a=Math.max(n.startY,n.endY);e.hasTuplet&&r===t&&(a+=this.tupletSize+this.tupletOffset),a>i&&(i=a);let h=this.voiceContainer.getHighestNoteY(e.beatOfHighestNote,Sh.Top);e.hasTuplet&&r!==t&&(h-=this.tupletSize+this.tupletOffset),h<s&&(s=h)}}else;s<t&&this.registerOverflowTop(Math.abs(s)),i>e&&this.registerOverflowBottom(Math.abs(i)-e)}initializeBeamDrawingInfo(t,e){const s=new jo,i=t.beats[0],n=t.beats[t.beats.length-1];s.startBeat=i,s.startX=this.getBeatX(i,ms.Stem),s.startY=e===Rt.Up?this.getFlagTopY(i,e):this.getFlagBottomY(i,e),s.endBeat=n,s.endX=this.getBeatX(n,ms.Stem),s.endY=e===Rt.Up?this.getFlagTopY(n,e):this.getFlagBottomY(n,e);const r=this.smuflMetrics.oneStaffSpace;return e===Rt.Down&&s.startY>s.endY&&s.startY-s.endY>r&&(s.endY=s.startY-r),e===Rt.Down&&s.endY>s.startY&&s.endY-s.startY>r&&(s.startY=s.endY-r),e===Rt.Up&&s.startY<s.endY&&s.endY-s.startY>r&&(s.endY=s.startY+r),e===Rt.Up&&s.endY<s.startY&&s.startY-s.endY>r&&(s.startY=s.endY+r),s}get beamSpacing(){return this.smuflMetrics.beamSpacing}get beamThickness(){return this.smuflMetrics.beamThickness}ensureBeamDrawingInfo(t,e){if(t.drawingInfos.has(e))return;const s=this.initializeBeamDrawingInfo(t,e);t.drawingInfos.set(e,s);const i=Xt.getIndex(t.shortestDuration)-2,n=this.applyBarShift(t,e,s,i);if(t.beats.length>1){if(e===Rt.Up){const i=n+this.getFlagTopY(t.beatOfHighestNote,e),r=s.calcY(this.getBeatX(t.beatOfHighestNote,ms.Stem))-i;r>0&&(s.startY-=r,s.endY-=r)}else{const i=n+this.getFlagBottomY(t.beatOfLowestNote,e)-s.calcY(this.getBeatX(t.beatOfLowestNote,ms.Stem));i>0&&(s.startY+=i,s.endY+=i)}let r=0;if(t.restBeats.length>0){const e=t.graceType!==u.None?Or.GraceScale:1;r=i*(this.beamSpacing+this.beamThickness)*e}for(const i of t.restBeats)if(i.isRest&&i.index<t.beats[t.beats.length-1].index)if(e===Rt.Up){const t=this.getBeatContainer(i).getBoundingBoxTop()-r,e=s.calcY(this.getBeatX(i,ms.Stem))-t;e>0&&(s.startY-=e,s.endY-=e)}else if(e===Rt.Down){const t=this.getBeatContainer(i).getBoundingBoxBottom()+r-s.calcY(this.getBeatX(i,ms.Stem));t>0&&(s.startY+=t,s.endY+=t)}if(t.slashBeats.length>0)for(const i of t.slashBeats){const t=s.calcY(this.getBeatX(i,ms.Stem)),n=(e===Rt.Up?this.getFlagTopY(i,e):this.getFlagBottomY(i,e))-t;n>0&&(s.startY+=n,s.endY+=n)}}Rt.Up,s.startY=Math.round(s.startY),s.endY=Math.round(s.endY)}applyBarShift(t,e,s,i){let n=0;const r=t.isRestBeamHelper,a=t.graceType!==u.None?Or.GraceScale:1;if(i>2&&!r){const t=this.beamSpacing*a,r=this.beamThickness*a,h=i*r+(i-1)*t;if(e===Rt.Up){const e=s.startY+2*r+t-h,i=s.startY-e;i>0&&(n=-1*i,s.startY-=i,s.endY-=i)}else{const e=s.startY-2*r+t+h-s.startY;e>0&&(n=e,s.startY+=e,s.endY+=e)}}return n}getMinLineOfBeat(t){return 0}getMaxLineOfBeat(t){return 0}}class vl extends Ml{static StaffId="numbered";simpleWhammyOverflow=0;L_;shortestDuration=l.QuadrupleWhole;get dotSpacing(){return 2*this.smuflMetrics.glyphHeights.get(ut.AugmentationDot)}get repeatsBarSubElement(){return E.NumberedRepeats}get barNumberBarSubElement(){return E.NumberedBarNumber}get barLineBarSubElement(){return E.NumberedBarLines}get staffLineBarSubElement(){return E.NumberedStaffLine}constructor(t,e){super(t,e),this.L_=!e.staff.showSlash&&!e.staff.showTablature&&!e.staff.showStandardNotation}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 0}get bottomGlyphOverflow(){return 0}get flagsSubElement(){return _t.NumberedDuration}get beamsSubElement(){return _t.NumberedDuration}get tupletSubElement(){return _t.NumberedTuplet}shouldPaintBeamingHelper(t){return!0}paintFlag(t,e,s,i,n){this.paintBar(t,e,s,i,n)}paintBar(t,e,s,i,n){if(0!==i.beats.length&&i.graceType===u.None)for(let r=0,a=i.beats.length;r<a;r++){const a=i.beats[r],h=ro.beat(s,n,a);try{const n=this.getBeamDirection(i),h=i.graceType!==u.None?Or.GraceScale:1;let o=(this.beamSpacing+this.beamThickness)*h,c=this.beamThickness*h;n===Rt.Down&&(o=-o,c=-c);let l=Xt.getIndex(a.duration)-2,d=this.getBeatX(a,ms.PreNotes),f=0,p=0;r===i.beats.length-1?(f=d,p=this.getBeatX(a,ms.PostNotes)):(f=d,p=this.getBeatX(i.beats[r+1],ms.PreNotes));const b=e+this.y+this.calculateBeamY(i,d);for(let e=0;e<l;e++){const i=b+e*o;Ml.paintSingleBar(s,t+this.x+f,i,t+this.x+p,i,c)}const m=this.voiceContainer.getBeatContainer(a);if(m&&m.hasAdditionalNumbers)for(const e of m.iterateAdditionalNumbers()){l=e.barCount,d=this.beatGlyphsStart+e.x+e.getBeatX(ms.PreNotes,!1);for(let i=0;i<l;i++){const n=b+i*o,r=this.beatGlyphsStart+e.x+e.getBeatX(ms.PostNotes,!1);Ml.paintSingleBar(s,t+this.x+d,n,t+this.x+r,n,c)}}}finally{h?.[Symbol.dispose]?.()}}}calculateOverflows(t,e){super.calculateOverflows(t,e),this.bar.isEmpty||this.calculateBeamingOverflows(t,e)}getNoteLine(t){return 0}W_(t){const e=Xt.getIndex(t.duration)-2;let s=0;if(e>0){const t=this.smuflMetrics;s=t.numberedBarRendererBarSpacing+e*(t.numberedBarRendererBarSpacing+t.numberedBarRendererBarSize)}return s}getFlagTopY(t,e){const s=this.W_(t),i=this.voiceContainer.getBeatContainer(t);return i?e===Rt.Up?i.getBoundingBoxTop()-s:i.getBoundingBoxBottom():e===Rt.Up?this.voiceContainer.getBoundingBoxTop()-s:this.voiceContainer.getBoundingBoxBottom()}getFlagBottomY(t,e){const s=this.W_(t),i=this.voiceContainer.getBeatContainer(t);return i?e===Rt.Down?i.getBoundingBoxBottom()+s:this.getLineY(0):e===Rt.Down?this.voiceContainer.getBoundingBoxBottom()+s:this.getLineY(0)}getBeamDirection(t){return Rt.Down}getTupletBeamDirection(t){return Rt.Up}createPreBeatGlyphs(){this.wasFirstOfStaff=this.isFirstOfStaff,(0===this.index||this.bar.masterBar.isRepeatStart&&this.L_)&&this.addPreBeatGlyph(new sl(!1,this.bar.staff.track.score.stylesheet.extendBarLines)),this.createLinePreBeatGlyphs();const t=this.createStartSpacing();this.shouldCreateBarNumber()?this.addPreBeatGlyph(new il(0,this.getLineHeight(-.5),this.bar.index+1)):t||this.addPreBeatGlyph(new dl(0,0,this.smuflMetrics.oneStaffSpace))}createLinePreBeatGlyphs(){this.L_&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.R_())}R_(){const t=this.bar.masterBar,e=new _l(0,this.getLineY(0),t.timeSignatureNumerator,t.timeSignatureDenominator,t.timeSignatureCommon,t.isFreeTime&&(null==t.previousMasterBar||t.isFreeTime!==t.previousMasterBar.isFreeTime));e.barSubElement=E.NumberedTimeSignature,this.addPreBeatGlyph(e)}createPostBeatGlyphs(){this.L_&&super.createPostBeatGlyphs()}createVoiceGlyphs(t){if(t.index>0)return;super.createVoiceGlyphs(t);const e=this.bar.masterBar.start;for(const s of t.beats){const i=new wl(s);if(this.addBeatGlyph(i),s.duration<l.Quarter){const n=s.displayStart+s.displayDuration;let r=s.displayStart+$.QuarterTime;for(;r<n;){if(n-r>=$.QuarterTime){const s=new kl(t.index,e+r);this.addBeatGlyph(s),i.addDash(s)}else if(s.duration===l.Half&&s.dots>1){const t=new yl(s,e+r,n-r);this.addBeatGlyph(t),i.addNotes(t)}r+=$.QuarterTime}}}}paintBeamingStem(t,e,s,i,n,r){}get beamSpacing(){return this.smuflMetrics.numberedBarRendererBarSpacing}get beamThickness(){return this.smuflMetrics.numberedBarRendererBarSize}paintBeamHelper(t,e,s,i,n,r){0===i.voice?.index&&super.paintBeamHelper(t,e,s,i,n,r)}applyBarShift(t,e,s,i){return 0}calculateBeamYWithDirection(t,e,s){this.ensureBeamDrawingInfo(t,s);const i=t.drawingInfos.get(s);return s===Rt.Up?Math.min(i.startY,i.endY):Math.max(i.startY,i.endY)}paintTuplets(t,e,s,i,n=!1){super.paintTuplets(t,e,s,i,!0)}}class Nl extends Ch{get staffId(){return vl.StaffId}create(t,e){return new vl(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showNumbered}}class Pl extends Yh{I_;O_;G_;constructor(t,e,s,i){super(t,e,1,Pl.ik(s,i)),this.I_=s,this.O_=i}getBoundingBoxTop(){let t=super.getBoundingBoxTop();const e=this.G_;if(e){const s=this.y+e.getBoundingBoxTop();t=Xt.minBoundingBox(t,s)}return t}getBoundingBoxBottom(){let t=super.getBoundingBoxBottom();const e=this.G_;if(e){const s=this.y+e.getBoundingBoxBottom();t=Xt.maxBoundingBox(t,s)}return t}doLayout(){switch(this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(ut.GClef),this.offsetX=this.width/2,this.G_=void 0,this.I_){case M.C3:case M.C4:if(this.O_===m.T)return;break;case M.F4:case M.G2:return}let t,e=!1;switch(this.O_){case m.S:t=ut.Clef15,e=!0;break;case m._:t=ut.Clef8,e=!0;break;case m.T:t=ut.Clef8;break;case m.M:t=ut.Clef15;break;default:return}const s=this.width/2,i=e?this.renderer.smuflMetrics.glyphTop.get(this.symbol):this.renderer.smuflMetrics.glyphBottom.get(this.symbol)-this.renderer.smuflMetrics.glyphHeights.get(t);this.G_=new Yh(s,-i,1,t),this.G_.center=!0,this.G_.renderer=this.renderer,this.G_.doLayout()}static ik(t,e){switch(t){case M.Neutral:return ut.UnpitchedPercussionClef1;case M.C3:case M.C4:return e===m.T?ut.CClef8vb:ut.CClef;case M.F4:switch(e){case m.S:return ut.FClef15ma;case m._:return ut.FClef8va;case m.T:return ut.FClef8vb;case m.M:return ut.FClef15mb;default:return ut.FClef}case M.G2:switch(e){case m.S:return ut.GClef15ma;case m._:return ut.GClef8va;case m.T:return ut.GClef8vb;case m.M:return ut.GClef15mb;default:return ut.GClef}default:return ut.None}}paint(t,e,s){const i=ro.bar(s,E.StandardNotationClef,this.renderer.bar);try{super.paint(t,e,s);const i=this.G_;i&&i.paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}}class Cl extends Oo{paint(t,e,s){const i=ro.bar(s,E.StandardNotationKeySignature,this.renderer.bar);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}class El extends Eh{Le;constructor(t,e,s){super(t,e),this.Le=s}static ik(t,e){switch(t){case d.None:return ut.None;case d.Normal:return e?ut.ArticAccentAbove:ut.ArticAccentBelow;case d.Heavy:return e?ut.ArticMarcatoAbove:ut.ArticMarcatoBelow;case d.Tenuto:return e?ut.ArticTenutoAbove:ut.ArticTenutoBelow;default:return ut.None}}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(ut.ArticAccentAbove),this.height=this.renderer.smuflMetrics.glyphHeights.get(ut.ArticAccentAbove)}paint(t,e,s){const i=this.renderer.getBeatDirection(this.Le.beat),n=El.ik(this.Le.accentuated,i===Rt.Down),r=i===Rt.Up?e+this.y:e+this.y+this.height;Ot.fillMusicFontSymbolSafe(s,t+this.x,r,1,n,!0)}}class Fl extends Yh{constructor(t,e){super(t,e,Or.GraceScale,ut.ArticStaccatoAbove),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}class Al extends Yh{centerOnStem=!1;constructor(t,e,s,i){super(t,e,s?Or.GraceScale:1,i)}paint(t,e,s){this.centerOnStem&&(this.center=!0),super.paint(t,e,s)}}class Dl extends Al{constructor(t,e,s,i){super(t,e,i,Dl.getSymbol(s))}static getSymbol(t){switch(t){case l.QuadrupleWhole:return ut.NoteheadDoubleWholeSquare;case l.DoubleWhole:return ut.NoteheadDoubleWhole;case l.Whole:return ut.NoteheadWhole;case l.Half:return ut.NoteheadHalf;default:return ut.NoteheadBlack}}}class Ll extends Al{constructor(t,e,s){super(t,e,s,ut.NoteheadXOrnate)}}class Wl extends Al{constructor(t,e,s,i){super(t,e,i,Wl.ik(s))}static ik(t){switch(t){case l.QuadrupleWhole:case l.DoubleWhole:case l.Whole:case l.Half:return ut.NoteheadDiamondWhiteWide;default:return ut.NoteheadDiamondBlackWide}}}class Rl{steps=0;isGhost;color;constructor(t,e,s){this.steps=t,this.isGhost=e,this.color=s}}class Il extends Ra{v_;dk=[];V_=[];isEmpty=!0;constructor(t){super(0,0),this.v_=t}addParenthesis(e){const s=this.renderer,i=s.getNoteSteps(e),n=e.isGhost||this.H_(e)&&s.settings.notation.isNotationElementVisible(t.NotationElement.ParenthesisOnTiedBends),r=ro.noteColor(s.resources,pt.Effects,e);this.U_(new Rl(i,n,r))}addParenthesisOnSteps(t,e){const s=new Rl(t,e,void 0);this.U_(s)}U_(t){this.dk.push(t),t.isGhost&&(this.isEmpty=!1)}H_(t){return!!t.isTieDestination&&(!!t.tieOrigin.hasBend||this.H_(t.tieOrigin))}doLayout(){const t=this.renderer;this.dk.sort((t,e)=>t.steps-e.steps);let e=null;const s=t.getScoreHeight(1);for(let i=0,n=this.dk.length;i<n;i++){let n;if(this.dk[i].isGhost)if(e){const n=t.getScoreY(this.dk[i].steps)+s;e.height=n-e.y}else n=new Sl(this.v_),n.colorOverride=this.dk[i].color,n.renderer=this.renderer,n.y=t.getScoreY(this.dk[i].steps)-s,n.height=2*s,n.doLayout(),this.V_.push(n),e=n;else e=null}this.width=this.V_.length>0?this.V_[0].width:0}paint(t,e,s){super.paint(t,e,s);for(const i of this.V_)i.paint(t+this.x,e+this.y,s)}}class Ol extends Al{b_;z_;constructor(t,e,s,i,n){super(t,e,n,s.getSymbol(i)),this.b_=n,this.z_=s}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride);const n=this.b_?1:0;Ot.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+n,this.glyphScale,this.symbol,!1),this.z_.techniqueSymbol!==ut.None&&this.z_.techniqueSymbolPlacement===dt.Inside&&Ot.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+n,this.glyphScale,this.z_.techniqueSymbol,!1),s.color=i}doLayout(){super.doLayout(),0===this.width&&(this.height=this.renderer.smuflMetrics.glyphWidths.get(ut.NoteheadBlack)),0===this.height&&(this.height=this.renderer.smuflMetrics.glyphHeights.get(ut.NoteheadBlack))}}class Gl extends Yh{constructor(t,e){super(t,e,.5,ut.PictEdgeOfCymbal),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}!function(t){t[t.NoIntersection=0]="NoIntersection",t[t.EndsTouchingOuter=1]="EndsTouchingOuter",t[t.EndsTouchingInner=2]="EndsTouchingInner",t[t.ExactMatch=3]="ExactMatch",t[t.FullIntersection=4]="FullIntersection"}(Th||(Th={}));class Vl{mainVoiceDirection=Rt.Up;groups=new Map;minX=0;maxX=0;X_=!1;constructor(t){this.mainVoiceDirection=t}update(){let t=0,e=0;for(const s of this.groups.values()){const i=s.minX+s.multiVoiceShiftX,n=s.maxX+s.multiVoiceShiftX;i<t&&(t=i),e<n&&(e=n)}this.minX=t,this.maxX=e}finish(t){if(!this.X_){this.X_=!0;for(const e of this.groups.values())this.j_(e,t);this.update()}}j_(t,e){if(this.mainVoiceDirection===t.direction)return;const s=this.groups.get(this.mainVoiceDirection),i=Vl.J_(s,t),n=e.multiVoiceDisplacedNoteHeadSpacing;switch(i){case Th.NoIntersection:return;case Th.ExactMatch:Vl.q_(s,t)||(s.direction===Rt.Up?t.displacedNotes?t.multiVoiceShiftX=t.stemX+t.correctNotes.width+n:t.multiVoiceShiftX=t.correctNotes.width+n:s.multiVoiceShiftX=t.stemX+n);break;case Th.EndsTouchingOuter:if(s.direction===Rt.Up)if(s.displacedNotes)t.multiVoiceShiftX=s.stemX;else{const e=s.stemX-t.stemX;t.multiVoiceShiftX=e}else if(s.displacedNotes)t.multiVoiceShiftX=-t.stemX;else{const e=t.stemX-s.stemX;s.multiVoiceShiftX=e}break;case Th.EndsTouchingInner:s.direction===Rt.Up?(s.multiVoiceShiftX=s.stemX,t.hasFlag&&(s.multiVoiceShiftX+=n)):(t.multiVoiceShiftX=t.stemX,s.hasFlag&&(t.multiVoiceShiftX+=n));break;case Th.FullIntersection:(s.hasStem||t.hasStem)&&(s.direction===Rt.Up?(s.multiVoiceShiftX=s.stemX,t.hasFlag?s.multiVoiceShiftX+=n:s.multiVoiceShiftX-=n):(t.multiVoiceShiftX=t.stemX,s.hasFlag?t.multiVoiceShiftX+=n:t.multiVoiceShiftX-=n))}}static q_(t,e){const s=t.direction===Rt.Up?t.maxStep:t.minStep,i=e.direction===Rt.Up?e.maxStep:e.minStep,n=t.correctNotes.notes.get(s);if(n.length>1)return!1;const r=e.correctNotes.notes.get(i);return!(r.length>1)&&Vl.Y_(n[0].glyph,r[0].glyph)}static Y_(t,e){return t.glyphScale===e.glyphScale&&t.centerOnStem===e.centerOnStem&&jt.isBlackNoteHead(t.symbol)&&jt.isBlackNoteHead(e.symbol)}static J_(t,e){let s=0;if(t.direction===Rt.Up){const i=t.maxStep;s=e.minStep-i}else{s=t.minStep-e.maxStep}return 0===s?Th.ExactMatch:1===s?Th.EndsTouchingOuter:-1===s?Th.EndsTouchingInner:s<0?Th.FullIntersection:Th.NoIntersection}}class $l extends Ra{dk=[];K_;noteGroup;minStepsNote=null;maxStepsNote=null;get stemX(){return this.noteGroup?this.noteGroup.stemX+this.noteGroup.multiVoiceShiftX:0}noteStartX=0;onTimeX=0;constructor(){super(0,0)}getBoundingBoxTop(){return this.minStepsNote?this.minStepsNote.glyph.getBoundingBoxTop():this.y}getBoundingBoxBottom(){return this.maxStepsNote?this.maxStepsNote.glyph.getBoundingBoxBottom():this.y+this.height}add(t,e){const s={glyph:t,steps:e};this.dk.push(s),(!this.minStepsNote||this.minStepsNote.steps>s.steps)&&(this.minStepsNote=s),(!this.maxStepsNote||this.maxStepsNote.steps<s.steps)&&(this.maxStepsNote=s)}Q_(t){const e=this.direction;let s;t.groups||(t.mainVoiceDirection=e),e===Rt.Up?this.dk.sort((t,e)=>e.steps-t.steps):this.dk.sort((t,e)=>t.steps-e.steps);const i=this.hasFlag,n=this.hasStem;return t.groups.has(e)?(s=t.groups.get(e),i&&(s.hasFlag=i),n&&(s.hasStem=n)):(s={correctNotes:{notes:new Map,width:0,minX:Number.NaN},direction:e,stemX:0,maxX:Number.NaN,minX:Number.NaN,minStep:Number.NaN,maxStep:Number.NaN,multiVoiceShiftX:0,hasFlag:i,hasStem:n},t.groups.set(e,s)),s}doLayout(){const t=this.getScoreChordNoteHeadInfo(),e=this.Q_(t);this.noteGroup=e,this.K_=t,this.Z_(e),this.tT(e),t.update(),this.eT()}eT(){const t=this.noteGroup;this.onTimeX=t.correctNotes.minX+t.correctNotes.width/2,this.width=this.noteStartX+t.multiVoiceShiftX+t.maxX-t.minX}doMultiVoiceLayout(){this.K_.finish(this.renderer.smuflMetrics),this.eT()}tT(t){t.direction===Rt.Up?(this.sT(t,t.correctNotes,!0),t.displacedNotes&&this.sT(t,t.displacedNotes,!1)):(this.sT(t,t.correctNotes,!1),t.displacedNotes&&this.sT(t,t.displacedNotes,!0))}sT(t,e,s){const i=this.scale,n=this.renderer.smuflMetrics;for(const r of e.notes.values())for(const a of r){a.glyph.x=t.stemX,a.glyph.centerOnStem||(s?n.stemUp.has(a.glyph.symbol)?a.glyph.x-=n.stemUp.get(a.glyph.symbol).x*i:a.glyph.x-=n.glyphWidths.get(a.glyph.symbol)*i:n.stemDown.has(a.glyph.symbol)&&(a.glyph.x+=n.stemDown.get(a.glyph.symbol).x*i)),e.width=Math.max(e.width,a.glyph.width),(Number.isNaN(e.minX)||a.glyph.x<e.minX)&&(e.minX=a.glyph.x),(Number.isNaN(t.minX)||a.glyph.x<t.minX)&&(t.minX=a.glyph.x);const r=a.glyph.x+a.glyph.width;(Number.isNaN(t.maxX)||r>t.maxX)&&(t.maxX=r)}}static iT(t,e){return t.notes.has(e.steps)||t.notes.has(e.steps+1)||t.notes.has(e.steps-1)}Z_(t){for(const e of this.dk){e.glyph.renderer=this.renderer,e.glyph.doLayout();let s,i;$l.iT(t.correctNotes,e)?(t.displacedNotes||(t.displacedNotes={notes:new Map,width:0,minX:0}),s=t.displacedNotes):s=t.correctNotes,s.notes.has(e.steps)?i=s.notes.get(e.steps):(i=[],s.notes.set(e.steps,i)),i.push(e),(Number.isNaN(t.minStep)||e.steps<t.minStep)&&(t.minStep=e.steps),(Number.isNaN(t.maxStep)||e.steps>t.maxStep)&&(t.maxStep=e.steps),this.nT(e,t)}}nT(t,e){const s=this.renderer.smuflMetrics,i=this.scale;let n;if(e.direction===Rt.Up||e.displacedNotes)if(s.stemUp.has(t.glyph.symbol)){n=s.stemUp.get(t.glyph.symbol).x*i}else n=s.glyphWidths.get(t.glyph.symbol)*i;else if(s.stemDown.has(t.glyph.symbol)){n=s.stemDown.get(t.glyph.symbol).x*i}else n=0;n+=this.noteStartX,n>e.stemX&&(e.stemX=n)}paint(t,e,s){t+=this.x,e+=this.y,this.rT(t,e,s);t+=this.noteGroup.multiVoiceShiftX;const i=this.dk;for(const n of i)n.glyph.renderer=this.renderer,n.glyph.paint(t,e,s)}rT(t,e,s){if(!this.minStepsNote)return;const i=this.renderer,n=ro.bar(s,E.StandardNotationStaffLine,i.bar,!0);try{const n=this.scale,r=this.renderer.smuflMetrics.legerLineExtension*n,a=this.width+2*r-this.noteStartX,h=i.getLineHeight(1),o=i.getLineY(-1),c=i.getLineY(i.drawnLineCount),l=i.getLineY(this.minStepsNote.steps/2),u=i.getLineY(this.maxStepsNote.steps/2),d=this.renderer.smuflMetrics.legerLineThickness*n/2;let f=o;for(;f>=l;)s.fillRect(t-r+this.noteStartX,e+f-d,a,this.renderer.smuflMetrics.legerLineThickness*n),f-=h;for(f=c;f<=u;)s.fillRect(t-r+this.noteStartX,e+f-d,a,this.renderer.smuflMetrics.legerLineThickness*n),f+=h}finally{n?.[Symbol.dispose]?.()}}}class Hl extends Yh{constructor(t,e,s){super(t,e,1,Hl.ik(s))}static ik(t){if(t.style===St.BuzzRoll)return ut.BuzzRoll;switch(t.marks){case 1:return ut.Tremolo1;case 2:return ut.Tremolo2;case 3:return ut.Tremolo3;case 4:return ut.Tremolo4;case 5:return ut.Tremolo5;default:return ut.None}}stemExtensionHeight=0;alignTremoloPickingGlyph(t,e,s,i){const n=this.renderer,r=n.smuflMetrics;let a=0;const h=r.glyphHeights.get(ut.Tremolo1)/2,o=this.height/2,c=this.symbol===ut.Tremolo1,l=n.lineSpacing,u=c?l:l/2;if(t===Rt.Up){let t=e;t+=r.stemFlagHeight.get(i),t-=r.stemFlagOffsets.get(i),a=u*Math.ceil(t/u);const n=s-l;n<a+o&&(a=n-o),t+=h;const c=a-o;this.stemExtensionHeight=t>c?t-c:0}else{let t=e;t-=r.stemFlagHeight.get(i),t+=r.stemFlagOffsets.get(i),a=u*Math.floor(t/u);const n=s+l;n>a-o&&(a=n+o),t-=h;const c=a+o;this.stemExtensionHeight=t<c?c-t:0}this.y=a}}class Ul extends $l{aT=new Map;CS=[];hT=null;oT=null;cT=0;aboveBeatEffects=new Map;belowBeatEffects=new Map;beat;get direction(){return this.renderer.getBeatDirection(this.beat)}get hasFlag(){return this.renderer.hasFlag(this.beat)}get hasStem(){return this.renderer.hasStem(this.beat)}get scale(){return this.beat.graceType!==u.None?Or.GraceScale:1}getScoreChordNoteHeadInfo(){if(this.beat.graceType!==u.None)return new Vl(this.direction);const t=this.beat.voice.bar.staff,e=`score.noteheads.${t.track.index}.${t.index}.${this.beat.voice.bar.index}.${this.beat.absoluteDisplayStart}`;let s=this.renderer.staff.getSharedLayoutData(e,void 0);return s||(s=new Vl(this.direction),this.renderer.staff.setSharedLayoutData(e,s)),s}getNoteX(t,e){if(this.aT.has(t.id)){const s=this.aT.get(t.id);let i=this.x+s.x;switch(e){case Bh.Left:break;case Bh.Center:i+=s.width/2;break;case Bh.Right:i+=s.width}return i}return 0}getNoteY(t,e){if(this.aT.has(t.id)){const s=this.aT.get(t.id);return this.y_(s,e)}return 0}getLowestNoteY(t){return this.maxStepsNote?this.y_(this.maxStepsNote.glyph,t):0}getHighestNoteY(t){return this.minStepsNote?this.y_(this.minStepsNote.glyph,t):0}y_(t,e){let s=this.y+t.y;const i=this.renderer,n=this.beat.graceType!==u.None?Or.GraceScale:1;switch(e){case Sh.TopWithStem:s-=(i.smuflMetrics.stemUp.has(t.symbol)?i.smuflMetrics.stemUp.get(t.symbol).bottomY:0)*n,s-=i.smuflMetrics.getStemLength(this.beat.duration,i.hasFlag(this.beat))*n,s-=this.cT;let e=i.centerStaffStemY(this.direction);return e-=this.cT,Math.min(e,s);case Sh.Top:s-=t.height/2;break;case Sh.Center:break;case Sh.Bottom:s+=t.height/2;break;case Sh.BottomWithStem:s-=(this.renderer.smuflMetrics.stemDown.has(t.symbol)?this.renderer.smuflMetrics.stemDown.get(t.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(t.symbol)/2)*n,s+=i.smuflMetrics.getStemLength(this.beat.duration,i.hasFlag(this.beat))*n,s+=this.cT;let r=i.centerStaffStemY(this.direction);return r+=this.cT,Math.max(r,s);case Sh.StemUp:s-=(i.smuflMetrics.stemUp.has(t.symbol)?i.smuflMetrics.stemUp.get(t.symbol).bottomY:0)*n;break;case Sh.StemDown:s-=(i.smuflMetrics.stemDown.has(t.symbol)?i.smuflMetrics.stemDown.get(t.symbol).topY:-i.smuflMetrics.glyphHeights.get(t.symbol)/2)*n}return s}addMainNoteGlyph(t,e,s){super.add(t,s),this.aT.set(e.id,t),this.CS.push(e)}addEffectNoteGlyph(t,e){super.add(t,e)}doLayout(){super.doLayout();const t=this.renderer;this.beat.deadSlapped&&(this.hT=new ll,this.hT.renderer=this.renderer,this.hT.doLayout(),this.width=this.hT.width,this.onTimeX=this.width/2);let e=0,s=0;const i=this.renderer.smuflMetrics.onNoteEffectPadding;this.beat.deadSlapped?(s=t.getScoreY(0),e=t.getScoreY(t.heightLineCount)):this.direction===Rt.Up?(s=this.y_(this.maxStepsNote.glyph,Sh.Bottom)+i,e=this.y_(this.minStepsNote.glyph,Sh.TopWithStem)-i):(s=this.y_(this.maxStepsNote.glyph,Sh.BottomWithStem)+i,e=this.y_(this.minStepsNote.glyph,Sh.Top)-i);let n=null,r=null;for(const t of this.aboveBeatEffects.values())t.renderer=this.renderer,t.doLayout(),e-=t.height,t.y=e,(null===n||n>e)&&(n=e),(null===r||r<e)&&(r=e),e-=i;for(const t of this.belowBeatEffects.values())t.renderer=this.renderer,t.doLayout(),t.y=s,(null===n||n>s)&&(n=s),(null===r||r<s)&&(r=s),s+=t.height+i;null!==n&&t.registerBeatEffectOverflows(n,r??0),this.beat.isTremolo&&!this.beat.deadSlapped&&(this.oT=new Hl(0,0,this.beat.tremoloPicking),this.oT.renderer=this.renderer,this.oT.doLayout(),this.lT())}lT(){const t=this.oT,e=this.direction;e===Rt.Up?t.alignTremoloPickingGlyph(e,this.getHighestNoteY(Sh.TopWithStem),this.getHighestNoteY(Sh.Center),this.beat.duration):t.alignTremoloPickingGlyph(e,this.getLowestNoteY(Sh.BottomWithStem),this.getLowestNoteY(Sh.Center),this.beat.duration),this.cT=t.stemExtensionHeight;let s=this.stemX;this.beat.duration<l.Half&&(s=this.width/2),t.x=s}buildBoundingsLookup(t,e,s){for(const i of this.CS)if(this.aT.has(i.id)){const n=this.aT.get(i.id),r=new ba;r.note=i,r.noteHeadBounds=new zs,r.noteHeadBounds.x=e+this.x+n.x,r.noteHeadBounds.y=s+this.y+n.y-n.height/2,r.noteHeadBounds.w=n.width,r.noteHeadBounds.h=n.height,t.addNote(r)}}paint(t,e,s){this.d_(t,e,s),super.paint(t,e,s)}d_(t,e,s){const i=ro.beat(s,_t.StandardNotationEffects,this.beat);try{for(const i of this.aboveBeatEffects.values())i.paint(t+this.x+this.width/2,e+this.y,s);for(const i of this.belowBeatEffects.values())i.paint(t+this.x+this.width/2,e+this.y,s);this.oT&&this.oT.paint(t,e,s),this.hT&&this.hT.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}class zl extends Yh{constructor(t,e,s){super(t,e,1,zl.getSymbol(s))}static getSymbol(t){switch(t){case l.QuadrupleWhole:return ut.RestLonga;case l.DoubleWhole:return ut.RestDoubleWhole;case l.Whole:return ut.RestWhole;case l.Half:return ut.RestHalf;case l.Quarter:return ut.RestQuarter;case l.Eighth:return ut.Rest8th;case l.Sixteenth:return ut.Rest16th;case l.ThirtySecond:return ut.Rest32nd;case l.SixtyFourth:return ut.Rest64th;case l.OneHundredTwentyEighth:return ut.Rest128th;case l.TwoHundredFiftySixth:return ut.Rest256th;default:return ut.None}}paint(t,e,s){this.internalPaint(t,e,s,_t.StandardNotationRests)}internalPaint(t,e,s,i){const n=ro.beat(s,i,this.beat);try{super.paint(t,e,s)}finally{n?.[Symbol.dispose]?.()}}}class Xl extends $l{Ne;uT=!1;dT=new Map;fT=new al;pT=null;bT=null;isEmpty=!0;mT;get scale(){return Or.GraceScale}get hasFlag(){return!1}get hasStem(){return!1}get direction(){return Rt.Up}constructor(t,e,s=!1){super(),this.Ne=e,this.mT=t,this.uT=s,s&&(this.pT=new Il(!0),this.bT=new Il(!1))}getScoreChordNoteHeadInfo(){const t=this.Ne.voice.bar.staff,e=`score.noteheads.${this.mT}.${t.track.index}.${t.index}.${this.Ne.absoluteDisplayStart}`;let s=this.renderer.staff.getSharedLayoutData(e,void 0);return s||(s=new Vl(this.direction),this.renderer.staff.setSharedLayoutData(e,s)),new Vl(this.direction)}containsNoteValue(t){return this.dT.has(t)}getNoteValueY(t){return this.dT.has(t)?this.y+this.dT.get(t).y:0}addGlyph(t,e,s){const i=this.renderer,n=new Dl(0,0,l.Quarter,!0),r=i.accidentalHelper.applyAccidentalForValue(this.Ne,t,e,!0),a=i.accidentalHelper.getNoteStepsForValue(t,!1);if(n.y=i.getScoreY(a),this.uT&&(this.pT.renderer=this.renderer,this.bT.renderer=this.renderer,this.pT.addParenthesisOnSteps(a,!0),this.bT.addParenthesisOnSteps(a,!0)),r!==x.None){const t=new To(0,n.y,r,Or.GraceScale);t.renderer=this.renderer,this.fT.renderer=this.renderer,this.fT.addGlyph(t)}this.dT.set(t,n),this.add(n,a),this.isEmpty=!1}doLayout(){let t=0;this.uT&&(this.pT.x=t,this.pT.renderer=this.renderer,this.pT.doLayout(),t+=this.pT.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this.fT.isEmpty||(t+=this.fT.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this.fT.x=t,this.fT.renderer=this.renderer,this.fT.doLayout(),t+=this.fT.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this.noteStartX=t,super.doLayout(),this.uT&&(this.bT.x=this.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this.bT.renderer=this.renderer,this.bT.doLayout(),this.width+=this.bT.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding)}paint(t,e,s){this.fT.isEmpty||this.fT.paint(t+this.x,e+this.y,s),this.uT&&(this.pT.paint(t+this.x,e+this.y,s),this.bT.paint(t+this.x,e+this.y,s)),super.paint(t,e,s)}}class jl extends no{drawBendSlur(t,e,s,i,n,r,a){Vo.drawBendSlur(t,e,s,i,n,r,this.renderer.smuflMetrics.tieHeight,a)}doLayout(){if(this.glyphs){this.width=0;for(const t of this.glyphs)t.doLayout(),this.width+=t.width}}getTieDirection(t,e){return e.getBeatDirection(t)===Rt.Up?Rt.Down:Rt.Up}}class Jl extends jl{Nk;Ne;gT=null;checkForOverflow=!1;constructor(t){super(0,0),this.Nk=t,this.Ne=t.beat}get hasBoundingBox(){const t=this.gT;return!!t&&(!!t.minStepsNote&&!!t.maxStepsNote)}getBoundingBoxTop(){return this.gT?.minStepsNote?this.gT.minStepsNote.glyph.getBoundingBoxTop():super.getBoundingBoxTop()}getBoundingBoxBottom(){return this.gT?.maxStepsNote?this.gT.maxStepsNote.glyph.getBoundingBoxBottom():super.getBoundingBoxBottom()}doMultiVoiceLayout(){this.gT?.doMultiVoiceLayout()}doLayout(){const e=this.renderer,s=e.settings.notation.notationMode;switch(this.Ne.whammyBarType){case bt.None:case bt.Custom:case bt.Hold:return;case bt.Dive:case bt.PrediveDive:{const t=new Xl("postwhammy",this.Ne,!1);this.gT=t,t.renderer=e;const s=this.Ne.whammyBarPoints[this.Ne.whammyBarPoints.length-1];for(const e of this.Ne.notes)e.isTieOrigin||t.addGlyph(this.wT(e,s),s.value%2!=0,void 0);t.doLayout(),this.addGlyph(t)}break;case bt.Dip:if(s===t.NotationMode.SongBook)return;{const s=new Xl("middlewhammy",this.Ne,!1);if(s.renderer=e,e.settings.notation.notationMode===t.NotationMode.GuitarPro){const t=this.Ne.whammyBarPoints[1];for(const e of this.Ne.notes)s.addGlyph(this.wT(e,this.Ne.whammyBarPoints[1]),t.value%2!=0,void 0)}s.doLayout(),this.addGlyph(s);const i=new Xl("postwhammy",this.Ne,!1);if(i.renderer=e,this.gT=i,e.settings.notation.notationMode===t.NotationMode.GuitarPro){const t=this.Ne.whammyBarPoints[this.Ne.whammyBarPoints.length-1];for(const e of this.Ne.notes)i.addGlyph(this.wT(e,t),t.value%2!=0,void 0)}i.doLayout(),this.addGlyph(i)}case bt.Predive:}super.doLayout(),this.width=this.width/2}paint(e,s,i){const n=this.Ne;switch(n.whammyBarType){case bt.None:case bt.Custom:return}const r=this.renderer.settings.notation.notationMode,h=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,n.voice.bar),o=ro.beat(i,_t.StandardNotationEffects,n);try{const o=e+h.x+h.getBeatX(n,ms.MiddleNotes),c=this.getTieDirection(n,h);let l=1===this.Ne.notes.length?c:Rt.Up;const u=i.textAlign,d=this.renderer.smuflMetrics.glyphHeights.get(ut.NoteheadBlack);for(let u=0;u<n.notes.length;u++){const f=n.notes[u],p=ro.note(i,pt.StandardNotationEffects,f);try{let p=s+h.y;u>0&&u>=(this.Ne.notes.length/2|0)&&(l=Rt.Down),l===Rt.Down?p+=h.getNoteY(f,Sh.Bottom):p+=h.getNoteY(f,Sh.Top);let b=e+h.x+h.getBeatX(n,ms.EndBeat);if(b-=this.renderer.smuflMetrics.postNoteEffectPadding,this.gT){b-=this.gT.width-this.gT.onTimeX}const m=n.whammyStyle===a.Gradual&&0===u?"grad.":"";let g=null;f.isTieOrigin&&(g=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,f.tieDestination.beat.voice.bar),g&&g.staff===h.staff?b=e+g.x+g.getBeatX(f.tieDestination.beat,ms.MiddleNotes):g=null);let w=d*Or.GraceScale*.5;l===Rt.Up&&(w=-w);const y=n.whammyBarPoints.length>0?this.wT(f,n.whammyBarPoints[n.whammyBarPoints.length-1]):0;let k=0,S=!1;switch(this.glyphs&&this.glyphs[0].containsNoteValue(y)?(k=this.glyphs[0].getNoteValueY(y)+w,S=!0):g&&(f.isTieOrigin&&f.tieDestination.beat.hasWhammyBar||f.beat.isContinuedWhammy)?(k=s+g.y+g.getNoteY(f.tieDestination,Sh.Top),S=!0,l===Rt.Down&&(k+=d)):f.isTieOrigin&&(k=g?s+g.y+g.getNoteY(f.tieDestination,Sh.Top):p,l===Rt.Down&&(k+=d)),n.whammyBarType){case bt.Hold:f.isTieOrigin&&Vo.paintTie(i,1,o,p,b,k,c===Rt.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case bt.Dive:if(0===u){const t=this.glyphs[0];t.x=b-t.onTimeX;const e=this.glyphs[0].y;t.y=s+h.y,t.paint(0,0,i),t.containsNoteValue(y)&&(k-=e,k+=t.y)}S?this.drawBendSlur(i,o,p,b,k,l===Rt.Down,m):f.isTieOrigin&&Vo.paintTie(i,1,o,p,b,k,c===Rt.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case bt.Dip:if(r===t.NotationMode.SongBook)f.isTieOrigin&&Vo.paintTie(i,1,o,p,b,k,c===Rt.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);else{const t=(o+b)/2,e=this.glyphs[0];e.x=t-e.onTimeX,e.y=s+h.y,e.paint(0,0,i);const r=this.wT(f,n.whammyBarPoints[1]),a=e.getNoteValueY(r)+w;this.drawBendSlur(i,o,p,t,a,l===Rt.Down,m);const c=this.glyphs[1];c.x=b-c.onTimeX,c.y=s+h.y,c.paint(0,0,i),k=c.getNoteValueY(y)+w,this.drawBendSlur(i,t,a,b,k,l===Rt.Down,m)}break;case bt.PrediveDive:case bt.Predive:let a=e+h.x+h.getBeatX(f.beat,ms.PreNotes);a+=this.Nk.prebendNoteHeadOffset;const d=s+h.y+h.getScoreY(h.accidentalHelper.getNoteStepsForValue(f.displayValue-(f.beat.whammyBarPoints[0].value/2|0),!1))+w;if(this.drawBendSlur(i,a,d,o,p,l===Rt.Down,m),this.glyphs){const t=this.glyphs[0];t.x=b-t.onTimeX,t.y=s+h.y,t.paint(0,0,i),this.drawBendSlur(i,o,p,b,k,l===Rt.Down,m)}}}finally{p?.[Symbol.dispose]?.()}}i.textAlign=u}finally{o?.[Symbol.dispose]?.()}}wT(t,e){return t.displayValueWithoutBend+(e.value/2|0)}}class ql extends Al{beatEffects=new Map;noteHeadElement=pt.SlashNoteHead;effectElement=_t.SlashEffects;stemX=0;constructor(t,e,s){super(t,e,s.graceType!==u.None,ql.getSymbol(s.duration)),this.beat=s}paint(t,e,s){const i=0===this.beat.notes.length?void 0:ro.note(s,this.noteHeadElement,this.beat.notes[0]);try{super.paint(t,e,s),this.d_(t,e,s)}finally{i?.[Symbol.dispose]?.()}}d_(t,e,s){const i=ro.beat(s,this.effectElement,this.beat);try{for(const i of this.beatEffects.values())i.paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){super.doLayout();const t=this.renderer,e=t.smuflMetrics.onNoteEffectPadding;let s=t.smuflMetrics.glyphHeights.get(this.symbol),i=Number.NaN,n=Number.NaN;for(const r of this.beatEffects.values())r.y+=s,r.x+=this.width/2,r.renderer=t,s+=r.height+e,r.doLayout(),(Number.isNaN(i)||i>s)&&(i=s),(Number.isNaN(n)||n<s)&&(n=s);Number.isNaN(i)||t.registerBeatEffectOverflows(i,n);const r=t.getBeatDirection(this.beat),a=this.symbol;if(r===Rt.Up){const e=t.smuflMetrics.stemUp.has(a)?t.smuflMetrics.stemUp.get(a).x:0;this.stemX=e}else{const e=t.smuflMetrics.stemDown.has(a)?t.smuflMetrics.stemDown.get(a).x:0;this.stemX=e}}static getSymbol(t){switch(t){case l.QuadrupleWhole:case l.DoubleWhole:case l.Whole:return ut.NoteheadSlashWhiteWhole;case l.Half:return ut.NoteheadSlashWhiteHalf;default:return ut.NoteheadSlashHorizontalEnds}}}class Yl extends Eh{yT=new Set;addString(t){this.yT.add(t)}doLayout(){const t=this.renderer.smuflMetrics.glyphWidths.get(ut.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;this.height=(t+this.renderer.smuflMetrics.stringNumberCirclePadding)*this.yT.size,this.width=t}paint(t,e,s){const i=this.renderer.bar.staff.tuning.length;let n=0;const r=this.renderer.smuflMetrics.glyphWidths.get(ut.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;for(const a of this.yT){const h=i-a,o=ut.GuitarString1+h;Ot.fillMusicFontSymbolSafe(s,t+this.x,e+this.y+r+n,this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,o,!0),n+=r+this.renderer.smuflMetrics.stringNumberCirclePadding}}}class Kl extends cl{kT=Number.NaN;ST=!1;BT;noteHeads=null;restGlyph=null;get effectElement(){return _t.StandardNotationEffects}buildBoundingsLookup(t,e,s){this.noteHeads&&this.noteHeads.buildBoundingsLookup(t,e+this.x,s+this.y)}getBoundingBoxTop(){let t=this.y;return this.noteHeads?t=this.noteHeads.getBoundingBoxTop():this.restGlyph&&(t=this.restGlyph.getBoundingBoxTop()),this.BT?.hasBoundingBox&&(t=Math.min(t,this.BT.getBoundingBoxTop())),t}getBoundingBoxBottom(){let t=this.y+this.height;return this.noteHeads?t=this.noteHeads.getBoundingBoxBottom():this.restGlyph&&(t=this.restGlyph.getBoundingBoxBottom()),this.BT?.hasBoundingBox&&(t=Math.max(t,this.BT.getBoundingBoxBottom())),t}getLowestNoteY(t){return this.noteHeads?this.noteHeads.getLowestNoteY(t):0}getHighestNoteY(t){return this.noteHeads?this.noteHeads.getHighestNoteY(t):0}getNoteY(t,e){return t.beat.slashed&&(t=t.beat.notes[0]),this.noteHeads?this.noteHeads.getNoteY(t,e):0}getNoteX(t,e){return t.beat.slashed&&(t=t.beat.notes[0]),this.noteHeads?this.noteHeads.getNoteX(t,e):0}getRestY(t){const e=this.restGlyph;if(e)switch(t){case Sh.TopWithStem:return e.getBoundingBoxTop()-this.renderer.smuflMetrics.getStemLength(l.Quarter,!0);case Sh.Top:return e.getBoundingBoxTop();case Sh.Center:case Sh.StemUp:case Sh.StemDown:return e.getBoundingBoxTop()+e.height/2;case Sh.Bottom:return e.getBoundingBoxBottom();case Sh.BottomWithStem:return e.getBoundingBoxBottom()+this.renderer.smuflMetrics.getStemLength(l.Quarter,!0)}return 0}applyRestCollisionOffset(){if(this.restGlyph&&Number.isNaN(this.kT)){this.kT=this.renderer.collisionHelper.applyRestCollisionOffset(this.container.beat,this.restGlyph.y,this.renderer.getScoreHeight(1)),this.y+=this.kT;const t=this.renderer.collisionHelper.restDurationsByDisplayTime;t.has(this.container.beat.playbackStart)&&t.get(this.container.beat.playbackStart).has(this.container.beat.playbackDuration)&&t.get(this.container.beat.playbackStart).get(this.container.beat.playbackDuration)!==this.container.beat.id&&(this.ST=!0)}}paint(t,e,s){this.ST||super.paint(t,e,s)}doMultiVoiceLayout(){this.applyRestCollisionOffset(),this.noteHeads?.doMultiVoiceLayout(),this.BT?.doMultiVoiceLayout();let t=0;if(this.glyphs)for(const e of this.glyphs)e.x=t,t+=e.width;this.width=t,this.computedWidth=t,this._T()}doLayout(){this.oB(),super.doLayout(),this._T()}_T(){this.container.beat.isEmpty?(this.onTimeX=this.width/2,this.middleX=this.onTimeX,this.stemX=this.middleX):this.restGlyph?(this.onTimeX=this.restGlyph.x+this.restGlyph.width/2,this.middleX=this.onTimeX,this.stemX=this.middleX):this.noteHeads&&(this.onTimeX=this.noteHeads.x+this.noteHeads.onTimeX,this.middleX=this.noteHeads.x+this.noteHeads.width/2,this.stemX=this.noteHeads.x+this.noteHeads.stemX)}oB(){this.container.beat.isEmpty||(this.container.beat.isRest?this.TT():this.xT())}xT(){const t=this.renderer,e=new Ul;this.noteHeads=e,e.beat=this.container.beat;const s=new Il(!1);if(s.renderer=this.renderer,this.container.beat.slashed){const e=t.heightLineCount-1,s=new ql(0,t.getScoreY(e),this.container.beat);s.colorOverride=ro.noteColor(t.resources,pt.StandardNotationNoteHead,this.container.beat.notes[0]),this.noteHeads.addMainNoteGlyph(s,this.container.beat.notes[0],e)}else for(const t of this.container.beat.notes)t.isVisible&&(this.MT(t),s.addParenthesis(t));if(this.addNormal(e),s.isEmpty||this.addEffect(s),this.container.beat.hasWhammyBar){const t=new Jl(this.container);this.BT=t,t.renderer=this.renderer,t.doLayout(),this.container.addTie(t)}if(this.container.beat.dots>0)for(let e=0;e<this.container.beat.dots;e++){const e=new no(0,0);e.renderer=this.renderer;for(const s of this.container.beat.notes){this.vT(t.getNoteSteps(s),e).colorOverride=ro.noteColor(t.resources,pt.StandardNotationEffects,s)}this.addEffect(e)}if(this.renderer.bar.isMultiVoice){let e=0,s=0;const i=t.getBeatDirection(this.container.beat);let n=0;this.container.beat.hasTuplet&&(n+=t.tupletOffset+t.tupletSize),i===Rt.Up?(e=this.getHighestNoteY(Sh.TopWithStem)-n,s=this.getLowestNoteY(Sh.Bottom)):(e=this.getHighestNoteY(Sh.Top),s=this.getLowestNoteY(Sh.BottomWithStem)+n),this.renderer.collisionHelper.reserveBeatSlot(this.container.beat,e,s)}}TT(){const t=this.renderer;let e=2*Math.ceil((this.renderer.bar.staff.standardNotationLineCount-1)/2);this.container.beat.duration===l.Whole&&1!==this.renderer.bar.staff.standardNotationLineCount&&3!==this.renderer.bar.staff.standardNotationLineCount&&(e-=2);const s=new zl(0,t.getScoreY(e),this.container.beat.duration);if(this.restGlyph=s,s.beat=this.container.beat,this.addNormal(s),this.renderer.bar.isMultiVoice)if(0===this.container.beat.voice.index){const e=Jo.computeLineHeightsForRest(this.container.beat.duration),i=s.y-t.getScoreHeight(e[0]),n=s.y+t.getScoreHeight(e[1]);this.renderer.collisionHelper.reserveBeatSlot(this.container.beat,i,n)}else this.renderer.collisionHelper.registerRest(this.container.beat);if(this.container.beat.dots>0)for(let t=0;t<this.container.beat.dots;t++){const t=new no(0,0);t.renderer=this.renderer,this.vT(e,t),this.addEffect(t)}}vT(t,e){const s=this.renderer,i=new hl(0,s.getScoreY(t));return e.addGlyph(i),i}NT(t){const e=this.container.beat.graceType!==u.None,s=t.style;if(void 0!==s?.noteHead){const i=new Dl(0,0,t.beat.duration,e);return i.symbol=s.noteHead,s.noteHeadCenterOnStem&&(i.centerOnStem=!0),i}if(t.beat.voice.bar.staff.isPercussion){const s=qt.getArticulation(t);if(s)return new Ol(0,0,s,t.beat.duration,e);q.warning("Rendering",`No articulation found for percussion instrument ${t.percussionArticulation}`)}return t.isDead?new Ll(0,0,e):t.beat.graceType===u.BendGrace?new Dl(0,0,l.Quarter,!0):t.harmonicType===p.Natural?new Wl(0,0,t.beat.duration,e):new Dl(0,0,t.beat.duration,e)}MT(t){if(t.beat.graceType===u.BendGrace&&!t.hasBend)return;const e=this.renderer,s=this.NT(t);s.colorOverride=ro.noteColor(e.resources,pt.StandardNotationNoteHead,t);let i=e.getNoteSteps(t);if(s.y=e.getScoreY(i),this.noteHeads.addMainNoteGlyph(s,t,i),!t.beat.slashed&&t.harmonicType!==p.None&&t.harmonicType!==p.Natural){const n=t.displayValue+t.harmonicPitch,r=new Wl(0,0,t.beat.duration,this.container.beat.graceType!==u.None);r.colorOverride=s.colorOverride,i=e.accidentalHelper.getNoteStepsForValue(n,!1),r.y=e.getScoreY(i),this.noteHeads.addEffectNoteGlyph(r,i)}const n=this.noteHeads.belowBeatEffects,r=this.noteHeads.aboveBeatEffects,a=e.getBeatDirection(this.container.beat)===Rt.Up?this.noteHeads.belowBeatEffects:this.noteHeads.aboveBeatEffects;if(t.isStaccato&&!n.has("Staccato")&&a.set("Staccato",new Fl(0,0)),t.accentuated!==d.Normal||n.has("Accent")||a.set("Accent",new El(0,0,t)),t.accentuated!==d.Heavy||n.has("HAccent")||a.set("HAccent",new El(0,0,t)),t.accentuated!==d.Tenuto||n.has("Tenuto")||a.set("Tenuto",new El(0,0,t)),t.showStringNumber&&t.isStringed){let e;r.has("StringNumber")?e=r.get("StringNumber"):(e=new Yl(0,0),r.set("StringNumber",e)),e.addString(t.string)}if(t.isPercussion){const e=qt.getArticulation(t);if(e&&e.techniqueSymbolPlacement!==dt.Inside){let t;switch(e.techniqueSymbolPlacement){case dt.Above:t=this.noteHeads.aboveBeatEffects;break;case dt.Below:t=this.noteHeads.belowBeatEffects;break;case dt.Outside:t=a;break;default:return}switch(e.techniqueSymbol){case ut.PictEdgeOfCymbal:t.set("PictEdgeOfCymbal",new Gl(0,0));break;case ut.ArticStaccatoAbove:t.set("ArticStaccatoAbove",new Fl(0,0));break;case ut.StringsUpBow:t.set("StringsUpBow",new Eo(0,0,lt.Up));break;case ut.StringsDownBow:t.set("StringsDownBow",new Eo(0,0,lt.Down));break;case ut.GuitarGolpe:t.set("GuitarGolpe",new uo(0,0,!0))}}}}}class Ql extends Ra{Ne;PT;constructor(t){super(0,0),this.Ne=t}doLayout(){if(this.Ne.brushType===o.ArpeggioUp||this.Ne.brushType===o.ArpeggioDown){const t=new sc(0,0,y.Slight,!0);t.renderer=this.renderer,t.doLayout(),this.PT=t,this.width=t.height}else this.width=0}paint(t,e,s){if(this.Ne.brushType===o.ArpeggioUp||this.Ne.brushType===o.ArpeggioDown){const i=this.renderer,n=i.lineOffset,r=e+this.y+(i.getNoteY(this.Ne.maxNote,Sh.Bottom)-n),a=e+this.y+i.getNoteY(this.Ne.minNote,Sh.Top)+n,h=t+this.x+this.width/2,c=this.renderer.smuflMetrics.glyphWidths.get(ut.ArrowheadBlackDown),l=this.PT;if(this.Ne.brushType===o.ArpeggioUp){const e=r+c,i=a-c;l.width=Math.abs(i-e),s.beginRotate(t+this.x,i,-90),l.paint(0,0,s),s.endRotate(),s.beginPath(),s.moveTo(h,a),s.lineTo(h+c/2,a-c),s.lineTo(h-c/2,a-c),s.closePath(),s.fill()}else if(this.Ne.brushType===o.ArpeggioDown){const e=r+c,i=a;l.width=Math.abs(i-e),s.beginRotate(t+this.x,e,90),l.paint(0,-l.height,s),s.endRotate(),s.beginPath(),s.moveTo(h,r),s.lineTo(h+c/2,r+c),s.lineTo(h-c/2,r+c),s.closePath(),s.fill()}}}}class Zl extends ol{CT=null;get prebendNoteHeadOffset(){return this.CT?this.CT.x+this.CT.onTimeX:0}get effectElement(){return _t.StandardNotationEffects}accidentals=null;doMultiVoiceLayout(){this.CT?.doMultiVoiceLayout()}doLayout(){this.container.beat.isRest||this.oB(),super.doLayout()}oB(){const t=new al;t.renderer=this.renderer;const e=new oo;e.renderer=this.renderer;const s=new Il(!0);s.renderer=this.renderer;let i=null,n=!1;for(const r of this.container.beat.notes){const a=ro.noteColor(this.renderer.resources,pt.StandardNotationEffects,r);if(r.isVisible){if(r.hasBend)switch(r.bendType){case h.PrebendBend:case h.Prebend:case h.PrebendRelease:i||(i=new Xl("prebend",this.container.beat,!0),i.renderer=this.renderer),i.addGlyph(r.displayValue-(r.bendPoints[0].value/2|0),!1,a)}else if(r.beat.hasWhammyBar)switch(r.beat.whammyBarType){case bt.PrediveDive:case bt.Predive:i||(i=new Xl("prebend",this.container.beat,!0),i.renderer=this.renderer),i.addGlyph(r.displayValue-(r.beat.whammyBarPoints[0].value/2|0),!1,a)}switch(this.ET(r,t),s.addParenthesis(r),e.addFingers(r),r.slideInType){case g.IntoFromBelow:case g.IntoFromAbove:n=!0}}}n&&this.addNormal(new dl(0,0,this.renderer.smuflMetrics.simpleSlideWidth*(this.container.beat.graceType!==u.None?Or.GraceScale:1))),this.CT=i,i&&(this.addEffect(i),this.addNormal(new dl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==u.None?Or.GraceScale:1)))),this.container.beat.brushType!==o.None&&(this.addEffect(new Ql(this.container.beat)),this.addNormal(new dl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==u.None?Or.GraceScale:1)))),e.isEmpty||(this.isEmpty||this.addNormal(new dl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==u.None?Or.GraceScale:1))),this.addEffect(e),this.addNormal(new dl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==u.None?Or.GraceScale:1)))),s.isEmpty||this.addEffect(s),t.isEmpty||(this.accidentals=t,this.isEmpty||this.addNormal(new dl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==u.None?Or.GraceScale:1))),this.addNormal(t),this.addNormal(new dl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==u.None?Or.GraceScale:1))))}ET(t,e){const s=this.renderer;let i=s.accidentalHelper.applyAccidental(t),n=s.getNoteSteps(t);const r=this.container.beat.graceType!==u.None,a=ro.noteColor(s.resources,pt.StandardNotationAccidentals,t),h=r?Or.GraceScale:1;if(i!==x.None){const t=new To(0,s.getScoreY(n),i,h);t.colorOverride=a,t.renderer=this.renderer,e.addGlyph(t)}if(t.harmonicType!==p.None&&t.harmonicType!==p.Natural){const o=t.displayValue+t.harmonicPitch;i=s.accidentalHelper.applyAccidentalForValue(t.beat,o,r,!1),n=s.accidentalHelper.getNoteStepsForValue(o,!1);const c=new To(0,s.getScoreY(n),i,h);c.colorOverride=a,c.renderer=this.renderer,e.addGlyph(c)}}}class tu extends jl{Ne;CS=[];FT=null;AT=null;Nk;checkForOverflow=!1;constructor(t){super(0,0),this.Ne=t.beat,this.Nk=t}doLayout(){super.doLayout(),this.width=0}getBoundingBoxTop(){return super.getBoundingBoxTop()-this.DT(Rt.Up)}getBoundingBoxBottom(){return super.getBoundingBoxBottom()+this.DT(Rt.Down)}doMultiVoiceLayout(){this.AT?.doMultiVoiceLayout(),this.FT?.doMultiVoiceLayout()}DT(e){const s=this.getTieDirection(this.Ne,this.renderer);if(s!==e)return 0;let i=0;for(const e of this.CS){if(e.isTieOrigin)continue;switch(e.bendType){case h.Custom:case h.Prebend:case h.Hold:continue}const n=2*this.renderer.getBeatContainer(this.Ne).width;let r=0,o=0;switch(e.bendType){case h.Bend:case h.PrebendBend:r=this.FT.minStepsNote.glyph.getBoundingBoxTop(),o=n;break;case h.BendRelease:r=this.AT.minStepsNote.glyph.getBoundingBoxTop(),o=n/2;break;case h.Release:case h.PrebendRelease:r=this.FT.maxStepsNote.glyph.getBoundingBoxTop(),o=n}const c=this.renderer.getNoteY(e,Sh.Top);let l=Math.abs(Vo.calculateBendSlurTopY(0,c,o,r,s===Rt.Down,1,this.renderer.smuflMetrics.tieHeight)-r);if(e.bendStyle===a.Gradual){const e=this.renderer.resources,s=this.renderer.scoreRenderer.canvas;s.font=e.elementFonts.get(t.NotationElement.ScoreBendSlur),l+=s.measureText("grad.").height}l>i&&(i=l)}return i}addBends(t){if(this.CS.push(t),t.isTieOrigin)return;const e=ro.noteColor(this.renderer.resources,pt.StandardNotationEffects,t);switch(t.bendType){case h.Bend:case h.PrebendRelease:case h.PrebendBend:{let s=this.FT;s||(s=new Xl("postbend",t.beat,!1),s.renderer=this.renderer,this.FT=s,this.addGlyph(s));const i=t.bendPoints[t.bendPoints.length-1];s.addGlyph(this.wT(t,i),i.value%2!=0,e)}break;case h.Release:if(!t.isTieOrigin){let s=this.FT;s||(s=new Xl("postbend",t.beat,!1),s.renderer=this.renderer,this.FT=s,this.addGlyph(s));const i=t.bendPoints[t.bendPoints.length-1];s.addGlyph(this.wT(t,i),i.value%2!=0,e)}break;case h.BendRelease:{let s=this.AT;s||(s=new Xl("middlebend",t.beat,!1),this.AT=s,s.renderer=this.renderer,this.addGlyph(s));const i=t.bendPoints[1];s.addGlyph(this.wT(t,t.bendPoints[1]),i.value%2!=0,e);let n=this.FT;n||(n=new Xl("postbend",t.beat,!1),n.renderer=this.renderer,this.FT=n,this.addGlyph(n));const r=t.bendPoints[t.bendPoints.length-1];n.addGlyph(this.wT(t,r),r.value%2!=0,e)}}}paint(e,s,i){const n=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.Ne.voice.bar),r=e+n.x+n.getBeatX(this.Ne,ms.MiddleNotes);let a=e+n.x;if(this.Ne.isLastOfVoice?a+=n.getBeatX(this.Ne,ms.EndBeat):a+=n.getBeatX(this.Ne.nextBeat,ms.PreNotes),a-=this.renderer.smuflMetrics.postNoteEffectPadding,this.FT){a-=this.FT.width-this.FT.onTimeX}const h=(r+a)/2;this.AT&&(this.AT.x=h-this.AT.onTimeX,this.AT.y=s+n.y,this.AT.paint(0,0,i)),this.FT&&(this.FT.x=a-this.FT.onTimeX,this.FT.y=s+n.y,this.FT.paint(0,0,i)),this.CS.sort((t,e)=>e.displayValue-t.displayValue),this.renderer.settings.notation.isNotationElementVisible(t.NotationElement.ScoreBendSlur)&&this.LT(e,s,i,n,r,h,a)}LT(e,s,i,n,r,o,c){const l=this.Ne.graceType===u.BendGrace?this.Ne.nextBeat:this.Ne;let d=1===this.CS.length?this.getTieDirection(l,n):Rt.Up;const f=this.renderer.smuflMetrics.glyphHeights.get(ut.NoteheadBlack);i.font=this.renderer.resources.elementFonts.get(t.NotationElement.ScoreBendSlur);for(let t=0;t<this.CS.length;t++){const l=this.CS[t],u=ro.note(i,pt.StandardNotationEffects,l);try{t>0&&t>=(this.CS.length/2|0)&&(d=Rt.Down);let u=s+n.y+n.getNoteY(l,Sh.Top),p=f*Or.GraceScale*.5;d===Rt.Down&&(u+=f);const b=l.bendStyle===a.Gradual?"grad.":"";if(l.isTieOrigin){const t=l.tieDestination,a=t?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,t.beat.voice.bar):null;if(a&&a.staff===n.staff){const n=e+a.x+a.getBeatX(t.beat,ms.MiddleNotes);let o=s+a.y+a.getNoteY(t,Sh.Top);d===Rt.Down&&(o+=f),l.bendType===h.Hold||l.bendType===h.Prebend?Vo.paintTie(i,1,r,u,n,o,d===Rt.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(i,r,u,n,o,d===Rt.Down,b)}else{const t=e+n.x+n.width,a=l.tieDestination.displayValue;n.accidentalHelper.applyAccidentalForValue(l.beat,a,!1,!0);const o=s+n.y+n.getScoreY(n.accidentalHelper.getNoteStepsForValue(a,!1));l.bendType===h.Hold||l.bendType===h.Prebend?Vo.paintTie(i,1,r,u,t,o,d===Rt.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(i,r,u,t,o,d===Rt.Down,b)}switch(l.bendType){case h.Prebend:case h.PrebendBend:case h.PrebendRelease:let t=e+n.x+n.getBeatX(l.beat,ms.PreNotes);t+=this.Nk.prebendNoteHeadOffset;const a=s+n.y+n.getScoreY(n.accidentalHelper.getNoteStepsForValue(l.displayValue-(l.bendPoints[0].value/2|0),!1))+p;this.drawBendSlur(i,t,a,r,u,d===Rt.Down)}}else{d===Rt.Up&&(p=-p);let t=0,a=0;switch(l.bendType){case h.Bend:t=this.wT(l,l.bendPoints[l.bendPoints.length-1]),a=this.FT.getNoteValueY(t)+p,this.drawBendSlur(i,r,u,c,a,d===Rt.Down,b);break;case h.BendRelease:const f=this.wT(l,l.bendPoints[1]),m=this.AT.getNoteValueY(f)+p;this.drawBendSlur(i,r,u,o,m,d===Rt.Down,b),t=this.wT(l,l.bendPoints[l.bendPoints.length-1]),a=this.FT.getNoteValueY(t)+p,this.drawBendSlur(i,o,m,c,a,d===Rt.Down,b);break;case h.Release:this.glyphs&&(t=this.wT(l,l.bendPoints[l.bendPoints.length-1]),a=this.glyphs[0].getNoteValueY(t)+p,this.drawBendSlur(i,r,u,c,a,d===Rt.Down,b));break;case h.Prebend:case h.PrebendBend:case h.PrebendRelease:let g=e+n.x+n.getBeatX(l.beat,ms.PreNotes);g+=this.Nk.prebendNoteHeadOffset;const w=s+n.y+n.getScoreY(n.accidentalHelper.getNoteStepsForValue(l.displayValue-(l.bendPoints[0].value/2|0),!1))+p;this.drawBendSlur(i,g,w,r,u,d===Rt.Down),this.glyphs&&(t=this.wT(l,l.bendPoints[l.bendPoints.length-1]),a=this.glyphs[0].getNoteValueY(t)+p,this.drawBendSlur(i,r,u,c,a,d===Rt.Down,b))}}}finally{u?.[Symbol.dispose]?.()}}}wT(t,e){return t.displayValueWithoutBend+(e.value/2|0)}}class eu extends Vo{startBeat;endBeat;startBeatRenderer=null;endBeatRenderer=null;constructor(t,e,s,i){super(t,i),this.startBeat=e,this.endBeat=s}doLayout(){super.doLayout()}lookupStartBeatRenderer(){return this.startBeatRenderer||(this.startBeatRenderer=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar)),this.startBeatRenderer}lookupEndBeatRenderer(){return this.endBeatRenderer||(this.endBeatRenderer=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endBeat.voice.bar)),this.endBeatRenderer}shouldDrawBendSlur(){return!1}calculateTieDirection(){return this.startBeat.isRest?Rt.Up:this.lookupStartBeatRenderer().getBeatDirection(this.startBeat)===Rt.Up?Rt.Down:Rt.Up}calculateStartX(){const t=this.lookupStartBeatRenderer();return t.x+t.getBeatX(this.startBeat,ms.MiddleNotes)}calculateStartY(){const t=this.lookupStartBeatRenderer();return this.startBeat.isRest?this.tieDirection===Rt.Up?t.y+t.getRestY(this.startBeat,Sh.Top):t.y+t.getRestY(this.startBeat,Sh.Bottom):this.tieDirection===Rt.Up?t.y+t.getNoteY(this.startBeat.maxNote,Sh.Top):t.y+t.getNoteY(this.startBeat.minNote,Sh.Bottom)}calculateEndX(){const t=this.lookupEndBeatRenderer();if(!t)return this.calculateStartX()+this.renderer.smuflMetrics.leftHandTabTieWidth;const e=t.getBeatDirection(this.endBeat);return t.x+t.getBeatX(this.endBeat,this.endBeat.duration>l.Whole&&e===this.tieDirection?ms.Stem:ms.MiddleNotes)}caclculateEndY(){const t=this.lookupEndBeatRenderer();if(!t)return this.calculateStartY();if(this.endBeat.isRest)return this.tieDirection===Rt.Up?t.y+t.getRestY(this.endBeat,Sh.Top):t.y+t.getRestY(this.endBeat,Sh.Bottom);const e=this.lookupStartBeatRenderer().getBeatDirection(this.startBeat),s=t.getBeatDirection(this.endBeat);return e!==s&&this.startBeat.graceType===u.None?s===this.tieDirection?this.tieDirection===Rt.Up?t.y+t.getNoteY(this.endBeat.maxNote,Sh.TopWithStem):t.y+t.getNoteY(this.endBeat.minNote,Sh.BottomWithStem):this.tieDirection===Rt.Up?t.y+t.getNoteY(this.endBeat.maxNote,Sh.BottomWithStem):t.y+t.getNoteY(this.endBeat.minNote,Sh.TopWithStem):this.tieDirection===Rt.Up?t.y+t.getNoteY(this.endBeat.maxNote,Sh.Top):t.y+t.getNoteY(this.endBeat.minNote,Sh.Bottom)}}class su extends Ra{WT;RT;IT;OT;checkForOverflow=!1;constructor(t,e,s,i){super(0,0),this.WT=e,this.RT=t,this.IT=s,this.OT=i}doLayout(){this.width=0}paint(t,e,s){this.GT(t,e,s),this.VT(t,e,s)}GT(t,e,s){const i=this.renderer,n=i.smuflMetrics.simpleSlideWidth;let r=t+i.x+i.getNoteX(this.IT,Bh.Left)-i.smuflMetrics.preNoteEffectPadding;const a=e+i.y+i.getNoteY(this.IT,Sh.Center);let h=r-n,o=e+i.y;switch(this.RT){case g.IntoFromBelow:o+=i.getNoteY(this.IT,Sh.Bottom);break;case g.IntoFromAbove:o+=i.getNoteY(this.IT,Sh.Top);break;default:return}const c=this.$T(i,this.IT.beat);h-=c,r-=c,this.HT(s,!1,h,r,o,a)}$T(t,e){return t.getBeatContainer(e).accidentalsWidth}VT(t,e,s){const i=this.renderer,n=i.smuflMetrics.simpleSlideWidth,r=i.smuflMetrics.postNoteEffectPadding;let a=0,h=0,o=0,c=0,l=!1;switch(this.WT){case w.Shift:case w.Legato:if(a=t+i.x+i.getBeatX(this.IT.beat,ms.PostNotes)+r,h=e+i.y+i.getNoteY(this.IT,Sh.Center),this.IT.slideTarget){const s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.IT.slideTarget.beat.voice.bar);s&&s.staff===i.staff?(o=t+s.x+s.getBeatX(this.IT.slideTarget.beat,ms.PreNotes)-r,c=e+s.y+s.getNoteY(this.IT.slideTarget,Sh.Center)):(o=t+i.x+i.width,c=this.IT.slideTarget.realValue>this.IT.realValue?e+i.y+i.getNoteY(this.IT,Sh.Top):e+i.y+i.getNoteY(this.IT,Sh.Bottom))}else o=t+i.x+this.OT.x,c=h;break;case w.OutUp:a=t+i.x+i.getNoteX(this.IT,Bh.Right)+r,h=e+i.y+i.getNoteY(this.IT,Sh.Center),o=a+n,c=e+i.y+i.getNoteY(this.IT,Sh.Top);break;case w.OutDown:a=t+i.x+i.getNoteX(this.IT,Bh.Right)+r,h=e+i.y+i.getNoteY(this.IT,Sh.Center),o=a+n,c=e+i.y+i.getNoteY(this.IT,Sh.Bottom);break;case w.PickSlideUp:a=t+i.x+i.getNoteX(this.IT,Bh.Right)+2*r,h=e+i.y+i.getNoteY(this.IT,Sh.Center),c=e+i.y+i.getNoteY(this.IT,Sh.Top),o=t+i.x+i.width,this.IT.beat.nextBeat&&this.IT.beat.nextBeat.voice===this.IT.beat.voice&&(o=t+i.x+i.getBeatX(this.IT.beat.nextBeat,ms.PreNotes)),l=!0;break;case w.PickSlideDown:a=t+i.x+i.getNoteX(this.IT,Bh.Right)+2*r,h=e+i.y+i.getNoteY(this.IT,Sh.Center),c=e+i.y+i.getNoteY(this.IT,Sh.Bottom),o=t+i.x+i.width,this.IT.beat.nextBeat&&this.IT.beat.nextBeat.voice===this.IT.beat.voice&&(o=t+i.x+i.getBeatX(this.IT.beat.nextBeat,ms.PreNotes)),l=!0;break;default:return}this.HT(s,l,a,o,h,c)}HT(t,e,s,i,n,r){if(e){const e=new sc(0,0,y.Slight);e.renderer=this.renderer,e.doLayout(),n-=e.height/2;const a=i-s,h=(r-=e.height/2)-n,o=Math.sqrt(Math.pow(h,2)+Math.pow(a,2));e.width=a;const c=Math.asin(h/o)*(180/Math.PI);t.beginRotate(s,n,c),e.paint(0,0,t),t.endRotate()}else t.beginPath(),t.moveTo(s,n),t.lineTo(i,r),t.stroke()}}class iu extends $o{shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}calculateStartX(){return this.isLeftHandTap?this.calculateEndX()-this.renderer.smuflMetrics.leftHandTabTieWidth:this.renderer.x+this.renderer.getBeatX(this.startNote.beat,ms.PostNotes)}calculateEndX(){const t=this.lookupEndBeatRenderer();return t?this.isLeftHandTap?t.x+t.getNoteX(this.endNote,Bh.Left):t.x+t.getBeatX(this.endNote.beat,ms.PreNotes):this.calculateStartX()+this.renderer.smuflMetrics.leftHandTabTieWidth}}class nu extends iu{getTieHeight(t,e,s,i){return Math.log2(s-t+1)*this.renderer.settings.notation.slurHeight/2}calculateStartX(){return this.renderer.x+(this.UT()?this.renderer.getBeatX(this.startNote.beat,ms.MiddleNotes):this.renderer.getNoteX(this.startNote,Bh.Right))}calculateStartY(){return this.UT()?this.tieDirection===Rt.Up?this.renderer.y+this.renderer.getNoteY(this.startNote,Sh.Top):this.renderer.y+this.renderer.getNoteY(this.startNote,Sh.Bottom):this.renderer.y+this.renderer.getNoteY(this.startNote,Sh.Center)}calculateEndX(){const t=this.lookupEndBeatRenderer();return t?this.zT()?this.XT()?t.x+t.getBeatX(this.endNote.beat,ms.Stem):t.x+t.getNoteX(this.endNote,Bh.Center):t.x+t.getBeatX(this.endNote.beat,ms.PreNotes):this.calculateStartX()+this.renderer.smuflMetrics.leftHandTabTieWidth}caclculateEndY(){const t=this.lookupEndBeatRenderer();return t?this.zT()?this.XT()?this.tieDirection===Rt.Up?t.y+t.getNoteY(this.endNote,Sh.TopWithStem):t.y+t.getNoteY(this.endNote,Sh.BottomWithStem):this.tieDirection===Rt.Up?t.y+t.getNoteY(this.endNote,Sh.Top):t.y+t.getNoteY(this.endNote,Sh.Bottom):t.y+t.getNoteY(this.endNote,Sh.Center):this.calculateStartY()}UT(){return this.startNote===this.startNote.beat.maxNote&&this.tieDirection===Rt.Up||this.startNote===this.startNote.beat.minNote&&this.tieDirection===Rt.Down}zT(){return this.startNote.beat.graceType===u.None&&(this.endNote===this.endNote.beat.maxNote&&this.tieDirection===Rt.Up||this.endNote===this.endNote.beat.minNote&&this.tieDirection===Rt.Down)}XT(){const t=this.lookupStartBeatRenderer().getBeatDirection(this.startNote.beat),e=this.lookupEndBeatRenderer();return t!==(e?e.getBeatDirection(this.endNote.beat):t)&&this.startNote.beat.graceType===u.None}}class ru extends Oa{jT=null;JT=null;qT=null;constructor(t){super(t),this.preNotes=new Zl,this.onNotes=new Kl}get prebendNoteHeadOffset(){return this.preNotes.prebendNoteHeadOffset}get accidentalsWidth(){const t=this.preNotes;return t&&t.accidentals?t.accidentals.width:0}doMultiVoiceLayout(){this.preNotes.x=0,this.preNotes.doMultiVoiceLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.doMultiVoiceLayout(),this.jT?.doMultiVoiceLayout()}doLayout(){this.JT=null,this.qT=null;const t=this.renderer,e=this.beat,s=e.graceType!==u.None;if(t.hasFlag(e)){const i=t.getBeatDirection(e),n=s?Or.GraceScale:1,r=Tl.getSymbol(e.duration,i,s),a=t.smuflMetrics.glyphWidths.get(r)*n;this.YT=a}else if(s){const e=t.smuflMetrics.glyphWidths.get(ut.Flag8thUp)*Or.GraceScale;this.YT=e}super.doLayout(),this.jT&&(this.jT.renderer=this.renderer,this.jT.doLayout(),this.updateWidth())}getBoundingBoxTop(){return null!==this.jT?Xt.minBoundingBox(this.jT.getBoundingBoxTop(),super.getBoundingBoxTop()):super.getBoundingBoxTop()}getBoundingBoxBottom(){return null!==this.jT?Xt.maxBoundingBox(this.jT.getBoundingBoxBottom(),super.getBoundingBoxTop()):super.getBoundingBoxBottom()}createTies(t){if(t.isVisible){if(t.isTieOrigin&&!t.hasBend&&!t.beat.hasWhammyBar&&t.beat.graceType!==u.BendGrace&&t.tieDestination&&t.tieDestination.isVisible){const e=new iu(`score.tie.${t.id}`,t,t.tieDestination,!1);this.addTie(e)}if(t.isTieDestination&&!t.tieOrigin.hasBend&&!t.beat.hasWhammyBar){const e=new iu(`score.tie.${t.tieOrigin.id}`,t.tieOrigin,t,!0);this.addTie(e)}if(t.slideInType!==g.None||t.slideOutType!==w.None){const e=new su(t.slideInType,t.slideOutType,t,this);this.addTie(e)}if(t.isSlurOrigin&&t.slurDestination&&t.slurDestination.isVisible){const e=new nu(`score.slur.${t.id}`,t,t.slurDestination,!1);this.addTie(e)}if(t.isSlurDestination){const e=new nu(`score.slur.${t.slurOrigin.id}`,t.slurOrigin,t,!0);this.addTie(e)}if(!this.JT&&t.isEffectSlurOrigin&&t.effectSlurDestination){const e=new nu(`score.slur.effect.${t.beat.id}`,t,t.effectSlurDestination,!1);this.JT=e,this.addTie(e)}if(!this.qT&&t.beat.isEffectSlurDestination&&t.beat.effectSlurOrigin){const e=this.renderer.getBeatDirection(t.beat),s=e===Rt.Up?t.beat.effectSlurOrigin.minNote:t.beat.effectSlurOrigin.maxNote,i=e===Rt.Up?t.beat.minNote:t.beat.maxNote,n=new nu(`score.slur.effect.${s.beat.id}`,s,i,!0);this.qT=n,this.addTie(n)}if(t.hasBend){if(!this.jT){const t=new tu(this);this.jT=t,t.renderer=this.renderer,this.addTie(t)}this.jT.addBends(t)}if(this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let t=this.beat.nextBeat;for(;t.nextBeat&&t.nextBeat.isLegatoDestination;)t=t.nextBeat;this.addTie(new eu(`score.legato.${this.beat.id}`,this.beat,t,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let t=this.beat.previousBeat;for(;t.previousBeat&&t.previousBeat.isLegatoOrigin;)t=t.previousBeat;this.addTie(new eu(`score.legato.${t.id}`,t,this.beat,!0))}}}YT=0;get postBeatStretch(){return super.postBeatStretch+this.YT}updateWidth(){super.updateWidth(),this.width+=this.YT}}class au extends Ml{static StaffId="score";static KT=[-1,2,-2,1,4,0,3];static QT=[3,0,4,1,5,2,6];accidentalHelper;constructor(t,e){super(t,e),this.accidentalHelper=new li(this)}get repeatsBarSubElement(){return E.StandardNotationRepeats}get barNumberBarSubElement(){return E.StandardNotationBarNumber}get barLineBarSubElement(){return E.StandardNotationBarLines}get staffLineBarSubElement(){return E.StandardNotationStaffLine}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return Math.max(5,this.bar.staff.standardNotationLineCount)}get drawnLineCount(){return this.bar.staff.standardNotationLineCount}getScoreY(t){return super.getLineY(t/2)}getScoreHeight(t){return super.getLineHeight(t/2)}calculateOverflows(t,e){super.calculateOverflows(t,e),this.bar.isEmpty||this.calculateBeamingOverflows(t,e)}get flagsSubElement(){return _t.StandardNotationFlags}get beamsSubElement(){return _t.StandardNotationBeams}get tupletSubElement(){return _t.StandardNotationTuplet}getFlagTopY(t,e){const s=e===Rt.Up?Sh.TopWithStem:Sh.StemDown;return t.isRest?this.getRestY(t,s):this.voiceContainer.getHighestNoteY(t,s)}getFlagBottomY(t,e){const s=e===Rt.Up?Sh.StemUp:Sh.BottomWithStem;return t.isRest?this.getRestY(t,s):this.voiceContainer.getLowestNoteY(t,s)}getBeamDirection(t){return this.ZT.has(t)?this.ZT.get(t):Rt.Up}centerStaffStemY(t){return this.bar.staff.standardNotationLineCount===Me.DefaultStandardNotationLineCount?this.getScoreY(this.bar.staff.standardNotationLineCount-1):t===Rt.Up?this.getScoreY(2*this.bar.staff.standardNotationLineCount):this.getScoreY(0)}get middleYPosition(){return this.getScoreY(this.bar.staff.standardNotationLineCount-1)}applyLayoutingInfo(){const t=super.applyLayoutingInfo();if(t&&this.bar.isMultiVoice){const t=this.getScoreY(-2),e=this.getScoreY(2*this.heightLineCount),s=this.helpers.collisionHelper.getBeatMinMaxY();s[0]<t&&this.registerOverflowTop(Math.abs(s[0])),s[1]>e&&this.registerOverflowBottom(Math.abs(s[1])-e)}return t}getMinLineOfBeat(t){return this.accidentalHelper.getMinSteps(t)/2}getMaxLineOfBeat(t){return this.accidentalHelper.getMaxSteps(t)/2}createLinePreBeatGlyphs(){let t=!1;if(this.isFirstOfStaff||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let e=0;switch(this.bar.clef){case M.Neutral:e=this.bar.staff.standardNotationLineCount-1;break;case M.F4:e=2;break;case M.C3:e=4;break;case M.C4:e=2;break;case M.G2:e=6}this.createStartSpacing(),this.addPreBeatGlyph(new Pl(0,this.getScoreY(e),this.bar.clef,this.bar.clefOttava)),this.addPreBeatGlyph(new dl(0,0,this.smuflMetrics.preBeatGlyphSpacing)),t=!0}(t||0===this.index&&this.bar.keySignature!==N.C||this.bar.previousBar&&this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this.tx()),(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.R_())}tx(){let t=0;const e=this.bar.keySignature,s=this.bar.previousBar?this.bar.previousBar.keySignature:0;switch(this.bar.clef){case M.Neutral:t=0;break;case M.G2:t=1;break;case M.F4:t=3;break;case M.C3:t=2;break;case M.C4:t=0}const i=new Cl;i.gap=this.smuflMetrics.accidentalPadding,i.renderer=this;const n=new Map,r=[];if(Xt.keySignatureIsSharp(e))for(let s=0;s<Math.abs(e);s++){const e=au.KT[s]+t;r.push(new To(0,this.getScoreY(e),x.Sharp,1)),n.set(e,!0)}else for(let s=0;s<Math.abs(e);s++){const e=au.QT[s]+t;r.push(new To(0,this.getScoreY(e),x.Flat,1)),n.set(e,!0)}if(this.bar.keySignature===N.C){const e=Math.abs(s),r=Xt.keySignatureIsSharp(s)?au.KT:au.QT;for(let s=0;s<e;s++){const e=r[s]+t;n.has(e)||i.addGlyph(new To(0,this.getScoreY(r[s]+t),x.Natural,1))}}for(const t of r)i.addGlyph(t);this.addPreBeatGlyph(i),i.isEmpty||this.addPreBeatGlyph(new dl(0,0,this.smuflMetrics.preBeatGlyphSpacing))}R_(){const t=this.bar.staff.standardNotationLineCount-1;this.addPreBeatGlyph(new _l(0,this.getScoreY(t),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime)),this.addPreBeatGlyph(new dl(0,0,this.smuflMetrics.preBeatGlyphSpacing))}createVoiceGlyphs(t){super.createVoiceGlyphs(t);for(const e of t.beats)this.addBeatGlyph(new ru(e))}getNoteLine(t){return this.accidentalHelper.getNoteSteps(t)/2}getNoteSteps(t){return this.accidentalHelper.getNoteSteps(t)}ZT=new Map;completeBeamingHelper(t){const e=this.sx(t);this.ZT.set(t,e)}sx(t){if(!t.voice)return Rt.Up;if(null!==t.preferredBeamDirection)return t.preferredBeamDirection;if(t.voice.index>0)return this.ix(t,Rt.Down);if(t.voice.bar.isMultiVoice)return this.ix(t,Rt.Up);if(t.beats[0].graceType!==u.None)return this.ix(t,Rt.Up);if(1===t.beats.length&&t.beats[0].slashed)return this.ix(t,Rt.Down);if(t.highestNoteInHelper&&t.lowestNoteInHelper){const e=(this.nx(t.highestNoteInHelper)+this.nx(t.lowestNoteInHelper))/2;return this.ix(t,this.middleYPosition<e?Rt.Up:Rt.Down)}return this.ix(t,Rt.Up)}nx(t){const e=li.computeStepsWithoutAccidentals(this.bar,t);return this.getScoreY(e)}ix(t,e){return t.invertBeamDirection?e===Rt.Down?Rt.Up:Rt.Down:e}paintBeamingStem(t,e,s,i,n,r){const a=ro.beat(r,_t.StandardNotationStem,t);try{r.fillRect(s,i,this.smuflMetrics.stemThickness,n-i)}finally{a?.[Symbol.dispose]?.()}}}class hu extends Ch{get staffId(){return au.StaffId}create(t,e){return new au(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showStandardNotation}}class ou extends zl{paint(t,e,s){super.internalPaint(t,e,s,_t.SlashRests)}}class cu extends cl{oT;cT=0;noteHeads=null;deadSlapped=null;restGlyph=null;get effectElement(){return _t.SlashEffects}getNoteX(t,e){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let t=s.x;switch(e){case Bh.Left:break;case Bh.Center:t+=s.width/2;break;case Bh.Right:t+=s.width}return t}return 0}buildBoundingsLookup(t,e,s){if(this.noteHeads&&this.container.beat.notes.length>0){const i=new ba;i.note=this.container.beat.notes[0],i.noteHeadBounds=new zs,i.noteHeadBounds.x=e+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}getLowestNoteY(t){return this.y_(t)}getHighestNoteY(t){return this.y_(t)}getRestY(t){const e=this.restGlyph;if(e)switch(t){case Sh.TopWithStem:return e.getBoundingBoxTop()-this.renderer.smuflMetrics.getStemLength(l.Quarter,!0);case Sh.Top:return e.getBoundingBoxTop();case Sh.Center:case Sh.StemUp:case Sh.StemDown:return e.getBoundingBoxTop()+e.height/2;case Sh.Bottom:return e.getBoundingBoxBottom();case Sh.BottomWithStem:return e.getBoundingBoxBottom()+this.renderer.smuflMetrics.getStemLength(l.Quarter,!0)}return 0}getNoteY(t,e){return this.y_(e)}y_(t){let e=null,s=ut.None,i=!1;if(this.noteHeads?(e=this.noteHeads,s=ql.getSymbol(this.container.beat.duration),i=!0):this.deadSlapped&&(e=this.deadSlapped),e){let n=this.y+e.y;const r=this.renderer,a=this.container.beat,h=a.graceType!==u.None?Or.GraceScale:1;switch(t){case Sh.TopWithStem:return i?(n-=(r.smuflMetrics.stemUp.has(s)?r.smuflMetrics.stemUp.get(s).bottomY:0)*h,n-=r.smuflMetrics.getStemLength(a.duration,r.hasFlag(a))*h,n-=this.cT):n-=e.height/2,n;case Sh.Top:n-=e.height/2;break;case Sh.Center:break;case Sh.Bottom:n+=e.height/2;break;case Sh.BottomWithStem:return i?(n-=(r.smuflMetrics.stemDown.has(s)?r.smuflMetrics.stemDown.get(s).topY:-r.smuflMetrics.glyphHeights.get(s)/2)*h,n+=r.smuflMetrics.getStemLength(a.duration,r.hasFlag(a))*h,n+=this.cT):n+=e.height/2,n;case Sh.StemUp:n-=this.renderer.smuflMetrics.stemUp.has(s)?this.renderer.smuflMetrics.stemUp.get(s).bottomY:0;break;case Sh.StemDown:n-=this.renderer.smuflMetrics.stemDown.has(s)?this.renderer.smuflMetrics.stemDown.get(s).topY:0}return n}return 0}doLayout(){const t=this.renderer,e=t.getLineY(0);if(this.container.beat.deadSlapped){const t=new ll;t.renderer=this.renderer,t.doLayout(),this.deadSlapped=t,this.addEffect(t)}else if(!this.container.beat.isEmpty)if(this.container.beat.isRest){const t=new ou(0,e,this.container.beat.duration);this.restGlyph=t,t.beat=this.container.beat,this.addNormal(t)}else{const t=new ql(0,e,this.container.beat);this.noteHeads=t,t.beat=this.container.beat,this.addNormal(t),this.container.beat.isTremolo&&(this.oT=new Hl(0,0,this.container.beat.tremoloPicking),this.oT.renderer=this.renderer,this.oT.doLayout(),this.lT())}if(this.container.beat.dots>0)for(let s=0;s<this.container.beat.dots;s++)this.addEffect(new hl(0,e-t.getLineHeight(.5)));super.doLayout(),this.container.beat.isEmpty?(this.onTimeX=this.width/2,this.stemX=this.onTimeX):this.restGlyph?(this.onTimeX=this.restGlyph.x+this.restGlyph.width/2,this.stemX=this.onTimeX):this.noteHeads?(this.onTimeX=this.noteHeads.x+this.noteHeads.width/2,this.stemX=this.noteHeads.x+this.noteHeads.stemX):this.deadSlapped&&(this.onTimeX=this.deadSlapped.x+this.deadSlapped.width/2,this.stemX=this.onTimeX),this.middleX=this.onTimeX;const s=this.oT;s&&(s.x=this.container.beat.duration<l.Half?this.width/2:this.stemX)}lT(){const t=this.oT;t.alignTremoloPickingGlyph(Rt.Up,this.y_(Sh.TopWithStem),this.y_(Sh.Center),this.container.beat.duration),this.cT=t.stemExtensionHeight;let e=this.stemX;this.container.beat.duration<l.Half&&(e=this.width/2),t.x=e}paint(t,e,s){super.paint(t,e,s);const i=this.oT;i&&i.paint(t+this.x,e+this.y,s)}}class lu extends $o{calculateTieDirection(){return Rt.Down}getStartNotePosition(){return Bh.Right}getEndNotePosition(){return Bh.Left}}class uu extends Oa{hx=null;constructor(t){super(t),this.preNotes=new ol,this.onNotes=new cu}doLayout(){const t=this.renderer,e=this.beat,s=e.graceType!==u.None;if(t.hasFlag(e)){const i=t.getBeatDirection(e),n=s?Or.GraceScale:1,r=Tl.getSymbol(e.duration,i,s),a=t.smuflMetrics.glyphWidths.get(r)*n;this.YT=a}else if(s){const e=t.smuflMetrics.glyphWidths.get(ut.Flag8thUp)*Or.GraceScale;this.YT=e}super.doLayout()}createTies(t){if(t.isVisible){if(!this.hx&&t.isTieOrigin&&t.tieDestination.isVisible){const e=new lu("slash.tie",t,t.tieDestination,!1);this.hx=e,this.addTie(e)}if(!this.hx&&t.isTieDestination){const e=new lu("slash.tie",t.tieOrigin,t,!0);this.hx=e,this.addTie(e)}}}YT=0;get postBeatStretch(){return super.postBeatStretch+this.YT}updateWidth(){super.updateWidth(),this.width+=this.YT}}class du extends Ml{static StaffId="slash";simpleWhammyOverflow=0;ox;constructor(t,e){super(t,e),this.ox=!e.staff.showTablature&&!e.staff.showStandardNotation,this.helpers.preferredBeamDirection=Rt.Up}get repeatsBarSubElement(){return E.SlashRepeats}get barNumberBarSubElement(){return E.SlashBarNumber}get barLineBarSubElement(){return E.SlashBarLines}get staffLineBarSubElement(){return E.SlashStaffLine}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 1}get bottomGlyphOverflow(){return 0}get flagsSubElement(){return _t.SlashFlags}get beamsSubElement(){return _t.SlashBeams}get tupletSubElement(){return _t.SlashTuplet}doLayout(){super.doLayout(),this.voiceContainer.tupletGroups.size>0&&this.registerOverflowTop(this.tupletSize)}getNoteLine(t){return 0}getFlagTopY(t,e){const s=e===Rt.Up?Sh.TopWithStem:Sh.StemDown;return t.notes.length>0?this.getNoteY(t.notes[0],s):this.getRestY(t,s)}getFlagBottomY(t,e){const s=e===Rt.Up?Sh.StemUp:Sh.BottomWithStem;return t.notes.length>0?this.getNoteY(t.notes[0],s):this.getRestY(t,s)}getBeamDirection(t){return Rt.Up}createLinePreBeatGlyphs(){this.ox&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.R_())}R_(){this.addPreBeatGlyph(new dl(0,0,this.smuflMetrics.oneStaffSpace));const t=this.bar.masterBar,e=new _l(0,this.getLineY(0),t.timeSignatureNumerator,t.timeSignatureDenominator,t.timeSignatureCommon,t.isFreeTime&&(null==t.previousMasterBar||t.isFreeTime!==t.previousMasterBar.isFreeTime));e.barSubElement=E.SlashTimeSignature,this.addPreBeatGlyph(e)}createVoiceGlyphs(t){if(!(t.index>0)){super.createVoiceGlyphs(t);for(const e of t.beats)this.addBeatGlyph(new uu(e))}}calculateOverflows(t,e){super.calculateOverflows(t,e),this.bar.isEmpty||this.calculateBeamingOverflows(t,e)}shouldPaintBeamingHelper(t){return super.shouldPaintBeamingHelper(t)&&0===t.voice.index}paintBeamingStem(t,e,s,i,n,r){const a=ro.beat(r,_t.SlashStem,t);try{r.fillRect(s,i,this.smuflMetrics.stemThickness,n-i)}finally{a?.[Symbol.dispose]?.()}}paintBeamHelper(t,e,s,i,n,r){0===i.voice?.index&&super.paintBeamHelper(t,e,s,i,n,r)}}class fu extends Ch{get staffId(){return du.StaffId}create(t,e){return new du(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showSlash}}class pu extends Ra{Le;lx=null;ux=null;bx=0;isEmpty=!1;noteStringWidth=0;constructor(t,e,s){super(t,e),this.Le=s}get Bk(){return.25*this.renderer.lineSpacing}getBoundingBoxTop(){return this.y-this.height/2-this.Bk}getBoundingBoxBottom(){return this.y+this.height/2}doLayout(){const e=this.Le;let s=e.fret-e.beat.voice.bar.staff.transpositionPitch;if(e.harmonicType===p.Natural&&0!==e.harmonicValue&&(s=e.harmonicValue-e.beat.voice.bar.staff.transpositionPitch),e.isTieDestination)0===e.beat.index&&this.renderer.settings.notation.notationMode===t.NotationMode.GuitarPro||(e.bendType===h.Bend||e.bendType===h.BendRelease)&&this.renderer.settings.notation.isNotationElementVisible(t.NotationElement.TabNotesOnTiedBends)?this.lx=`(${(e.tieOrigin.fret-e.beat.voice.bar.staff.transpositionPitch).toString()})`:this.lx="";else if(this.lx=e.isDead?"x":s.toString(),e.isGhost)this.lx=`(${this.lx})`;else if(e.harmonicType===p.Natural){const t=this.lx.indexOf(String.fromCharCode(46));t>=0&&(this.lx=this.lx.substr(0,t+2)),this.lx=`<${this.lx}>`}if(e.isTrill)this.ux=`(${(e.trillFret-e.beat.voice.bar.staff.transpositionPitch).toString()})`;else if(Xt.isAlmostEqualTo(e.harmonicValue,0))this.ux="";else switch(e.harmonicType){case p.Artificial:case p.Pinch:case p.Tap:case p.Semi:case p.Feedback:let t=(s+e.harmonicValue).toString();const i=t.indexOf(String.fromCharCode(46));i>=0&&(t=t.substr(0,i+2)),this.ux=`<${t}>`;break;default:this.ux=""}if(this.isEmpty=!this.lx,!this.isEmpty){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont;const t=!!this.ux;this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this.lx+(t?" ":"")).width,this.width=this.noteStringWidth,this.height=this.renderer.scoreRenderer.canvas.font.size,t&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this.bx=3+this.renderer.scoreRenderer.canvas.measureText(this.ux).width,this.width+=this.bx)}}paint(t,e,s){if(this.isEmpty)return;const i=this.noteStringWidth+this.bx,n=t+this.x+(this.width-i)/2,r=e+this.y;this.paintTrill(n,r,s);const a=ro.note(s,pt.GuitarTabFretNumber,this.Le);try{s.fillText(this.lx,n,r)}finally{a?.[Symbol.dispose]?.()}}paintTrill(t,e,s){const i=ro.note(s,pt.GuitarTabFretNumber,this.Le);try{const i=this.renderer.scoreRenderer.canvas.font;this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,s.fillText(this.ux,t+this.noteStringWidth,e),this.renderer.scoreRenderer.canvas.font=i}finally{i?.[Symbol.dispose]?.()}}buildBoundingsLookup(t,e,s){const i=new ba;i.note=this.Le,i.noteHeadBounds=new zs,i.noteHeadBounds.x=e+this.x,i.noteHeadBounds.y=s+this.y-this.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}class bu extends Ra{CS=[];hT=null;b_;beat;maxStringNote=null;minStringNote=null;beatEffects=new Map;notesPerString=new Map;noteStringWidth=0;constructor(t,e,s){super(t,e),this.b_=s}buildBoundingsLookup(t,e,s){for(const i of this.CS)i.buildBoundingsLookup(t,e+this.x,s+this.y)}getNoteX(t,e){if(this.notesPerString.has(t.string)){const s=this.notesPerString.get(t.string);let i=this.x+s.x;switch(e){case Bh.Left:break;case Bh.Center:i+=s.noteStringWidth/2;break;case Bh.Right:i+=s.width}return i}return 0}getLowestNoteY(t){return this.maxStringNote?this.getNoteY(this.maxStringNote,t):0}getHighestNoteY(t){return this.minStringNote?this.getNoteY(this.minStringNote,t):0}getNoteY(t,e){if(this.notesPerString.has(t.string)){const s=this.notesPerString.get(t.string);let i=this.y+s.y;switch(e){case Sh.Top:i-=s.height/2;break;case Sh.StemUp:i=this.y+s.getBoundingBoxTop();break;case Sh.Center:break;case Sh.Bottom:i+=s.height/2;break;case Sh.StemDown:i=this.y+s.getBoundingBoxBottom();break;case Sh.TopWithStem:i=-this.renderer.settings.notation.rhythmHeight,i-=this.calculateTremoloHeightForStem();break;case Sh.BottomWithStem:i=this.renderer.height+this.renderer.settings.notation.rhythmHeight,i+=this.calculateTremoloHeightForStem()}return i}return 0}calculateTremoloHeightForStem(){const t=this.beat;if(!t.isTremolo)return 0;if(t.duration<=l.Quarter)return 0;const e=Hl.ik(t.tremoloPicking),s=this.renderer.smuflMetrics;return s.glyphHeights.has(e)?s.glyphHeights.get(e):0}doLayout(){let t=0;if(this.beat.deadSlapped)this.hT=new ll,this.hT.renderer=this.renderer,this.hT.doLayout(),t=this.hT.width,this.noteStringWidth=t;else{let e=0;for(let s=0,i=this.CS.length;s<i;s++){const i=this.CS[s];i.renderer=this.renderer,i.doLayout(),i.width>t&&(t=i.width),i.noteStringWidth>e&&(e=i.noteStringWidth)}this.noteStringWidth=e;const s=this.renderer.resources.tablatureFont.size;let i=Number.NaN,n=Number.NaN,r=this.getNoteY(this.minStringNote,Sh.Center)+s/2;const a=this.renderer.smuflMetrics.onNoteEffectPadding;for(const t of this.beatEffects.values())t.y+=r,t.x+=this.width/2,t.renderer=this.renderer,t.doLayout(),r+=t.height+a,(Number.isNaN(i)||i>r)&&(i=r),(Number.isNaN(n)||n<r)&&(n=r);Number.isNaN(i)||this.renderer.registerBeatEffectOverflows(i,n)}this.width=t}addNoteGlyph(t,e){this.CS.push(t),this.notesPerString.set(e.string,t),(!this.minStringNote||e.string<this.minStringNote.string)&&(this.minStringNote=e),(!this.maxStringNote||e.string>this.maxStringNote.string)&&(this.maxStringNote=e)}paint(t,e,s){if(t+=this.x,e+=this.y,this.beat.deadSlapped)this.hT?.paint(t,e,s);else{const i=this.renderer.resources,n=s.textBaseline;s.textBaseline=ot.Middle,s.font=this.b_?i.graceFont:i.tablatureFont;const r=this.CS,a=this.width;for(const i of r)i.renderer=this.renderer,i.width=a,i.paint(t,e,s);s.textBaseline=n;const h=ro.beat(s,_t.GuitarTabEffects,this.beat);try{for(const i of this.beatEffects.values())i.paint(t,e,s)}finally{h?.[Symbol.dispose]?.()}}}}class mu extends Yh{mx;constructor(t,e,s,i){super(t,e,1,zl.getSymbol(i)),this.mx=s}doLayout(){super.doLayout()}paint(t,e,s){if(this.mx){const i=ro.beat(s,_t.GuitarTabRests,this.beat);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}}class gu extends cl{slash=null;noteNumbers=null;restGlyph=null;get effectElement(){return _t.GuitarTabEffects}getNoteX(t,e){if(this.slash){let t=this.slash.x;switch(e){case Bh.Left:break;case Bh.Center:t+=this.slash.width/2;break;case Bh.Right:t+=this.slash.width}return t}return this.noteNumbers?this.noteNumbers.getNoteX(t,e):0}getNoteY(t,e){return this.noteNumbers?this.noteNumbers.getNoteY(t,e):0}getRestY(t){const e=this.restGlyph;if(e)switch(t){case Sh.TopWithStem:return e.getBoundingBoxTop()-this.renderer.smuflMetrics.getStemLength(l.Quarter,!0);case Sh.Top:return e.getBoundingBoxTop();case Sh.Center:case Sh.StemUp:case Sh.StemDown:return e.getBoundingBoxTop()+e.height/2;case Sh.Bottom:return e.getBoundingBoxTop();case Sh.BottomWithStem:return e.getBoundingBoxBottom()+this.renderer.smuflMetrics.getStemLength(l.Quarter,!0)}return 0}getLowestNoteY(t){return this.noteNumbers?this.noteNumbers.getLowestNoteY(t):0}getHighestNoteY(t){return this.noteNumbers?this.noteNumbers.getHighestNoteY(t):0}buildBoundingsLookup(t,e,s){this.noteNumbers&&this.noteNumbers.buildBoundingsLookup(t,e+this.x,s+this.y)}doLayout(){const e=this.renderer,s=[];if(this.container.beat.isRest){const t=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),s=e.getLineY(t),i=new mu(0,s,e.showRests,this.container.beat.duration);if(this.restGlyph=i,i.beat=this.container.beat,this.addNormal(i),this.container.beat.dots>0&&e.showRests)for(let t=0;t<this.container.beat.dots;t++)this.addEffect(new hl(0,s))}else{const i=this.renderer.settings.notation.smallGraceTabNotes&&this.container.beat.graceType!==u.None;let n;if(this.container.beat.slashed&&!this.container.beat.notes.some(t=>t.isTieDestination)){const t=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),s=e.getLineY(t),i=new ql(0,s,this.container.beat);i.noteHeadElement=pt.GuitarTabFretNumber,i.effectElement=_t.GuitarTabEffects,this.slash=i,i.beat=this.container.beat,this.addNormal(i),n=i.beatEffects}else{const t=new bu(0,0,i);this.noteNumbers=t,t.beat=this.container.beat;for(const t of this.container.beat.notes)t.isVisible&&this.MT(t);this.addNormal(t),n=t.beatEffects}if(this.container.beat.isTremolo&&!n.has("tremolo")){const t=new Hl(0,0,this.container.beat.tremoloPicking);t.offsetY=this.renderer.smuflMetrics.glyphTop.get(t.symbol),n.set("tremolo",t),s.push(t)}if(this.container.beat.dots>0&&e.rhythmMode!==t.TabRhythmMode.Hidden){const t=this.getNoteY(this.container.beat.maxNote,Sh.BottomWithStem);for(let e=0;e<this.container.beat.dots;e++)this.addEffect(new hl(0,t))}}if(this.isEmpty)return;let i=0;for(let t=0,e=this.glyphs.length;t<e;t++){const e=this.glyphs[t];e.x=i,e.renderer=this.renderer,e.doLayout(),i+=e.width}this.width=i,this.computedWidth=i,this.container.beat.isEmpty?this.onTimeX=this.width/2:this.restGlyph?this.onTimeX=this.restGlyph.x+this.restGlyph.width/2:this.noteNumbers?this.onTimeX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2:this.slash&&(this.onTimeX=this.slash.x+this.slash.width/2),this.middleX=this.onTimeX,this.stemX=this.middleX;for(const t of s)t.x=this.onTimeX}MT(t){const e=this.renderer,s=new pu(0,0,t),i=e.getNoteLine(t);s.y=e.getLineY(i),s.renderer=this.renderer,s.doLayout(),this.noteNumbers.addNoteGlyph(s,t);const n=s.getBoundingBoxTop(),r=s.getBoundingBoxBottom();this.renderer.collisionHelper.reserveBeatSlot(this.container.beat,n,r);const a=e.minString,h=e.maxString;(Number.isNaN(a)||a<t.string)&&(e.minString=i),(Number.isNaN(h)||h>t.string)&&(e.maxString=i)}}class wu extends Ra{Ne;PT;constructor(t){super(0,0),this.Ne=t}doLayout(){if(this.width=this.renderer.smuflMetrics.glyphWidths.get(ut.ArrowheadBlackDown),this.Ne.brushType===o.ArpeggioUp){const t=new sc(0,0,y.Slight,!0);t.renderer=this.renderer,t.doLayout(),this.PT=t}else if(this.Ne.brushType===o.ArpeggioDown){const t=new sc(0,0,y.Slight,!0);t.renderer=this.renderer,t.doLayout(),this.PT=t}}paint(t,e,s){const i=this.renderer,n=e+this.x+i.getNoteY(this.Ne.maxStringNote,Sh.Top),r=e+this.y+i.getNoteY(this.Ne.minStringNote,Sh.Bottom),a=t+this.x+this.width/2,h=this.renderer.smuflMetrics.glyphWidths.get(ut.ArrowheadBlackDown);if(this.Ne.brushType!==o.None){if(this.Ne.brushType===o.BrushUp||this.Ne.brushType===o.BrushDown)s.beginPath(),s.moveTo(a,n),s.lineTo(a,r),s.stroke();else if(this.Ne.brushType===o.ArpeggioUp){const e=this.PT,i=n,a=r-h;e.width=Math.abs(a-i),s.beginRotate(t+this.x,a,-90),e.paint(0,(this.width-e.height)/2,s),s.endRotate()}else if(this.Ne.brushType===o.ArpeggioDown){const e=this.PT,i=n+h,a=r;e.width=Math.abs(a-i),s.beginRotate(t+this.x,i,90),e.paint(0,-(this.width-e.height/2),s),s.endRotate()}this.Ne.brushType===o.BrushUp||this.Ne.brushType===o.ArpeggioUp?(s.beginPath(),s.moveTo(a,r),s.lineTo(a+h/2,r-h),s.lineTo(a-h/2,r-h),s.closePath(),s.fill()):(s.beginPath(),s.moveTo(a,n),s.lineTo(a+h/2,n+h),s.lineTo(a-h/2,n+h),s.closePath(),s.fill())}}}class yu extends ol{doLayout(){this.container.beat.brushType===o.None||this.container.beat.isRest||(this.addEffect(new wu(this.container.beat)),this.addNormal(new dl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))),super.doLayout()}get effectElement(){return _t.GuitarTabEffects}}class ku extends Ra{RT;WT;IT;OT;checkForOverflow=!1;constructor(t,e,s,i){super(0,0),this.RT=t,this.WT=e,this.IT=s,this.OT=i}doLayout(){this.width=0}paint(t,e,s){this.GT(t,e,s),this.gx(t,e,s)}GT(t,e,s){const i=this.renderer,n=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight;let a=0,h=0,o=0,c=0;const l=this.renderer.smuflMetrics.preNoteEffectPadding;switch(this.RT){case g.IntoFromBelow:o=t+i.x+i.getNoteX(this.IT,Bh.Left)-l,c=e+i.y+i.getNoteY(this.IT,Sh.Center)-r,a=o-n,h=e+i.y+i.getNoteY(this.IT,Sh.Center)+r;break;case g.IntoFromAbove:o=t+i.x+i.getNoteX(this.IT,Bh.Left)-l,c=e+i.y+i.getNoteY(this.IT,Sh.Center)+r,a=o-n,h=e+i.y+i.getNoteY(this.IT,Sh.Center)-r;break;default:return}this.HT(s,!1,a,o,h,c)}gx(t,e,s){const i=this.renderer,n=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight;let a=0,h=0,o=0,c=0,l=!1;const u=this.renderer.smuflMetrics.postNoteEffectPadding;switch(this.WT){case w.Shift:case w.Legato:if(a=t+i.x+i.getBeatX(this.IT.beat,ms.PostNotes)+u,h=e+i.y+i.getNoteY(this.IT,Sh.Center),this.IT.slideTarget){const s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.IT.slideTarget.beat.voice.bar);s&&s.staff===i.staff?(o=t+s.x+s.getBeatX(this.IT.slideTarget.beat,ms.OnNotes)-u,c=e+s.y+s.getNoteY(this.IT.slideTarget,Sh.Center)):(o=t+i.x+i.width,c=h),this.IT.slideTarget.fret>this.IT.fret?(h+=r,c-=r):(h-=r,c+=r)}else o=t+i.x+this.OT.x,c=h;break;case w.OutUp:a=t+i.x+i.getNoteX(this.IT,Bh.Right)+u,h=e+i.y+i.getNoteY(this.IT,Sh.Center)+r,o=a+n,c=e+i.y+i.getNoteY(this.IT,Sh.Center)-r;break;case w.OutDown:a=t+i.x+i.getNoteX(this.IT,Bh.Right)+u,h=e+i.y+i.getNoteY(this.IT,Sh.Center)-r,o=a+n,c=e+i.y+i.getNoteY(this.IT,Sh.Center)+r;break;case w.PickSlideDown:a=t+i.x+i.getNoteX(this.IT,Bh.Right)+2*u,h=e+i.y+i.getNoteY(this.IT,Sh.Center),o=t+i.x+i.width,c=h+3*r,this.IT.beat.nextBeat&&this.IT.beat.nextBeat.voice===this.IT.beat.voice&&(o=t+i.x+i.getBeatX(this.IT.beat.nextBeat,ms.PreNotes)),l=!0;break;case w.PickSlideUp:a=t+i.x+i.getNoteX(this.IT,Bh.Right)+2*u,h=e+i.y+i.getNoteY(this.IT,Sh.Center),o=t+i.x+i.width,c=h-3*r,this.IT.beat.nextBeat&&this.IT.beat.nextBeat.voice===this.IT.beat.voice&&(o=t+i.x+i.getBeatX(this.IT.beat.nextBeat,ms.PreNotes)),l=!0;break;default:return}this.HT(s,l,a,o,h,c)}HT(t,e,s,i,n,r){if(e){const e=new sc(0,0,y.Slight);e.renderer=this.renderer,e.doLayout(),n-=e.height/2;const a=i-s,h=(r-=e.height/2)-n,o=Math.sqrt(Math.pow(h,2)+Math.pow(a,2));e.width=a;const c=Math.asin(h/o)*(180/Math.PI);t.beginRotate(s,n,c),e.paint(0,0,t),t.endRotate()}else t.beginPath(),t.moveTo(s,n),t.lineTo(i,r),t.stroke()}}class Su extends Oa{jT=null;S_=[];constructor(t){super(t),this.preNotes=new yu,this.onNotes=new gu}drawBeamHelperAsFlags(t){return t.hasFlag(this.renderer.drawBeamHelperAsFlags(t),this.beat)}doLayout(){this.S_=[],super.doLayout(),this.jT&&(this.jT.renderer=this.renderer,this.jT.doLayout(),this.updateWidth())}createTies(t){if(!t.isVisible)return;const e=this.renderer;if(t.isTieOrigin&&e.showTiedNotes&&t.tieDestination.isVisible){const e=new bl(`tab.tie.${t.id}`,t,t.tieDestination,!1);this.addTie(e)}if(t.isTieDestination&&e.showTiedNotes){const e=new bl(`tab.tie.${t.tieOrigin.id}`,t.tieOrigin,t,!0);this.addTie(e)}if(t.isLeftHandTapped&&!t.isHammerPullDestination){const e=new bl(`tab.tie.leftHandTap.${t.id}`,t,t,!1);this.addTie(e)}if(t.isEffectSlurOrigin&&t.effectSlurDestination){let e=!1;for(const s of this.S_)if(s.tryExpand(t,t.effectSlurDestination,!1,!1)){e=!0;break}if(!e){const e=new ml(`tab.slur.effect.${t.id}`,t,t.effectSlurDestination,!1,!1);this.S_.push(e),this.addTie(e)}}if(t.isEffectSlurDestination&&t.effectSlurOrigin){let e=!1;for(const s of this.S_)if(s.tryExpand(t.effectSlurOrigin,t,!1,!0)){e=!0;break}if(!e){const e=new ml(`tab.slur.effect.${t.effectSlurOrigin.id}`,t.effectSlurOrigin,t,!1,!0);this.S_.push(e),this.addTie(e)}}if(t.slideInType!==g.None||t.slideOutType!==w.None){const e=new ku(t.slideInType,t.slideOutType,t,this);this.addTie(e)}if(t.hasBend){if(!this.jT){const t=new nc;this.jT=t,t.renderer=this.renderer,this.addTie(t)}this.jT.addBends(t)}}}class Bu extends Yh{constructor(t,e){super(t,e,1,ut.SixStringTabClef)}doLayout(){this.symbol=this.renderer.bar.staff.tuning.length<=4?ut.FourStringTabClef:ut.SixStringTabClef,this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(ut.GClef),this.offsetX=this.width/2}}class _u extends Bl{doLayout(){this.barSubElement=E.GuitarTabsTimeSignature,super.doLayout()}get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?Or.GraceScale:1}}class Tu extends Ml{static StaffId="tab";wx=!1;showTimeSignature=!1;showRests=!1;showTiedNotes=!1;yx=!1;get showMultiBarRest(){return this.yx}get repeatsBarSubElement(){return E.GuitarTabsRepeats}get barNumberBarSubElement(){return E.GuitarTabsBarNumber}get barLineBarSubElement(){return E.GuitarTabsBarLines}get staffLineBarSubElement(){return E.GuitarTabsStaffLine}get lineSpacing(){return this.smuflMetrics.tabLineSpacing}get heightLineCount(){return this.bar.staff.tuning.length}get drawnLineCount(){return this.bar.staff.tuning.length}get rhythmMode(){let e=this.settings.notation.rhythmMode;return e===t.TabRhythmMode.Automatic&&(e=this.bar.staff.showStandardNotation?t.TabRhythmMode.Hidden:t.TabRhythmMode.ShowWithBars),e}getNoteLine(t){return this.bar.staff.tuning.length-t.string}minString=Number.NaN;maxString=Number.NaN;collectSpaces(t){if(this.additionalMultiRestBars)return;const e=this.smuflMetrics.staffLineThickness,s=this.bar.staff.tuning;for(const i of this.voiceContainer.beatGlyphs.values())for(const n of i){const i=n.onNotes,r=i.noteNumbers;if(r)for(const[a,h]of r.notesPerString)h.isEmpty||t[s.length-a].push(new Float32Array([this.beatGlyphsStart+n.x+i.x+r.x-e,r.width+2*e]))}}doLayout(){this.bar.staff.showStandardNotation&&this.scoreRenderer.layout.profile.has(au.StaffId)||(this.showTimeSignature=!0,this.showRests=!0,this.showTiedNotes=!0,this.yx=!0),super.doLayout();0===this.minString&&this.registerOverflowTop(this.lineSpacing/2);this.maxString===this.bar.staff.tuning.length-1&&this.registerOverflowBottom(this.lineSpacing/2),this.rhythmMode!==t.TabRhythmMode.Hidden&&(this.wx=this.voiceContainer.tupletGroups.size>0,this.wx&&this.registerOverflowBottom(this.settings.notation.rhythmHeight+this.tupletSize))}createLinePreBeatGlyphs(){if(this.isFirstOfStaff){const t=(this.bar.staff.tuning.length-1)/2;this.createStartSpacing(),this.addPreBeatGlyph(new Bu(0,this.getLineY(t)))}this.showTimeSignature&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.R_())}R_(){this.addPreBeatGlyph(new dl(0,0,this.smuflMetrics.oneStaffSpace));const t=(this.bar.staff.tuning.length+1)/2-1;this.addPreBeatGlyph(new _u(0,this.getLineY(t),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime))}createVoiceGlyphs(t){super.createVoiceGlyphs(t);for(const e of t.beats)this.addBeatGlyph(new Su(e))}get flagsSubElement(){return _t.GuitarTabFlags}get beamsSubElement(){return _t.GuitarTabBeams}get tupletSubElement(){return _t.GuitarTabTuplet}paintBeams(e,s,i,n,r){this.rhythmMode!==t.TabRhythmMode.Hidden&&super.paintBeams(e,s,i,n,r)}paintTuplets(e,s,i,n,r=!1){this.rhythmMode!==t.TabRhythmMode.Hidden&&super.paintTuplets(e,s,i,n,r)}drawBeamHelperAsFlags(e){return super.drawBeamHelperAsFlags(e)||this.rhythmMode===t.TabRhythmMode.ShowWithBeams}getFlagTopY(t,e){const s=t.maxStringNote,i=e===Rt.Up?Sh.TopWithStem:Sh.StemDown;return s?this.getNoteY(s,i):this.getRestY(t,i)}getFlagBottomY(t,e){const s=t.minStringNote,i=e===Rt.Up?Sh.StemUp:Sh.BottomWithStem;return s?this.getNoteY(s,i):this.getRestY(t,i)}getBeamDirection(t){return Rt.Down}shouldPaintFlag(t){return!!super.shouldPaintFlag(t)&&t.graceType===u.None}paintBeamingStem(t,e,s,i,n,r){if(n<i){const t=n;n=i,i=t}const a=ro.beat(r,_t.GuitarTabStem,t);try{let a=[];if(this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.has(t.displayStart)&&(a=this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.get(t.displayStart).slots.slice(),a.sort((t,e)=>t.topY-e.topY)),1===a.length)return void r.fillRect(s,i,this.smuflMetrics.stemThickness,n-i);const h=n-e,o=a[a.length-1];r.fillRect(s,e+o.bottomY,this.smuflMetrics.stemThickness,h-o.bottomY);for(let t=a.length-1;t>0;t--){const i=a[t].topY,n=a[t-1].bottomY;n<i&&r.fillRect(s,e+n,this.smuflMetrics.stemThickness,i-n)}}finally{a?.[Symbol.dispose]?.()}}calculateOverflows(e,s){super.calculateOverflows(e,s),this.bar.isEmpty||this.rhythmMode!==t.TabRhythmMode.Hidden&&this.calculateBeamingOverflows(e,s)}}class xu extends Ch{get staffId(){return Tu.StaffId}constructor(t){super(t),this.hideOnPercussionTrack=!0}canCreate(t,e){return e.showTablature&&e.tuning.length>0&&super.canCreate(t,e)}create(t,e){return new Tu(t,e)}}class Mu{vertical;createLayout;constructor(t,e){this.vertical=t,this.createLayout=e}}class vu{supportsWorkers;createCanvas;constructor(t,e){this.supportsWorkers=t,this.createCanvas=e}}class Nu{static highDpiFactor=1;static kx=void 0;static get globalThis(){if(void 0===Nu.kx){try{Nu.kx=globalThis}catch{}void 0===Nu.kx&&(Nu.kx=self),void 0===Nu.kx&&(Nu.kx=global),void 0===Nu.kx&&(Nu.kx=window),void 0===Nu.kx&&(Nu.kx=Function("return this")())}return Nu.kx}static webPlatform=Nu.Sx();static isWebPackBundled=Nu.Bx();static isViteBundled=Nu._x();static scriptFile=Nu.Tx();static fontDirectory=Nu.xx();static get isRunningInWorker(){return"WorkerGlobalScope"in Nu.globalThis}static get isRunningInAudioWorklet(){return"AudioWorkletGlobalScope"in Nu.globalThis}static createWebWorker;static createAudioWorklet;static throttle(t,e){let s=0;return()=>{Nu.globalThis.clearTimeout(s),s=Nu.globalThis.setTimeout(t,e)}}static Tx(){if(!Nu.isRunningInWorker&&Nu.globalThis.ALPHATAB_ROOT){let t=Nu.globalThis.ALPHATAB_ROOT;return t=Nu.ensureFullUrl(t),t=Nu.Mx(t),t}try{const t={};if(t&&-1===t.indexOf("file://"))return t}catch{}return"document"in Nu.globalThis&&document.currentScript&&document.currentScript instanceof HTMLScriptElement?document.currentScript.src:null}static ensureFullUrl(t){if(!t)return"";if(!t.startsWith("http")&&!t.startsWith("https")&&!t.startsWith("file")){let e="";const s=Nu.globalThis.location;if(e+=s.protocol?.toString(),e+="//"?.toString(),s.hostname&&(e+=s.hostname?.toString()),s.port&&(e+=":"?.toString(),e+=s.port?.toString()),!t.startsWith("/")){const t=s.pathname.split("/").slice(0,-1).join("/");t.length>0&&(t.startsWith("/")||(e+="/"?.toString()),e+=t?.toString())}return t.startsWith("/")||(e+="/"?.toString()),e+=t?.toString(),e}return t}static Mx(t){return t&&!t.endsWith(".js")&&(t.endsWith("/")||(t+="/"),t+="alphaTab.js"),t}static xx(){if(!Nu.isRunningInWorker&&Nu.globalThis.ALPHATAB_FONT)return Nu.ensureFullUrl(Nu.globalThis.ALPHATAB_FONT);const t=Nu.scriptFile;if(t){const e=t.lastIndexOf(String.fromCharCode(47));if(e>=0)return`${t.substr(0,e)}/font/`}return null}static vx(){if(!Nu.isRunningInWorker&&Nu.globalThis&&"jQuery"in Nu.globalThis){const t=Nu.globalThis.jQuery,e=new wh;t.fn.alphaTab=function(t){const s=Array.prototype.slice.call(arguments,1);return 1===this.length?e.exec(this[0],t,s):this.each((i,n)=>{e.exec(n,t,s)})},t.alphaTab={restore:wh.restore},t.fn.alphaTab.fn=e}}static renderEngines=Nu.Nx();static layoutEngines=Nu.Px();static staveProfiles=Nu.Cx();static getRenderEngineFactory(t){return t&&Nu.renderEngines.has(t)?Nu.renderEngines.get(t):Nu.renderEngines.get("default")}static getLayoutEngineFactory(e){return e&&Nu.layoutEngines.has(e)?Nu.layoutEngines.get(e):Nu.layoutEngines.get(t.LayoutMode.Page)}static buildImporters(){return[new $s,new oi,new ii,new pi,new Vs,new We]}static Nx(){const t=new Map;return t.set("svg",new vu(!0,()=>new Ph)),t.set("default",t.get("svg")),t.set("skia",new vu(!1,()=>new vh)),Nu.Ex(t),t}static enableAlphaSkia(t,e){vh.enable(t,e)}static registerAlphaSkiaCustomFont(t){return vh.registerFont(t)}static Ex(t){t.set("html5",new vu(!1,()=>new ka))}static defaultRenderers=[new fu([{effect:new bc,mode:yh.SharedTop},{effect:new kc,mode:yh.SharedTop},{effect:new So,mode:yh.SharedTop},{effect:new qh,mode:yh.SharedTop},{effect:new lo,mode:yh.SharedTop},{effect:new mc,mode:yh.SharedTop},{effect:new Oh,mode:yh.SharedTop},{effect:new Hh,mode:yh.SharedTop},{effect:new Dh,mode:yh.SharedTop,order:1e3}]),new hu([{effect:new Vh,mode:yh.SharedTop},{effect:new io,mode:yh.SharedTop},{effect:new Rh,mode:yh.SharedTop},{effect:new _o,mode:yh.SharedTop},{effect:new Ao,mode:yh.SharedTop},{effect:new Bc,mode:yh.SharedTop},{effect:new _c,mode:yh.OwnedTop},{effect:new ac,mode:yh.OwnedTop},{effect:new wc,mode:yh.OwnedTop},{effect:new No(!0),mode:yh.OwnedTop},{effect:new go,mode:yh.OwnedTop},{effect:new fc,mode:yh.OwnedTop},{effect:new Tc,mode:yh.OwnedTop},{effect:new oc,mode:yh.OwnedTop},{effect:new xc,mode:yh.OwnedTop},{effect:new cc(!1),mode:yh.OwnedTop},{effect:new eo,mode:yh.OwnedTop,shouldCreate:t=>!t.showTablature},{effect:new wo,mode:yh.OwnedTop,shouldCreate:t=>!t.showTablature},{effect:new Fo,mode:yh.OwnedTop,shouldCreate:t=>!t.showTablature},{effect:new Co,mode:yh.OwnedTop,shouldCreate:t=>!t.showTablature},{effect:new fo(mt.Finger),mode:yh.OwnedTop},{effect:new fo(mt.Thumb),mode:yh.OwnedBottom},{effect:new zh,mode:yh.SharedBottom},{effect:new Zh,mode:yh.SharedBottom},{effect:new uc,mode:yh.SharedBottom}]),new Nl([{effect:new Mo,mode:yh.OwnedTop,order:1e3}]),new xu([{effect:new ko,mode:yh.SharedTop},{effect:new dc,mode:yh.OwnedTop},{effect:new wc,mode:yh.OwnedTop},{effect:new Tc,mode:yh.OwnedTop},{effect:new oc,mode:yh.OwnedTop},{effect:new xc,mode:yh.OwnedTop},{effect:new cc(!0),mode:yh.OwnedTop},{effect:new fc,mode:yh.OwnedTop},{effect:new eo,mode:yh.OwnedTop},{effect:new bo(p.Natural),mode:yh.OwnedTop},{effect:new bo(p.Artificial),mode:yh.OwnedTop},{effect:new bo(p.Pinch),mode:yh.OwnedTop},{effect:new bo(p.Tap),mode:yh.OwnedTop},{effect:new bo(p.Semi),mode:yh.OwnedTop},{effect:new bo(p.Feedback),mode:yh.OwnedTop},{effect:new wo,mode:yh.OwnedTop},{effect:new co,mode:yh.OwnedTop},{effect:new Po,mode:yh.OwnedTop},{effect:new Fo,mode:yh.OwnedTop},{effect:new Co,mode:yh.OwnedTop},{effect:new go,mode:yh.OwnedTop},{effect:new fo(mt.Finger),mode:yh.OwnedTop,shouldCreate:t=>!t.showStandardNotation},{effect:new fo(mt.Thumb),mode:yh.OwnedBottom,shouldCreate:t=>!t.showStandardNotation}])];static Cx(){const e=new Map;return e.set(t.StaveProfile.Default,new Set([du.StaffId,au.StaffId,vl.StaffId,Tu.StaffId])),e.set(t.StaveProfile.ScoreTab,new Set([du.StaffId,au.StaffId,vl.StaffId,Tu.StaffId])),e.set(t.StaveProfile.Score,new Set([au.StaffId])),e.set(t.StaveProfile.Tab,new Set([Tu.StaffId])),e.set(t.StaveProfile.TabMixed,new Set([Tu.StaffId])),e}static Px(){const e=new Map;return e.set(t.LayoutMode.Page,new Mu(!0,t=>new Xc(t))),e.set(t.LayoutMode.Horizontal,new Mu(!1,t=>new Uc(t))),e.set(t.LayoutMode.Parchment,new Mu(!0,t=>new jc(t))),e}static initializeMain(e,s){Nu.isRunningInWorker||Nu.isRunningInAudioWorklet||(Nu.webPlatform!==t.WebPlatform.Browser&&Nu.webPlatform!==t.WebPlatform.BrowserModule||(Nu.vx(),Nu.highDpiFactor=window.devicePixelRatio),Nu.createWebWorker=e,Nu.createAudioWorklet=s)}static get alphaTabWorker(){return Nu.globalThis.Worker}static get alphaTabUrl(){return Nu.globalThis.URL}static initializeWorker(){if(!Nu.isRunningInWorker)throw new G(t.AlphaTabErrorType.General,"Not running in worker, cannot run worker initialization");ya.init(),oa.init(),Nu.createWebWorker=e=>{throw new G(t.AlphaTabErrorType.General,"Nested workers are not supported")}}static initializeAudioWorklet(){if(!Nu.isRunningInAudioWorklet)throw new G(t.AlphaTabErrorType.General,"Not running in audio worklet, cannot run worklet initialization");Bi.init()}static Bx(){try{if("function"==typeof __webpack_require__)return"boolean"!=typeof __ALPHATAB_WEBPACK__&&q.warning("WebPack","Detected bundling with WebPack but @coderline/alphatab-webpack was not used! To ensure alphaTab works as expected use our bundler plugins. Learn more at https://www.alphatab.net/docs/getting-started/installation-webpack"),!0}catch{}return!1}static _x(){try{if("string"==typeof __BASE__)return"boolean"!=typeof __ALPHATAB_VITE__&&q.warning("Vite","Detected bundling with Vite but @coderline/alphatab-vite was not used! To ensure alphaTab works as expected use our bundler plugins. Learn more at https://www.alphatab.net/docs/getting-started/installation-vite"),!0}catch{}return!1}static Sx(){if(!(void 0!==Nu.globalThis.Window&&Nu.globalThis instanceof Nu.globalThis.Window))try{if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return t.WebPlatform.NodeJs}catch{}try{const e={};if(e&&"string"==typeof e&&!e.startsWith("file://"))return t.WebPlatform.BrowserModule}catch{}return t.WebPlatform.Browser}static printEnvironmentInfo(t=!0){const e=t?t=>{q.log.debug("VersionInfo",t)}:t=>{q.debug("VersionInfo",t)};V.print(e),e(`High DPI: ${Nu.highDpiFactor}`),Nu.Ax(e)}static Ax(e){e(`Platform: ${t.WebPlatform[Nu.webPlatform]}`),e(`WebPack: ${Nu.isWebPackBundled}`),e(`Vite: ${Nu.isViteBundled}`),Nu.webPlatform!==t.WebPlatform.NodeJs&&(e(`Browser: ${navigator.userAgent}`),e(`Window Size: ${window.outerWidth}x${window.outerHeight}`),e(`Screen Size: ${window.screen.width}x${window.screen.height}`))}static prepareForPostMessage(t){if(!t)return t;if("object"==typeof t){const e=t.Dx;if(e)return Nu.prepareForPostMessage(e)}return t}static quoteJsonString(t){return JSON.stringify(t)}static sortDescending(t){t.sort((t,e)=>e-t)}}t.FontFileFormat=void 0,(xh=t.FontFileFormat||(t.FontFileFormat={}))[xh.EmbeddedOpenType=0]="EmbeddedOpenType",xh[xh.Woff=1]="Woff",xh[xh.Woff2=2]="Woff2",xh[xh.OpenType=3]="OpenType",xh[xh.TrueType=4]="TrueType",xh[xh.Svg=5]="Svg";class Pu{scriptFile=null;fontDirectory=null;smuflFontSources=null;static buildDefaultSmuflFontSources(e){const s=new Map,i=e??"";return s.set(t.FontFileFormat.Woff2,`${i}Bravura.woff2`),s.set(t.FontFileFormat.Woff,`${i}Bravura.woff`),s.set(t.FontFileFormat.OpenType,`${i}Bravura.otf`),s}file=null;tex=!1;tracks=null;enableLazyLoading=!0;engine="default";logLevel=t.LogLevel.Info;useWorkers=!0;includeNoteBounds=!1;constructor(){this.scriptFile=Nu.scriptFile,this.fontDirectory=Nu.fontDirectory}}const Cu=Object.freeze(Object.defineProperty({__proto__:null,get AlphaTexAccidentalMode(){return vt},AlphaTexDiagnosticBag:ue,get AlphaTexDiagnosticCode(){return Mt},get AlphaTexDiagnosticsSeverity(){return xt},AlphaTexLexer:pe,get AlphaTexNodeType(){return Tt},get AlphaTexParseMode(){return Et},AlphaTexParser:be,get AlphaTexStaffNoteKind(){return Pt},get AlphaTexVoiceMode(){return Nt},get ArgumentListParseTypesMode(){return Ct}},Symbol.toStringTag,{value:"Module"})),Eu=Object.freeze(Object.defineProperty({__proto__:null,AlphaTexErrorWithDiagnostics:De,AlphaTexImporter:We,ScoreImporter:Ee,ScoreLoader:nh,UnsupportedFormatError:Fe,alphaTex:Cu},Symbol.toStringTag,{value:"Module"})),Fu=Object.freeze(Object.defineProperty({__proto__:null,ByteBuffer:Ae,IOHelper:fe},Symbol.toStringTag,{value:"Module"}));class Au{data;settings;init(t,e){this.data=t,this.settings=e}export(t,e=null){const s=Ae.withCapacity(1024);return this.init(s,e??new aa),this.writeScore(t),s.toArray()}}class Du{tex="";isStartOfLine=!0;indentString="";currentIndent=0;indent(){this.indentString.length>0&&this.currentIndent++}outdent(){this.indentString.length>0&&this.currentIndent--}Lx(){if(this.isStartOfLine&&this.indentString.length>0)for(let t=0;t<this.currentIndent;t++)this.tex+=this.indentString;this.isStartOfLine=!1}write(t){this.Lx(),this.tex+=t,this.isStartOfLine=!1}writeString(t){this.Lx(),this.tex+=Nu.quoteJsonString(t)}writeLine(t){this.Lx(),void 0!==t&&(this.tex+=t),this.indentString.length>0?this.tex+="\n":this.tex.endsWith(" ")||(this.tex+=" "),this.isStartOfLine=!0}}class Lu{Wx;Rx=!1;get tex(){return this.Wx.tex}constructor(t){const e=new Du;this.Rx=t.exporter.comments,e.indentString=t.exporter.indent>0?" ".repeat(t.exporter.indent):"",this.Wx=e}writeScoreNode(t){this.Ix(t.leadingComments);for(const e of t.bars)this.Ox(e);this.Ix(t.trailingComments)}Ox(t){this.Ix(t.leadingComments),this.Gx(t.metaData),this.Wx.indent();for(const e of t.beats)this.Vx(e);this.Wx.outdent(),this.Ix(t.trailingComments),this.$x(t.pipe,!0)}Vx(t){this.Ix(t.leadingComments),t.durationChange&&this.Hx(t.durationChange),t.rest?this.Ux(t.rest):t.notes&&this.zx(t.notes),this.$x(t.durationDot,!1),this.Ux(t.durationValue),this.$x(t.beatMultiplier,!1),this.Ux(t.beatMultiplierValue),t.beatEffects&&this.Xx(t.beatEffects,!1),this.Ix(t.trailingComments),this.Wx.writeLine()}zx(t){this.Ix(t.leadingComments),this.$x(t.openParenthesis,!1);let e=!0;for(const s of t.notes)e||this.Wx.write(" "),this.jx(s),e=!1;this.$x(t.closeParenthesis,!1),this.Ix(t.trailingComments)}jx(t){this.Ix(t.leadingComments),this.Ux(t.noteValue),this.$x(t.noteStringDot,!1),this.Ux(t.noteString),t.noteEffects&&this.Xx(t.noteEffects,!1),this.Ix(t.trailingComments)}Hx(t){this.Ix(t.leadingComments),this.$x(t.colon,!1),this.Ux(t.value),t.properties&&(this.Wx.write(" "),this.Xx(t.properties,!1)),this.Ix(t.trailingComments),this.Wx.write(" ")}Gx(t){for(const e of t)this.Jx(e)}qx=0;Yx=0;M_=0;Jx(t){switch(t.tag.tag.text){case"track":this.Yx>0&&this.Wx.outdent(),this.qx>0&&this.Wx.outdent();break;case"staff":this.Yx>0&&this.Wx.outdent();break;case"voice":this.M_>0&&this.Wx.outdent()}this.Ix(t.leadingComments),this.$x(t.tag.prefix,!1),this.Ux(t.tag.tag);let e=!0;switch(t.propertiesBeforeArguments?(t.properties&&(this.Wx.write(" "),this.Xx(t.properties,!1)),t.arguments&&(this.Wx.write(" "),this.Kx(t.arguments))):(t.arguments&&(this.Wx.write(" "),this.Kx(t.arguments)),t.properties&&(this.Wx.write(" "),this.Xx(t.properties,!0),e=!1)),t.trailingComments&&(this.Wx.write(" "),this.Ix(t.trailingComments)),t.tag.tag.text){case"track":this.qx++,this.Yx=0,this.M_=0,this.Wx.indent();break;case"staff":this.Yx++,this.M_=0,this.Wx.indent();break;case"voice":this.M_++,this.Wx.indent()}e&&this.Wx.writeLine()}Xx(t,e){this.Ix(t.leadingComments),this.$x(t.openBrace,e),e&&this.Wx.indent();let s=!0;for(const i of t.properties)s||e||this.Wx.write(" "),this.Qx(i),s=!1,e&&this.Wx.writeLine();e&&this.Wx.outdent(),this.$x(t.closeBrace,e),this.Ix(t.trailingComments)}Qx(t){this.Ix(t.leadingComments),this.Ux(t.property),t.arguments&&(this.Wx.write(" "),this.Kx(t.arguments)),this.Ix(t.trailingComments)}Kx(t){this.Ix(t.leadingComments),this.$x(t.openParenthesis,!1);let e=!0;for(const s of t.arguments)e||this.Wx.write(" "),this.Ux(s),e=!1;this.$x(t.closeParenthesis,!1),this.Ix(t.trailingComments)}Ux(t){if(t){switch(this.Ix(t.leadingComments),t.nodeType){case Tt.Ident:this.Wx.write(t.text);break;case Tt.Arguments:this.Kx(t);break;case Tt.Number:this.Wx.write(t.value.toString());break;case Tt.String:this.Wx.writeString(t.text)}this.Ix(t.trailingComments)}}$x(t,e){if(t){switch(this.Ix(t.leadingComments),t.nodeType){case Tt.Dot:this.Wx.write(".");break;case Tt.Backslash:this.Wx.write("\\");break;case Tt.DoubleBackslash:this.Wx.write("\\\\");break;case Tt.Pipe:this.Wx.write("|");break;case Tt.LBrace:this.Wx.write("{");break;case Tt.RBrace:this.Wx.write("}");break;case Tt.LParen:this.Wx.write("(");break;case Tt.RParen:this.Wx.write(")");break;case Tt.Colon:this.Wx.write(":");break;case Tt.Asterisk:this.Wx.write("*")}this.Ix(t.trailingComments),e&&this.Wx.writeLine()}}Ix(t){if(this.Rx&&t)for(const e of t){let t=e.text;t.startsWith(" ")||(t=` ${t}`),e.multiLine?(t.endsWith(" ")||(t+=" "),this.Wx.write(`/*${t}*/`)):this.Wx.writeLine(`//${t}`)}}}class Wu{icon=Ru.Piano;instrumentSetName;instrumentSetType;constructor(t,e,s=null){if(this.icon=t,this.instrumentSetName=e,s)this.instrumentSetType=s;else{const t=e.split(" ");t[0]=t[0].substr(0,1).toLowerCase()+t[0].substr(1),this.instrumentSetType=t.join("")}}}var Ru;!function(t){t[t.SteelGuitar=1]="SteelGuitar",t[t.AcousticGuitar=2]="AcousticGuitar",t[t.TwelveStringGuitar=3]="TwelveStringGuitar",t[t.ElectricGuitar=4]="ElectricGuitar",t[t.Bass=5]="Bass",t[t.ClassicalGuitar=23]="ClassicalGuitar",t[t.UprightBass=6]="UprightBass",t[t.Ukulele=7]="Ukulele",t[t.Banjo=8]="Banjo",t[t.Mandolin=9]="Mandolin",t[t.Piano=10]="Piano",t[t.Synth=12]="Synth",t[t.Strings=11]="Strings",t[t.Brass=13]="Brass",t[t.Reed=14]="Reed",t[t.Woodwind=15]="Woodwind",t[t.Vocal=16]="Vocal",t[t.PitchedIdiophone=17]="PitchedIdiophone",t[t.Fx=21]="Fx",t[t.PercussionKit=18]="PercussionKit",t[t.Idiophone=19]="Idiophone",t[t.Membraphone=20]="Membraphone"}(Ru||(Ru={}));class Iu{lineCount=0;name="";type="";elements=[];static create(t,e,s,i){const n=new Iu;return n.name=t,n.type=e,n.lineCount=s,n.elements=i,n}}class Ou{name;type;soundbankName;articulations;constructor(t,e,s,i){this.name=t,this.type=e,this.soundbankName=s,this.articulations=i}}class Gu{name;staffLine;noteHeads;techniqueSymbol;techniqueSymbolPlacement;inputMidiNumbers;outputMidiNumber;outputRSESound;constructor(t,e,s,i,n,r,a,h){this.name=t,this.staffLine=e,this.noteHeads=s,this.techniqueSymbol=i,this.techniqueSymbolPlacement=n,this.inputMidiNumbers=r,this.outputMidiNumber=a,this.outputRSESound=h}static template(t,e,s){return new Gu(t,0,[],ut.None,dt.Outside,e,0,s)}}class Vu{static Zx=new Map([[0,new Wu(Ru.Piano,"Acoustic Piano")],[1,new Wu(Ru.Piano,"Acoustic Piano")],[2,new Wu(Ru.Piano,"Electric Piano")],[3,new Wu(Ru.Piano,"Acoustic Piano")],[4,new Wu(Ru.Piano,"Electric Piano")],[5,new Wu(Ru.Piano,"Electric Piano")],[6,new Wu(Ru.Piano,"Harpsichord")],[7,new Wu(Ru.Piano,"Harpsichord")],[8,new Wu(Ru.PitchedIdiophone,"Celesta")],[9,new Wu(Ru.PitchedIdiophone,"Vibraphone")],[10,new Wu(Ru.PitchedIdiophone,"Vibraphone")],[11,new Wu(Ru.PitchedIdiophone,"Vibraphone")],[12,new Wu(Ru.PitchedIdiophone,"Xylophone")],[13,new Wu(Ru.PitchedIdiophone,"Xylophone")],[14,new Wu(Ru.PitchedIdiophone,"Vibraphone")],[15,new Wu(Ru.Banjo,"Banjo")],[16,new Wu(Ru.Piano,"Electric Organ")],[17,new Wu(Ru.Piano,"Electric Organ")],[18,new Wu(Ru.Piano,"Electric Organ")],[19,new Wu(Ru.Piano,"Electric Organ")],[20,new Wu(Ru.Piano,"Electric Organ")],[21,new Wu(Ru.Piano,"Electric Organ")],[22,new Wu(Ru.Woodwind,"Recorder")],[23,new Wu(Ru.Piano,"Electric Organ")],[24,new Wu(Ru.ClassicalGuitar,"Nylon Guitar")],[25,new Wu(Ru.SteelGuitar,"Steel Guitar")],[26,new Wu(Ru.SteelGuitar,"Electric Guitar")],[27,new Wu(Ru.ElectricGuitar,"Electric Guitar")],[28,new Wu(Ru.ElectricGuitar,"Electric Guitar")],[29,new Wu(Ru.ElectricGuitar,"Electric Guitar")],[30,new Wu(Ru.SteelGuitar,"Electric Guitar")],[31,new Wu(Ru.SteelGuitar,"Electric Guitar")],[32,new Wu(Ru.Bass,"Acoustic Bass")],[33,new Wu(Ru.Bass,"Electric Bass")],[34,new Wu(Ru.Bass,"Electric Bass")],[35,new Wu(Ru.Bass,"Acoustic Bass")],[36,new Wu(Ru.Bass,"Electric Bass")],[37,new Wu(Ru.Bass,"Electric Bass")],[38,new Wu(Ru.Synth,"Synth Bass")],[39,new Wu(Ru.Synth,"Synth Bass")],[40,new Wu(Ru.Strings,"Violin")],[41,new Wu(Ru.Strings,"Viola")],[42,new Wu(Ru.Strings,"Cello")],[43,new Wu(Ru.Strings,"Contrabass")],[44,new Wu(Ru.Strings,"Violin")],[45,new Wu(Ru.Strings,"Violin")],[46,new Wu(Ru.Piano,"Harp")],[47,new Wu(Ru.Membraphone,"Timpani")],[48,new Wu(Ru.Strings,"Violin")],[49,new Wu(Ru.Strings,"Violin")],[50,new Wu(Ru.Strings,"Violin")],[51,new Wu(Ru.Strings,"Violin")],[52,new Wu(Ru.Vocal,"Voice")],[53,new Wu(Ru.Vocal,"Voice")],[54,new Wu(Ru.Vocal,"Voice")],[55,new Wu(Ru.Synth,"Pad Synthesizer")],[56,new Wu(Ru.Brass,"Trumpet")],[57,new Wu(Ru.Brass,"Trombone")],[58,new Wu(Ru.Brass,"Tuba")],[59,new Wu(Ru.Brass,"Trumpet")],[60,new Wu(Ru.Brass,"French Horn")],[61,new Wu(Ru.Brass,"Trumpet")],[62,new Wu(Ru.Brass,"Trumpet")],[63,new Wu(Ru.Brass,"Trumpet")],[64,new Wu(Ru.Reed,"Saxophone")],[65,new Wu(Ru.Reed,"Saxophone")],[66,new Wu(Ru.Reed,"Saxophone")],[67,new Wu(Ru.Reed,"Saxophone")],[68,new Wu(Ru.Reed,"Oboe")],[69,new Wu(Ru.Reed,"English Horn")],[70,new Wu(Ru.Reed,"Bassoon")],[71,new Wu(Ru.Reed,"Clarinet")],[72,new Wu(Ru.Reed,"Piccolo")],[73,new Wu(Ru.Woodwind,"Flute")],[74,new Wu(Ru.Woodwind,"Recorder")],[75,new Wu(Ru.Woodwind,"Flute")],[76,new Wu(Ru.Woodwind,"Recorder")],[77,new Wu(Ru.Woodwind,"Flute")],[78,new Wu(Ru.Woodwind,"Recorder")],[79,new Wu(Ru.Woodwind,"Flute")],[80,new Wu(Ru.Synth,"Lead Synthesizer")],[81,new Wu(Ru.Synth,"Lead Synthesizer")],[82,new Wu(Ru.Synth,"Lead Synthesizer")],[83,new Wu(Ru.Synth,"Lead Synthesizer")],[84,new Wu(Ru.Synth,"Lead Synthesizer")],[85,new Wu(Ru.Synth,"Lead Synthesizer")],[86,new Wu(Ru.Synth,"Lead Synthesizer")],[87,new Wu(Ru.Synth,"Lead Synthesizer")],[88,new Wu(Ru.Synth,"Pad Synthesizer")],[89,new Wu(Ru.Synth,"Pad Synthesizer")],[90,new Wu(Ru.Synth,"Pad Synthesizer")],[91,new Wu(Ru.Synth,"Pad Synthesizer")],[92,new Wu(Ru.Synth,"Pad Synthesizer")],[93,new Wu(Ru.Synth,"Pad Synthesizer")],[94,new Wu(Ru.Synth,"Pad Synthesizer")],[95,new Wu(Ru.Synth,"Pad Synthesizer")],[96,new Wu(Ru.Fx,"Pad Synthesizer")],[97,new Wu(Ru.Fx,"Pad Synthesizer")],[98,new Wu(Ru.Fx,"Pad Synthesizer")],[99,new Wu(Ru.Fx,"Pad Synthesizer")],[100,new Wu(Ru.Fx,"Lead Synthesizer")],[101,new Wu(Ru.Fx,"Lead Synthesizer")],[102,new Wu(Ru.Fx,"Lead Synthesizer")],[103,new Wu(Ru.Fx,"Trumpet")],[104,new Wu(Ru.ElectricGuitar,"Banjo")],[105,new Wu(Ru.Banjo,"Banjo")],[106,new Wu(Ru.Ukulele,"Ukulele")],[107,new Wu(Ru.Banjo,"Banjo")],[108,new Wu(Ru.PitchedIdiophone,"Xylophone")],[109,new Wu(Ru.Reed,"Bassoon")],[110,new Wu(Ru.Strings,"Violin")],[111,new Wu(Ru.Woodwind,"Flute")],[112,new Wu(Ru.PitchedIdiophone,"Xylophone")],[113,new Wu(Ru.Idiophone,"Celesta")],[114,new Wu(Ru.PitchedIdiophone,"Vibraphone")],[115,new Wu(Ru.Idiophone,"Xylophone")],[116,new Wu(Ru.Membraphone,"Xylophone")],[117,new Wu(Ru.Membraphone,"Xylophone")],[118,new Wu(Ru.Membraphone,"Xylophone")],[119,new Wu(Ru.Idiophone,"Celesta")],[120,new Wu(Ru.Fx,"Steel Guitar")],[121,new Wu(Ru.Fx,"Recorder")],[122,new Wu(Ru.Fx,"Recorder")],[123,new Wu(Ru.Fx,"Recorder")],[124,new Wu(Ru.Fx,"Recorder")],[125,new Wu(Ru.Fx,"Recorder")],[126,new Wu(Ru.Fx,"Recorder")],[127,new Wu(Ru.Fx,"Timpani")]]);static tM=Iu.create("Drums","drumKit",5,[new Ou("Snare","snare","Master-Snare",[Gu.template("Snare (hit)",[38],"stick.hit.hit"),Gu.template("Snare (side stick)",[37],"stick.hit.sidestick"),Gu.template("Snare (rim shot)",[91],"stick.hit.rimshot")]),new Ou("Charley","hiHat","Master-Hihat",[Gu.template("Hi-Hat (closed)",[42],"stick.hit.closed"),Gu.template("Hi-Hat (half)",[92],"stick.hit.half"),Gu.template("Hi-Hat (open)",[46],"stick.hit.open"),Gu.template("Pedal Hi-Hat (hit)",[44],"pedal.hit.pedal")]),new Ou("Acoustic Kick Drum","kickDrum","AcousticKick-Percu",[Gu.template("Kick (hit)",[35],"pedal.hit.hit")]),new Ou("Kick Drum","kickDrum","Master-Kick",[Gu.template("Kick (hit)",[36],"pedal.hit.hit")]),new Ou("Tom Very High","tom","Master-Tom05",[Gu.template("High Floor Tom (hit)",[50],"stick.hit.hit")]),new Ou("Tom High","tom","Master-Tom04",[Gu.template("High Tom (hit)",[48],"stick.hit.hit")]),new Ou("Tom Medium","tom","Master-Tom03",[Gu.template("Mid Tom (hit)",[47],"stick.hit.hit")]),new Ou("Tom Low","tom","Master-Tom02",[Gu.template("Low Tom (hit)",[45],"stick.hit.hit")]),new Ou("Tom Very Low","tom","Master-Tom01",[Gu.template("Very Low Tom (hit)",[43],"stick.hit.hit")]),new Ou("Ride","ride","Master-Ride",[Gu.template("Ride (edge)",[93],"stick.hit.edge"),Gu.template("Ride (middle)",[51],"stick.hit.mid"),Gu.template("Ride (bell)",[53],"stick.hit.bell"),Gu.template("Ride (choke)",[94],"stick.hit.choke")]),new Ou("Splash","splash","Master-Splash",[Gu.template("Splash (hit)",[55],"stick.hit.hit"),Gu.template("Splash (choke)",[95],"stick.hit.choke")]),new Ou("China","china","Master-China",[Gu.template("China (hit)",[52],"stick.hit.hit"),Gu.template("China (choke)",[96],"stick.hit.choke")]),new Ou("Crash High","crash","Master-Crash02",[Gu.template("Crash high (hit)",[49],"stick.hit.hit"),Gu.template("Crash high (choke)",[97],"stick.hit.choke")]),new Ou("Crash Medium","crash","Master-Crash01",[Gu.template("Crash medium (hit)",[57],"stick.hit.hit"),Gu.template("Crash medium (choke)",[98],"stick.hit.choke")]),new Ou("Cowbell Low","cowbell","CowbellBig-Percu",[Gu.template("Cowbell low (hit)",[99],"stick.hit.hit"),Gu.template("Cowbell low (tip)",[100],"stick.hit.tip")]),new Ou("Cowbell Medium","cowbell","CowbellMid-Percu",[Gu.template("Cowbell medium (hit)",[56],"stick.hit.hit"),Gu.template("Cowbell medium (tip)",[101],"stick.hit.tip")]),new Ou("Cowbell High","cowbell","CowbellSmall-Percu",[Gu.template("Cowbell high (hit)",[102],"stick.hit.hit"),Gu.template("Cowbell high (tip)",[103],"stick.hit.tip")]),new Ou("Woodblock Low","woodblock","WoodblockLow-Percu",[Gu.template("Woodblock low (hit)",[77],"stick.hit.hit")]),new Ou("Woodblock High","woodblock","WoodblockHigh-Percu",[Gu.template("Woodblock high (hit)",[76],"stick.hit.hit")]),new Ou("Bongo High","bongo","BongoHigh-Percu",[Gu.template("Bongo High (hit)",[60],"hand.hit.hit"),Gu.template("Bongo High (mute)",[104],"hand.hit.mute"),Gu.template("Bongo High (slap)",[105],"hand.hit.slap")]),new Ou("Bongo Low","bongo","BongoLow-Percu",[Gu.template("Bongo Low (hit)",[61],"hand.hit.hit"),Gu.template("Bongo Low (mute)",[106],"hand.hit.mute"),Gu.template("Bongo Low (slap)",[107],"hand.hit.slap")]),new Ou("Timbale Low","timbale","TimbaleLow-Percu",[Gu.template("Timbale low (hit)",[66],"stick.hit.hit")]),new Ou("Timbale High","timbale","TimbaleHigh-Percu",[Gu.template("Timbale high (hit)",[65],"stick.hit.hit")]),new Ou("Agogo Low","agogo","AgogoLow-Percu",[Gu.template("Agogo low (hit)",[68],"stick.hit.hit")]),new Ou("Agogo High","agogo","AgogoHigh-Percu",[Gu.template("Agogo high (hit)",[67],"stick.hit.hit")]),new Ou("Conga Low","conga","CongaLow-Percu",[Gu.template("Conga low (hit)",[64],"hand.hit.hit"),Gu.template("Conga low (slap)",[108],"hand.hit.slap"),Gu.template("Conga low (mute)",[109],"hand.hit.mute")]),new Ou("Conga High","conga","CongaHigh-Percu",[Gu.template("Conga high (hit)",[63],"hand.hit.hit"),Gu.template("Conga high (slap)",[110],"hand.hit.slap"),Gu.template("Conga high (mute)",[62],"hand.hit.mute")]),new Ou("Whistle Low","whistle","WhistleLow-Percu",[Gu.template("Whistle low (hit)",[72],"blow.hit.hit")]),new Ou("Whistle High","whistle","WhistleHigh-Percu",[Gu.template("Whistle high (hit)",[71],"blow.hit.hit")]),new Ou("Guiro","guiro","Guiro-Percu",[Gu.template("Guiro (hit)",[73],"stick.hit.hit"),Gu.template("Guiro (scrap-return)",[74],"stick.scrape.return")]),new Ou("Surdo","surdo","Surdo-Percu",[Gu.template("Surdo (hit)",[86],"brush.hit.hit"),Gu.template("Surdo (mute)",[87],"brush.hit.mute")]),new Ou("Tambourine","tambourine","Tambourine-Percu",[Gu.template("Tambourine (hit)",[54],"hand.hit.hit"),Gu.template("Tambourine (return)",[111],"hand.hit.return"),Gu.template("Tambourine (roll)",[112],"hand.hit.roll"),Gu.template("Tambourine (hand)",[113],"hand.hit.handhit")]),new Ou("Cuica","cuica","Cuica-Percu",[Gu.template("Cuica (open)",[79],"hand.hit.hit"),Gu.template("Cuica (mute)",[78],"hand.hit.mute")]),new Ou("Vibraslap","vibraslap","Vibraslap-Percu",[Gu.template("Vibraslap (hit)",[58],"hand.hit.hit")]),new Ou("Triangle","triangle","Triangle-Percu",[Gu.template("Triangle (hit)",[81],"stick.hit.hit"),Gu.template("Triangle (mute)",[80],"stick.hit.mute")]),new Ou("Grancassa","grancassa","Grancassa-Percu",[Gu.template("Grancassa (hit)",[114],"mallet.hit.hit")]),new Ou("Piatti","piatti","Piatti-Percu",[Gu.template("Piatti (hit)",[115],"hand.hit.hit"),Gu.template("Piatti (hand)",[116],"hand.hit.hit")]),new Ou("Cabasa","cabasa","Cabasa-Percu",[Gu.template("Cabasa (hit)",[69],"hand.hit.hit"),Gu.template("Cabasa (return)",[117],"hand.hit.return")]),new Ou("Castanets","castanets","Castanets-Percu",[Gu.template("Castanets (hit)",[85],"hand.hit.hit")]),new Ou("Claves","claves","Claves-Percu",[Gu.template("Claves (hit)",[75],"stick.hit.hit")]),new Ou("Left Maraca","maraca","Maracas-Percu",[Gu.template("Left Maraca (hit)",[70],"hand.hit.hit"),Gu.template("Left Maraca (return)",[118],"hand.hit.return")]),new Ou("Right Maraca","maraca","Maracas-Percu",[Gu.template("Right Maraca (hit)",[119],"hand.hit.hit"),Gu.template("Right Maraca (return)",[120],"hand.hit.return")]),new Ou("Shaker","shaker","ShakerStudio-Percu",[Gu.template("Shaker (hit)",[82],"hand.hit.hit"),Gu.template("Shaker (return)",[122],"hand.hit.return")]),new Ou("Bell Tree","bellTree","BellTree-Percu",[Gu.template("Bell Tree (hit)",[84],"stick.hit.hit"),Gu.template("Bell Tree (return)",[123],"stick.hit.return")]),new Ou("Jingle Bell","jingleBell","JingleBell-Percu",[Gu.template("Jingle Bell (hit)",[83],"stick.hit.hit")]),new Ou("Tinkle Bell","jingleBell","JingleBell-Percu",[Gu.template("Tinkle Bell (hit)",[83],"stick.hit.hit")]),new Ou("Golpe","unpitched","Golpe-Percu",[Gu.template("Golpe (thumb)",[124],"thumb.hit.body"),Gu.template("Golpe (finger)",[125],"finger4.hit.body")]),new Ou("Hand Clap","handClap","GroupHandClap-Percu",[Gu.template("Hand Clap (hit)",[39],"hand.hit.hit")]),new Ou("Electric Snare","snare","ElectricSnare-Percu",[Gu.template("Electric Snare (hit)",[40],"stick.hit.hit")]),new Ou("Sticks","snare","Stick-Percu",[Gu.template("Snare (side stick)",[31],"stick.hit.sidestick")]),new Ou("Very Low Floor Tom","tom","LowFloorTom-Percu",[Gu.template("Low Floor Tom (hit)",[41],"stick.hit.hit")]),new Ou("Ride Cymbal 2","ride","Ride-Percu",[Gu.template("Ride (edge)",[59],"stick.hit.edge"),Gu.template("Ride (middle)",[126],"stick.hit.mid"),Gu.template("Ride (bell)",[127],"stick.hit.bell"),Gu.template("Ride (choke)",[29],"stick.hit.choke")]),new Ou("Reverse Cymbal","crash","Reverse-Cymbal",[Gu.template("Reverse Cymbal (hit)",[30],"stick.hit.hit")]),new Ou("Metronome","snare","Metronome-Percu",[Gu.template("Metronome (hit)",[33],"stick.hit.sidestick"),Gu.template("Metronome (bell)",[34],"stick.hit.hit")])]);static eM=void 0;static sM=void 0;static iM(){const t=Vu.tM,e=new Map,s=new Map;for(const i of t.elements)for(const t of i.articulations)for(const n of t.inputMidiNumbers){const r=`${i.name}.${n}`;e.set(r,i),s.set(r,t)}return Vu.eM=e,Vu.sM=s,e}static getIconId(t){return 9===t.primaryChannel?Ru.PercussionKit:Vu.Zx.has(t.program)?Vu.Zx.get(t.program).icon:Ru.SteelGuitar}static buildInstrumentSet(t){return t.percussionArticulations.length>0||t.isPercussion?Vu.nM(t):Vu.rM(t)}static aM=new Ou("Pitched","pitched","",[new Gu("",0,[ut.NoteheadBlack,ut.NoteheadHalf,ut.NoteheadWhole],ut.None,dt.Outside,[],0,"")]);static rM(t){const e=new Iu;e.lineCount=t.staves[0].standardNotationLineCount;const s=Vu.Zx.has(t.playbackInfo.program)?Vu.Zx.get(t.playbackInfo.program):Vu.Zx.get(0);e.name=s.instrumentSetName,e.type=s.instrumentSetType;const i=new Ou(Vu.aM.name,Vu.aM.type,Vu.aM.soundbankName,[Vu.aM.articulations[0]]);return e.elements.push(i),e}static nM(t){Vu.eM||Vu.iM();const e=new Iu;e.lineCount=t.staves[0].standardNotationLineCount,e.name="Drums",e.type="drumKit";const s=t.percussionArticulations.length>0?t.percussionArticulations:Array.from(qt.instrumentArticulations.values());let i;for(const t of s){const s=new Gu(t.elementType,t.staffLine,[t.noteHeadDefault,t.noteHeadHalf,t.noteHeadWhole],t.techniqueSymbol,t.techniqueSymbolPlacement,[t.id],t.outputMidiNumber,""),n=t.uniqueId;if(Vu.sM.has(n)){const t=Vu.sM.get(n);s.inputMidiNumbers=t.inputMidiNumbers,s.name=t.name,s.outputRSESound=t.outputRSESound}if(Vu.eM.has(n)){const s=Vu.eM.get(n);i&&i.name===t.elementType||(i=new Ou(s.name,s.type,s.soundbankName,[]),e.elements.push(i))}else i&&i.name===t.elementType||(i=new Ou(t.elementType,t.elementType,"",[]),e.elements.push(i));i.articulations.push(s)}return e}}class $u{static ua=44100;hM=new Map;writeXml(t){const e=new Ms;return this.hM=new Map,this.oM(e,t),e.toFormattedString("",!0)}oM(t,e){const s=t.addElement("GPIF");s.addElement("GPVersion").innerText="8.1.3";const i=s.addElement("GPRevision");i.attributes.set("required","12024"),i.attributes.set("recommended","13000"),i.innerText="13007";const n=s.addElement("Encoding");n.addElement("EncodingDescription").innerText="GP8";const r=new Bs;r.nodeType=He.Comment,r.value=`Written by alphaTab ${V.version} (${V.commit})`,n.addChild(r),this.cM(s,e),this.lM(s,e),this.uM(s,e),this.dM(s,e),this.fM(s,e),this.pM(s,e),this.bM(s,e);const a=s.addElement("Bars"),h=s.addElement("Voices"),o=s.addElement("Beats"),c=s.addElement("Notes"),l=s.addElement("Rhythms");for(const t of e.tracks)for(const e of t.staves)for(const t of e.bars){this.mM(a,t);for(const e of t.voices){this.gM(h,e);for(const t of e.beats){this.wM(o,t,l);for(const e of t.notes)this.yM(c,e)}}}}bM(t,e){if(!e.backingTrack?.rawAudioFile)return;const s=t.addElement("Assets").addElement("Asset");s.attributes.set("id",this.da),this.backingTrackAssetFileName="Content/Assets/backing-track",s.addElement("EmbeddedFilePath").setCData(this.backingTrackAssetFileName)}da;kM;backingTrackAssetFileName;uM(t,e){if(!e.backingTrack?.rawAudioFile)return;const s=t.addElement("BackingTrack");this.da="0",s.addElement("IconId").innerText="21",s.addElement("Color").innerText="0 0 0",s.addElement("Name").setCData("Audio Track"),s.addElement("ShortName").setCData("a.track"),s.addElement("PlaybackState").innerText="Default",s.addElement("Enabled").innerText="true",s.addElement("Source").innerText="Local",s.addElement("AssetId").innerText="0";const i=s.addElement("ChannelStrip");i.addElement("Parameters").innerText="0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.000000 0.500000 0.500000 0.800000 0.500000 0.500000 0.500000",i.addElement("YouTubeVideoUrl").innerText="",i.addElement("Filter").innerText="6",i.addElement("FramesPerPixel").innerText="400";const n=void 0!==this.kM?this.kM:0;s.addElement("FramePadding").innerText=`${n}`,s.addElement("Semitones").innerText="0",s.addElement("Cents").innerText="0"}yM(t,e){const s=t.addElement("Note");s.attributes.set("id",e.id.toString()),this.SM(s,e),e.isGhost&&(s.addElement("AntiAccent").innerText="normal"),e.isLetRing&&s.addElement("LetRing"),e.isTrill&&(s.addElement("Trill").innerText=e.trillValue.toString());let i=0;switch(e.isStaccato&&(i|=1),e.accentuated){case d.Normal:i|=8;break;case d.Heavy:i|=4;break;case d.Tenuto:i|=16}if(i>0&&(s.addElement("Accent").innerText=i.toString()),e.isTieOrigin||e.isTieDestination){const t=s.addElement("Tie");t.attributes.set("origin",e.isTieOrigin?"true":"false"),t.attributes.set("destination",e.isTieDestination?"true":"false")}switch(e.vibrato){case y.Slight:s.addElement("Vibrato").innerText="Slight";break;case y.Wide:s.addElement("Vibrato").innerText="Wide"}if(e.isFingering){switch(e.leftHandFinger){case f.Thumb:s.addElement("LeftFingering").innerText="P";break;case f.IndexFinger:s.addElement("LeftFingering").innerText="I";break;case f.MiddleFinger:s.addElement("LeftFingering").innerText="M";break;case f.AnnularFinger:s.addElement("LeftFingering").innerText="A";break;case f.LittleFinger:s.addElement("LeftFingering").innerText="C"}switch(e.rightHandFinger){case f.Thumb:s.addElement("RightFingering").innerText="P";break;case f.IndexFinger:s.addElement("RightFingering").innerText="I";break;case f.MiddleFinger:s.addElement("RightFingering").innerText="M";break;case f.AnnularFinger:s.addElement("RightFingering").innerText="A";break;case f.LittleFinger:s.addElement("RightFingering").innerText="C"}}e.percussionArticulation>=0?s.addElement("InstrumentArticulation").innerText=e.percussionArticulation.toString():s.addElement("InstrumentArticulation").innerText="0",e.ornament!==ft.None&&(s.addElement("Ornament").innerText=ft[e.ornament])}SM(t,e){const s=t.addElement("Properties");if(this.BM(s,e),this._M(s,e),e.isStringed&&(this.TM(s,"String","String",(e.string-1).toString()),this.TM(s,"Fret","Fret",e.fret.toString()),this.TM(s,"Midi","Number",e.realValue.toString()),e.showStringNumber&&this.TM(s,"ShowStringNumber","Enable",null)),e.isPiano&&(this.TM(s,"Octave","Number",e.octave.toString()),this.TM(s,"Tone","Step",e.tone.toString()),this.TM(s,"Midi","Number",e.realValue.toString())),e.beat.tap&&this.TM(s,"Tapped","Enable",null),e.harmonicType!==p.None){switch(e.harmonicType){case p.Natural:this.TM(s,"HarmonicType","HType","Natural");break;case p.Artificial:this.TM(s,"HarmonicType","HType","Artificial");break;case p.Pinch:this.TM(s,"HarmonicType","HType","Pinch");break;case p.Tap:this.TM(s,"HarmonicType","HType","Tap");break;case p.Semi:this.TM(s,"HarmonicType","HType","Semi");break;case p.Feedback:this.TM(s,"HarmonicType","HType","Feedback")}0!==e.harmonicValue&&this.TM(s,"HarmonicFret","HFret",e.harmonicValue.toString())}e.isDead&&this.TM(s,"Muted","Enable",null),e.isPalmMute&&this.TM(s,"PalmMuted","Enable",null),e.hasBend&&this.xM(s,e),e.isHammerPullOrigin&&this.TM(s,"HopoOrigin","Enable",null),e.isHammerPullDestination&&this.TM(s,"HopoDestination","Enable",null),e.isLeftHandTapped&&this.TM(s,"LeftHandTapped","Enable",null);let i=0;switch(e.slideInType){case g.IntoFromAbove:i|=32;break;case g.IntoFromBelow:i|=16}switch(e.slideOutType){case w.Shift:i|=1;break;case w.Legato:i|=2;break;case w.OutDown:i|=4;break;case w.OutUp:i|=8;break;case w.PickSlideDown:i|=64;break;case w.PickSlideUp:i|=128}i>0&&this.TM(s,"Slide","Flags",i.toString())}_M(t,e){e.isPercussion?this.MM(t,"ConcertPitch","C","-1",""):this.vM(t,"TransposedPitch",e.displayValueWithoutBend,e.accidentalMode,e.beat.voice.bar.keySignature)}BM(t,e){e.isPercussion?this.MM(t,"ConcertPitch","C","-1",""):this.vM(t,"ConcertPitch",e.realValueWithoutHarmonic,e.accidentalMode,e.beat.voice.bar.keySignature)}static NM=["C","C","D","D","E","F","F","G","G","A","A","B"];vM(t,e,s,i,n){let r=0,a=0,h="",o="";const c=()=>{switch(r=s%12,a=s/12|0,h=$u.NM[r],Xt.computeAccidental(n,b.Default,s,!1)){case x.None:case x.Natural:o="";break;case x.Sharp:o="#";break;case x.Flat:o="b";break;case x.DoubleSharp:o="x";break;case x.DoubleFlat:o="bb"}};switch(c(),i){case b.Default:break;case b.ForceNone:case b.ForceNatural:o="";break;case b.ForceSharp:o="#";break;case b.ForceDoubleSharp:"#"===o&&(s-=2,c()),o="x";break;case b.ForceFlat:"#"===o&&(s+=1,c()),o="b";break;case b.ForceDoubleFlat:"#"===o&&(s+=2,c()),o="bb"}this.MM(t,e,h,a.toString(),o)}MM(t,e,s,i,n){const r=t.addElement("Property");r.attributes.set("name",e);const a=r.addElement("Pitch");a.addElement("Step").innerText=s,a.addElement("Accidental").innerText=n,a.addElement("Octave").innerText=i}xM(t,e){e.hasBend&&e.bendPoints.length<=4&&this.PM(t,e.bendPoints)}PM(t,e){this.TM(t,"Bended","Enable",null);const s=e[0],i=e[e.length-1];let n,r;switch(e.length){case 4:n=e[1],r=e[2];break;case 3:n=e[1],r=e[1];break;default:n=new z((s.offset+i.offset)/2,(s.value+i.value)/2),r=n}this.TM(t,"BendDestinationOffset","Float",this.$h(i.offset).toString()),this.TM(t,"BendDestinationValue","Float",this.Vh(i.value).toString()),this.TM(t,"BendMiddleOffset1","Float",this.$h(n.offset).toString()),this.TM(t,"BendMiddleOffset2","Float",this.$h(r.offset).toString()),this.TM(t,"BendMiddleValue","Float",this.Vh(n.value).toString()),this.TM(t,"BendOriginOffset","Float",this.$h(s.offset).toString()),this.TM(t,"BendOriginValue","Float",this.Vh(s.value).toString())}Vh(t){return 25*t}$h(t){return t/z.MaxPosition*100}wM(t,e,s){const i=t.addElement("Beat");if(i.attributes.set("id",e.id.toString()),i.addElement("Dynamic").innerText=n[e.dynamics],e.fade!==gt.None&&(i.addElement("Fadding").innerText=gt[e.fade]),e.isTremolo)switch(e.tremoloPicking.marks){case 1:i.addElement("Tremolo").innerText="1/2";break;case 2:i.addElement("Tremolo").innerText="1/4";break;case 3:i.addElement("Tremolo").innerText="1/8"}switch(e.hasChord&&i.addElement("Chord").setCData(e.chordId),e.crescendo!==c.None&&(i.addElement("Hairpin").innerText=c[e.crescendo]),e.brushType){case o.ArpeggioUp:i.addElement("Arpeggio").innerText="Up";break;case o.ArpeggioDown:i.addElement("Arpeggio").innerText="Down"}switch(e.text&&i.addElement("FreeText").setCData(e.text),e.graceType){case u.OnBeat:case u.BeforeBeat:i.addElement("GraceNotes").innerText=u[e.graceType]}if(e.ottava!==m.Regular&&(i.addElement("Ottavia").innerText=m[e.ottava].substr(1)),e.hasWhammyBar&&this.CM(i,e),e.isLegatoOrigin||e.isLegatoDestination){const t=i.addElement("Legato");t.attributes.set("origin",e.isLegatoOrigin?"true":"false"),t.attributes.set("destination",e.isLegatoDestination?"true":"false")}if(this.EM(i,e,s),null!==e.preferredBeamDirection)switch(e.preferredBeamDirection){case Rt.Up:i.addElement("TransposedPitchStemOrientation").innerText="Upward",i.addElement("UserTransposedPitchStemOrientation").innerText="Upward";break;case Rt.Down:i.addElement("TransposedPitchStemOrientation").innerText="Downward",i.addElement("UserTransposedPitchStemOrientation").innerText="Downward"}i.addElement("ConcertPitchStemOrientation").innerText="Undefined",e.slashed&&i.addElement("Slashed"),e.deadSlapped&&i.addElement("DeadSlapped"),e.notes.length>0&&(i.addElement("Notes").innerText=e.notes.map(t=>t.id).join(" ")),e.golpe!==mt.None&&(i.addElement("Golpe").innerText=mt[e.golpe]),e.wahPedal!==wt.None&&(i.addElement("Wah").innerText=wt[e.wahPedal]),e.showTimer&&(i.addElement("Timer").innerText=(e.timer??0).toString()),this.FM(i,e),this.AM(i,e),e.lyrics&&e.lyrics.length>0&&this.DM(i,e.lyrics)}DM(t,e){const s=t.addElement("Lyrics");for(const t of e){s.addElement("Line").setCData(t)}}AM(t,e){const s=t.addElement("XProperties");switch(e.brushDuration>0&&this.LM(s,"687935489","Int",e.brushDuration.toString()),e.beamingMode){case Bt.ForceSplitToNext:this.LM(s,"1124204546","Int","2");break;case Bt.ForceMergeWithNext:this.LM(s,"1124204546","Int","1");break;case Bt.ForceSplitOnSecondaryToNext:this.LM(s,"1124204552","Int","1")}}FM(t,e){const s=t.addElement("Properties");switch(e.brushType){case o.BrushUp:this.TM(s,"Brush","Direction","Up");break;case o.BrushDown:this.TM(s,"Brush","Direction","Down")}switch(e.pickStroke){case lt.Up:this.TM(s,"PickStroke","Direction","Up");break;case lt.Down:this.TM(s,"PickStroke","Direction","Down")}switch(e.slap&&this.TM(s,"Slapped","Enable",null),e.pop&&this.TM(s,"Popped","Enable",null),e.vibrato){case y.Wide:this.TM(s,"VibratoWTremBar","Strength","Wide");break;case y.Slight:this.TM(s,"VibratoWTremBar","Strength","Slight")}if(e.isBarre)switch(this.TM(s,"BarreFret","Fret",e.barreFret.toString()),e.barreShape){case yt.Full:this.TM(s,"BarreString","String","0");break;case yt.Half:this.TM(s,"BarreString","String","1")}if(e.rasgueado!==kt.None){let t="";switch(e.rasgueado){case kt.Ii:t="ii_1";break;case kt.Mi:t="mi_1";break;case kt.MiiTriplet:t="mii_1";break;case kt.MiiAnapaest:t="mii_2";break;case kt.PmpTriplet:t="pmp_1";break;case kt.PmpAnapaest:t="pmp_2";break;case kt.PeiTriplet:t="pei_1";break;case kt.PeiAnapaest:t="pei_2";break;case kt.PaiTriplet:t="pai_1";break;case kt.PaiAnapaest:t="pai_2";break;case kt.AmiTriplet:t="ami_1";break;case kt.AmiAnapaest:t="ami_2";break;case kt.Ppp:t="ppp_1";break;case kt.Amii:t="amii_1";break;case kt.Amip:t="amip_1";break;case kt.Eami:t="eami_1";break;case kt.Eamii:t="eamii_1";break;case kt.Peami:t="peami_1"}this.TM(s,"Rasgueado","Rasgueado",t)}}EM(t,e,s){const i=`${e.duration}_${e.dots}_${e.tupletNumerator}_${e.tupletDenominator}';`;let n;if(this.hM.has(i))n=this.hM.get(i);else{n=this.hM.size.toString(),this.hM.set(i,n);const t=s.addElement("Rhythm");if(t.attributes.set("id",n),e.hasTuplet){const s=t.addElement("PrimaryTuplet");s.attributes.set("num",e.tupletNumerator.toString()),s.attributes.set("den",e.tupletDenominator.toString())}e.dots>0&&t.addElement("AugmentationDot").attributes.set("count",e.dots.toString());let r="Quarter";switch(e.duration){case l.QuadrupleWhole:r="Long";break;case l.DoubleWhole:r="DoubleWhole";break;case l.Whole:r="Whole";break;case l.Half:r="Half";break;case l.Quarter:r="Quarter";break;case l.Eighth:r="Eighth";break;case l.Sixteenth:r="16th";break;case l.ThirtySecond:r="32nd";break;case l.SixtyFourth:r="64th";break;case l.OneHundredTwentyEighth:r="128th";break;case l.TwoHundredFiftySixth:r="256th"}t.addElement("NoteValue").innerText=r}t.addElement("Rhythm").attributes.set("ref",n)}CM(t,e){e.hasWhammyBar&&e.whammyBarPoints.length<=4&&this.WM(t,e.whammyBarPoints)}WM(t,e){const s=t.addElement("Whammy"),i=e[0],n=e[e.length-1];let r,a;switch(e.length){case 4:r=e[1],a=e[2];break;case 3:r=e[1],a=e[1];break;default:r=new z((i.offset+n.offset)/2,(i.value+n.value)/2),a=r}s.attributes.set("destinationOffset",this.$h(n.offset).toString()),s.attributes.set("destinationValue",this.Vh(n.value).toString()),s.attributes.set("middleOffset1",this.$h(r.offset).toString()),s.attributes.set("middleOffset2",this.$h(a.offset).toString()),s.attributes.set("middleValue",this.Vh(r.value).toString()),s.attributes.set("originOffset",this.$h(i.offset).toString()),s.attributes.set("originValue",this.Vh(i.value).toString())}cM(t,e){const s=t.addElement("Score");s.addElement("Title").setCData(e.title),s.addElement("SubTitle").setCData(e.subTitle),s.addElement("Artist").setCData(e.artist),s.addElement("Album").setCData(e.album),s.addElement("Words").setCData(e.words),s.addElement("Music").setCData(e.music),s.addElement("WordsAndMusic").setCData(e.words===e.music?e.words:""),s.addElement("Copyright").setCData(e.copyright),s.addElement("Tabber").setCData(e.tab),s.addElement("Instructions").setCData(e.instructions),s.addElement("Notices").setCData(e.notices),s.addElement("FirstPageHeader").setCData(""),s.addElement("FirstPageFooter").setCData(""),s.addElement("PageHeader").setCData(""),s.addElement("PageFooter").setCData(""),s.addElement("ScoreSystemsDefaultLayout").setCData(e.defaultSystemsLayout.toString()),s.addElement("ScoreSystemsLayout").setCData(e.systemsLayout.join(" ")),s.addElement("ScoreZoomPolicy").innerText="Value",s.addElement("ScoreZoom").innerText="1",s.addElement("MultiVoice").innerText="1>"}lM(t,e){const s=t.addElement("MasterTrack");s.addElement("Tracks").innerText=e.tracks.map(t=>t.index).join(" ");const i=s.addElement("Automations");if(e.masterBars.length>0&&e.masterBars[0].isAnacrusis&&s.addElement("Anacrusis"),0===e.masterBars[0].tempoAutomations.length){const t=i.addElement("Automation");t.addElement("Type").innerText="Tempo",t.addElement("Linear").innerText="false",t.addElement("Bar").innerText="0",t.addElement("Position").innerText="0",t.addElement("Visible").innerText="true",t.addElement("Value").innerText=`${e.tempo} 2`,e.tempoLabel&&(t.addElement("Text").innerText=e.tempoLabel)}const n=e.masterBars[0].syncPoints?e.masterBars[0].syncPoints.find(t=>0===t.ratioPosition&&0===t.syncPointValue.barOccurence):void 0,r=n?n.syncPointValue.millisecondOffset:0;this.kM=r/1e3*$u.ua*-1|0;const a=new j(()=>La.buildModifiedTempoLookup(e));for(const t of e.masterBars){for(const e of t.tempoAutomations){const s=i.addElement("Automation");s.addElement("Type").innerText="Tempo",s.addElement("Linear").innerText=e.isLinear?"true":"false",s.addElement("Bar").innerText=t.index.toString(),s.addElement("Position").innerText=e.ratioPosition.toString(),s.addElement("Visible").innerText=e.isVisible?"true":"false",s.addElement("Value").innerText=`${e.value} 2`,e.text&&(s.addElement("Text").innerText=e.text)}if(t.syncPoints)for(const s of t.syncPoints){const n=i.addElement("Automation");n.addElement("Type").innerText="SyncPoint",n.addElement("Linear").innerText="false",n.addElement("Bar").innerText=t.index.toString(),n.addElement("Position").innerText=s.ratioPosition.toString(),n.addElement("Visible").innerText=s.isVisible?"true":"false";const h=n.addElement("Value");h.addElement("BarIndex").innerText=t.index.toString(),h.addElement("BarOccurrence").innerText=s.syncPointValue.barOccurence.toString(),h.addElement("ModifiedTempo").innerText=a.value.get(s).syncBpm.toString(),h.addElement("OriginalTempo").innerText=e.tempo.toString();let o=(s.syncPointValue.millisecondOffset-r)/1e3*$u.ua;o=Math.floor(o+.5),h.addElement("FrameOffset").innerText=o.toString()}}}dM(t,e){t.addElement("AudioTracks")}fM(t,e){const s=t.addElement("Tracks");for(const t of e.tracks)this.RM(s,t)}RM(t,e){const s=t.addElement("Track");s.attributes.set("id",e.index.toString()),s.addElement("Name").setCData(e.name),s.addElement("ShortName").setCData(e.shortName),s.addElement("Color").innerText=`${e.color.r} ${e.color.g} ${e.color.b}`,s.addElement("SystemsDefautLayout").innerText=e.defaultSystemsLayout.toString(),s.addElement("SystemsLayout").innerText=e.systemsLayout.join(" "),s.addElement("AutoBrush"),s.addElement("PalmMute").innerText="0",s.addElement("PlayingStyle").innerText=we.isGuitar(e.playbackInfo.program)?"StringedPick":"Default",s.addElement("UseOneChannelPerString"),s.addElement("IconId").innerText=Vu.getIconId(e.playbackInfo).toString(),this.IM(s,e),this.OM(s,e),this.GM(s,e),s.addElement("ForcedSound").innerText="-1",this.VM(s,e),e.playbackInfo.isSolo?s.addElement("PlaybackState").innerText="Solo":e.playbackInfo.isMute?s.addElement("PlaybackState").innerText="Mute":s.addElement("PlaybackState").innerText="Default",s.addElement("AudioEngineState").innerText="MIDI",this.$M(s,e),this.HM(s,e),this.UM(s,e)}zM(t,e,s,i,n,r,a,h,o=0){const c=t.addElement("Sound");c.addElement("Name").setCData(s),c.addElement("Label").setCData(s),c.addElement("Path").setCData(i),c.addElement("Role").setCData(n);const l=c.addElement("MIDI"),u=we.bankToLsbMsb(h);l.addElement("LSB").innerText=u[0].toString(),l.addElement("MSB").innerText=u[1].toString(),l.addElement("Program").innerText=a.toString();const d=e.addElement("Automation");d.addElement("Type").innerText="Sound",d.addElement("Linear").innerText="false",d.addElement("Bar").innerText=r.toString(),d.addElement("Position").innerText=o.toString(),d.addElement("Visible").innerText="true",d.addElement("Value").setCData(`${i};${s};${n}`)}UM(t,e){const s=t.addElement("Sounds"),i=t.addElement("Automations");if(e.staves.length>0&&e.staves[0].bars.length>0){const t=`Track_${e.index}_Initial`,n=`Midi/${e.playbackInfo.program}`,a="Factory";let h=!1,o=e.playbackInfo.bank;for(const c of e.staves)for(const l of c.bars)for(const c of l.voices)for(const u of c.beats){const c=u.getAutomation(r.Instrument),d=0===l.index&&0===u.index,f=u.getAutomation(r.Bank);if(f&&(o=f.value),c){const r=d?t:`ProgramChange_${u.id}`,f=d?n:`Midi/${c.value}`,p=d?a:"User";d||h||(this.zM(s,i,t,n,a,e.staves[0].bars[0].index,e.playbackInfo.program,e.playbackInfo.bank),h=!0),this.zM(s,i,r,f,p,l.index,c.value,o,c.ratioPosition),d&&(h=!0)}}}for(const t of e.staves)for(const e of t.bars)for(const t of e.sustainPedals)if(t.pedalType!==C.Hold){const s=i.addElement("Automation");switch(s.addElement("Type").innerText="SustainPedal",s.addElement("Linear").innerText="false",s.addElement("Bar").innerText=e.index.toString(),s.addElement("Position").innerText=t.ratioPosition.toString(),s.addElement("Visible").innerText="true",t.pedalType){case C.Down:s.addElement("Value").innerText="0 1";break;case C.Up:s.addElement("Value").innerText="0 3"}}}VM(t,e){const s=t.addElement("MidiConnection");s.addElement("Port").innerText=e.playbackInfo.port.toString(),s.addElement("PrimaryChannel").innerText=e.playbackInfo.primaryChannel.toString(),s.addElement("SecondaryChannel").innerText=e.playbackInfo.secondaryChannel.toString(),s.addElement("ForeOneChannelPerString").innerText="false"}GM(t,e){const s=t.addElement("RSE").addElement("ChannelStrip");s.attributes.set("version","E56");s.addElement("Parameters").innerText=`0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 1 0.5 ${e.playbackInfo.balance/16} ${e.playbackInfo.volume/16} 0.5 0.5 0.5`}HM(t,e){const s=t.addElement("Staves");for(const t of e.staves)this.XM(s,t)}XM(t,e){const s=t.addElement("Staff").addElement("Properties");if(this.TM(s,"CapoFret","Fret",e.capo.toString()),this.TM(s,"FretCount","Fret","24"),e.tuning.length>0){const t=s.addElement("Property");switch(t.attributes.set("name","Tuning"),t.addElement("Pitches").innerText=e.tuning.slice().reverse().join(" "),t.addElement("Label").setCData(e.tuningName),t.addElement("LabelVisible").innerText=e.tuningName?"true":"false",t.addElement("Flat"),e.tuning.length){case 3:t.addElement("Instrument").innerText="Shamisen";break;case 4:105===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Banjo":42===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Cello":43===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Contrabass":40===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Violin":41===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Viola":t.addElement("Instrument").innerText="Bass";break;case 5:105===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Banjo":t.addElement("Instrument").innerText="Bass";break;case 6:105===e.track.playbackInfo.program?t.addElement("Instrument").innerText="Banjo":e.track.playbackInfo.program<=39?t.addElement("Instrument").innerText="Bass":t.addElement("Instrument").innerText="Guitar";break;case 7:e.track.playbackInfo.program<=39?t.addElement("Instrument").innerText="Bass":t.addElement("Instrument").innerText="Guitar";break;default:t.addElement("Instrument").innerText="Guitar"}}this.TM(s,"PartialCapoFret","Fret","0"),this.TM(s,"PartialCapoStringFlags","Bitset",e.tuning.map(t=>"0").join("")),this.TM(s,"TuningFlat","Enable",null),this.jM(s,e,"DiagramCollection"),this.jM(s,e,"DiagramWorkingSet")}jM(t,e,s){const i=t.addElement("Property");i.attributes.set("name",s);const n=i.addElement("Items"),r=e.chords;if(r)for(const[t,e]of r){const s=n.addElement("Item");s.attributes.set("id",t),s.attributes.set("name",e.name);const i=s.addElement("Diagram");i.attributes.set("stringCount",e.strings.length.toString()),i.attributes.set("fretCount","5"),i.attributes.set("baseFret",(e.firstFret-1).toString()),i.attributes.set("barStates",e.strings.map(t=>"1").join(" "));const r=[],a=new Map;for(let t=0;t<e.strings.length;t++){const s=e.strings[t];if(-1!==s){const n=i.addElement("Fret"),h=e.strings.length-1-t;n.attributes.set("string",h.toString()),n.attributes.set("fret",(s-e.firstFret+1).toString()),a.has(s)||(a.set(s,[]),r.push(s)),a.get(s).push(h)}}r.sort();const h=i.addElement("Fingering");if(e.barreFrets.length>0){const t=[f.LittleFinger,f.AnnularFinger,f.MiddleFinger,f.IndexFinger];for(const s of r){const i=a.get(s);if(i.length>1&&e.barreFrets.indexOf(s)>=0){const n=t.length>0?t.pop():f.IndexFinger;for(const t of i){const i=h.addElement("Position");switch(n){case f.LittleFinger:i.attributes.set("finger","Pinky");break;case f.AnnularFinger:i.attributes.set("finger","Ring");break;case f.MiddleFinger:i.attributes.set("finger","Middle");break;case f.IndexFinger:i.attributes.set("finger","Index")}i.attributes.set("fret",(s-e.firstFret+1).toString()),i.attributes.set("string",t.toString())}}}}const o=i.addElement("Property");o.attributes.set("name","ShowName"),o.attributes.set("type","bool"),o.attributes.set("value",e.showName?"true":"false");const c=i.addElement("Property");c.attributes.set("name","ShowDiagram"),c.attributes.set("type","bool"),c.attributes.set("value",e.showDiagram?"true":"false");const l=i.addElement("Property");l.attributes.set("name","ShowFingering"),l.attributes.set("type","bool"),l.attributes.set("value",e.showFingering?"true":"false");const u=i.addElement("Chord"),d=u.addElement("KeyNote");d.attributes.set("step","C"),d.attributes.set("accidental","Natural");const p=u.addElement("BassNote");p.attributes.set("step","C"),p.attributes.set("accidental","Natural");const b=u.addElement("Degree");b.attributes.set("interval","Third"),b.attributes.set("alteration","Major"),b.attributes.set("omitted","false");const m=u.addElement("Degree");m.attributes.set("interval","Fifth"),m.attributes.set("alteration","Perfect"),m.attributes.set("omitted","false")}}TM(t,e,s,i){const n=t.addElement("Property");n.attributes.set("name",e);const r=n.addElement(s);return null!==i&&(r.innerText=i),n}LM(t,e,s,i){const n=t.addElement("XProperty");n.attributes.set("id",e);const r=n.addElement(s);return null!==i&&(r.innerText=i),n}$M(t,e){const s=t.addElement("Lyrics");s.attributes.set("dispatched","true");const i=[];for(const t of e.staves[0].bars)for(const e of t.voices)if(!e.isEmpty)for(const s of e.beats)if(s.lyrics)for(let e=0;e<s.lyrics.length;e++){for(;e>=i.length;){const e=new _e;e.startBar=t.index,e.text="[Empty]",i.push(e)}const n=i[e];n.text="[Empty]"===n.text?s.lyrics[e]:`${n.text} ${s.lyrics[e].split(" ").join("+")}`}for(let t=0;t<i.length;t++){const e=s.addElement("Line");e.addElement("Text").setCData(i[t].text),e.addElement("Offset").innerText=i[t].startBar.toString()}}OM(t,e){const s=t.addElement("Transpose"),i=Math.floor(e.staves[0].displayTranspositionPitch/12),n=e.staves[0].displayTranspositionPitch-12*i;s.addElement("Chromatic").innerText=n.toString(),s.addElement("Octave").innerText=i.toString()}IM(t,e){const s=Vu.buildInstrumentSet(e),i=t.addElement("InstrumentSet");i.addElement("Name").innerText=s.name,i.addElement("Type").innerText=s.type,i.addElement("LineCount").innerText=s.lineCount.toString();const n=i.addElement("Elements");for(const t of s.elements){const e=n.addElement("Element");e.addElement("Name").innerText=t.name,e.addElement("Type").innerText=t.type,e.addElement("SoundbankName").innerText=t.soundbankName;const s=e.addElement("Articulations");for(const e of t.articulations){const t=s.addElement("Articulation");switch(t.addElement("Name").innerText=e.name,t.addElement("StaffLine").innerText=e.staffLine.toString(),t.addElement("Noteheads").innerText=[this.JM(e.noteHeads[0]),this.JM(e.noteHeads[1]),this.JM(e.noteHeads[2])].join(" "),e.techniqueSymbolPlacement){case dt.Below:t.addElement("TechniquePlacement").innerText="below";break;case dt.Outside:t.addElement("TechniquePlacement").innerText="outside";break;case dt.Inside:t.addElement("TechniquePlacement").innerText="inside";break;case dt.Above:t.addElement("TechniquePlacement").innerText="above"}t.addElement("TechniqueSymbol").innerText=this.JM(e.techniqueSymbol),t.addElement("InputMidiNumbers").innerText=e.inputMidiNumbers.map(t=>t.toString()).join(" "),t.addElement("OutputRSESound").innerText=e.outputRSESound,t.addElement("OutputMidiNumber").innerText=e.outputMidiNumber.toString()}}}JM(t){if(t===ut.None)return"";const e=ut[t];return e.substring(0,1).toLowerCase()+e.substring(1)}pM(t,e){const s=t.addElement("MasterBars");for(const t of e.masterBars)this.qM(s,t)}qM(t,e){const s=t.addElement("MasterBar"),i=s.addElement("Key");let n=e.score.tracks[0].staves[0].bars[e.index].keySignature;const r=e.score.tracks[0].staves[0].bars[e.index].keySignatureType,a=Xt.flooredDivision(e.score.tracks[0].staves[0].displayTranspositionPitch,12);n=Xt.transposeKey(n,-a),i.addElement("AccidentalCount").innerText=n.toString(),i.addElement("Mode").innerText=P[r],i.addElement("Sharps").innerText="Sharps",s.addElement("Time").innerText=`${e.timeSignatureNumerator}/${e.timeSignatureDenominator}`,e.actualBeamingRules&&this.YM(s,e),e.isFreeTime&&s.addElement("FreeTime");const h=[];for(const t of e.score.tracks)for(const s of t.staves)h.push(s.bars[e.index].id.toString());if(s.addElement("Bars").innerText=h.join(" "),e.isDoubleBar&&s.addElement("DoubleBar"),e.isSectionStart){const t=s.addElement("Section");t.addElement("Letter").setCData(e.section.marker),t.addElement("Text").setCData(e.section.text)}if(e.isRepeatStart||e.isRepeatEnd){const t=s.addElement("Repeat");t.attributes.set("start",e.isRepeatStart?"true":"false"),t.attributes.set("end",e.isRepeatEnd?"true":"false"),e.isRepeatEnd&&t.attributes.set("count",e.repeatCount.toString())}if(e.alternateEndings>0){let t=e.alternateEndings;const i=[];let n=0;for(;t>0;)1==(t>>n&1)&&(i.push(n+1),t&=~(1<<n)),n++;s.addElement("AlternateEndings").innerText=i.join(" ")}if(e.tripletFeel!==A.NoTripletFeel&&(s.addElement("TripletFeel").innerText=A[e.tripletFeel]),e.directions&&e.directions.size>0){const t=s.addElement("Directions");for(const s of e.directions)switch(s){case Xe.TargetFine:t.addElement("Target").innerText="Fine";break;case Xe.TargetSegno:t.addElement("Target").innerText="Segno";break;case Xe.TargetSegnoSegno:t.addElement("Target").innerText="SegnoSegno";break;case Xe.TargetCoda:t.addElement("Target").innerText="Coda";break;case Xe.TargetDoubleCoda:t.addElement("Target").innerText="DoubleCoda";break;case Xe.JumpDaCapo:t.addElement("Jump").innerText="DaCapo";break;case Xe.JumpDaCapoAlCoda:t.addElement("Jump").innerText="DaCapoAlCoda";break;case Xe.JumpDaCapoAlDoubleCoda:t.addElement("Jump").innerText="DaCapoAlDoubleCoda";break;case Xe.JumpDaCapoAlFine:t.addElement("Jump").innerText="DaCapoAlFine";break;case Xe.JumpDalSegno:t.addElement("Jump").innerText="DaSegno";break;case Xe.JumpDalSegnoAlCoda:t.addElement("Jump").innerText="DaSegnoAlCoda";break;case Xe.JumpDalSegnoAlDoubleCoda:t.addElement("Jump").innerText="DaSegnoAlDoubleCoda";break;case Xe.JumpDalSegnoAlFine:t.addElement("Jump").innerText="DaSegnoAlFine";break;case Xe.JumpDalSegnoSegno:t.addElement("Jump").innerText="DaSegnoSegno";break;case Xe.JumpDalSegnoSegnoAlCoda:t.addElement("Jump").innerText="DaSegnoSegnoAlCoda";break;case Xe.JumpDalSegnoSegnoAlDoubleCoda:t.addElement("Jump").innerText="DaSegnoSegnoAlDoubleCoda";break;case Xe.JumpDalSegnoSegnoAlFine:t.addElement("Jump").innerText="DaSegnoSegnoAlFine";break;case Xe.JumpDaCoda:t.addElement("Jump").innerText="DaCoda";break;case Xe.JumpDaDoubleCoda:t.addElement("Jump").innerText="DaDoubleCoda"}}this.KM(s,e)}YM(t,e){const s=t.addElement("XProperties"),i=e.actualBeamingRules;if(i){const t=i.findRule(l.Eighth);let e=t[0],n=1;t[0]===l.Quarter&&(e=8,n=2),this.LM(s,"1124139010","Int",e.toString());const r=1124139264;let a=0;for(;a<t[1].length;)this.LM(s,(r+a).toString(),"Int",(t[1][a]*n).toString()),a++}}KM(t,e){const s=e.fermata?.size??0;if(0!==s&&s>0){const s=t.addElement("Fermatas");for(const[t,i]of e.fermata)this.QM(s,t,i)}}QM(t,e,s){let i=-1,n=1;if(e>0)for(;n<10&&(i=e/$.QuarterTime*n,i!==Math.floor(i));)i=-1,n++;else i=0,n=1;if(-1===i)return;const r=t.addElement("Fermata");r.addElement("Type").innerText=Dt[s.type],r.addElement("Length").innerText=s.length.toString(),r.addElement("Offset").innerText=`${i}/${n}`}mM(t,e){const s=t.addElement("Bar");s.attributes.set("id",e.id.toString()),s.addElement("Voices").innerText=e.voices.map(t=>t.isEmpty?"-1":t.id.toString()).join(" "),s.addElement("Clef").innerText=M[e.clef],e.clefOttava!==m.Regular&&(s.addElement("Ottavia").innerText=m[e.clefOttava].substr(1)),e.simileMark!==v.None&&(s.addElement("SimileMark").innerText=v[e.simileMark])}gM(t,e){if(e.isEmpty)return;const s=t.addElement("Voice");s.attributes.set("id",e.id.toString()),s.addElement("Beats").innerText=e.beats.map(t=>t.id).join(" ")}}class Hu{static ZM=Hu.tv();static tv(){const t=new Uint32Array(256);for(let e=0;e<t.length;e++){let s=e;for(let t=0;t<8;t++)s=1&~s?s>>>1:s>>>1^3988292384;t[e]=s}return t}static ev=4294967295;sv=Hu.ev;get value(){return~this.sv}constructor(){this.reset()}update(t,e,s){for(let i=0;i<s;i++)this.sv=Hu.ZM[255&(this.sv^t[e+i])]^this.sv>>>8}reset(){this.sv=Hu.ev}}class Uu{static maxWbits=15;static wsize=1<<Uu.maxWbits;static wmask=Uu.wsize-1;static minMatch=3;static maxMatch=258;static defaultMemLevel=8;static pendingBufSize=1<<Uu.defaultMemLevel+8;static hashBits=Uu.defaultMemLevel+7;static hashSize=1<<Uu.hashBits;static hashShift=(Uu.hashBits+Uu.minMatch-1)/Uu.minMatch;static hashMask=Uu.hashSize-1;static minLookahead=Uu.maxMatch+Uu.minMatch+1;static maxDist=Uu.wsize-Uu.minLookahead}class zu{static iv=16;static nv=17;static rv=18;freqs;length=null;minNumCodes;numCodes=0;av=null;hv;ov;Gi;constructor(t,e,s,i){this.Gi=t,this.minNumCodes=s,this.ov=i,this.freqs=new Int16Array(e),this.hv=new Int32Array(i)}reset(){for(let t=0;t<this.freqs.length;t++)this.freqs[t]=0;this.av=null,this.length=null}buildTree(){const t=this.freqs.length,e=new Int32Array(t);let s=0,i=0;for(let n=0;n<t;n++){const t=this.freqs[n];if(0!==t){let r=s++;for(;r>0;){const s=Math.floor((r-1)/2);if(!(this.freqs[e[s]]>t))break;e[r]=e[s],r=s}e[r]=n,i=n}}for(;s<2;){const t=i<2?++i:0;e[s++]=t}this.numCodes=Math.max(i+1,this.minNumCodes);const n=s,r=new Int32Array(4*s-2),a=new Int32Array(2*s-1);let h=n;for(let t=0;t<s;t++){const s=e[t];r[2*t]=s,r[2*t+1]=-1,a[t]=this.freqs[s]<<8,e[t]=t}do{const t=e[0];let i=e[--s],n=0,o=1;for(;o<s;)o+1<s&&a[e[o]]>a[e[o+1]]&&o++,e[n]=e[o],n=o,o=2*o+1;let c=a[i];for(;o=n,n>0&&(n=Math.floor((o-1)/2),a[e[n]]>c);)e[o]=e[n];e[o]=i;const l=e[0];i=h++,r[2*i]=t,r[2*i+1]=l;const u=Math.min(255&a[t],255&a[l]);for(c=a[t]+a[l]-u+1,a[i]=c,n=0,o=1;o<s;)o+1<s&&a[e[o]]>a[e[o+1]]&&o++,e[n]=e[o],n=o,o=2*n+1;for(;o=n,o>0&&(n=Math.floor((o-1)/2),a[e[n]]>c);)e[o]=e[n];e[o]=i}while(s>1);this.cv(r)}cv(t){this.length=new Uint8Array(this.freqs.length);const e=Math.floor(t.length/2),s=Math.floor((e+1)/2);let i=0;for(let t=0;t<this.ov;t++)this.hv[t]=0;const n=new Int32Array(e);n[e-1]=0;for(let s=e-1;s>=0;s--)if(-1!==t[2*s+1]){let e=n[s]+1;e>this.ov&&(e=this.ov,i++),n[t[2*s]]=e,n[t[2*s+1]]=e}else{const e=n[s];this.hv[e-1]++,this.length[t[2*s]]=n[s]}if(0===i)return;let r=this.ov-1;do{for(;0===this.hv[--r];);do{this.hv[r]--,this.hv[++r]++,i-=1<<this.ov-1-r}while(i>0&&r<this.ov-1)}while(i>0);this.hv[this.ov-1]+=i,this.hv[this.ov-2]-=i;let a=2*s;for(let e=this.ov;0!==e;e--){let s=this.hv[e-1];for(;s>0;){const i=2*t[a++];-1===t[i+1]&&(this.length[t[i]]=e,s--)}}}getEncodedLength(){let t=0;for(let e=0;e<this.freqs.length;e++)t+=this.freqs[e]*this.length[e];return t}calcBLFreq(t){let e,s,i,n=-1,r=0;for(;r<this.numCodes;){i=1;const a=this.length[r];for(0===a?(e=138,s=3):(e=6,s=3,n!==a&&(t.freqs[a]++,i=0)),n=a,r++;r<this.numCodes&&n===this.length[r]&&(r++,!(++i>=e)););i<s?t.freqs[n]+=i:0!==n?t.freqs[zu.iv]++:i<=10?t.freqs[zu.nv]++:t.freqs[zu.rv]++}}setStaticCodes(t,e){this.av=t,this.length=e}buildCodes(){const t=new Int32Array(this.ov);let e=0;this.av=new Int16Array(this.freqs.length);for(let s=0;s<this.ov;s++)t[s]=e,e+=this.hv[s]<<15-s;for(let e=0;e<this.numCodes;e++){const s=this.length[e];s>0&&(this.av[e]=Xu.bitReverse(t[s-1]),t[s-1]+=1<<16-s)}}writeTree(t){let e,s,i,n=-1,r=0;for(;r<this.numCodes;){i=1;const a=this.length[r];for(0===a?(e=138,s=3):(e=6,s=3,n!==a&&(t.writeSymbol(a),i=0)),n=a,r++;r<this.numCodes&&n===this.length[r]&&(r++,!(++i>=e)););if(i<s)for(;i-- >0;)t.writeSymbol(n);else 0!==n?(t.writeSymbol(zu.iv),this.Gi.pending.writeBits(i-3,2)):i<=10?(t.writeSymbol(zu.nv),this.Gi.pending.writeBits(i-3,3)):(t.writeSymbol(zu.rv),this.Gi.pending.writeBits(i-11,7))}}writeSymbol(t){this.Gi.pending.writeBits(65535&this.av[t],this.length[t])}}class Xu{static lv=1<<Uu.defaultMemLevel+6;static uv=286;static storedBlock=0;static staticTrees=1;static dynTrees=2;static dv=30;static fv=new Int16Array(Xu.uv);static pv=new Uint8Array(Xu.uv);static bv=new Int16Array(Xu.dv);static mv=new Uint8Array(Xu.dv);static staticInit(){let t=0;for(;t<144;)Xu.fv[t]=Xu.bitReverse(48+t<<8),Xu.pv[t++]=8;for(;t<256;)Xu.fv[t]=Xu.bitReverse(256+t<<7),Xu.pv[t++]=9;for(;t<280;)Xu.fv[t]=Xu.bitReverse(-256+t<<9),Xu.pv[t++]=7;for(;t<Xu.uv;)Xu.fv[t]=Xu.bitReverse(-88+t<<8),Xu.pv[t++]=8;for(t=0;t<Xu.dv;t++)Xu.bv[t]=Xu.bitReverse(t<<11),Xu.mv[t]=5}static gv=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];static wv=new Uint8Array([0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15]);static bitReverse(t){return Xu.wv[15&t]<<12|Xu.wv[t>>4&15]<<8|Xu.wv[t>>8&15]<<4|Xu.wv[t>>12]}static yv=19;static kv=256;pending;Sv;Bv;_v;Tv;xv;Mv=0;vv=0;constructor(t){this.pending=t,this.Sv=new zu(this,Xu.uv,257,15),this.Bv=new zu(this,Xu.dv,1,15),this._v=new zu(this,Xu.yv,4,7),this.Tv=new Int16Array(Xu.lv),this.xv=new Uint8Array(Xu.lv)}isFull(){return this.Mv>=Xu.lv}reset(){this.Mv=0,this.vv=0,this.Sv.reset(),this.Bv.reset(),this._v.reset()}flushStoredBlock(t,e,s,i){this.pending.writeBits((Xu.storedBlock<<1)+(i?1:0),3),this.pending.alignToByte(),this.pending.writeShort(s),this.pending.writeShort(~s),this.pending.writeBlock(t,e,s),this.reset()}flushBlock(t,e,s,i){this.Sv.freqs[Xu.kv]++,this.Sv.buildTree(),this.Bv.buildTree(),this.Sv.calcBLFreq(this._v),this.Bv.calcBLFreq(this._v),this._v.buildTree();let n=4;for(let t=18;t>n;t--)this._v.length[Xu.gv[t]]>0&&(n=t+1);let r=14+3*n+this._v.getEncodedLength()+this.Sv.getEncodedLength()+this.Bv.getEncodedLength()+this.vv,a=this.vv;for(let t=0;t<Xu.uv;t++)a+=this.Sv.freqs[t]*Xu.pv[t];for(let t=0;t<Xu.dv;t++)a+=this.Bv.freqs[t]*Xu.mv[t];r>=a&&(r=a),e>=0&&s+4<r>>3?this.flushStoredBlock(t,e,s,i):r===a?(this.pending.writeBits((Xu.staticTrees<<1)+(i?1:0),3),this.Sv.setStaticCodes(Xu.fv,Xu.pv),this.Bv.setStaticCodes(Xu.bv,Xu.mv),this.compressBlock(),this.reset()):(this.pending.writeBits((Xu.dynTrees<<1)+(i?1:0),3),this.sendAllTrees(n),this.compressBlock(),this.reset())}sendAllTrees(t){this._v.buildCodes(),this.Sv.buildCodes(),this.Bv.buildCodes(),this.pending.writeBits(this.Sv.numCodes-257,5),this.pending.writeBits(this.Bv.numCodes-1,5),this.pending.writeBits(t-4,4);for(let e=0;e<t;e++)this.pending.writeBits(this._v.length[Xu.gv[e]],3);this.Sv.writeTree(this._v),this.Bv.writeTree(this._v)}compressBlock(){for(let t=0;t<this.Mv;t++){const e=255&this.xv[t];let s=this.Tv[t];if(0!==s--){const t=Xu.Nv(e);this.Sv.writeSymbol(t);let i=Math.floor((t-261)/4);i>0&&i<=5&&this.pending.writeBits(e&(1<<i)-1,i);const n=Xu.Pv(s);this.Bv.writeSymbol(n),i=Math.floor(n/2)-1,i>0&&this.pending.writeBits(s&(1<<i)-1,i)}else this.Sv.writeSymbol(e)}this.Sv.writeSymbol(Xu.kv)}tallyDist(t,e){this.Tv[this.Mv]=t,this.xv[this.Mv++]=e-3;const s=Xu.Nv(e-3);this.Sv.freqs[s]++,s>=265&&s<285&&(this.vv+=Math.floor((s-261)/4));const i=Xu.Pv(t-1);return this.Bv.freqs[i]++,i>=4&&(this.vv+=Math.floor(i/2)-1),this.isFull()}tallyLit(t){return this.Tv[this.Mv]=0,this.xv[this.Mv++]=t,this.Sv.freqs[t]++,this.isFull()}static Nv(t){if(255===t)return 285;let e=257;for(;t>=8;)e+=4,t>>=1;return e+t}static Pv(t){let e=0;for(;t>=4;)e+=2,t>>=1;return e+t}}Xu.staticInit();class ju{static Cv=4096;Ev;Fv=128;Av=128;Dv=8;Lv=0;Wv;qi;lf;Rv;Iv=0;Ov=null;Gv=0;Vv=0;$v=!1;Hv=0;Uv=0;zv;Gi;inputCrc;constructor(t){this.zv=t,this.Gi=new Xu(t),this.inputCrc=new Hu,this.qi=new Uint8Array(2*Uu.wsize),this.lf=new Int16Array(Uu.hashSize),this.Rv=new Int16Array(Uu.wsize),this.Ev=1,this.Wv=1}reset(){this.Gi.reset(),this.inputCrc.reset(),this.Ev=1,this.Wv=1,this.Iv=0,this.$v=!1,this.Uv=Uu.minMatch-1;for(let t=0;t<Uu.hashSize;t++)this.lf[t]=0;for(let t=0;t<Uu.wsize;t++)this.Rv[t]=0}Xv(){this.Lv=this.qi[this.Wv]<<Uu.hashShift^this.qi[this.Wv+1]}needsInput(){return this.Vv===this.Gv}setInput(t,e,s){const i=e+s;this.Ov=t,this.Gv=e,this.Vv=i}deflate(t,e){let s;do{this.fillWindow();const i=t&&this.Gv===this.Vv;s=this.jv(i,e)}while(this.zv.isFlushed&&s);return s}jv(t,e){if(this.Iv<Uu.minLookahead&&!t)return!1;for(;this.Iv>=Uu.minLookahead||t;){if(0===this.Iv)return this.$v&&this.Gi.tallyLit(255&this.qi[this.Wv-1]),this.$v=!1,this.Gi.flushBlock(this.qi,this.Ev,this.Wv-this.Ev,e),this.Ev=this.Wv,!1;this.Wv>=2*Uu.wsize-Uu.minLookahead&&this.Jv();const t=this.Hv;let s=this.Uv;if(this.Iv>=Uu.minMatch){const t=this.qv();0!==t&&this.Wv-t<=Uu.maxDist&&this.Yv(t)&&this.Uv===Uu.minMatch&&this.Wv-this.Hv>ju.Cv&&(this.Uv=Uu.minMatch-1)}if(s>=Uu.minMatch&&this.Uv<=s){this.Gi.tallyDist(this.Wv-1-t,s),s-=2;do{this.Wv++,this.Iv--,this.Iv>=Uu.minMatch&&this.qv()}while(--s>0);this.Wv++,this.Iv--,this.$v=!1,this.Uv=Uu.minMatch-1}else this.$v&&this.Gi.tallyLit(255&this.qi[this.Wv-1]),this.$v=!0,this.Wv++,this.Iv--;if(this.Gi.isFull()){let t=this.Wv-this.Ev;this.$v&&t--;const s=e&&0===this.Iv&&!this.$v;return this.Gi.flushBlock(this.qi,this.Ev,t,s),this.Ev+=t,!s}}return!0}Yv(t){let e,s=this.Wv;const i=s+Math.min(Uu.maxMatch,this.Iv)-1,n=Math.max(s-Uu.maxDist,0),r=this.qi,a=this.Rv;let h=this.Fv;const o=Math.min(this.Av,this.Iv);if(this.Uv=Math.max(this.Uv,Uu.minMatch-1),s+this.Uv>i)return!1;let c=r[s+this.Uv-1],l=r[s+this.Uv];this.Uv>=this.Dv&&(h>>=2);do{if(e=t,s=this.Wv,r[e+this.Uv]===l&&r[e+this.Uv-1]===c&&r[e]===r[s]&&r[++e]===r[++s]){switch((i-s)%8){case 1:if(r[++s]===r[++e])break;break;case 2:if(r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 3:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 4:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 5:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 6:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break;break;case 7:if(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e])break}if(r[s]===r[e])do{if(s===i){++s,++e;break}}while(r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]&&r[++s]===r[++e]);if(s-this.Wv>this.Uv){if(this.Hv=t,this.Uv=s-this.Wv,this.Uv>=o)break;c=r[s-1],l=r[s]}t=65535&a[t&Uu.wmask]}}while(t>n&&0!==--h);return this.Uv>=Uu.minMatch}qv(){const t=(this.Lv<<Uu.hashShift^this.qi[this.Wv+(Uu.minMatch-1)])&Uu.hashMask,e=this.lf[t];return this.Rv[this.Wv&Uu.wmask]=e,this.lf[t]=this.Wv,this.Lv=t,65535&e}fillWindow(){if(this.Wv>=Uu.wsize+Uu.maxDist&&this.Jv(),this.Iv<Uu.minLookahead&&this.Gv<this.Vv){let t=2*Uu.wsize-this.Iv-this.Wv;t>this.Vv-this.Gv&&(t=this.Vv-this.Gv),this.qi.set(this.Ov.subarray(this.Gv,this.Gv+t),this.Wv+this.Iv),this.inputCrc.update(this.Ov,this.Gv,t),this.Gv+=t,this.Iv+=t}this.Iv>=Uu.minMatch&&this.Xv()}Jv(){this.qi.set(this.qi.subarray(Uu.wsize,Uu.wsize+Uu.wsize),0),this.Hv-=Uu.wsize,this.Wv-=Uu.wsize,this.Ev-=Uu.wsize;for(let t=0;t<Uu.hashSize;++t){const e=65535&this.lf[t];this.lf[t]=e>=Uu.wsize?e-Uu.wsize:0}for(let t=0;t<Uu.wsize;t++){const e=65535&this.Rv[t];this.Rv[t]=e>=Uu.wsize?e-Uu.wsize:0}}}class Ju{ni;Kv=0;Xu=0;Ri=0;bitCount=0;get isFlushed(){return 0===this.Xu}constructor(t){this.ni=new Uint8Array(t)}reset(){this.Kv=0,this.Xu=0,this.bitCount=0}writeShortMSB(t){this.ni[this.Xu++]=t>>8&255,this.ni[this.Xu++]=255&t}writeShort(t){this.ni[this.Xu++]=t,this.ni[this.Xu++]=t>>8}writeBlock(t,e,s){this.ni.set(t.subarray(e,e+s),this.Xu),this.Xu+=s}flush(t,e,s){return this.bitCount>=8&&(this.ni[this.Xu++]=255&this.Ri,this.Ri>>=8,this.bitCount-=8),s>this.Xu-this.Kv?(s=this.Xu-this.Kv,t.set(this.ni.subarray(this.Kv,this.Kv+s),e),this.Kv=0,this.Xu=0):(t.set(this.ni.subarray(this.Kv,this.Kv+s),e),this.Kv+=s),s}writeBits(t,e){this.Ri|=t<<this.bitCount,this.bitCount+=e,this.bitCount>=16&&(this.ni[this.Xu++]=255&this.Ri,this.ni[this.Xu++]=this.Ri>>8&255,this.Ri>>=16,this.bitCount-=16)}alignToByte(){this.bitCount>0&&(this.ni[this.Xu++]=255&this.Ri,this.bitCount>8&&(this.ni[this.Xu++]=this.Ri>>8&255)),this.Ri=0,this.bitCount=0}}class qu{static Qv=4;static isFinishing=8;static Zv=16;static tN=20;static eN=28;static sN=30;li=0;zv;iN;get inputCrc(){return this.iN.inputCrc.value}constructor(){this.zv=new Ju(Uu.pendingBufSize),this.iN=new ju(this.zv),this.reset()}get isNeedingInput(){return this.iN.needsInput()}get isFinished(){return this.li===qu.sN&&this.zv.isFlushed}reset(){this.li=qu.Zv,this.zv.reset(),this.iN.reset()}setInput(t,e,s){this.iN.setInput(t,e,s)}deflate(t,e,s){const i=s;for(;;){const n=this.zv.flush(t,e,s);if(e+=n,0===(s-=n)||this.li===qu.sN)break;if(!this.iN.deflate(0!==(this.li&qu.Qv),0!==(this.li&qu.isFinishing)))switch(this.li){case qu.Zv:return i-s;case qu.tN:let t=8+(7&-this.zv.bitCount);for(;t>0;)this.zv.writeBits(2,10),t-=10;this.li=qu.Zv;break;case qu.eN:this.zv.alignToByte(),this.li=qu.sN}}return i-s}finish(){this.li|=qu.Qv|qu.isFinishing}}class Yu{entry;localHeaderOffset;compressedSize;crc32;compressionMode;constructor(t,e,s,i,n){this.entry=t,this.crc32=e,this.localHeaderOffset=s,this.compressionMode=i,this.compressedSize=n}}class Ku{tu;nN=[];rN=new qu;constructor(t){this.tu=t}writeEntry(t){const e=ks.CompressionMethodDeflate,s=Ae.empty(),i=this.aN(s,t.data,e),n=s.toArray(),r=new Yu(t,i,this.tu.bytesWritten,e,s.length);this.nN.push(r),fe.writeInt32LE(this.tu,ks.LocalFileHeaderSignature),fe.writeUInt16LE(this.tu,10),fe.writeUInt16LE(this.tu,2048),fe.writeUInt16LE(this.tu,e),fe.writeInt16LE(this.tu,0),fe.writeInt16LE(this.tu,0),fe.writeInt32LE(this.tu,i),fe.writeInt32LE(this.tu,n.length),fe.writeInt32LE(this.tu,t.data.length),fe.writeInt16LE(this.tu,t.fullName.length),fe.writeInt16LE(this.tu,0);const a=fe.stringToBytes(t.fullName);this.tu.write(a,0,a.length),this.tu.write(n,0,n.length)}aN(t,e,s){if(s!==ks.CompressionMethodDeflate){const s=new Hu;return s.update(e,0,e.length),t.write(e,0,e.length),s.value}const i=new Uint8Array(512);for(this.rN.reset(),this.rN.setInput(e,0,e.length);!this.rN.isNeedingInput;){const e=this.rN.deflate(i,0,i.length);if(e<=0)break;t.write(i,0,e)}for(this.rN.finish();!this.rN.isFinished;){const e=this.rN.deflate(i,0,i.length);if(e<=0)break;t.write(i,0,e)}return this.rN.inputCrc}end(){const t=this.tu.bytesWritten;for(const t of this.nN)this.hN(t);const e=this.tu.bytesWritten;this.oN(t,e)}oN(t,e){fe.writeInt32LE(this.tu,ks.EndOfCentralDirSignature),fe.writeInt16LE(this.tu,0),fe.writeInt16LE(this.tu,0),fe.writeInt16LE(this.tu,this.nN.length),fe.writeInt16LE(this.tu,this.nN.length),fe.writeInt32LE(this.tu,e-t),fe.writeInt32LE(this.tu,t),fe.writeInt16LE(this.tu,0)}hN(t){fe.writeInt32LE(this.tu,ks.CentralFileHeaderSignature),fe.writeUInt16LE(this.tu,10),fe.writeUInt16LE(this.tu,10),fe.writeUInt16LE(this.tu,2048),fe.writeUInt16LE(this.tu,t.compressionMode),fe.writeInt16LE(this.tu,0),fe.writeInt16LE(this.tu,0),fe.writeInt32LE(this.tu,t.crc32),fe.writeInt32LE(this.tu,t.compressedSize),fe.writeInt32LE(this.tu,t.entry.data.length),fe.writeInt16LE(this.tu,t.entry.fullName.length),fe.writeInt16LE(this.tu,0),fe.writeInt16LE(this.tu,0),fe.writeInt16LE(this.tu,0),fe.writeInt16LE(this.tu,0),fe.writeInt32LE(this.tu,0),fe.writeInt32LE(this.tu,t.localHeaderOffset);const e=fe.stringToBytes(t.entry.fullName);this.tu.write(e,0,e.length)}}const Qu=Object.freeze(Object.defineProperty({__proto__:null,AlphaTexExporter:class extends Au{ci=Ce.instance;get name(){return"alphaTex"}exportToString(t,e=null){return this.settings=e??new aa,this.scoreToAlphaTexString(t)}writeScore(t){const e=fe.stringToBytes(this.scoreToAlphaTexString(t));this.data.write(e,0,e.length)}scoreToAlphaTexString(t){const e=new Lu(this.settings);return e.writeScoreNode(this.Be(t)),e.tex}Be(t){const e={nodeType:Tt.Score,bars:[]};for(const s of t.tracks)this.cN(e,s);return 0===e.bars.length?e.bars.push({nodeType:Tt.Bar,metaData:this.ci.buildScoreMetaDataNodes(t),beats:[]}):e.bars[0].metaData=this.ci.buildScoreMetaDataNodes(t).concat(e.bars[0].metaData),e.bars.push({nodeType:Tt.Bar,metaData:this.ci.buildSyncPointNodes(t),beats:[]}),e}cN(t,e){for(const s of e.staves)this.iS(t,s)}iS(t,e){const s=Math.max(...e.filledVoices)+1;if(0===e.bars.length){const s={nodeType:Tt.Bar,metaData:this.ci.buildBarMetaDataNodes(e,void 0,0,!1),beats:[],pipe:void 0};t.bars.push(s)}else for(let i=0;i<s;i++)this.lN(t,i,e,s>1)}lN(t,e,s,i){for(const n of s.bars)this.Te(t,n,e,i)}Te(t,e,s,i){const n={nodeType:Tt.Bar,metaData:this.ci.buildBarMetaDataNodes(e.staff,e,s,i),beats:[],pipe:void 0};if(e.isEmpty)n.trailingComments=[{multiLine:!1,text:`Bar ${e.index+1} / Voice ${s+1} no contents`}];else{const t=e.voices[s];if(t.isEmpty)n.trailingComments=[{multiLine:!1,text:`Bar ${e.index+1} / Voice ${s+1} no contents`}];else{for(const e of t.beats)n.beats.push(this.Ne(e));n.beats.length>0&&(n.beats[0].leadingComments??=[],n.beats[0].leadingComments.unshift({multiLine:!1,text:`Bar ${e.index+1} / Voice ${s+1} contents`}))}}e.index<e.staff.bars.length-1&&(n.pipe={nodeType:Tt.Pipe}),t.bars.push(n)}Ne(t){const e={nodeType:Tt.Beat,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0};return t.isRest?e.rest={nodeType:Tt.Ident,text:"r"}:e.notes=this.CS(t.notes),e.durationDot={nodeType:Tt.Dot},e.durationValue={nodeType:Tt.Number,value:t.duration},e.beatEffects=this.yi(t),e}yi(t){const e=this.ci.buildBeatEffects(t);return e.length>0?{nodeType:Tt.Props,openBrace:{nodeType:Tt.LBrace},properties:e,closeBrace:{nodeType:Tt.RBrace}}:void 0}CS(t){const e={nodeType:Tt.NoteList,openParenthesis:void 0,notes:[],closeParenthesis:void 0};(0===t.length||t.length>1)&&(e.openParenthesis={nodeType:Tt.LParen},e.closeParenthesis={nodeType:Tt.RParen});for(const s of t)e.notes.push(this.Le(s));return e}Le(t){const e={nodeType:Tt.Note,noteValue:{nodeType:Tt.Ident,text:""}};if(t.isPercussion)e.noteValue={nodeType:Tt.String,text:qt.getArticulationName(t)};else if(t.isPiano)e.noteValue={nodeType:Tt.Ident,text:xe.getTextForTuning(t.realValueWithoutHarmonic,!0)};else{if(!t.isStringed)throw new Error("What kind of note");{e.noteValue={nodeType:Tt.Number,value:t.fret},e.noteStringDot={nodeType:Tt.Dot};const s=t.beat.voice.bar.staff.tuning.length-t.string+1;e.noteString={nodeType:Tt.Number,value:s}}}return e.noteEffects=this.ki(t),e}ki(t){const e=this.ci.buildNoteEffects(t);return e.length>0?{nodeType:Tt.Props,openBrace:{nodeType:Tt.LBrace},properties:e,closeBrace:{nodeType:Tt.RBrace}}:void 0}},Gp7Exporter:class extends Au{get name(){return"Guitar Pro 7-8"}writeScore(t){q.debug(this.name,"Writing data entries");const e=new $u,s=e.writeXml(t),i=Xs.writeForScore(t),n=Zs.writeForScore(t),r=si.writeForScore(t);q.debug(this.name,"Writing ZIP entries");const a=new Ku(this.data);a.writeEntry(new ks("VERSION",fe.stringToBytes("7.0"))),a.writeEntry(new ks("Content/",new Uint8Array(0))),a.writeEntry(new ks("Content/BinaryStylesheet",i)),a.writeEntry(new ks("Content/PartConfiguration",n)),a.writeEntry(new ks("Content/LayoutConfiguration",r)),a.writeEntry(new ks("Content/score.gpif",fe.stringToBytes(s))),e.backingTrackAssetFileName&&a.writeEntry(new ks(e.backingTrackAssetFileName,t.backingTrack.rawAudioFile)),a.end()}},ScoreExporter:Au},Symbol.toStringTag,{value:"Module"}));class Zu extends Mi{constructor(){super(0,0,Ke.EndOfTrack)}writeTo(e){throw new G(t.AlphaTabErrorType.General,"Deprecated event, serialization not supported")}}var td,ed,sd;!function(t){t[t.SequenceNumber=0]="SequenceNumber",t[t.TextEvent=1]="TextEvent",t[t.CopyrightNotice=2]="CopyrightNotice",t[t.SequenceOrTrackName=3]="SequenceOrTrackName",t[t.InstrumentName=4]="InstrumentName",t[t.LyricText=5]="LyricText",t[t.MarkerText=6]="MarkerText",t[t.CuePoint=7]="CuePoint",t[t.PatchName=8]="PatchName",t[t.PortName=9]="PortName",t[t.MidiChannel=32]="MidiChannel",t[t.MidiPort=33]="MidiPort",t[t.EndOfTrack=47]="EndOfTrack",t[t.Tempo=81]="Tempo",t[t.SmpteOffset=84]="SmpteOffset",t[t.TimeSignature=88]="TimeSignature",t[t.KeySignature=89]="KeySignature",t[t.SequencerSpecific=127]="SequencerSpecific"}(td||(td={}));class id extends Zu{get metaStatus(){return td.EndOfTrack}}!function(t){t[t.SystemExclusive=240]="SystemExclusive",t[t.MtcQuarterFrame=241]="MtcQuarterFrame",t[t.SongPosition=242]="SongPosition",t[t.SongSelect=243]="SongSelect",t[t.TuneRequest=246]="TuneRequest",t[t.SystemExclusive2=247]="SystemExclusive2"}(ed||(ed={}));class nd extends Zu{}!function(t){t[t.MetronomeTick=0]="MetronomeTick",t[t.Rest=1]="Rest"}(sd||(sd={}));const rd=Object.freeze(Object.defineProperty({__proto__:null,AlphaSynthMidiFileHandler:Sa,AlphaTabMetronomeEvent:Pi,AlphaTabRestEvent:Ci,AlphaTabSysExEvent:Ni,get AlphaTabSystemExclusiveEvents(){return sd},BeatTickLookup:xa,BeatTickLookupItem:Ta,ControlChangeEvent:Di,get ControllerType(){return rs},DeprecatedMidiEvent:Zu,EndOfTrackEvent:Oi,MasterBarTickLookup:va,MasterBarTickLookupTempoChange:Ma,MetaDataEvent:class extends id{data=new Uint8Array},MetaEvent:id,get MetaEventType(){return td},MetaNumberEvent:class extends id{value=0},Midi20PerNotePitchBendEvent:class extends Zu{noteKey=0;pitch=0},MidiEvent:Mi,get MidiEventType(){return Ke},MidiFile:xi,get MidiFileFormat(){return Ye},MidiFileGenerator:La,MidiTickLookup:Ca,MidiTickLookupFindBeatResult:Na,get MidiTickLookupFindBeatResultCursorMode(){return bs},MidiTrack:Ti,NoteBendEvent:Ii,NoteEvent:Ei,NoteOffEvent:Ai,NoteOnEvent:Fi,PitchBendEvent:Ri,ProgramChangeEvent:Li,SystemCommonEvent:nd,get SystemCommonType(){return ed},SystemExclusiveEvent:class extends nd{static AlphaTabManufacturerId=125;data=new Uint8Array;get isMetronome(){return!1}get metronomeNumerator(){return-1}get metronomeDurationInTicks(){return-1}get metronomeDurationInMilliseconds(){return-1}get isRest(){return!1}get manufacturerId(){return 0}},TempoChangeEvent:Wi,TimeSignatureEvent:vi},Symbol.toStringTag,{value:"Module"})),ad=Object.freeze(Object.defineProperty({__proto__:null,get AccentuationType(){return d},get AccidentalType(){return x},Automation:U,get AutomationType(){return r},BackingTrack:js,Bar:Z,get BarLineStyle(){return F},get BarNumberDisplay(){return I},BarStyle:Q,get BarSubElement(){return E},get BarreShape(){return yt},BeamingRules:tt,Beat:se,get BeatBeamingMode(){return Bt},BeatStyle:ee,get BeatSubElement(){return _t},BendPoint:z,get BendStyle(){return a},get BendType(){return h},get BracketExtendMode(){return D},get BrushType(){return o},Chord:ye,get Clef(){return M},Color:Se,get CrescendoType(){return c},get Direction(){return Xe},get Duration(){return l},get DynamicValue(){return n},ElementStyle:Y,get FadeType(){return gt},Fermata:Be,get FermataType(){return Dt},get Fingers(){return f},Font:Hr,get FontStyle(){return as},get FontWeight(){return hs},get GolpeType(){return mt},GraceGroup:nt,get GraceType(){return u},get HarmonicType(){return p},HeaderFooterStyle:Gt,InstrumentArticulation:Jt,JsonConverter:ha,get KeySignature(){return N},get KeySignatureType(){return P},Lyrics:_e,MasterBar:et,get MusicFontSymbol(){return ut},Note:Qt,get NoteAccidentalMode(){return b},get NoteOrnament(){return ft},NoteStyle:Kt,get NoteSubElement(){return pt},get Ottavia(){return m},get PickStroke(){return lt},PlaybackInformation:ve,get Rasgueado(){return kt},RenderStylesheet:st,RepeatGroup:it,Score:$t,ScoreStyle:Vt,get ScoreSubElement(){return ct},Section:Te,get SimileMark(){return v},get SlideInType(){return g},get SlideOutType(){return w},Staff:Me,SustainPedalMarker:K,get SustainPedalMarkerType(){return C},SyncPointData:H,get TechniqueSymbolPlacement(){return dt},Track:Pe,get TrackNameMode(){return W},get TrackNameOrientation(){return R},get TrackNamePolicy(){return L},TrackStyle:Ne,get TrackSubElement(){return Wt},TremoloPickingEffect:te,get TremoloPickingStyle(){return St},get TripletFeel(){return A},Tuning:xe,TupletGroup:Zt,get VibratoType(){return y},Voice:at,VoiceStyle:rt,get VoiceSubElement(){return O},get WahPedal(){return wt},get WhammyType(){return bt}},Symbol.toStringTag,{value:"Module"})),hd=Object.freeze(Object.defineProperty({__proto__:null,BarBounds:da,get BeamDirection(){return Rt},BeatBounds:fa,Bounds:zs,BoundsLookup:ga,MasterBarBounds:pa,NoteBounds:ba,RenderFinishedEventArgs:ua,ScoreRenderer:wa,StaffSystemBounds:ma},Symbol.toStringTag,{value:"Module"})),od=Object.freeze(Object.defineProperty({__proto__:null,CssFontSvgCanvas:Ph,Cursors:uh,FontSizeDefinition:ca,FontSizes:la,MeasuredText:It,SvgCanvas:Nh,get TextAlign(){return ht},get TextBaseline(){return ot}},Symbol.toStringTag,{value:"Module"})),cd=Object.freeze(Object.defineProperty({__proto__:null,ActiveBeatsChangedEventArgs:Ja,AlphaSynth:ir,AlphaSynthAudioWorkletOutput:_i,AlphaSynthBase:sr,AlphaSynthScriptProcessorOutput:oh,AlphaSynthWebAudioOutputBase:Si,AlphaSynthWebWorkerApi:ch,AudioExportChunk:er,AudioExportOptions:tr,BackingTrackSyncPoint:Vi,CircularSampleBuffer:bi,MidiEventsPlayedEventArgs:Qn,PlaybackRange:qa,PlaybackRangeChangedEventArgs:Zn,get PlayerState(){return Qe},PlayerStateChangedEventArgs:zi,PositionChangedEventArgs:Xi},Symbol.toStringTag,{value:"Module"})),ld=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));Nu.isRunningInWorker?Nu.initializeWorker():Nu.isRunningInAudioWorklet?Nu.initializeAudioWorklet():Nu.initializeMain(e=>{if(Nu.webPlatform===t.WebPlatform.NodeJs)throw new G(t.AlphaTabErrorType.General,"Workers not yet supported in Node.js");if(Nu.webPlatform===t.WebPlatform.BrowserModule||Nu.isWebPackBundled||Nu.isViteBundled){q.debug("AlphaTab","Creating webworker");try{return new Nu.alphaTabWorker(new Nu.alphaTabUrl("./alphaTab.worker.ts",{}),{type:"module"})}catch(t){q.debug("AlphaTab","ESM webworker construction with direct URL failed",t)}let t="";try{t=new Nu.alphaTabUrl("./alphaTab.worker.ts",{});const e=`import ${JSON.stringify(t)}`,s=new Blob([e],{type:"application/javascript"});return new Worker(URL.createObjectURL(s),{type:"module"})}catch(e){q.debug("AlphaTab","ESM webworker construction with blob import failed",t,e)}try{if(!e.core.scriptFile)throw new Error("Could not detect alphaTab script file");t=e.core.scriptFile;const s=`import ${JSON.stringify(e.core.scriptFile)}`,i=new Blob([s],{type:"application/javascript"});return new Worker(URL.createObjectURL(i),{type:"module"})}catch(t){q.debug("AlphaTab","ESM webworker construction with blob import failed",e.core.scriptFile,t)}}if(!e.core.scriptFile)throw new G(t.AlphaTabErrorType.General,"Could not detect alphaTab script file, cannot initialize renderer");try{q.debug("AlphaTab","Creating Blob worker");const t=`importScripts('${e.core.scriptFile}')`,s=new Blob([t],{type:"application/javascript"});return new Worker(URL.createObjectURL(s))}catch{return q.warning("Rendering","Could not create inline worker, fallback to normal worker"),new Worker(e.core.scriptFile)}},(e,s)=>{if(Nu.webPlatform===t.WebPlatform.NodeJs)throw new G(t.AlphaTabErrorType.General,"Audio Worklets not yet supported in Node.js");if(Nu.webPlatform===t.WebPlatform.BrowserModule||Nu.isWebPackBundled||Nu.isViteBundled){q.debug("AlphaTab","Creating Module worklet");return e.audioWorklet.addModule(new Nu.alphaTabUrl("./alphaTab.worklet.ts",{}))}return q.debug("AlphaTab","Creating Script worklet"),e.audioWorklet.addModule(s.core.scriptFile)}),t.AlphaTabApi=gh,t.AlphaTabApiBase=sh,t.AlphaTabError=G,t.ConsoleLogger=J,t.CoreSettings=Pu,t.DisplaySettings=Xr,t.EngravingSettings=Or,t.EngravingStemInfo=Ir,t.Environment=Nu,t.ExporterSettings=ra,t.FileLoadError=ih,t.FormatError=ke,t.ImporterSettings=na,t.Logger=q,t.NotationSettings=X,t.PlayerSettings=ta,t.ProgressEventArgs=mh,t.RenderEngineFactory=vu,t.RenderingResources=zr,t.ResizeEventArgs=Wa,t.Settings=aa,t.SlidePlaybackSettings=Zr,t.VibratoPlaybackSettings=Qr,t.exporter=Qu,t.importer=Eu,t.io=Fu,t.json=ld,t.meta=V,t.midi=rd,t.model=ad,t.platform=od,t.rendering=hd,t.synth=cd,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});